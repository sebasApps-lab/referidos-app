[{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\App.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\datos\\ChartsAvanzados.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[68,107],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/admin/datos/ChartsAvanzados.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Activity, BarChart3, PieChart, TrendingDown } from \"lucide-react\";\r\n\r\nexport default function ChartsAvanzados() {\r\n  const funnel = [\r\n    { label: \"Visitas\", value: \"120k\" },\r\n    { label: \"QR generados\", value: \"35k\" },\r\n    { label: \"QR canjeados\", value: \"18k\" },\r\n    { label: \"Recompensas\", value: \"9k\" },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div>\r\n        <div className=\"text-lg font-semibold text-[#2F1A55]\">Datos</div>\r\n        <div className=\"text-xs text-slate-500\">\r\n          Analisis profundo para decisiones estrategicas.\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"grid gap-4 lg:grid-cols-3\">\r\n        <motion.div\r\n          whileHover={{ y: -2 }}\r\n          className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n        >\r\n          <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n            <BarChart3 size={16} />\r\n            Conversion por sector\r\n          </div>\r\n          <div className=\"mt-4 space-y-3 text-xs text-slate-500\">\r\n            {[\"Restaurantes\", \"Retail\", \"Salud\"].map((sector) => (\r\n              <div key={sector} className=\"space-y-1\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <span>{sector}</span>\r\n                  <span>32%</span>\r\n                </div>\r\n                <div className=\"h-2 rounded-full bg-slate-100\">\r\n                  <div className=\"h-2 w-2/3 rounded-full bg-[#5E30A5]/70\" />\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </motion.div>\r\n\r\n        <motion.div\r\n          whileHover={{ y: -2 }}\r\n          className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n        >\r\n          <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n            <PieChart size={16} />\r\n            Retencion\r\n          </div>\r\n          <div className=\"mt-4 grid grid-cols-2 gap-3 text-xs text-slate-500\">\r\n            <div className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-3\">\r\n              <div className=\"text-sm font-semibold text-[#5E30A5]\">72%</div>\r\n              <div>Clientes 30 dias</div>\r\n            </div>\r\n            <div className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-3\">\r\n              <div className=\"text-sm font-semibold text-[#5E30A5]\">41%</div>\r\n              <div>Clientes 90 dias</div>\r\n            </div>\r\n          </div>\r\n        </motion.div>\r\n\r\n        <motion.div\r\n          whileHover={{ y: -2 }}\r\n          className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n        >\r\n          <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n            <TrendingDown size={16} />\r\n            Alertas de caida\r\n          </div>\r\n          <div className=\"mt-3 space-y-2 text-xs text-slate-500\">\r\n            <div className=\"flex items-center justify-between rounded-xl border border-[#E9E2F7] bg-[#FFF5F5] px-3 py-2\">\r\n              <span>QRs canjeados</span>\r\n              <span className=\"text-rose-600\">-12%</span>\r\n            </div>\r\n            <div className=\"flex items-center justify-between rounded-xl border border-[#E9E2F7] bg-[#FFF5F5] px-3 py-2\">\r\n              <span>Promos activas</span>\r\n              <span className=\"text-rose-600\">-6%</span>\r\n            </div>\r\n          </div>\r\n        </motion.div>\r\n      </div>\r\n\r\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\">\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n          <Activity size={16} />\r\n          Funnel de conversion\r\n        </div>\r\n        <div className=\"mt-4 grid gap-3 sm:grid-cols-4\">\r\n          {funnel.map((step) => (\r\n            <div\r\n              key={step.label}\r\n              className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-3 text-xs text-slate-500\"\r\n            >\r\n              <div className=\"text-sm font-semibold text-[#5E30A5]\">\r\n                {step.value}\r\n              </div>\r\n              <div>{step.label}</div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\docs\\AdminDocumentationPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\docs\\MarkdownArticle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\docs\\docsRegistry.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\hooks\\useAdminUser.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\inicio\\GithubTokenRenewalCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\inicio\\InicioCharts.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[66,105],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/admin/inicio/InicioCharts.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { ArrowUpRight, BarChart3, Sparkles, TrendingUp } from \"lucide-react\";\r\n\r\nexport default function InicioCharts() {\r\n  const qrBars = [30, 48, 38, 60, 72, 55, 66];\r\n  const userBars = [15, 25, 35, 45, 58, 68, 82];\r\n  const topPromos = [\r\n    { name: \"2x1 desayuno\", value: 62 },\r\n    { name: \"Happy hour\", value: 48 },\r\n    { name: \"Combo familiar\", value: 39 },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"grid gap-4 lg:grid-cols-2\">\r\n      <motion.div\r\n        whileHover={{ y: -2 }}\r\n        className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\"\r\n      >\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n              QRs generados vs canjeados\r\n            </div>\r\n            <div className=\"text-xs text-slate-500\">Ultimos 7 dias</div>\r\n          </div>\r\n          <div className=\"flex items-center gap-1 text-xs text-emerald-600\">\r\n            <TrendingUp size={14} />\r\n            +12%\r\n          </div>\r\n        </div>\r\n        <div className=\"mt-4 grid grid-cols-7 gap-2\">\r\n          {qrBars.map((height, index) => (\r\n            <div key={`qr-${index}`} className=\"flex flex-col items-center gap-2\">\r\n              <div\r\n                className=\"h-24 w-full rounded-lg bg-[#F3F0FF]\"\r\n                style={{ height: 96 }}\r\n              >\r\n                <div\r\n                  className=\"w-full rounded-lg bg-[#5E30A5]/70\"\r\n                  style={{ height: `${height}%` }}\r\n                />\r\n              </div>\r\n              <div className=\"text-[10px] text-slate-400\">D{index + 1}</div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </motion.div>\r\n\r\n      <motion.div\r\n        whileHover={{ y: -2 }}\r\n        className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\"\r\n      >\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n              Registros de usuarios\r\n            </div>\r\n            <div className=\"text-xs text-slate-500\">Ultimos 7 dias</div>\r\n          </div>\r\n          <div className=\"flex items-center gap-1 text-xs text-[#5E30A5]\">\r\n            <Sparkles size={14} />\r\n            tendencia estable\r\n          </div>\r\n        </div>\r\n        <div className=\"mt-4 grid grid-cols-7 gap-2\">\r\n          {userBars.map((height, index) => (\r\n            <div key={`user-${index}`} className=\"flex flex-col items-center gap-2\">\r\n              <div\r\n                className=\"h-24 w-full rounded-lg bg-[#F5F5F7]\"\r\n                style={{ height: 96 }}\r\n              >\r\n                <div\r\n                  className=\"w-full rounded-lg bg-[#8A62E8]\"\r\n                  style={{ height: `${height}%` }}\r\n                />\r\n              </div>\r\n              <div className=\"text-[10px] text-slate-400\">D{index + 1}</div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </motion.div>\r\n\r\n      <motion.div\r\n        whileHover={{ y: -2 }}\r\n        className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\"\r\n      >\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n          <BarChart3 size={18} />\r\n          Promos mas usadas\r\n        </div>\r\n        <div className=\"mt-4 space-y-3\">\r\n          {topPromos.map((promo) => (\r\n            <div key={promo.name} className=\"space-y-1\">\r\n              <div className=\"flex items-center justify-between text-xs font-semibold text-slate-600\">\r\n                <span>{promo.name}</span>\r\n                <span className=\"text-slate-400\">{promo.value}%</span>\r\n              </div>\r\n              <div className=\"h-2 w-full rounded-full bg-slate-100\">\r\n                <div\r\n                  className=\"h-2 rounded-full bg-[#5E30A5]/70\"\r\n                  style={{ width: `${promo.value}%` }}\r\n                />\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </motion.div>\r\n\r\n      <motion.div\r\n        whileHover={{ y: -2 }}\r\n        className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\"\r\n      >\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n              Negocios con mas canjes\r\n            </div>\r\n            <div className=\"text-xs text-slate-500\">Top 4 de la semana</div>\r\n          </div>\r\n          <div className=\"flex items-center gap-1 text-xs text-emerald-600\">\r\n            <ArrowUpRight size={14} />\r\n            +9%\r\n          </div>\r\n        </div>\r\n        <div className=\"mt-4 space-y-3\">\r\n          {[\"La Esquina\", \"Cafe Central\", \"La Rueda\", \"Mercado Norte\"].map(\r\n            (name, index) => (\r\n              <div\r\n                key={name}\r\n                className=\"flex items-center justify-between rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] px-3 py-2 text-xs\"\r\n              >\r\n                <span className=\"font-semibold text-slate-600\">\r\n                  {index + 1}. {name}\r\n                </span>\r\n                <span className=\"text-[#5E30A5]\">{38 - index * 6} canjes</span>\r\n              </div>\r\n            )\r\n          )}\r\n        </div>\r\n      </motion.div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\inicio\\InicioKPIs.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[64,103],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/admin/inicio/InicioKPIs.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  Activity,\r\n  BadgeCheck,\r\n  QrCode,\r\n  Store,\r\n  Ticket,\r\n  UserCheck,\r\n  Users,\r\n} from \"lucide-react\";\r\n\r\nexport default function InicioKPIs() {\r\n  const stats = [\r\n    {\r\n      label: \"Total usuarios\",\r\n      value: \"24,580\",\r\n      delta: \"+6%\",\r\n      Icon: Users,\r\n    },\r\n    {\r\n      label: \"Clientes activos\",\r\n      value: \"18,302\",\r\n      delta: \"+4%\",\r\n      Icon: UserCheck,\r\n    },\r\n    {\r\n      label: \"Negocios activos\",\r\n      value: \"1,482\",\r\n      delta: \"+3%\",\r\n      Icon: Store,\r\n    },\r\n    {\r\n      label: \"Promos activas\",\r\n      value: \"682\",\r\n      delta: \"+2%\",\r\n      Icon: Ticket,\r\n    },\r\n    {\r\n      label: \"QRs generados hoy\",\r\n      value: \"5,240\",\r\n      delta: \"+10%\",\r\n      Icon: QrCode,\r\n    },\r\n    {\r\n      label: \"QRs canjeados hoy\",\r\n      value: \"2,918\",\r\n      delta: \"+7%\",\r\n      Icon: BadgeCheck,\r\n    },\r\n    {\r\n      label: \"Reportes abiertos\",\r\n      value: \"41\",\r\n      delta: \"-5%\",\r\n      Icon: Activity,\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n      {stats.map((stat) => (\r\n        <motion.div\r\n          key={stat.label}\r\n          whileHover={{ y: -2 }}\r\n          className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n        >\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-[#F7F4FF] text-[#5E30A5]\">\r\n              <stat.Icon size={18} />\r\n            </div>\r\n            <div className=\"rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-600\">\r\n              {stat.delta}\r\n            </div>\r\n          </div>\r\n          <div className=\"mt-3 text-2xl font-bold text-[#2F1A55]\">\r\n            {stat.value}\r\n          </div>\r\n          <div className=\"text-xs text-slate-500\">{stat.label}</div>\r\n        </motion.div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\inicio\\NetlifyTokenRenewalCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\layout\\AdminLayout.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\layout\\AdminSidebar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\layout\\AdminTopbar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\legal\\AdminLegalPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\legal\\legalDocsRegistry.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\logs\\LogsTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\negocios\\NegocioDetalle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\negocios\\NegociosTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\observability\\AdminRuntimeErrorModalHost.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'lastByKey' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":24,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"lastByKey"},"fix":{"range":[667,676],"text":""},"desc":"Remove unused variable 'lastByKey'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState } from \"react\";\r\nimport { AlertTriangle } from \"lucide-react\";\r\nimport { subscribeErrorEvents } from \"../../services/loggingClient\";\r\n\r\nconst DEDUPE_WINDOW_MS = 60_000;\r\n\r\nfunction toEventKey(event = {}) {\r\n  return `${event.code || \"unknown\"}|${event.route || \"-\"}|${event.fingerprint || \"-\"}`;\r\n}\r\n\r\nfunction formatNow() {\r\n  return new Date().toLocaleString(\"es-EC\", {\r\n    year: \"numeric\",\r\n    month: \"2-digit\",\r\n    day: \"2-digit\",\r\n    hour: \"2-digit\",\r\n    minute: \"2-digit\",\r\n    second: \"2-digit\",\r\n  });\r\n}\r\n\r\nexport default function AdminRuntimeErrorModalHost() {\r\n  const [queue, setQueue] = useState([]);\r\n  const [lastByKey, setLastByKey] = useState({});\r\n\r\n  useEffect(() => {\r\n    const unsubscribe = subscribeErrorEvents((event) => {\r\n      const key = toEventKey(event);\r\n      const now = Date.now();\r\n      setLastByKey((current) => {\r\n        const lastAt = current[key] || 0;\r\n        if (now - lastAt < DEDUPE_WINDOW_MS) {\r\n          return current;\r\n        }\r\n        setQueue((items) => [\r\n          ...items,\r\n          {\r\n            id: `${key}:${now}`,\r\n            at: formatNow(),\r\n            code: event?.code || \"unknown_error\",\r\n            route: event?.route || event?.context?.route || \"-\",\r\n            message: event?.message || \"Error sin mensaje\",\r\n            requestId: event?.context?.request_id || \"-\",\r\n            traceId: event?.context?.trace_id || \"-\",\r\n            fingerprint: event?.fingerprint || \"-\",\r\n            source: event?.context?.source || event?.source || \"web\",\r\n          },\r\n        ]);\r\n        return { ...current, [key]: now };\r\n      });\r\n    });\r\n\r\n    return () => unsubscribe?.();\r\n  }, []);\r\n\r\n  const current = useMemo(() => queue[0] || null, [queue]);\r\n  if (!current) return null;\r\n\r\n  const close = () => {\r\n    setQueue((items) => items.slice(1));\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-[12000] flex items-center justify-center bg-black/45 p-4\">\r\n      <div className=\"w-full max-w-3xl rounded-2xl border border-red-100 bg-white p-5 shadow-xl\">\r\n        <div className=\"flex items-start justify-between gap-3\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <AlertTriangle size={18} className=\"text-red-600\" />\r\n            <h3 className=\"text-base font-bold text-red-700\">Runtime error detectado</h3>\r\n          </div>\r\n          <button\r\n            type=\"button\"\r\n            onClick={close}\r\n            className=\"rounded-lg border border-slate-200 px-2 py-1 text-xs font-semibold text-slate-700\"\r\n          >\r\n            X\r\n          </button>\r\n        </div>\r\n\r\n        <div className=\"mt-4 grid gap-2 text-sm text-slate-700 md:grid-cols-2\">\r\n          <div><span className=\"font-semibold\">Hora:</span> {current.at}</div>\r\n          <div><span className=\"font-semibold\">Code:</span> {current.code}</div>\r\n          <div><span className=\"font-semibold\">Route:</span> {current.route}</div>\r\n          <div><span className=\"font-semibold\">Source:</span> {current.source}</div>\r\n          <div><span className=\"font-semibold\">Request ID:</span> {current.requestId}</div>\r\n          <div><span className=\"font-semibold\">Trace ID:</span> {current.traceId}</div>\r\n        </div>\r\n\r\n        <div className=\"mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs text-slate-700\">\r\n          <div className=\"font-semibold\">Mensaje</div>\r\n          <div className=\"mt-1 whitespace-pre-wrap break-words\">{current.message}</div>\r\n          <div className=\"mt-2 text-[11px] text-slate-500\">\r\n            fingerprint: {current.fingerprint}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-4 flex justify-end\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={close}\r\n            className=\"rounded-xl bg-[#5E30A5] px-4 py-2 text-sm font-semibold text-white\"\r\n          >\r\n            Cerrar\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\observability\\ErrorCatalogTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\observability\\IssuesTable.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'FallbackIcon' is defined but never used.","line":602,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":602,"endColumn":70,"suggestions":[{"messageId":"removeVar","data":{"varName":"FallbackIcon"},"fix":{"range":[20648,20662],"text":""},"desc":"Remove unused variable 'FallbackIcon'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'navigate'. Either include it or remove the dependency array.","line":834,"column":6,"nodeType":"ArrayExpression","endLine":834,"endColumn":46,"suggestions":[{"desc":"Update the dependencies array to be: [isEventsRoute, isDetailsRoute, issueId, navigate]","fix":{"range":[28118,28158],"text":"[isEventsRoute, isDetailsRoute, issueId, navigate]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'symbolicatedFrames' conditional could make the dependencies of useMemo Hook (at line 950) change on every render. To fix this, wrap the initialization of 'symbolicatedFrames' in its own useMemo() Hook.","line":883,"column":9,"nodeType":"VariableDeclarator","endLine":885,"endColumn":9}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport {\r\n  AlertOctagon,\r\n  AlertCircle,\r\n  ArrowLeft,\r\n  Code2,\r\n  Globe2,\r\n  Layers3,\r\n  Mail,\r\n  Monitor,\r\n  RefreshCw,\r\n  Search,\r\n  Smartphone,\r\n  Sparkles,\r\n  Tablet,\r\n  Tags,\r\n  UserRound,\r\n} from \"lucide-react\";\r\nimport { useLocation, useNavigate, useSearchParams } from \"react-router-dom\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport Badge from \"../../components/ui/Badge\";\r\nimport Table from \"../../components/ui/Table\";\r\nimport {\r\n  BRAND_ICON_UI_NOTICE,\r\n  resolveBrandIcon,\r\n} from \"./brandIconPolicy\";\r\n\r\nconst LEVEL_VARIANT = {\r\n  fatal: \"bg-red-100 text-red-700\",\r\n  error: \"bg-red-100 text-red-700\",\r\n  warn: \"bg-amber-100 text-amber-700\",\r\n  info: \"bg-slate-100 text-slate-700\",\r\n  debug: \"bg-slate-100 text-slate-700\",\r\n};\r\n\r\nconst EVENT_DETAIL_SELECT = [\r\n  \"id\",\r\n  \"tenant_id\",\r\n  \"issue_id\",\r\n  \"occurred_at\",\r\n  \"created_at\",\r\n  \"level\",\r\n  \"event_type\",\r\n  \"message\",\r\n  \"error_code\",\r\n  \"request_id\",\r\n  \"trace_id\",\r\n  \"session_id\",\r\n  \"app_id\",\r\n  \"source\",\r\n  \"fingerprint\",\r\n  \"stack_preview\",\r\n  \"stack_raw\",\r\n  \"stack_frames_raw\",\r\n  \"context\",\r\n  \"breadcrumbs\",\r\n  \"release\",\r\n  \"device\",\r\n  \"user_ref\",\r\n  \"user_id\",\r\n  \"auth_user_id\",\r\n  \"ip_hash\",\r\n  \"event_domain\",\r\n  \"support_category\",\r\n  \"support_thread_id\",\r\n  \"support_route\",\r\n  \"support_screen\",\r\n  \"support_flow\",\r\n  \"support_flow_step\",\r\n  \"support_context_extra\",\r\n  \"support_received_at\",\r\n  \"retention_tier\",\r\n  \"retention_expires_at\",\r\n  \"symbolicated_stack\",\r\n  \"symbolication_status\",\r\n  \"symbolicated_at\",\r\n  \"symbolication_type\",\r\n  \"symbolication_release\",\r\n  \"release_version_label\",\r\n  \"release_source_commit_sha\",\r\n  \"release_version_id\",\r\n  \"release_semver\",\r\n  \"resolved_component_key\",\r\n  \"resolved_component_type\",\r\n  \"resolved_component_revision_no\",\r\n  \"resolved_component_revision_id\",\r\n  \"component_resolution_method\",\r\n  \"breadcrumbs_count\",\r\n  \"breadcrumbs_last_at\",\r\n  \"breadcrumbs_source\",\r\n  \"breadcrumbs_status\",\r\n  \"breadcrumbs_reason\",\r\n  \"breadcrumbs_meta\",\r\n].join(\", \");\r\n\r\nfunction formatDate(iso) {\r\n  if (!iso) return \"-\";\r\n  const date = new Date(iso);\r\n  if (Number.isNaN(date.getTime())) return \"-\";\r\n  return new Intl.DateTimeFormat(\"es-EC\", {\r\n    year: \"numeric\",\r\n    month: \"2-digit\",\r\n    day: \"2-digit\",\r\n    hour: \"2-digit\",\r\n    minute: \"2-digit\",\r\n    second: \"2-digit\",\r\n  }).format(date);\r\n}\r\n\r\nfunction parseSymbolicationFromEvent(event) {\r\n  if (event?.symbolicated_stack && typeof event.symbolicated_stack === \"object\") {\r\n    return {\r\n      symbolicated_stack: event.symbolicated_stack,\r\n      symbolication_status: event.symbolication_status || \"ok\",\r\n      symbolicated_at: event.symbolicated_at || null,\r\n      symbolication_type: event.symbolication_type || \"short\",\r\n      symbolication_release: event.symbolication_release || null,\r\n    };\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction formatFrame(frame) {\r\n  if (!frame || typeof frame !== \"object\") return \"-\";\r\n  const original = frame.original;\r\n  if (original?.source && original?.line != null) {\r\n    return `${original.source}:${original.line}:${original.column ?? 0}`;\r\n  }\r\n  if (frame.file && frame.line != null) {\r\n    return `${frame.file}:${frame.line}:${frame.column ?? 0}`;\r\n  }\r\n  return frame.raw || \"-\";\r\n}\r\n\r\nfunction safeJson(value) {\r\n  try {\r\n    return JSON.stringify(value ?? null, null, 2);\r\n  } catch {\r\n    return \"{}\";\r\n  }\r\n}\r\n\r\nfunction asArray(value) {\r\n  return Array.isArray(value) ? value : [];\r\n}\r\n\r\nfunction asObject(value) {\r\n  if (value && typeof value === \"object\" && !Array.isArray(value)) return value;\r\n  return {};\r\n}\r\n\r\nfunction asString(value) {\r\n  if (typeof value === \"string\") {\r\n    const next = value.trim();\r\n    return next || null;\r\n  }\r\n  if (typeof value === \"number\" || typeof value === \"boolean\") {\r\n    return String(value);\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction firstString(...values) {\r\n  for (const value of values) {\r\n    const next = asString(value);\r\n    if (next) return next;\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction normalizeKey(value) {\r\n  return asString(value)?.toLowerCase().replace(/\\s+/g, \"_\") || \"\";\r\n}\r\n\r\nconst SYMBOLICATION_STATUS_LABELS = {\r\n  ok: \"Mapeado correctamente\",\r\n  \"ok:dev_native_stack\": \"Dev: stack nativo (sin mapear)\",\r\n  \"ok:dev_manifest_passthrough\": \"Dev: sin manifest, stack nativo\",\r\n  \"ok:dev_no_mapped_frames\": \"Dev: sin frames mapeados, stack nativo\",\r\n  \"error:release_not_found\": \"Error: release no encontrado\",\r\n  \"error:manifest_path_missing\": \"Error: falta ruta del manifest\",\r\n  \"error:manifest_download_failed\": \"Error: no se pudo descargar el manifest\",\r\n  \"error:manifest_empty\": \"Error: manifest vacio\",\r\n  \"error:manifest_invalid_json\": \"Error: manifest invalido\",\r\n  \"error:no_mapped_frames\": \"Error: no se pudieron mapear frames\",\r\n};\r\n\r\nfunction formatSymbolicationStatus(value) {\r\n  const key = asString(value);\r\n  if (!key) return \"-\";\r\n  const known = SYMBOLICATION_STATUS_LABELS[key];\r\n  if (known) return known;\r\n  if (key.startsWith(\"error:\")) {\r\n    return `Error: ${key.slice(6).replace(/_/g, \" \")}`;\r\n  }\r\n  if (key.startsWith(\"ok:\")) {\r\n    return `OK: ${key.slice(3).replace(/_/g, \" \")}`;\r\n  }\r\n  return key;\r\n}\r\n\r\nfunction formatSymbolicationType(value) {\r\n  const key = normalizeKey(value);\r\n  if (!key) return \"-\";\r\n  if (key === \"short\") return \"Cache corto\";\r\n  if (key === \"long\") return \"Cache largo\";\r\n  return key;\r\n}\r\n\r\nfunction formatLevelLabel(value) {\r\n  const key = normalizeKey(value);\r\n  if (!key) return \"-\";\r\n  if (key === \"fatal\") return \"Critico (fatal)\";\r\n  if (key === \"error\") return \"Severo (error)\";\r\n  if (key === \"warn\") return \"Advertencia\";\r\n  if (key === \"info\") return \"Informativo\";\r\n  if (key === \"debug\") return \"Debug\";\r\n  return key;\r\n}\r\n\r\nfunction formatLevelBadge(value) {\r\n  const key = normalizeKey(value);\r\n  if (!key) return \"-\";\r\n  if (key === \"fatal\") return \"Critico\";\r\n  if (key === \"error\") return \"Severo\";\r\n  if (key === \"warn\") return \"Warn\";\r\n  if (key === \"info\") return \"Info\";\r\n  if (key === \"debug\") return \"Debug\";\r\n  return key;\r\n}\r\n\r\nfunction formatEventTypeLabel(value) {\r\n  const key = normalizeKey(value);\r\n  if (!key) return \"-\";\r\n  if (key === \"error\") return \"Error\";\r\n  if (key === \"log\") return \"Log\";\r\n  if (key === \"performance\") return \"Performance\";\r\n  if (key === \"security\") return \"Seguridad\";\r\n  if (key === \"audit\") return \"Auditoria\";\r\n  return key;\r\n}\r\n\r\nconst BREADCRUMB_STATUS_META = {\r\n  present: { label: \"Con breadcrumbs\", tone: \"ok\" },\r\n  missing_early_boot: { label: \"Sin breadcrumbs (arranque temprano)\", tone: \"warn\" },\r\n  missing_runtime_failure: { label: \"Sin breadcrumbs (fallo runtime)\", tone: \"warn\" },\r\n  missing_source_uninstrumented: { label: \"Sin breadcrumbs (origen sin instrumentar)\", tone: \"warn\" },\r\n  missing_payload_empty: { label: \"Sin breadcrumbs (payload vacio)\", tone: \"warn\" },\r\n  missing_storage_unavailable: { label: \"Sin breadcrumbs (storage no disponible)\", tone: \"warn\" },\r\n  missing_unknown: { label: \"Sin breadcrumbs (motivo no determinado)\", tone: \"warn\" },\r\n};\r\n\r\nconst BREADCRUMB_SOURCE_LABELS = {\r\n  memory: \"Memoria runtime\",\r\n  storage: \"Storage persistente\",\r\n  merged: \"Memoria + storage\",\r\n  provided: \"Payload del evento\",\r\n  none: \"Sin origen\",\r\n};\r\n\r\nconst BREADCRUMB_REASON_LABELS = {\r\n  runtime_not_initialized: \"El runtime no estaba inicializado cuando ocurrio el evento.\",\r\n  runtime_init_failed: \"Fallo durante la inicializacion del runtime de observabilidad.\",\r\n  runtime_runtime_error: \"El runtime de observabilidad reporto un error interno.\",\r\n  storage_unavailable: \"No habia storage disponible para persistir breadcrumbs.\",\r\n  storage_read_failed: \"Fallo al leer breadcrumbs persistidos.\",\r\n  storage_write_failed: \"Fallo al guardar breadcrumbs persistidos.\",\r\n  edge_without_breadcrumb_steps: \"El evento proviene de Edge sin pasos instrumentados.\",\r\n  worker_without_breadcrumb_steps: \"El evento proviene de Worker sin pasos instrumentados.\",\r\n  payload_breadcrumbs_empty: \"El payload envio breadcrumbs vacios.\",\r\n  missing_reason_not_determined: \"No se pudo determinar la causa exacta.\",\r\n};\r\n\r\nfunction formatKeyAsLabel(value) {\r\n  const raw = asString(value);\r\n  if (!raw) return \"-\";\r\n  return raw.replace(/_/g, \" \");\r\n}\r\n\r\nfunction resolveBreadcrumbDiagnostics(event) {\r\n  const meta = asObject(event?.breadcrumbs_meta);\r\n  const breadcrumbRows = asArray(event?.breadcrumbs);\r\n  const fromField = Number(event?.breadcrumbs_count);\r\n  const fromMeta = Number(meta.count);\r\n  const payloadCount = breadcrumbRows.length;\r\n  const count = payloadCount > 0\r\n    ? payloadCount\r\n    : Number.isFinite(fromField)\r\n      ? Math.max(0, Math.trunc(fromField))\r\n      : Number.isFinite(fromMeta)\r\n        ? Math.max(0, Math.trunc(fromMeta))\r\n        : 0;\r\n\r\n  const statusKey =\r\n    (payloadCount > 0\r\n      ? \"present\"\r\n      : normalizeKey(event?.breadcrumbs_status) ||\r\n        normalizeKey(meta.classified_status) ||\r\n        (count > 0 ? \"present\" : \"missing_unknown\"));\r\n  const sourceKey =\r\n    (payloadCount > 0\r\n      ? normalizeKey(event?.breadcrumbs_source) ||\r\n        normalizeKey(meta.source) ||\r\n        \"provided\"\r\n      : normalizeKey(event?.breadcrumbs_source) ||\r\n        normalizeKey(meta.source) ||\r\n        (count > 0 ? \"provided\" : \"none\"));\r\n  const reasonKey =\r\n    (payloadCount > 0\r\n      ? null\r\n      : normalizeKey(event?.breadcrumbs_reason) ||\r\n        normalizeKey(meta.classified_reason) ||\r\n        normalizeKey(meta.missing_reason_hint) ||\r\n        null);\r\n\r\n  return {\r\n    count,\r\n    lastAt: firstString(event?.breadcrumbs_last_at, meta.last_at),\r\n    status: statusKey || \"missing_unknown\",\r\n    statusLabel: BREADCRUMB_STATUS_META[statusKey]?.label || formatKeyAsLabel(statusKey),\r\n    statusTone: BREADCRUMB_STATUS_META[statusKey]?.tone || \"warn\",\r\n    source: sourceKey || \"none\",\r\n    sourceLabel: BREADCRUMB_SOURCE_LABELS[sourceKey] || formatKeyAsLabel(sourceKey),\r\n    reason: reasonKey,\r\n    reasonLabel: reasonKey ? (BREADCRUMB_REASON_LABELS[reasonKey] || formatKeyAsLabel(reasonKey)) : null,\r\n    meta,\r\n  };\r\n}\r\n\r\nfunction breadcrumbStatusClass(tone) {\r\n  if (tone === \"ok\") return \"border-emerald-200 bg-emerald-50 text-emerald-700\";\r\n  return \"border-amber-200 bg-amber-50 text-amber-700\";\r\n}\r\n\r\nfunction withPolicy(group, key, fallbackLabel = null) {\r\n  const policy = resolveBrandIcon(group, key, fallbackLabel);\r\n  return {\r\n    key: policy.key,\r\n    label: policy.label,\r\n    iconUrl: policy.iconUrl,\r\n    legalStatus: policy.legalStatus,\r\n    legalReason: policy.legalReason,\r\n    sourceUrl: policy.sourceUrl || null,\r\n    attribution: policy.attribution || null,\r\n  };\r\n}\r\n\r\nfunction detectBrowser(event) {\r\n  const device = asObject(event?.device);\r\n  const context = asObject(event?.context);\r\n  const release = asObject(event?.release);\r\n  const raw = normalizeKey(\r\n    firstString(\r\n      device.browser,\r\n      context.browser,\r\n      context.user_agent_browser,\r\n      release.browser,\r\n    ),\r\n  );\r\n  if (!raw) return withPolicy(\"browsers\", \"unknown\", \"Desconocido\");\r\n  if (raw.includes(\"chrome\")) return withPolicy(\"browsers\", \"chrome\", \"Chrome\");\r\n  if (raw.includes(\"firefox\") || raw.includes(\"mozilla\")) return withPolicy(\"browsers\", \"firefox\", \"Firefox\");\r\n  if (raw.includes(\"brave\")) return withPolicy(\"browsers\", \"brave\", \"Brave\");\r\n  if (raw.includes(\"safari\")) return withPolicy(\"browsers\", \"safari\", \"Safari\");\r\n  if (raw.includes(\"edge\")) return withPolicy(\"browsers\", \"edge\", \"Edge\");\r\n  if (raw.includes(\"opera\")) return withPolicy(\"browsers\", \"opera\", \"Opera\");\r\n  return withPolicy(\"browsers\", raw, raw);\r\n}\r\n\r\nfunction detectProvider(event) {\r\n  const userRef = asObject(event?.user_ref);\r\n  const context = asObject(event?.context);\r\n  const appMeta = asObject(userRef.app_metadata);\r\n\r\n  const raw = normalizeKey(\r\n    firstString(\r\n      userRef.provider,\r\n      appMeta.provider,\r\n      context.provider,\r\n      context.auth_provider,\r\n    ),\r\n  );\r\n\r\n  if (!raw) return withPolicy(\"providers\", \"unknown\", \"Desconocido\");\r\n  if (raw.includes(\"google\")) return withPolicy(\"providers\", \"google\", \"Google\");\r\n  if (raw.includes(\"facebook\")) return withPolicy(\"providers\", \"facebook\", \"Facebook\");\r\n  if (raw.includes(\"discord\")) return withPolicy(\"providers\", \"discord\", \"Discord\");\r\n  if (raw.includes(\"apple\")) return withPolicy(\"providers\", \"apple\", \"Apple\");\r\n  if (raw.includes(\"email\")) return withPolicy(\"providers\", \"email\", \"Correo\");\r\n  return withPolicy(\"providers\", raw, raw);\r\n}\r\n\r\nfunction detectContactEmail(event) {\r\n  const userRef = asObject(event?.user_ref);\r\n  const context = asObject(event?.context);\r\n  return firstString(\r\n    userRef.email,\r\n    context.email,\r\n    context.user_email,\r\n  );\r\n}\r\n\r\nfunction detectOs(event) {\r\n  const device = asObject(event?.device);\r\n  const context = asObject(event?.context);\r\n  const release = asObject(event?.release);\r\n  const raw = normalizeKey(\r\n    firstString(\r\n      device.os,\r\n      context.os,\r\n      context.platform,\r\n      release.os,\r\n    ),\r\n  );\r\n  if (!raw) return withPolicy(\"os\", \"unknown\", \"Desconocido\");\r\n  if (raw.includes(\"windows\")) return withPolicy(\"os\", \"windows\", \"Windows\");\r\n  if (raw.includes(\"android\")) return withPolicy(\"os\", \"android\", \"Android\");\r\n  if (raw.includes(\"ios\")) return withPolicy(\"os\", \"ios\", \"iOS\");\r\n  if (raw.includes(\"mac\") || raw.includes(\"darwin\")) return withPolicy(\"os\", \"macos\", \"macOS\");\r\n  if (raw.includes(\"linux\")) return withPolicy(\"os\", \"linux\", \"Linux\");\r\n  return withPolicy(\"os\", raw, raw);\r\n}\r\n\r\nfunction detectDeviceType(event, osKey) {\r\n  const device = asObject(event?.device);\r\n  const context = asObject(event?.context);\r\n  const raw = normalizeKey(\r\n    firstString(\r\n      device.type,\r\n      context.device_type,\r\n      context.device,\r\n    ),\r\n  );\r\n  if (raw.includes(\"tablet\")) return { key: \"tablet\", label: \"Tablet\", Icon: Tablet };\r\n  if (raw.includes(\"mobile\") || raw.includes(\"phone\")) return { key: \"phone\", label: \"Teléfono\", Icon: Smartphone };\r\n  if (raw.includes(\"desktop\") || raw.includes(\"pc\") || raw.includes(\"laptop\")) {\r\n    return { key: \"pc\", label: \"PC\", Icon: Monitor };\r\n  }\r\n  if (osKey === \"android\" || osKey === \"ios\") return { key: \"phone\", label: \"Teléfono\", Icon: Smartphone };\r\n  return { key: \"pc\", label: \"PC\", Icon: Monitor };\r\n}\r\n\r\nfunction buildImportantTags({ event, symbolicationInfo, identity, breadcrumbDiagnostics }) {\r\n  if (!event) return [];\r\n  const tags = [\r\n    { label: \"Nivel\", value: formatLevelLabel(event.level), tone: \"risk\" },\r\n    { label: \"Tipo\", value: formatEventTypeLabel(event.event_type), tone: \"base\" },\r\n    { label: \"Estado\", value: event.event_domain || \"-\", tone: \"base\" },\r\n    { label: \"Source\", value: event.source || \"-\", tone: \"base\" },\r\n    { label: \"App\", value: event.app_id || \"-\", tone: \"base\" },\r\n    { label: \"Release\", value: event.release_version_label || \"-\", tone: \"accent\" },\r\n    { label: \"Componente\", value: event.resolved_component_key || \"-\", tone: \"accent\" },\r\n    { label: \"Resolución\", value: event.component_resolution_method || \"-\", tone: \"base\" },\r\n    {\r\n      label: \"Symbolication\",\r\n      value: formatSymbolicationStatus(symbolicationInfo?.symbolication_status),\r\n      tone: \"accent\",\r\n    },\r\n    { label: \"Navegador\", value: identity.browser.label || \"-\", tone: \"base\" },\r\n    { label: \"Proveedor\", value: identity.provider.label || \"-\", tone: \"base\" },\r\n    { label: \"SO\", value: identity.os.label || \"-\", tone: \"base\" },\r\n    { label: \"Dispositivo\", value: identity.deviceType.label || \"-\", tone: \"base\" },\r\n    {\r\n      label: \"Breadcrumbs\",\r\n      value: breadcrumbDiagnostics?.statusLabel || \"-\",\r\n      tone: breadcrumbDiagnostics?.statusTone === \"ok\" ? \"base\" : \"risk\",\r\n    },\r\n    { label: \"Origen trail\", value: breadcrumbDiagnostics?.sourceLabel || \"-\", tone: \"base\" },\r\n    { label: \"Retention\", value: event.retention_tier || \"-\", tone: \"base\" },\r\n  ];\r\n  if (breadcrumbDiagnostics?.reasonLabel) {\r\n    tags.push({ label: \"Motivo trail\", value: breadcrumbDiagnostics.reasonLabel, tone: \"base\" });\r\n  }\r\n  return tags.filter((tag) => tag.value && tag.value !== \"-\");\r\n}\r\n\r\nfunction tagToneClass(tone) {\r\n  if (tone === \"risk\") return \"border-red-200 bg-red-50 text-red-700\";\r\n  if (tone === \"accent\") return \"border-[#D8C6FF] bg-[#F5F0FF] text-[#5E30A5]\";\r\n  return \"border-slate-200 bg-slate-50 text-slate-700\";\r\n}\r\n\r\nfunction normalizeBreadcrumb(entry, index) {\r\n  const obj = asObject(entry);\r\n  const title =\r\n    firstString(obj.message, obj.event, obj.action, obj.name, obj.category) ||\r\n    `Paso ${index + 1}`;\r\n  const timestamp = firstString(obj.timestamp, obj.occurred_at, obj.created_at, obj.time);\r\n  const detail =\r\n    firstString(\r\n      obj.description,\r\n      obj.route,\r\n      obj.screen,\r\n      obj.flow_step,\r\n      obj.details,\r\n      typeof entry === \"string\" ? entry : null,\r\n    ) || \"Sin detalle adicional\";\r\n\r\n  const meta = [\r\n    [\"nivel\", firstString(obj.level, obj.severity)],\r\n    [\"tipo\", firstString(obj.type, obj.event_type)],\r\n    [\"ruta\", firstString(obj.route, obj.path)],\r\n    [\"pantalla\", firstString(obj.screen)],\r\n    [\"flow\", firstString(obj.flow)],\r\n  ].filter((item) => item[1]);\r\n\r\n  return {\r\n    id: firstString(obj.id) || `crumb-${index}`,\r\n    index,\r\n    title,\r\n    timestamp,\r\n    detail,\r\n    meta,\r\n    raw: obj,\r\n  };\r\n}\r\n\r\nfunction toInt(value) {\r\n  const num = Number(value);\r\n  if (!Number.isFinite(num)) return null;\r\n  return Math.trunc(num);\r\n}\r\n\r\nfunction isErrorBreadcrumb(crumb, eventLevelKey, isLast) {\r\n  const raw = asObject(crumb?.raw);\r\n  const level = normalizeKey(firstString(raw.level, raw.severity));\r\n  const type = normalizeKey(firstString(raw.type, raw.event_type));\r\n  const hay = `${crumb?.title || \"\"} ${crumb?.detail || \"\"} ${level} ${type}`.toLowerCase();\r\n  const errorWords = [\r\n    \"error\",\r\n    \"fatal\",\r\n    \"exception\",\r\n    \"failed\",\r\n    \"fail\",\r\n    \"crash\",\r\n    \"throw\",\r\n    \"timeout\",\r\n    \"rejected\",\r\n  ];\r\n\r\n  if (level === \"error\" || level === \"fatal\") return true;\r\n  if (errorWords.some((word) => hay.includes(word))) return true;\r\n  if (isLast && (eventLevelKey === \"error\" || eventLevelKey === \"fatal\")) return true;\r\n  return false;\r\n}\r\n\r\nfunction buildFailedCodeContext(symbolicationInfo, symbolicatedFrames) {\r\n  const stack = asObject(symbolicationInfo?.symbolicated_stack);\r\n  const errorExcerpt = asObject(stack.error_excerpt);\r\n  const excerptLines = asArray(errorExcerpt.lines);\r\n\r\n  if (excerptLines.length > 0) {\r\n    const line = toInt(errorExcerpt.error_line) ?? toInt(errorExcerpt.line) ?? null;\r\n    const lines = excerptLines.map((entry, idx) => {\r\n      const row = asObject(entry);\r\n      const lineNo = toInt(row.line_no) ?? (line != null ? line - 10 + idx : idx + 1);\r\n      const text = firstString(row.text, row.code, row.value, \"\") || \"\";\r\n      const highlight = Boolean(row.highlight) || (line != null ? lineNo === line : false);\r\n      return { lineNo, text, highlight };\r\n    });\r\n    return {\r\n      source: firstString(errorExcerpt.source, \"unknown\"),\r\n      line: line ?? 1,\r\n      column: toInt(errorExcerpt.error_column) ?? toInt(errorExcerpt.column) ?? 0,\r\n      frameLabel: firstString(errorExcerpt.frame_name, \"Frame\"),\r\n      lines,\r\n    };\r\n  }\r\n\r\n  const frames = Array.isArray(symbolicatedFrames) ? symbolicatedFrames : [];\r\n  const frameWithExcerpt = frames.find((item) => {\r\n    const original = asObject(item?.original);\r\n    const excerpt = asObject(original.excerpt);\r\n    const lines = asArray(excerpt.lines);\r\n    return lines.length > 0;\r\n  });\r\n  if (!frameWithExcerpt) return null;\r\n\r\n  const original = asObject(frameWithExcerpt.original);\r\n  const excerpt = asObject(original.excerpt);\r\n  const rawLines = asArray(excerpt.lines);\r\n  if (!rawLines.length) return null;\r\n\r\n  const line = toInt(excerpt.error_line) ?? toInt(original.line) ?? toInt(frameWithExcerpt.line) ?? 1;\r\n  const lines = rawLines.map((entry, idx) => {\r\n    const row = asObject(entry);\r\n    const lineNo = toInt(row.line_no) ?? line - 10 + idx;\r\n    const text = firstString(row.text, row.code, row.value, \"\") || \"\";\r\n    const highlight = Boolean(row.highlight) || lineNo === line;\r\n    return { lineNo, text, highlight };\r\n  });\r\n\r\n  return {\r\n    source: firstString(original.source, frameWithExcerpt.file, frameWithExcerpt.generated_file, \"unknown\"),\r\n    line,\r\n    column: toInt(excerpt.error_column) ?? toInt(original.column) ?? toInt(frameWithExcerpt.column) ?? 0,\r\n    frameLabel: firstString(original.name, frameWithExcerpt.function, frameWithExcerpt.raw, \"Frame\"),\r\n    lines,\r\n  };\r\n}\r\n\r\nfunction IdentityCard({ title, value, subtitle, iconUrl, FallbackIcon }) {\r\n  return (\r\n    <div className=\"rounded-xl border border-[#E8E2F5] bg-white px-3 py-2.5\">\r\n      <div className=\"flex items-center gap-3\">\r\n        <div className=\"relative flex h-10 w-10 shrink-0 items-center justify-center rounded-lg border border-[#E7DDFB] bg-[#F7F2FF]\">\r\n          <FallbackIcon size={16} className=\"text-[#6A3EB1]\" />\r\n          {iconUrl ? (\r\n            <img\r\n              src={iconUrl}\r\n              alt={title}\r\n              loading=\"lazy\"\r\n              className=\"absolute h-5 w-5 object-contain\"\r\n              referrerPolicy=\"no-referrer\"\r\n              onError={(event) => {\r\n                event.currentTarget.style.display = \"none\";\r\n              }}\r\n            />\r\n          ) : null}\r\n        </div>\r\n        <div className=\"min-w-0\">\r\n          <div className=\"text-[10px] font-semibold uppercase tracking-[0.12em] text-slate-400\">\r\n            {title}\r\n          </div>\r\n          <div className=\"truncate text-sm font-semibold text-slate-800\">{value || \"-\"}</div>\r\n          {subtitle ? (\r\n            <div className=\"truncate text-[11px] text-slate-500\">{subtitle}</div>\r\n          ) : null}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function IssuesTable() {\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const [searchParams] = useSearchParams();\r\n\r\n  const path = location.pathname || \"\";\r\n  const isEventsRoute = path.endsWith(\"/issues/events\");\r\n  const isDetailsRoute = path.endsWith(\"/issues/events/details\");\r\n\r\n  const issueId = searchParams.get(\"issue\") || \"\";\r\n  const eventId = searchParams.get(\"event\") || \"\";\r\n\r\n  const [issues, setIssues] = useState([]);\r\n  const [events, setEvents] = useState([]);\r\n  const [eventDetails, setEventDetails] = useState(null);\r\n  const [query, setQuery] = useState(\"\");\r\n  const [loadingIssues, setLoadingIssues] = useState(false);\r\n  const [loadingEvents, setLoadingEvents] = useState(false);\r\n  const [error, setError] = useState(null);\r\n  const [symbolicateBusy, setSymbolicateBusy] = useState(false);\r\n  const [cacheIssueBusy, setCacheIssueBusy] = useState(false);\r\n  const [symbolicationError, setSymbolicationError] = useState(null);\r\n  const [symbolicationByEvent, setSymbolicationByEvent] = useState({});\r\n  const [issuePulseId, setIssuePulseId] = useState(null);\r\n  const [eventPulseId, setEventPulseId] = useState(null);\r\n  const issuePulseTimeoutRef = useRef(null);\r\n  const eventPulseTimeoutRef = useRef(null);\r\n\r\n  const loadIssues = async () => {\r\n    setLoadingIssues(true);\r\n    setError(null);\r\n    const { data, error: fetchError } = await supabase\r\n      .from(\"obs_issues\")\r\n      .select(\r\n        \"id, title, level, status, count_total, count_24h, first_seen_at, last_seen_at, last_release\",\r\n      )\r\n      .order(\"last_seen_at\", { ascending: false })\r\n      .limit(150);\r\n\r\n    if (fetchError) {\r\n      setError(fetchError.message || \"No se pudieron cargar los issues\");\r\n      setLoadingIssues(false);\r\n      return;\r\n    }\r\n    setIssues(Array.isArray(data) ? data : []);\r\n    setLoadingIssues(false);\r\n  };\r\n\r\n  const loadEvents = async (targetIssueId) => {\r\n    setEventPulseId(null);\r\n    setSymbolicationError(null);\r\n    if (!targetIssueId) {\r\n      setEvents([]);\r\n      return;\r\n    }\r\n    setLoadingEvents(true);\r\n    const { data, error: fetchError } = await supabase\r\n      .from(\"obs_events\")\r\n      .select(EVENT_DETAIL_SELECT)\r\n      .eq(\"issue_id\", targetIssueId)\r\n      .order(\"occurred_at\", { ascending: false })\r\n      .limit(80);\r\n\r\n    if (fetchError) {\r\n      setEvents([]);\r\n      setLoadingEvents(false);\r\n      return;\r\n    }\r\n    setEvents(Array.isArray(data) ? data : []);\r\n    setLoadingEvents(false);\r\n  };\r\n\r\n  const loadEventDetails = async (targetIssueId, targetEventId) => {\r\n    if (!targetEventId) {\r\n      setEventDetails(null);\r\n      return;\r\n    }\r\n    setLoadingEvents(true);\r\n    const { data, error: fetchError } = await supabase\r\n      .from(\"obs_events\")\r\n      .select(EVENT_DETAIL_SELECT)\r\n      .eq(\"id\", targetEventId)\r\n      .eq(\"issue_id\", targetIssueId)\r\n      .maybeSingle();\r\n    setLoadingEvents(false);\r\n\r\n    if (fetchError || !data) {\r\n      setEventDetails(null);\r\n      if (fetchError) {\r\n        setSymbolicationError(fetchError.message || \"No se pudo cargar el detalle del evento\");\r\n      }\r\n      return;\r\n    }\r\n\r\n    setEventDetails(data);\r\n  };\r\n\r\n  const symbolicateEvent = async (targetEventId, options = {}) => {\r\n    if (!targetEventId) return null;\r\n    setSymbolicateBusy(true);\r\n    setSymbolicationError(null);\r\n    const { data, error: invokeError } = await supabase.functions.invoke(\"obs-symbolicate\", {\r\n      body: {\r\n        action: \"event\",\r\n        event_id: targetEventId,\r\n        cache_type: options.cacheType || \"short\",\r\n        force: Boolean(options.force),\r\n      },\r\n    });\r\n    setSymbolicateBusy(false);\r\n\r\n    if (invokeError || !data?.ok || !data?.result) {\r\n      setSymbolicationError(\r\n        invokeError?.message ||\r\n          data?.result?.code ||\r\n          data?.code ||\r\n          \"No se pudo symbolicar el evento\",\r\n      );\r\n      return null;\r\n    }\r\n\r\n    setSymbolicationByEvent((current) => ({\r\n      ...current,\r\n      [targetEventId]: data.result,\r\n    }));\r\n    return data.result;\r\n  };\r\n\r\n  const cacheIssue = async () => {\r\n    if (!issueId) return;\r\n    setCacheIssueBusy(true);\r\n    setSymbolicationError(null);\r\n    const { data, error: invokeError } = await supabase.functions.invoke(\"obs-symbolicate\", {\r\n      body: {\r\n        action: \"issue\",\r\n        issue_id: issueId,\r\n        cache_type: \"long\",\r\n        force: true,\r\n      },\r\n    });\r\n    setCacheIssueBusy(false);\r\n\r\n    if (invokeError || !data?.ok) {\r\n      setSymbolicationError(\r\n        invokeError?.message || data?.code || \"No se pudo cachear la symbolication del issue\",\r\n      );\r\n      return;\r\n    }\r\n\r\n    const updates = {};\r\n    (data.results || []).forEach((item) => {\r\n      if (!item?.event_id) return;\r\n      updates[item.event_id] = item;\r\n    });\r\n    if (Object.keys(updates).length) {\r\n      setSymbolicationByEvent((current) => ({ ...current, ...updates }));\r\n    }\r\n    await loadEvents(issueId);\r\n  };\r\n\r\n  const openEventsScreen = (targetIssueId) => {\r\n    if (!targetIssueId) return;\r\n    setIssuePulseId(targetIssueId);\r\n    if (issuePulseTimeoutRef.current) {\r\n      window.clearTimeout(issuePulseTimeoutRef.current);\r\n    }\r\n    issuePulseTimeoutRef.current = window.setTimeout(() => {\r\n      setIssuePulseId(null);\r\n      issuePulseTimeoutRef.current = null;\r\n      navigate(`/admin/issues/events?issue=${encodeURIComponent(targetIssueId)}`);\r\n    }, 90);\r\n  };\r\n\r\n  const openEventDetails = (targetEventId) => {\r\n    if (!targetEventId || !issueId) return;\r\n    setEventPulseId(targetEventId);\r\n    if (eventPulseTimeoutRef.current) {\r\n      window.clearTimeout(eventPulseTimeoutRef.current);\r\n    }\r\n    eventPulseTimeoutRef.current = window.setTimeout(() => {\r\n      setEventPulseId(null);\r\n      eventPulseTimeoutRef.current = null;\r\n      navigate(\r\n        `/admin/issues/events/details?issue=${encodeURIComponent(issueId)}&event=${encodeURIComponent(targetEventId)}`,\r\n      );\r\n    }, 90);\r\n  };\r\n\r\n  useEffect(() => {\r\n    void loadIssues();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isEventsRoute && !isDetailsRoute) return;\r\n    if (!issueId) {\r\n      navigate(\"/admin/issues\", { replace: true });\r\n      return;\r\n    }\r\n    void loadEvents(issueId);\r\n  }, [isEventsRoute, isDetailsRoute, issueId]);\r\n\r\n  useEffect(() => {\r\n    if (!isDetailsRoute || !eventId || !issueId) return;\r\n    setSymbolicationError(null);\r\n    void loadEventDetails(issueId, eventId);\r\n    void symbolicateEvent(eventId, { cacheType: \"short\", force: true });\r\n  }, [isDetailsRoute, issueId, eventId]);\r\n\r\n  useEffect(() => {\r\n    if (!isDetailsRoute) {\r\n      setEventDetails(null);\r\n    }\r\n  }, [isDetailsRoute]);\r\n\r\n  useEffect(\r\n    () => () => {\r\n      if (issuePulseTimeoutRef.current) window.clearTimeout(issuePulseTimeoutRef.current);\r\n      if (eventPulseTimeoutRef.current) window.clearTimeout(eventPulseTimeoutRef.current);\r\n    },\r\n    [],\r\n  );\r\n\r\n  const filteredIssues = useMemo(() => {\r\n    const term = query.trim().toLowerCase();\r\n    if (!term) return issues;\r\n    return issues.filter((issue) => {\r\n      const title = String(issue.title || \"\").toLowerCase();\r\n      const level = String(issue.level || \"\").toLowerCase();\r\n      const release = String(issue.last_release || \"\").toLowerCase();\r\n      return title.includes(term) || level.includes(term) || release.includes(term);\r\n    });\r\n  }, [issues, query]);\r\n\r\n  const selectedIssue = useMemo(\r\n    () => issues.find((issue) => issue.id === issueId) || null,\r\n    [issues, issueId],\r\n  );\r\n\r\n  const selectedEvent = useMemo(() => {\r\n    if (eventDetails?.id === eventId) return eventDetails;\r\n    return events.find((event) => event.id === eventId) || null;\r\n  }, [eventDetails, events, eventId]);\r\n\r\n  const symbolicationInfo = useMemo(() => {\r\n    if (!selectedEvent) return null;\r\n    return symbolicationByEvent[selectedEvent.id] || parseSymbolicationFromEvent(selectedEvent);\r\n  }, [selectedEvent, symbolicationByEvent]);\r\n\r\n  const symbolicatedFrames = Array.isArray(symbolicationInfo?.symbolicated_stack?.frames)\r\n    ? symbolicationInfo.symbolicated_stack.frames\r\n    : [];\r\n\r\n  const breadcrumbDiagnostics = useMemo(\r\n    () => resolveBreadcrumbDiagnostics(selectedEvent),\r\n    [selectedEvent],\r\n  );\r\n\r\n  const identityInfo = useMemo(() => {\r\n    if (!selectedEvent) {\r\n      return {\r\n        browser: { label: \"-\", iconUrl: null },\r\n        provider: { label: \"-\", iconUrl: null },\r\n        os: { label: \"-\", iconUrl: null },\r\n        deviceType: { label: \"-\", Icon: Monitor },\r\n        email: null,\r\n      };\r\n    }\r\n    const browser = detectBrowser(selectedEvent);\r\n    const provider = detectProvider(selectedEvent);\r\n    const os = detectOs(selectedEvent);\r\n    const deviceType = detectDeviceType(selectedEvent, os.key);\r\n    const email = detectContactEmail(selectedEvent);\r\n    return { browser, provider, os, deviceType, email };\r\n  }, [selectedEvent]);\r\n\r\n  const brandLegalNotes = useMemo(() => {\r\n    const attributionRows = [identityInfo?.browser, identityInfo?.provider, identityInfo?.os]\r\n      .map((item) => firstString(item?.attribution))\r\n      .filter(Boolean);\r\n    return {\r\n      notice: BRAND_ICON_UI_NOTICE,\r\n      attributions: Array.from(new Set(attributionRows)),\r\n    };\r\n  }, [identityInfo]);\r\n\r\n  const importantTags = useMemo(\r\n    () =>\r\n      buildImportantTags({\r\n        event: selectedEvent,\r\n        symbolicationInfo,\r\n        identity: identityInfo,\r\n        breadcrumbDiagnostics,\r\n      }),\r\n    [selectedEvent, symbolicationInfo, identityInfo, breadcrumbDiagnostics],\r\n  );\r\n\r\n  const breadcrumbTimeline = useMemo(() => {\r\n    const raw = Array.isArray(selectedEvent?.breadcrumbs) ? selectedEvent.breadcrumbs : [];\r\n    const normalized = raw.map((entry, index) => normalizeBreadcrumb(entry, index));\r\n    const eventLevelKey = normalizeKey(selectedEvent?.level);\r\n    const flags = normalized.map((crumb, index) =>\r\n      isErrorBreadcrumb(crumb, eventLevelKey, index === normalized.length - 1),\r\n    );\r\n    let errorIndex = flags.lastIndexOf(true);\r\n    if (errorIndex < 0 && normalized.length > 0 && (eventLevelKey === \"error\" || eventLevelKey === \"fatal\")) {\r\n      errorIndex = normalized.length - 1;\r\n    }\r\n    return normalized.map((crumb, index) => ({\r\n      ...crumb,\r\n      isError: index === errorIndex,\r\n    }));\r\n  }, [selectedEvent]);\r\n\r\n  const failedCodeContext = useMemo(\r\n    () => buildFailedCodeContext(symbolicationInfo, symbolicatedFrames),\r\n    [symbolicationInfo, symbolicatedFrames],\r\n  );\r\n\r\n  if (isDetailsRoute) {\r\n    if (loadingEvents && !selectedEvent) {\r\n      return (\r\n        <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 text-sm text-slate-600\">\r\n          Cargando detalle del evento...\r\n        </div>\r\n      );\r\n    }\r\n\r\n    if (!selectedEvent) {\r\n      return (\r\n        <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 text-sm text-slate-600\">\r\n          Evento no encontrado para este issue.\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => navigate(`/admin/issues/events?issue=${encodeURIComponent(issueId)}`)}\r\n            className=\"ml-2 font-semibold text-[#5E30A5]\"\r\n          >\r\n            Volver a eventos\r\n          </button>\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <div className=\"space-y-4\">\r\n        <div className=\"flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-[#E9E2F7] bg-white p-4\">\r\n          <div className=\"min-w-0\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => navigate(`/admin/issues/events?issue=${encodeURIComponent(issueId)}`)}\r\n              className=\"inline-flex items-center gap-2 text-sm font-semibold text-[#5E30A5]\"\r\n            >\r\n              <ArrowLeft size={16} />\r\n              Volver a eventos\r\n            </button>\r\n            <div className=\"mt-2 text-base font-semibold text-[#2F1A55]\">Detalle del evento</div>\r\n            <div className=\"mt-1 text-xs text-slate-500\">{selectedEvent.id}</div>\r\n          </div>\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => symbolicateEvent(selectedEvent.id, { cacheType: \"short\", force: true })}\r\n            disabled={symbolicateBusy}\r\n            className=\"inline-flex items-center gap-2 rounded-xl border border-[#D9C8FF] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5] disabled:opacity-60\"\r\n          >\r\n            <RefreshCw size={13} className={symbolicateBusy ? \"animate-spin\" : undefined} />\r\n            {symbolicateBusy ? \"Procesando...\" : \"Re-symbolicate\"}\r\n          </button>\r\n        </div>\r\n\r\n        {symbolicationError ? (\r\n          <div className=\"rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-xs text-red-600\">\r\n            {symbolicationError}\r\n          </div>\r\n        ) : null}\r\n\r\n        <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n          <div className=\"mb-2 flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n            <Tags size={15} />\r\n            Tags importantes del evento\r\n          </div>\r\n          <div className=\"flex flex-wrap gap-2\">\r\n            {importantTags.map((tag) => (\r\n              <div\r\n                key={`${tag.label}-${tag.value}`}\r\n                className={`inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-[11px] font-semibold ${tagToneClass(tag.tone)}`}\r\n              >\r\n                <span className=\"opacity-80\">{tag.label}:</span>\r\n                <span>{tag.value}</span>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid gap-3 md:grid-cols-2 xl:grid-cols-4\">\r\n          <IdentityCard\r\n            title=\"Navegador\"\r\n            value={identityInfo.browser.label}\r\n            iconUrl={identityInfo.browser.iconUrl}\r\n            FallbackIcon={Globe2}\r\n          />\r\n          <IdentityCard\r\n            title=\"Proveedor\"\r\n            value={identityInfo.provider.label}\r\n            subtitle={identityInfo.email || null}\r\n            iconUrl={identityInfo.provider.iconUrl}\r\n            FallbackIcon={identityInfo.provider.key === \"email\" ? Mail : UserRound}\r\n          />\r\n          <IdentityCard\r\n            title=\"Sistema operativo\"\r\n            value={identityInfo.os.label}\r\n            iconUrl={identityInfo.os.iconUrl}\r\n            FallbackIcon={Monitor}\r\n          />\r\n          <IdentityCard\r\n            title=\"Dispositivo\"\r\n            value={identityInfo.deviceType.label}\r\n            subtitle={identityInfo.email ? \"Contacto detectado\" : \"Sin correo detectado\"}\r\n            iconUrl={null}\r\n            FallbackIcon={identityInfo.deviceType.Icon || Monitor}\r\n          />\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#ECE5FA] bg-[#FCFBFF] px-3 py-2 text-[11px] text-slate-600\">\r\n          <div>{brandLegalNotes.notice}</div>\r\n          {brandLegalNotes.attributions.map((line, idx) => (\r\n            <div key={`brand-attr-${idx}`} className=\"mt-1 text-[10px] text-slate-500\">\r\n              {line}\r\n            </div>\r\n          ))}\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n          <div className=\"mb-3 flex flex-wrap items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n            <Layers3 size={15} />\r\n            Secuencia de breadcrumbs\r\n            <span className=\"rounded-full border border-[#E2D6FA] bg-[#F6F2FF] px-2 py-0.5 text-[10px] font-semibold text-[#5E30A5]\">\r\n              {breadcrumbTimeline.length}\r\n            </span>\r\n            <span\r\n              className={`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${breadcrumbStatusClass(\r\n                breadcrumbDiagnostics.statusTone,\r\n              )}`}\r\n            >\r\n              {breadcrumbDiagnostics.statusLabel}\r\n            </span>\r\n            <span className=\"rounded-full border border-slate-200 bg-slate-50 px-2 py-0.5 text-[10px] font-semibold text-slate-600\">\r\n              {breadcrumbDiagnostics.sourceLabel}\r\n            </span>\r\n          </div>\r\n          <div className=\"mb-3 grid gap-2 text-[11px] text-slate-600 sm:grid-cols-2 xl:grid-cols-4\">\r\n            <div className=\"rounded-lg border border-slate-200 bg-slate-50 px-2 py-1.5\">\r\n              <span className=\"font-semibold text-slate-700\">Count:</span> {breadcrumbDiagnostics.count}\r\n            </div>\r\n            <div className=\"rounded-lg border border-slate-200 bg-slate-50 px-2 py-1.5\">\r\n              <span className=\"font-semibold text-slate-700\">Last at:</span> {formatDate(breadcrumbDiagnostics.lastAt)}\r\n            </div>\r\n            <div className=\"rounded-lg border border-slate-200 bg-slate-50 px-2 py-1.5\">\r\n              <span className=\"font-semibold text-slate-700\">Status key:</span> {breadcrumbDiagnostics.status}\r\n            </div>\r\n            <div className=\"rounded-lg border border-slate-200 bg-slate-50 px-2 py-1.5\">\r\n              <span className=\"font-semibold text-slate-700\">Source key:</span> {breadcrumbDiagnostics.source}\r\n            </div>\r\n          </div>\r\n          {breadcrumbDiagnostics.reasonLabel ? (\r\n            <div className=\"mb-3 rounded-lg border border-amber-200 bg-amber-50 px-3 py-2 text-[11px] text-amber-800\">\r\n              <span className=\"font-semibold\">Motivo:</span> {breadcrumbDiagnostics.reasonLabel}\r\n            </div>\r\n          ) : null}\r\n\r\n          {breadcrumbTimeline.length > 0 ? (\r\n            <div className=\"space-y-2\">\r\n              {breadcrumbTimeline.map((crumb, idx) => (\r\n                <div key={`${crumb.id}-${idx}`} className=\"relative pl-14\">\r\n                  {idx < breadcrumbTimeline.length - 1 ? (\r\n                    <div\r\n                      className={`absolute left-[22px] top-[40px] h-[calc(100%-24px)] w-px ${\r\n                        crumb.isError\r\n                          ? \"bg-gradient-to-b from-red-300 to-transparent\"\r\n                          : \"bg-gradient-to-b from-[#CBB8F3] to-transparent\"\r\n                      }`}\r\n                    />\r\n                  ) : null}\r\n                  <div\r\n                    className={`absolute left-0 top-2 flex h-11 w-11 items-center justify-center rounded-xl text-sm font-bold ${\r\n                      crumb.isError\r\n                        ? \"border border-red-300 bg-red-100 text-red-700\"\r\n                        : \"border border-[#DCCBFF] bg-[#F4EDFF] text-[#5E30A5]\"\r\n                    }`}\r\n                  >\r\n                    {crumb.isError ? <AlertOctagon size={18} /> : idx + 1}\r\n                  </div>\r\n\r\n                  <div\r\n                    className={`min-h-[84px] rounded-xl px-4 py-3 ${\r\n                      crumb.isError\r\n                        ? \"border border-red-200 bg-red-50\"\r\n                        : \"border border-[#EEE7FC] bg-[#FCFBFF]\"\r\n                    }`}\r\n                  >\r\n                    <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n                      <div className={`text-sm font-semibold ${crumb.isError ? \"text-red-700\" : \"text-slate-800\"}`}>\r\n                        {crumb.title}\r\n                      </div>\r\n                      <div className={`text-[11px] ${crumb.isError ? \"text-red-600\" : \"text-slate-500\"}`}>\r\n                        {crumb.timestamp ? formatDate(crumb.timestamp) : \"Sin timestamp\"}\r\n                      </div>\r\n                    </div>\r\n                    {crumb.isError ? (\r\n                      <div className=\"mt-1 inline-flex items-center rounded-full border border-red-200 bg-white px-2 py-0.5 text-[10px] font-semibold text-red-700\">\r\n                        Paso con error\r\n                      </div>\r\n                    ) : null}\r\n                    <div className={`mt-1 text-xs ${crumb.isError ? \"text-red-700\" : \"text-slate-600\"}`}>\r\n                      {crumb.detail}\r\n                    </div>\r\n                    {crumb.meta.length > 0 ? (\r\n                      <div className=\"mt-2 flex flex-wrap gap-1.5\">\r\n                        {crumb.meta.map(([key, value]) => (\r\n                          <div\r\n                            key={`${crumb.id}-${key}`}\r\n                            className={`rounded-md bg-white px-2 py-0.5 text-[10px] ${\r\n                              crumb.isError\r\n                                ? \"border border-red-200 text-red-700\"\r\n                                : \"border border-[#E5DBF8] text-slate-600\"\r\n                            }`}\r\n                          >\r\n                            <span className=\"font-semibold text-[#5E30A5]\">{key}:</span> {value}\r\n                          </div>\r\n                        ))}\r\n                      </div>\r\n                    ) : null}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <div className=\"rounded-lg border border-dashed border-[#DDD4F3] px-3 py-4 text-center text-xs text-slate-500\">\r\n              Este evento no tiene breadcrumbs registrados.{\" \"}\r\n              {breadcrumbDiagnostics.reasonLabel\r\n                ? `Motivo detectado: ${breadcrumbDiagnostics.reasonLabel}`\r\n                : \"Motivo detectado: no determinado.\"}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-red-200 bg-red-50 p-3\">\r\n          <div className=\"mb-2 flex items-center gap-2 text-sm font-semibold text-red-700\">\r\n            <Code2 size={15} />\r\n            Codigo que fallo\r\n          </div>\r\n\r\n          {failedCodeContext ? (\r\n            <>\r\n              <div className=\"mb-2 text-xs text-red-700\">\r\n                {failedCodeContext.source}:{failedCodeContext.line}:{failedCodeContext.column}\r\n              </div>\r\n              <div className=\"overflow-auto rounded-lg border border-red-200 bg-[#211A2B] p-2\">\r\n                <div className=\"min-w-[420px] space-y-1 font-mono text-[11px] leading-5\">\r\n                  {failedCodeContext.lines.map((line, idx) => (\r\n                    <div\r\n                      key={`${failedCodeContext.source}-${line.lineNo}-${idx}`}\r\n                      className={`grid grid-cols-[56px_minmax(0,1fr)] items-start gap-3 rounded px-2 py-0.5 ${\r\n                        line.highlight ? \"bg-red-500/20 ring-1 ring-red-400/50\" : \"bg-transparent\"\r\n                      }`}\r\n                    >\r\n                      <span className={`text-right ${line.highlight ? \"text-red-200\" : \"text-slate-500\"}`}>\r\n                        {line.lineNo}\r\n                      </span>\r\n                      <pre\r\n                        className={`whitespace-pre-wrap break-words ${\r\n                          line.highlight ? \"text-red-100\" : \"text-slate-100\"\r\n                        }`}\r\n                      >\r\n                        {line.text || \" \"}\r\n                      </pre>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n              <div className=\"mt-2 text-[11px] text-red-700\">\r\n                {failedCodeContext.frameLabel || \"Frame\"}\r\n              </div>\r\n            </>\r\n          ) : (\r\n            <div className=\"rounded-lg border border-dashed border-red-200 bg-white px-3 py-4 text-center text-xs text-red-600\">\r\n              No hay codigo fuente disponible para este release/frame.\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"grid gap-3 md:grid-cols-2\">\r\n          <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3 text-xs text-slate-700\">\r\n            <div><span className=\"font-semibold\">Fecha:</span> {formatDate(selectedEvent.occurred_at)}</div>\r\n            <div><span className=\"font-semibold\">Severidad:</span> {formatLevelLabel(selectedEvent.level)}</div>\r\n            <div><span className=\"font-semibold\">Clase:</span> {formatEventTypeLabel(selectedEvent.event_type)}</div>\r\n            <div><span className=\"font-semibold\">Codigo:</span> {selectedEvent.error_code || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Issue:</span> {selectedEvent.issue_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">App:</span> {selectedEvent.app_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Source:</span> {selectedEvent.source || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Tenant:</span> {selectedEvent.tenant_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Request:</span> {selectedEvent.request_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Trace:</span> {selectedEvent.trace_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Session:</span> {selectedEvent.session_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Fingerprint:</span> {selectedEvent.fingerprint || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">IP Hash:</span> {selectedEvent.ip_hash || \"-\"}</div>\r\n          </div>\r\n          <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3 text-xs text-slate-700\">\r\n            <div><span className=\"font-semibold\">Release:</span> {selectedEvent.release_version_label || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Semver:</span> {selectedEvent.release_semver || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Release ID:</span> {selectedEvent.release_version_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Commit:</span> {selectedEvent.release_source_commit_sha || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Component:</span> {selectedEvent.resolved_component_key || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Type:</span> {selectedEvent.resolved_component_type || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Revision:</span> {selectedEvent.resolved_component_revision_no ?? \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Revision ID:</span> {selectedEvent.resolved_component_revision_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Resolution:</span> {selectedEvent.component_resolution_method || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Symbolication status:</span> {formatSymbolicationStatus(symbolicationInfo?.symbolication_status)}</div>\r\n            <div><span className=\"font-semibold\">Symbolication type:</span> {formatSymbolicationType(symbolicationInfo?.symbolication_type)}</div>\r\n            <div><span className=\"font-semibold\">Symbolicated at:</span> {formatDate(symbolicationInfo?.symbolicated_at)}</div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid gap-3 md:grid-cols-2\">\r\n          <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3 text-xs text-slate-700\">\r\n            <div><span className=\"font-semibold\">Dominio:</span> {selectedEvent.event_domain || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Categoria soporte:</span> {selectedEvent.support_category || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Thread soporte:</span> {selectedEvent.support_thread_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Ruta soporte:</span> {selectedEvent.support_route || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Screen soporte:</span> {selectedEvent.support_screen || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Flow:</span> {selectedEvent.support_flow || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Flow step:</span> {selectedEvent.support_flow_step || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Recibido soporte:</span> {formatDate(selectedEvent.support_received_at)}</div>\r\n          </div>\r\n          <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3 text-xs text-slate-700\">\r\n            <div><span className=\"font-semibold\">Retention tier:</span> {selectedEvent.retention_tier || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Retention expires:</span> {formatDate(selectedEvent.retention_expires_at)}</div>\r\n            <div><span className=\"font-semibold\">Breadcrumbs status:</span> {breadcrumbDiagnostics.statusLabel}</div>\r\n            <div><span className=\"font-semibold\">Breadcrumbs source:</span> {breadcrumbDiagnostics.sourceLabel}</div>\r\n            <div><span className=\"font-semibold\">Breadcrumbs reason:</span> {breadcrumbDiagnostics.reasonLabel || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Breadcrumbs count:</span> {breadcrumbDiagnostics.count}</div>\r\n            <div><span className=\"font-semibold\">Breadcrumbs last at:</span> {formatDate(breadcrumbDiagnostics.lastAt)}</div>\r\n            <div><span className=\"font-semibold\">User ID:</span> {selectedEvent.user_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Auth user ID:</span> {selectedEvent.auth_user_id || \"-\"}</div>\r\n            <div><span className=\"font-semibold\">Created at:</span> {formatDate(selectedEvent.created_at)}</div>\r\n            <div><span className=\"font-semibold\">Event ID:</span> {selectedEvent.id || \"-\"}</div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n          <div className=\"mb-2 text-sm font-semibold text-[#2F1A55]\">Mensaje</div>\r\n          <div className=\"text-sm text-slate-700\">{selectedEvent.message || \"-\"}</div>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n          <div className=\"mb-2 text-sm font-semibold text-[#2F1A55]\">Stack preview</div>\r\n          <pre className=\"max-h-56 overflow-auto whitespace-pre-wrap text-xs text-slate-700\">\r\n            {selectedEvent.stack_preview || \"-\"}\r\n          </pre>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n          <div className=\"mb-2 text-sm font-semibold text-[#2F1A55]\">Stack raw</div>\r\n          <pre className=\"max-h-72 overflow-auto whitespace-pre-wrap text-xs text-slate-700\">\r\n            {selectedEvent.stack_raw || \"-\"}\r\n          </pre>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n          <div className=\"mb-2 text-sm font-semibold text-[#2F1A55]\">\r\n            Frames symbolicated ({symbolicatedFrames.length})\r\n          </div>\r\n          {symbolicatedFrames.length > 0 ? (\r\n            <div className=\"max-h-72 space-y-1 overflow-auto rounded-lg border border-[#ECE5FA] bg-[#FCFBFF] p-2 text-[11px] text-slate-700\">\r\n              {symbolicatedFrames.map((frame, idx) => (\r\n                <div key={`${frame.raw || frame.file || \"frame\"}-${idx}`}>\r\n                  {idx + 1}. {formatFrame(frame)}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          ) : (\r\n            <div className=\"rounded-lg border border-dashed border-[#DDD4F3] px-2 py-3 text-center text-xs text-slate-500\">\r\n              Sin frames symbolicated para este evento.\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"grid gap-3 md:grid-cols-2\">\r\n          <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n            <div className=\"mb-2 text-sm font-semibold text-[#2F1A55]\">Context</div>\r\n            <pre className=\"max-h-72 overflow-auto whitespace-pre-wrap text-[11px] text-slate-700\">\r\n              {safeJson(selectedEvent.context)}\r\n            </pre>\r\n          </div>\r\n          <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n            <div className=\"mb-2 text-sm font-semibold text-[#2F1A55]\">Release / Device / UserRef</div>\r\n            <pre className=\"max-h-72 overflow-auto whitespace-pre-wrap text-[11px] text-slate-700\">\r\n              {safeJson({\r\n                release: selectedEvent.release,\r\n                device: selectedEvent.device,\r\n                user_ref: selectedEvent.user_ref,\r\n                breadcrumbs: selectedEvent.breadcrumbs,\r\n                breadcrumbs_meta: selectedEvent.breadcrumbs_meta,\r\n                support_context_extra: selectedEvent.support_context_extra,\r\n              })}\r\n            </pre>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E8E2F5] bg-white p-3\">\r\n          <div className=\"mb-2 text-sm font-semibold text-[#2F1A55]\">Evento completo (raw)</div>\r\n          <pre className=\"max-h-72 overflow-auto whitespace-pre-wrap text-[11px] text-slate-700\">\r\n            {safeJson(selectedEvent)}\r\n          </pre>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (isEventsRoute) {\r\n    return (\r\n      <div className=\"space-y-4\">\r\n        <div className=\"flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-[#E9E2F7] bg-white p-4\">\r\n          <div className=\"min-w-0\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => navigate(\"/admin/issues\")}\r\n              className=\"inline-flex items-center gap-2 text-sm font-semibold text-[#5E30A5]\"\r\n            >\r\n              <ArrowLeft size={16} />\r\n              Volver a issues\r\n            </button>\r\n            <div className=\"mt-2 truncate text-base font-semibold text-[#2F1A55]\">\r\n              {selectedIssue?.title || \"Issue\"}\r\n            </div>\r\n            <div className=\"mt-1 text-xs text-slate-500\">\r\n              {issueId || \"-\"} | release: {selectedIssue?.last_release || \"-\"}\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => loadEvents(issueId)}\r\n              disabled={!issueId || loadingEvents}\r\n              className=\"inline-flex items-center gap-2 rounded-xl border border-[#D9C8FF] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5] disabled:opacity-60\"\r\n            >\r\n              <RefreshCw size={13} className={loadingEvents ? \"animate-spin\" : undefined} />\r\n              Recargar eventos\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={cacheIssue}\r\n              disabled={!issueId || cacheIssueBusy}\r\n              className=\"inline-flex items-center gap-2 rounded-xl border border-[#D9C8FF] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5] disabled:opacity-60\"\r\n            >\r\n              <Sparkles size={13} />\r\n              {cacheIssueBusy ? \"Cacheando...\" : \"Cachear issue (30d)\"}\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        {symbolicationError ? (\r\n          <div className=\"rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-xs text-red-600\">\r\n            {symbolicationError}\r\n          </div>\r\n        ) : null}\r\n\r\n        <div className=\"space-y-2\">\r\n          {events.map((event) => (\r\n            <button\r\n              type=\"button\"\r\n              key={event.id}\r\n              onClick={() => openEventDetails(event.id)}\r\n              className={`w-full rounded-xl border px-3 py-2 text-left text-xs transition ${\r\n                eventPulseId === event.id\r\n                  ? \"border-[#4AAFA4] bg-[#E6FAF7] ring-2 ring-[#4AAFA4]/40\"\r\n                  : \"border-[#EFE9FA] bg-[#FCFBFF] hover:border-[#D9C8FF]\"\r\n              }`}\r\n            >\r\n              <div className=\"flex flex-wrap items-center gap-2\">\r\n                <Badge className={LEVEL_VARIANT[event.level] || LEVEL_VARIANT.info}>\r\n                  {formatLevelBadge(event.level)}\r\n                </Badge>\r\n                <span className=\"font-semibold text-slate-700\">{formatEventTypeLabel(event.event_type)}</span>\r\n                <span className=\"text-slate-500\">{formatDate(event.occurred_at)}</span>\r\n              </div>\r\n              <div className=\"mt-1 text-sm text-slate-700\">{event.message}</div>\r\n              <div className=\"mt-1 flex flex-wrap gap-x-4 gap-y-1 text-[11px] text-slate-500\">\r\n                <span>code: {event.error_code || \"-\"}</span>\r\n                <span>request: {event.request_id || \"-\"}</span>\r\n                <span>trace: {event.trace_id || \"-\"}</span>\r\n                <span>session: {event.session_id || \"-\"}</span>\r\n                <span>app: {event.app_id || \"-\"}</span>\r\n              </div>\r\n              <div className=\"mt-1 flex flex-wrap gap-x-4 gap-y-1 text-[11px] text-slate-500\">\r\n                <span>release: {event.release_version_label || \"-\"}</span>\r\n                <span>component: {event.resolved_component_key || \"-\"}</span>\r\n                <span>rev: {event.resolved_component_revision_no ?? \"-\"}</span>\r\n                <span>res: {event.component_resolution_method || \"unresolved\"}</span>\r\n              </div>\r\n            </button>\r\n          ))}\r\n          {!loadingEvents && events.length === 0 ? (\r\n            <div className=\"rounded-xl border border-dashed border-[#DDD4F3] px-3 py-4 text-center text-xs text-slate-500\">\r\n              No hay eventos para este issue.\r\n            </div>\r\n          ) : null}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-5\">\r\n      <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n        <div className=\"relative w-full max-w-sm\">\r\n          <Search\r\n            size={16}\r\n            className=\"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\"\r\n          />\r\n          <input\r\n            value={query}\r\n            onChange={(event) => setQuery(event.target.value)}\r\n            placeholder=\"Buscar por titulo, nivel o release\"\r\n            className=\"h-10 w-full rounded-xl border border-[#E7E1FF] bg-white pl-9 pr-3 text-sm text-slate-700 outline-none focus:border-[#5E30A5]\"\r\n          />\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          onClick={loadIssues}\r\n          disabled={loadingIssues}\r\n          className=\"inline-flex items-center gap-2 rounded-xl border border-[#D9C8FF] bg-white px-3 py-2 text-sm font-semibold text-[#5E30A5] disabled:opacity-60\"\r\n        >\r\n          <RefreshCw size={15} className={loadingIssues ? \"animate-spin\" : undefined} />\r\n          Recargar\r\n        </button>\r\n      </div>\r\n\r\n      {error ? (\r\n        <div className=\"flex items-center gap-2 rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-sm text-red-600\">\r\n          <AlertCircle size={15} />\r\n          {error}\r\n        </div>\r\n      ) : null}\r\n\r\n      <Table\r\n        columns={[\r\n          { key: \"title\", label: \"Issue\" },\r\n          { key: \"level\", label: \"Nivel\" },\r\n          { key: \"status\", label: \"Estado\" },\r\n          { key: \"count\", label: \"Eventos\" },\r\n          { key: \"last\", label: \"Ultima vez\", hideOnMobile: true },\r\n        ]}\r\n      >\r\n        {filteredIssues.map((issue) => (\r\n          <tr\r\n            key={issue.id}\r\n            onClick={() => openEventsScreen(issue.id)}\r\n            className={`cursor-pointer transition ${\r\n              issue.id === issuePulseId\r\n                ? \"bg-[#E6FAF7] ring-2 ring-[#4AAFA4]/45 shadow-[inset_0_0_0_1px_rgba(74,175,164,0.35)]\"\r\n                : \"hover:bg-[#FAF8FF]\"\r\n            }`}\r\n          >\r\n            <td className=\"px-4 py-3\">\r\n              <div className=\"font-semibold text-slate-800\">{issue.title}</div>\r\n              <div className=\"text-xs text-slate-400\">{issue.id}</div>\r\n              <div className=\"text-[11px] text-[#5E30A5]\">Click para ver eventos</div>\r\n            </td>\r\n            <td className=\"px-4 py-3\">\r\n              <Badge className={LEVEL_VARIANT[issue.level] || LEVEL_VARIANT.info}>\r\n                {formatLevelBadge(issue.level)}\r\n              </Badge>\r\n            </td>\r\n            <td className=\"px-4 py-3 text-slate-600\">{issue.status}</td>\r\n            <td className=\"px-4 py-3 text-slate-600\">\r\n              {issue.count_total} (24h: {issue.count_24h})\r\n            </td>\r\n            <td className=\"hidden px-4 py-3 text-slate-600 md:table-cell\">\r\n              {formatDate(issue.last_seen_at)}\r\n            </td>\r\n          </tr>\r\n        ))}\r\n      </Table>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\observability\\brandIconPolicy.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\ops\\useOpsTelemetryHotSync.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\prelaunch\\PrelaunchAnalyticsPanel.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":100,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":100,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[2633,2644],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState } from \"react\";\r\nimport { BarChart3, Clock3, RefreshCw, ShieldAlert, Ticket, Users } from \"lucide-react\";\r\nimport Table from \"../../components/ui/Table\";\r\nimport { usePrelaunchMetrics } from \"./hooks/usePrelaunchMetrics\";\r\n\r\nconst RANGE_OPTIONS = [\r\n  { value: 1, label: \"24 horas\" },\r\n  { value: 7, label: \"7 dias\" },\r\n  { value: 14, label: \"14 dias\" },\r\n  { value: 30, label: \"30 dias\" },\r\n  { value: 60, label: \"60 dias\" },\r\n  { value: 90, label: \"90 dias\" },\r\n];\r\n\r\nconst CHANNEL_OPTIONS = [\r\n  { value: \"\", label: \"Todos los canales\" },\r\n  { value: \"prelaunch_web\", label: \"Prelaunch Web\" },\r\n  { value: \"pwa_web\", label: \"PWA Web\" },\r\n  { value: \"android\", label: \"Android\" },\r\n];\r\n\r\nconst TABS = [\r\n  { id: \"overview\", label: \"Resumen\" },\r\n  { id: \"funnel\", label: \"Funnel\" },\r\n  { id: \"waitlist\", label: \"Waitlist\" },\r\n  { id: \"tickets\", label: \"Tickets\" },\r\n  { id: \"risk\", label: \"Riesgo\" },\r\n];\r\n\r\nconst WAITLIST_ROLE_LABELS = {\r\n  cliente: \"Cliente\",\r\n  negocio: \"Negocio\",\r\n};\r\n\r\nconst WAITLIST_STATUS_LABELS = {\r\n  pending_confirm: \"Pendiente confirmacion\",\r\n  active: \"Activo\",\r\n  unsubscribed: \"Desuscrito\",\r\n  blocked: \"Bloqueado\",\r\n};\r\n\r\nconst SUPPORT_STATUS_LABELS = {\r\n  new: \"Nuevo\",\r\n  assigned: \"Asignado\",\r\n  in_progress: \"En progreso\",\r\n  waiting_user: \"Esperando usuario\",\r\n  queued: \"En cola\",\r\n  closed: \"Cerrado\",\r\n  cancelled: \"Cancelado\",\r\n};\r\n\r\nconst SUPPORT_SEVERITY_LABELS = {\r\n  s0: \"S0 Critico\",\r\n  s1: \"S1 Alto\",\r\n  s2: \"S2 Medio\",\r\n  s3: \"S3 Bajo\",\r\n};\r\n\r\nconst SUPPORT_CATEGORY_LABELS = {\r\n  acceso: \"Acceso / Cuenta\",\r\n  verificacion: \"Verificacion\",\r\n  qr: \"QR / Escaner\",\r\n  promos: \"Promociones\",\r\n  negocios_sucursales: \"Negocios / Sucursales\",\r\n  pagos_plan: \"Pagos / Plan\",\r\n  reporte_abuso: \"Reporte de abuso\",\r\n  bug_performance: \"Bug / performance\",\r\n  sugerencia: \"Sugerencia\",\r\n  tier_beneficios: \"Tier / beneficios\",\r\n  borrar_correo_waitlist: \"Borrar correo waitlist\",\r\n};\r\n\r\nfunction formatNumber(value) {\r\n  return Number(value || 0).toLocaleString(\"es-EC\");\r\n}\r\n\r\nfunction formatPercent(value) {\r\n  const pct = Number(value || 0) * 100;\r\n  return `${pct.toFixed(1)}%`;\r\n}\r\n\r\nfunction formatDateTime(iso) {\r\n  if (!iso) return \"-\";\r\n  const date = new Date(iso);\r\n  if (Number.isNaN(date.getTime())) return \"-\";\r\n  return date.toLocaleString(\"es-EC\", {\r\n    day: \"2-digit\",\r\n    month: \"2-digit\",\r\n    hour: \"2-digit\",\r\n    minute: \"2-digit\",\r\n  });\r\n}\r\n\r\nfunction truncateRiskId(value) {\r\n  const safe = String(value || \"\");\r\n  if (safe.length <= 14) return safe;\r\n  return `${safe.slice(0, 6)}...${safe.slice(-6)}`;\r\n}\r\n\r\nfunction StatCard({ icon: Icon, title, value, helper }) {\r\n  return (\r\n    <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\">\r\n      <div className=\"flex items-center gap-2 text-xs font-semibold text-slate-500\">\r\n        <Icon size={15} />\r\n        {title}\r\n      </div>\r\n      <div className=\"mt-3 text-2xl font-bold text-[#2F1A55]\">{value}</div>\r\n      <div className=\"mt-1 text-xs text-slate-500\">{helper}</div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction BreakdownList({ title, rows, labelResolver }) {\r\n  const max = rows.reduce((acc, item) => Math.max(acc, Number(item.count || 0)), 1);\r\n\r\n  return (\r\n    <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\">\r\n      <div className=\"text-sm font-semibold text-[#2F1A55]\">{title}</div>\r\n      <div className=\"mt-4 space-y-3\">\r\n        {rows.map((row) => {\r\n          const count = Number(row.count || 0);\r\n          const label = labelResolver(row);\r\n          const pct = Math.max(4, Math.round((count / max) * 100));\r\n          return (\r\n            <div key={label} className=\"space-y-1\">\r\n              <div className=\"flex items-center justify-between text-xs text-slate-600\">\r\n                <span>{label}</span>\r\n                <span className=\"font-semibold text-[#2F1A55]\">{formatNumber(count)}</span>\r\n              </div>\r\n              <div className=\"h-2 rounded-full bg-[#F1ECFB]\">\r\n                <div\r\n                  className=\"h-2 rounded-full bg-[#5E30A5]/70\"\r\n                  style={{ width: `${pct}%` }}\r\n                />\r\n              </div>\r\n            </div>\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function PrelaunchAnalyticsPanel() {\r\n  const [activeTab, setActiveTab] = useState(\"overview\");\r\n  const {\r\n    filters,\r\n    setFilters,\r\n    loading,\r\n    refreshing,\r\n    error,\r\n    metrics,\r\n    summary,\r\n    lastUpdatedAt,\r\n    reload,\r\n  } = usePrelaunchMetrics();\r\n\r\n  const funnel = metrics?.funnel || {};\r\n  const eventBreakdown = metrics?.event_breakdown || {};\r\n  const waitlistBreakdown = metrics?.waitlist_breakdown || {};\r\n  const supportBreakdown = metrics?.support_breakdown || {};\r\n  const timeline = metrics?.timeline || [];\r\n  const topIpRisk = metrics?.top_ip_risk || [];\r\n\r\n  const channelLabel = useMemo(() => {\r\n    const found = CHANNEL_OPTIONS.find((item) => item.value === filters.appChannel);\r\n    return found?.label || \"Canal personalizado\";\r\n  }, [filters.appChannel]);\r\n\r\n  const handleReload = () => {\r\n    reload({ silent: true });\r\n  };\r\n\r\n  const hasData = !loading && !error;\r\n\r\n  const renderOverview = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"grid gap-4 md:grid-cols-2 xl:grid-cols-3\">\r\n        <StatCard\r\n          icon={Users}\r\n          title=\"Visitantes unicos\"\r\n          value={formatNumber(summary.unique_visitors)}\r\n          helper=\"Con actividad en el rango\"\r\n        />\r\n        <StatCard\r\n          icon={Users}\r\n          title=\"Visitantes nuevos\"\r\n          value={formatNumber(summary.new_visitors)}\r\n          helper=\"Primer contacto en el rango\"\r\n        />\r\n        <StatCard\r\n          icon={Users}\r\n          title=\"Visitantes recurrentes\"\r\n          value={formatNumber(summary.recurrent_visitors)}\r\n          helper=\"Ya habian entrado antes\"\r\n        />\r\n        <StatCard\r\n          icon={BarChart3}\r\n          title=\"Waitlist submits\"\r\n          value={formatNumber(summary.waitlist_submits)}\r\n          helper=\"Registros confirmados por endpoint\"\r\n        />\r\n        <StatCard\r\n          icon={BarChart3}\r\n          title=\"Conversion waitlist\"\r\n          value={formatPercent(summary.waitlist_conversion)}\r\n          helper=\"Waitlist / visitantes unicos\"\r\n        />\r\n        <StatCard\r\n          icon={Ticket}\r\n          title=\"Tickets anonimos\"\r\n          value={formatNumber(summary.support_tickets_created)}\r\n          helper=\"Creados desde prelaunch\"\r\n        />\r\n      </div>\r\n\r\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\">\r\n        <div className=\"text-sm font-semibold text-[#2F1A55]\">Funnel rapido</div>\r\n        <div className=\"mt-4 grid gap-3 sm:grid-cols-2 xl:grid-cols-4\">\r\n          {[\r\n            [\"Page Views\", funnel.page_view || 0],\r\n            [\"Abrio waitlist\", funnel.cta_waitlist_open || 0],\r\n            [\"Submit waitlist\", funnel.waitlist_submit || 0],\r\n            [\"Ticket soporte\", funnel.support_ticket_created || 0],\r\n          ].map(([label, value]) => (\r\n            <div\r\n              key={label}\r\n              className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-3\"\r\n            >\r\n              <div className=\"text-lg font-bold text-[#5E30A5]\">{formatNumber(value)}</div>\r\n              <div className=\"text-xs text-slate-500\">{label}</div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      <Table\r\n        columns={[\r\n          { key: \"day\", label: \"Dia\" },\r\n          { key: \"unique\", label: \"Visitantes\", align: \"right\" },\r\n          { key: \"page_views\", label: \"Page views\", align: \"right\" },\r\n          { key: \"waitlist\", label: \"Waitlist\", align: \"right\" },\r\n          { key: \"tickets\", label: \"Tickets\", align: \"right\" },\r\n        ]}\r\n      >\r\n        {timeline.length === 0 ? (\r\n          <tr>\r\n            <td colSpan={5} className=\"px-4 py-6 text-center text-xs text-slate-400\">\r\n              Sin datos de timeline para el rango seleccionado.\r\n            </td>\r\n          </tr>\r\n        ) : (\r\n          timeline.map((row) => (\r\n            <tr key={row.day} className=\"hover:bg-[#FAF8FF]\">\r\n              <td className=\"px-4 py-3 text-slate-700\">{row.day}</td>\r\n              <td className=\"px-4 py-3 text-right text-slate-600\">\r\n                {formatNumber(row.unique_visitors)}\r\n              </td>\r\n              <td className=\"px-4 py-3 text-right text-slate-600\">\r\n                {formatNumber(row.page_views)}\r\n              </td>\r\n              <td className=\"px-4 py-3 text-right text-slate-600\">\r\n                {formatNumber(row.waitlist_submits)}\r\n              </td>\r\n              <td className=\"px-4 py-3 text-right text-slate-600\">\r\n                {formatNumber(row.support_tickets_created)}\r\n              </td>\r\n            </tr>\r\n          ))\r\n        )}\r\n      </Table>\r\n    </div>\r\n  );\r\n\r\n  const renderFunnel = () => {\r\n    const rows = Object.entries(eventBreakdown).map(([eventType, count]) => ({\r\n      eventType,\r\n      count: Number(count || 0),\r\n    }));\r\n    const max = rows.reduce((acc, item) => Math.max(acc, item.count), 1);\r\n    return (\r\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\">\r\n        <div className=\"text-sm font-semibold text-[#2F1A55]\">Eventos prelaunch</div>\r\n        <div className=\"mt-4 space-y-3\">\r\n          {rows.map((row) => (\r\n            <div key={row.eventType} className=\"space-y-1\">\r\n              <div className=\"flex items-center justify-between text-xs text-slate-600\">\r\n                <span>{row.eventType}</span>\r\n                <span className=\"font-semibold text-[#2F1A55]\">{formatNumber(row.count)}</span>\r\n              </div>\r\n              <div className=\"h-2 rounded-full bg-[#F1ECFB]\">\r\n                <div\r\n                  className=\"h-2 rounded-full bg-[#5E30A5]/70\"\r\n                  style={{ width: `${Math.max(4, Math.round((row.count / max) * 100))}%` }}\r\n                />\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const renderWaitlist = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"grid gap-4 lg:grid-cols-2\">\r\n        <BreakdownList\r\n          title=\"Waitlist por rol\"\r\n          rows={waitlistBreakdown.by_role || []}\r\n          labelResolver={(row) => WAITLIST_ROLE_LABELS[row.role_intent] || row.role_intent}\r\n        />\r\n        <BreakdownList\r\n          title=\"Waitlist por estado\"\r\n          rows={waitlistBreakdown.by_status || []}\r\n          labelResolver={(row) => WAITLIST_STATUS_LABELS[row.status] || row.status}\r\n        />\r\n      </div>\r\n\r\n      <Table\r\n        columns={[\r\n          { key: \"source\", label: \"Origen / Campaign\" },\r\n          { key: \"count\", label: \"Registros\", align: \"right\" },\r\n        ]}\r\n      >\r\n        {(waitlistBreakdown.top_sources || []).length === 0 ? (\r\n          <tr>\r\n            <td colSpan={2} className=\"px-4 py-6 text-center text-xs text-slate-400\">\r\n              Sin fuentes registradas en el rango.\r\n            </td>\r\n          </tr>\r\n        ) : (\r\n          (waitlistBreakdown.top_sources || []).map((row) => (\r\n            <tr key={row.source} className=\"hover:bg-[#FAF8FF]\">\r\n              <td className=\"px-4 py-3 text-slate-700\">{row.source}</td>\r\n              <td className=\"px-4 py-3 text-right font-semibold text-[#2F1A55]\">\r\n                {formatNumber(row.count)}\r\n              </td>\r\n            </tr>\r\n          ))\r\n        )}\r\n      </Table>\r\n    </div>\r\n  );\r\n\r\n  const renderTickets = () => (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"grid gap-4 lg:grid-cols-2\">\r\n        <BreakdownList\r\n          title=\"Tickets por estado\"\r\n          rows={supportBreakdown.by_status || []}\r\n          labelResolver={(row) => SUPPORT_STATUS_LABELS[row.status] || row.status}\r\n        />\r\n        <BreakdownList\r\n          title=\"Tickets por severidad\"\r\n          rows={supportBreakdown.by_severity || []}\r\n          labelResolver={(row) => SUPPORT_SEVERITY_LABELS[row.severity] || row.severity}\r\n        />\r\n      </div>\r\n\r\n      <Table\r\n        columns={[\r\n          { key: \"category\", label: \"Categoria\" },\r\n          { key: \"count\", label: \"Tickets\", align: \"right\" },\r\n        ]}\r\n      >\r\n        {(supportBreakdown.by_category || []).filter((row) => Number(row.count || 0) > 0).length ===\r\n        0 ? (\r\n          <tr>\r\n            <td colSpan={2} className=\"px-4 py-6 text-center text-xs text-slate-400\">\r\n              Sin tickets anonimos para mostrar en este rango.\r\n            </td>\r\n          </tr>\r\n        ) : (\r\n          (supportBreakdown.by_category || [])\r\n            .filter((row) => Number(row.count || 0) > 0)\r\n            .sort((a, b) => Number(b.count || 0) - Number(a.count || 0))\r\n            .map((row) => (\r\n              <tr key={row.category} className=\"hover:bg-[#FAF8FF]\">\r\n                <td className=\"px-4 py-3 text-slate-700\">\r\n                  {SUPPORT_CATEGORY_LABELS[row.category] || row.category}\r\n                </td>\r\n                <td className=\"px-4 py-3 text-right font-semibold text-[#2F1A55]\">\r\n                  {formatNumber(row.count)}\r\n                </td>\r\n              </tr>\r\n            ))\r\n        )}\r\n      </Table>\r\n    </div>\r\n  );\r\n\r\n  const renderRisk = () => (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\">\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n          <ShieldAlert size={16} />\r\n          Top IP Risk IDs\r\n        </div>\r\n        <div className=\"mt-2 text-xs text-slate-500\">\r\n          Conteo de actividad por hash de riesgo (sin exponer IP real).\r\n        </div>\r\n      </div>\r\n\r\n      <Table\r\n        columns={[\r\n          { key: \"id\", label: \"Risk ID\" },\r\n          { key: \"count\", label: \"Eventos\", align: \"right\" },\r\n        ]}\r\n      >\r\n        {topIpRisk.length === 0 ? (\r\n          <tr>\r\n            <td colSpan={2} className=\"px-4 py-6 text-center text-xs text-slate-400\">\r\n              Sin actividad de riesgo en el rango.\r\n            </td>\r\n          </tr>\r\n        ) : (\r\n          topIpRisk.map((row) => (\r\n            <tr key={row.ip_risk_id} className=\"hover:bg-[#FAF8FF]\">\r\n              <td className=\"px-4 py-3 font-mono text-xs text-slate-700\">\r\n                {truncateRiskId(row.ip_risk_id)}\r\n              </td>\r\n              <td className=\"px-4 py-3 text-right font-semibold text-[#2F1A55]\">\r\n                {formatNumber(row.count)}\r\n              </td>\r\n            </tr>\r\n          ))\r\n        )}\r\n      </Table>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\">\r\n        <div className=\"flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between\">\r\n          <div className=\"grid gap-3 sm:grid-cols-2\">\r\n            <label className=\"space-y-1\">\r\n              <div className=\"text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400\">\r\n                Rango\r\n              </div>\r\n              <select\r\n                value={filters.days}\r\n                onChange={(event) =>\r\n                  setFilters((prev) => ({ ...prev, days: Number(event.target.value) }))\r\n                }\r\n                className=\"w-full rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-sm text-slate-700 outline-none focus:border-[#BFA8E6]\"\r\n              >\r\n                {RANGE_OPTIONS.map((option) => (\r\n                  <option key={option.value} value={option.value}>\r\n                    {option.label}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </label>\r\n\r\n            <label className=\"space-y-1\">\r\n              <div className=\"text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400\">\r\n                Canal\r\n              </div>\r\n              <select\r\n                value={filters.appChannel}\r\n                onChange={(event) =>\r\n                  setFilters((prev) => ({ ...prev, appChannel: event.target.value }))\r\n                }\r\n                className=\"w-full rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-sm text-slate-700 outline-none focus:border-[#BFA8E6]\"\r\n              >\r\n                {CHANNEL_OPTIONS.map((option) => (\r\n                  <option key={option.value} value={option.value}>\r\n                    {option.label}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </label>\r\n          </div>\r\n\r\n          <div className=\"flex flex-wrap items-center gap-3\">\r\n            <div className=\"rounded-xl border border-[#EEE7FA] bg-[#FAF8FF] px-3 py-2 text-xs text-slate-500\">\r\n              Canal activo: <span className=\"font-semibold text-[#2F1A55]\">{channelLabel}</span>\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleReload}\r\n              disabled={refreshing || loading}\r\n              className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-xs font-semibold text-[#2F1A55] disabled:opacity-60\"\r\n            >\r\n              <RefreshCw size={14} className={refreshing ? \"animate-spin\" : \"\"} />\r\n              {refreshing ? \"Actualizando...\" : \"Actualizar\"}\r\n            </button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-3 flex items-center gap-2 text-xs text-slate-500\">\r\n          <Clock3 size={13} />\r\n          Ultima actualizacion: {formatDateTime(lastUpdatedAt)}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex flex-wrap gap-2\">\r\n        {TABS.map((tab) => {\r\n          const active = activeTab === tab.id;\r\n          return (\r\n            <button\r\n              key={tab.id}\r\n              type=\"button\"\r\n              onClick={() => setActiveTab(tab.id)}\r\n              className={`rounded-xl px-4 py-2 text-xs font-semibold transition ${\r\n                active\r\n                  ? \"bg-[#5E30A5] text-white\"\r\n                  : \"border border-[#E9E2F7] bg-white text-slate-600 hover:bg-[#F8F4FF]\"\r\n              }`}\r\n            >\r\n              {tab.label}\r\n            </button>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      {error ? (\r\n        <div className=\"rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-600\">\r\n          {error}\r\n        </div>\r\n      ) : null}\r\n\r\n      {loading ? (\r\n        <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-6 text-sm text-slate-500\">\r\n          Cargando metricas de prelaunch...\r\n        </div>\r\n      ) : null}\r\n\r\n      {hasData && activeTab === \"overview\" ? renderOverview() : null}\r\n      {hasData && activeTab === \"funnel\" ? renderFunnel() : null}\r\n      {hasData && activeTab === \"waitlist\" ? renderWaitlist() : null}\r\n      {hasData && activeTab === \"tickets\" ? renderTickets() : null}\r\n      {hasData && activeTab === \"risk\" ? renderRisk() : null}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\prelaunch\\hooks\\usePrelaunchMetrics.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\prelaunch\\services\\prelaunchMetrics.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\promos\\PromosTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\qrs\\QRDetalle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\qrs\\QRsTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\reportes\\ReportesTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\services\\adminUser.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\sistema\\FeatureFlags.jsx","messages":[{"ruleId":"no-extra-boolean-cast","severity":2,"message":"Redundant Boolean call.","line":83,"column":24,"nodeType":"CallExpression","messageId":"unexpectedCall","endLine":83,"endColumn":43,"fix":{"range":[2619,2638],"text":"state[key]"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"// src/admin/sistema/FeatureFlags.jsx\nimport React, { useEffect, useState } from \"react\";\nimport { Shield, ToggleLeft } from \"lucide-react\";\nimport {\n  getSystemFeatureFlags,\n  setSystemFeatureFlag,\n  subscribeSystemFeatureFlags,\n} from \"@referidos/support-sdk/runtime/systemFeatureFlags\";\nimport {\n  fetchSupportRuntimeFlags,\n  getCachedSupportRuntimeFlags,\n  setSupportRuntimeFlag,\n  subscribeSupportRuntimeFlags,\n} from \"@referidos/support-sdk/runtime/supportRuntimeFlags\";\nimport { useAppStore } from \"../../store/appStore\";\n\r\nconst FLAGS = [\n  {\r\n    key: \"disable_qr\",\r\n    title: \"Deshabilitar generacion de QR\",\r\n    desc: \"Bloquea generacion de nuevos QR en toda la app.\",\r\n  },\r\n  {\r\n    key: \"maintenance\",\r\n    title: \"Modo mantenimiento\",\r\n    desc: \"Muestra aviso general y pausa flujos criticos.\",\r\n  },\r\n  {\n    key: \"freeze_registro\",\n    title: \"Bloquear registros\",\n    desc: \"Evita nuevas altas de usuarios y negocios.\",\n  },\n  {\n    key: \"support_live_updates\",\n    title: \"Soporte: actualizacion en vivo\",\n    desc: \"Activa suscripciones realtime para inbox/jornada. Recomendado solo con plan pago.\",\n  },\n];\n\nconst SUPPORT_AUTH_FLAGS = [\n  {\n    key: \"require_session_authorization\",\n    title: \"Soporte: requerir autorizacion de sesion\",\n    desc: \"Si esta activo, soporte debe ser aprobado por admin antes de abrir sesion.\",\n  },\n  {\n    key: \"require_jornada_authorization\",\n    title: \"Soporte: requerir autorizacion de jornada\",\n    desc: \"Si esta activo, soporte debe estar autorizado para trabajar antes de iniciar jornada.\",\n  },\n];\n\nexport default function FeatureFlags() {\n  const [state, setState] = useState(() => getSystemFeatureFlags());\n  const [supportAuthState, setSupportAuthState] = useState(() =>\n    getCachedSupportRuntimeFlags()\n  );\n  const [supportAuthLoading, setSupportAuthLoading] = useState(true);\n  const [supportAuthError, setSupportAuthError] = useState(\"\");\n  const [savingSupportFlag, setSavingSupportFlag] = useState({});\n  const usuario = useAppStore((s) => s.usuario);\n\n  useEffect(() => subscribeSystemFeatureFlags(setState), []);\n\n  useEffect(() => {\n    let active = true;\n    const loadSupportAuth = async () => {\n      setSupportAuthLoading(true);\n      const next = await fetchSupportRuntimeFlags({ force: true });\n      if (!active) return;\n      setSupportAuthState(next);\n      setSupportAuthLoading(false);\n    };\n    loadSupportAuth();\n    const unsubscribe = subscribeSupportRuntimeFlags(setSupportAuthState);\n    return () => {\n      active = false;\n      unsubscribe?.();\n    };\n  }, []);\n\n  const toggleFlag = (key) => {\n    const nextValue = !Boolean(state[key]);\n    const nextState = setSystemFeatureFlag(key, nextValue);\n    setState(nextState);\n  };\n\n  const toggleSupportAuthFlag = async (key) => {\n    const currentValue = Boolean(supportAuthState[key]);\n    const nextValue = !currentValue;\n    setSupportAuthError(\"\");\n    setSavingSupportFlag((prev) => ({ ...prev, [key]: true }));\n    const result = await setSupportRuntimeFlag(key, nextValue, {\n      updatedBy: usuario?.id || null,\n    });\n    setSavingSupportFlag((prev) => ({ ...prev, [key]: false }));\n    if (!result.ok) {\n      setSupportAuthError(result.error || \"No se pudo actualizar la autorizacion.\");\n      return;\n    }\n    setSupportAuthState(result.flags);\n  };\n\r\n  return (\r\n    <div className=\"space-y-5\">\r\n      <div>\r\n        <div className=\"text-lg font-semibold text-[#2F1A55]\">\r\n          Feature flags\r\n        </div>\r\n        <div className=\"text-xs text-slate-500\">\r\n          Controla funciones globales sin tocar codigo.\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"grid gap-3\">\n        {FLAGS.map((flag) => {\n          const enabled = state[flag.key];\r\n          return (\r\n            <div\r\n              key={flag.key}\r\n              className=\"flex items-center justify-between rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n            >\r\n              <div className=\"flex items-start gap-3\">\r\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-[#F7F4FF] text-[#5E30A5]\">\r\n                  <Shield size={18} />\r\n                </div>\r\n                <div>\r\n                  <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                    {flag.title}\r\n                  </div>\r\n                  <div className=\"text-xs text-slate-500\">{flag.desc}</div>\r\n                </div>\r\n              </div>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => toggleFlag(flag.key)}\r\n                className={`relative h-6 w-11 rounded-full transition ${\r\n                  enabled ? \"bg-[#5E30A5]\" : \"bg-slate-200\"\r\n                }`}\r\n                aria-pressed={enabled}\r\n              >\r\n                <span\r\n                  className={`absolute top-0.5 h-5 w-5 rounded-full bg-white shadow-sm transition ${\r\n                    enabled ? \"translate-x-5\" : \"translate-x-0.5\"\r\n                  }`}\r\n                />\r\n              </button>\r\n            </div>\r\n          );\r\n        })}\n      </div>\n\n      <div>\n        <div className=\"text-sm font-semibold text-[#2F1A55]\">\n          Autorizaciones soporte\n        </div>\n        <div className=\"text-xs text-slate-500\">\n          Controla si soporte requiere aprobacion para sesion y/o jornada.\n        </div>\n      </div>\n\n      {supportAuthError ? (\n        <div className=\"rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-600\">\n          {supportAuthError}\n        </div>\n      ) : null}\n\n      <div className=\"grid gap-3\">\n        {SUPPORT_AUTH_FLAGS.map((flag) => {\n          const enabled = Boolean(supportAuthState[flag.key]);\n          const saving = Boolean(savingSupportFlag[flag.key]);\n          return (\n            <div\n              key={flag.key}\n              className=\"flex items-center justify-between rounded-2xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\n            >\n              <div className=\"flex items-start gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-[#F7F4FF] text-[#5E30A5]\">\n                  <Shield size={18} />\n                </div>\n                <div>\n                  <div className=\"text-sm font-semibold text-[#2F1A55]\">\n                    {flag.title}\n                  </div>\n                  <div className=\"text-xs text-slate-500\">{flag.desc}</div>\n                </div>\n              </div>\n\n              <button\n                type=\"button\"\n                onClick={() => void toggleSupportAuthFlag(flag.key)}\n                disabled={supportAuthLoading || saving}\n                className={`relative h-6 w-11 rounded-full transition disabled:cursor-not-allowed disabled:opacity-60 ${\n                  enabled ? \"bg-[#5E30A5]\" : \"bg-slate-200\"\n                }`}\n                aria-pressed={enabled}\n              >\n                <span\n                  className={`absolute top-0.5 h-5 w-5 rounded-full bg-white shadow-sm transition ${\n                    enabled ? \"translate-x-5\" : \"translate-x-0.5\"\n                  }`}\n                />\n              </button>\n            </div>\n          );\n        })}\n      </div>\n\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#F9F7FF] p-4 text-xs text-slate-500\">\n        <div className=\"flex items-center gap-2 font-semibold text-[#2F1A55]\">\n          <ToggleLeft size={14} />\n          Cambios pendientes\n        </div>\n        <p className=\"mt-2\">\n          Las flags quedan guardadas localmente. Para soporte en vivo, por ahora\n          mantenla apagada y usa refresco manual.\n        </p>\n        <p className=\"mt-2\">\n          Las autorizaciones de soporte se guardan en la base de datos runtime.\n        </p>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\sistema\\RegistroCodes.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\support\\AdminSupportAgents.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'recentTicketsMap' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":23,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":26,"suggestions":[{"messageId":"removeVar","data":{"varName":"recentTicketsMap"},"fix":{"range":[1007,1023],"text":""},"desc":"Remove unused variable 'recentTicketsMap'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'nameDrafts' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":24,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"nameDrafts"},"fix":{"range":[1072,1082],"text":""},"desc":"Remove unused variable 'nameDrafts'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadAgents'. Either include it or remove the dependency array.","line":484,"column":6,"nodeType":"ArrayExpression","endLine":484,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadAgents]","fix":{"range":[16965,16967],"text":"[loadAgents]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'updateUsuario' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":541,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":541,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"updateUsuario"},"fix":{"range":[18647,19144],"text":""},"desc":"Remove unused variable 'updateUsuario'."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { Check, ChevronDown, ChevronUp, Pencil, RefreshCw, Users, X } from \"lucide-react\";\r\nimport AdminLayout from \"../layout/AdminLayout\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport {\r\n  assignSupportThread,\r\n  closeSupportThread,\r\n  createSupportAdminUser,\r\n  denyAdminSupportSession,\r\n  endAdminSupportSession,\r\n  startAdminSupportSession,\r\n} from \"@referidos/support-sdk/supportClient\";\r\n\r\nexport default function AdminSupportAgents() {\r\n  const [agents, setAgents] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [phoneDrafts, setPhoneDrafts] = useState({});\r\n  const [authorizedUntilDrafts, setAuthorizedUntilDrafts] = useState({});\r\n  const [authorizedFromDrafts, setAuthorizedFromDrafts] = useState({});\r\n  const [usersMap, setUsersMap] = useState({});\r\n  const [sessionsMap, setSessionsMap] = useState({});\r\n  const [activeTicketsMap, setActiveTicketsMap] = useState({});\r\n  const [recentTicketsMap, setRecentTicketsMap] = useState({});\r\n  const [nameDrafts, setNameDrafts] = useState({});\r\n  const [expandedMap, setExpandedMap] = useState({});\r\n  const [agentErrors, setAgentErrors] = useState({});\r\n  const [availableThreads, setAvailableThreads] = useState([]);\r\n  const [assignErrors, setAssignErrors] = useState({});\r\n  const [phoneEditingMap, setPhoneEditingMap] = useState({});\r\n  const [timeFromEditingMap, setTimeFromEditingMap] = useState({});\r\n  const [timeUntilEditingMap, setTimeUntilEditingMap] = useState({});\r\n  const [refreshingMap, setRefreshingMap] = useState({});\r\n  const [globalRefreshing, setGlobalRefreshing] = useState(false);\r\n  const [actionLoadingMap, setActionLoadingMap] = useState({});\r\n  const [createForm, setCreateForm] = useState({\r\n    nombre: \"\",\r\n    apellido: \"\",\r\n    email: \"\",\r\n    fecha_nacimiento: \"\",\r\n    role: \"soporte\",\r\n  });\r\n  const [createLoading, setCreateLoading] = useState(false);\r\n  const [createError, setCreateError] = useState(\"\");\r\n  const [createResult, setCreateResult] = useState(null);\r\n  const [createOpen, setCreateOpen] = useState(false);\r\n  const mountedRef = useRef(true);\r\n  const authorizedAgentsCount = useMemo(\r\n    () => agents.filter((agent) => agent.authorized_for_work && !agent.blocked).length,\r\n    [agents]\r\n  );\r\n\r\n  const formatTime = (value) => {\r\n    if (!value) return \"\";\r\n    const date = new Date(value);\r\n    if (Number.isNaN(date.getTime())) return \"\";\r\n    return date.toLocaleTimeString(\"es-EC\", {\r\n      hour: \"2-digit\",\r\n      minute: \"2-digit\",\r\n      hour12: false,\r\n      timeZone: \"America/Guayaquil\",\r\n    });\r\n  };\r\n\r\n  const formatDate = (value) => {\r\n    if (!value) return \"\";\r\n    const date = new Date(value);\r\n    if (Number.isNaN(date.getTime())) return \"\";\r\n    return date.toLocaleDateString(\"es-EC\", {\r\n      day: \"2-digit\",\r\n      month: \"2-digit\",\r\n      timeZone: \"America/Guayaquil\",\r\n    });\r\n  };\r\n\r\n  const formatSupportPhone = (rawValue) => {\r\n    if (!rawValue) return \"Sin numero\";\r\n    const digits = rawValue.replace(/\\D/g, \"\");\r\n    let local = digits;\r\n    if (local.startsWith(\"593\")) {\r\n      local = local.slice(3);\r\n    }\r\n    if (local.length > 9) {\r\n      local = local.slice(-9);\r\n    }\r\n    if (local.length === 9) {\r\n      return `0${local}`;\r\n    }\r\n    return rawValue;\r\n  };\r\n\r\n  const normalizeSupportPhoneInput = (value) => {\r\n    if (!value) return \"\";\r\n    const digits = value.replace(/\\D/g, \"\");\r\n    if (digits.startsWith(\"593\")) {\r\n      const local = digits.slice(3);\r\n      return local.length === 9 ? `0${local}` : local;\r\n    }\r\n    if (digits.length === 10 && digits.startsWith(\"0\")) {\r\n      return digits;\r\n    }\r\n    return digits;\r\n  };\r\n\r\n  const formatSupportPhoneForSave = (value) => {\r\n    if (!value) return null;\r\n    const digits = value.replace(/\\D/g, \"\");\r\n    if (digits.startsWith(\"593\")) {\r\n      return `+${digits}`;\r\n    }\r\n    if (digits.length === 10 && digits.startsWith(\"0\")) {\r\n      return `+593${digits.slice(1)}`;\r\n    }\r\n    if (digits.length === 9) {\r\n      return `+593${digits}`;\r\n    }\r\n    return `+${digits}`;\r\n  };\r\n\r\n  const buildHourOptions = () => {\r\n    const options = [];\r\n    for (let hour = 0; hour < 24; hour += 1) {\r\n      options.push(hour.toString().padStart(2, \"0\"));\r\n    }\r\n    return options;\r\n  };\r\n\r\n  const hourOptions = useMemo(() => buildHourOptions(), []);\r\n\r\n  const pad2 = (value) => value.toString().padStart(2, \"0\");\r\n\r\n  const parseTimeToMinutes = (value) => {\r\n    if (!value) return null;\r\n    const [h, m] = value.split(\":\").map((item) => parseInt(item, 10));\r\n    if (Number.isNaN(h) || Number.isNaN(m)) return null;\r\n    return h * 60 + m;\r\n  };\r\n\r\n  const clampToShift = (fromTime, untilTime) => {\r\n    const fromMinutes = parseTimeToMinutes(fromTime);\r\n    const untilMinutes = parseTimeToMinutes(untilTime);\r\n    if (fromMinutes === null || untilMinutes === null) return untilTime;\r\n    let diff = (untilMinutes - fromMinutes + 1440) % 1440;\r\n    if (diff === 0) diff = 1440;\r\n    if (diff <= 480) return untilTime;\r\n    const maxMinutes = (fromMinutes + 480) % 1440;\r\n    return `${pad2(Math.floor(maxMinutes / 60))}:${pad2(maxMinutes % 60)}`;\r\n  };\r\n\r\n  const getAllowedUntilMinutes = (fromTime) => {\r\n    const fromMinutes = parseTimeToMinutes(fromTime);\r\n    if (fromMinutes === null) return null;\r\n    return (fromMinutes + 480) % 1440;\r\n  };\r\n\r\n  const isAfterLimit = (fromTime, untilTime) => {\r\n    const fromMinutes = parseTimeToMinutes(fromTime);\r\n    const untilMinutes = parseTimeToMinutes(untilTime);\r\n    if (fromMinutes === null || untilMinutes === null) return false;\r\n    let diff = (untilMinutes - fromMinutes + 1440) % 1440;\r\n    if (diff === 0) diff = 1440;\r\n    return diff > 480;\r\n  };\r\n\r\n  const getShiftDuration = (agent) => {\r\n    if (!agent.authorized_from || !agent.authorized_until) return \"\";\r\n    const start = new Date(agent.authorized_from);\r\n    const end = new Date(agent.authorized_until);\r\n    if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return \"\";\r\n    const diffMs = end.getTime() - start.getTime();\r\n    if (diffMs <= 0) return \"\";\r\n    const minutes = Math.round(diffMs / 60000);\r\n    const hours = Math.floor(minutes / 60);\r\n    const mins = minutes % 60;\r\n    if (hours <= 0) return \"\";\r\n    return mins ? `${hours}h ${pad2(mins)}m` : `${hours} horas`;\r\n  };\r\n\r\n  const getAgentFromTime = (agent) =>\r\n    agent.authorized_from ? formatTime(agent.authorized_from) : \"08:00\";\r\n  const getAgentUntilTime = (agent) =>\r\n    agent.authorized_until ? formatTime(agent.authorized_until) : \"18:00\";\r\n  const getAgentDateRange = (agent) => {\r\n    if (!agent.authorized_from || !agent.authorized_until) return \"\";\r\n    const startDate = formatDate(agent.authorized_from);\r\n    const endDate = formatDate(agent.authorized_until);\r\n    if (!startDate || !endDate || startDate === endDate) return \"\";\r\n    return `${startDate} - ${endDate}`;\r\n  };\r\n\r\n  const hasAgentChanges = (agent) => {\r\n    const phoneDraft = phoneDrafts[agent.user_id] ?? \"\";\r\n    const currentPhone = agent.support_phone || \"\";\r\n    const nextPhone = phoneDraft ? formatSupportPhoneForSave(phoneDraft) : null;\r\n    const phoneChanged = (nextPhone || \"\") !== currentPhone;\r\n    const fromChanged =\r\n      (authorizedFromDrafts[agent.user_id] ?? \"08:00\") !== getAgentFromTime(agent);\r\n    const untilChanged =\r\n      (authorizedUntilDrafts[agent.user_id] ?? \"18:00\") !==\r\n      getAgentUntilTime(agent);\r\n    return phoneChanged || fromChanged || untilChanged;\r\n  };\r\n\r\n  const timeValueToIso = (timeValue, dayOffset = 0) => {\r\n    if (!timeValue) return null;\r\n    const [hours, minutes] = timeValue.split(\":\").map((value) => parseInt(value, 10));\r\n    if (Number.isNaN(hours) || Number.isNaN(minutes)) return null;\r\n    const offsetMs = 5 * 60 * 60 * 1000;\r\n    const ecuNow = new Date(Date.now() - offsetMs);\r\n    const utcTime = Date.UTC(\r\n      ecuNow.getUTCFullYear(),\r\n      ecuNow.getUTCMonth(),\r\n      ecuNow.getUTCDate() + dayOffset,\r\n      hours + 5,\r\n      minutes,\r\n      0,\r\n      0\r\n    );\r\n    return new Date(utcTime).toISOString();\r\n  };\r\n\r\n  const buildEcuadorDate = (hour, minute = 0, dayOffset = 0) => {\r\n    const offsetMs = 5 * 60 * 60 * 1000;\r\n    const ecuNow = new Date(Date.now() - offsetMs);\r\n    const utcTime = Date.UTC(\r\n      ecuNow.getUTCFullYear(),\r\n      ecuNow.getUTCMonth(),\r\n      ecuNow.getUTCDate() + dayOffset,\r\n      hour + 5,\r\n      minute,\r\n      0,\r\n      0\r\n    );\r\n    return new Date(utcTime);\r\n  };\r\n\r\n  const computeGlow = (agent) => {\r\n    if (agent.blocked) return \"shadow-[0_0_0_1px_rgba(239,68,68,0.4)]\";\r\n    if (!agent.authorized_for_work) {\r\n      return \"shadow-[0_0_0_1px_rgba(148,163,184,0.4)]\";\r\n    }\r\n    if (sessionsMap[agent.user_id]) {\r\n      return \"shadow-[0_0_0_1px_rgba(34,197,94,0.4)]\";\r\n    }\r\n    const startAt = agent.authorized_from\r\n      ? new Date(agent.authorized_from)\r\n      : buildEcuadorDate(8, 0);\r\n    const endAt = agent.authorized_until\r\n      ? new Date(agent.authorized_until)\r\n      : buildEcuadorDate(18, 0);\r\n    if (Number.isNaN(startAt.getTime()) || Number.isNaN(endAt.getTime())) {\r\n      return \"shadow-[0_0_0_1px_rgba(148,163,184,0.4)]\";\r\n    }\r\n    const now = Date.now();\r\n    if (now < startAt.getTime()) {\r\n      return \"shadow-[0_0_0_1px_rgba(34,197,94,0.4)]\";\r\n    }\r\n    if (now <= endAt.getTime()) {\r\n      return \"shadow-[0_0_0_1px_rgba(249,115,22,0.45)]\";\r\n    }\r\n    return \"shadow-[0_0_0_1px_rgba(148,163,184,0.4)]\";\r\n  };\r\n\r\n  const loadAgents = async () => {\r\n    setLoading(true);\r\n    const { data } = await supabase\r\n      .from(\"support_agent_profiles\")\r\n      .select(\r\n        \"user_id, support_phone, authorized_for_work, blocked, authorized_until, authorized_from, session_request_status, session_request_at\"\r\n      )\r\n      .order(\"authorized_for_work\", { ascending: false });\r\n    if (!mountedRef.current) return;\r\n    setAgents(data || []);\r\n    const nextDrafts = {};\r\n    const nextUntilDrafts = {};\r\n    const nextFromDrafts = {};\r\n    (data || []).forEach((agent) => {\r\n      nextDrafts[agent.user_id] = normalizeSupportPhoneInput(agent.support_phone || \"\");\r\n      const fromValue = agent.authorized_from\r\n        ? formatTime(agent.authorized_from)\r\n        : \"08:00\";\r\n      const untilValue = agent.authorized_until\r\n        ? formatTime(agent.authorized_until)\r\n        : \"18:00\";\r\n      nextFromDrafts[agent.user_id] = fromValue;\r\n      nextUntilDrafts[agent.user_id] = clampToShift(fromValue, untilValue);\r\n    });\r\n    setPhoneDrafts(nextDrafts);\r\n    setAuthorizedUntilDrafts(nextUntilDrafts);\r\n    setAuthorizedFromDrafts(nextFromDrafts);\r\n    const nextPhoneEdit = {};\r\n    const nextTimeFromEdit = {};\r\n    const nextTimeUntilEdit = {};\r\n    (data || []).forEach((agent) => {\r\n      nextPhoneEdit[agent.user_id] = !agent.support_phone;\r\n      nextTimeFromEdit[agent.user_id] = false;\r\n      nextTimeUntilEdit[agent.user_id] = false;\r\n    });\r\n    setPhoneEditingMap(nextPhoneEdit);\r\n    setTimeFromEditingMap(nextTimeFromEdit);\r\n    setTimeUntilEditingMap(nextTimeUntilEdit);\r\n\r\n    if (data && data.length > 0) {\r\n      const agentIds = data.map((agent) => agent.user_id);\r\n      const { data: users } = await supabase\r\n        .from(\"usuarios\")\r\n        .select(\"id, nombre, apellido, public_id\")\r\n        .in(\"id\", agentIds);\r\n      const nextUsers = {};\r\n      const nextNames = {};\r\n      (users || []).forEach((u) => {\r\n        nextUsers[u.id] = u;\r\n        nextNames[u.id] = {\r\n          nombre: u.nombre || \"\",\r\n          apellido: u.apellido || \"\",\r\n        };\r\n      });\r\n      setUsersMap(nextUsers);\r\n      setNameDrafts(nextNames);\r\n    } else {\r\n      setUsersMap({});\r\n      setNameDrafts({});\r\n    }\r\n\r\n    const { data: sessions } = await supabase\r\n      .from(\"support_agent_sessions\")\r\n      .select(\"agent_id, start_at, last_seen_at\")\r\n      .is(\"end_at\", null);\r\n    const sessionLookup = {};\r\n    (sessions || []).forEach((session) => {\r\n      sessionLookup[session.agent_id] = session;\r\n    });\r\n    setSessionsMap(sessionLookup);\r\n\r\n    const { data: activeThreads } = await supabase\r\n      .from(\"support_threads\")\r\n      .select(\"assigned_agent_id, public_id, status\")\r\n      .in(\"status\", [\"assigned\", \"in_progress\", \"waiting_user\"]);\r\n    const ticketLookup = {};\r\n    (activeThreads || []).forEach((thread) => {\r\n      ticketLookup[thread.assigned_agent_id] = thread;\r\n    });\r\n    setActiveTicketsMap(ticketLookup);\r\n\r\n    if (data && data.length > 0) {\r\n      const agentIds = data.map((agent) => agent.user_id);\r\n      const { data: recentThreads } = await supabase\r\n        .from(\"support_threads\")\r\n        .select(\"assigned_agent_id, public_id, closed_at\")\r\n        .eq(\"status\", \"closed\")\r\n        .in(\"assigned_agent_id\", agentIds)\r\n        .order(\"closed_at\", { ascending: false })\r\n        .limit(200);\r\n      const recentLookup = {};\r\n      (recentThreads || []).forEach((thread) => {\r\n        if (!thread.assigned_agent_id) return;\r\n        const list = recentLookup[thread.assigned_agent_id] || [];\r\n        if (list.length < 3) {\r\n          list.push(thread);\r\n          recentLookup[thread.assigned_agent_id] = list;\r\n        }\r\n      });\r\n      setRecentTicketsMap(recentLookup);\r\n    } else {\r\n      setRecentTicketsMap({});\r\n    }\r\n\r\n    const { data: threads } = await supabase\r\n      .from(\"support_threads\")\r\n      .select(\"id, public_id, status, category, created_at\")\r\n      .in(\"status\", [\"new\", \"queued\"])\r\n      .order(\"created_at\", { ascending: true })\r\n      .limit(12);\r\n    setAvailableThreads(threads || []);\r\n    setLoading(false);\r\n  };\r\n\r\n  const refreshAgentRow = async (userId) => {\r\n    setRefreshingMap((prev) => ({ ...prev, [userId]: true }));\r\n    const { data: agent } = await supabase\r\n      .from(\"support_agent_profiles\")\r\n      .select(\r\n        \"user_id, support_phone, authorized_for_work, blocked, authorized_until, authorized_from, session_request_status, session_request_at\"\r\n      )\r\n      .eq(\"user_id\", userId)\r\n      .maybeSingle();\r\n    if (!agent) return;\r\n    setAgents((prev) =>\r\n      prev.map((item) => (item.user_id === userId ? agent : item))\r\n    );\r\n    setPhoneDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: normalizeSupportPhoneInput(agent.support_phone || \"\"),\r\n    }));\r\n    const fromValue = agent.authorized_from\r\n      ? formatTime(agent.authorized_from)\r\n      : \"08:00\";\r\n    const untilValue = agent.authorized_until\r\n      ? formatTime(agent.authorized_until)\r\n      : \"18:00\";\r\n    setAuthorizedUntilDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: clampToShift(fromValue, untilValue),\r\n    }));\r\n    setAuthorizedFromDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: fromValue,\r\n    }));\r\n    setAuthorizedFromDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: agent.authorized_from ? formatTime(agent.authorized_from) : \"08:00\",\r\n    }));\r\n\r\n    const { data: userRow } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"id, nombre, apellido, public_id\")\r\n      .eq(\"id\", userId)\r\n      .maybeSingle();\r\n    if (userRow) {\r\n      setUsersMap((prev) => ({ ...prev, [userId]: userRow }));\r\n    }\r\n\r\n    const { data: session } = await supabase\r\n      .from(\"support_agent_sessions\")\r\n      .select(\"agent_id, start_at, last_seen_at\")\r\n      .eq(\"agent_id\", userId)\r\n      .is(\"end_at\", null)\r\n      .maybeSingle();\r\n    setSessionsMap((prev) => ({\r\n      ...prev,\r\n      [userId]: session || null,\r\n    }));\r\n\r\n    const { data: activeThread } = await supabase\r\n      .from(\"support_threads\")\r\n      .select(\"assigned_agent_id, public_id, status\")\r\n      .eq(\"assigned_agent_id\", userId)\r\n      .in(\"status\", [\"assigned\", \"in_progress\", \"waiting_user\"])\r\n      .maybeSingle();\r\n    setActiveTicketsMap((prev) => ({\r\n      ...prev,\r\n      [userId]: activeThread || null,\r\n    }));\r\n    setRefreshingMap((prev) => ({ ...prev, [userId]: false }));\r\n  };\r\n\r\n  const refreshAllAgents = async () => {\r\n    if (globalRefreshing) return;\r\n    setGlobalRefreshing(true);\r\n    try {\r\n      await loadAgents();\r\n    } finally {\r\n      if (mountedRef.current) {\r\n        setGlobalRefreshing(false);\r\n      }\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    mountedRef.current = true;\r\n    loadAgents();\r\n    // Realtime subscription (disabled until prod)\r\n    // const channel = supabase\r\n    //   .channel(\"support_admin_agents\")\r\n    //   .on(\r\n    //     \"postgres_changes\",\r\n    //     { event: \"*\", schema: \"public\", table: \"support_agent_sessions\" },\r\n    //     loadAgents\r\n    //   )\r\n    //   .on(\r\n    //     \"postgres_changes\",\r\n    //     { event: \"*\", schema: \"public\", table: \"support_agent_profiles\" },\r\n    //     loadAgents\r\n    //   )\r\n    //   .on(\r\n    //     \"postgres_changes\",\r\n    //     { event: \"*\", schema: \"public\", table: \"support_threads\" },\r\n    //     loadAgents\r\n    //   )\r\n    //   .subscribe();\r\n    return () => {\r\n      mountedRef.current = false;\r\n      // if (channel) supabase.removeChannel(channel);\r\n    };\r\n  }, []);\r\n\r\n  const updateAgent = async (userId, patch) => {\r\n    const { data, error } = await supabase\r\n      .from(\"support_agent_profiles\")\r\n      .update(patch)\r\n      .eq(\"user_id\", userId)\r\n      .select(\r\n        \"user_id, support_phone, authorized_for_work, blocked, authorized_until, authorized_from\"\r\n      )\r\n      .single();\r\n    if (error || !data) {\r\n      setAgentErrors((prev) => ({\r\n        ...prev,\r\n        [userId]: error?.message || \"No se pudo guardar los cambios.\",\r\n      }));\r\n      return false;\r\n    }\r\n    setAgentErrors((prev) => ({\r\n      ...prev,\r\n      [userId]: \"\",\r\n    }));\r\n    setAgents((prev) =>\r\n      prev.map((agent) => (agent.user_id === userId ? data : agent))\r\n    );\r\n    setPhoneDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: normalizeSupportPhoneInput(data.support_phone || \"\"),\r\n    }));\r\n    const dataFromValue = data.authorized_from\r\n      ? formatTime(data.authorized_from)\r\n      : \"08:00\";\r\n    const dataUntilValue = data.authorized_until\r\n      ? formatTime(data.authorized_until)\r\n      : \"18:00\";\r\n    setAuthorizedUntilDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: clampToShift(dataFromValue, dataUntilValue),\r\n    }));\r\n    setAuthorizedFromDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: dataFromValue,\r\n    }));\r\n    setAuthorizedFromDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: data.authorized_from ? formatTime(data.authorized_from) : \"08:00\",\r\n    }));\r\n    return true;\r\n  };\r\n\r\n  const isPhoneValid = (rawValue) => {\r\n    const digits = String(rawValue || \"\").replace(/\\D/g, \"\");\r\n    return (\r\n      (digits.length === 10 && digits.startsWith(\"0\")) || digits.length === 9\r\n    );\r\n  };\r\n\r\n  const updateUsuario = async (userId, patch) => {\r\n    const { data } = await supabase\r\n      .from(\"usuarios\")\r\n      .update(patch)\r\n      .eq(\"id\", userId)\r\n      .select(\"id, nombre, apellido, public_id\")\r\n      .single();\r\n    if (!data) return;\r\n    setUsersMap((prev) => ({\r\n      ...prev,\r\n      [userId]: data,\r\n    }));\r\n    setNameDrafts((prev) => ({\r\n      ...prev,\r\n      [userId]: {\r\n        nombre: data.nombre || \"\",\r\n        apellido: data.apellido || \"\",\r\n      },\r\n    }));\r\n  };\r\n\r\n  const handleCreateChange = (field) => (event) => {\r\n    setCreateForm((prev) => ({\r\n      ...prev,\r\n      [field]: event.target.value,\r\n    }));\r\n  };\r\n\r\n  const handleCreate = async () => {\r\n    setCreateError(\"\");\r\n    setCreateResult(null);\r\n    const payload = {\r\n      nombre: createForm.nombre.trim(),\r\n      apellido: createForm.apellido.trim(),\r\n      email: createForm.email.trim(),\r\n      fecha_nacimiento: createForm.fecha_nacimiento || null,\r\n      role: createForm.role,\r\n    };\r\n    if (!payload.nombre || !payload.apellido || !payload.email) {\r\n      setCreateError(\"Completa todos los datos.\");\r\n      return;\r\n    }\r\n    setCreateLoading(true);\r\n    const result = await createSupportAdminUser(payload);\r\n    setCreateLoading(false);\r\n    if (!result.ok) {\r\n      setCreateError(\"No se pudo crear la cuenta.\");\r\n      return;\r\n    }\r\n    setCreateResult(result.data);\r\n    setCreateForm({\r\n      nombre: \"\",\r\n      apellido: \"\",\r\n      email: \"\",\r\n      fecha_nacimiento: \"\",\r\n      role: \"soporte\",\r\n    });\r\n    await loadAgents();\r\n  };\r\n\r\n  return (\r\n    <AdminLayout\r\n      title=\"Asesores\"\r\n      subtitle=\"Gestiona disponibilidad y autorizaciones\"\r\n    >\r\n      <div className=\"space-y-6\">\r\n        <div className=\"rounded-3xl border border-[#E9E2F7] bg-white p-6 space-y-4\">\r\n          <div className=\"flex items-center justify-between gap-3\">\r\n            <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n              Crear cuenta de soporte\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setCreateOpen((prev) => !prev)}\r\n              className=\"rounded-2xl border border-[#E9E2F7] px-4 py-2 text-xs font-semibold text-[#5E30A5]\"\r\n            >\r\n              Crear cuenta\r\n            </button>\r\n          </div>\r\n          {createOpen ? (\r\n            <>\r\n              <div className=\"grid gap-3 sm:grid-cols-2\">\r\n                <input\r\n                  value={createForm.nombre}\r\n                  onChange={handleCreateChange(\"nombre\")}\r\n                  placeholder=\"Nombre\"\r\n                  className=\"rounded-2xl border border-[#E9E2F7] px-4 py-3 text-sm text-slate-700 outline-none focus:border-[#5E30A5]\"\r\n                />\r\n                <input\r\n                  value={createForm.apellido}\r\n                  onChange={handleCreateChange(\"apellido\")}\r\n                  placeholder=\"Apellido\"\r\n                  className=\"rounded-2xl border border-[#E9E2F7] px-4 py-3 text-sm text-slate-700 outline-none focus:border-[#5E30A5]\"\r\n                />\r\n                <input\r\n                  value={createForm.email}\r\n                  onChange={handleCreateChange(\"email\")}\r\n                  placeholder=\"Correo\"\r\n                  className=\"rounded-2xl border border-[#E9E2F7] px-4 py-3 text-sm text-slate-700 outline-none focus:border-[#5E30A5]\"\r\n                />\r\n                <input\r\n                  type=\"date\"\r\n                  value={createForm.fecha_nacimiento}\r\n                  onChange={handleCreateChange(\"fecha_nacimiento\")}\r\n                  className=\"rounded-2xl border border-[#E9E2F7] px-4 py-3 text-sm text-slate-700 outline-none focus:border-[#5E30A5]\"\r\n                />\r\n                <select\r\n                  value={createForm.role}\r\n                  onChange={handleCreateChange(\"role\")}\r\n                  className=\"rounded-2xl border border-[#E9E2F7] px-4 py-3 text-sm text-slate-700 outline-none focus:border-[#5E30A5]\"\r\n                >\r\n                  <option value=\"soporte\">Soporte</option>\r\n                  <option value=\"dev\">Dev</option>\r\n                  <option value=\"empleado\">Empleado</option>\r\n                </select>\r\n              </div>\r\n              {createError ? (\r\n                <div className=\"text-xs text-red-500\">{createError}</div>\r\n              ) : null}\r\n              {createResult ? (\r\n                <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] px-4 py-3 text-xs text-slate-600 space-y-1\">\r\n                  <div>Correo: {createResult.email}</div>\r\n                  <div>Contrasena provisional: {createResult.password}</div>\r\n                </div>\r\n              ) : null}\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleCreate}\r\n                disabled={createLoading}\r\n                className={`rounded-2xl px-4 py-2 text-sm font-semibold text-white ${\r\n                  createLoading ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"\r\n                }`}\r\n              >\r\n                {createLoading ? \"Creando...\" : \"Crear cuenta\"}\r\n              </button>\r\n            </>\r\n          ) : null}\r\n        </div>\r\n\r\n        <div className=\"rounded-3xl border border-[#E9E2F7] bg-white p-5\">\r\n          <div className=\"grid gap-3 md:grid-cols-3\">\r\n            <div className=\"rounded-2xl border border-[#E9E2F7] bg-white px-4 py-3\">\r\n              <div className=\"flex items-center justify-between text-xs uppercase tracking-[0.12em] text-slate-400\">\r\n                <span>Agentes autorizados</span>\r\n                <Users size={14} className=\"text-[#5E30A5]\" />\r\n              </div>\r\n              <div className=\"mt-2 text-xl font-extrabold text-[#2F1A55]\">{authorizedAgentsCount}</div>\r\n              <div className=\"mt-1 text-xs text-slate-500\">Asesores habilitados para atencion.</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-3xl border border-[#E9E2F7] bg-white p-6 space-y-4\">\r\n          <div className=\"flex items-center justify-between gap-3\">\r\n            <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n              Estado de asesores\r\n            </div>\r\n            <button\r\n              type=\"button\"\r\n              onClick={refreshAllAgents}\r\n              disabled={loading || globalRefreshing}\r\n              className=\"rounded-full border border-[#E9E2F7] p-2 text-slate-500 disabled:cursor-not-allowed disabled:opacity-60\"\r\n              title=\"Refrescar todos los asesores\"\r\n              aria-label=\"Refrescar todos los asesores\"\r\n            >\r\n              <RefreshCw\r\n                size={14}\r\n                className={loading || globalRefreshing ? \"animate-spin\" : \"\"}\r\n              />\r\n            </button>\r\n          </div>\r\n          {loading ? (\r\n            <div className=\"text-sm text-slate-500\">Cargando asesores...</div>\r\n          ) : agents.length === 0 ? (\r\n            <div className=\"text-sm text-slate-500\">Sin asesores registrados.</div>\r\n          ) : (\r\n            <div className=\"space-y-3\">\r\n              {agents.map((agent) => (\r\n                <div\r\n                  key={agent.user_id}\r\n                  className={`rounded-2xl border border-[#E9E2F7] bg-white px-4 py-3 text-sm text-slate-600 ${computeGlow(\r\n                    agent\r\n                  )}`}\r\n                >\r\n                  <div className=\"flex items-center justify-between gap-3\">\r\n                    <div className=\"flex flex-wrap items-center gap-3 text-xs text-slate-500\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => refreshAgentRow(agent.user_id)}\r\n                      className=\"rounded-full border border-[#E9E2F7] p-2 text-slate-500\"\r\n                    >\r\n                      <RefreshCw\r\n                        size={14}\r\n                        className={\r\n                          refreshingMap[agent.user_id] ? \"animate-spin\" : \"\"\r\n                        }\r\n                      />\r\n                    </button>\r\n                    <div className=\"font-semibold text-[#5E30A5]\">\r\n                      {usersMap[agent.user_id]?.nombre || usersMap[agent.user_id]?.apellido\r\n                        ? `${usersMap[agent.user_id]?.nombre || \"\"} ${usersMap[agent.user_id]?.apellido || \"\"}`.trim()\r\n                        : usersMap[agent.user_id]?.public_id || \"Sin nombre\"}\r\n                    </div>\r\n                      {!expandedMap[agent.user_id] ? (\r\n                        <>\r\n                          <div\r\n                            className={\r\n                              agent.support_phone ? \"text-slate-500\" : \"text-slate-900\"\r\n                            }\r\n                          >\r\n                            {formatSupportPhone(agent.support_phone)}\r\n                          </div>\r\n                          <div\r\n                            className={\r\n                              sessionsMap[agent.user_id]\r\n                                ? \"text-slate-500\"\r\n                                : \"text-slate-900\"\r\n                            }\r\n                          >\r\n                            {sessionsMap[agent.user_id]\r\n                              ? \"Sesion activa\"\r\n                              : \"Sesion inactiva\"}\r\n                          </div>\r\n                          <div className=\"text-slate-500\">\r\n                            {agent.authorized_from\r\n                              ? formatTime(agent.authorized_from)\r\n                              : \"08:00\"}\r\n                            {\" - \"}\r\n                            {agent.authorized_until\r\n                              ? formatTime(agent.authorized_until)\r\n                              : \"18:00\"}\r\n                            {getShiftDuration(agent)\r\n                              ? ` (turno de ${getShiftDuration(agent)})`\r\n                              : \"\"}\r\n                            {getAgentDateRange(agent)\r\n                              ? ` (${getAgentDateRange(agent)})`\r\n                              : \"\"}\r\n                          </div>\r\n                          {!agent.authorized_for_work &&\r\n                          !agent.blocked &&\r\n                          agent.support_phone &&\r\n                          agent.authorized_from &&\r\n                          agent.authorized_until ? (\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={async () => {\r\n                                  setActionLoadingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: true,\r\n                                  }));\r\n                                  const ok = await updateAgent(agent.user_id, {\r\n                                    authorized_for_work: true,\r\n                                    blocked: false,\r\n                                  });\r\n                                  setActionLoadingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: false,\r\n                                  }));\r\n                                  if (ok) {\r\n                                    setExpandedMap((prev) => ({\r\n                                      ...prev,\r\n                                      [agent.user_id]: false,\r\n                                    }));\r\n                                  }\r\n                                }}\r\n                                disabled={actionLoadingMap[agent.user_id]}\r\n                                className={`rounded-full px-3 py-1 text-[11px] font-semibold text-white ${\r\n                                  actionLoadingMap[agent.user_id]\r\n                                    ? \"bg-[#C9B6E8] cursor-not-allowed\"\r\n                                    : \"bg-[#5E30A5]\"\r\n                                }`}\r\n                              >\r\n                                Autorizar\r\n                              </button>\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={async () => {\r\n                                  setActionLoadingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: true,\r\n                                  }));\r\n                                  await updateAgent(agent.user_id, {\r\n                                    authorized_for_work: false,\r\n                                    blocked: true,\r\n                                  });\r\n                                  setActionLoadingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: false,\r\n                                  }));\r\n                                }}\r\n                                disabled={actionLoadingMap[agent.user_id]}\r\n                                className={`rounded-full border px-3 py-1 text-[11px] font-semibold ${\r\n                                  actionLoadingMap[agent.user_id]\r\n                                    ? \"border-red-200 text-red-300 cursor-not-allowed\"\r\n                                    : \"border-red-200 text-red-500\"\r\n                                }`}\r\n                              >\r\n                                Bloquear\r\n                              </button>\r\n                            </div>\r\n                          ) : null}\r\n                        </>\r\n                      ) : null}\r\n                    </div>\r\n                    {agent.session_request_status === \"pending\" ? (\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={async () => {\r\n                            await startAdminSupportSession({\r\n                              agent_id: agent.user_id,\r\n                            });\r\n                            await refreshAgentRow(agent.user_id);\r\n                          }}\r\n                          className=\"flex h-7 w-7 items-center justify-center rounded-full bg-emerald-500 text-white\"\r\n                        >\r\n                          <Check size={12} />\r\n                        </button>\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={async () => {\r\n                            await denyAdminSupportSession({\r\n                              agent_id: agent.user_id,\r\n                            });\r\n                            await refreshAgentRow(agent.user_id);\r\n                          }}\r\n                          className=\"flex h-7 w-7 items-center justify-center rounded-full bg-rose-500 text-white\"\r\n                        >\r\n                          <X size={12} />\r\n                        </button>\r\n                      </div>\r\n                    ) : null}\r\n                    <div className=\"flex items-center gap-2\">\r\n                      {sessionsMap[agent.user_id] ? (\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={async () => {\r\n                            await endAdminSupportSession({\r\n                              agent_id: agent.user_id,\r\n                              reason: \"admin_revoke\",\r\n                            });\r\n                            await refreshAgentRow(agent.user_id);\r\n                          }}\r\n                          className=\"rounded-full border border-[#E9E2F7] px-3 py-1 text-[11px] font-semibold text-slate-600\"\r\n                        >\r\n                          Cerrar jornada\r\n                        </button>\r\n                      ) : null}\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() =>\r\n                          setExpandedMap((prev) => ({\r\n                            ...prev,\r\n                            [agent.user_id]: !prev[agent.user_id],\r\n                          }))\r\n                        }\r\n                        className=\"rounded-full border border-[#E9E2F7] p-2 text-slate-500\"\r\n                      >\r\n                        {expandedMap[agent.user_id] ? (\r\n                          <ChevronUp size={16} />\r\n                        ) : (\r\n                          <ChevronDown size={16} />\r\n                        )}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {activeTicketsMap[agent.user_id] ? (\r\n                    <div className=\"mt-2 text-xs text-slate-500\">\r\n                      Ticket asignado: {activeTicketsMap[agent.user_id].public_id}\r\n                    </div>\r\n                  ) : null}\r\n\r\n                      {expandedMap[agent.user_id] ? (\r\n                    <div className=\"mt-4 grid gap-4 text-xs text-slate-500 md:grid-cols-[1fr_1fr]\">\r\n                      <div className=\"space-y-3\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                          <span className=\"min-w-[70px] text-slate-400\">Tel</span>\r\n                          {phoneEditingMap[agent.user_id] ? (\r\n                            <>\r\n                              <input\r\n                                value={phoneDrafts[agent.user_id] ?? \"\"}\r\n                                onChange={(e) =>\r\n                                  setPhoneDrafts((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: normalizeSupportPhoneInput(\r\n                                      e.target.value\r\n                                    ),\r\n                                  }))\r\n                                }\r\n                                placeholder=\"Sin numero\"\r\n                                className=\"w-1/4 rounded-full border border-[#E9E2F7] bg-white px-3 py-1 text-xs text-slate-600 outline-none focus:border-[#5E30A5]\"\r\n                              />\r\n                              {agent.support_phone ? (\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={async () => {\r\n                                    setPhoneDrafts((prev) => ({\r\n                                      ...prev,\r\n                                      [agent.user_id]: normalizeSupportPhoneInput(\r\n                                        agent.support_phone || \"\"\r\n                                      ),\r\n                                    }));\r\n                                    setPhoneEditingMap((prev) => ({\r\n                                      ...prev,\r\n                                      [agent.user_id]: false,\r\n                                    }));\r\n                                  }}\r\n                                  className=\"rounded-full border border-[#E9E2F7] px-2 py-1 text-[10px] font-semibold text-slate-500\"\r\n                                >\r\n                                  <X size={12} />\r\n                                </button>\r\n                              ) : null}\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                            <span className=\"text-slate-600\">\r\n                              {formatSupportPhone(agent.support_phone)}\r\n                            </span>\r\n                            <button\r\n                                type=\"button\"\r\n                                onClick={() =>\r\n                                  setPhoneEditingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: true,\r\n                                  }))\r\n                                }\r\n                                className=\"ml-1 rounded-full border border-[#E9E2F7] px-2 py-1 text-[10px] font-semibold text-slate-500\"\r\n                              >\r\n                                <Pencil size={12} />\r\n                              </button>\r\n                            </>\r\n                          )}\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-[max-content_max-content_max-content] items-center gap-x-2 gap-y-3\">\r\n                          <div className=\"flex w-fit items-center gap-1\">\r\n                            <span className=\"min-w-[70px] text-slate-400\">Desde</span>\r\n                            {timeFromEditingMap[agent.user_id] ? (\r\n                              <div className=\"flex w-fit items-center gap-2\">\r\n                                <select\r\n                                  value={\r\n                                    (authorizedFromDrafts[agent.user_id] ?? \"08:00\").split(\":\")[0]\r\n                                  }\r\n                                  onChange={(e) => {\r\n                                    const nextHour = e.target.value;\r\n                                    const current = authorizedFromDrafts[agent.user_id] ?? \"08:00\";\r\n                                    const nextValue = `${nextHour}:${current.split(\":\")[1] ?? \"00\"}`;\r\n                                    setAuthorizedFromDrafts((prev) => ({\r\n                                      ...prev,\r\n                                      [agent.user_id]: nextValue,\r\n                                    }));\r\n                                    const untilValue =\r\n                                      authorizedUntilDrafts[agent.user_id] ?? \"18:00\";\r\n                                    if (isAfterLimit(nextValue, untilValue)) {\r\n                                      setAuthorizedUntilDrafts((prev) => ({\r\n                                        ...prev,\r\n                                        [agent.user_id]: getAllowedUntilMinutes(nextValue) !== null\r\n                                          ? `${pad2(Math.floor(getAllowedUntilMinutes(nextValue) / 60))}:${pad2(getAllowedUntilMinutes(nextValue) % 60)}`\r\n                                          : untilValue,\r\n                                      }));\r\n                                    }\r\n                                  }}\r\n                                  className=\"w-16 rounded-full border border-[#E9E2F7] bg-white px-2 py-1 text-xs text-slate-600 outline-none focus:border-[#5E30A5]\"\r\n                                >\r\n                                  {hourOptions.map((option) => (\r\n                                    <option key={option} value={option}>\r\n                                      {option}\r\n                                    </option>\r\n                                  ))}\r\n                                </select>\r\n                                <span className=\"text-xs text-slate-400\">:</span>\r\n                                <select\r\n                                  value={\r\n                                    (authorizedFromDrafts[agent.user_id] ?? \"08:00\").split(\":\")[1] ??\r\n                                    \"00\"\r\n                                  }\r\n                                  onChange={(e) => {\r\n                                    const current = authorizedFromDrafts[agent.user_id] ?? \"08:00\";\r\n                                    const nextValue = `${current.split(\":\")[0]}:${e.target.value}`;\r\n                                    setAuthorizedFromDrafts((prev) => ({\r\n                                      ...prev,\r\n                                      [agent.user_id]: nextValue,\r\n                                    }));\r\n                                    const untilValue =\r\n                                      authorizedUntilDrafts[agent.user_id] ?? \"18:00\";\r\n                                    if (isAfterLimit(nextValue, untilValue)) {\r\n                                      setAuthorizedUntilDrafts((prev) => ({\r\n                                        ...prev,\r\n                                        [agent.user_id]: getAllowedUntilMinutes(nextValue) !== null\r\n                                          ? `${pad2(Math.floor(getAllowedUntilMinutes(nextValue) / 60))}:${pad2(getAllowedUntilMinutes(nextValue) % 60)}`\r\n                                          : untilValue,\r\n                                      }));\r\n                                    }\r\n                                  }}\r\n                                  className=\"w-16 rounded-full border border-[#E9E2F7] bg-white px-2 py-1 text-xs text-slate-600 outline-none focus:border-[#5E30A5]\"\r\n                                >\r\n                                  {Array.from({ length: 60 }).map((_, idx) => (\r\n                                    <option key={idx} value={pad2(idx)}>\r\n                                      {pad2(idx)}\r\n                                    </option>\r\n                                  ))}\r\n                                </select>\r\n                              </div>\r\n                            ) : (\r\n                              <span className=\"w-fit text-slate-600\">\r\n                                {getAgentFromTime(agent)}\r\n                                {getAgentDateRange(agent)\r\n                                  ? ` (${formatDate(agent.authorized_from)})`\r\n                                  : \"\"}\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n\r\n                          {!timeUntilEditingMap[agent.user_id] ? (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => {\r\n                                setTimeFromEditingMap((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: true,\r\n                                }));\r\n                                setTimeUntilEditingMap((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: true,\r\n                                }));\r\n                              }}\r\n                              className=\"col-start-3 row-span-2 self-center rounded-full border border-[#E9E2F7] px-2 py-1 text-[10px] font-semibold text-slate-500\"\r\n                            >\r\n                              <Pencil size={12} />\r\n                            </button>\r\n                          ) : (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => {\r\n                                setAuthorizedFromDrafts((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: getAgentFromTime(agent),\r\n                                }));\r\n                                setAuthorizedUntilDrafts((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: getAgentUntilTime(agent),\r\n                                }));\r\n                                setTimeFromEditingMap((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: false,\r\n                                }));\r\n                                setTimeUntilEditingMap((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: false,\r\n                                }));\r\n                              }}\r\n                              className=\"col-start-3 row-span-2 self-center rounded-full border border-[#E9E2F7] px-2 py-1 text-[10px] font-semibold text-slate-500\"\r\n                            >\r\n                              <X size={12} />\r\n                            </button>\r\n                          )}\r\n\r\n                          <div className=\"flex w-fit items-center gap-1\">\r\n                            <span className=\"min-w-[70px] text-slate-400\">Hasta</span>\r\n                            {timeUntilEditingMap[agent.user_id] ? (\r\n                              <div className=\"flex w-fit items-center gap-2\">\r\n                                <select\r\n                                  value={\r\n                                    (authorizedUntilDrafts[agent.user_id] ?? \"18:00\").split(\":\")[0]\r\n                                  }\r\n                                  onChange={(e) => {\r\n                                    const nextHour = e.target.value;\r\n                                    const current =\r\n                                      authorizedUntilDrafts[agent.user_id] ?? \"18:00\";\r\n                                    setAuthorizedUntilDrafts((prev) => ({\r\n                                      ...prev,\r\n                                      [agent.user_id]: `${nextHour}:${current.split(\":\")[1] ?? \"00\"}`,\r\n                                    }));\r\n                                  }}\r\n                                  className=\"w-16 rounded-full border border-[#E9E2F7] bg-white px-2 py-1 text-xs text-slate-600 outline-none focus:border-[#5E30A5]\"\r\n                                >\r\n                                  {hourOptions.map((option) => {\r\n                                    const fromValue =\r\n                                      authorizedFromDrafts[agent.user_id] ?? \"08:00\";\r\n                                    const optionValue = `${option}:00`;\r\n                                    const disabled = isAfterLimit(fromValue, optionValue);\r\n                                    return (\r\n                                      <option\r\n                                        key={option}\r\n                                        value={option}\r\n                                        disabled={disabled}\r\n                                        style={disabled ? { color: \"#CBD5E1\" } : undefined}\r\n                                      >\r\n                                        {option}\r\n                                      </option>\r\n                                    );\r\n                                  })}\r\n                                </select>\r\n                                <span className=\"text-xs text-slate-400\">:</span>\r\n                                <select\r\n                                  value={\r\n                                    (authorizedUntilDrafts[agent.user_id] ?? \"18:00\").split(\":\")[1] ??\r\n                                    \"00\"\r\n                                  }\r\n                                  onChange={(e) => {\r\n                                    const current =\r\n                                      authorizedUntilDrafts[agent.user_id] ?? \"18:00\";\r\n                                    setAuthorizedUntilDrafts((prev) => ({\r\n                                      ...prev,\r\n                                      [agent.user_id]: `${current.split(\":\")[0]}:${e.target.value}`,\r\n                                    }));\r\n                                  }}\r\n                                  className=\"w-16 rounded-full border border-[#E9E2F7] bg-white px-2 py-1 text-xs text-slate-600 outline-none focus:border-[#5E30A5]\"\r\n                                >\r\n                                  {Array.from({ length: 60 }).map((_, idx) => {\r\n                                    const minuteValue = pad2(idx);\r\n                                    const fromValue =\r\n                                      authorizedFromDrafts[agent.user_id] ?? \"08:00\";\r\n                                    const hourValue =\r\n                                      (authorizedUntilDrafts[agent.user_id] ?? \"18:00\").split(\":\")[0];\r\n                                    const optionValue = `${hourValue}:${minuteValue}`;\r\n                                    const disabled = isAfterLimit(fromValue, optionValue);\r\n                                    return (\r\n                                      <option\r\n                                        key={minuteValue}\r\n                                        value={minuteValue}\r\n                                        disabled={disabled}\r\n                                        style={disabled ? { color: \"#CBD5E1\" } : undefined}\r\n                                      >\r\n                                        {minuteValue}\r\n                                      </option>\r\n                                    );\r\n                                  })}\r\n                                </select>\r\n                              </div>\r\n                            ) : (\r\n                              <span className=\"w-fit text-slate-600\">\r\n                                {getAgentUntilTime(agent)}\r\n                                {getAgentDateRange(agent)\r\n                                  ? ` (${formatDate(agent.authorized_until)})`\r\n                                  : \"\"}\r\n                              </span>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                        <div className=\"mt-2 flex flex-wrap items-center gap-2\">\r\n                          {hasAgentChanges(agent) ? (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={async () => {\r\n                                const ok = await updateAgent(agent.user_id, {\r\n                                  support_phone: isPhoneValid(\r\n                                    phoneDrafts[agent.user_id]\r\n                                  )\r\n                                    ? formatSupportPhoneForSave(\r\n                                        phoneDrafts[agent.user_id]\r\n                                      )\r\n                                    : agent.support_phone,\r\n                                  authorized_from: timeValueToIso(\r\n                                    authorizedFromDrafts[agent.user_id] || \"08:00\"\r\n                                  ),\r\n                                  authorized_until: timeValueToIso(\r\n                                    authorizedUntilDrafts[agent.user_id],\r\n                                    isAfterLimit(\r\n                                      authorizedFromDrafts[agent.user_id] || \"08:00\",\r\n                                      authorizedUntilDrafts[agent.user_id] || \"18:00\"\r\n                                    )\r\n                                      ? 1\r\n                                      : authorizedUntilDrafts[agent.user_id] <\r\n                                          (authorizedFromDrafts[agent.user_id] || \"08:00\")\r\n                                        ? 1\r\n                                        : 0\r\n                                  ),\r\n                                });\r\n                                if (ok) {\r\n                                  setPhoneEditingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: false,\r\n                                  }));\r\n                                  setTimeFromEditingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: false,\r\n                                  }));\r\n                                  setTimeUntilEditingMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: false,\r\n                                  }));\r\n                                }\r\n                              }}\r\n                              className=\"rounded-full bg-[#5E30A5] px-3 py-1 text-xs font-semibold text-white\"\r\n                            >\r\n                              Guardar\r\n                            </button>\r\n                          ) : null}\r\n                          {!agent.authorized_for_work ? (\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={async () => {\r\n                                setActionLoadingMap((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: true,\r\n                                }));\r\n                                const ok = await updateAgent(agent.user_id, {\r\n                                  authorized_for_work: true,\r\n                                  blocked: false,\r\n                                  authorized_from: timeValueToIso(\r\n                                    authorizedFromDrafts[agent.user_id] || \"08:00\"\r\n                                  ),\r\n                                  authorized_until: timeValueToIso(\r\n                                    authorizedUntilDrafts[agent.user_id],\r\n                                    isAfterLimit(\r\n                                      authorizedFromDrafts[agent.user_id] || \"08:00\",\r\n                                      authorizedUntilDrafts[agent.user_id] || \"18:00\"\r\n                                    )\r\n                                      ? 1\r\n                                      : authorizedUntilDrafts[agent.user_id] <\r\n                                          (authorizedFromDrafts[agent.user_id] || \"08:00\")\r\n                                        ? 1\r\n                                        : 0\r\n                                  ),\r\n                                });\r\n                                setActionLoadingMap((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: false,\r\n                                }));\r\n                                if (ok) {\r\n                                  setExpandedMap((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]: false,\r\n                                  }));\r\n                                }\r\n                              }}\r\n                              disabled={actionLoadingMap[agent.user_id]}\r\n                              className={`rounded-full px-3 py-1 text-xs font-semibold text-white ${\r\n                                actionLoadingMap[agent.user_id]\r\n                                  ? \"bg-[#C9B6E8] cursor-not-allowed\"\r\n                                  : \"bg-[#5E30A5]\"\r\n                              }`}\r\n                            >\r\n                              Autorizar\r\n                            </button>\r\n                          ) : null}\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={async () => {\r\n                              setActionLoadingMap((prev) => ({\r\n                                ...prev,\r\n                                [agent.user_id]: true,\r\n                              }));\r\n                              await updateAgent(agent.user_id, {\r\n                                authorized_for_work: false,\r\n                                blocked: true,\r\n                              });\r\n                              setActionLoadingMap((prev) => ({\r\n                                ...prev,\r\n                                [agent.user_id]: false,\r\n                              }));\r\n                            }}\r\n                            disabled={actionLoadingMap[agent.user_id]}\r\n                            className={`rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                              actionLoadingMap[agent.user_id]\r\n                                ? \"border-red-200 text-red-300 cursor-not-allowed\"\r\n                                : \"border-red-200 text-red-500\"\r\n                            }`}\r\n                          >\r\n                            Bloquear\r\n                          </button>\r\n                        </div>\r\n                        {agentErrors[agent.user_id] ? (\r\n                          <div className=\"text-xs text-red-500\">\r\n                            {agentErrors[agent.user_id]}\r\n                          </div>\r\n                        ) : null}\r\n                      </div>\r\n\r\n                      <div className=\"space-y-2 text-xs text-slate-500\">\r\n                        <div className=\"text-[11px] uppercase tracking-wide text-slate-400\">\r\n                          Tickets\r\n                        </div>\r\n                        {activeTicketsMap[agent.user_id] ? (\r\n                          <div className=\"rounded-xl border border-[#E9E2F7] bg-[#FAF8FF] px-3 py-2\">\r\n                            <div className=\"font-semibold text-slate-600\">\r\n                              {activeTicketsMap[agent.user_id].public_id}\r\n                            </div>\r\n                            <div className=\"text-[11px] text-slate-400\">\r\n                              {activeTicketsMap[agent.user_id].status}\r\n                            </div>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={async () => {\r\n                                const result = await closeSupportThread({\r\n                                  thread_public_id:\r\n                                    activeTicketsMap[agent.user_id].public_id,\r\n                                  resolution: \"Cierre forzado por admin\",\r\n                                  root_cause: \"cierre_forzado\",\r\n                                });\r\n                                if (!result.ok) {\r\n                                  setAssignErrors((prev) => ({\r\n                                    ...prev,\r\n                                    [agent.user_id]:\r\n                                      result.error || \"No se pudo cerrar.\",\r\n                                  }));\r\n                                  return;\r\n                                }\r\n                                setAssignErrors((prev) => ({\r\n                                  ...prev,\r\n                                  [agent.user_id]: \"\",\r\n                                }));\r\n                                await loadAgents();\r\n                              }}\r\n                              className=\"mt-2 rounded-full border border-[#E9E2F7] px-3 py-1 text-[11px] font-semibold text-slate-600\"\r\n                            >\r\n                              Forzar cierre\r\n                            </button>\r\n                          </div>\r\n                        ) : (\r\n                          <>\r\n                            {availableThreads.length === 0 ? (\r\n                              <div className=\"text-xs text-slate-400\">\r\n                                Sin tickets disponibles\r\n                              </div>\r\n                            ) : (\r\n                              <div className=\"space-y-2\">\r\n                                {availableThreads.slice(0, 4).map((thread) => (\r\n                                  <div\r\n                                    key={thread.id}\r\n                                    className=\"flex items-center justify-between gap-2 rounded-xl border border-[#E9E2F7] px-3 py-2\"\r\n                                  >\r\n                                    <div>\r\n                                      <div className=\"font-semibold text-slate-600\">\r\n                                        {thread.public_id}\r\n                                      </div>\r\n                                      <div className=\"text-[11px] text-slate-400\">\r\n                                        {thread.status}\r\n                                      </div>\r\n                                    </div>\r\n                                    <button\r\n                                      type=\"button\"\r\n                                      onClick={async () => {\r\n                                        const result = await assignSupportThread({\r\n                                          thread_public_id: thread.public_id,\r\n                                          agent_id: agent.user_id,\r\n                                        });\r\n                                        if (!result.ok) {\r\n                                          setAssignErrors((prev) => ({\r\n                                            ...prev,\r\n                                            [agent.user_id]:\r\n                                              result.error || \"No se pudo asignar.\",\r\n                                          }));\r\n                                          return;\r\n                                        }\r\n                                        setAssignErrors((prev) => ({\r\n                                          ...prev,\r\n                                          [agent.user_id]: \"\",\r\n                                        }));\r\n                                        await loadAgents();\r\n                                      }}\r\n                                      className=\"rounded-full border border-[#E9E2F7] px-3 py-1 text-[11px] font-semibold text-slate-600\"\r\n                                    >\r\n                                      Asignar\r\n                                    </button>\r\n                                  </div>\r\n                                ))}\r\n                              </div>\r\n                            )}\r\n                            {assignErrors[agent.user_id] ? (\r\n                              <div className=\"text-xs text-red-500\">\r\n                                {assignErrors[agent.user_id]}\r\n                              </div>\r\n                            ) : null}\r\n                          </>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  ) : null}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\support\\AdminSupportCatalogPanel.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'formatTargets' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":115,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":115,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"formatTargets"},"fix":{"range":[4023,4226],"text":""},"desc":"Remove unused variable 'formatTargets'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'submitCreateCategory' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":681,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":681,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"submitCreateCategory"},"fix":{"range":[24445,25235],"text":""},"desc":"Remove unused variable 'submitCreateCategory'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'renderAdd' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1620,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":1620,"endColumn":18,"suggestions":[{"messageId":"removeVar","data":{"varName":"renderAdd"},"fix":{"range":[63478,65617],"text":""},"desc":"Remove unused variable 'renderAdd'."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { ArrowDown, ArrowLeft, ArrowUp, ChevronDown, ChevronUp, Plus, RefreshCw, Save, Search, Trash2 } from \"lucide-react\";\r\nimport { Link, useNavigate, useParams } from \"react-router-dom\";\r\nimport AdminLayout from \"../layout/AdminLayout\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport {\r\n  createSupportMacro,\r\n  createSupportMacroCategory,\r\n  deleteSupportMacroCategory,\r\n  deleteSupportMacro,\r\n  dispatchSupportMacrosSync,\r\n  listSupportMacroCatalog,\r\n  setSupportMacroCategoryStatus,\r\n  setSupportMacroStatus,\r\n  updateSupportMacroCategory,\r\n  updateSupportMacro,\r\n} from \"./services/supportMacrosOpsService\";\r\n\r\nconst GROUP_OPTIONS = [\r\n  { id: \"categoria\", label: \"categoria\" },\r\n  { id: \"estado\", label: \"estado\" },\r\n  { id: \"rol\", label: \"rol\" },\r\n];\r\n\r\nconst APP_OPTIONS = [\r\n  { id: \"all\", label: \"Todas apps\" },\r\n  { id: \"referidos_app\", label: \"PWA\" },\r\n  { id: \"prelaunch_web\", label: \"Prelaunch web\" },\r\n  { id: \"android_app\", label: \"Android app\" },\r\n];\r\n\r\nconst ENV_OPTIONS = [\r\n  { id: \"all\", label: \"Todos\" },\r\n  { id: \"dev\", label: \"Dev\" },\r\n  { id: \"staging\", label: \"Staging\" },\r\n  { id: \"prod\", label: \"Prod\" },\r\n];\r\n\r\nconst ROLE_OPTIONS = [\n  { id: \"cliente\", label: \"cliente\" },\n  { id: \"negocio\", label: \"negocio\" },\n  { id: \"anonimo\", label: \"anonimo\" },\n];\n\r\nconst THREAD_STATUS_ORDER = [\"new\", \"assigned\", \"in_progress\", \"waiting_user\", \"queued\", \"closed\", \"cancelled\", \"sin_estado\"];\r\nconst THREAD_STATUS_LABEL = {\r\n  new: \"Nuevo\",\r\n  assigned: \"Asignado\",\r\n  in_progress: \"En progreso\",\r\n  waiting_user: \"Esperando usuario\",\r\n  queued: \"En cola\",\r\n  closed: \"Cerrado\",\r\n  cancelled: \"Cancelado\",\r\n  sin_estado: \"Sin estado\",\r\n};\r\n\r\nconst LIFECYCLE_OPTIONS = [\"draft\", \"published\", \"archived\"];\r\nconst USAGE_WINDOWS = [\"1d\", \"7d\", \"15d\", \"30d\"];\r\nconst EMPTY_USAGE = {\r\n  shown_1d: 0,\r\n  shown_7d: 0,\r\n  shown_15d: 0,\r\n  shown_30d: 0,\r\n  copied_1d: 0,\r\n  copied_7d: 0,\r\n  copied_15d: 0,\r\n  copied_30d: 0,\r\n};\r\nconst EMPTY_MACRO_FORM = {\r\n  title: \"\",\r\n  body: \"\",\r\n  category_id: \"\",\r\n  thread_status: \"new\",\r\n  audience_roles: [\"cliente\", \"negocio\"],\r\n  app_targets: [\"all\"],\r\n  env_targets: [\"all\"],\r\n};\r\n\r\nconst s = (v, d = \"\") => (typeof v === \"string\" && v.trim() ? v.trim() : d);\r\nconst arr = (v, d = []) => (Array.isArray(v) ? Array.from(new Set(v.map((x) => s(x).toLowerCase()).filter(Boolean))) : d);\r\nconst code = (v) => s(v).toLowerCase().replace(/\\s+/g, \"_\");\r\nconst normCategoryCode = (value) => code(value).replace(/[^a-z0-9_]/g, \"\") || \"general\";\r\nconst short = (v, n = 180) => (s(v).length > n ? `${s(v).slice(0, n)}...` : s(v, \"-\"));\r\nconst matchApp = (targets, appFilter) => appFilter === \"all\" || arr(targets, [\"all\"]).includes(\"all\") || arr(targets, [\"all\"]).includes(appFilter);\r\nconst normalizeAudienceRoles = (values) => {\n  const allowed = new Set([\"cliente\", \"negocio\", \"anonimo\"]);\n  const aliases = {\n    anonymous: \"anonimo\",\n  };\n  const normalized = arr(values, [])\n    .map((role) => aliases[role] || role)\n    .filter((role) => allowed.has(role));\n  return normalized.length ? normalized : [\"cliente\", \"negocio\"];\n};\nconst rank = (status) => {\r\n  const idx = THREAD_STATUS_ORDER.indexOf(status);\r\n  return idx === -1 ? THREAD_STATUS_ORDER.length + 1 : idx;\r\n};\r\nconst sortByPriority = (a, b) => {\r\n  const aSort = Number(a.sort_order || 100);\r\n  const bSort = Number(b.sort_order || 100);\r\n  if (aSort !== bSort) return aSort - bSort;\r\n  return s(a.title).localeCompare(s(b.title), \"es\", { sensitivity: \"base\" });\r\n};\r\nconst badge = (status) => {\r\n  if (status === \"published\") return \"border-emerald-200 bg-emerald-50 text-emerald-700\";\r\n  if (status === \"archived\") return \"border-slate-300 bg-slate-100 text-slate-700\";\r\n  return \"border-amber-200 bg-amber-50 text-amber-700\";\r\n};\r\nconst categoryBadge = (status) => (\r\n  status === \"active\"\r\n    ? \"border-emerald-200 bg-emerald-50 text-emerald-700\"\r\n    : \"border-slate-300 bg-slate-100 text-slate-700\"\r\n);\r\nconst formatTargets = (targets, options) => {\r\n  const map = options.reduce((acc, opt) => ((acc[opt.id] = opt.label), acc), {});\r\n  return arr(targets, [\"all\"]).map((id) => map[id] || id).join(\", \");\r\n};\r\nconst escapeRegExp = (value) => value.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\r\nconst resolveAppTagLabels = (targets) => {\r\n  const normalized = arr(targets, [\"all\"]);\r\n  if (normalized.includes(\"all\")) {\r\n    return APP_OPTIONS.filter((opt) => opt.id !== \"all\").map((opt) => opt.label);\r\n  }\r\n  return normalized.map((id) => APP_OPTIONS.find((opt) => opt.id === id)?.label || id);\r\n};\r\nconst resolveEnvTagLabels = (targets) => {\r\n  const normalized = arr(targets, [\"all\"]);\r\n  if (normalized.includes(\"all\")) return [\"dev\", \"staging\", \"production\"];\r\n  const labels = [];\r\n  if (normalized.includes(\"dev\")) labels.push(\"dev\");\r\n  if (normalized.includes(\"staging\")) labels.push(\"staging\");\r\n  if (normalized.includes(\"prod\")) labels.push(\"production\");\r\n  return labels;\r\n};\r\nconst toggleMulti = (values, item) => {\r\n  const list = arr(values, []);\r\n  if (item === \"all\") return list.includes(\"all\") ? [] : [\"all\"];\r\n  const withoutAll = list.filter((v) => v !== \"all\");\r\n  if (withoutAll.includes(item)) {\r\n    const next = withoutAll.filter((v) => v !== item);\r\n    return next.length ? next : [\"all\"];\r\n  }\r\n  return [...withoutAll, item];\r\n};\r\n\r\nfunction Card({ title, subtitle, headerRight, children }) {\r\n  return (\r\n    <div className=\"rounded-3xl border border-[#E9E2F7] bg-white p-5 space-y-4\">\r\n      <div className=\"flex flex-wrap items-start justify-between gap-3\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">{title}</div>\r\n          {subtitle ? <div className=\"text-xs text-slate-500\">{subtitle}</div> : null}\r\n        </div>\r\n        {headerRight ? <div className=\"shrink-0\">{headerRight}</div> : null}\r\n      </div>\r\n      {children}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction TogglePills({ options, values, onChange }) {\r\n  const selected = arr(values, []);\r\n  return (\r\n    <div className=\"flex flex-wrap gap-2\">\r\n      {options.map((opt) => {\r\n        const active = selected.includes(opt.id);\r\n        return (\r\n          <button\r\n            key={opt.id}\r\n            type=\"button\"\r\n            onClick={() => onChange(toggleMulti(selected, opt.id))}\r\n            className={`rounded-full border px-3 py-1 text-xs font-semibold ${\r\n              active ? \"border-[#2F1A55] bg-[#2F1A55] text-white\" : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n            }`}\r\n          >\r\n            {opt.label}\r\n          </button>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function AdminSupportCatalogPanel() {\r\n  const navigate = useNavigate();\r\n  const { macroId = \"\", categoryId = \"\" } = useParams();\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [refreshing, setRefreshing] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [ok, setOk] = useState(\"\");\r\n  const [catalogHint, setCatalogHint] = useState(\"\");\r\n  const [priorityFloatingMessage, setPriorityFloatingMessage] = useState(\"\");\r\n\r\n  const [groupBy, setGroupBy] = useState(\"categoria\");\r\n  const [selectedGroupKey, setSelectedGroupKey] = useState(\"\");\r\n  const [appFilter, setAppFilter] = useState(\"all\");\r\n  const [macroStatusFilter, setMacroStatusFilter] = useState(\"all\");\r\n  const [search, setSearch] = useState(\"\");\r\n\r\n  const [categories, setCategories] = useState([]);\r\n  const [macros, setMacros] = useState([]);\r\n  const [baselineSortOrders, setBaselineSortOrders] = useState({});\r\n  const [collapsedMacroGroups, setCollapsedMacroGroups] = useState({});\r\n  const [inlineAddContext, setInlineAddContext] = useState(null);\r\n  const [workspaceMacroSubgroup, setWorkspaceMacroSubgroup] = useState(null);\r\n\r\n  const [categoryForm, setCategoryForm] = useState({ label: \"\", description: \"\", app_targets: [\"all\"] });\r\n  const [macroForm, setMacroForm] = useState({ ...EMPTY_MACRO_FORM });\r\n  const [workspaceAddForm, setWorkspaceAddForm] = useState({ ...EMPTY_MACRO_FORM });\r\n  const [editForm, setEditForm] = useState({\r\n    code: \"\",\r\n    title: \"\",\r\n    body: \"\",\r\n    category_id: \"\",\r\n    thread_status: \"new\",\r\n    audience_roles: [\"cliente\", \"negocio\"],\r\n    app_targets: [\"all\"],\r\n    env_targets: [\"all\"],\r\n  });\r\n  const [categoryEditForm, setCategoryEditForm] = useState({\r\n    code: \"\",\r\n    label: \"\",\r\n    description: \"\",\r\n    app_targets: [\"all\"],\r\n  });\r\n  const [categoryConfirm, setCategoryConfirm] = useState({\r\n    open: false,\r\n    action: \"\",\r\n    title: \"\",\r\n    confirmLabel: \"\",\r\n    message: \"\",\r\n    macros: [],\r\n    payload: {},\r\n  });\r\n  const [usageByMacroId, setUsageByMacroId] = useState({});\r\n  const [defaultUsageWindow, setDefaultUsageWindow] = useState(\"7d\");\r\n  const priorityMessageTimerRef = useRef(null);\r\n\r\n  const loadMacroUsageSummary = useCallback(async (macroList, selectedAppFilter) => {\r\n    const macroIds = Array.from(\r\n      new Set((macroList || []).map((macro) => s(macro.id)).filter(Boolean))\r\n    );\r\n    if (!macroIds.length) {\r\n      setUsageByMacroId({});\r\n      return;\r\n    }\r\n\r\n    const payload = { p_macro_ids: macroIds };\r\n    if (selectedAppFilter && selectedAppFilter !== \"all\") {\r\n      payload.p_app_key = selectedAppFilter;\r\n    }\r\n\r\n    const { data, error: usageError } = await supabase.rpc(\"support_macro_usage_summary\", payload);\r\n    if (usageError) {\r\n      setCatalogHint((prev) =>\r\n        prev ||\r\n        `No se pudo cargar analitica de macros (${usageError.message || \"summary_failed\"}).`\r\n      );\r\n      setUsageByMacroId({});\r\n      return;\r\n    }\r\n\r\n    const next = {};\r\n    (data || []).forEach((row) => {\r\n      const macroId = s(row.macro_id);\r\n      if (!macroId) return;\r\n      next[macroId] = {\r\n        shown_1d: Number(row.shown_1d || 0),\r\n        shown_7d: Number(row.shown_7d || 0),\r\n        shown_15d: Number(row.shown_15d || 0),\r\n        shown_30d: Number(row.shown_30d || 0),\r\n        copied_1d: Number(row.copied_1d || 0),\r\n        copied_7d: Number(row.copied_7d || 0),\r\n        copied_15d: Number(row.copied_15d || 0),\r\n        copied_30d: Number(row.copied_30d || 0),\r\n      };\r\n    });\r\n    setUsageByMacroId(next);\r\n  }, []);\r\n\r\n  const load = useCallback(async (manual = false) => {\r\n    manual ? setRefreshing(true) : setLoading(true);\r\n    setError(\"\");\r\n    setCatalogHint(\"\");\r\n    try {\r\n      const initialCatalog = await listSupportMacroCatalog({ includeArchived: true, includeDraft: true });\r\n\r\n      let catalog = initialCatalog;\r\n      const initialMacroCount = Array.isArray(initialCatalog?.macros) ? initialCatalog.macros.length : 0;\r\n      const initialCategoryCount = Array.isArray(initialCatalog?.categories) ? initialCatalog.categories.length : 0;\r\n\r\n      if (initialMacroCount === 0) {\r\n        try {\r\n          await dispatchSupportMacrosSync({\r\n            mode: \"hot\",\r\n            panelKey: \"admin_support_macros\",\r\n          });\r\n          catalog = await listSupportMacroCatalog({ includeArchived: true, includeDraft: true });\r\n        } catch (syncErr) {\r\n          setCatalogHint(\r\n            `No se pudo sincronizar macros desde OPS (${syncErr?.message || \"error_sync\"}).`,\r\n          );\r\n        }\r\n      }\r\n\r\n      const nextCategories = (catalog?.categories || []).map((c) => ({\r\n        id: s(c.id),\r\n        code: normCategoryCode(s(c.code, s(c.id))),\r\n        label: s(c.label, s(c.code, \"Sin label\")),\r\n        description: s(c.description),\r\n        status: s(c.status, \"active\"),\r\n        sort_order: Number(c.sort_order || 100),\r\n        app_targets: arr(c.app_targets, [\"all\"]),\r\n      }));\r\n      const byId = nextCategories.reduce((acc, c) => ((acc[c.id] = c.code), acc), {});\r\n      const nextMacros = (catalog?.macros || []).map((m) => ({\r\n        id: s(m.id),\r\n        code: s(m.code),\r\n        title: s(m.title, \"Sin titulo\"),\r\n        body: s(m.body),\r\n        category_id: s(m.category_id),\r\n        category_code: normCategoryCode(s(m.category_code, s(byId[s(m.category_id)], \"general\"))),\r\n        thread_status: s(m.thread_status, \"sin_estado\"),\r\n        audience_roles: normalizeAudienceRoles(m.audience_roles),\r\n        app_targets: arr(m.app_targets, [\"all\"]),\r\n        env_targets: arr(m.env_targets, [\"all\"]),\r\n        sort_order: Number(m.sort_order || 100),\r\n        status: s(m.status, \"draft\"),\r\n      }));\r\n\r\n      if (nextMacros.length === 0) {\r\n        if (initialCategoryCount > 0 || nextCategories.length > 0) {\r\n          setCatalogHint(\r\n            \"No hay macros en OPS para este tenant. El catalogo ahora vive en OPS y los macros legacy no se migran automaticamente.\",\r\n          );\r\n        } else {\r\n          setCatalogHint(\r\n            \"Catálogo OPS vacío (sin categorías ni macros). Crea categorías/macros con el botón + AÑADIR o ejecuta un seed inicial.\",\r\n          );\r\n        }\r\n      }\r\n\r\n      setCategories(nextCategories);\r\n      setMacros(nextMacros);\r\n      setBaselineSortOrders(\r\n        nextMacros.reduce((acc, macro) => {\r\n          acc[s(macro.id)] = Number(macro.sort_order || 100);\r\n          return acc;\r\n        }, {})\r\n      );\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudo cargar catalogo.\");\r\n    } finally {\r\n      setLoading(false);\r\n      setRefreshing(false);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    load(false);\r\n  }, [load]);\r\n\r\n  useEffect(\r\n    () => () => {\r\n      if (priorityMessageTimerRef.current) {\r\n        clearTimeout(priorityMessageTimerRef.current);\r\n      }\r\n    },\r\n    []\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (loading) return;\r\n    loadMacroUsageSummary(macros, appFilter);\r\n  }, [appFilter, loading, loadMacroUsageSummary, macros]);\r\n\r\n  useEffect(() => {\r\n    setCollapsedMacroGroups({});\r\n  }, [groupBy, selectedGroupKey]);\r\n\r\n  useEffect(() => {\r\n    setWorkspaceMacroSubgroup(null);\r\n  }, [groupBy, selectedGroupKey]);\r\n\r\n  useEffect(() => {\r\n    if (!inlineAddContext) return;\r\n    if (inlineAddContext.groupBy !== groupBy || inlineAddContext.parentGroupKey !== selectedGroupKey) {\r\n      setInlineAddContext(null);\r\n    }\r\n  }, [groupBy, inlineAddContext, selectedGroupKey]);\r\n\r\n  useEffect(() => {\r\n    if (!macroId || !inlineAddContext) return;\r\n    setInlineAddContext(null);\r\n  }, [inlineAddContext, macroId]);\r\n\r\n  const filteredCategories = useMemo(\r\n    () => categories.filter((c) => matchApp(c.app_targets, appFilter)),\r\n    [categories, appFilter]\r\n  );\r\n\r\n  const filteredMacros = useMemo(() => {\r\n    const query = search.trim().toLowerCase();\r\n    return macros\r\n      .filter((m) => matchApp(m.app_targets, appFilter))\r\n      .filter((m) => macroStatusFilter === \"all\" || m.status === macroStatusFilter)\r\n      .filter((m) => !query || `${m.title} ${m.body} ${m.code} ${m.category_code}`.toLowerCase().includes(query))\r\n      .sort(sortByPriority);\r\n  }, [macros, appFilter, macroStatusFilter, search]);\r\n\r\n  const categoryStats = useMemo(() => {\r\n    const macroCount = {};\r\n    const byThreadStatus = {};\r\n\r\n    filteredMacros.forEach((m) => {\r\n      const c = s(m.category_code, \"general\");\r\n      macroCount[c] = (macroCount[c] || 0) + 1;\r\n      byThreadStatus[c] ||= {};\r\n      byThreadStatus[c][m.thread_status] ||= [];\r\n      byThreadStatus[c][m.thread_status].push(m);\r\n    });\r\n\r\n    const base = [\r\n      {\r\n        id: \"general\",\r\n        code: \"general\",\r\n        label: \"General\",\r\n        description: \"Consultas generales sin categoria especifica.\",\r\n        status: \"active\",\r\n        sort_order: 0,\r\n        app_targets: [\"all\"],\r\n      },\r\n      ...filteredCategories,\r\n    ];\r\n\r\n    return base.map((c) => ({\r\n      ...c,\r\n      macros: macroCount[c.code] || 0,\r\n      byThreadStatus: byThreadStatus[c.code] || {},\r\n    }));\r\n  }, [filteredMacros, filteredCategories]);\r\n\r\n  const groupedStatus = useMemo(() => {\r\n    const groups = {};\r\n    filteredMacros.forEach((m) => {\r\n      groups[m.thread_status] ||= [];\r\n      groups[m.thread_status].push(m);\r\n    });\r\n    return Object.entries(groups)\r\n      .sort((a, b) => rank(a[0]) - rank(b[0]))\r\n      .map(([id, list]) => ({ id, label: THREAD_STATUS_LABEL[id] || id, list: [...list].sort(sortByPriority) }));\r\n  }, [filteredMacros]);\r\n\r\n  const groupedRole = useMemo(() => {\r\n    const groups = {};\r\n    filteredMacros.forEach((m) => {\r\n      m.audience_roles.forEach((r) => {\r\n        groups[r] ||= [];\r\n        groups[r].push(m);\r\n      });\r\n    });\r\n    return Object.entries(groups)\r\n      .sort((a, b) => a[0].localeCompare(b[0]))\r\n      .map(([id, list]) => ({ id, label: id, list: [...list].sort(sortByPriority) }));\r\n  }, [filteredMacros]);\r\n\r\n  const catalogGroups = useMemo(() => {\r\n    if (groupBy === \"estado\") {\r\n      return groupedStatus.map((group) => ({\r\n        id: group.id,\r\n        label: group.label,\r\n        description: \"Agrupado por estado de ticket.\",\r\n        list: [...group.list].sort(sortByPriority),\r\n        status: null,\r\n      }));\r\n    }\r\n\r\n    if (groupBy === \"rol\") {\r\n      return groupedRole.map((group) => ({\r\n        id: group.id,\r\n        label: group.label,\r\n        description: \"Agrupado por rol de audiencia.\",\r\n        list: [...group.list].sort(sortByPriority),\r\n        status: null,\r\n      }));\r\n    }\r\n\r\n    return [...categoryStats]\r\n      .map((category) => {\r\n        const normalizedCode = normCategoryCode(category.code);\r\n        const normalizedStatus = category.status === \"active\" ? \"active\" : \"inactive\";\r\n        const list = filteredMacros\r\n          .filter((macro) => normCategoryCode(macro.category_code) === normalizedCode)\r\n          .sort(sortByPriority);\r\n        return {\r\n          id: normalizedCode,\r\n          category_id: category.id,\r\n          label: category.label,\r\n          code: category.code,\r\n          description: category.description || \"Sin descripcion\",\r\n          status: normalizedStatus,\r\n          sort_order: Number(category.sort_order || 100),\r\n          list,\r\n        };\r\n      })\r\n      .sort((a, b) => {\r\n        const statusDiff = (a.status === \"active\" ? 0 : 1) - (b.status === \"active\" ? 0 : 1);\r\n        if (statusDiff !== 0) return statusDiff;\r\n        const sortDiff = Number(a.sort_order || 100) - Number(b.sort_order || 100);\r\n        if (sortDiff !== 0) return sortDiff;\r\n        return s(a.label).localeCompare(s(b.label), \"es\", { sensitivity: \"base\" });\r\n      });\r\n  }, [categoryStats, filteredMacros, groupBy, groupedRole, groupedStatus]);\r\n\r\n  useEffect(() => {\r\n    if (!catalogGroups.length) {\r\n      if (selectedGroupKey) setSelectedGroupKey(\"\");\r\n      return;\r\n    }\r\n\r\n    if (selectedGroupKey && catalogGroups.some((group) => group.id === selectedGroupKey)) {\r\n      return;\r\n    }\r\n\r\n    const currentEditing = macros.find((macro) => macro.id === macroId) || null;\r\n    if (currentEditing) {\r\n      let fallbackGroupKey = \"\";\r\n      if (groupBy === \"estado\") {\r\n        fallbackGroupKey = s(currentEditing.thread_status, \"sin_estado\");\r\n      } else if (groupBy === \"rol\") {\r\n        fallbackGroupKey = s(arr(currentEditing.audience_roles, [\"sin_rol\"])[0], \"sin_rol\");\r\n      } else {\r\n        fallbackGroupKey = normCategoryCode(s(currentEditing.category_code, \"general\"));\r\n      }\r\n      if (fallbackGroupKey && catalogGroups.some((group) => group.id === fallbackGroupKey)) {\r\n        setSelectedGroupKey(fallbackGroupKey);\r\n        return;\r\n      }\r\n    }\r\n\r\n    setSelectedGroupKey(\"\");\r\n  }, [catalogGroups, groupBy, macroId, macros, selectedGroupKey]);\r\n\r\n  const selectedGroup = useMemo(\r\n    () => catalogGroups.find((group) => group.id === selectedGroupKey) || null,\r\n    [catalogGroups, selectedGroupKey]\r\n  );\r\n\r\n  const selectedGroupMacrosByStatus = useMemo(() => {\r\n    const groups = {};\r\n    (selectedGroup?.list || []).forEach((macro) => {\r\n      const status = s(macro.thread_status, \"sin_estado\");\r\n      groups[status] ||= [];\r\n      groups[status].push(macro);\r\n    });\r\n    return Object.entries(groups)\r\n      .sort((a, b) => rank(a[0]) - rank(b[0]))\r\n      .map(([status, list]) => ({\r\n        id: status,\r\n        label: THREAD_STATUS_LABEL[status] || status,\r\n        list: [...list].sort(sortByPriority),\r\n      }));\r\n  }, [selectedGroup]);\r\n\r\n  const selectedGroupMacrosByCategory = useMemo(() => {\r\n    const groups = {};\r\n    (selectedGroup?.list || []).forEach((macro) => {\r\n      const byId = categories.find((category) => s(category.id) === s(macro.category_id));\r\n      const byCode = categories.find(\r\n        (category) => normCategoryCode(category.code) === normCategoryCode(s(macro.category_code, \"general\"))\r\n      );\r\n      const category = byId || byCode || null;\r\n      const categoryCode = category ? normCategoryCode(category.code) : \"general\";\r\n      groups[categoryCode] ||= {\r\n        id: categoryCode,\r\n        code: categoryCode,\r\n        label: category?.label || \"General\",\r\n        category_id: category?.id || \"\",\r\n        sort_order: Number(category?.sort_order || 0),\r\n        app_targets: category ? arr(category.app_targets, [\"all\"]) : [\"all\"],\r\n        list: [],\r\n      };\r\n      groups[categoryCode].list.push(macro);\r\n    });\r\n\r\n    return Object.values(groups)\r\n      .map((group) => ({\r\n        ...group,\r\n        list: [...group.list].sort(sortByPriority),\r\n      }))\r\n      .sort((a, b) => {\r\n        const sortDiff = Number(a.sort_order || 0) - Number(b.sort_order || 0);\r\n        if (sortDiff !== 0) return sortDiff;\r\n        return s(a.label).localeCompare(s(b.label), \"es\", { sensitivity: \"base\" });\r\n      });\r\n  }, [categories, selectedGroup]);\r\n\r\n  const selectedGroupFlatMacros = useMemo(\r\n    () => [...(selectedGroup?.list || [])].sort(sortByPriority),\r\n    [selectedGroup]\r\n  );\r\n\r\n  const workspaceLeftMacros = useMemo(() => {\r\n    const base = [...(selectedGroup?.list || [])].sort(sortByPriority);\r\n    if (!workspaceMacroSubgroup || workspaceMacroSubgroup.groupBy !== groupBy) return base;\r\n    if (groupBy === \"categoria\") {\r\n      return base.filter(\r\n        (macro) => s(macro.thread_status, \"sin_estado\") === s(workspaceMacroSubgroup.subgroupId)\r\n      );\r\n    }\r\n    if (groupBy === \"rol\") {\r\n      return base.filter(\r\n        (macro) => normCategoryCode(s(macro.category_code, \"general\")) === s(workspaceMacroSubgroup.subgroupId)\r\n      );\r\n    }\r\n    return base;\r\n  }, [groupBy, selectedGroup, workspaceMacroSubgroup]);\r\n\r\n  const editing = useMemo(() => macros.find((m) => m.id === macroId) || null, [macros, macroId]);\r\n  const editingCategory = useMemo(\r\n    () => categories.find((category) => category.id === categoryId) || null,\r\n    [categories, categoryId]\r\n  );\r\n  const categoryMacros = useMemo(() => {\r\n    if (!editingCategory) return [];\r\n    const categoryCode = normCategoryCode(editingCategory.code);\r\n    return macros.filter(\r\n      (macro) =>\r\n        s(macro.category_id) === editingCategory.id ||\r\n        normCategoryCode(macro.category_code) === categoryCode\r\n    );\r\n  }, [editingCategory, macros]);\r\n\r\n  useEffect(() => {\r\n    if (!editing) return;\r\n    setEditForm({\r\n      code: editing.code,\r\n      title: editing.title,\r\n      body: editing.body,\r\n      category_id: editing.category_id || \"\",\r\n      thread_status: editing.thread_status === \"sin_estado\" ? \"new\" : editing.thread_status,\r\n      audience_roles: normalizeAudienceRoles(editing.audience_roles),\r\n      app_targets: arr(editing.app_targets, [\"all\"]),\r\n      env_targets: arr(editing.env_targets, [\"all\"]),\r\n    });\r\n  }, [editing]);\r\n\r\n  useEffect(() => {\r\n    if (!editingCategory) return;\r\n    setCategoryEditForm({\r\n      code: editingCategory.code,\r\n      label: editingCategory.label,\r\n      description: editingCategory.description || \"\",\r\n      app_targets: arr(editingCategory.app_targets, [\"all\"]),\r\n    });\r\n  }, [editingCategory]);\r\n\r\n  const categoryOptions = useMemo(\r\n    () => {\r\n      const orderedCategories = [...categories].sort((a, b) => {\r\n        const statusDiff = (a.status === \"active\" ? 0 : 1) - (b.status === \"active\" ? 0 : 1);\r\n        if (statusDiff !== 0) return statusDiff;\r\n        const sortDiff = Number(a.sort_order || 100) - Number(b.sort_order || 100);\r\n        if (sortDiff !== 0) return sortDiff;\r\n        return s(a.label).localeCompare(s(b.label), \"es\", { sensitivity: \"base\" });\r\n      });\r\n      return [\r\n        { id: \"\", label: \"Sin categoria (general)\" },\r\n        ...orderedCategories.map((c) => ({\r\n          id: c.id,\r\n          label: `${c.label} (${c.code})`,\r\n        })),\r\n      ];\r\n    },\r\n    [categories]\r\n  );\r\n\r\n  const submitCreateCategory = async (event) => {\r\n    event.preventDefault();\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    if (!s(categoryForm.label)) {\r\n      setError(\"Label de categoria invalido.\");\r\n      return;\r\n    }\r\n    setSaving(true);\r\n    try {\r\n      await createSupportMacroCategory({\r\n        label: s(categoryForm.label),\r\n        description: s(categoryForm.description),\r\n        app_targets: arr(categoryForm.app_targets, [\"all\"]),\r\n        status: \"active\",\r\n      });\r\n      setOk(\"Categoria creada en active con code automatico.\");\r\n      setCategoryForm({ label: \"\", description: \"\", app_targets: [\"all\"] });\r\n      await load(true);\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudo crear categoria.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const submitCreateMacro = async (event) => {\n    event.preventDefault();\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    if (!s(macroForm.title) || !s(macroForm.body)) {\r\n      setError(\"Título/body de macro inválidos.\");\r\n      return;\r\n    }\r\n    setSaving(true);\n    try {\n      const created = await createSupportMacro({\n        title: s(macroForm.title),\n        body: s(macroForm.body),\n        category_id: s(macroForm.category_id) || null,\n        thread_status: s(macroForm.thread_status, \"new\"),\n        audience_roles: normalizeAudienceRoles(macroForm.audience_roles),\n        app_targets: arr(macroForm.app_targets, [\"all\"]),\r\n        env_targets: arr(macroForm.env_targets, [\"all\"]),\r\n        status: \"draft\",\n      });\n      const createdId = s(created?.id);\n      setOk(\"Macro creado en draft con code automatico.\");\n      setMacroForm({ ...EMPTY_MACRO_FORM });\n      await load(true);\n      if (createdId) {\n        navigate(`/admin/macros/${createdId}`);\n      }\n    } catch (err) {\n      setError(err?.message || \"No se pudo crear macro.\");\n    } finally {\n      setSaving(false);\n    }\n  };\r\n\r\n  const openInlineAddMacro = useCallback(\r\n    (context) => {\r\n      const next = {\r\n        ...EMPTY_MACRO_FORM,\r\n        category_id: s(context?.category_id),\r\n        thread_status: s(context?.thread_status, \"new\"),\r\n        audience_roles: normalizeAudienceRoles(context?.audience_roles),\r\n        app_targets: arr(context?.app_targets, appFilter !== \"all\" ? [appFilter] : [\"all\"]),\r\n        env_targets: arr(context?.env_targets, [\"all\"]),\r\n      };\r\n      setInlineAddContext({\r\n        ...context,\r\n        groupBy,\r\n        parentGroupKey: selectedGroupKey,\r\n      });\r\n      setWorkspaceAddForm(next);\r\n      setError(\"\");\r\n      setOk(\"\");\r\n    },\r\n    [appFilter, groupBy, selectedGroupKey]\r\n  );\r\n\r\n  const closeInlineAddMacro = useCallback(() => {\r\n    setInlineAddContext(null);\r\n    setWorkspaceAddForm({ ...EMPTY_MACRO_FORM });\r\n  }, []);\r\n\r\n  const submitInlineAddMacro = async (event) => {\n    event.preventDefault();\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    if (!s(workspaceAddForm.title) || !s(workspaceAddForm.body)) {\r\n      setError(\"Título/body de macro inválidos.\");\r\n      return;\r\n    }\r\n    setSaving(true);\n    try {\n      const created = await createSupportMacro({\n        title: s(workspaceAddForm.title),\n        body: s(workspaceAddForm.body),\n        category_id: s(workspaceAddForm.category_id) || null,\n        thread_status: s(workspaceAddForm.thread_status, \"new\"),\n        audience_roles: normalizeAudienceRoles(workspaceAddForm.audience_roles),\n        app_targets: arr(workspaceAddForm.app_targets, [\"all\"]),\r\n        env_targets: arr(workspaceAddForm.env_targets, [\"all\"]),\n        status: \"draft\",\n      });\n      const createdId = s(created?.id);\n      setOk(\"Macro creado en draft.\");\n      await load(true);\n      if (createdId) {\n        navigate(`/admin/macros/${createdId}`);\n      } else {\n        closeInlineAddMacro();\n      }\n    } catch (err) {\n      setError(err?.message || \"No se pudo crear macro.\");\n    } finally {\n      setSaving(false);\n    }\n  };\r\n\r\n  const submitSaveMacro = async (event) => {\r\n    event.preventDefault();\r\n    if (!macroId) return;\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    if (!s(editForm.title) || !s(editForm.body)) {\r\n      setError(\"Título/body de macro inválidos.\");\r\n      return;\r\n    }\r\n    setSaving(true);\r\n    try {\r\n      await updateSupportMacro({\r\n        macro_id: macroId,\r\n        title: s(editForm.title),\r\n        body: s(editForm.body),\r\n        category_id: s(editForm.category_id) || null,\r\n        thread_status: s(editForm.thread_status, \"new\"),\r\n        audience_roles: normalizeAudienceRoles(editForm.audience_roles),\r\n        app_targets: arr(editForm.app_targets, [\"all\"]),\r\n        env_targets: arr(editForm.env_targets, [\"all\"]),\r\n      });\r\n      setOk(\"Macro actualizada.\");\r\n      await load(true);\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudo actualizar macro.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const setMacroLifecycle = async (status) => {\r\n    if (!macroId) return;\r\n    setSaving(true);\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    try {\r\n      await setSupportMacroStatus({ macroId, status });\r\n      setOk(`Macro movida a ${status}.`);\r\n      await load(true);\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudo cambiar estado.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const removeMacro = async () => {\r\n    if (!macroId || !window.confirm(\"Eliminar macro permanentemente.\")) return;\r\n    setSaving(true);\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    try {\r\n      await deleteSupportMacro({ macroId });\r\n      navigate(\"/admin/macros\");\r\n      await load(true);\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudo eliminar macro.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const openCategoryConfirm = ({\r\n    action,\r\n    title,\r\n    confirmLabel,\r\n    message,\r\n    payload = {},\r\n  }) => {\r\n    setCategoryConfirm({\r\n      open: true,\r\n      action,\r\n      title,\r\n      confirmLabel,\r\n      message,\r\n      macros: categoryMacros,\r\n      payload,\r\n    });\r\n  };\r\n\r\n  const closeCategoryConfirm = () => {\r\n    setCategoryConfirm({\r\n      open: false,\r\n      action: \"\",\r\n      title: \"\",\r\n      confirmLabel: \"\",\r\n      message: \"\",\r\n      macros: [],\r\n      payload: {},\r\n    });\r\n  };\r\n\r\n  const submitSaveCategory = (event) => {\r\n    event.preventDefault();\r\n    if (!editingCategory) return;\r\n    if (!s(categoryEditForm.label)) {\r\n      setError(\"Label de categoria invalido.\");\r\n      return;\r\n    }\r\n\r\n    openCategoryConfirm({\r\n      action: \"save\",\r\n      title: \"Confirmar edicion de categoria\",\r\n      confirmLabel: \"Guardar categoria\",\r\n      message:\r\n        \"Se guardaran los cambios de la categoria. Los macros listados seguiran asociados a esta categoria.\",\r\n      payload: {\r\n        category_id: editingCategory.id,\r\n        label: s(categoryEditForm.label),\r\n        description: s(categoryEditForm.description),\r\n        app_targets: arr(categoryEditForm.app_targets, [\"all\"]),\r\n      },\r\n    });\r\n  };\r\n\r\n  const triggerCategoryLifecycle = (nextStatus) => {\r\n    if (!editingCategory) return;\r\n    const verbs = {\r\n      active: \"activar\",\r\n      inactive: \"inactivar\",\r\n    };\r\n    openCategoryConfirm({\r\n      action: `status:${nextStatus}`,\r\n      title: `Confirmar ${verbs[nextStatus] || \"cambio\"} de categoria`,\r\n      confirmLabel: verbs[nextStatus] || \"Confirmar\",\r\n      message:\r\n        nextStatus === \"inactive\"\r\n          ? \"Esta accion inactiva la categoria y archivara los macros asociados que se muestran abajo.\"\r\n          : \"Se activara la categoria. Los macros asociados conservan su estado actual.\",\r\n      payload: { category_id: editingCategory.id, status: nextStatus },\r\n    });\r\n  };\r\n\r\n  const removeCategory = () => {\r\n    if (!editingCategory) return;\r\n    openCategoryConfirm({\r\n      action: \"delete\",\r\n      title: \"Confirmar eliminacion de categoria\",\r\n      confirmLabel: \"Eliminar categoria\",\r\n      message:\r\n        \"Se eliminara la categoria y tambien se eliminaran los macros asociados que se muestran abajo.\",\r\n      payload: { category_id: editingCategory.id },\r\n    });\r\n  };\r\n\r\n  const executeCategoryConfirm = async () => {\r\n    const targetCategoryId = s(categoryConfirm.payload?.category_id, s(editingCategory?.id));\r\n    if (!targetCategoryId) return;\r\n    setSaving(true);\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    try {\r\n      if (categoryConfirm.action === \"save\") {\r\n        await updateSupportMacroCategory(categoryConfirm.payload || {});\r\n        setOk(\"Categoria actualizada.\");\r\n      } else if (categoryConfirm.action.startsWith(\"status:\")) {\r\n        const nextStatus = categoryConfirm.action.split(\":\")[1];\r\n        await setSupportMacroCategoryStatus({\r\n          categoryId: targetCategoryId,\r\n          status: nextStatus,\r\n        });\r\n        setOk(`Categoria movida a ${nextStatus}.`);\r\n      } else if (categoryConfirm.action === \"delete\") {\r\n        await deleteSupportMacroCategory({ categoryId: targetCategoryId });\r\n        setOk(\"Categoria eliminada junto con sus macros.\");\r\n        navigate(\"/admin/macros\");\r\n      }\r\n      closeCategoryConfirm();\r\n      await load(true);\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudo ejecutar accion de categoria.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const pendingPriorityChanges = useMemo(\r\n    () =>\r\n      macros.filter((macro) => {\r\n        const macroId = s(macro.id);\r\n        if (!macroId || baselineSortOrders[macroId] === undefined) return false;\r\n        return Number(macro.sort_order || 100) !== Number(baselineSortOrders[macroId]);\r\n      }),\r\n    [baselineSortOrders, macros]\r\n  );\r\n  const hasPendingPriorityChanges = pendingPriorityChanges.length > 0;\r\n\r\n  const moveMacroPriorityWithinList = useCallback((orderedList, index, direction) => {\r\n    const targetIndex = index + direction;\r\n    if (targetIndex < 0 || targetIndex >= orderedList.length) return;\r\n\r\n    const orderedIds = orderedList.map((macro) => s(macro.id)).filter(Boolean);\r\n    if (!orderedIds.length) return;\r\n\r\n    const movedId = orderedIds[index];\r\n    orderedIds.splice(index, 1);\r\n    orderedIds.splice(targetIndex, 0, movedId);\r\n\r\n    const base = 100;\r\n    const step = 10;\r\n    const nextSortById = orderedIds.reduce((acc, macroId, idx) => {\r\n      acc[macroId] = base + idx * step;\r\n      return acc;\r\n    }, {});\r\n\r\n    setMacros((prev) =>\r\n      prev.map((macro) => {\r\n        const macroId = s(macro.id);\r\n        if (nextSortById[macroId] === undefined) return macro;\r\n        return {\r\n          ...macro,\r\n          sort_order: nextSortById[macroId],\r\n        };\r\n      })\r\n    );\r\n  }, []);\r\n\r\n  const applyPriorityChanges = async () => {\r\n    if (!hasPendingPriorityChanges) return;\r\n    setSaving(true);\r\n    setError(\"\");\r\n    setOk(\"\");\r\n    try {\r\n      await Promise.all(\r\n        pendingPriorityChanges.map((macro) =>\r\n          updateSupportMacro({\r\n            macro_id: macro.id,\r\n            sort_order: Number(macro.sort_order || 100),\r\n          })\r\n        )\r\n      );\r\n      setOk(\"Prioridades aplicadas.\");\r\n      await load(true);\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudieron aplicar los cambios de prioridad.\");\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const revertPriorityChanges = () => {\r\n    setMacros((prev) =>\r\n      prev.map((macro) => {\r\n        const macroId = s(macro.id);\r\n        if (baselineSortOrders[macroId] === undefined) return macro;\r\n        return {\r\n          ...macro,\r\n          sort_order: Number(baselineSortOrders[macroId]),\r\n        };\r\n      })\r\n    );\r\n    setPriorityFloatingMessage(\"Cambios de prioridad revertidos.\");\r\n    if (priorityMessageTimerRef.current) {\r\n      clearTimeout(priorityMessageTimerRef.current);\r\n    }\r\n    priorityMessageTimerRef.current = setTimeout(() => {\r\n      setPriorityFloatingMessage(\"\");\r\n      priorityMessageTimerRef.current = null;\r\n    }, 5000);\r\n  };\r\n\r\n  const getMacroDisplayTitle = useCallback(\r\n    (macro) => {\r\n      const rawTitle = s(macro?.title, \"Sin titulo\");\r\n      const categoryFromId = categories.find((category) => s(category.id) === s(macro?.category_id));\r\n      const categoryFromCode = categories.find(\r\n        (category) => normCategoryCode(category.code) === normCategoryCode(s(macro?.category_code, \"general\"))\r\n      );\r\n      const category = categoryFromId || categoryFromCode || null;\r\n      const prefixes = Array.from(\r\n        new Set(\r\n          [\r\n            s(category?.label),\r\n            s(category?.code),\r\n            s(macro?.category_code),\r\n            s(category?.code).replace(/_/g, \" \"),\r\n            s(macro?.category_code).replace(/_/g, \" \"),\r\n          ].filter(Boolean),\r\n        ),\r\n      );\r\n\r\n      let cleaned = rawTitle;\r\n      for (const prefix of prefixes) {\r\n        const regex = new RegExp(`^\\\\s*${escapeRegExp(prefix)}\\\\s*[-:|]\\\\s*`, \"i\");\r\n        cleaned = cleaned.replace(regex, \"\").trim();\r\n      }\r\n      return s(cleaned, rawTitle);\r\n    },\r\n    [categories]\r\n  );\r\n\r\n  const macroCard = (macro, key, controls = null, onOpenMacro = null, view = \"full\", isSelected = false) => {\r\n    const usage = usageByMacroId[macro.id] || EMPTY_USAGE;\r\n    const macroUsageWindow = defaultUsageWindow;\r\n    const shownValue = Number(usage[`shown_${macroUsageWindow}`] || 0);\r\n    const copiedValue = Number(usage[`copied_${macroUsageWindow}`] || 0);\r\n    const compactWorkspaceView = view === \"workspace-left\";\r\n    const rightPanelView = !compactWorkspaceView;\r\n    const displayTitle = getMacroDisplayTitle(macro);\r\n    const appTagLabels = rightPanelView ? resolveAppTagLabels(macro.app_targets) : [];\r\n    const roleTagLabels = rightPanelView ? arr(macro.audience_roles, []) : [];\r\n    const envTagLabels = rightPanelView ? resolveEnvTagLabels(macro.env_targets) : [];\r\n    return (\r\n      <div key={key} className=\"flex items-stretch gap-2\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={() =>\r\n            (onOpenMacro || ((item) => navigate(`/admin/macros/${item.id}`)))(macro)\r\n          }\r\n          className={`flex-1 rounded-lg border px-3 py-2 text-left transition ${\r\n            isSelected\r\n              ? \"border-[#BFC7D1] bg-[#F3EEFF]\"\r\n              : \"border-[#D1D5DB] bg-[#FCFBFF] hover:border-[#BFC7D1] hover:bg-[#F9F7FF]\"\r\n          }`}\r\n        >\r\n          <div className=\"flex items-start gap-4\">\r\n            <div className=\"min-w-0 flex-1\">\r\n              <div className={`flex items-start ${rightPanelView ? \"gap-3\" : \"gap-2\"}`}>\r\n                <div className=\"min-w-0 flex-1 text-xs font-semibold text-[#2F1A55]\">{displayTitle}</div>\r\n                {!rightPanelView ? (\r\n                  <span className={`shrink-0 rounded-full border px-2 py-0.5 text-[11px] font-semibold ${badge(macro.status)}`}>\r\n                    {macro.status}\r\n                  </span>\r\n                ) : null}\r\n                {rightPanelView ? (\r\n                  <div className=\"ml-auto flex max-w-[55%] flex-wrap items-center justify-end text-[9px] font-medium text-slate-900\">\r\n                    {appTagLabels.map((label, index) => (\r\n                      <React.Fragment key={`${macro.id}-app-${label}`}>\r\n                        {index > 0 ? <span className=\"px-2 text-slate-900\">/</span> : null}\r\n                        <span>{label}</span>\r\n                      </React.Fragment>\r\n                    ))}\r\n                  </div>\r\n                ) : null}\r\n              </div>\r\n              <div className={rightPanelView ? \"mt-3 text-xs text-slate-600\" : \"mt-2 text-xs text-slate-600\"}>\r\n                {short(macro.body, 220)}\r\n              </div>\r\n              {rightPanelView ? (\r\n                <div className=\"mt-3 flex items-center gap-3\">\r\n                  <div className=\"flex flex-wrap items-center text-[9px] font-medium text-slate-600\">\r\n                    {roleTagLabels.map((role, index) => (\r\n                      <React.Fragment key={`${macro.id}-role-${role}`}>\r\n                        {index > 0 ? <span className=\"px-2 text-slate-600\">/</span> : null}\r\n                        <span>{role}</span>\r\n                      </React.Fragment>\r\n                    ))}\r\n                  </div>\r\n                  <div className=\"ml-auto flex flex-wrap items-center justify-end text-[9px] font-medium text-orange-600\">\r\n                    {envTagLabels.map((label, index) => (\r\n                      <React.Fragment key={`${macro.id}-env-${label}`}>\r\n                        {index > 0 ? <span className=\"px-2 text-orange-600\">/</span> : null}\r\n                        <span>{label}</span>\r\n                      </React.Fragment>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              ) : null}\r\n            </div>\r\n            {rightPanelView ? (\r\n              <div className=\"ml-auto flex shrink-0 items-start gap-1\">\r\n                <div className=\"w-[136px] rounded-xl border border-[#E9E2F7] bg-white px-2 py-2 text-center text-[11px]\">\r\n                  <div className=\"text-[#5E30A5]\">\r\n                    Mostrado: <strong>{shownValue}</strong>\r\n                  </div>\r\n                  <div className=\"mt-1 text-[#1E5E9A]\">\r\n                    Copiado: <strong>{copiedValue}</strong>\r\n                  </div>\r\n                </div>\r\n                <span className={`shrink-0 rounded-full border px-2 py-0.5 text-[11px] font-semibold ${badge(macro.status)}`}>\r\n                  {macro.status}\r\n                </span>\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        </button>\r\n        {controls ? (\r\n          <div className=\"flex shrink-0 flex-col justify-center gap-1\">\r\n            {controls.canMoveUp ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={(event) => {\r\n                  event.preventDefault();\r\n                  event.stopPropagation();\r\n                  controls.onMoveUp?.();\r\n                }}\r\n                className=\"rounded-md border border-[#E9E2F7] bg-white p-1 text-[#5E30A5] hover:border-[#CDBAF1]\"\r\n                aria-label=\"Subir prioridad\"\r\n              >\r\n                <ArrowUp size={12} />\r\n              </button>\r\n            ) : (\r\n              <span className=\"h-[22px] w-[22px]\" />\r\n            )}\r\n            <span className=\"inline-flex h-[22px] w-[22px] items-center justify-center rounded-md border border-[#E9E2F7] bg-white text-[11px] font-semibold text-[#5E30A5]\">\r\n              {controls.position ?? \"\"}\r\n            </span>\r\n            {controls.canMoveDown ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={(event) => {\r\n                  event.preventDefault();\r\n                  event.stopPropagation();\r\n                  controls.onMoveDown?.();\r\n                }}\r\n                className=\"rounded-md border border-[#E9E2F7] bg-white p-1 text-[#5E30A5] hover:border-[#CDBAF1]\"\r\n                aria-label=\"Bajar prioridad\"\r\n              >\r\n                <ArrowDown size={12} />\r\n              </button>\r\n            ) : (\r\n              <span className=\"h-[22px] w-[22px]\" />\r\n            )}\r\n          </div>\r\n        ) : null}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  const renderCatalog = () => {\r\n    const selectionLabel = groupBy === \"categoria\" ? \"categoría\" : groupBy === \"estado\" ? \"estado\" : \"rol\";\r\n    const selectionArticle = groupBy === \"categoria\" ? \"una\" : \"un\";\r\n    const showMacroWorkspace = Boolean(macroId);\r\n    const showRightWorkspace = Boolean(macroId) || Boolean(inlineAddContext);\r\n    const rightPanelGroupedMacros = groupBy === \"rol\" ? selectedGroupMacrosByCategory : selectedGroupMacrosByStatus;\r\n    const supportsGroupedActions = groupBy === \"categoria\" || groupBy === \"rol\";\r\n    const showCollapseToggle = supportsGroupedActions && rightPanelGroupedMacros.length > 1;\r\n\r\n    const renderInlineAddWorkspace = () => (\r\n      <div className=\"space-y-3\">\r\n        <div className=\"flex items-center justify-between gap-3 px-1 py-0.5\">\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Añadir macro\r\n            {inlineAddContext?.title ? (\r\n              <span className=\"ml-2 text-xs font-medium text-slate-500\">{inlineAddContext.title}</span>\r\n            ) : null}\r\n          </div>\r\n          <button\r\n            type=\"button\"\r\n            onClick={closeInlineAddMacro}\r\n            className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-1.5 text-xs font-semibold text-[#5E30A5]\"\r\n          >\r\n            <ArrowLeft size={14} />\r\n            Volver\r\n          </button>\r\n        </div>\r\n\r\n        <form className=\"space-y-4\" onSubmit={submitInlineAddMacro}>\r\n          <input\r\n            value={workspaceAddForm.title}\r\n            onChange={(e) => setWorkspaceAddForm((prev) => ({ ...prev, title: e.target.value }))}\r\n            placeholder=\"título\"\r\n            className=\"w-full rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\"\r\n          />\r\n          <textarea\r\n            rows={5}\r\n            value={workspaceAddForm.body}\r\n            onChange={(e) => setWorkspaceAddForm((prev) => ({ ...prev, body: e.target.value }))}\r\n            placeholder=\"body\"\r\n            className=\"w-full resize-none rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\"\r\n          />\r\n          <div className=\"grid gap-3 md:grid-cols-2\">\r\n            <select\r\n              value={workspaceAddForm.category_id}\r\n              onChange={(e) => setWorkspaceAddForm((prev) => ({ ...prev, category_id: e.target.value }))}\r\n              className=\"rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\"\r\n            >\r\n              {categoryOptions.map((option) => (\r\n                <option key={option.id || \"general\"} value={option.id}>\r\n                  {option.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n            <select\r\n              value={workspaceAddForm.thread_status}\r\n              onChange={(e) => setWorkspaceAddForm((prev) => ({ ...prev, thread_status: e.target.value }))}\r\n              className=\"rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\"\r\n            >\r\n              {THREAD_STATUS_ORDER.filter((status) => status !== \"sin_estado\").map((status) => (\r\n                <option key={status} value={status}>\r\n                  {THREAD_STATUS_LABEL[status]}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n          <TogglePills\r\n            options={ROLE_OPTIONS}\r\n            values={workspaceAddForm.audience_roles}\r\n            onChange={(values) => setWorkspaceAddForm((prev) => ({ ...prev, audience_roles: values }))}\r\n          />\r\n          <TogglePills\r\n            options={APP_OPTIONS}\r\n            values={workspaceAddForm.app_targets}\r\n            onChange={(values) => setWorkspaceAddForm((prev) => ({ ...prev, app_targets: values }))}\r\n          />\r\n          <TogglePills\r\n            options={ENV_OPTIONS}\r\n            values={workspaceAddForm.env_targets}\r\n            onChange={(values) => setWorkspaceAddForm((prev) => ({ ...prev, env_targets: values }))}\r\n          />\r\n          <div className=\"flex justify-end\">\r\n            <button\r\n              type=\"submit\"\r\n              disabled={saving}\r\n              className={`inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-sm font-semibold text-white ${\r\n                saving ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"\r\n              }`}\r\n            >\r\n              <Plus size={14} />\r\n              Crear macro draft\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </div>\r\n    );\r\n\r\n    return (\r\n      <Card\r\n        title={<span className=\"text-lg font-extrabold tracking-wide text-[#2F1A55]\">CATÁLOGO DE MACROS</span>}\r\n        headerRight={(\r\n          <div className=\"flex items-center gap-1\">\r\n            <label className=\"text-xs font-semibold text-slate-500\">Periodo de tiempo</label>\r\n            <div className=\"flex flex-wrap gap-1\">\r\n              {USAGE_WINDOWS.map((windowKey) => (\r\n                <button\r\n                  key={`catalog-window-${windowKey}`}\r\n                  type=\"button\"\r\n                  onClick={() => setDefaultUsageWindow(windowKey)}\r\n                  className={`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${\r\n                    defaultUsageWindow === windowKey\r\n                      ? \"border-[#2F1A55] bg-[#2F1A55] text-white\"\r\n                      : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n                  }`}\r\n                >\r\n                  {windowKey}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        )}\r\n      >\r\n        <div className=\"grid items-end gap-3 sm:grid-cols-12\">\r\n          <div className=\"sm:col-span-3\">\r\n            <label className=\"text-xs font-semibold text-slate-500\">App</label>\r\n            <select\r\n              value={appFilter}\r\n              onChange={(e) => setAppFilter(e.target.value)}\r\n              className=\"mt-1 w-full rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs\"\r\n            >\r\n              {APP_OPTIONS.map((o) => (\r\n                <option key={o.id} value={o.id}>\r\n                  {o.label}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n          <div className=\"sm:col-span-3\">\r\n            <label className=\"text-xs font-semibold text-slate-500\">Estado macro</label>\r\n            <select\r\n              value={macroStatusFilter}\r\n              onChange={(e) => setMacroStatusFilter(e.target.value)}\r\n              className=\"mt-1 w-full rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs\"\r\n            >\r\n              <option value=\"all\">Todos</option>\r\n              {LIFECYCLE_OPTIONS.map((status) => (\r\n                <option key={status} value={status}>\r\n                  {status}\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n          <div className=\"sm:col-span-6\">\r\n            <label className=\"text-xs font-semibold text-slate-500\">Buscar</label>\r\n            <div className=\"relative mt-1\">\r\n              <Search size={14} className=\"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" />\r\n              <input\r\n                value={search}\r\n                onChange={(e) => setSearch(e.target.value)}\r\n                placeholder=\"Título, body, code...\"\r\n                className=\"w-full rounded-xl border border-[#E9E2F7] py-2 pl-9 pr-3 text-xs\"\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid gap-4 lg:grid-cols-10\">\r\n          <div className=\"space-y-2 lg:col-span-3\">\r\n            {!showRightWorkspace ? (\r\n              <div className=\"px-3 pt-2 pb-0\">\r\n                <div className=\"flex min-h-[24px] flex-nowrap items-center gap-2 overflow-x-auto\">\r\n                  <span className=\"shrink-0 text-xs font-semibold text-slate-500\">Grupo</span>\r\n                  {GROUP_OPTIONS.map((g) => (\r\n                    <button\r\n                      key={g.id}\r\n                      type=\"button\"\r\n                      onClick={() => {\r\n                        setGroupBy(g.id);\r\n                        if (macroId) navigate(\"/admin/macros\");\r\n                      }}\r\n                      className={`shrink-0 rounded-full border px-2.5 py-0.5 text-xs font-semibold ${\r\n                        groupBy === g.id ? \"border-[#2F1A55] bg-[#2F1A55] text-white\" : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n                      }`}\r\n                    >\r\n                      {g.label}\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            ) : null}\r\n            {showMacroWorkspace ? (\r\n              <div className=\"space-y-2\">\r\n                {workspaceLeftMacros.length ? (\r\n                  <div className=\"space-y-2\">\r\n                    {workspaceLeftMacros.map((macro, index) =>\r\n                      macroCard(\r\n                        macro,\r\n                        `left-workspace-${macro.id}`,\r\n                        groupBy === \"categoria\"\r\n                          ? {\r\n                              canMoveUp: index > 0,\r\n                              canMoveDown: index < workspaceLeftMacros.length - 1,\r\n                              position: index + 1,\r\n                              onMoveUp: () => moveMacroPriorityWithinList(workspaceLeftMacros, index, -1),\r\n                              onMoveDown: () => moveMacroPriorityWithinList(workspaceLeftMacros, index, 1),\r\n                            }\r\n                          : null,\r\n                        () => navigate(`/admin/macros/${macro.id}`),\r\n                        \"workspace-left\",\r\n                        macro.id === macroId\r\n                      )\r\n                    )}\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-white px-3 py-4 text-center text-xs text-slate-500\">\r\n                    No hay macros en este grupo.\r\n                  </div>\r\n                )}\r\n              </div>\r\n            ) : (\r\n              catalogGroups.map((group) => {\r\n                const isSelected = selectedGroup?.id === group.id;\r\n                return (\r\n                  <div\r\n                    key={`group-${groupBy}-${group.id}`}\r\n                    role=\"button\"\r\n                    tabIndex={0}\r\n                    onClick={() => setSelectedGroupKey(group.id)}\r\n                    onKeyDown={(event) => {\r\n                      if (event.key === \"Enter\" || event.key === \" \") {\r\n                        event.preventDefault();\r\n                        setSelectedGroupKey(group.id);\r\n                      }\r\n                    }}\r\n                    className={`rounded-2xl border px-4 py-3 text-left transition ${\r\n                      isSelected\r\n                        ? \"border-[#BFC7D1] bg-[#F7F2FF]\"\r\n                        : \"border-[#D1D5DB] bg-[#FCFBFF] hover:border-[#BFC7D1] hover:bg-[#F9F7FF]\"\r\n                    }`}\r\n                  >\r\n                    <div className=\"flex items-center justify-between gap-3\">\r\n                      <div className=\"min-w-0 flex-1\">\r\n                        <div className=\"flex flex-wrap items-center gap-2\">\r\n                          <span className=\"text-sm font-semibold text-[#2F1A55]\">{group.label}</span>\r\n                          {groupBy === \"categoria\" ? <span className=\"text-xs text-slate-400\">({group.code || group.id})</span> : null}\r\n                        </div>\r\n                        <div className=\"text-xs text-slate-500\">{group.description || \"Sin descripcion\"}</div>\r\n                      </div>\r\n                      <div className=\"text-right text-[11px] text-slate-600\">\r\n                        {groupBy === \"categoria\" ? (\r\n                          <div>\r\n                            <span className={`rounded-full border px-2 py-0.5 text-[11px] font-semibold ${categoryBadge(group.status)}`}>\r\n                              {group.status}\r\n                            </span>\r\n                          </div>\r\n                        ) : null}\r\n                        <div className={groupBy === \"categoria\" ? \"mt-1\" : \"\"}>\r\n                          Macros: <strong>{group.list.length}</strong>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                );\r\n              })\r\n            )}\r\n          </div>\r\n\r\n          <div className={`lg:col-span-7 ${showRightWorkspace ? \"lg:border-l lg:border-[#E9E2F7] lg:pl-4\" : \"\"}`}>\r\n            {showRightWorkspace ? (\r\n              macroId ? renderEdit(true) : renderInlineAddWorkspace()\r\n            ) : selectedGroup ? (\r\n              groupBy === \"estado\" ? (\r\n                selectedGroupFlatMacros.length ? (\r\n                  <div className=\"space-y-2\">\r\n                    {selectedGroupFlatMacros.map((macro) =>\r\n                      macroCard(\r\n                        macro,\r\n                        `right-flat-${macro.id}`,\r\n                        null,\r\n                        () => {\r\n                          setWorkspaceMacroSubgroup(null);\r\n                          navigate(`/admin/macros/${macro.id}`);\r\n                        }\r\n                      )\r\n                    )}\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-white px-3 py-5 text-center text-xs text-slate-500\">\r\n                    Sin macros para este grupo.\r\n                  </div>\r\n                )\r\n              ) : (\r\n                <div className=\"space-y-3\">\r\n                  {rightPanelGroupedMacros.length ? (\r\n                    rightPanelGroupedMacros.map((macroGroup) => {\r\n                      const groupUiKey = `right-${groupBy}-${selectedGroup.id}-${macroGroup.id}`;\r\n                      const collapsed = Boolean(collapsedMacroGroups[groupUiKey]);\r\n                      return (\r\n                        <div key={groupUiKey} className=\"rounded-xl border border-[#EFE9FA] bg-white px-3 py-2\">\r\n                          <div className=\"mb-2 flex items-center justify-between gap-2\">\r\n                            <div className=\"flex min-w-0 items-center gap-2\">\r\n                              <div className=\"truncate text-xs font-semibold text-[#2F1A55]\">{macroGroup.label}</div>\r\n                              <span className=\"text-xs text-slate-400\">({macroGroup.id})</span>\r\n                              {supportsGroupedActions ? (\r\n                                <button\r\n                                  type=\"button\"\r\n                                  onClick={() =>\r\n                                    openInlineAddMacro(\r\n                                      groupBy === \"categoria\"\r\n                                        ? {\r\n                                            title: `${selectedGroup?.label || \"categoría\"} / ${macroGroup.label}`,\r\n                                            category_id:\r\n                                              s(selectedGroup?.category_id) && s(selectedGroup?.category_id) !== \"general\"\r\n                                                ? s(selectedGroup?.category_id)\r\n                                                : \"\",\r\n                                            thread_status: macroGroup.id === \"sin_estado\" ? \"new\" : macroGroup.id,\r\n                                            audience_roles: [\"cliente\", \"negocio\"],\r\n                                            app_targets: arr(selectedGroup?.app_targets, appFilter !== \"all\" ? [appFilter] : [\"all\"]),\r\n                                            env_targets: [\"all\"],\r\n                                          }\r\n                                        : {\r\n                                            title: `${macroGroup.label} / ${selectedGroup?.label || \"rol\"}`,\r\n                                            category_id: s(macroGroup.category_id),\r\n                                            thread_status: \"new\",\r\n                                            audience_roles: [s(selectedGroup?.id)],\r\n                                            app_targets: arr(macroGroup.app_targets, appFilter !== \"all\" ? [appFilter] : [\"all\"]),\r\n                                            env_targets: [\"all\"],\r\n                                          }\r\n                                    )\r\n                                  }\r\n                                  className=\"inline-flex items-center gap-1 rounded-lg border border-[#E9E2F7] bg-white px-2 py-1 text-[10px] font-semibold text-[#5E30A5] hover:bg-[#F9F7FF]\"\r\n                                >\r\n                                  <Plus size={12} />\r\n                                  AÑADIR\r\n                                </button>\r\n                              ) : null}\r\n                            </div>\r\n                            {showCollapseToggle ? (\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() =>\r\n                                  setCollapsedMacroGroups((prev) => ({\r\n                                    ...prev,\r\n                                    [groupUiKey]: !prev[groupUiKey],\r\n                                  }))\r\n                                }\r\n                                className=\"inline-flex items-center justify-center p-0.5 text-slate-500 transition hover:text-[#5E30A5]\"\r\n                                aria-label={collapsed ? \"Expandir grupo\" : \"Contraer grupo\"}\r\n                                title={collapsed ? \"Expandir grupo\" : \"Contraer grupo\"}\r\n                              >\r\n                                {collapsed ? <ChevronDown size={16} /> : <ChevronUp size={16} />}\r\n                              </button>\r\n                            ) : null}\r\n                          </div>\r\n                          {!collapsed ? (\r\n                            <div className=\"space-y-2\">\r\n                              {macroGroup.list.map((macro, index) =>\r\n                                macroCard(\r\n                                  macro,\r\n                                  `right-${macroGroup.id}-${macro.id}`,\r\n                                  groupBy === \"categoria\"\r\n                                    ? {\r\n                                        canMoveUp: index > 0,\r\n                                        canMoveDown: index < macroGroup.list.length - 1,\r\n                                        position: index + 1,\r\n                                        onMoveUp: () => moveMacroPriorityWithinList(macroGroup.list, index, -1),\r\n                                        onMoveDown: () => moveMacroPriorityWithinList(macroGroup.list, index, 1),\r\n                                      }\r\n                                    : null,\r\n                                  () => {\r\n                                    setWorkspaceMacroSubgroup({ groupBy, subgroupId: macroGroup.id });\r\n                                    navigate(`/admin/macros/${macro.id}`);\r\n                                  }\r\n                                )\r\n                              )}\r\n                            </div>\r\n                          ) : null}\r\n                        </div>\r\n                      );\r\n                    })\r\n                  ) : (\r\n                    <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-white px-3 py-5 text-center text-xs text-slate-500\">\r\n                      Sin macros para este grupo.\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              )\r\n            ) : (\r\n              <div className=\"flex min-h-[320px] items-center justify-center rounded-2xl border border-dashed border-[#E9E2F7] bg-[#FCFBFF] px-4 text-center text-sm text-slate-500\">\r\n                Selecciona {selectionArticle} {selectionLabel} para ver los macros.\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </Card>\r\n    );\r\n  };\r\n\r\n  const renderAdd = () => (\r\n    <div className=\"space-y-5\">\r\n      <Card title=\"Añadir macro (draft)\" subtitle=\"Macro nueva lista para editar/publicar.\">\r\n        <form className=\"space-y-4\" onSubmit={submitCreateMacro}>\r\n          <input value={macroForm.title} onChange={(e) => setMacroForm((p) => ({ ...p, title: e.target.value }))} placeholder=\"titulo\" className=\"w-full rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\" />\r\n          <textarea rows={4} value={macroForm.body} onChange={(e) => setMacroForm((p) => ({ ...p, body: e.target.value }))} placeholder=\"body\" className=\"w-full resize-none rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\" />\r\n          <div className=\"grid gap-3 md:grid-cols-2\">\r\n            <select value={macroForm.category_id} onChange={(e) => setMacroForm((p) => ({ ...p, category_id: e.target.value }))} className=\"rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\">{categoryOptions.map((o) => <option key={o.id || \"general\"} value={o.id}>{o.label}</option>)}</select>\r\n            <select value={macroForm.thread_status} onChange={(e) => setMacroForm((p) => ({ ...p, thread_status: e.target.value }))} className=\"rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\">{THREAD_STATUS_ORDER.filter((st) => st !== \"sin_estado\").map((st) => <option key={st} value={st}>{THREAD_STATUS_LABEL[st]}</option>)}</select>\r\n          </div>\r\n          <TogglePills options={ROLE_OPTIONS} values={macroForm.audience_roles} onChange={(values) => setMacroForm((p) => ({ ...p, audience_roles: values }))} />\r\n          <TogglePills options={APP_OPTIONS} values={macroForm.app_targets} onChange={(values) => setMacroForm((p) => ({ ...p, app_targets: values }))} />\r\n          <TogglePills options={ENV_OPTIONS} values={macroForm.env_targets} onChange={(values) => setMacroForm((p) => ({ ...p, env_targets: values }))} />\r\n          <button type=\"submit\" disabled={saving} className={`inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-sm font-semibold text-white ${saving ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"}`}><Plus size={14} />Crear macro draft</button>\r\n        </form>\r\n      </Card>\r\n    </div>\r\n  );\r\n\r\n  const renderCategoryEdit = () => {\r\n    if (loading) return <Card title=\"Cargando...\" subtitle=\"Buscando categoria seleccionada.\" />;\r\n    if (!editingCategory) {\r\n      return (\r\n        <Card title=\"Categoria no encontrada\" subtitle=\"No existe en el catalogo actual.\">\r\n          <Link to=\"/admin/macros\" className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs font-semibold text-[#5E30A5]\">\r\n            <ArrowLeft size={14} />\r\n            Volver\r\n          </Link>\r\n        </Card>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <Card\r\n        title={`Editar categoria: ${editingCategory.label}`}\r\n        subtitle=\"Gestion completa de categoria con confirmacion de macros afectados.\"\r\n        headerRight={(\r\n          <Link to=\"/admin/macros\" className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs font-semibold text-[#5E30A5]\">\r\n            <ArrowLeft size={14} />\r\n            Volver\r\n          </Link>\r\n        )}\r\n      >\r\n        <form className=\"space-y-4\" onSubmit={submitSaveCategory}>\r\n          <div className=\"grid gap-3 md:grid-cols-2\">\r\n            <input value={categoryEditForm.code} readOnly className=\"rounded-xl border border-[#E9E2F7] bg-slate-100 px-3 py-2 text-sm text-slate-600\" />\r\n            <input value={categoryEditForm.label} onChange={(e) => setCategoryEditForm((p) => ({ ...p, label: e.target.value }))} placeholder=\"label\" className=\"rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\" />\r\n          </div>\r\n          <textarea rows={4} value={categoryEditForm.description} onChange={(e) => setCategoryEditForm((p) => ({ ...p, description: e.target.value }))} placeholder=\"descripcion\" className=\"w-full resize-none rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\" />\r\n          <div className=\"rounded-xl border border-[#E9E2F7] bg-[#FAF8FF] px-3 py-2 text-xs text-slate-600\">\r\n            Macros asociadas: <strong>{categoryMacros.length}</strong>\r\n          </div>\r\n          <TogglePills options={APP_OPTIONS} values={categoryEditForm.app_targets} onChange={(values) => setCategoryEditForm((p) => ({ ...p, app_targets: values }))} />\r\n          <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              <button type=\"button\" disabled={saving} onClick={() => triggerCategoryLifecycle(\"active\")} className=\"rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-xs font-semibold text-emerald-700\">Activar</button>\r\n              <button type=\"button\" disabled={saving} onClick={() => triggerCategoryLifecycle(\"inactive\")} className=\"rounded-xl border border-slate-300 bg-slate-100 px-3 py-2 text-xs font-semibold text-slate-700\">Inactivar</button>\r\n              <button type=\"button\" disabled={saving} onClick={removeCategory} className=\"inline-flex items-center gap-1 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-xs font-semibold text-red-700\"><Trash2 size={12} />Eliminar</button>\r\n            </div>\r\n            <button type=\"submit\" disabled={saving} className={`inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-sm font-semibold text-white ${saving ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"}`}><Save size={14} />Guardar cambios</button>\r\n          </div>\r\n        </form>\r\n      </Card>\r\n    );\r\n  };\r\n\r\n  const renderEdit = (workspace = false) => {\r\n    if (loading) {\r\n      return workspace ? (\r\n        <div className=\"px-1 py-0.5 text-sm font-semibold text-[#2F1A55]\">Cargando...</div>\r\n      ) : (\r\n        <Card title=\"Cargando...\" subtitle=\"Buscando macro seleccionada.\" />\r\n      );\r\n    }\r\n    if (!editing) {\r\n      if (workspace) {\r\n        return (\r\n          <div className=\"px-1 py-0.5 text-sm font-semibold text-[#2F1A55]\">\r\n            Macro no encontrada\r\n          </div>\r\n        );\r\n      }\r\n      return (\r\n        <Card title=\"Macro no encontrada\" subtitle=\"No existe en el catalogo actual.\">\r\n          <Link to=\"/admin/macros\" className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs font-semibold text-[#5E30A5]\">\r\n            <ArrowLeft size={14} />\r\n            Volver\r\n          </Link>\r\n        </Card>\r\n      );\r\n    }\r\n\r\n    const heading = (\r\n      <div className=\"flex items-center justify-between gap-3 px-1 py-0.5\">\r\n        <div className=\"text-sm font-semibold\">\r\n          <span className=\"text-[#2F1A55]\">Modo Edición</span>\r\n          <span className=\"ml-2 font-medium text-slate-500\">{s(editing.code, \"sin_code\")}</span>\r\n        </div>\r\n        <Link to=\"/admin/macros\" className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-1.5 text-xs font-semibold text-[#5E30A5]\">\r\n          <ArrowLeft size={14} />\r\n          Volver\r\n        </Link>\r\n      </div>\r\n    );\r\n\r\n    const form = (\n      <form className=\"space-y-4\" onSubmit={submitSaveMacro}>\n        <input value={editForm.title} onChange={(e) => setEditForm((p) => ({ ...p, title: e.target.value }))} placeholder=\"titulo\" className=\"w-full rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\" />\r\n        <textarea rows={5} value={editForm.body} onChange={(e) => setEditForm((p) => ({ ...p, body: e.target.value }))} placeholder=\"body\" className=\"w-full resize-none rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\" />\r\n        <div className=\"grid gap-3 md:grid-cols-2\">\r\n          <select value={editForm.category_id} onChange={(e) => setEditForm((p) => ({ ...p, category_id: e.target.value }))} className=\"rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\">{categoryOptions.map((o) => <option key={o.id || \"general\"} value={o.id}>{o.label}</option>)}</select>\r\n          <select value={editForm.thread_status} onChange={(e) => setEditForm((p) => ({ ...p, thread_status: e.target.value }))} className=\"rounded-xl border border-[#E9E2F7] px-3 py-2 text-sm\">{THREAD_STATUS_ORDER.filter((st) => st !== \"sin_estado\").map((st) => <option key={st} value={st}>{THREAD_STATUS_LABEL[st]}</option>)}</select>\r\n        </div>\r\n        <TogglePills options={ROLE_OPTIONS} values={editForm.audience_roles} onChange={(values) => setEditForm((p) => ({ ...p, audience_roles: values }))} />\n        <TogglePills options={APP_OPTIONS} values={editForm.app_targets} onChange={(values) => setEditForm((p) => ({ ...p, app_targets: values }))} />\n        <TogglePills options={ENV_OPTIONS} values={editForm.env_targets} onChange={(values) => setEditForm((p) => ({ ...p, env_targets: values }))} />\n        <div className=\"flex flex-wrap items-center justify-between gap-3\">\n          <div className=\"flex flex-wrap gap-2\">\n            <button type=\"button\" disabled={saving} onClick={() => setMacroLifecycle(\"draft\")} className=\"rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-xs font-semibold text-amber-700\">Pasar a draft</button>\n            <button\n              type=\"button\"\n              disabled={saving}\n              onClick={() => setMacroLifecycle(editing.status === \"published\" ? \"archived\" : \"published\")}\n              className={`rounded-xl px-3 py-2 text-xs font-semibold ${\n                editing.status === \"published\"\n                  ? \"border border-slate-300 bg-slate-100 text-slate-700\"\n                  : \"border border-emerald-200 bg-emerald-50 text-emerald-700\"\n              }`}\n            >\n              {editing.status === \"published\" ? \"Archivar\" : \"Publicar\"}\n            </button>\n            <button type=\"button\" disabled={saving} onClick={removeMacro} className=\"inline-flex items-center gap-1 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-xs font-semibold text-red-700\"><Trash2 size={12} />Eliminar</button>\n          </div>\n          <button type=\"submit\" disabled={saving} className={`inline-flex items-center gap-2 rounded-2xl px-4 py-2 text-sm font-semibold text-white ${saving ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"}`}><Save size={14} />Guardar cambios</button>\r\n        </div>\r\n      </form>\r\n    );\r\n\r\n    if (workspace) {\r\n      return (\r\n        <div className=\"space-y-3\">\r\n          {heading}\r\n          {form}\r\n        </div>\r\n      );\r\n    }\r\n\r\n    return (\r\n      <Card\r\n        title={`Modo Edición ${s(editing.code, \"sin_code\")}`}\r\n        headerRight={(\r\n          <Link to=\"/admin/macros\" className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs font-semibold text-[#5E30A5]\">\r\n            <ArrowLeft size={14} />\r\n            Volver\r\n          </Link>\r\n        )}\r\n      >\r\n        {form}\r\n      </Card>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <AdminLayout title=\"Macros\" subtitle=\"Catálogo operativo y CRUD desde panel admin\">\r\n      {hasPendingPriorityChanges || priorityFloatingMessage ? (\r\n        <div className=\"fixed left-1/2 top-0 z-40 -translate-x-1/2\">\r\n          <div className=\"flex items-center gap-2 rounded-b-2xl border-x border-b border-t-0 border-[#BCC5D1] bg-slate-100/92 px-3 py-2 shadow-lg backdrop-blur\">\r\n            <span className=\"text-xs font-semibold text-[#2F1A55]\">\r\n              {hasPendingPriorityChanges ? \"Cambios de prioridad pendientes\" : priorityFloatingMessage}\r\n            </span>\r\n            {hasPendingPriorityChanges ? (\r\n              <>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={applyPriorityChanges}\r\n                  disabled={saving}\r\n                  className={`rounded-xl px-3 py-1 text-xs font-semibold text-white ${saving ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"}`}\r\n                >\r\n                  Aplicar cambios\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={revertPriorityChanges}\r\n                  disabled={saving}\r\n                  className=\"rounded-xl border border-[#E9E2F7] bg-white px-3 py-1 text-xs font-semibold text-[#5E30A5]\"\r\n                >\r\n                  Revertir\r\n                </button>\r\n              </>\r\n            ) : null}\r\n          </div>\r\n        </div>\r\n      ) : null}\r\n      <div className=\"space-y-6\">\r\n        <div className=\"space-y-3\">\r\n          <div className=\"flex flex-wrap items-center justify-end gap-3\">\r\n            <button type=\"button\" onClick={() => load(true)} disabled={loading || refreshing || saving} className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs font-semibold text-[#5E30A5] disabled:opacity-60\"><RefreshCw size={14} className={loading || refreshing ? \"animate-spin\" : \"\"} />Refrescar</button>\r\n          </div>\r\n          {error ? <div className=\"rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-xs text-red-600\">{error}</div> : null}\r\n          {catalogHint ? <div className=\"rounded-xl border border-amber-100 bg-amber-50 px-3 py-2 text-xs text-amber-700\">{catalogHint}</div> : null}\r\n          {ok ? <div className=\"rounded-xl border border-emerald-100 bg-emerald-50 px-3 py-2 text-xs text-emerald-700\">{ok}</div> : null}\r\n        </div>\r\n        {categoryId ? renderCategoryEdit() : renderCatalog()}\r\n      </div>\r\n      {categoryConfirm.open ? (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/45 p-4\">\r\n          <div className=\"w-full max-w-2xl rounded-3xl border border-[#E9E2F7] bg-white p-5 shadow-2xl\">\r\n            <div className=\"space-y-2\">\r\n              <h3 className=\"text-sm font-semibold text-[#2F1A55]\">{categoryConfirm.title}</h3>\r\n              <p className=\"text-xs text-slate-600\">{categoryConfirm.message}</p>\r\n            </div>\r\n\r\n            <div className=\"mt-4 rounded-2xl border border-[#EFE9FA] bg-[#FCFBFF] p-3\">\r\n              <div className=\"text-xs font-semibold text-[#2F1A55]\">Macros afectados ({categoryConfirm.macros.length})</div>\r\n              <div className=\"mt-2 max-h-56 space-y-2 overflow-y-auto\">\r\n                {categoryConfirm.macros.length ? (\r\n                  categoryConfirm.macros.map((macro) => (\r\n                    <div key={`confirm-${macro.id}`} className=\"rounded-xl border border-[#EFE9FA] bg-white px-3 py-2 text-xs\">\r\n                      <div className=\"font-semibold text-[#2F1A55]\">{macro.title}</div>\r\n                      <div className=\"text-slate-500\">{macro.code} | {macro.status}</div>\r\n                    </div>\r\n                  ))\r\n                ) : (\r\n                  <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-white px-3 py-2 text-xs text-slate-500\">\r\n                    No hay macros asociados a esta categoria.\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-4 flex flex-wrap justify-end gap-2\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={closeCategoryConfirm}\r\n                disabled={saving}\r\n                className=\"rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5]\"\r\n              >\r\n                Cancelar\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                onClick={executeCategoryConfirm}\r\n                disabled={saving}\r\n                className={`rounded-xl px-3 py-2 text-xs font-semibold text-white ${saving ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"}`}\r\n              >\r\n                {categoryConfirm.confirmLabel || \"Confirmar\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : null}\r\n    </AdminLayout>\r\n  );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\support\\AdminSupportControlPanel.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'selectedTimeline' conditional could make the dependencies of useMemo Hook (at line 1219) change on every render. To fix this, wrap the initialization of 'selectedTimeline' in its own useMemo() Hook.","line":562,"column":9,"nodeType":"VariableDeclarator","endLine":562,"endColumn":77}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport {\r\n  AlertTriangle,\r\n  ArrowLeft,\r\n  ChevronDown,\r\n  ChevronUp,\r\n  CheckCircle2,\r\n  Clock3,\r\n  Layers3,\r\n  Pencil,\r\n  Plus,\r\n  RefreshCw,\r\n  Route,\r\n  Settings2,\r\n  ShieldAlert,\r\n  Trash2,\r\n  Users,\r\n  X,\r\n} from \"lucide-react\";\r\nimport { useLocation, useNavigate } from \"react-router-dom\";\r\nimport AdminLayout from \"../layout/AdminLayout\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport {\r\n  listSupportMacroCatalog,\r\n  createSupportMacroCategory,\r\n  deleteSupportMacroCategory,\r\n  setSupportMacroCategoryStatus,\r\n  updateSupportMacroCategory,\r\n} from \"./services/supportMacrosOpsService\";\r\n\r\nconst ACTIVE = [\"new\", \"assigned\", \"in_progress\", \"waiting_user\", \"queued\"];\r\nconst FLOW = [\"new\", \"assigned\", \"in_progress\", \"waiting_user\", \"queued\", \"closed\"];\r\nconst STATUS_LABEL = {\r\n  new: \"Nuevo\",\r\n  assigned: \"Asignado\",\r\n  in_progress: \"En progreso\",\r\n  waiting_user: \"Esperando usuario\",\r\n  queued: \"En cola\",\r\n  closed: \"Cerrado\",\r\n  cancelled: \"Cancelado\",\r\n};\r\nconst MACRO_STATUS_ORDER = [\"new\", \"assigned\", \"in_progress\", \"waiting_user\", \"queued\", \"closed\", \"cancelled\", \"sin_estado\"];\r\nconst MACRO_STATUS_LABEL = {\r\n  ...STATUS_LABEL,\r\n  sin_estado: \"Sin estado\",\r\n};\r\nconst CATALOG_GROUP_OPTIONS = [\r\n  { id: \"categoria\", label: \"categoría\" },\n  { id: \"estado\", label: \"estado\" },\r\n  { id: \"rol\", label: \"rol\" },\r\n];\r\nconst CATEGORY_STATUS_OPTIONS = [\"active\", \"inactive\"];\r\nconst CATEGORY_APP_OPTIONS = [\r\n  { id: \"all\", label: \"Todas\" },\r\n  { id: \"referidos_app\", label: \"PWA\" },\r\n  { id: \"prelaunch_web\", label: \"Prelaunch web\" },\r\n  { id: \"android_app\", label: \"Android app\" },\r\n];\r\nconst SEV_RANK = { s0: 0, s1: 1, s2: 2, s3: 3 };\r\nconst statusRank = (status) => {\r\n  const idx = MACRO_STATUS_ORDER.indexOf(status);\r\n  return idx === -1 ? MACRO_STATUS_ORDER.length + 1 : idx;\r\n};\r\nconst roleLabel = (role) => {\r\n  if (!role) return \"sin_rol\";\r\n  return role;\r\n};\r\nconst roleRank = (role) => {\r\n  const base = [\"cliente\", \"negocio\", \"soporte\", \"admin\", \"sin_rol\"];\r\n  const idx = base.indexOf(role);\r\n  return idx === -1 ? base.length + 1 : idx;\r\n};\r\nconst THREAD_STATUS_VALUES = [\"new\", \"assigned\", \"in_progress\", \"waiting_user\", \"queued\", \"closed\", \"cancelled\"];\nconst TERMINAL_THREAD_STATUSES = new Set([\"closed\", \"cancelled\"]);\nconst TIMELINE_DEFAULT_SEQUENCE = [\"new\", \"assigned\", \"in_progress\", \"closed\"];\nconst TIMELINE_RECOVERY_SEQUENCE = [\"queued\", \"assigned\", \"in_progress\", \"closed\"];\nconst TIMELINE_RELEASE_EVENT_TYPES = new Set([\"agent_timeout_release\", \"agent_manual_release\"]);\nconst TERMINAL_TIMELINE_STATUSES = new Set([\"closed\", \"cancelled\", \"released\"]);\nconst TIMELINE_BLOCK_LABELS = {\n  new: \"Creado\",\n  assigned: \"Asignado\",\n  in_progress: \"Resolviendo\",\n  waiting_user: \"Esperando usuario\",\n  queued: \"En cola\",\n  postponed: \"Pospuesto\",\n  released: \"Liberado\",\n  closed: \"Cerrado\",\n  cancelled: \"Cancelado\",\n};\nconst EVENT_TYPE_LABELS = {\r\n  created: \"created\",\r\n  assigned: \"assigned\",\r\n  status_changed: \"status_changed\",\r\n  waiting_user: \"waiting_user\",\r\n  resumed: \"resumed\",\r\n  queued: \"queued\",\r\n  closed: \"closed\",\r\n  note_added: \"note_added\",\r\n  agent_timeout_release: \"agent_timeout_release\",\r\n  agent_manual_release: \"agent_manual_release\",\r\n  cancelled: \"cancelled\",\r\n  linked_to_user: \"linked_to_user\",\r\n};\r\nconst TIMELINE_BLOCK_REACHED_CLASSES = {\n  new: \"bg-[#1D4ED8] text-white\",\n  assigned: \"bg-[#7C3AED] text-white\",\n  in_progress: \"bg-[#0891B2] text-white\",\n  waiting_user: \"bg-[#EA580C] text-white\",\n  queued: \"bg-[#4F46E5] text-white\",\n  postponed: \"bg-[#BE185D] text-white\",\n  released: \"bg-[#4B5563] text-white\",\n  closed: \"bg-[#15803D] text-white\",\n  cancelled: \"bg-[#B91C1C] text-white\",\n};\nconst normalizeThreadStatusCandidate = (value) => {\r\n  if (typeof value !== \"string\") return null;\r\n  const raw = value.trim().toLowerCase();\r\n  const compact = raw.replace(/[\\s-]+/g, \"_\");\r\n  const aliases = {\r\n    inprogress: \"in_progress\",\r\n    en_progreso: \"in_progress\",\r\n    resolviendo: \"in_progress\",\r\n    waitinguser: \"waiting_user\",\r\n    esperando_usuario: \"waiting_user\",\r\n    en_espera: \"waiting_user\",\r\n    en_cola: \"queued\",\r\n    cola: \"queued\",\r\n    cerrado: \"closed\",\r\n    cancelado: \"cancelled\",\r\n    asignado: \"assigned\",\r\n    nuevo: \"new\",\r\n  };\r\n  const normalized = aliases[compact] || compact;\r\n  return THREAD_STATUS_VALUES.includes(normalized) ? normalized : null;\r\n};\r\nconst deriveNextThreadStatusFromEvent = (event) => {\r\n  if (!event || typeof event !== \"object\") return null;\r\n  const type = typeof event.event_type === \"string\" ? event.event_type.trim().toLowerCase() : \"\";\r\n  if (!type) return null;\r\n  if (type === \"created\") return \"new\";\r\n  if (type === \"resumed\") return \"in_progress\";\r\n  if (type === \"agent_timeout_release\" || type === \"agent_manual_release\") return \"queued\";\r\n  const statusFromType = normalizeThreadStatusCandidate(type);\r\n  if (statusFromType) return statusFromType;\r\n  if (type !== \"status_changed\") return null;\r\n  const details = event.details && typeof event.details === \"object\" ? event.details : {};\r\n  const toStatus =\r\n    normalizeThreadStatusCandidate(details.to) ||\r\n    normalizeThreadStatusCandidate(details.next_status) ||\r\n    normalizeThreadStatusCandidate(details.to_status) ||\r\n    normalizeThreadStatusCandidate(details.status);\r\n  return toStatus;\n};\nconst getEventDetails = (event) => (\n  event && typeof event.details === \"object\" && !Array.isArray(event.details) ? event.details : {}\n);\nconst normalizeQueueKind = (value) => {\n  if (typeof value !== \"string\") return null;\n  const normalized = value.trim().toLowerCase().replace(/[\\s-]+/g, \"_\");\n  if (!normalized) return null;\n  if ([\"personal\", \"mine\", \"propia\", \"private\", \"postponed\", \"pospuesto\"].includes(normalized)) return \"personal\";\n  if ([\"general\", \"shared\", \"public\", \"global\"].includes(normalized)) return \"general\";\n  return null;\n};\nconst deriveQueueKindFromEvent = (event, thread) => {\n  const details = getEventDetails(event);\n  if (typeof details.personal_queue === \"boolean\") {\n    return details.personal_queue ? \"personal\" : \"general\";\n  }\n  const queueKind =\n    normalizeQueueKind(details.queue_kind) ||\n    normalizeQueueKind(details.queue_scope) ||\n    normalizeQueueKind(details.scope) ||\n    normalizeQueueKind(details.queue);\n  if (queueKind) return queueKind;\n  const eventType = typeof event?.event_type === \"string\" ? event.event_type.trim().toLowerCase() : \"\";\n  if (eventType === \"queued\" && thread?.status === \"queued\") {\n    if (thread.personal_queue === true || Boolean(thread.assigned_agent_id)) return \"personal\";\n  }\n  return \"general\";\n};\nconst statusToTimelineStatus = (status, queueKind = \"general\") => {\n  if (status !== \"queued\") return status;\n  return queueKind === \"personal\" ? \"postponed\" : \"queued\";\n};\nconst buildCollapsedResolvingLane = (segments) => {\n  const resolvingIndexes = [];\n  segments.forEach((segment, index) => {\n    if (segment.status === \"in_progress\") resolvingIndexes.push(index);\n  });\n  if (resolvingIndexes.length <= 1) {\n    return {\n      hasCollapsedResolving: false,\n      collapsedSegments: segments,\n      collapsedSegmentId: \"\",\n    };\n  }\n  const firstIndex = resolvingIndexes[0];\n  const lastIndex = resolvingIndexes[resolvingIndexes.length - 1];\n  if (lastIndex <= firstIndex) {\n    return {\n      hasCollapsedResolving: false,\n      collapsedSegments: segments,\n      collapsedSegmentId: \"\",\n    };\n  }\n  const groupedSegments = segments.slice(firstIndex, lastIndex + 1);\n  const collapsedId = `${segments[firstIndex].id}:collapsed_resolving:${segments[lastIndex].id}`;\n  const collapsedResolvingSegment = {\n    ...segments[firstIndex],\n    id: collapsedId,\n    endedAt: segments[lastIndex].endedAt || segments[firstIndex].endedAt || null,\n    events: groupedSegments.flatMap((segment) => segment.events || []),\n    isCollapsedResolving: true,\n  };\n  return {\n    hasCollapsedResolving: true,\n    collapsedSegments: [\n      ...segments.slice(0, firstIndex),\n      collapsedResolvingSegment,\n      ...segments.slice(lastIndex + 1),\n    ],\n    collapsedSegmentId: collapsedId,\n  };\n};\n\nconst fmt = (v) => {\n  if (!v) return \"-\";\r\n  const d = new Date(v);\r\n  if (Number.isNaN(d.getTime())) return \"-\";\r\n  return d.toLocaleString(\"es-EC\", { timeZone: \"America/Guayaquil\" });\r\n};\r\nconst mins = (a, b) => {\r\n  const x = new Date(a).getTime();\r\n  const y = new Date(b).getTime();\r\n  if (Number.isNaN(x) || Number.isNaN(y) || y < x) return null;\r\n  return Math.round((y - x) / 60000);\r\n};\r\nconst hoursAgo = (a) => {\r\n  const x = new Date(a).getTime();\r\n  if (Number.isNaN(x)) return null;\r\n  return (Date.now() - x) / 3600000;\r\n};\r\nconst avg = (arr) => (arr.length ? arr.reduce((s, n) => s + n, 0) / arr.length : null);\r\nconst short = (t, n = 130) => {\r\n  const s = typeof t === \"string\" ? t.trim() : \"\";\r\n  if (!s) return \"-\";\r\n  return s.length > n ? `${s.slice(0, n)}...` : s;\r\n};\r\nconst nameOf = (u) => {\r\n  if (!u) return \"Sin usuario\";\r\n  const full = `${u.nombre || \"\"} ${u.apellido || \"\"}`.trim();\r\n  return full || u.public_id || \"Sin nombre\";\r\n};\r\n\r\nfunction Metric({ title, value, hint, icon: Icon }) {\r\n  return (\r\n    <div className=\"rounded-2xl border border-[#E9E2F7] bg-white px-4 py-3\">\r\n      <div className=\"flex items-center justify-between text-xs uppercase tracking-[0.12em] text-slate-400\">\r\n        <span>{title}</span>\r\n        {Icon ? <Icon size={14} className=\"text-[#5E30A5]\" /> : null}\r\n      </div>\r\n      <div className=\"mt-2 text-xl font-extrabold text-[#2F1A55]\">{value}</div>\r\n      {hint ? <div className=\"mt-1 text-xs text-slate-500\">{hint}</div> : null}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction Card({ title, subtitle, headerRight, children }) {\r\n  const hasHeader = Boolean(title || subtitle || headerRight);\r\n  return (\r\n    <div className=\"rounded-3xl border border-[#E9E2F7] bg-white p-5 space-y-4\">\r\n      {hasHeader ? (\r\n        <div className=\"flex flex-wrap items-start justify-between gap-3\">\r\n          <div>\r\n            {title ? <div className=\"text-sm font-semibold text-[#2F1A55]\">{title}</div> : null}\r\n            {subtitle ? <div className=\"text-xs text-slate-500\">{subtitle}</div> : null}\r\n          </div>\r\n          {headerRight ? <div className=\"shrink-0\">{headerRight}</div> : null}\r\n        </div>\r\n      ) : null}\r\n      {children}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function AdminSupportControlPanel({\r\n  lockedPanel = null,\r\n  title = \"Soporte\",\r\n  subtitle = \"Panel de control de flujo de tickets\",\r\n}) {\r\n  const location = useLocation();\r\n  const navigate = useNavigate();\r\n  const [panel, setPanel] = useState(lockedPanel || \"tickets\");\r\n  const [viewByPanel, setViewByPanel] = useState({ tickets: \"basic\" });\r\n  const [ticketsTab, setTicketsTab] = useState(() => {\r\n    if (typeof window === \"undefined\") return \"analytics\";\r\n    const tab = new URLSearchParams(window.location.search).get(\"tab\");\r\n    return tab === \"categorias\" ? \"categorias\" : \"analytics\";\r\n  });\r\n  const [loading, setLoading] = useState(true);\r\n  const [refreshing, setRefreshing] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [categoryError, setCategoryError] = useState(\"\");\r\n  const [categoryOk, setCategoryOk] = useState(\"\");\r\n  const [categorySaving, setCategorySaving] = useState(false);\r\n  const [categoryEditId, setCategoryEditId] = useState(\"\");\r\n  const [categoryFormMode, setCategoryFormMode] = useState(\"\");\r\n  const [categoryForm, setCategoryForm] = useState({\r\n    label: \"\",\r\n    description: \"\",\r\n    app_targets: [\"all\"],\r\n    status: \"active\",\r\n  });\r\n  const [threads, setThreads] = useState([]);\r\n  const [events, setEvents] = useState([]);\r\n  const [inbox, setInbox] = useState([]);\r\n  const [macros, setMacros] = useState([]);\r\n  const [macroCategories, setMacroCategories] = useState([]);\r\n  const [usersById, setUsersById] = useState({});\r\n  const [selectedPublicId, setSelectedPublicId] = useState(null);\n  const [catalogGroupBy, setCatalogGroupBy] = useState(\"categoria\");\n  const [expandedCatalogGroups, setExpandedCatalogGroups] = useState({});\n  const [expandedTimelineThreadId, setExpandedTimelineThreadId] = useState(\"\");\n  const [expandedTimelineSegmentByThread, setExpandedTimelineSegmentByThread] = useState({});\n  const [expandedResolvingByLane, setExpandedResolvingByLane] = useState({});\n  const collapseResolvingTimersRef = useRef({});\n\r\n  const load = useCallback(async (manual = false) => {\r\n    if (manual) setRefreshing(true);\r\n    else setLoading(true);\r\n    setError(\"\");\r\n    try {\r\n      const opsCatalogPromise = listSupportMacroCatalog({\r\n        includeArchived: true,\r\n        includeDraft: true,\r\n      }).catch(() => null);\r\n\r\n      const [tRes, eRes, iRes, mRes, cRes, opsCatalog] = await Promise.all([\r\n        supabase\n          .from(\"support_threads\")\n          .select(\n            \"id, public_id, user_public_id, category, severity, status, summary, request_origin, origin_source, app_channel, created_at, updated_at, assigned_agent_id, personal_queue, closed_at, cancelled_at, resolution, root_cause, anon_profile_id\"\n          )\n          .order(\"created_at\", { ascending: false })\r\n          .limit(700),\r\n        supabase\r\n          .from(\"support_thread_events\")\r\n          .select(\"id, thread_id, event_type, actor_role, actor_id, details, created_at\")\r\n          .order(\"created_at\", { ascending: false })\r\n          .limit(3500),\r\n        supabase\r\n          .from(\"support_threads_inbox\")\r\n          .select(\"public_id, contact_display, anon_public_id\")\r\n          .order(\"created_at\", { ascending: false })\r\n          .limit(700),\r\n        supabase\r\n          .from(\"support_macros_cache\")\r\n          .select(\r\n            \"id, title, body, category_code, thread_status, audience_roles, status, app_targets, env_targets, sort_order, created_at\"\r\n          )\r\n          .order(\"sort_order\", { ascending: true })\r\n          .order(\"created_at\", { ascending: false })\r\n          .limit(600),\r\n        supabase\r\n          .from(\"support_macro_categories_cache\")\r\n          .select(\"id, code, label, description, status, sort_order, app_targets\")\r\n          .order(\"sort_order\", { ascending: true })\r\n          .order(\"created_at\", { ascending: false })\r\n          .limit(300),\r\n        opsCatalogPromise,\r\n      ]);\r\n\r\n      const nextThreads = (tRes.data || []).map((t) => ({\r\n        ...t,\r\n        request_origin: t.request_origin || \"registered\",\r\n        origin_source: t.origin_source || \"app\",\r\n        app_channel: t.app_channel || \"undetermined\",\r\n      }));\r\n      const nextEvents = eRes.data || [];\r\n      const nextInbox = iRes.data || [];\r\n      const nextMacros = (mRes.data || []).map((macro) => ({\r\n        id: macro.id,\r\n        title: macro.title,\r\n        body: macro.body,\r\n        category: macro.category_code || \"general\",\r\n        status: macro.thread_status || \"sin_estado\",\r\n        audience: macro.audience_roles || [\"cliente\", \"negocio\"],\r\n        active: macro.status === \"published\",\r\n        app_targets: macro.app_targets || [\"all\"],\r\n        env_targets: macro.env_targets || [\"all\"],\r\n        created_at: macro.created_at,\r\n      }));\r\n      const nextCategoriesFromCache = (cRes.data || []).map((category) => ({\r\n        id: category.code || category.id,\r\n        category_id: category.id,\r\n        code: category.code || category.id,\r\n        label: category.label || category.code || \"Sin label\",\r\n        description: category.description || \"\",\r\n        status: category.status || \"active\",\r\n        app_targets: Array.isArray(category.app_targets) && category.app_targets.length\r\n          ? category.app_targets\r\n          : [\"all\"],\r\n      }));\r\n      const nextCategoriesFromOps = (opsCatalog?.categories || []).map((category) => ({\r\n        id: category.code || category.id,\r\n        category_id: category.id,\r\n        code: category.code || category.id,\r\n        label: category.label || category.code || \"Sin label\",\r\n        description: category.description || \"\",\r\n        status: category.status || \"active\",\r\n        app_targets: Array.isArray(category.app_targets) && category.app_targets.length\r\n          ? category.app_targets\r\n          : [\"all\"],\r\n      }));\r\n      const nextCategories = nextCategoriesFromOps.length\r\n        ? nextCategoriesFromOps\r\n        : nextCategoriesFromCache;\r\n\r\n      const ids = Array.from(\r\n        new Set(\r\n          [\r\n            ...nextThreads.map((t) => t.assigned_agent_id),\r\n            ...nextEvents.map((e) => e.actor_id),\r\n          ].filter(Boolean)\r\n        )\r\n      );\r\n      let users = {};\r\n      if (ids.length) {\r\n        const uRes = await supabase\r\n          .from(\"usuarios\")\r\n          .select(\"id, nombre, apellido, public_id, role\")\r\n          .in(\"id\", ids);\r\n        users = (uRes.data || []).reduce((acc, u) => {\r\n          acc[u.id] = u;\r\n          return acc;\r\n        }, {});\r\n      }\r\n\r\n      if (tRes.error || eRes.error || mRes.error || iRes.error || cRes.error) {\r\n        setError(\r\n          tRes.error?.message ||\r\n          eRes.error?.message ||\r\n          mRes.error?.message ||\r\n          iRes.error?.message ||\r\n          cRes.error?.message ||\r\n          \"Error de carga\"\r\n        );\r\n      }\r\n\r\n      setThreads(nextThreads);\r\n      setEvents(nextEvents);\r\n      setInbox(nextInbox);\r\n      setMacros(nextMacros);\r\n      setMacroCategories(nextCategories);\r\n      setUsersById(users);\r\n    } catch (err) {\r\n      setError(err?.message || \"Error de carga\");\r\n    } finally {\r\n      setLoading(false);\r\n      setRefreshing(false);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\n    load(false);\n  }, [load]);\n\n  useEffect(() => {\n    setExpandedResolvingByLane({});\n    Object.values(collapseResolvingTimersRef.current).forEach((timerId) => {\n      if (timerId) clearTimeout(timerId);\n    });\n    collapseResolvingTimersRef.current = {};\n  }, [expandedTimelineThreadId]);\n\n  useEffect(\n    () => () => {\n      Object.values(collapseResolvingTimersRef.current).forEach((timerId) => {\n        if (timerId) clearTimeout(timerId);\n      });\n      collapseResolvingTimersRef.current = {};\n    },\n    []\n  );\n\r\n  const activePanel = lockedPanel || panel;\r\n  const view = viewByPanel[activePanel] || \"basic\";\r\n  const isCatalogLocked = lockedPanel === \"catalogo\";\r\n  const isTicketsLocked = lockedPanel === \"tickets\";\r\n\r\n  const resetCategoryForm = useCallback(() => {\r\n    setCategoryFormMode(\"\");\r\n    setCategoryEditId(\"\");\r\n    setCategoryForm({\r\n      label: \"\",\r\n      description: \"\",\r\n      app_targets: [\"all\"],\r\n      status: \"active\",\r\n    });\r\n  }, []);\r\n\r\n  const setTicketsTabWithUrl = useCallback(\r\n    (nextTab) => {\r\n      const normalized = nextTab === \"categorias\" ? \"categorias\" : \"analytics\";\r\n      setTicketsTab(normalized);\r\n      if (!isTicketsLocked) return;\r\n      const params = new URLSearchParams(location.search);\r\n      if (normalized === \"categorias\") params.set(\"tab\", \"categorias\");\r\n      else params.delete(\"tab\");\r\n      const nextSearch = params.toString();\r\n      navigate(\r\n        {\r\n          pathname: location.pathname,\r\n          search: nextSearch ? `?${nextSearch}` : \"\",\r\n        },\r\n        { replace: true }\r\n      );\r\n    },\r\n    [isTicketsLocked, location.pathname, location.search, navigate]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!isTicketsLocked) return;\r\n    const tab = new URLSearchParams(location.search).get(\"tab\");\r\n    setTicketsTab(tab === \"categorias\" ? \"categorias\" : \"analytics\");\r\n  }, [isTicketsLocked, location.search]);\r\n\r\n  const inboxByPublic = useMemo(\r\n    () => inbox.reduce((acc, r) => ((acc[r.public_id] = r), acc), {}),\r\n    [inbox]\r\n  );\r\n  const byPublic = useMemo(\r\n    () => threads.reduce((acc, t) => ((acc[t.public_id] = t), acc), {}),\r\n    [threads]\r\n  );\r\n  const eventsByThread = useMemo(() => {\r\n    const out = {};\r\n    events.forEach((e) => {\r\n      if (!e.thread_id) return;\r\n      if (!out[e.thread_id]) out[e.thread_id] = [];\r\n      out[e.thread_id].push(e);\r\n    });\r\n    Object.values(out).forEach((arr) =>\r\n      arr.sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())\r\n    );\r\n    return out;\r\n  }, [events]);\r\n\r\n  const activeTickets = useMemo(\r\n    () =>\r\n      threads\r\n        .filter((t) => ACTIVE.includes(t.status))\r\n        .sort((a, b) => {\r\n          const d = (SEV_RANK[a.severity] ?? 99) - (SEV_RANK[b.severity] ?? 99);\r\n          return d !== 0 ? d : new Date(a.created_at).getTime() - new Date(b.created_at).getTime();\r\n        }),\r\n    [threads]\r\n  );\r\n\r\n  const selected = selectedPublicId ? byPublic[selectedPublicId] : null;\r\n  const selectedTimeline = selected ? eventsByThread[selected.id] || [] : [];\r\n  const timelineRows = useMemo(() => {\n    const sortedThreads = [...threads].sort(\n      (a, b) => new Date(b.created_at || 0).getTime() - new Date(a.created_at || 0).getTime()\n    );\n    return sortedThreads.map((thread) => {\n      const orderedEvents = [...(eventsByThread[thread.id] || [])].sort(\n        (a, b) => new Date(a.created_at || 0).getTime() - new Date(b.created_at || 0).getTime()\n      );\n      const createSegment = (status, startedAt, isReached = true, queueKind = \"general\") => ({\n        id: \"\",\n        status,\n        label: TIMELINE_BLOCK_LABELS[status] || status,\n        startedAt: startedAt || null,\n        endedAt: null,\n        events: [],\n        isReached,\n        queueKind,\n      });\n      const lanes = [];\n      const createLane = (firstStatus, startedAt, queueKind = \"general\") => {\n        const lane = {\n          initialStatus: firstStatus,\n          queueKind,\n          segments: [createSegment(firstStatus, startedAt, true, queueKind)],\n        };\n        lanes.push(lane);\n        return lane;\n      };\n\n      let currentLane = createLane(\n        \"new\",\n        thread.created_at || thread.updated_at || new Date().toISOString(),\n        \"general\"\n      );\n      const getCurrentSegment = () => currentLane.segments[currentLane.segments.length - 1] || null;\n      const splitLaneToQueue = (transitionAt, queueKind = \"general\", eventForRelease = null) => {\n        const current = getCurrentSegment();\n        if (current) {\n          current.endedAt = current.endedAt || transitionAt;\n        }\n        const releaseSegment = createSegment(\"released\", transitionAt, true, queueKind);\n        if (eventForRelease) {\n          releaseSegment.events.push(eventForRelease);\n        }\n        releaseSegment.endedAt = transitionAt;\n        currentLane.segments.push(releaseSegment);\n        currentLane = createLane(statusToTimelineStatus(\"queued\", queueKind), transitionAt, queueKind);\n      };\n\n      orderedEvents.forEach((event) => {\n        const eventType = typeof event.event_type === \"string\" ? event.event_type.trim().toLowerCase() : \"\";\n        const transitionAt = event.created_at || thread.updated_at || thread.created_at || new Date().toISOString();\n        let current = getCurrentSegment();\n        if (!current) {\n          currentLane = createLane(\"new\", thread.created_at || transitionAt, \"general\");\n          current = getCurrentSegment();\n        }\n\n        if (TIMELINE_RELEASE_EVENT_TYPES.has(eventType)) {\n          splitLaneToQueue(transitionAt, \"general\", event);\n          return;\n        }\n\n        current.events.push(event);\n\n        const nextStatus = deriveNextThreadStatusFromEvent(event);\n        if (!nextStatus) return;\n\n        const queueKind = nextStatus === \"queued\" ? deriveQueueKindFromEvent(event, thread) : currentLane.queueKind;\n        const nextTimelineStatus = statusToTimelineStatus(nextStatus, queueKind);\n        if (!nextTimelineStatus || nextTimelineStatus === current.status) return;\n\n        if (nextStatus === \"queued\") {\n          splitLaneToQueue(transitionAt, queueKind, null);\n          return;\n        }\n\n        current.endedAt = current.endedAt || transitionAt;\n        currentLane.segments.push(createSegment(nextTimelineStatus, transitionAt, true, queueKind));\n      });\n\n      const currentThreadStatus = normalizeThreadStatusCandidate(thread.status);\n      if (currentThreadStatus) {\n        const currentQueueKind =\n          thread.personal_queue === true || Boolean(thread.assigned_agent_id) ? \"personal\" : \"general\";\n        const currentTimelineStatus = statusToTimelineStatus(currentThreadStatus, currentQueueKind);\n        const current = getCurrentSegment();\n        if (!current || currentTimelineStatus !== current.status) {\n          const transitionAt = thread.updated_at || thread.created_at || new Date().toISOString();\n          if (currentThreadStatus === \"queued\") {\n            splitLaneToQueue(transitionAt, currentQueueKind, null);\n          } else {\n            if (current) {\n              current.endedAt = current.endedAt || transitionAt;\n            }\n            currentLane.segments.push(\n              createSegment(\n                currentTimelineStatus,\n                transitionAt,\n                true,\n                currentQueueKind\n              )\n            );\n          }\n        }\n      }\n\n      const finalLanes = lanes.map((lane, laneIndex) => {\n        lane.segments.forEach((segment, index) => {\n          const next = lane.segments[index + 1];\n          if (!segment.endedAt && next?.startedAt) {\n            segment.endedAt = next.startedAt;\n            return;\n          }\n          if (!segment.endedAt && segment.status === \"closed\") {\n            segment.endedAt = thread.closed_at || thread.updated_at || segment.startedAt;\n            return;\n          }\n          if (!segment.endedAt && segment.status === \"cancelled\") {\n            segment.endedAt = thread.cancelled_at || thread.updated_at || segment.startedAt;\n            return;\n          }\n          if (!segment.endedAt && segment.status === \"released\") {\n            segment.endedAt = segment.startedAt || thread.updated_at || thread.created_at;\n          }\n        });\n\n        const reachedSegments = lane.segments.length\n          ? [...lane.segments]\n          : [createSegment(\"new\", thread.created_at || thread.updated_at || new Date().toISOString(), true, \"general\")];\n\n        const firstTerminalIndex = reachedSegments.findIndex((segment) =>\n          TERMINAL_TIMELINE_STATUSES.has(segment.status)\n        );\n        const trimmedReachedSegments =\n          firstTerminalIndex >= 0 ? reachedSegments.slice(0, firstTerminalIndex + 1) : reachedSegments;\n\n        const displaySegments = trimmedReachedSegments.length\n          ? [...trimmedReachedSegments]\n          : [createSegment(\"new\", thread.created_at || thread.updated_at || new Date().toISOString(), true, \"general\")];\n\n        const hasTerminal = displaySegments.some((segment) =>\n          TERMINAL_TIMELINE_STATUSES.has(segment.status)\n        );\n        if (!hasTerminal) {\n          const defaultSequence =\n            lane.initialStatus === \"queued\" || lane.initialStatus === \"postponed\"\n              ? TIMELINE_RECOVERY_SEQUENCE\n              : TIMELINE_DEFAULT_SEQUENCE;\n          const orderStatus = (status) => (status === \"postponed\" ? \"queued\" : status);\n          const reachedDefaultIndexes = displaySegments\n            .map((segment) => defaultSequence.indexOf(orderStatus(segment.status)))\n            .filter((idx) => idx >= 0);\n          const lastDefaultIndex = reachedDefaultIndexes.length ? Math.max(...reachedDefaultIndexes) : -1;\n          defaultSequence.slice(lastDefaultIndex + 1).forEach((status) => {\n            displaySegments.push(\n              createSegment(\n                statusToTimelineStatus(status, lane.queueKind || \"general\"),\n                null,\n                false,\n                lane.queueKind || \"general\"\n              )\n            );\n          });\n        }\n\n        return displaySegments.map((segment, segmentIndex) => ({\n          ...segment,\n          id: `${thread.id}:${laneIndex}:${segmentIndex}:${segment.status}:${segment.startedAt || \"pending\"}`,\n        }));\n      });\n\n      return {\n        threadId: thread.id,\n        threadPublicId: thread.public_id,\n        threadStatus: thread.status,\n        summary: thread.summary,\n        lanes: finalLanes,\n      };\n    });\n  }, [threads, eventsByThread]);\n\r\n  const metrics = useMemo(() => {\r\n    const closed = threads.filter((t) => t.status === \"closed\" && t.closed_at);\r\n    const cancelled = threads.filter((t) => t.status === \"cancelled\");\r\n\r\n    const firstResponse = [];\r\n    const queueToAssigned = [];\r\n    threads.forEach((t) => {\r\n      const tl = eventsByThread[t.id] || [];\r\n      const first = tl.find((e) =>\r\n        [\"assigned\", \"status_changed\", \"waiting_user\", \"resumed\", \"closed\"].includes(e.event_type)\r\n      );\r\n      const assigned = tl.find((e) => [\"assigned\", \"resumed\", \"status_changed\"].includes(e.event_type));\r\n      const a = first ? mins(t.created_at, first.created_at) : null;\r\n      const b = assigned ? mins(t.created_at, assigned.created_at) : null;\r\n      if (a != null) firstResponse.push(a);\r\n      if (b != null) queueToAssigned.push(b);\r\n    });\r\n\r\n    const resHours = closed\r\n      .map((t) => mins(t.created_at, t.closed_at))\r\n      .filter((v) => v != null)\r\n      .map((v) => v / 60);\r\n\r\n    const activeByAgent = {};\r\n    const closedByAgent7d = {};\r\n    activeTickets.forEach((t) => {\r\n      if (!t.assigned_agent_id) return;\r\n      activeByAgent[t.assigned_agent_id] = (activeByAgent[t.assigned_agent_id] || 0) + 1;\r\n    });\r\n    closed.forEach((t) => {\r\n      const closeTs = new Date(t.closed_at).getTime();\r\n      if (!t.assigned_agent_id || Number.isNaN(closeTs)) return;\r\n      if (closeTs >= Date.now() - 7 * 24 * 3600000) {\r\n        closedByAgent7d[t.assigned_agent_id] = (closedByAgent7d[t.assigned_agent_id] || 0) + 1;\r\n      }\r\n    });\r\n\r\n    const backlogCat = {};\r\n    const backlogSev = {};\r\n    activeTickets.forEach((t) => {\r\n      backlogCat[t.category] = (backlogCat[t.category] || 0) + 1;\r\n      backlogSev[t.severity] = (backlogSev[t.severity] || 0) + 1;\r\n    });\r\n\r\n    const resumed = new Set(events.filter((e) => e.event_type === \"resumed\").map((e) => e.thread_id));\r\n    const waiting = new Set(events.filter((e) => e.event_type === \"waiting_user\").map((e) => e.thread_id));\r\n    const forced = closed.filter((t) => {\r\n      const a = (t.resolution || \"\").toLowerCase();\r\n      const b = (t.root_cause || \"\").toLowerCase();\r\n      return a.includes(\"forzad\") || b.includes(\"forzad\") || b.includes(\"cierre_forzado\");\r\n    });\r\n    const stale = activeTickets.filter((t) => {\r\n      const h = hoursAgo(t.updated_at || t.created_at);\r\n      return h != null && h > 12;\r\n    });\r\n\r\n    const anonActive = activeTickets.filter((t) => t.request_origin === \"anonymous\");\r\n    const repeatedAnon = {};\r\n    anonActive.forEach((t) => {\r\n      const key = inboxByPublic[t.public_id]?.anon_public_id || inboxByPublic[t.public_id]?.contact_display;\r\n      if (!key) return;\r\n      repeatedAnon[key] = (repeatedAnon[key] || 0) + 1;\r\n    });\r\n    const cancelledByUser = {};\r\n    cancelled.forEach((t) => {\r\n      if (!t.user_public_id) return;\r\n      cancelledByUser[t.user_public_id] = (cancelledByUser[t.user_public_id] || 0) + 1;\r\n    });\r\n\r\n    const macrosByCat = {};\r\n    macros.forEach((m) => {\r\n      if (m.active === false) return;\r\n      const key = m.category || \"general\";\r\n      macrosByCat[key] = (macrosByCat[key] || 0) + 1;\r\n    });\r\n    const configCategories = [\r\n      {\r\n        id: \"general\",\r\n        label: \"General\",\r\n      },\r\n      ...macroCategories,\r\n    ];\r\n\r\n    const top = (obj, n = 6) =>\r\n      Object.entries(obj)\r\n        .sort((a, b) => b[1] - a[1])\r\n        .slice(0, n)\r\n        .map(([k, c]) => ({ key: k, count: c }));\r\n\r\n    return {\r\n      sla: {\r\n        first: avg(firstResponse),\r\n        queue: avg(queueToAssigned),\r\n        resolution: avg(resHours),\r\n        overdue: activeTickets.filter((t) => (hoursAgo(t.created_at) || 0) > 48).length,\r\n      },\r\n      workload: {\r\n        activeByAgent: top(activeByAgent).map((x) => ({ ...x, label: nameOf(usersById[x.key]) })),\r\n        closedByAgent: top(closedByAgent7d).map((x) => ({ ...x, label: nameOf(usersById[x.key]) })),\r\n      },\r\n      queue: {\r\n        active: activeTickets.length,\r\n        oldest: (() => {\r\n          const o = [...activeTickets]\r\n            .filter((t) => t.status === \"new\" || t.status === \"queued\")\r\n            .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())[0];\r\n          return o ? hoursAgo(o.created_at) : null;\r\n        })(),\r\n        byCat: top(backlogCat, 8),\r\n        bySev: top(backlogSev, 5),\r\n      },\r\n      quality: {\r\n        resumed: resumed.size,\r\n        waitingClosed: closed.filter((t) => waiting.has(t.id)).length,\r\n        forced: forced.length,\r\n        stale: stale.length,\r\n      },\r\n      risk: {\r\n        anonActive: anonActive.length,\r\n        repeatedAnon: top(repeatedAnon, 5),\r\n        cancelledByUser: top(cancelledByUser, 5),\r\n        cancelled: cancelled.length,\r\n      },\r\n      audit: events.slice(0, 25),\r\n      config: {\r\n        categories: configCategories.length,\r\n        macros: macros.filter((m) => m.active !== false).length,\r\n        categoriesNoMacro: configCategories.filter((c) => !macrosByCat[c.id]),\r\n      },\r\n    };\r\n  }, [threads, events, macros, activeTickets, usersById, eventsByThread, inboxByPublic, macroCategories]);\r\n\r\n  const catalogMacros = useMemo(\r\n    () =>\r\n      macros.map((m) => ({\r\n        ...m,\r\n        category: m.category || \"general\",\r\n        status: m.status || \"sin_estado\",\r\n      })),\r\n    [macros]\r\n  );\r\n\r\n  const categoriesStats = useMemo(() => {\r\n    const total = {};\r\n    const active = {};\r\n    const macroCount = {};\r\n    const macroByCategoryStatus = {};\r\n    const macroListByCategory = {};\r\n    const roleSetByCategory = {};\r\n\r\n    threads.forEach((t) => {\r\n      const key = t.category || \"general\";\r\n      total[key] = (total[key] || 0) + 1;\r\n    });\r\n    activeTickets.forEach((t) => {\r\n      const key = t.category || \"general\";\r\n      active[key] = (active[key] || 0) + 1;\r\n    });\r\n    catalogMacros.forEach((m) => {\r\n      const cat = m.category || \"general\";\r\n      const status = m.status || \"sin_estado\";\r\n      if (m.active !== false) {\r\n        macroCount[cat] = (macroCount[cat] || 0) + 1;\r\n      }\r\n      if (!macroByCategoryStatus[cat]) macroByCategoryStatus[cat] = {};\r\n      if (!macroByCategoryStatus[cat][status]) macroByCategoryStatus[cat][status] = [];\r\n      macroByCategoryStatus[cat][status].push(m);\r\n      if (!macroListByCategory[cat]) macroListByCategory[cat] = [];\r\n      macroListByCategory[cat].push(m);\r\n      if (!roleSetByCategory[cat]) roleSetByCategory[cat] = new Set();\r\n      const audiences = Array.isArray(m.audience) && m.audience.length ? m.audience : [\"sin_rol\"];\r\n      audiences.forEach((role) => roleSetByCategory[cat].add(roleLabel(role)));\r\n    });\r\n\r\n    const baseCategories = [\r\n      {\r\n        id: \"general\",\r\n        label: \"General\",\r\n        description: \"Consultas generales sin categoría especifica.\",\n        roles: [\"cliente\", \"negocio\"],\r\n      },\r\n      ...macroCategories,\r\n    ];\r\n    const known = new Set(baseCategories.map((c) => c.id));\r\n    const extraIds = Array.from(\r\n      new Set([...Object.keys(total), ...Object.keys(active), ...Object.keys(macroCount), ...Object.keys(macroByCategoryStatus)])\r\n    ).filter((id) => id && !known.has(id));\r\n    const extraCategories = extraIds.map((id) => ({\r\n      id,\r\n      label: id,\r\n      description: \"Categoría detectada en datos.\",\n      roles: [],\r\n    }));\r\n\r\n    return [...baseCategories, ...extraCategories].map((c) => ({\r\n      ...c,\r\n      total: total[c.id] || 0,\r\n      active: active[c.id] || 0,\r\n      macros: macroCount[c.id] || 0,\r\n      macrosByStatus: macroByCategoryStatus[c.id] || {},\r\n      macrosList: macroListByCategory[c.id] || [],\r\n      rolesWithMacros: Array.from(roleSetByCategory[c.id] || []).sort((a, b) => roleRank(a) - roleRank(b)),\r\n    }));\r\n  }, [threads, activeTickets, catalogMacros, macroCategories]);\r\n\r\n  const catalogMacroSummary = useMemo(() => {\r\n    const categoriesCovered = new Set(catalogMacros.map((m) => m.category || \"general\")).size;\r\n    return {\r\n      total: catalogMacros.length,\r\n      active: catalogMacros.filter((m) => m.active !== false).length,\r\n      covered: categoriesCovered,\r\n    };\r\n  }, [catalogMacros]);\r\n\r\n  const ticketCategoryRows = useMemo(() => {\r\n    const dynamic = [...macroCategories].sort((a, b) => {\r\n      const statusDiff = (String(a.status || \"inactive\") === \"active\" ? 0 : 1) - (String(b.status || \"inactive\") === \"active\" ? 0 : 1);\r\n      if (statusDiff !== 0) return statusDiff;\r\n      const aSort = Number(a.sort_order || 100);\r\n      const bSort = Number(b.sort_order || 100);\r\n      if (aSort !== bSort) return aSort - bSort;\r\n      return String(a.label || a.code || \"\").localeCompare(String(b.label || b.code || \"\"), \"es\", {\r\n        sensitivity: \"base\",\r\n      });\r\n    });\r\n\r\n    return dynamic.map((category) => ({\r\n      ...category,\r\n      readonly: false,\r\n    }));\r\n  }, [macroCategories]);\r\n\r\n  const editingCategory = useMemo(() => {\r\n    if (categoryFormMode !== \"edit\" || !categoryEditId) return null;\r\n    return ticketCategoryRows.find((category) => {\r\n      const currentId = String(category?.category_id || category?.id || \"\").trim();\r\n      return currentId && currentId === categoryEditId;\r\n    }) || null;\r\n  }, [categoryEditId, categoryFormMode, ticketCategoryRows]);\r\n\r\n  useEffect(() => {\r\n    if (categoryFormMode === \"edit\" && categoryEditId && !editingCategory) {\r\n      resetCategoryForm();\r\n    }\r\n  }, [categoryEditId, categoryFormMode, editingCategory, resetCategoryForm]);\r\n\r\n  const groupedByStatus = useMemo(() => {\r\n    const groups = {};\r\n    catalogMacros.forEach((m) => {\r\n      const status = m.status || \"sin_estado\";\r\n      if (!groups[status]) groups[status] = [];\r\n      groups[status].push(m);\r\n    });\r\n    return Object.entries(groups)\r\n      .sort((a, b) => {\r\n        const diff = statusRank(a[0]) - statusRank(b[0]);\r\n        return diff !== 0 ? diff : a[0].localeCompare(b[0]);\r\n      })\r\n      .map(([status, list]) => ({\r\n        id: status,\r\n        label: MACRO_STATUS_LABEL[status] || status,\r\n        list,\r\n      }));\r\n  }, [catalogMacros]);\r\n\r\n  const groupedByRole = useMemo(() => {\r\n    const groups = {};\r\n    catalogMacros.forEach((m) => {\r\n      const audiences = Array.isArray(m.audience) && m.audience.length ? m.audience : [\"sin_rol\"];\r\n      audiences.forEach((role) => {\r\n        const key = roleLabel(role);\r\n        if (!groups[key]) groups[key] = [];\r\n        groups[key].push(m);\r\n      });\r\n    });\r\n    return Object.entries(groups)\r\n      .sort((a, b) => {\r\n        const diff = roleRank(a[0]) - roleRank(b[0]);\r\n        return diff !== 0 ? diff : a[0].localeCompare(b[0]);\r\n      })\r\n      .map(([role, list]) => ({\r\n        id: role,\r\n        label: role,\r\n        list,\r\n      }));\r\n  }, [catalogMacros]);\r\n\r\n  const formatMacroRoles = useCallback((audience) => {\r\n    const roles = Array.isArray(audience) && audience.length ? audience.map((r) => roleLabel(r)) : [\"sin_rol\"];\r\n    return roles.join(\", \");\r\n  }, []);\r\n\r\n  const formatCategoryTargets = useCallback((targets) => {\r\n    const source = Array.isArray(targets) && targets.length ? targets : [\"all\"];\r\n    if (source.includes(\"all\")) return \"Todas\";\r\n    return source\r\n      .map((target) => CATEGORY_APP_OPTIONS.find((opt) => opt.id === target)?.label || target)\r\n      .join(\", \");\r\n  }, []);\r\n\r\n  const toggleCategoryTarget = useCallback((targetId) => {\r\n    setCategoryForm((prev) => {\r\n      const current = Array.isArray(prev.app_targets) && prev.app_targets.length\r\n        ? prev.app_targets\r\n        : [\"all\"];\r\n      if (targetId === \"all\") {\r\n        return {\r\n          ...prev,\r\n          app_targets: current.includes(\"all\") ? [\"referidos_app\"] : [\"all\"],\r\n        };\r\n      }\r\n      const withoutAll = current.filter((value) => value !== \"all\");\r\n      const hasTarget = withoutAll.includes(targetId);\r\n      const next = hasTarget\r\n        ? withoutAll.filter((value) => value !== targetId)\r\n        : [...withoutAll, targetId];\r\n      return {\r\n        ...prev,\r\n        app_targets: next.length ? next : [\"all\"],\r\n      };\r\n    });\r\n  }, []);\r\n\r\n  const beginEditCategory = useCallback((category) => {\r\n    const categoryId = String(category?.category_id || category?.id || \"\").trim();\r\n    if (!categoryId) return;\r\n    setCategoryFormMode(\"edit\");\r\n    setCategoryEditId(categoryId);\r\n    setCategoryForm({\r\n      label: String(category?.label || \"\").trim(),\r\n      description: String(category?.description || \"\").trim(),\r\n      app_targets:\r\n        Array.isArray(category?.app_targets) && category.app_targets.length\r\n          ? category.app_targets\r\n          : [\"all\"],\r\n      status: String(category?.status || \"active\").trim() || \"active\",\r\n    });\r\n    setCategoryError(\"\");\r\n    setCategoryOk(\"\");\r\n  }, []);\r\n\r\n  const openCreateCategory = useCallback(() => {\r\n    setCategoryFormMode(\"create\");\r\n    setCategoryEditId(\"\");\r\n    setCategoryForm({\r\n      label: \"\",\r\n      description: \"\",\r\n      app_targets: [\"all\"],\r\n      status: \"active\",\r\n    });\r\n    setCategoryError(\"\");\r\n    setCategoryOk(\"\");\r\n  }, []);\r\n\r\n  const submitCategory = useCallback(\r\n    async (event) => {\r\n      event.preventDefault();\r\n      const label = String(categoryForm.label || \"\").trim();\r\n      if (!label) {\r\n        setCategoryError(\"El label de categoría es requerido.\");\n        return;\r\n      }\r\n\r\n      setCategorySaving(true);\r\n      setCategoryError(\"\");\r\n      setCategoryOk(\"\");\r\n      try {\r\n        const payload = {\r\n          label,\r\n          description: String(categoryForm.description || \"\").trim(),\r\n          app_targets:\r\n            Array.isArray(categoryForm.app_targets) && categoryForm.app_targets.length\r\n              ? categoryForm.app_targets\r\n              : [\"all\"],\r\n        };\r\n\r\n        if (categoryEditId) {\r\n          await updateSupportMacroCategory({\r\n            category_id: categoryEditId,\r\n            ...payload,\r\n          });\r\n          setCategoryOk(\"Categoría actualizada.\");\n        } else {\r\n          await createSupportMacroCategory({\r\n            ...payload,\r\n            status: \"active\",\r\n          });\r\n          setCategoryOk(\"Categoría creada.\");\n        }\r\n        resetCategoryForm();\r\n        await load(true);\r\n      } catch (err) {\r\n        setCategoryError(err?.message || \"No se pudo guardar categoría.\");\n      } finally {\r\n        setCategorySaving(false);\r\n      }\r\n    },\r\n    [categoryEditId, categoryForm, load, resetCategoryForm]\r\n  );\r\n\r\n  const changeCategoryStatus = useCallback(\r\n    async (category, status) => {\r\n      const categoryId = String(category?.category_id || category?.id || \"\").trim();\r\n      if (!categoryId) return;\r\n      if (!CATEGORY_STATUS_OPTIONS.includes(status)) return;\r\n      if (status === \"inactive\") {\r\n        const categoryCode = String(category?.code || category?.id || \"\").trim();\r\n        const affectedCount = catalogMacros.filter((macro) => String(macro.category || \"general\").trim() === categoryCode).length;\r\n        const confirmed = globalThis.confirm(\r\n          `Inactivar categoría archivara macros asociados (${affectedCount}). Deseas continuar?`\n        );\r\n        if (!confirmed) return;\r\n      }\r\n      setCategorySaving(true);\r\n      setCategoryError(\"\");\r\n      setCategoryOk(\"\");\r\n      try {\r\n        await setSupportMacroCategoryStatus({ categoryId, status });\r\n        setCategoryOk(`Categoría movida a ${status}.`);\n        await load(true);\r\n      } catch (err) {\r\n        setCategoryError(err?.message || \"No se pudo cambiar estado de categoría.\");\n      } finally {\r\n        setCategorySaving(false);\r\n      }\r\n    },\r\n    [catalogMacros, load]\r\n  );\r\n\r\n  const removeCategory = useCallback(\r\n    async (category) => {\r\n      const categoryId = String(category?.category_id || category?.id || \"\").trim();\r\n      if (!categoryId) return;\r\n      const label = String(category?.label || category?.code || categoryId).trim();\r\n      const confirmed = globalThis.confirm(\r\n        `Eliminar categoría \"${label}\"? Esta accion elimina tambien sus macros asociados.`\n      );\r\n      if (!confirmed) return;\r\n\r\n      setCategorySaving(true);\r\n      setCategoryError(\"\");\r\n      setCategoryOk(\"\");\r\n      try {\r\n        await deleteSupportMacroCategory({ categoryId });\r\n        setCategoryOk(\"Categoría eliminada.\");\n        if (categoryEditId === categoryId) {\r\n          resetCategoryForm();\r\n        }\r\n        await load(true);\r\n      } catch (err) {\r\n        setCategoryError(err?.message || \"No se pudo eliminar categoría.\");\n      } finally {\r\n        setCategorySaving(false);\r\n      }\r\n    },\r\n    [categoryEditId, load, resetCategoryForm]\r\n  );\r\n\r\n  const visitedFlow = useMemo(() => {\r\n    if (!selected) return new Set();\r\n    const v = new Set([\"new\", selected.status]);\r\n    selectedTimeline.forEach((e) => {\r\n      if (FLOW.includes(e.event_type)) v.add(e.event_type);\r\n      if (e.event_type === \"resumed\") v.add(\"in_progress\");\r\n      if (e.event_type === \"waiting_user\") v.add(\"waiting_user\");\r\n      if (e.event_type === \"assigned\") v.add(\"assigned\");\r\n      if (e.event_type === \"queued\") v.add(\"queued\");\r\n      if (e.event_type === \"closed\") v.add(\"closed\");\r\n      if (e.event_type === \"status_changed\" && e.details && typeof e.details === \"object\") {\r\n        const ns = e.details.next_status || e.details.to_status || e.details.status;\r\n        if (typeof ns === \"string\") v.add(ns);\r\n      }\r\n    });\r\n    return v;\r\n  }, [selected, selectedTimeline]);\r\n\r\n  const renderAdvancedTickets = () => (\r\n    <div className=\"space-y-5\">\r\n      <Card\n        title=\"Flujo visual de tickets\"\n        subtitle=\"Click en un ticket para expandir su flujo por etapas y eventos.\"\n      >\n        {timelineRows.length === 0 ? (\r\n          <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-[#FCFBFF] px-3 py-4 text-center text-sm text-slate-500\">\r\n            Sin tickets para mostrar.\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\n            {timelineRows.map((row) => {\n              const isRowExpanded = expandedTimelineThreadId === row.threadId;\n              const expandedSegmentId = expandedTimelineSegmentByThread[row.threadId] || \"\";\n              const collapsedSegments = row.lanes.flatMap(\n                (laneSegments) => buildCollapsedResolvingLane(laneSegments).collapsedSegments\n              );\n              const expandedSegment =\n                row.lanes.flat().find((segment) => segment.id === expandedSegmentId) ||\n                collapsedSegments.find((segment) => segment.id === expandedSegmentId) ||\n                null;\n              const clearAllLaneCollapseTimers = () => {\n                Object.values(collapseResolvingTimersRef.current).forEach((timerId) => {\n                  if (timerId) clearTimeout(timerId);\n                });\n                collapseResolvingTimersRef.current = {};\n              };\n              const setLaneExpanded = (laneKey, value) => {\n                setExpandedResolvingByLane((prev) => {\n                  if (value) {\n                    const currentExpandedLane = Object.keys(prev).find((key) => !!prev[key]);\n                    if (currentExpandedLane === laneKey) return prev;\n                    return { [laneKey]: true };\n                  }\n                  if (!prev[laneKey]) return prev;\n                  const next = { ...prev };\n                  delete next[laneKey];\n                  return next;\n                });\n              };\n              const clearLaneCollapseTimer = (laneKey) => {\n                const timerId = collapseResolvingTimersRef.current[laneKey];\n                if (timerId) {\n                  clearTimeout(timerId);\n                  delete collapseResolvingTimersRef.current[laneKey];\n                }\n              };\n              const scheduleLaneCollapse = (laneKey) => {\n                clearLaneCollapseTimer(laneKey);\n                collapseResolvingTimersRef.current[laneKey] = setTimeout(() => {\n                  setLaneExpanded(laneKey, false);\n                  delete collapseResolvingTimersRef.current[laneKey];\n                }, 1000);\n              };\n              return (\n                <div key={`timeline-${row.threadId}`} className=\"rounded-2xl border border-[#E9E2F7] bg-[#FCFBFF] p-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() => {\n                      setExpandedTimelineThreadId((prev) => (prev === row.threadId ? \"\" : row.threadId));\n                      setExpandedTimelineSegmentByThread((prev) => ({\n                        ...prev,\n                        [row.threadId]: \"\",\n                      }));\n                    }}\n                    className=\"w-full text-left\"\n                  >\n                    <div className=\"flex items-center justify-between gap-3\">\n                      <div className=\"min-w-0\">\n                        <div className=\"text-xs font-semibold uppercase tracking-[0.12em] text-[#5E30A5]\">\n                          Ticket {row.threadPublicId}\n                        </div>\n                        <div className=\"mt-1 text-xs text-slate-500\">{short(row.summary, 120)}</div>\n                      </div>\n                      <div className=\"flex items-center gap-2 text-[11px] text-slate-500\">\n                        <span>Estado actual: {STATUS_LABEL[row.threadStatus] || row.threadStatus || \"-\"}</span>\n                        {isRowExpanded ? <ChevronUp size={15} /> : <ChevronDown size={15} />}\n                      </div>\n                    </div>\n                  </button>\n                  {isRowExpanded ? (\n                    <div className=\"mt-3 space-y-3\">\n                      {row.lanes.map((laneSegments, laneIndex) => (\n                        <div key={`${row.threadId}-lane-${laneIndex}`} className=\"overflow-x-auto pb-1\">\n                          {(() => {\n                            const laneKey = `${row.threadId}:${laneIndex}`;\n                            const compression = buildCollapsedResolvingLane(laneSegments);\n                            const isResolvingExpanded = !!expandedResolvingByLane[laneKey];\n                            const renderSegments =\n                              compression.hasCollapsedResolving && !isResolvingExpanded\n                                ? compression.collapsedSegments\n                                : laneSegments;\n                            return (\n                              <div\n                                className=\"flex min-w-max items-center\"\n                                onMouseEnter={() => {\n                                  if (isResolvingExpanded) clearLaneCollapseTimer(laneKey);\n                                }}\n                                onMouseLeave={() => {\n                                  if (compression.hasCollapsedResolving && isResolvingExpanded) {\n                                    scheduleLaneCollapse(laneKey);\n                                  }\n                                }}\n                              >\n                                {renderSegments.map((segment, segmentIndex) => {\n                                  const isFirstSegmentInLane = segmentIndex === 0;\n                                  const isExpanded = expandedSegmentId === segment.id;\n                                  const blockClipPath =\n                                    \"polygon(0 0, calc(100% - 14px) 0, 100% 50%, calc(100% - 14px) 100%, 0 100%)\";\n                                  const reachedClass =\n                                    TIMELINE_BLOCK_REACHED_CLASSES[segment.status] || \"bg-[#1E293B] text-white\";\n                                  const colorClass = segment.isReached\n                                    ? reachedClass\n                                    : \"bg-[#64748B] text-white\";\n                                  const isCollapsedResolving = Boolean(segment.isCollapsedResolving);\n                                  return (\n                                    <div\n                                      key={segment.id}\n                                      className={isFirstSegmentInLane ? \"overflow-hidden\" : \"\"}\n                                      style={{\n                                        marginLeft: isFirstSegmentInLane ? 0 : -18,\n                                        zIndex: renderSegments.length - segmentIndex,\n                                      }}\n                                    >\n                                      <button\n                                        type=\"button\"\n                                        onMouseEnter={() => {\n                                          if (isCollapsedResolving) {\n                                            clearAllLaneCollapseTimers();\n                                            setLaneExpanded(laneKey, true);\n                                          }\n                                        }}\n                                        onClick={(event) => {\n                                          event.stopPropagation();\n                                          setExpandedTimelineSegmentByThread((prev) => ({\n                                            ...prev,\n                                            [row.threadId]: prev[row.threadId] === segment.id ? \"\" : segment.id,\n                                          }));\n                                        }}\n                                        className={`relative h-12 min-w-[150px] overflow-hidden px-3 text-[12px] font-semibold transition ${colorClass} ${\n                                          isExpanded\n                                            ? \"ring-2 ring-[#5E30A5] ring-offset-1\"\n                                            : \"hover:brightness-[0.98]\"\n                                        }`}\n                                        style={{\n                                          clipPath: blockClipPath,\n                                        }}\n                                      >\n                                        <span className=\"pointer-events-none absolute inset-0 flex items-center justify-center text-center\">\n                                          {segment.label}\n                                        </span>\n                                        {isCollapsedResolving ? (\n                                          <span className=\"pointer-events-none absolute right-2 top-1/2 -translate-y-1/2\">\n                                            <svg\n                                              width=\"10\"\n                                              height=\"20\"\n                                              viewBox=\"0 0 10 20\"\n                                              fill=\"none\"\n                                              xmlns=\"http://www.w3.org/2000/svg\"\n                                              aria-hidden=\"true\"\n                                            >\n                                              <path\n                                                d=\"M0.8 2.4L4.2 10L0.8 17.6\"\n                                                stroke=\"white\"\n                                                strokeWidth=\"1.3\"\n                                                strokeLinecap=\"round\"\n                                                strokeLinejoin=\"round\"\n                                                vectorEffect=\"non-scaling-stroke\"\n                                              />\n                                              <path\n                                                d=\"M4.8 2.4L8.2 10L4.8 17.6\"\n                                                stroke=\"white\"\n                                                strokeWidth=\"1.3\"\n                                                strokeLinecap=\"round\"\n                                                strokeLinejoin=\"round\"\n                                                vectorEffect=\"non-scaling-stroke\"\n                                              />\n                                            </svg>\n                                          </span>\n                                        ) : null}\n                                      </button>\n                                    </div>\n                                  );\n                                })}\n                              </div>\n                            );\n                          })()}\n                        </div>\n                      ))}\n\n                      {expandedSegment ? (\n                        <div className=\"rounded-xl border border-[#E9E2F7] bg-white p-3\">\n                          <div className=\"flex flex-wrap items-center justify-between gap-2\">\n                            <div className=\"text-[11px] text-slate-500\">\n                              Inicio: {fmt(expandedSegment.startedAt)} | Fin: {expandedSegment.endedAt ? fmt(expandedSegment.endedAt) : \"-\"}\n                            </div>\n                            <button\n                              type=\"button\"\n                              onClick={() =>\n                                setExpandedTimelineSegmentByThread((prev) => ({\n                                  ...prev,\n                                  [row.threadId]: \"\",\n                                }))\n                              }\n                              className=\"h-6 w-6 rounded-md border border-[#E9E2F7] text-sm font-semibold text-slate-500 transition hover:bg-slate-50 hover:text-slate-700\"\n                              aria-label=\"Cerrar detalle de etapa\"\n                            >\n                              x\n                            </button>\n                          </div>\n                          <div className=\"mt-3 space-y-2\">\n                            {expandedSegment.events.length === 0 ? (\n                              <div className=\"rounded-lg border border-dashed border-[#E9E2F7] bg-[#FCFBFF] px-3 py-2 text-xs text-slate-500\">\n                                Sin eventos registrados en esta etapa.\n                              </div>\n                            ) : (\n                              expandedSegment.events.map((event, eventIndex) => (\n                                <div\n                                  key={`${event.id || expandedSegment.id}-event-${eventIndex}`}\n                                  className=\"rounded-lg border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-xs text-slate-600\"\n                                >\n                                  <div className=\"flex flex-wrap items-center justify-between gap-2\">\n                                    <div className=\"font-semibold text-[#2F1A55]\">\n                                      {EVENT_TYPE_LABELS[event.event_type] || event.event_type}\n                                    </div>\n                                    <div className=\"text-[11px] text-slate-400\">{fmt(event.created_at)}</div>\n                                  </div>\n                                  <div className=\"mt-1 text-[11px] text-slate-500\">\n                                    Actor: {nameOf(usersById[event.actor_id])}\n                                  </div>\n                                </div>\n                              ))\n                            )}\n                          </div>\n                        </div>\n                      ) : null}\n                    </div>\n                  ) : null}\n                </div>\n              );\n            })}\n          </div>\n        )}\r\n      </Card>\r\n\r\n      <Card title=\"SLA y tiempos\" subtitle=\"Tiempos de respuesta, cola y resolucion.\">\r\n        <div className=\"grid gap-3 md:grid-cols-4\">\r\n          <Metric\r\n            icon={Clock3}\r\n            title=\"1ra respuesta\"\r\n            value={metrics.sla.first == null ? \"-\" : `${Math.round(metrics.sla.first)}m`}\r\n          />\r\n          <Metric\r\n            icon={Route}\r\n            title=\"Cola -> asignacion\"\r\n            value={metrics.sla.queue == null ? \"-\" : `${Math.round(metrics.sla.queue)}m`}\r\n          />\r\n          <Metric\r\n            icon={CheckCircle2}\r\n            title=\"Resolucion promedio\"\r\n            value={metrics.sla.resolution == null ? \"-\" : `${metrics.sla.resolution.toFixed(1)}h`}\r\n          />\r\n          <Metric icon={AlertTriangle} title=\"Activos >48h\" value={metrics.sla.overdue} />\r\n        </div>\r\n      </Card>\r\n\r\n      <Card title=\"Carga por asesor\" subtitle=\"Distribucion activa y cierres ultimos 7 dias.\">\r\n        <div className=\"grid gap-4 lg:grid-cols-2\">\r\n          <div className=\"space-y-2\">\r\n            <div className=\"text-xs uppercase tracking-[0.12em] text-slate-400\">Activos</div>\r\n            {(metrics.workload.activeByAgent.length ? metrics.workload.activeByAgent : [{ key: \"-\", label: \"Sin datos\", count: 0 }]).map((r) => (\r\n              <div key={`a-${r.key}`} className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-sm text-slate-600\">\r\n                {r.label}: <strong>{r.count}</strong>\r\n              </div>\r\n            ))}\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            <div className=\"text-xs uppercase tracking-[0.12em] text-slate-400\">Cerrados 7d</div>\r\n            {(metrics.workload.closedByAgent.length ? metrics.workload.closedByAgent : [{ key: \"-\", label: \"Sin datos\", count: 0 }]).map((r) => (\r\n              <div key={`c-${r.key}`} className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-sm text-slate-600\">\r\n                {r.label}: <strong>{r.count}</strong>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      <Card title=\"Salud de cola\" subtitle=\"Backlog por categoría y severidad.\">\n        <div className=\"grid gap-3 md:grid-cols-3\">\r\n          <Metric icon={Layers3} title=\"Backlog activo\" value={metrics.queue.active} />\r\n          <Metric\r\n            icon={Clock3}\r\n            title=\"Cola mas antigua\"\r\n            value={metrics.queue.oldest == null ? \"-\" : `${metrics.queue.oldest.toFixed(1)}h`}\r\n          />\r\n          <Metric icon={Route} title=\"Categorías con backlog\" value={metrics.queue.byCat.length} />\n        </div>\r\n        <div className=\"grid gap-4 lg:grid-cols-2\">\r\n          <div className=\"space-y-2\">\r\n            {metrics.queue.byCat.map((r) => (\r\n              <div key={`bc-${r.key}`} className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-sm text-slate-600\">\r\n                {r.key}: <strong>{r.count}</strong>\r\n              </div>\r\n            ))}\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            {metrics.queue.bySev.map((r) => (\r\n              <div key={`bs-${r.key}`} className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-sm text-slate-600\">\r\n                {r.key}: <strong>{r.count}</strong>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n      <Card title=\"Calidad de atencion\" subtitle=\"Continuidad, cierres y tickets estancados.\">\r\n        <div className=\"grid gap-3 md:grid-cols-4\">\r\n          <Metric title=\"Reanudados\" value={metrics.quality.resumed} />\r\n          <Metric title=\"Waiting -> Closed\" value={metrics.quality.waitingClosed} />\r\n          <Metric title=\"Cierres forzados\" value={metrics.quality.forced} />\r\n          <Metric title=\"Activos sin mov. >12h\" value={metrics.quality.stale} />\r\n        </div>\r\n      </Card>\r\n\r\n      <Card title=\"Riesgo / abuso\" subtitle=\"Anonimos repetidos y cancelaciones.\">\r\n        <div className=\"grid gap-3 md:grid-cols-3\">\r\n          <Metric icon={ShieldAlert} title=\"Anonimos activos\" value={metrics.risk.anonActive} />\r\n          <Metric icon={AlertTriangle} title=\"Cancelados\" value={metrics.risk.cancelled} />\r\n          <Metric\r\n            icon={Users}\r\n            title=\"Top anonimos\"\r\n            value={metrics.risk.repeatedAnon.length === 0 ? \"Sin datos\" : metrics.risk.repeatedAnon.length}\r\n          />\r\n        </div>\r\n        <div className=\"grid gap-4 lg:grid-cols-2\">\r\n          <div className=\"space-y-2\">\r\n            {metrics.risk.repeatedAnon.length === 0 ? (\r\n              <div className=\"rounded-xl border border-dashed border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-sm text-slate-500\">\r\n                Sin datos\r\n              </div>\r\n            ) : (\r\n              metrics.risk.repeatedAnon.map((r) => (\r\n                <div key={`ra-${r.key}`} className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-sm text-slate-600\">\r\n                  {r.key}: <strong>{r.count}</strong>\r\n                </div>\r\n              ))\r\n            )}\r\n          </div>\r\n          <div className=\"space-y-2\">\r\n            {metrics.risk.cancelledByUser.map((r) => (\r\n              <div key={`cu-${r.key}`} className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-sm text-slate-600\">\r\n                {r.key}: <strong>{r.count}</strong>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </Card>\r\n\r\n    </div>\r\n  );\r\n\r\n  const renderTicketCategories = () => {\r\n    const isCategoryEditMode = categoryFormMode === \"edit\";\r\n    const isCategoryCreateMode = categoryFormMode === \"create\";\r\n    const isCategoryPanelOpen = isCategoryEditMode || isCategoryCreateMode;\r\n\r\n    return (\r\n      <div className=\"space-y-5\">\r\n        <Card\r\n          title=\"Categorías\"\r\n          subtitle=\"Gestion centralizada de categorías para tickets y macros.\"\r\n          headerRight={\r\n            !isCategoryPanelOpen ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={openCreateCategory}\r\n                className=\"rounded-2xl border border-dashed border-[#C9B6E8] bg-[#FCFBFF] px-4 py-3 text-left transition hover:bg-[#F9F7FF]\"\r\n              >\r\n                <div className=\"flex items-center gap-2 text-sm font-semibold text-[#5E30A5]\">\r\n                  <Plus size={14} />\r\n                  Añadir nueva categoría\n                </div>\r\n              </button>\r\n            ) : null\r\n          }\r\n        >\r\n          {categoryError ? (\r\n            <div className=\"rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-xs text-red-600\">\r\n              {categoryError}\r\n            </div>\r\n          ) : null}\r\n          {categoryOk ? (\r\n            <div className=\"rounded-xl border border-emerald-100 bg-emerald-50 px-3 py-2 text-xs text-emerald-700\">\r\n              {categoryOk}\r\n            </div>\r\n          ) : null}\r\n\r\n          <div className={isCategoryPanelOpen ? \"grid gap-4 lg:grid-cols-2\" : \"space-y-2\"}>\r\n            <div className=\"space-y-2\">\r\n              {isCategoryCreateMode ? (\r\n                <div className=\"rounded-2xl border border-[#C9B6E8] bg-[#FCFBFF] px-4 py-3\">\r\n                  <div className=\"min-w-0\">\r\n                    <div className=\"flex flex-wrap items-center gap-2\">\r\n                      <span className=\"text-sm font-semibold text-[#2F1A55]\">Nueva Categoría</span>\r\n                      <span className=\"rounded-full border border-[#E9E2F7] bg-[#FAF8FF] px-2 py-0.5 text-[11px] text-slate-600\">\r\n                        borrador\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"text-xs text-slate-500\">Crea una nueva categoría.</div>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                <>\r\n\r\n                  {ticketCategoryRows.map((category) => {\r\n                    const currentId = String(category?.category_id || category?.id || \"\").trim();\r\n                    const isSelected = isCategoryEditMode && currentId === categoryEditId;\r\n                    const canSelect = isCategoryEditMode && !category.readonly;\r\n                    return (\r\n                      <div\r\n                        key={`category-row-${category.code || category.id}`}\r\n                        role={canSelect ? \"button\" : undefined}\r\n                        tabIndex={canSelect ? 0 : undefined}\r\n                        onClick={canSelect ? () => beginEditCategory(category) : undefined}\r\n                        onKeyDown={\r\n                          canSelect\r\n                            ? (event) => {\r\n                                if (event.key === \"Enter\" || event.key === \" \") {\r\n                                  event.preventDefault();\r\n                                  beginEditCategory(category);\r\n                                }\r\n                              }\r\n                            : undefined\r\n                        }\r\n                        className={`rounded-2xl border bg-white px-4 py-3 ${\r\n                          isSelected ? \"border-[#C9B6E8] bg-[#FCFBFF]\" : \"border-[#E9E2F7]\"\r\n                        } ${canSelect ? \"cursor-pointer transition hover:bg-[#F9F7FF]\" : \"\"}`}\r\n                      >\r\n                        <div className=\"flex flex-wrap items-center justify-between gap-2\">\r\n                          <div className=\"min-w-0\">\r\n                            <div className=\"flex flex-wrap items-center gap-2\">\r\n                              <span className=\"text-sm font-semibold text-[#2F1A55]\">{category.label}</span>\r\n                              <span className=\"text-xs text-slate-400\">({category.code || category.id})</span>\r\n                              <span className=\"rounded-full border border-[#E9E2F7] bg-[#FAF8FF] px-2 py-0.5 text-[11px] text-slate-600\">\r\n                                {category.status}\r\n                              </span>\r\n                            </div>\r\n                            <div className=\"text-xs text-slate-500\">{category.description || \"Sin descripcion\"}</div>\r\n                            <div className=\"mt-1 text-[11px] text-slate-500\">Apps: {formatCategoryTargets(category.app_targets)}</div>\r\n                          </div>\r\n                          {!category.readonly && !isCategoryPanelOpen ? (\r\n                            <div className=\"flex flex-wrap gap-2\">\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() => beginEditCategory(category)}\r\n                                className=\"inline-flex items-center justify-center rounded-xl border border-[#E9E2F7] bg-white px-2 py-2 text-[#5E30A5]\"\r\n                                aria-label=\"Editar categoría\"\r\n                              >\r\n                                <Pencil size={14} />\r\n                              </button>\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() => changeCategoryStatus(category, category.status === \"active\" ? \"inactive\" : \"active\")}\r\n                                className={`rounded-full border px-3 py-2 text-xs font-semibold ${\r\n                                  category.status === \"active\"\r\n                                    ? \"border-slate-300 bg-slate-100 text-slate-700\"\r\n                                    : \"border-emerald-200 bg-emerald-50 text-emerald-700\"\r\n                                }`}\r\n                              >\r\n                                {category.status === \"active\" ? \"Desactivar\" : \"Activar\"}\r\n                              </button>\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() => removeCategory(category)}\r\n                                className=\"inline-flex items-center justify-center rounded-xl border border-red-200 bg-red-50 px-2 py-2 text-red-700\"\r\n                                aria-label=\"Eliminar categoría\"\r\n                              >\r\n                                <Trash2 size={14} />\r\n                              </button>\r\n                            </div>\r\n                          ) : null}\r\n                        </div>\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </>\r\n              )}\r\n            </div>\r\n\r\n            {isCategoryPanelOpen ? (\r\n              <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4\">\r\n                <div className=\"mb-3 flex items-center justify-between gap-2\">\r\n                  <div className=\"text-sm font-semibold text-[#2F1A55]\">\n                    {isCategoryEditMode ? \"Editar categoría\" : \"Nueva categoría\"}\n                    {isCategoryEditMode && editingCategory ? (\n                      <span className=\"ml-2 text-xs font-medium text-slate-500\">({editingCategory.code || editingCategory.id})</span>\n                    ) : null}\n                  </div>\n                  <button\r\n                    type=\"button\"\r\n                    onClick={resetCategoryForm}\r\n                    className=\"inline-flex items-center justify-center rounded-lg border border-[#E9E2F7] bg-white p-1.5 text-[#5E30A5]\"\r\n                    aria-label=\"Cerrar panel de categoría\"\r\n                  >\r\n                    <X size={14} />\r\n                  </button>\r\n                </div>\r\n\r\n                {isCategoryEditMode && !editingCategory ? (\r\n                  <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-white px-3 py-4 text-center text-xs text-slate-500\">\r\n                    Categoría no encontrada para edicion.\r\n                  </div>\r\n                ) : (\r\n                  <form className=\"space-y-3\" onSubmit={submitCategory}>\r\n                    <div className=\"grid gap-3 md:grid-cols-[minmax(0,1fr)_auto]\">\r\n                      <input\r\n                        value={categoryForm.label}\r\n                        onChange={(event) =>\r\n                          setCategoryForm((prev) => ({\r\n                            ...prev,\r\n                            label: event.target.value,\r\n                          }))\r\n                        }\r\n                        placeholder=\"Label categoría\"\r\n                        className=\"w-full rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs\"\r\n                      />\r\n                      {isCategoryEditMode && editingCategory ? (\r\n                        <div className=\"flex items-center justify-end gap-2\">\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              changeCategoryStatus(\r\n                                editingCategory,\r\n                                editingCategory.status === \"active\" ? \"inactive\" : \"active\"\r\n                              )\r\n                            }\r\n                            className={`rounded-full border px-3 py-2 text-xs font-semibold ${\r\n                              editingCategory.status === \"active\"\r\n                                ? \"border-slate-300 bg-slate-100 text-slate-700\"\r\n                                : \"border-emerald-200 bg-emerald-50 text-emerald-700\"\r\n                            }`}\r\n                          >\r\n                            {editingCategory.status === \"active\" ? \"Desactivar\" : \"Activar\"}\r\n                          </button>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => removeCategory(editingCategory)}\r\n                            className=\"inline-flex items-center justify-center rounded-xl border border-red-200 bg-red-50 p-2 text-red-700\"\r\n                            aria-label=\"Eliminar categoría\"\r\n                          >\r\n                            <Trash2 size={14} />\r\n                          </button>\r\n                        </div>\r\n                      ) : null}\r\n                    </div>\r\n                    <textarea\r\n                      rows={3}\r\n                      value={categoryForm.description}\r\n                      onChange={(event) =>\r\n                        setCategoryForm((prev) => ({\r\n                          ...prev,\r\n                          description: event.target.value,\r\n                        }))\r\n                      }\r\n                      placeholder=\"Descripcion\"\r\n                      className=\"w-full resize-none rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs\"\r\n                    />\r\n                    <div className=\"flex flex-wrap gap-2\">\r\n                      {CATEGORY_APP_OPTIONS.map((appOption) => {\r\n                        const active = (categoryForm.app_targets || []).includes(appOption.id);\r\n                        return (\r\n                          <button\r\n                            key={`category-editor-target-${appOption.id}`}\r\n                            type=\"button\"\r\n                            onClick={() => toggleCategoryTarget(appOption.id)}\r\n                            className={`rounded-full border px-3 py-1 text-[11px] font-semibold ${\r\n                              active\r\n                                ? \"border-[#2F1A55] bg-[#2F1A55] text-white\"\r\n                                : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n                            }`}\r\n                          >\r\n                            {appOption.label}\r\n                          </button>\r\n                        );\r\n                      })}\r\n                    </div>\r\n\r\n                    <div className=\"flex justify-end\">\r\n                      <button\r\n                        type=\"submit\"\r\n                        disabled={categorySaving}\r\n                        className={`rounded-xl px-3 py-2 text-xs font-semibold text-white ${\r\n                          categorySaving ? \"bg-[#C9B6E8]\" : \"bg-[#5E30A5]\"\r\n                        }`}\r\n                      >\r\n                        {isCategoryEditMode ? \"Guardar categoría\" : \"Crear categoría\"}\r\n                      </button>\r\n                    </div>\r\n                  </form>\r\n                )}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        </Card>\r\n      </div>\r\n    );\r\n  };\r\n  const renderCatalogMacroCard = (m, key) => (\r\n    <div\r\n      key={key}\r\n      className=\"rounded-lg border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2\"\r\n    >\r\n      <div className=\"flex flex-wrap items-center justify-between gap-2 text-xs\">\r\n        <div className=\"font-semibold text-[#2F1A55]\">{m.title}</div>\r\n        <div className=\"text-slate-500\">{m.active === false ? \"Inactiva\" : \"Activa\"}</div>\r\n      </div>\r\n      <div className=\"mt-1 text-[11px] text-slate-500\">\r\n        Categoría: {m.category || \"general\"} | Estado: {m.status || \"sin_estado\"} | Roles: {formatMacroRoles(m.audience)}\r\n      </div>\r\n      <div className=\"mt-1 text-xs text-slate-600\">{short(m.body, 220)}</div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <AdminLayout title={title} subtitle={subtitle}>\r\n      <div className=\"space-y-6\">\r\n        {isCatalogLocked ? (\r\n          <div className=\"space-y-3\">\r\n            <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {[\r\n                  { id: \"basic\", label: \"Basica\" },\r\n                  { id: \"advanced\", label: \"Avanzada\" },\r\n                ].map((v) => (\r\n                  <button\r\n                    key={v.id}\r\n                    type=\"button\"\r\n                    onClick={() =>\r\n                      setViewByPanel((prev) => ({\r\n                        ...prev,\r\n                        [activePanel]: v.id,\r\n                      }))\r\n                    }\r\n                    className={`rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                      view === v.id\r\n                        ? \"border-[#2F1A55] bg-[#2F1A55] text-white\"\r\n                        : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n                    }`}\r\n                  >\r\n                    {v.label}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => load(true)}\r\n                disabled={loading || refreshing}\r\n                aria-label=\"Refrescar\"\r\n                className=\"inline-flex h-9 w-9 items-center justify-center rounded-xl border border-[#E9E2F7] text-[#5E30A5] disabled:opacity-60\"\r\n              >\r\n                <RefreshCw size={14} className={loading || refreshing ? \"animate-spin\" : \"\"} />\r\n              </button>\r\n            </div>\r\n            {error ? (\r\n              <div className=\"rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-xs text-red-600\">\r\n                {error}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n        ) : (\r\n          <Card\r\n            title={lockedPanel === \"tickets\" ? null : \"Control de tickets\"}\r\n            subtitle={\r\n              lockedPanel === \"tickets\"\r\n                ? null\r\n                : isTicketsLocked\r\n                  ? \"Vista unica con Analytics y Categorías.\"\r\n                  : \"Vista basica (default) y avanzada.\"\r\n            }\r\n          >\r\n            <div className=\"flex flex-wrap items-center justify-between gap-3\">\r\n              <div className=\"flex flex-wrap items-center gap-2\">\r\n                {lockedPanel ? null : (\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {[{ id: \"tickets\", label: \"Panel Tickets\" }].map((p) => (\r\n                      <button\r\n                        key={p.id}\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                          setPanel(p.id);\r\n                          setSelectedPublicId(null);\r\n                        }}\r\n                        className={`rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                          activePanel === p.id\r\n                            ? \"border-[#5E30A5] bg-[#5E30A5] text-white\"\r\n                            : \"border-[#E9E2F7] bg-white text-[#5E30A5]\"\r\n                        }`}\r\n                      >\r\n                        {p.label}\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n                {isTicketsLocked ? (\r\n                  <>\r\n                    {[\r\n                      { id: \"analytics\", label: \"Analytics\" },\r\n                      { id: \"categorias\", label: \"Categorías\" },\r\n                    ].map((tabOption) => (\r\n                      <button\r\n                        key={tabOption.id}\r\n                        type=\"button\"\r\n                        onClick={() => setTicketsTabWithUrl(tabOption.id)}\r\n                        className={`rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                          ticketsTab === tabOption.id\r\n                            ? \"border-[#2F1A55] bg-[#2F1A55] text-white\"\r\n                            : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n                        }`}\r\n                      >\r\n                        {tabOption.label}\r\n                      </button>\r\n                    ))}\r\n                  </>\r\n                ) : null}\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => load(true)}\r\n                disabled={loading || refreshing}\r\n                className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] px-3 py-2 text-xs font-semibold text-[#5E30A5] disabled:opacity-60\"\r\n              >\r\n                <RefreshCw size={14} className={loading || refreshing ? \"animate-spin\" : \"\"} />\r\n                Refrescar\r\n              </button>\r\n            </div>\r\n            {isTicketsLocked ? null : (\r\n              <div className=\"flex flex-wrap gap-2\">\r\n                {[\r\n                  { id: \"basic\", label: \"Basica\" },\r\n                  { id: \"advanced\", label: \"Avanzada\" },\r\n                ].map((v) => (\r\n                  <button\r\n                    key={v.id}\r\n                    type=\"button\"\r\n                    onClick={() =>\r\n                      setViewByPanel((prev) => ({\r\n                        ...prev,\r\n                        [activePanel]: v.id,\r\n                      }))\r\n                    }\r\n                    className={`rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                      view === v.id\r\n                        ? \"border-[#2F1A55] bg-[#2F1A55] text-white\"\r\n                        : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n                    }`}\r\n                  >\r\n                    {v.label}\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            )}\r\n            {error ? (\r\n              <div className=\"rounded-xl border border-red-100 bg-red-50 px-3 py-2 text-xs text-red-600\">\r\n                {error}\r\n              </div>\r\n            ) : null}\r\n          </Card>\r\n        )}\r\n\r\n        {loading ? (\r\n          <Card title=\"Cargando...\" subtitle=\"Obteniendo datos de soporte.\" />\r\n        ) : isTicketsLocked ? (\r\n          ticketsTab === \"categorias\" ? renderTicketCategories() : renderAdvancedTickets()\r\n        ) : activePanel === \"tickets\" ? (\r\n          selected ? (\r\n            <div className=\"space-y-5\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setSelectedPublicId(null)}\r\n                className=\"inline-flex items-center gap-2 rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5]\"\r\n              >\r\n                <ArrowLeft size={14} />\r\n                Volver a tickets activos\r\n              </button>\r\n              <Card\r\n                title={`Flujo de ticket ${selected.public_id}`}\r\n                subtitle=\"Pasos completados, paso actual y pendientes.\"\r\n              >\r\n                <div className=\"grid gap-3 md:grid-cols-2 text-xs text-slate-600\">\r\n                  <div className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2\">\r\n                    <div className=\"font-semibold text-[#2F1A55]\">{short(selected.summary, 160)}</div>\r\n                    <div>Categoría: {selected.category} | Severidad: {selected.severity}</div>\r\n                    <div>Estado: {STATUS_LABEL[selected.status] || selected.status}</div>\r\n                    <div>Creado: {fmt(selected.created_at)}</div>\r\n                  </div>\r\n                  <div className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2\">\r\n                    <div>Asesor: {selected.assigned_agent_id ? nameOf(usersById[selected.assigned_agent_id]) : \"Sin asignar\"}</div>\r\n                    <div>Origen: {selected.request_origin || \"registered\"} / {selected.origin_source || \"app\"}</div>\r\n                    <div>Contacto: {inboxByPublic[selected.public_id]?.contact_display || \"-\"}</div>\r\n                    <div>Actualizado: {fmt(selected.updated_at)}</div>\r\n                  </div>\r\n                </div>\r\n                <div className=\"overflow-x-auto pb-2\">\r\n                  <div className=\"flex min-w-max items-center gap-2\">\r\n                    {FLOW.map((step, idx) => {\r\n                      const current = selected.status === step;\r\n                      const done = !current && visitedFlow.has(step);\r\n                      return (\r\n                        <React.Fragment key={step}>\r\n                          <div className={`rounded-full border px-3 py-1 text-xs font-semibold ${\r\n                            current\r\n                              ? \"border-[#5E30A5] bg-[#5E30A5] text-white\"\r\n                              : done\r\n                                ? \"border-[#1B7F4B] bg-[#EAF7F0] text-[#1B7F4B]\"\r\n                                : \"border-[#E2E8F0] bg-[#F8FAFC] text-slate-400\"\r\n                          }`}>\r\n                            {STATUS_LABEL[step]}\r\n                          </div>\r\n                          {idx < FLOW.length - 1 ? (\r\n                            <div className={`h-[2px] w-8 ${done || current ? \"bg-[#5E30A5]\" : \"bg-[#E2E8F0]\"}`} />\r\n                          ) : null}\r\n                        </React.Fragment>\r\n                      );\r\n                    })}\r\n                  </div>\r\n                </div>\r\n              </Card>\r\n              <Card title=\"Timeline\" subtitle=\"Eventos del ticket en orden temporal.\">\r\n                <div className=\"space-y-2\">\r\n                  {[...selectedTimeline].reverse().map((e) => (\r\n                    <div key={e.id} className=\"rounded-xl border border-[#EFE9FA] bg-[#FCFBFF] px-3 py-2 text-xs text-slate-600\">\r\n                      <div className=\"flex items-center justify-between gap-2\">\r\n                        <div className=\"font-semibold text-[#2F1A55]\">{e.event_type}</div>\r\n                        <div className=\"text-slate-400\">{fmt(e.created_at)}</div>\r\n                      </div>\r\n                      <div>Actor: {e.actor_role || \"-\"} / {nameOf(usersById[e.actor_id])}</div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </Card>\r\n            </div>\r\n          ) : (\r\n            <Card\r\n              title=\"Tickets activos\"\r\n              subtitle=\"Lista de cards horizontales. Click para abrir flujo visual.\"\r\n            >\r\n              <div className=\"grid gap-3 md:grid-cols-4\">\r\n                <Metric icon={Layers3} title=\"Activos\" value={activeTickets.length} />\r\n                <Metric icon={Clock3} title=\"En cola\" value={activeTickets.filter((t) => t.status === \"queued\").length} />\r\n                <Metric icon={Users} title=\"Sin asignar\" value={activeTickets.filter((t) => !t.assigned_agent_id).length} />\r\n                <Metric icon={AlertTriangle} title=\">48h\" value={activeTickets.filter((t) => (hoursAgo(t.created_at) || 0) > 48).length} />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                {activeTickets.map((t) => (\r\n                  <button\r\n                    key={t.public_id}\r\n                    type=\"button\"\r\n                    onClick={() => setSelectedPublicId(t.public_id)}\r\n                    className=\"w-full rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] px-4 py-3 text-left hover:border-[#CDBAF1]\"\r\n                  >\r\n                    <div className=\"flex flex-col gap-2 md:flex-row md:items-center md:justify-between\">\r\n                      <div>\r\n                        <div className=\"text-[11px] uppercase tracking-[0.12em] text-slate-400\">{t.public_id}</div>\r\n                        <div className=\"text-sm font-semibold text-[#2F1A55]\">{short(t.summary)}</div>\r\n                        <div className=\"text-xs text-slate-500\">\r\n                          {t.category} | {t.severity} | {STATUS_LABEL[t.status] || t.status}\r\n                        </div>\r\n                      </div>\r\n                      <div className=\"text-xs text-slate-500 md:text-right\">\r\n                        <div>Asesor: <strong>{t.assigned_agent_id ? nameOf(usersById[t.assigned_agent_id]) : \"Sin asignar\"}</strong></div>\r\n                        <div>Origen: <strong>{t.request_origin === \"anonymous\" ? \"Anonimo\" : \"Registrado\"}</strong></div>\r\n                        <div>Creado: {fmt(t.created_at)}</div>\r\n                      </div>\r\n                    </div>\r\n                  </button>\r\n                ))}\r\n              </div>\r\n            </Card>\r\n          )\r\n        ) : (\r\n          <div className=\"space-y-5\">\r\n            <Card\r\n              title=\"Configuracion operativa\"\r\n              subtitle=\"Cobertura y estado del sistema de catalogo.\"\r\n              headerRight={\r\n                <div className=\"text-xs text-slate-500\">\r\n                  Sin macros:{\" \"}\r\n                  <strong>\r\n                    {metrics.config.categoriesNoMacro.length\r\n                      ? metrics.config.categoriesNoMacro.map((c) => c.label).join(\", \")\r\n                      : \"Cobertura completa\"}\r\n                  </strong>\r\n                </div>\r\n              }\r\n            >\r\n              <div className=\"grid gap-3 md:grid-cols-3\">\r\n                <Metric icon={Settings2} title=\"Macros totales\" value={catalogMacroSummary.total} />\r\n                <Metric icon={CheckCircle2} title=\"Macros activas\" value={catalogMacroSummary.active} />\r\n                <Metric icon={Users} title=\"Categorías cubiertas\" value={catalogMacroSummary.covered} />\r\n              </div>\r\n            </Card>\r\n            <Card\r\n              title=\"Categorías y catalogo de macros\"\r\n              subtitle=\"Cobertura, volumen y macros agrupadas.\"\r\n              headerRight={\r\n                <div className=\"flex flex-wrap items-center justify-end gap-2 text-xs\">\r\n                  <span className=\"text-slate-500\">Agrupar por:</span>\r\n                  {CATALOG_GROUP_OPTIONS.map((opt) => (\r\n                    <button\r\n                      key={opt.id}\r\n                      type=\"button\"\r\n                      onClick={() => {\r\n                        setCatalogGroupBy(opt.id);\r\n                        setExpandedCatalogGroups({});\r\n                      }}\r\n                      className={`rounded-full border px-3 py-1 font-semibold ${\r\n                        catalogGroupBy === opt.id\r\n                          ? \"border-[#2F1A55] bg-[#2F1A55] text-white\"\r\n                          : \"border-[#E9E2F7] bg-white text-[#2F1A55]\"\r\n                      }`}\r\n                    >\r\n                      {opt.label}\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              }\r\n            >\r\n              <div className=\"space-y-3\">\r\n                {catalogGroupBy === \"categoria\"\r\n                  ? categoriesStats.map((c) => {\r\n                      const groupKey = `cat:${c.id}`;\r\n                      const isExpanded = !!expandedCatalogGroups[groupKey];\r\n                      const groupedStatuses = Object.entries(c.macrosByStatus || {}).sort((a, b) => {\r\n                        const diff = statusRank(a[0]) - statusRank(b[0]);\r\n                        return diff !== 0 ? diff : a[0].localeCompare(b[0]);\r\n                      });\r\n                      return (\r\n                        <div key={groupKey} className=\"overflow-hidden rounded-2xl border border-[#EFE9FA] bg-[#FCFBFF]\">\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              setExpandedCatalogGroups((prev) => ({\r\n                                ...prev,\r\n                                [groupKey]: !prev[groupKey],\r\n                              }))\r\n                            }\r\n                            className=\"flex w-full flex-col gap-3 px-4 py-3 text-left md:flex-row md:items-center md:justify-between\"\r\n                          >\r\n                            <div className=\"min-w-0 flex-1 space-y-1\">\r\n                              <div className=\"flex flex-wrap items-center gap-2\">\r\n                                <span className=\"text-sm font-semibold text-[#2F1A55]\">{c.label}</span>\r\n                                <span className=\"text-xs text-slate-400\">({c.id})</span>\r\n                              </div>\r\n                              <div className=\"text-xs text-slate-500\">{c.description}</div>\r\n                            </div>\r\n                            <div className=\"flex flex-wrap items-center gap-2 text-[11px] text-slate-600\">\r\n                              <span className=\"rounded-full border border-[#E9E2F7] bg-white px-2 py-1\">\r\n                                Total: <strong>{c.total}</strong>\r\n                              </span>\r\n                              <span className=\"rounded-full border border-[#E9E2F7] bg-white px-2 py-1\">\r\n                                Activos: <strong>{c.active}</strong>\r\n                              </span>\r\n                              <span className=\"rounded-full border border-[#E9E2F7] bg-white px-2 py-1\">\r\n                                Macros: <strong>{c.macros}</strong>\r\n                              </span>\r\n                              <span className=\"rounded-full border border-[#E9E2F7] bg-white px-2 py-1\">\r\n                                Roles: <strong>{c.rolesWithMacros.length ? c.rolesWithMacros.join(\", \") : \"-\"}</strong>\r\n                              </span>\r\n                            </div>\r\n                            <div className=\"shrink-0 text-[#5E30A5]\">\r\n                              {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}\r\n                            </div>\r\n                          </button>\r\n                          {isExpanded ? (\r\n                            <div className=\"space-y-3 border-t border-[#EFE9FA] px-4 py-3\">\r\n                              {groupedStatuses.length ? (\r\n                                groupedStatuses.map(([status, list]) => (\r\n                                  <div key={`${groupKey}-${status}`} className=\"rounded-xl border border-[#EFE9FA] bg-white px-3 py-2\">\r\n                                    <div className=\"mb-2 flex flex-wrap items-center justify-between gap-2 text-xs\">\r\n                                      <div className=\"font-semibold text-[#2F1A55]\">\r\n                                        {MACRO_STATUS_LABEL[status] || status}\r\n                                        <span className=\"ml-1 text-slate-400\">({status})</span>\r\n                                      </div>\r\n                                      <div className=\"text-slate-500\">\r\n                                        Macros: <strong>{list.length}</strong>\r\n                                      </div>\r\n                                    </div>\r\n                                    <div className=\"space-y-2\">\r\n                                      {list.map((m) => renderCatalogMacroCard(m, `${groupKey}-${status}-${m.id}`))}\r\n                                    </div>\r\n                                  </div>\r\n                                ))\r\n                              ) : (\r\n                                <div className=\"rounded-xl border border-[#EFE9FA] bg-white px-3 py-2 text-xs text-slate-500\">\r\n                                  Sin macros para esta categoría.\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                          ) : null}\r\n                        </div>\r\n                      );\r\n                    })\r\n                  : null}\r\n\r\n                {catalogGroupBy === \"estado\"\r\n                  ? groupedByStatus.map((group) => {\r\n                      const groupKey = `status:${group.id}`;\r\n                      const isExpanded = !!expandedCatalogGroups[groupKey];\r\n                      return (\r\n                        <div key={groupKey} className=\"overflow-hidden rounded-2xl border border-[#EFE9FA] bg-[#FCFBFF]\">\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              setExpandedCatalogGroups((prev) => ({\r\n                                ...prev,\r\n                                [groupKey]: !prev[groupKey],\r\n                              }))\r\n                            }\r\n                            className=\"flex w-full items-center justify-between gap-3 px-4 py-3 text-left\"\r\n                          >\r\n                            <div>\r\n                              <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                                {group.label}\r\n                                <span className=\"ml-1 text-xs text-slate-400\">({group.id})</span>\r\n                              </div>\r\n                              <div className=\"text-xs text-slate-500\">Macros agrupadas por estado objetivo.</div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-3\">\r\n                              <span className=\"rounded-full border border-[#E9E2F7] bg-white px-2 py-1 text-[11px] text-slate-600\">\r\n                                Macros: <strong>{group.list.length}</strong>\r\n                              </span>\r\n                              <div className=\"text-[#5E30A5]\">\r\n                                {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}\r\n                              </div>\r\n                            </div>\r\n                          </button>\r\n                          {isExpanded ? (\r\n                            <div className=\"space-y-2 border-t border-[#EFE9FA] px-4 py-3\">\r\n                              {group.list.map((m) => renderCatalogMacroCard(m, `${groupKey}-${m.id}`))}\r\n                            </div>\r\n                          ) : null}\r\n                        </div>\r\n                      );\r\n                    })\r\n                  : null}\r\n\r\n                {catalogGroupBy === \"rol\"\r\n                  ? groupedByRole.map((group) => {\r\n                      const groupKey = `role:${group.id}`;\r\n                      const isExpanded = !!expandedCatalogGroups[groupKey];\r\n                      return (\r\n                        <div key={groupKey} className=\"overflow-hidden rounded-2xl border border-[#EFE9FA] bg-[#FCFBFF]\">\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              setExpandedCatalogGroups((prev) => ({\r\n                                ...prev,\r\n                                [groupKey]: !prev[groupKey],\r\n                              }))\r\n                            }\r\n                            className=\"flex w-full items-center justify-between gap-3 px-4 py-3 text-left\"\r\n                          >\r\n                            <div>\r\n                              <div className=\"text-sm font-semibold text-[#2F1A55]\">{group.label}</div>\r\n                              <div className=\"text-xs text-slate-500\">Macros agrupadas por rol de atencion.</div>\r\n                            </div>\r\n                            <div className=\"flex items-center gap-3\">\r\n                              <span className=\"rounded-full border border-[#E9E2F7] bg-white px-2 py-1 text-[11px] text-slate-600\">\r\n                                Macros: <strong>{group.list.length}</strong>\r\n                              </span>\r\n                              <div className=\"text-[#5E30A5]\">\r\n                                {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}\r\n                              </div>\r\n                            </div>\r\n                          </button>\r\n                          {isExpanded ? (\r\n                            <div className=\"space-y-2 border-t border-[#EFE9FA] px-4 py-3\">\r\n                              {group.list.map((m) => renderCatalogMacroCard(m, `${groupKey}-${m.id}`))}\r\n                            </div>\r\n                          ) : null}\r\n                        </div>\r\n                      );\r\n                    })\r\n                  : null}\r\n              </div>\r\n            </Card>\r\n          </div>\r\n        )}\r\n\r\n        {!isTicketsLocked && view === \"advanced\" && !loading && activePanel === \"tickets\"\r\n          ? renderAdvancedTickets()\r\n          : null}\r\n      </div>\r\n    </AdminLayout>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\support\\AdminSupportDesk.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\support\\AdminSupportTicket.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\support\\AdminSupportTicketsPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\support\\services\\supportMacrosOpsService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\usuarios\\UsuarioDrawer.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\usuarios\\UsuariosTable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\usuarios\\usuarioCliente.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\usuarios\\usuarioNegocio.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\versioning\\VersioningOverviewPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\versioning\\VersioningReleaseExplorerPanel.jsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'load'. Either include it or remove the dependency array.","line":210,"column":6,"nodeType":"ArrayExpression","endLine":210,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [load]","fix":{"range":[7066,7068],"text":"[load]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadReleases'. Either include it or remove the dependency array.","line":222,"column":6,"nodeType":"ArrayExpression","endLine":222,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [loadReleases, selectedProduct]","fix":{"range":[7373,7390],"text":"[loadReleases, selectedProduct]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadComponents'. Either include it or remove the dependency array.","line":234,"column":6,"nodeType":"ArrayExpression","endLine":234,"endColumn":55,"suggestions":[{"desc":"Update the dependencies array to be: [selectedRelease, selectedProduct, isInitialized, loadComponents]","fix":{"range":[7700,7749],"text":"[selectedRelease, selectedProduct, isInitialized, loadComponents]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\admin\\versioning\\services\\versioningService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\AuthFlow.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has a missing dependency: 'flow'. Either include it or remove the dependency array.","line":242,"column":6,"nodeType":"ArrayExpression","endLine":273,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [flow]","fix":{"range":[8447,9266],"text":"[flow]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'verificationSteps'. Either include it or remove the dependency array.","line":396,"column":6,"nodeType":"ArrayExpression","endLine":403,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [flow, onboarding?.allowAccess, clientStepsPending, verificationStatus, emailConfirmed, isBusiness, verificationSteps]","fix":{"range":[13884,14019],"text":"[flow, onboarding?.allowAccess, clientStepsPending, verificationStatus, emailConfirmed, isBusiness, verificationSteps]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useCallback has a missing dependency: 'flow'. Either include it or remove the dependency array.","line":505,"column":6,"nodeType":"ArrayExpression","endLine":505,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: [logout, flow]","fix":{"range":[17553,17575],"text":"[logout, flow]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has a missing dependency: 'flow'. Either include it or remove the dependency array.","line":533,"column":6,"nodeType":"ArrayExpression","endLine":533,"endColumn":80,"suggestions":[{"desc":"Update the dependencies array to be: [flow, flow.isAddressSearchModeOpen, flow.setIsAddressSearchModeOpen, flow.step]","fix":{"range":[18271,18345],"text":"[flow, flow.isAddressSearchModeOpen, flow.setIsAddressSearchModeOpen, flow.step]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import React, { useEffect, useMemo } from \"react\";\r\nimport { useLocation } from \"react-router-dom\";\r\nimport { useAppStore } from \"../store/appStore\";\r\nimport AuthView from \"./AuthView\";\r\nimport AuthBranderHeader from \"./blocks/AuthBranderHeader\";\r\nimport AuthFooter from \"./blocks/AuthFooter\";\r\nimport BackButton from \"./blocks/BackButton\";\r\nimport StepProgress from \"./blocks/StepProgress\";\r\nimport EmailLoginStep from \"./steps/EmailLoginStep\";\r\nimport EmailRegisterStep from \"./steps/EmailRegisterStep\";\r\nimport WelcomeStep from \"./steps/WelcomeStep\";\r\nimport UserProfileStep from \"./steps/UserProfileStep\";\r\nimport BusinessDataStep from \"./steps/BusinessDataStep\";\r\nimport BusinessCategoryStep from \"./steps/BusinessCategoryStep\";\r\nimport UserAddressStep from \"./steps/UserAddressStep\";\r\nimport AccountVerifyPrompt from \"./steps/AccountVerifyPrompt\";\r\nimport AddPasswordStep from \"./steps/AddPasswordStep\";\r\nimport AddTwoFAStep from \"./steps/AddTwoFAStep\";\r\nimport VerifyEmailStep from \"./steps/VerifyEmailStep\";\r\nimport AccountVerifyMethodStep from \"./steps/AccountVerifyMethodStep\";\r\nimport AccountVerifyReadyStep from \"./steps/AccountVerifyReadyStep\";\r\nimport BusinessVerifyStep from \"./steps/BusinessVerifyStep\";\r\nimport RoleSelectStep from \"./steps/RoleSelectStep\";\r\nimport useAuthFlow from \"./hooks/useAuthFlow\";\r\nimport useAuthActions from \"./hooks/useAuthActions\";\r\nimport useAuthPrefill from \"./hooks/useAuthPrefill\";\r\nimport { AUTH_STEPS } from \"./constants/authSteps\";\r\nimport { getUserProfileStatus } from \"./utils/userProfileUtils\";\r\nimport { AUTH_BRAND } from \"./constants/authCopy\";\r\nimport {\r\n  BUSINESS_CATEGORIES,\r\n  BUSINESS_SUBCATEGORIES,\r\n  getBusinessCategoryPath,\r\n} from \"./constants/businessCategories\";\r\n\r\nconst BUSINESS_STEP_COPY = {\r\n  [AUTH_STEPS.USER_PROFILE]: {\r\n    header: \"Cuéntanos más sobre ti\",\r\n    subtitle: \"Eres quien administrará el negocio en la app.\",\r\n  },\r\n  [AUTH_STEPS.BUSINESS_DATA]: {\r\n    header: \"Ahora tu negocio\",\r\n    subtitle: \"Así te verán tus clientes\",\r\n  },\r\n  [AUTH_STEPS.BUSINESS_CATEGORY]: {\r\n    header: \"Cuéntanos a qué se dedica tu negocio\",\r\n    headerFallback: \"Cómo definirías tu negocio?\",\r\n    subtitle: \"No te preocupes, puedes cambiarlo después\",\r\n    helperLabel: \"Así podremos mostrar tus promos a las personas correctas.\",\r\n  },\r\n  [AUTH_STEPS.BUSINESS_VERIFY]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.USER_ADDRESS]: {\r\n    header: \"¿Dónde estás ubicado?\",\r\n    subtitle: \"Ayúdanos a conectar tu negocio con personas cerca de ti.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY_PROMPT]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ADD_PASSWORD]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ADD_MFA]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.VERIFY_EMAIL]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY_METHOD]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY_READY]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n};\r\n\r\nconst CLIENT_STEP_COPY = {\r\n  [AUTH_STEPS.USER_PROFILE]: {\r\n    header: \"Cuéntanos más sobre ti\",\r\n    subtitle: \"Empieza por personalizar tu experiencia en la app.\",\r\n  },\r\n  [AUTH_STEPS.USER_ADDRESS]: {\r\n    header: \"Descubre promociones cerca de ti\",\r\n    subtitle: \"Encuentra lo que más te conviene según tu ubicación.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY_PROMPT]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ADD_PASSWORD]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ADD_MFA]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.VERIFY_EMAIL]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY_METHOD]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n  [AUTH_STEPS.ACCOUNT_VERIFY_READY]: {\r\n    header: \"Desbloquea tus beneficios\",\r\n    subtitle:\r\n      \"Esto es opcional, pero te ayudará a sacarle más provecho a la app.\",\r\n  },\r\n};\r\n\r\nexport default function AuthFlow() {\r\n  const location = useLocation();\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const logout = useAppStore((s) => s.logout);\r\n  const bootstrapAuth = useAppStore((s) => s.bootstrapAuth);\r\n  const currentRole = usuario?.role || onboarding?.usuario?.role;\r\n  const isBusiness = currentRole === \"negocio\";\r\n  const isClient = currentRole === \"cliente\";\r\n  const minAge = isClient ? 16 : 18;\r\n  const initialStep = useMemo(\r\n    () =>\r\n      location.pathname === \"/auth\"\r\n        ? AUTH_STEPS.EMAIL_LOGIN\r\n        : AUTH_STEPS.WELCOME,\r\n    [location.pathname]\r\n  );\r\n  const flow = useAuthFlow({ initialStep });\r\n  const isVerificationFlowStep = [\r\n    AUTH_STEPS.BUSINESS_VERIFY,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_PROMPT,\r\n    AUTH_STEPS.VERIFY_EMAIL,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_METHOD,\r\n    AUTH_STEPS.ADD_PASSWORD,\r\n    AUTH_STEPS.ADD_MFA,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_READY,\r\n  ].includes(flow.step);\r\n\r\n  const resetToWelcome = React.useCallback(() => {\r\n    flow.setEmail(\"\");\r\n    flow.setPassword(\"\");\r\n    flow.setPasswordConfirm(\"\");\r\n    flow.setTelefono(\"\");\r\n    flow.setCodigo(\"\");\r\n    flow.setNombreDueno(\"\");\r\n    flow.setApellidoDueno(\"\");\r\n    flow.setGenero(\"no_especificar\");\r\n    flow.setFechaNacimiento(\"\");\r\n    flow.setOwnerPrefill({\r\n      nombre: \"\",\r\n      apellido: \"\",\r\n      fechaNacimiento: \"\",\r\n      genero: \"\",\r\n    });\r\n    flow.setBusinessPrefill({\r\n      nombreNegocio: \"\",\r\n      ruc: \"\",\r\n      categoriaNegocio: \"\",\r\n    });\r\n    flow.setNombreNegocio(\"\");\r\n    flow.setCategoriaNegocio(\"\");\r\n    flow.setIsSucursalPrincipal(false);\r\n    flow.setSectorNegocio(\"\");\r\n    flow.setCalle1(\"\");\r\n    flow.setCalle2(\"\");\r\n    flow.setHorarios({\r\n      semanal: {\r\n        lunes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n        martes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n        miercoles: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n        jueves: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n        viernes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n        sabado: [],\r\n        domingo: [],\r\n      },\r\n      excepciones: [],\r\n    });\r\n    flow.setDireccionPayload({\r\n      place_id: \"\",\r\n      label: \"\",\r\n      display_label: \"\",\r\n      provider: \"\",\r\n      lat: null,\r\n      lng: null,\r\n      provincia_id: \"\",\r\n      canton_id: \"\",\r\n      parroquia_id: \"\",\r\n      parroquia: \"\",\r\n      ciudad: \"\",\r\n      sector: \"\",\r\n      calles: \"\",\r\n      house_number: \"\",\r\n      postcode: \"\",\r\n      referencia: \"\",\r\n      provincia: \"\",\r\n      canton: \"\",\r\n      country: \"\",\r\n    });\r\n    flow.setEmailError(\"\");\r\n    flow.setWelcomeError(\"\");\r\n    flow.setLoginLoading(false);\r\n    flow.setOauthLoading(false);\r\n    flow.setOauthProvider(null);\r\n    flow.setWelcomeLoading(false);\r\n    flow.setIsAddressSearchModeOpen(false);\r\n    flow.setIsAddressPrefillReady(false);\r\n    flow.setShowPassword(false);\r\n    flow.setShowPasswordConfirm(false);\r\n    flow.setStep(AUTH_STEPS.WELCOME);\r\n  }, [\r\n    flow.setApellidoDueno,\r\n    flow.setCalle1,\r\n    flow.setCalle2,\r\n    flow.setCodigo,\r\n    flow.setEmail,\r\n    flow.setEmailError,\r\n    flow.setLoginLoading,\r\n    flow.setNombreDueno,\r\n    flow.setFechaNacimiento,\r\n    flow.setOwnerPrefill,\r\n    flow.setGenero,\r\n    flow.setBusinessPrefill,\r\n    flow.setNombreNegocio,\r\n    flow.setCategoriaNegocio,\r\n    flow.setIsSucursalPrincipal,\r\n    flow.setOauthLoading,\r\n    flow.setOauthProvider,\r\n    flow.setPassword,\r\n    flow.setPasswordConfirm,\r\n    flow.setSectorNegocio,\r\n    flow.setTelefono,\r\n    flow.setWelcomeError,\r\n    flow.setWelcomeLoading,\r\n    flow.setIsAddressSearchModeOpen,\r\n    flow.setIsAddressPrefillReady,\r\n    flow.setHorarios,\r\n    flow.setDireccionPayload,\r\n    flow.setShowPassword,\r\n    flow.setShowPasswordConfirm,\r\n    flow.setStep,\r\n  ]);\r\n\r\n  const actions = useAuthActions({\r\n    email: flow.email,\r\n    password: flow.password,\r\n    passwordConfirm: flow.passwordConfirm,\r\n    telefono: flow.telefono,\r\n    nombreDueno: flow.nombreDueno,\r\n    apellidoDueno: flow.apellidoDueno,\r\n    genero: flow.genero,\r\n    fechaNacimiento: flow.fechaNacimiento,\r\n    ownerPrefill: flow.ownerPrefill,\r\n    businessPrefill: flow.businessPrefill,\r\n    nombreNegocio: flow.nombreNegocio,\r\n    categoriaNegocio: flow.categoriaNegocio,\r\n    isSucursalPrincipal: flow.isSucursalPrincipal,\r\n    horarios: flow.horarios,\r\n    direccionPayload: flow.direccionPayload,\r\n    setEmailError: flow.setEmailError,\r\n    setWelcomeError: flow.setWelcomeError,\r\n    setLoginLoading: flow.setLoginLoading,\r\n    setOauthLoading: flow.setOauthLoading,\r\n    setOauthProvider: flow.setOauthProvider,\r\n    setWelcomeLoading: flow.setWelcomeLoading,\r\n    setStep: flow.setStep,\r\n    goToStep: flow.goToStep,\r\n    step: flow.step,\r\n    onResetToWelcome: resetToWelcome,\r\n  });\r\n\r\n  useAuthPrefill({\r\n    usuario,\r\n    onboarding,\r\n    setStep: flow.setStep,\r\n    setEmailError: flow.setEmailError,\r\n    setNombreDueno: flow.setNombreDueno,\r\n    setApellidoDueno: flow.setApellidoDueno,\r\n    setGenero: flow.setGenero,\r\n    setTelefono: flow.setTelefono,\r\n    setFechaNacimiento: flow.setFechaNacimiento,\r\n    setOwnerPrefill: flow.setOwnerPrefill,\r\n    setBusinessPrefill: flow.setBusinessPrefill,\r\n    setNombreNegocio: flow.setNombreNegocio,\r\n    setCategoriaNegocio: flow.setCategoriaNegocio,\r\n    setIsSucursalPrincipal: flow.setIsSucursalPrincipal,\r\n    setHorarios: flow.setHorarios,\r\n    setSectorNegocio: flow.setSectorNegocio,\r\n    setCalle1: flow.setCalle1,\r\n    setCalle2: flow.setCalle2,\r\n    setDireccionPayload: flow.setDireccionPayload,\r\n    setIsAddressPrefillReady: flow.setIsAddressPrefillReady,\r\n    skipStepChange: isVerificationFlowStep,\r\n  });\r\n\r\n\r\n  const verificationStatus =\r\n    onboarding?.verification_status || onboarding?.usuario?.verification_status;\r\n  const authProfile = onboarding?.usuario || {};\r\n  const hasPassword = Boolean(authProfile?.has_password);\r\n  const hasMfa = Boolean(\r\n    authProfile?.mfa_totp_enabled ||\r\n      authProfile?.mfa_method ||\r\n      authProfile?.mfa_primary_method ||\r\n      authProfile?.mfa_enrolled_at\r\n  );\r\n  const emailConfirmed = Boolean(onboarding?.email_confirmed);\r\n  const provider = onboarding?.provider || \"email\";\r\n  const providers = onboarding?.providers || [];\r\n  const termsAccepted = Boolean(authProfile?.terms_accepted);\r\n  const privacyAccepted = Boolean(authProfile?.privacy_accepted);\r\n  const clientSteps = onboarding?.client_steps || {};\r\n  const clientProfile = clientSteps.profile || {};\r\n  const clientAddress = clientSteps.address || {};\r\n  const clientProfileCompleted = Boolean(clientProfile.completed);\r\n  const clientAddressCompleted = Boolean(clientAddress.completed);\r\n  const clientProfileSkipped =\r\n    Boolean(clientProfile.skipped) && !clientProfileCompleted;\r\n  const clientAddressSkipped =\r\n    Boolean(clientAddress.skipped) && !clientAddressCompleted;\r\n  const accountVerified = Boolean(emailConfirmed && (hasPassword || hasMfa));\r\n  const businessVerified = Boolean(\r\n    (onboarding?.ruc || onboarding?.negocio?.ruc) &&\r\n      (onboarding?.phone || usuario?.telefono)\r\n  );\r\n  const clientStepsPending =\r\n    isClient &&\r\n    ((!clientProfileCompleted && !clientProfileSkipped) ||\r\n      (!clientAddressCompleted && !clientAddressSkipped));\r\n  const verificationSteps = [\r\n    AUTH_STEPS.BUSINESS_VERIFY,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_PROMPT,\r\n    AUTH_STEPS.VERIFY_EMAIL,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_METHOD,\r\n    AUTH_STEPS.ADD_PASSWORD,\r\n    AUTH_STEPS.ADD_MFA,\r\n  ];\r\n  useEffect(() => {\r\n    if (!onboarding?.allowAccess) return;\r\n    if (clientStepsPending) return;\r\n    const status = verificationStatus || \"unverified\";\r\n    if (status === \"unverified\") {\r\n      if (flow.step !== AUTH_STEPS.ACCOUNT_VERIFY_PROMPT) {\r\n        flow.setStep(AUTH_STEPS.ACCOUNT_VERIFY_PROMPT);\r\n      }\r\n      return;\r\n    }\r\n    if (status === \"in_progress\") {\r\n      const target = isBusiness\r\n        ? AUTH_STEPS.BUSINESS_VERIFY\r\n        : emailConfirmed\r\n          ? AUTH_STEPS.ACCOUNT_VERIFY_METHOD\r\n          : AUTH_STEPS.VERIFY_EMAIL;\r\n      if (!verificationSteps.includes(flow.step) && flow.step !== target) {\r\n        flow.setStep(target);\r\n      }\r\n      return;\r\n    }\r\n    if (status === \"verified\" || status === \"skipped\") {\r\n      if (flow.step !== AUTH_STEPS.ACCOUNT_VERIFY_READY) {\r\n        flow.setStep(AUTH_STEPS.ACCOUNT_VERIFY_READY);\r\n      }\r\n      return;\r\n    }\r\n  }, [\r\n    flow,\r\n    onboarding?.allowAccess,\r\n    clientStepsPending,\r\n    verificationStatus,\r\n    emailConfirmed,\r\n    isBusiness,\r\n  ]);\r\n  const showBackButton = flow.step !== AUTH_STEPS.WELCOME;\r\n  const hasMinLength = flow.password.length >= 8;\r\n  const hasNumber = /\\d/.test(flow.password);\r\n  const hasSymbol = /[^A-Za-z0-9]/.test(flow.password);\r\n  const hasNumberAndSymbol = hasNumber && hasSymbol;\r\n  const passwordsMatch =\r\n    flow.password.length > 0 &&\r\n    flow.passwordConfirm.length > 0 &&\r\n    flow.password === flow.passwordConfirm;\r\n  const canSubmitPassword = hasMinLength && hasNumberAndSymbol && passwordsMatch;\r\n  const ownerStatus = useMemo(\r\n    () =>\r\n      getUserProfileStatus({\r\n        nombre: flow.nombreDueno,\r\n        apellido: flow.apellidoDueno,\r\n        genero: flow.genero,\r\n        fechaNacimiento: flow.fechaNacimiento,\r\n        minAge,\r\n      }),\r\n    [\r\n      flow.apellidoDueno,\r\n      flow.fechaNacimiento,\r\n      flow.genero,\r\n      flow.nombreDueno,\r\n      minAge,\r\n    ]\r\n  );\r\n  const isWelcome = flow.step === AUTH_STEPS.WELCOME;\r\n  const isFormStep = [\r\n    AUTH_STEPS.USER_PROFILE,\r\n    AUTH_STEPS.BUSINESS_DATA,\r\n    AUTH_STEPS.BUSINESS_CATEGORY,\r\n    AUTH_STEPS.USER_ADDRESS,\r\n    AUTH_STEPS.BUSINESS_VERIFY,\r\n    AUTH_STEPS.ACCOUNT_VERIFY,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_PROMPT,\r\n    AUTH_STEPS.VERIFY_EMAIL,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_METHOD,\r\n    AUTH_STEPS.ACCOUNT_VERIFY_READY,\r\n    AUTH_STEPS.ADD_PASSWORD,\r\n    AUTH_STEPS.ADD_MFA,\r\n  ].includes(flow.step);\r\n  const containerClassName = isWelcome\r\n    ? \"justify-center pb-28\"\r\n    : isFormStep\r\n    ? \"relative justify-center\"\r\n    : \"relative\";\r\n  const brandClassName = isWelcome\r\n    ? \"mb-6\"\r\n    : isFormStep\r\n    ? \"mb-4 text-center\"\r\n    : \"mt-12 mb-2 text-center\";\r\n  const stepCopyMap = isClient\r\n    ? { ...BUSINESS_STEP_COPY, ...CLIENT_STEP_COPY }\r\n    : BUSINESS_STEP_COPY;\r\n  const stepCopy = stepCopyMap[flow.step] || {};\r\n  const headerTitle =\r\n    stepCopy.header || stepCopy.headerFallback || AUTH_BRAND.name;\r\n  const userProfileSubtitle = (isClient\r\n    ? CLIENT_STEP_COPY\r\n    : BUSINESS_STEP_COPY)[AUTH_STEPS.USER_PROFILE]?.subtitle;\r\n  const businessSubtitle = BUSINESS_STEP_COPY[AUTH_STEPS.BUSINESS_DATA]?.subtitle;\r\n  const categorySubtitle =\r\n    BUSINESS_STEP_COPY[AUTH_STEPS.BUSINESS_CATEGORY]?.subtitle;\r\n  const categoryHelper =\r\n    BUSINESS_STEP_COPY[AUTH_STEPS.BUSINESS_CATEGORY]?.helperLabel;\r\n  const addressSubtitle = (isClient\r\n    ? CLIENT_STEP_COPY\r\n    : BUSINESS_STEP_COPY)[AUTH_STEPS.USER_ADDRESS]?.subtitle;\r\n  const categoryPath = useMemo(\r\n    () => getBusinessCategoryPath(flow.categoriaNegocio),\r\n    [flow.categoriaNegocio]\r\n  );\r\n\r\n  const handleVerificationExit = React.useCallback(async () => {\r\n    await bootstrapAuth({ force: true });\r\n    flow.setStep(AUTH_STEPS.ACCOUNT_VERIFY_READY);\r\n  }, [bootstrapAuth, flow]);\r\n\r\n  const handleBackToMethod = React.useCallback(async () => {\r\n    await bootstrapAuth({ force: true });\r\n    flow.goToStep(AUTH_STEPS.ACCOUNT_VERIFY_METHOD);\r\n  }, [bootstrapAuth, flow]);\r\n\r\n\r\n  const [showExitConfirm, setShowExitConfirm] = React.useState(false);\r\n  const statusErrorRef = React.useRef(false);\r\n\r\n  React.useEffect(() => {\r\n    if (statusErrorRef.current) return;\r\n    const message = sessionStorage.getItem(\"auth_status_error\");\r\n    if (!message) return;\r\n    statusErrorRef.current = true;\r\n    sessionStorage.removeItem(\"auth_status_error\");\r\n    flow.setWelcomeError(message);\r\n  }, [flow]);\r\n\r\n  const handleOwnerExit = React.useCallback(async () => {\r\n    setShowExitConfirm(false);\r\n    await logout?.();\r\n    flow.setStep(AUTH_STEPS.EMAIL_REGISTER);\r\n  }, [logout, flow.setStep]);\r\n\r\n  const handleBack = () => {\r\n    if (\r\n      flow.step === AUTH_STEPS.EMAIL_LOGIN ||\r\n      flow.step === AUTH_STEPS.EMAIL_REGISTER\r\n    ) {\r\n      resetToWelcome();\r\n      return;\r\n    }\r\n    if (\r\n      flow.step === AUTH_STEPS.USER_ADDRESS &&\r\n      flow.isAddressSearchModeOpen\r\n    ) {\r\n      flow.setIsAddressSearchModeOpen(false);\r\n      return;\r\n    }\r\n    if (flow.step === AUTH_STEPS.USER_PROFILE && isBusiness) {\r\n      setShowExitConfirm(true);\r\n      return;\r\n    }\r\n    actions.handleButtonBack();\r\n  };\r\n\r\n  React.useEffect(() => {\r\n    if (flow.step !== AUTH_STEPS.USER_ADDRESS && flow.isAddressSearchModeOpen) {\r\n      flow.setIsAddressSearchModeOpen(false);\r\n    }\r\n  }, [flow.isAddressSearchModeOpen, flow.setIsAddressSearchModeOpen, flow.step]);\r\n\r\n  return (\r\n    <AuthView\r\n      className={containerClassName}\r\n      header={<AuthBranderHeader className={brandClassName} text={headerTitle} />}\r\n      footer={<AuthFooter />}\r\n    >\r\n      {showBackButton && (\r\n        <BackButton\r\n          onClick={handleBack}\r\n          className=\"absolute left-2 top-68\"\r\n          ariaLabel=\"Volver\"\r\n        />\r\n      )}\r\n\r\n      {(isBusiness &&\r\n        (flow.step === AUTH_STEPS.USER_PROFILE ||\r\n          flow.step === AUTH_STEPS.BUSINESS_CATEGORY ||\r\n          flow.step === AUTH_STEPS.BUSINESS_DATA ||\r\n          flow.step === AUTH_STEPS.USER_ADDRESS)) && (\r\n        <div className=\"w-full max-w-sm px-2 mb-4\">\r\n          <StepProgress\r\n            page={\r\n              flow.step === AUTH_STEPS.USER_PROFILE\r\n                ? 1\r\n                : flow.step === AUTH_STEPS.USER_ADDRESS\r\n                  ? 3\r\n                  : 2\r\n            }\r\n          />\r\n        </div>\r\n      )}\r\n\r\n      {flow.step === AUTH_STEPS.WELCOME && (\r\n        <WelcomeStep\r\n          error={flow.welcomeError}\r\n          loading={flow.welcomeLoading}\r\n          oauthLoading={flow.oauthLoading}\r\n          oauthProvider={flow.oauthProvider}\r\n          onEmail={() => {\r\n            flow.setWelcomeError(\"\");\r\n            flow.setStep(AUTH_STEPS.EMAIL_LOGIN);\r\n          }}\r\n          onGoogle={actions.startGoogleOneTap}\r\n          onFacebook={actions.startFacebookOAuth}\r\n          // onApple={actions.startAppleOAuth}\r\n          onTwitter={actions.startTwitterOAuth}\r\n          onDiscord={actions.startDiscordOAuth}\r\n        />\r\n      )}\r\n\r\n      {flow.step === AUTH_STEPS.ROLE_SELECT && (\r\n        <RoleSelectStep\r\n          error={flow.emailError}\r\n          onSubmit={actions.handleRoleSelect}\r\n          onValidateNegocioCode={actions.validateNegocioCode}\r\n        />\r\n      )}\r\n\r\n      {flow.step === AUTH_STEPS.EMAIL_LOGIN && (\r\n        <EmailLoginStep\r\n          email={flow.email}\r\n          password={flow.password}\r\n          error={flow.emailError}\r\n          loginLoading={flow.loginLoading}\r\n          showPassword={flow.showPassword}\r\n          onLoginTab={actions.goToEmailLogin}\r\n          onRegisterTab={actions.goToEmailRegister}\r\n          onChangeEmail={flow.setEmail}\r\n          onChangePassword={flow.setPassword}\r\n          onToggleShowPassword={() =>\r\n            flow.setShowPassword((prev) => !prev)\r\n          }\r\n          onSubmit={actions.handleEmailLogin}\r\n        />\r\n      )}\r\n\r\n      {flow.step === AUTH_STEPS.EMAIL_REGISTER && (\r\n        <EmailRegisterStep\r\n          email={flow.email}\r\n          password={flow.password}\r\n          passwordConfirm={flow.passwordConfirm}\r\n          error={flow.emailError}\r\n          showPassword={flow.showPassword}\r\n          showPasswordConfirm={flow.showPasswordConfirm}\r\n          hasMinLength={hasMinLength}\r\n          hasNumberAndSymbol={hasNumberAndSymbol}\r\n          passwordsMatch={passwordsMatch}\r\n          onLoginTab={actions.goToEmailLogin}\r\n          onRegisterTab={actions.goToEmailRegister}\r\n          onChangeEmail={flow.setEmail}\r\n          onChangePassword={flow.setPassword}\r\n          onChangePasswordConfirm={flow.setPasswordConfirm}\r\n          onToggleShowPassword={() =>\r\n            flow.setShowPassword((prev) => !prev)\r\n          }\r\n          onToggleShowPasswordConfirm={() =>\r\n            flow.setShowPasswordConfirm((prev) => !prev)\r\n          }\r\n          onSubmit={actions.handleEmailRegister}\r\n          primaryDisabled={!canSubmitPassword}\r\n        />\r\n      )}\r\n\r\n      {isFormStep && (\r\n        <div\r\n          ref={flow.cardRef}\r\n          className=\"bg-white w-full max-w-sm rounded-2xl shadow-xl mt-2 overflow-visible flex flex-col\"\r\n          style={{\r\n            height: \"80vh\",\r\n            boxSizing: \"border-box\",\r\n            transition: \"height 260ms ease\",\r\n            overflow: \"hidden\",\r\n          }}\r\n        >\r\n          <div\r\n            ref={flow.cardInnerRef}\r\n            className=\"bg-white w-full rounded-2xl shadow-xl px-6 pt-4 pb-4 flex flex-col h-full\"\r\n            style={{ boxSizing: \"border-box\", overflow: \"hidden\" }}\r\n          >\r\n            <div\r\n              ref={flow.sliderRef}\r\n              style={flow.containerStyle}\r\n              className=\"relative z-10 flex-1\"\r\n            >\r\n      {flow.step === AUTH_STEPS.USER_PROFILE && (\r\n        <UserProfileStep\r\n          error={flow.emailError}\r\n          inputClassName=\"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 mb-2 text-sm\"\r\n          nombreDueno={flow.nombreDueno}\r\n          apellidoDueno={flow.apellidoDueno}\r\n          fechaNacimiento={flow.fechaNacimiento}\r\n          genero={flow.genero}\r\n          subtitle={userProfileSubtitle}\r\n          underageMessage={\r\n            isBusiness\r\n              ? \"Tienes que ser mayor de edad para ser el administrador de un negocio\"\r\n              : \"Debes tener al menos 16 años para usar la app.\"\r\n          }\r\n          minAge={minAge}\r\n          onChangeNombre={flow.setNombreDueno}\r\n          onChangeApellido={flow.setApellidoDueno}\r\n          onChangeGenero={flow.setGenero}\r\n          onChangeFechaNacimiento={flow.setFechaNacimiento}\r\n          onSubmit={actions.handleUserProfile}\r\n          onSkip={isClient ? actions.skipUserProfile : undefined}\r\n          innerRef={flow.regPage1Ref}\r\n          onGoWelcome={resetToWelcome}\r\n          primaryDisabled={!ownerStatus.canSubmit}\r\n        />\r\n      )}\r\n\r\n              {flow.step === AUTH_STEPS.BUSINESS_DATA && (\r\n                <BusinessDataStep\r\n                  error={flow.emailError}\r\n                  inputClassName=\"w-full border border-gray-300 rounded-lg px-3 py-2 mt-1 mb-2 text-sm\"\r\n                  nombreNegocio={flow.nombreNegocio}\r\n                  subtitle={businessSubtitle}\r\n                  categoriaNegocio={flow.categoriaNegocio}\r\n                  categoriaPadre={categoryPath.parentLabel}\r\n                  categoriaDetalle={categoryPath.subLabel}\r\n                  onChangeNombre={flow.setNombreNegocio}\r\n                  onOpenCategory={() => flow.goToStep(AUTH_STEPS.BUSINESS_CATEGORY)}\r\n                  onSubmit={actions.handleBusinessData}\r\n                  innerRef={flow.regPage2Ref}\r\n                  onGoWelcome={resetToWelcome}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.BUSINESS_CATEGORY && (\r\n                <BusinessCategoryStep\r\n                  subtitle={categorySubtitle}\r\n                  helperLabel={categoryHelper}\r\n                  categories={BUSINESS_CATEGORIES}\r\n                  subcategories={BUSINESS_SUBCATEGORIES}\r\n                  currentCategory={flow.categoriaNegocio}\r\n                  onConfirmCategory={(value) => {\r\n                    flow.setCategoriaNegocio(value);\r\n                    flow.goToStep(AUTH_STEPS.BUSINESS_DATA);\r\n                  }}\r\n                  innerRef={flow.regPage2Ref}\r\n                  onGoWelcome={resetToWelcome}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.USER_ADDRESS && (\r\n                <UserAddressStep\r\n                  innerRef={flow.regPage2Ref}\r\n                  searchModeOpen={flow.isAddressSearchModeOpen}\r\n                  onSearchModeChange={flow.setIsAddressSearchModeOpen}\r\n                  isAddressPrefillReady={flow.isAddressPrefillReady}\r\n                  isSucursalPrincipal={flow.isSucursalPrincipal}\r\n                  onChangeSucursalPrincipal={flow.setIsSucursalPrincipal}\r\n                  horarios={flow.horarios}\r\n                  onChangeHorarios={flow.setHorarios}\r\n                  direccionPayload={flow.direccionPayload}\r\n                  onChangeDireccionPayload={flow.setDireccionPayload}\r\n                  subtitle={addressSubtitle}\r\n                  error={flow.emailError}\r\n                  onSubmit={actions.handleUserAddress}\r\n                  onSkip={isClient ? actions.skipUserAddress : undefined}\r\n                  primaryLabel={isBusiness ? \"Entrar\" : \"Continuar\"}\r\n                  mode={isBusiness ? \"negocio\" : \"cliente\"}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.ACCOUNT_VERIFY_PROMPT && (\r\n                <AccountVerifyPrompt\r\n                  innerRef={flow.regPage2Ref}\r\n                  onVerify={() => {\r\n                    if (isBusiness) {\r\n                      flow.goToStep(AUTH_STEPS.BUSINESS_VERIFY);\r\n                      return;\r\n                    }\r\n                    flow.goToStep(\r\n                      emailConfirmed\r\n                        ? AUTH_STEPS.ACCOUNT_VERIFY_METHOD\r\n                        : AUTH_STEPS.VERIFY_EMAIL\r\n                    );\r\n                  }}\r\n                  onSkip={handleVerificationExit}\r\n                  mode={isBusiness ? \"negocio\" : \"cliente\"}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.BUSINESS_VERIFY && isBusiness && (\r\n                <BusinessVerifyStep\r\n                  innerRef={flow.regPage2Ref}\r\n                  phone={onboarding?.phone || usuario?.telefono || \"\"}\r\n                  ruc={onboarding?.ruc || \"\"}\r\n                  onContinue={() =>\r\n                    flow.goToStep(\r\n                      emailConfirmed\r\n                        ? AUTH_STEPS.ACCOUNT_VERIFY_METHOD\r\n                        : AUTH_STEPS.VERIFY_EMAIL\r\n                    )\r\n                  }\r\n                  onSkip={handleVerificationExit}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.VERIFY_EMAIL && (\r\n                <VerifyEmailStep\r\n                  innerRef={flow.regPage2Ref}\r\n                  emailConfirmed={emailConfirmed}\r\n                  onContinue={() => flow.goToStep(AUTH_STEPS.ACCOUNT_VERIFY_METHOD)}\r\n                  onSkip={handleVerificationExit}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.ACCOUNT_VERIFY_METHOD && (\r\n                <AccountVerifyMethodStep\r\n                  innerRef={flow.regPage2Ref}\r\n                  hasPassword={hasPassword}\r\n                  hasMfa={hasMfa}\r\n                  onGoAddPassword={() => flow.goToStep(AUTH_STEPS.ADD_PASSWORD)}\r\n                  onGoAddMfa={() => flow.goToStep(AUTH_STEPS.ADD_MFA)}\r\n                  onContinue={handleVerificationExit}\r\n                  onSkip={handleVerificationExit}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.ADD_PASSWORD && (\r\n                <AddPasswordStep\r\n                  innerRef={flow.regPage2Ref}\r\n                  provider={provider}\r\n                  providers={providers}\r\n                  hasPassword={hasPassword}\r\n                  onContinue={handleBackToMethod}\r\n                  onSkip={handleVerificationExit}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.ADD_MFA && (\r\n                <AddTwoFAStep\r\n                  innerRef={flow.regPage2Ref}\r\n                  onCancel={() => flow.goToStep(AUTH_STEPS.ACCOUNT_VERIFY_METHOD)}\r\n                  onContinue={handleBackToMethod}\r\n                />\r\n              )}\r\n\r\n              {flow.step === AUTH_STEPS.ACCOUNT_VERIFY_READY && (\r\n                <AccountVerifyReadyStep\r\n                  innerRef={flow.regPage2Ref}\r\n                  isVerified={\r\n                    isBusiness\r\n                      ? Boolean(accountVerified && businessVerified)\r\n                      : Boolean(accountVerified)\r\n                  }\r\n                  termsAccepted={termsAccepted}\r\n                  privacyAccepted={privacyAccepted}\r\n                  onBackToVerify={() =>\r\n                    flow.goToStep(AUTH_STEPS.ACCOUNT_VERIFY_PROMPT)\r\n                  }\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {showExitConfirm && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-6 backdrop-blur-[2px]\">\r\n          <div className=\"w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 text-[#0F172A]\">\r\n            <h3 className=\"text-center text-lg font-semibold text-[#5E30A5]\">\r\n              Confirmar salida\r\n            </h3>\r\n            <p className=\"text-sm text-gray-600 mt-2 text-center\">\r\n              Deberas iniciar sesion para completar registro.\r\n            </p>\r\n            <div className=\"flex gap-3 mt-5\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setShowExitConfirm(false)}\r\n                className=\"flex-1 py-2.5 rounded-lg border border-gray-300 text-gray-600 font-semibold\"\r\n              >\r\n                Cancelar\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleOwnerExit}\r\n                className=\"flex-1 py-2.5 rounded-lg font-semibold bg-[#5E30A5] text-white shadow\"\r\n              >\r\n                Aceptar\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </AuthView>\r\n  );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\AuthView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\AuthBranderHeader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\AuthCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\AuthFooter.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\AuthHeader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\AuthTabs.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\BackButton.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\ContactPhoneBlock.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\EmailPasswordForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\EmailVerificationBlock.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\ErrorBanner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\OAuthButtons.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onApple' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":10,"suggestions":[{"messageId":"removeVar","data":{"varName":"onApple"},"fix":{"range":[95,107],"text":""},"desc":"Remove unused variable 'onApple'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":50,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1160,1166],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\n\r\nexport default function OAuthButtons({\r\n  onGoogle,\r\n  onFacebook,\r\n  onApple,\r\n  onTwitter,\r\n  onDiscord,\r\n  loading,\r\n  oauthLoading,\r\n  oauthProvider,\r\n}) {\r\n  const disableAll = Boolean(loading || oauthLoading);\r\n  const buttons = [\r\n    {\r\n      key: \"google\",\r\n      label: \"Continuar con Google\",\r\n      onClick: onGoogle,\r\n      Icon: GoogleIcon,\r\n    },\r\n    {\r\n      key: \"facebook\",\r\n      label: \"Continuar con Facebook\",\r\n      onClick: onFacebook,\r\n      Icon: FacebookIcon,\r\n    },\r\n    // Apple OAuth se habilitara en futuras versiones.\r\n    // {\r\n    //   key: \"apple\",\r\n    //   label: \"Continuar con Apple\",\r\n    //   onClick: onApple,\r\n    //   Icon: AppleIcon,\r\n    // },\r\n    {\r\n      key: \"x\",\r\n      label: \"Continuar con X\",\r\n      onClick: onTwitter,\r\n      Icon: XIcon,\r\n    },\r\n    {\r\n      key: \"discord\",\r\n      label: \"Continuar con Discord\",\r\n      onClick: onDiscord,\r\n      Icon: DiscordIcon,\r\n    },\r\n  ].filter((btn) => Boolean(btn.onClick));\r\n\r\n  return (\r\n    <div className=\"flex items-center justify-center gap-3 flex-nowrap overflow-x-auto py-1\">\r\n      {buttons.map(({ key, label, onClick, Icon }) => {\r\n        const isBusy =\r\n          (key === \"google\" && loading) ||\r\n          (oauthLoading && oauthProvider === key);\r\n        return (\r\n          <button\r\n            key={key}\r\n            type=\"button\"\r\n            onClick={onClick}\r\n            disabled={disableAll}\r\n            aria-label={label}\r\n            aria-busy={isBusy}\r\n            title={label}\r\n            className={`h-12 w-12 shrink-0 rounded-xl border border-gray-300 bg-white shadow flex items-center justify-center transition-transform ${\r\n              disableAll\r\n                ? \"opacity-60 cursor-not-allowed\"\r\n                : \"active:scale-[0.98]\"\r\n            }`}\r\n          >\r\n            <Icon />\r\n          </button>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction GoogleIcon() {\r\n  return (\r\n    <svg\r\n      aria-hidden=\"true\"\r\n      focusable=\"false\"\r\n      height=\"18\"\r\n      viewBox=\"0 0 18 18\"\r\n      width=\"18\"\r\n    >\r\n      <path\r\n        d=\"M17.64 9.2045c0-.6381-.0573-1.2518-.1636-1.8409H9v3.4814h4.8436c-.2087 1.125-.8427 2.0782-1.7959 2.7164v2.2581h2.9082c1.7018-1.5677 2.6836-3.8745 2.6836-6.6149z\"\r\n        fill=\"#4285F4\"\r\n      />\r\n      <path\r\n        d=\"M9 18c2.43 0 4.4673-.8059 5.9563-2.1818l-2.9082-2.2581c-.8059.54-1.834.8609-3.0481.8609-2.3455 0-4.3309-1.5841-5.0386-3.7105H.957v2.3318C2.4382 15.9836 5.4818 18 9 18z\"\r\n        fill=\"#34A853\"\r\n      />\r\n      <path\r\n        d=\"M3.9614 10.7105c-.18-.54-.2823-1.1172-.2823-1.7105 0-.5936.1023-1.1709.2823-1.7109V4.957H.957C.3473 6.1718 0 7.5473 0 9c0 1.4527.3473 2.8282.957 4.0436l3.0044-2.3331z\"\r\n        fill=\"#FBBC05\"\r\n      />\r\n      <path\r\n        d=\"M9 3.5795c1.3214 0 2.5086.4541 3.4418 1.3459l2.5814-2.5818C13.4673.8577 11.43 0 9 0 5.4818 0 2.4382 2.0168.957 4.9568l3.0044 2.3318C4.6691 5.1636 6.6545 3.5795 9 3.5795z\"\r\n        fill=\"#EA4335\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction FacebookIcon() {\r\n  return (\r\n    <svg\r\n      aria-hidden=\"true\"\r\n      focusable=\"false\"\r\n      height=\"21\"\r\n      viewBox=\"0 0 24 24\"\r\n      width=\"21\"\r\n    >\r\n      <path\r\n        fill=\"#1877F2\"\r\n        d=\"M22 12.07C22 6.48 17.52 2 11.93 2S1.86 6.48 1.86 12.07c0 4.99 3.66 9.13 8.44 9.93v-7.03H7.9v-2.9h2.4V9.62c0-2.38 1.42-3.7 3.6-3.7 1.04 0 2.13.19 2.13.19v2.34h-1.2c-1.18 0-1.55.73-1.55 1.48v1.77h2.64l-.42 2.9h-2.22V22c4.78-.8 8.44-4.94 8.44-9.93z\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction AppleIcon() {\r\n  return (\r\n    <svg\r\n      aria-hidden=\"true\"\r\n      focusable=\"false\"\r\n      height=\"20\"\r\n      viewBox=\"0 0 24 24\"\r\n      width=\"20\"\r\n    >\r\n      <path\r\n        d=\"M16.365 1.43c0 1.14-.48 2.23-1.26 3.05-.84.89-2.21 1.58-3.37 1.48-.1-1.08.43-2.2 1.18-3 .83-.9 2.26-1.53 3.45-1.53z\"\r\n        fill=\"#000\"\r\n      />\r\n      <path\r\n        d=\"M20.39 17.12c-.53 1.21-.78 1.74-1.46 2.83-1 1.57-2.41 3.52-4.17 3.54-1.56.02-1.96-1.02-4.09-1.01-2.13 0-2.58 1.03-4.1 1-1.76-.02-3.1-1.78-4.1-3.34-2.79-4.37-3.08-9.5-1.36-12.17 1.22-1.9 3.15-3.01 4.96-3.01 1.85 0 3.01 1.02 4.54 1.02 1.49 0 2.4-1.02 4.52-1.02 1.61 0 3.32.88 4.54 2.39-3.98 2.18-3.33 8.03 1.72 9.77z\"\r\n        fill=\"#000\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction XIcon() {\r\n  return (\r\n    <svg\r\n      aria-hidden=\"true\"\r\n      focusable=\"false\"\r\n      height=\"18\"\r\n      viewBox=\"0 0 24 24\"\r\n      width=\"18\"\r\n    >\r\n      <path\r\n        d=\"M18.244 2H21l-6.27 7.163L22 22h-5.69l-4.49-6.59L6.16 22H3.39l6.7-7.35L2 2h5.69l4.1 6.08L18.244 2z\"\r\n        fill=\"#000\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction DiscordIcon() {\r\n  return (\r\n    <svg\r\n      aria-hidden=\"true\"\r\n      focusable=\"false\"\r\n      height=\"18\"\r\n      viewBox=\"0 0 24 24\"\r\n      width=\"18\"\r\n    >\r\n      <path\r\n        d=\"M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.078.037c-.211.375-.444.864-.608 1.249a18.147 18.147 0 00-5.487 0 12.505 12.505 0 00-.617-1.249.077.077 0 00-.078-.037 19.736 19.736 0 00-4.885 1.515.07.07 0 00-.032.027C.533 9.046-.32 13.579.099 18.057a.082.082 0 00.031.056 19.911 19.911 0 006.064 3.04.077.077 0 00.084-.027c.467-.64.882-1.312 1.305-2.02a.076.076 0 00-.041-.106 13.106 13.106 0 01-1.888-.9.077.077 0 01-.008-.127c.127-.095.254-.192.371-.291a.074.074 0 01.077-.01c3.927 1.793 8.18 1.793 12.061 0a.074.074 0 01.078.009c.118.1.245.198.372.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.889.899.076.076 0 00-.04.107c.426.707.84 1.38 1.304 2.02a.076.076 0 00.084.028 19.876 19.876 0 006.065-3.04.077.077 0 00.031-.055c.5-5.177-.838-9.673-3.548-13.661a.061.061 0 00-.031-.028zM8.02 15.331c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.418 2.157-2.418 1.21 0 2.174 1.094 2.157 2.418 0 1.334-.955 2.419-2.157 2.419zm7.974 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.418 2.157-2.418 1.21 0 2.174 1.094 2.157 2.418 0 1.334-.946 2.419-2.157 2.419z\"\r\n        fill=\"#5865F2\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\PasswordSetupBlock.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\RoleCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\blocks\\StepProgress.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\constants\\authCopy.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\constants\\authRoles.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\constants\\authSteps.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\constants\\businessCategories.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\useAuthActions.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'goToStep'. Either include it or remove the dependency array. If 'goToStep' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":329,"column":6,"nodeType":"ArrayExpression","endLine":329,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [bootstrapAuth, email, goToStep, setEmailError]","fix":{"range":[10885,10922],"text":"[bootstrapAuth, email, goToStep, setEmailError]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'negocioId' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":714,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":714,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has unnecessary dependencies: 'apellidoDueno', 'isSucursalPrincipal', 'nombreDueno', and 'telefono'. Either exclude them or remove the dependency array.","line":722,"column":6,"nodeType":"ArrayExpression","endLine":733,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [bootstrapAuth, businessPrefill, categoriaNegocio, goToStep, nombreNegocio, setEmailError]","fix":{"range":[23113,23318],"text":"[bootstrapAuth, businessPrefill, categoriaNegocio, goToStep, nombreNegocio, setEmailError]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":793,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":793,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import { useCallback } from \"react\";\r\nimport {\r\n  CODE_RE,\r\n  EMAIL_RE,\r\n  validateEmail,\r\n} from \"../../utils/validators\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport { signInWithOAuth, signInWithGoogleIdToken } from \"../../services/authService\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport { requestGoogleCredential } from \"../../utils/googleOneTap\";\r\nimport { AUTH_STEPS } from \"../constants/authSteps\";\r\nimport {\r\n  buildBirthdateISO,\r\n  getUserProfileStatus,\r\n  normalizeUserName,\r\n} from \"../utils/userProfileUtils\";\r\nimport {\r\n  getBusinessDataStatus,\r\n  normalizeBusinessName,\r\n} from \"../utils/businessDataUtils\";\r\nimport { runValidateRegistration } from \"../../services/registrationClient\";\r\nimport { logCatalogBreadcrumb } from \"../../services/loggingClient\";\r\nimport { toTitleCaseEs } from \"../../utils/textCase\";\r\n\r\nconst OAUTH_INTENT_KEY = \"oauth_intent\";\r\nconst OAUTH_LOGIN_PENDING = \"oauth_login_pending\";\r\nconst GOOGLE_ONE_TAP_CLIENT_ID =\r\n  import.meta.env.VITE_GOOGLE_ONE_TAP_CLIENT_ID ||\r\n  import.meta.env.VITE_GOOGLE_CLIENT_ID;\r\nconst DEFAULT_SUCURSAL_HORARIOS = {\r\n  semanal: {\r\n    lunes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    martes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    miercoles: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    jueves: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    viernes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    sabado: [],\r\n    domingo: [],\r\n  },\r\n  excepciones: [],\r\n};\r\n\r\nconst normalizeNullableString = (value) => {\r\n  const text = String(value ?? \"\").trim();\r\n  return text ? text : null;\r\n};\r\n\r\nconst normalizeNullableNumber = (value) => {\r\n  if (value === null || value === undefined || value === \"\") return null;\r\n  const num = Number(value);\r\n  return Number.isNaN(num) ? null : num;\r\n};\r\n\r\nconst areDireccionesEqual = (current, next) => {\r\n  if (!current || !next) return false;\r\n  return (\r\n    normalizeNullableString(current.owner_id) ===\r\n      normalizeNullableString(next.owner_id) &&\r\n    normalizeNullableString(current.calles) ===\r\n      normalizeNullableString(next.calles) &&\r\n    normalizeNullableString(current.referencia) ===\r\n      normalizeNullableString(next.referencia) &&\r\n    normalizeNullableString(current.ciudad) ===\r\n      normalizeNullableString(next.ciudad) &&\r\n    normalizeNullableString(current.sector) ===\r\n      normalizeNullableString(next.sector) &&\r\n    normalizeNullableString(current.place_id) ===\r\n      normalizeNullableString(next.place_id) &&\r\n    normalizeNullableString(current.label) ===\r\n      normalizeNullableString(next.label) &&\r\n    normalizeNullableString(current.provider) ===\r\n      normalizeNullableString(next.provider) &&\r\n    normalizeNullableString(current.provincia_id) ===\r\n      normalizeNullableString(next.provincia_id) &&\r\n    normalizeNullableString(current.canton_id) ===\r\n      normalizeNullableString(next.canton_id) &&\r\n    normalizeNullableString(current.parroquia_id) ===\r\n      normalizeNullableString(next.parroquia_id) &&\r\n    normalizeNullableString(current.parroquia) ===\r\n      normalizeNullableString(next.parroquia) &&\r\n    normalizeNullableNumber(current.lat) ===\r\n      normalizeNullableNumber(next.lat) &&\r\n    normalizeNullableNumber(current.lng) ===\r\n      normalizeNullableNumber(next.lng) &&\r\n    Boolean(current.is_user_provided) === Boolean(next.is_user_provided)\r\n  );\r\n};\r\n\r\nexport default function useAuthActions({\r\n  email,\r\n  password,\r\n  passwordConfirm,\r\n  telefono,\r\n  nombreDueno,\r\n  apellidoDueno,\r\n  genero,\r\n  fechaNacimiento,\r\n  ownerPrefill,\r\n  businessPrefill,\r\n  nombreNegocio,\r\n  categoriaNegocio,\r\n  isSucursalPrincipal,\r\n  horarios,\r\n  direccionPayload,\r\n  step,\r\n  setEmailError,\r\n  setWelcomeError,\r\n  setLoginLoading,\r\n  setOauthLoading,\r\n  setOauthProvider,\r\n  setWelcomeLoading,\r\n  setStep,\r\n  goToStep,\r\n  onResetToWelcome,\r\n}) {\r\n  const login = useAppStore((s) => s.login);\r\n  const bootstrapAuth = useAppStore((s) => s.bootstrapAuth);\r\n  const setJustCompletedRegistration = useAppStore(\r\n    (s) => s.setJustCompletedRegistration\r\n  );\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n\r\n  const redirectTo =\r\n    (typeof window !== \"undefined\" && `${window.location.origin}/auth`) ||\r\n    import.meta.env.VITE_AUTH_REDIRECT_URL;\r\n\r\n  const resolveClientSteps = useCallback((state = onboarding) => {\r\n    const steps = state?.client_steps || {};\r\n    const profile = steps.profile || {};\r\n    const address = steps.address || {};\r\n    const profileCompleted = Boolean(profile.completed);\r\n    const addressCompleted = Boolean(address.completed);\r\n    const profileSkipped = Boolean(profile.skipped) && !profileCompleted;\r\n    const addressSkipped = Boolean(address.skipped) && !addressCompleted;\r\n    return {\r\n      profilePending: !profileCompleted && !profileSkipped,\r\n      addressPending: !addressCompleted && !addressSkipped,\r\n    };\r\n  }, [onboarding]);\r\n\r\n  const advanceClientFlow = useCallback(async () => {\r\n    await bootstrapAuth({ force: true });\r\n    const nextOnboarding = useAppStore.getState().onboarding;\r\n    const { profilePending, addressPending } = resolveClientSteps(nextOnboarding);\r\n    if (profilePending) {\r\n      goToStep(AUTH_STEPS.USER_PROFILE);\r\n      return;\r\n    }\r\n    if (addressPending) {\r\n      goToStep(AUTH_STEPS.USER_ADDRESS);\r\n    }\r\n  }, [bootstrapAuth, goToStep, resolveClientSteps]);\r\n\r\n  const goToEmailLogin = useCallback(() => {\r\n    setStep(AUTH_STEPS.EMAIL_LOGIN);\r\n    setEmailError(\"\");\r\n  }, [setEmailError, setStep]);\r\n\r\n  const goToEmailRegister = useCallback(() => {\r\n    setStep(AUTH_STEPS.EMAIL_REGISTER);\r\n    setEmailError(\"\");\r\n  }, [setEmailError, setStep]);\r\n\r\n  const validateEmailRegister = useCallback(() => {\r\n    if (!EMAIL_RE.test(email)) {\r\n      setEmailError(\"Email invalido\");\r\n      return false;\r\n    }\r\n    const hasMinLength = password.length >= 8;\r\n    const hasNumber = /\\d/.test(password);\r\n    const hasSymbol = /[^A-Za-z0-9]/.test(password);\r\n    const hasNumberAndSymbol = hasNumber && hasSymbol;\r\n\r\n    if (!hasMinLength) {\r\n      setEmailError(\"La contrasena debe tener al menos 8 caracteres\");\r\n      return false;\r\n    }\r\n    if (!hasNumberAndSymbol) {\r\n      setEmailError(\"Incluye un simbolo y un numero\");\r\n      return false;\r\n    }\r\n    if (password !== passwordConfirm) {\r\n      setEmailError(\"Las contrasenas deben coincidir\");\r\n      return false;\r\n    }\r\n    setEmailError(\"\");\r\n    return true;\r\n  }, [email, password, passwordConfirm, setEmailError]);\r\n\r\n  const handleEmailLogin = useCallback(async () => {\r\n    setEmailError(\"\");\r\n\r\n    if (!email) return setEmailError(\"Ingrese su email\");\r\n    if (!validateEmail(email)) return setEmailError(\"Formato de email invÃ¡lido\");\r\n    if (!password) return setEmailError(\"Ingrese su contraseÃ±a\");\r\n\r\n    setLoginLoading(true);\r\n    const result = await login(email, password);\r\n    setLoginLoading(false);\r\n\r\n    if (!result.ok) {\r\n      const msg = (result.error || \"\").toLowerCase();\r\n\r\n      //UX especÃ‡Ã°fica: cuenta creada con Oauth\r\n      if (\r\n        msg.includes(\"invalid\") ||\r\n        msg.includes(\"credentials\") ||\r\n        msg.includes(\"password\")\r\n      ) {\r\n        const { data: oauthUser } = await supabase\r\n          .from(\"usuarios\")\r\n          .select(\"id_auth\")\r\n          .eq(\"email\", email)\r\n          .maybeSingle();\r\n\r\n        if (oauthUser) {\r\n          setEmailError(\"Esta Cuenta fue creada con Google. Inicia sesiÃ³n con Google para continuar\");\r\n          return;\r\n        }\r\n      }\r\n\r\n      setEmailError(result.error || \"Email o contrasena incorrectos\");\r\n      return;\r\n    }\r\n  }, [email, password, login, setEmailError, setLoginLoading]);\r\n\r\n  const createClienteProfile = useCallback(async () => {\r\n    setEmailError(\"\");\r\n\r\n    const session = (await supabase.auth.getSession()).data.session;\r\n    if (!session?.user) {\r\n      setEmailError(\"Sesion no valida\");\r\n      return { ok: false };\r\n    }\r\n    const authEmail = session.user.email || email;\r\n    if (!authEmail) {\r\n      setEmailError(\"No se pudo obtener el email de la cuenta\");\r\n      return { ok: false };\r\n    }\r\n\r\n    //Crear perfil si no existe, o actualizar si ya existe\r\n    const { data: existing, error: exErr } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"*\")\r\n      .eq(\"id_auth\", session.user.id)\r\n      .maybeSingle();\r\n    if (exErr) {\r\n      setEmailError(exErr.message || \"No se puede leer perfil\");\r\n      return { ok: false };\r\n    }\r\n\r\n    //Crear perfil cliente solo si no tenia rol\r\n    if (!existing?.role) {\r\n      const { error } = await supabase\r\n        .from(\"usuarios\")\r\n        .insert({\r\n          id_auth: session.user.id,\r\n          email: authEmail,\r\n          nombre: authEmail.split(\"@\")[0],\r\n          role: \"cliente\",\r\n          telefono: telefono || null,\r\n          account_status: \"active\",\r\n        })\r\n        .select()\r\n        .maybeSingle();\r\n      if (error) {\r\n        setEmailError(error.message || \"Error al crear perfil\");\r\n        return { ok: false };\r\n      }\r\n    }\r\n\r\n    await bootstrapAuth({ force: true });\r\n    return { ok: true };\r\n  }, [bootstrapAuth, email, setEmailError, telefono]);\r\n\r\n  const createNegocioProfile = useCallback(async ({\r\n    bootstrap = true,\r\n    silent = false,\r\n  } = {}) => {\r\n    const reportError = silent ? () => {} : setEmailError;\r\n    reportError(\"\");\r\n\r\n    const session = (await supabase.auth.getSession()).data.session;\r\n    if (!session?.user) {\r\n      reportError(\"Sesion no valida\");\r\n      return { ok: false, error: \"Sesion no valida\" };\r\n    }\r\n    const authEmail = session.user.email || email;\r\n    if (!authEmail) {\r\n      reportError(\"No se pudo obtener el email de la cuenta\");\r\n      return { ok: false, error: \"No se pudo obtener el email de la cuenta\" };\r\n    }\r\n\r\n    //Crear o actualizar perfil de negocio (solo si no tenia rol)\r\n    const { data: existing, error: exErr } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"*\")\r\n      .eq(\"id_auth\", session.user.id)\r\n      .maybeSingle();\r\n    if (exErr) {\r\n      reportError(exErr.message || \"No se pudo leer perfil\");\r\n      return { ok: false, error: exErr.message || \"No se pudo leer perfil\" };\r\n    }\r\n\r\n    //Crear perfil negocio solo si no tenia rol\r\n    if (!existing?.role) {\r\n      const { error } = await supabase\r\n        .from(\"usuarios\")\r\n        .insert({\r\n          id_auth: session.user.id,\r\n          email: authEmail,\r\n          role: \"negocio\",\r\n          account_status: \"pending\",\r\n        })\r\n        .select()\r\n        .maybeSingle();\r\n      if (error) {\r\n        reportError(error.message || \"Error al crear perfil\");\r\n        return { ok: false, error: error.message || \"Error al crear perfil\" };\r\n      }\r\n    }\r\n\r\n    if (bootstrap) {\r\n      await bootstrapAuth({ force: true });\r\n      goToStep(AUTH_STEPS.USER_PROFILE);\r\n    }\r\n    return { ok: true };\r\n  }, [bootstrapAuth, email, setEmailError]);\r\n\r\n  const handleRoleSelect = useCallback(\r\n    async (role) => {\r\n      if (role === \"cliente\") {\r\n        return createClienteProfile();\r\n      }\r\n      if (role === \"negocio\") {\r\n        return createNegocioProfile();\r\n      }\r\n      return { ok: false };\r\n    },\r\n    [createClienteProfile, createNegocioProfile]\r\n  );\r\n\r\n  const validateNegocioCode = useCallback(\r\n    async (codeRaw) => {\r\n      const code = String(codeRaw || \"\").trim().toUpperCase();\r\n      if (!CODE_RE.test(code)) {\r\n        return { ok: false, error: \"Codigo de registro invalido\" };\r\n      }\r\n\r\n      const session = (await supabase.auth.getSession()).data.session;\r\n      if (!session?.access_token) {\r\n        return { ok: false, error: \"No hay sesion activa\" };\r\n      }\r\n\r\n      const { data: validation, error: validationError } =\r\n        await supabase.functions.invoke(\"validate-registration-code\", {\r\n          headers: {\r\n            Authorization: `Bearer ${session.access_token}`,\r\n          },\r\n          body: {\r\n            code,\r\n            expected_role: \"negocio\",\r\n            consume: false,\r\n          },\r\n        });\r\n\r\n      if (validationError) {\r\n        return {\r\n          ok: false,\r\n          error: validationError.message || \"No se pudo validar el codigo\",\r\n        };\r\n      }\r\n\r\n      if (!validation?.ok || !validation?.valid) {\r\n        const reason = validation?.reason;\r\n        const message =\r\n          reason === \"revoked\"\r\n            ? \"Codigo revocado\"\r\n            : reason === \"used\"\r\n              ? \"Codigo ya utilizado\"\r\n              : reason === \"expired\"\r\n                ? \"Codigo expirado\"\r\n                : reason === \"role_mismatch\"\r\n                  ? \"Codigo no valido para negocio\"\r\n                  : \"Codigo de registro invalido\";\r\n        return { ok: false, error: message };\r\n      }\r\n\r\n      const created = await createNegocioProfile({\r\n        bootstrap: false,\r\n        silent: true,\r\n      });\r\n      if (!created.ok) {\r\n        return {\r\n          ok: false,\r\n          error: created.error || \"No se pudo crear el perfil de negocio\",\r\n        };\r\n      }\r\n\r\n      const { data: consumed, error: consumeError } =\r\n        await supabase.functions.invoke(\"validate-registration-code\", {\r\n          headers: {\r\n            Authorization: `Bearer ${session.access_token}`,\r\n          },\r\n          body: {\r\n            code,\r\n            expected_role: \"negocio\",\r\n            consume: true,\r\n          },\r\n        });\r\n\r\n      if (consumeError) {\r\n        return {\r\n          ok: false,\r\n          error: consumeError.message || \"No se pudo consumir el codigo\",\r\n        };\r\n      }\r\n\r\n      if (!consumed?.ok || !consumed?.valid) {\r\n        return { ok: false, error: \"No se pudo consumir el codigo\" };\r\n      }\r\n\r\n      return { ok: true };\r\n    },\r\n    [createNegocioProfile]\r\n  );\r\n\r\n  const handleEmailRegister = useCallback(async () => {\r\n    if (!validateEmailRegister()) return;\r\n    setEmailError(\"\");\r\n    logCatalogBreadcrumb(\"auth.signup.start\", {\r\n      method: \"auth_flow_email_register\",\r\n    });\r\n\r\n    try {\r\n      //Crear SOLO la cuenta Auth (sin perfil)\r\n      const { data, error } = await supabase.auth.signUp({\r\n        email,\r\n        password,\r\n      });\r\n\r\n      if (error) {\r\n        const msg = error.message?.toLowerCase() || \"\";\r\n        logCatalogBreadcrumb(\"auth.signup.error\", {\r\n          method: \"auth_flow_email_register\",\r\n          error: error.message || \"signup_failed\",\r\n        });\r\n        if (msg.includes(\"ya existe\") || msg.includes(\"already\") || msg.includes(\"exists\")) {\r\n          setEmailError(\"Esta cuenta ya existe. Si la creaste con Google, usa Google para continuar.\");\r\n          if (onResetToWelcome) {\r\n            onResetToWelcome();\r\n            return;\r\n          }\r\n          goToEmailLogin();\r\n          return;\r\n        }\r\n        setEmailError(error.message);\r\n        return;\r\n      }\r\n\r\n      //Asegurar sesion activa\r\n      const session = data?.session ?? (await supabase.auth.getSession()).data.session;\r\n      if (!session?.user) {\r\n        logCatalogBreadcrumb(\"auth.signup.error\", {\r\n          method: \"auth_flow_email_register\",\r\n          error: \"signup_session_missing\",\r\n        });\r\n        setEmailError(\"No se pudo iniciar la sesion\");\r\n        return;\r\n      }\r\n\r\n      const boot = await bootstrapAuth({ force: true });\r\n      if (!boot.ok) {\r\n        logCatalogBreadcrumb(\"auth.signup.error\", {\r\n          method: \"auth_flow_email_register\",\r\n          error: boot.error || \"bootstrap_failed\",\r\n        });\r\n        setEmailError(boot.error || \"No se pudo validar onboarding\");\r\n        return;\r\n      }\r\n      logCatalogBreadcrumb(\"auth.signup.ok\", {\r\n        method: \"auth_flow_email_register\",\r\n      });\r\n\r\n    } catch (err) {\r\n      logCatalogBreadcrumb(\"auth.signup.error\", {\r\n        method: \"auth_flow_email_register\",\r\n        error: err?.message || \"signup_exception\",\r\n      });\r\n      setEmailError(err?.message || \"Error al crear la cuenta\");\r\n    }\r\n  }, [\r\n    email,\r\n    onResetToWelcome,\r\n    password,\r\n    bootstrapAuth,\r\n    setEmailError,\r\n    goToEmailLogin,\r\n    validateEmailRegister,\r\n  ]);\r\n\r\n  const handleUserProfile = useCallback(async () => {\r\n    const role = usuario?.role || onboarding?.usuario?.role;\r\n    const profileStatus = getUserProfileStatus({\r\n      nombre: nombreDueno,\r\n      apellido: apellidoDueno,\r\n      genero,\r\n      fechaNacimiento,\r\n      minAge: role === \"cliente\" ? 16 : 18,\r\n    });\r\n    if (!profileStatus.nombre.trim()) return setEmailError(\"Ingrese nombres\");\r\n    if (!profileStatus.apellido.trim()) return setEmailError(\"Ingrese apellidos\");\r\n    if (!profileStatus.genero.trim()) return setEmailError(\"Selecciona un género\");\r\n    if (!profileStatus.birthStatus.isValid) {\r\n      return setEmailError(\"Ingrese una fecha de nacimiento válida\");\r\n    }\r\n    setEmailError(\"\");\r\n\r\n    const prefillNombre = normalizeUserName(ownerPrefill?.nombre || \"\");\r\n    const prefillApellido = normalizeUserName(ownerPrefill?.apellido || \"\");\r\n    const prefillFecha = ownerPrefill?.fechaNacimiento || \"\";\r\n    const prefillGenero = ownerPrefill?.genero || \"\";\r\n    const unchanged =\r\n      profileStatus.nombre === prefillNombre &&\r\n      profileStatus.apellido === prefillApellido &&\r\n      (fechaNacimiento || \"\") === prefillFecha &&\r\n      profileStatus.genero === prefillGenero;\r\n\r\n    const session = (await supabase.auth.getSession()).data.session;\r\n    if (!session?.user) {\r\n      setEmailError(\"No hay sesion activa\");\r\n      return;\r\n    }\r\n    const { data: existing, error: exErr } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"*\")\r\n      .eq(\"id_auth\", session.user.id)\r\n      .maybeSingle();\r\n    if (exErr) {\r\n      setEmailError(exErr.message || \"No se pudo leer perfil\");\r\n      return;\r\n    }\r\n    if (!existing?.role) {\r\n      setEmailError(\"Primero debes seleccionar tipo de cuenta\");\r\n      return;\r\n    }\r\n    if (existing.role !== \"negocio\" && existing.role !== \"cliente\") {\r\n      setEmailError(\"Tu cuenta no es valida\");\r\n      return;\r\n    }\r\n\r\n    const underageMessage =\r\n      existing.role === \"negocio\"\r\n        ? \"Tienes que ser mayor de edad para ser el administrador de un negocio\"\r\n        : \"Debes tener al menos 16 años para usar la app.\";\r\n    if (profileStatus.birthStatus.isUnderage) {\r\n      return setEmailError(underageMessage);\r\n    }\r\n\r\n    const shouldUpdateProfile =\r\n      !unchanged || Boolean(existing.cliente_profile_skipped);\r\n\r\n    if (!shouldUpdateProfile) {\r\n      if (existing.role === \"negocio\") {\r\n        goToStep(AUTH_STEPS.BUSINESS_DATA);\r\n        return;\r\n      }\r\n      await advanceClientFlow();\r\n      return;\r\n    }\r\n\r\n    const birthdateIso = buildBirthdateISO(fechaNacimiento);\r\n    const updatePayload = {\r\n      nombre: profileStatus.nombre,\r\n      apellido: profileStatus.apellido,\r\n      genero: profileStatus.genero,\r\n      fecha_nacimiento: birthdateIso,\r\n    };\r\n    if (existing.role === \"cliente\") {\r\n      updatePayload.cliente_profile_skipped = false;\r\n    }\r\n    const { error } = await supabase\r\n      .from(\"usuarios\")\r\n      .update(updatePayload)\r\n      .eq(\"id_auth\", session.user.id);\r\n\r\n    if (error) {\r\n      setEmailError(error.message || \"No se pudo guardar datos del usuario\");\r\n      return;\r\n    }\r\n\r\n    if (existing.role === \"negocio\") {\r\n      await bootstrapAuth({ force: true });\r\n      goToStep(AUTH_STEPS.BUSINESS_DATA);\r\n      return;\r\n    }\r\n    await advanceClientFlow();\r\n  }, [\r\n    apellidoDueno,\r\n    advanceClientFlow,\r\n    bootstrapAuth,\r\n    fechaNacimiento,\r\n    genero,\r\n    goToStep,\r\n    nombreDueno,\r\n    onboarding?.usuario?.role,\r\n    ownerPrefill,\r\n    setEmailError,\r\n    usuario?.role,\r\n  ]);\r\n\r\n  const handleBusinessData = useCallback(async () => {\r\n    try {\r\n      const businessStatus = getBusinessDataStatus({\r\n        nombreNegocio,\r\n        ruc: \"\",\r\n        categoriaNegocio,\r\n      });\r\n      if (!businessStatus.nombre.trim()) {\r\n        setEmailError(\"Ingresa el nombre del negocio\");\r\n        return;\r\n      }\r\n      if (!businessStatus.categoria) {\r\n        setEmailError(\"Selecciona una categoria\");\r\n        return;\r\n      }\r\n      setEmailError(\"\");\r\n\r\n      const prefillNombre = normalizeBusinessName(\r\n        businessPrefill?.nombreNegocio || \"\"\r\n      );\r\n      const prefillCategoria = String(\r\n        businessPrefill?.categoriaNegocio || \"\"\r\n      ).trim();\r\n      const unchanged =\r\n        businessStatus.nombre === prefillNombre &&\r\n        businessStatus.categoria === prefillCategoria;\r\n\r\n      const session = (await supabase.auth.getSession())?.data?.session;\r\n      const userId = session?.user?.id;\r\n      if (!userId || !session?.access_token) {\r\n        setEmailError(\"No hay sesion activa. Inicia sesiÃ³n y vuelve a intentar.\");\r\n        return;\r\n      }\r\n\r\n      //Obtener perfil actual\r\n      const { data: userRow, error: userErr } = await supabase\r\n        .from(\"usuarios\")\r\n        .select(\"*\")\r\n        .eq(\"id_auth\", userId)\r\n        .order(\"id\", { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n\r\n      if (userErr) {\r\n        setEmailError(userErr.message || \"No se pudo leer el perfil\");\r\n        return;\r\n      }\r\n      if (!userRow) {\r\n        setEmailError(\"Falta crear el perfil de usuario antes de registrar el negocio\");\r\n        return;\r\n      }\r\n      if (userRow.role !== \"negocio\") {\r\n        setEmailError(\"Tu cuenta no es de negocio\");\r\n        return;\r\n      }\r\n\r\n      const { data: existingNeg, error: negReadErr } = await supabase\r\n        .from(\"negocios\")\r\n        .select(\"*\")\r\n        .eq(\"usuarioid\", userRow.id)\r\n        .order(\"id\", { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle();\r\n      if (negReadErr) {\r\n        setEmailError(negReadErr.message || \"No se pudo leer el negocio\");\r\n        return;\r\n      }\r\n\r\n      const negocioPayload = {\r\n        usuarioid: userRow.id,\r\n        nombre: businessStatus.nombre || existingNeg?.nombre || \"Nombre Local\",\r\n        categoria: businessStatus.categoria || existingNeg?.categoria || null,\r\n      };\r\n\r\n      //Crear/actualizar negocio\r\n      let negocioId = existingNeg?.id || null;\r\n\r\n      if (existingNeg && !unchanged) {\r\n        const { data: updatedNeg, error } = await supabase\r\n          .from(\"negocios\")\r\n          .update(negocioPayload)\r\n          .eq(\"id\", existingNeg.id)\r\n          .select(\"id\")\r\n          .maybeSingle();\r\n        if (error) throw error;\r\n        if (!updatedNeg) {\r\n          setEmailError(\"No se pudo actualizar el negocio\");\r\n          return;\r\n        }\r\n        negocioId = updatedNeg.id;\r\n      } else if (!existingNeg) {\r\n        const { data: createdNeg, error } = await supabase\r\n          .from(\"negocios\")\r\n          .insert(negocioPayload)\r\n          .select(\"id\")\r\n          .maybeSingle();\r\n        if (error) throw error;\r\n        if (!createdNeg) {\r\n          setEmailError(\"No se pudo crear el negocio\");\r\n          return;\r\n        }\r\n        negocioId = createdNeg.id;\r\n      }\r\n\r\n      await bootstrapAuth({ force: true });\r\n      goToStep(AUTH_STEPS.USER_ADDRESS);\r\n    } catch (err) {\r\n      setEmailError(err?.message || \"Error al registrar negocio\");\r\n    }\r\n  }, [\r\n    apellidoDueno,\r\n    bootstrapAuth,\r\n    businessPrefill,\r\n    categoriaNegocio,\r\n    isSucursalPrincipal,\r\n    goToStep,\r\n    nombreDueno,\r\n    nombreNegocio,\r\n    setEmailError,\r\n    telefono,\r\n  ]);\r\n\r\n  const startOAuth = useCallback(async (provider) => {\r\n    setEmailError(\"\");\r\n    setOauthProvider(provider);\r\n    setOauthLoading(true);\r\n\r\n    try {\r\n      await signInWithOAuth(provider, { redirectTo });\r\n    } catch (err) {\r\n      localStorage.removeItem(OAUTH_INTENT_KEY);\r\n      setEmailError(err?.message || \"No se pudo iniciar sesiÃ‡Ã¼n\");\r\n      setOauthLoading(false);\r\n      setOauthProvider(null);\r\n    }\r\n  }, [redirectTo, setEmailError, setOauthLoading, setOauthProvider]);\r\n\r\n  const startGoogleOAuth = useCallback(() => startOAuth(\"google\"), [startOAuth]);\r\n  const startFacebookOAuth = useCallback(() => startOAuth(\"facebook\"), [startOAuth]);\r\n  const startAppleOAuth = useCallback(() => startOAuth(\"apple\"), [startOAuth]);\r\n  const startTwitterOAuth = useCallback(() => startOAuth(\"x\"), [startOAuth]);\r\n  const startDiscordOAuth = useCallback(() => startOAuth(\"discord\"), [startOAuth]);\r\n\r\n  const startGoogleOneTap = useCallback(async () => {\r\n    setWelcomeError(\"\");\r\n    setWelcomeLoading(true);\r\n    const fallbackToOAuth = async () => {\r\n      try {\r\n        await signInWithOAuth(\"google\", { redirectTo });\r\n        return true;\r\n      } catch (err) {\r\n        setWelcomeError(err?.message || \"No se pudo iniciar con Google\");\r\n        return false;\r\n      }\r\n    };\r\n\r\n    if (!GOOGLE_ONE_TAP_CLIENT_ID) {\r\n      await fallbackToOAuth();\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await requestGoogleCredential({\r\n        clientId: GOOGLE_ONE_TAP_CLIENT_ID,\r\n      });\r\n\r\n      if (!result || result.type !== \"credential\") {\r\n        const redirected = await fallbackToOAuth();\r\n        if (!redirected) {\r\n          setWelcomeError(\"No se pudo iniciar con Google. Intenta de nuevo o usa el acceso manual.\");\r\n        }\r\n        return;\r\n      }\r\n\r\n      localStorage.setItem(OAUTH_LOGIN_PENDING, JSON.stringify({ ts: Date.now() }));\r\n      await signInWithGoogleIdToken({\r\n        token: result.credential,\r\n      });\r\n\r\n      await bootstrapAuth({ force: true });\r\n    } catch (err) {\r\n      const redirected = await fallbackToOAuth();\r\n      if (!redirected) {\r\n        setWelcomeError(\"No se pudo iniciar con Google. Intenta de nuevo o usa el acceso manual.\");\r\n      }\r\n    } finally {\r\n      setWelcomeLoading(false);\r\n    }\r\n  }, [bootstrapAuth, redirectTo, setWelcomeError, setWelcomeLoading]);\r\n\r\n  const startFacebookOneTap = useCallback(() => {}, []);\r\n\r\n  const skipUserProfile = useCallback(async () => {\r\n    setEmailError(\"\");\r\n    const session = (await supabase.auth.getSession())?.data?.session;\r\n    if (!session?.user) {\r\n      setEmailError(\"No hay sesion activa\");\r\n      return;\r\n    }\r\n    const { error } = await supabase\r\n      .from(\"usuarios\")\r\n      .update({ cliente_profile_skipped: true })\r\n      .eq(\"id_auth\", session.user.id);\r\n    if (error) {\r\n      setEmailError(error.message || \"No se pudo omitir el paso\");\r\n      return;\r\n    }\r\n    await advanceClientFlow();\r\n  }, [advanceClientFlow, setEmailError]);\r\n\r\n  const skipUserAddress = useCallback(async () => {\r\n    setEmailError(\"\");\r\n    const session = (await supabase.auth.getSession())?.data?.session;\r\n    if (!session?.user) {\r\n      setEmailError(\"No hay sesion activa\");\r\n      return;\r\n    }\r\n    const { error } = await supabase\r\n      .from(\"usuarios\")\r\n      .update({ cliente_address_skipped: true })\r\n      .eq(\"id_auth\", session.user.id);\r\n    if (error) {\r\n      setEmailError(error.message || \"No se pudo omitir el paso\");\r\n      return;\r\n    }\r\n    await advanceClientFlow();\r\n  }, [advanceClientFlow, setEmailError]);\r\n\r\n  const handleClientAddress = useCallback(async () => {\r\n    setEmailError(\"\");\r\n    const placeId = String(direccionPayload?.place_id || \"\").trim();\r\n    const label = toTitleCaseEs(String(direccionPayload?.label || \"\").trim());\r\n    const provider = String(direccionPayload?.provider || \"\").trim();\r\n    const provinciaId = String(direccionPayload?.provincia_id || \"\").trim();\r\n    const cantonId = String(direccionPayload?.canton_id || \"\").trim();\r\n    const parroquiaId = String(direccionPayload?.parroquia_id || \"\").trim();\r\n    const latValue = direccionPayload?.lat ?? null;\r\n    const lngValue = direccionPayload?.lng ?? null;\r\n    if (!placeId || !label) {\r\n      setEmailError(\"Selecciona una direcciÃƒÂ³n de la lista\");\r\n      return;\r\n    }\r\n\r\n    const calles = toTitleCaseEs(String(direccionPayload?.calles || \"\").trim());\r\n    const ciudad = toTitleCaseEs(String(direccionPayload?.ciudad || \"\").trim());\r\n    const sector = toTitleCaseEs(String(direccionPayload?.sector || \"\").trim());\r\n    const referencia = String(direccionPayload?.referencia || \"\").trim();\r\n    const parroquiaText = toTitleCaseEs(\r\n      String(direccionPayload?.parroquia || \"\").trim()\r\n    );\r\n\r\n    if (latValue == null || lngValue == null) {\r\n      setEmailError(\"Selecciona una direcciÃƒÂ³n vÃƒÂ¡lida\");\r\n      return;\r\n    }\r\n\r\n    const session = (await supabase.auth.getSession())?.data?.session;\r\n    const userId = session?.user?.id;\r\n    if (!userId) {\r\n      setEmailError(\"No hay sesiÃƒÂ³n activa. Inicia sesiÃƒÂ³n y vuelve a intentar.\");\r\n      return;\r\n    }\r\n\r\n    const { data: userRow, error: userErr } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"id, role\")\r\n      .eq(\"id_auth\", userId)\r\n      .maybeSingle();\r\n\r\n    if (userErr || !userRow) {\r\n      setEmailError(userErr?.message || \"No se pudo leer el perfil\");\r\n      return;\r\n    }\r\n    if (userRow.role !== \"cliente\") {\r\n      setEmailError(\"Tu cuenta no es de cliente\");\r\n      return;\r\n    }\r\n\r\n    const direccionData = {\r\n      owner_id: userRow.id,\r\n      calles: calles || null,\r\n      referencia: referencia || null,\r\n      ciudad: ciudad || null,\r\n      sector: sector || null,\r\n      lat: Number(latValue),\r\n      lng: Number(lngValue),\r\n      place_id: placeId,\r\n      label,\r\n      provider: provider || null,\r\n      provincia_id: provinciaId || null,\r\n      canton_id: cantonId || null,\r\n      parroquia_id: parroquiaId || null,\r\n      parroquia: parroquiaId ? null : (parroquiaText || null),\r\n      is_user_provided: true,\r\n    };\r\n\r\n    const { data: existingDir, error: existingErr } = await supabase\r\n      .from(\"direcciones\")\r\n      .select(\r\n        \"id, owner_id, calles, referencia, ciudad, sector, lat, lng, place_id, label, provider, provincia_id, canton_id, parroquia_id, parroquia, is_user_provided\"\r\n      )\r\n      .eq(\"owner_id\", userRow.id)\r\n      .eq(\"is_user_provided\", true)\r\n      .order(\"updated_at\", { ascending: false })\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(1)\r\n      .maybeSingle();\r\n\r\n    if (existingErr) {\r\n      setEmailError(existingErr.message || \"No se pudo leer la direccion\");\r\n      return;\r\n    }\r\n\r\n    if (existingDir?.id) {\r\n      const needsUpdate = !areDireccionesEqual(existingDir, direccionData);\r\n      if (needsUpdate) {\r\n        const { error: dirErr } = await supabase\r\n          .from(\"direcciones\")\r\n          .update(direccionData)\r\n          .eq(\"id\", existingDir.id);\r\n        if (dirErr) {\r\n          setEmailError(dirErr.message || \"No se pudo actualizar la direccion\");\r\n          return;\r\n        }\r\n      }\r\n    } else {\r\n      const { error: dirErr } = await supabase\r\n        .from(\"direcciones\")\r\n        .insert(direccionData)\r\n        .select(\"id\")\r\n        .maybeSingle();\r\n      if (dirErr) {\r\n        setEmailError(dirErr.message || \"No se pudo guardar la direccion\");\r\n        return;\r\n      }\r\n    }\r\n\r\n    const { error: skipErr } = await supabase\r\n      .from(\"usuarios\")\r\n      .update({ cliente_address_skipped: false })\r\n      .eq(\"id_auth\", userId);\r\n    if (skipErr) {\r\n      setEmailError(skipErr.message || \"No se pudo actualizar el perfil\");\r\n      return;\r\n    }\r\n\r\n    await advanceClientFlow();\r\n  }, [advanceClientFlow, direccionPayload, setEmailError]);\r\n\r\n  const handleBusinessAddress = useCallback(async () => {\r\n    setEmailError(\"\");\r\n    const placeId = String(direccionPayload?.place_id || \"\").trim();\r\n    const label = toTitleCaseEs(String(direccionPayload?.label || \"\").trim());\r\n    const provider = String(direccionPayload?.provider || \"\").trim();\r\n    const provinciaId = String(direccionPayload?.provincia_id || \"\").trim();\r\n    const cantonId = String(direccionPayload?.canton_id || \"\").trim();\r\n    const parroquiaId = String(direccionPayload?.parroquia_id || \"\").trim();\r\n    const latValue = direccionPayload?.lat ?? null;\r\n    const lngValue = direccionPayload?.lng ?? null;\r\n    if (!placeId || !label) {\r\n      setEmailError(\"Selecciona una direcciÃ³n de la lista\");\r\n      return;\r\n    }\r\n\r\n    const calles = toTitleCaseEs(String(direccionPayload?.calles || \"\").trim());\r\n    const ciudad = toTitleCaseEs(String(direccionPayload?.ciudad || \"\").trim());\r\n    const sector = toTitleCaseEs(String(direccionPayload?.sector || \"\").trim());\r\n    const referencia = String(direccionPayload?.referencia || \"\").trim();\r\n    const parroquiaText = toTitleCaseEs(\r\n      String(direccionPayload?.parroquia || \"\").trim()\r\n    );\r\n\r\n    if (latValue == null || lngValue == null) {\r\n      setEmailError(\"Selecciona una direcciÃ³n vÃ¡lida\");\r\n      return;\r\n    }\r\n\r\n    const session = (await supabase.auth.getSession())?.data?.session;\r\n    const userId = session?.user?.id;\r\n    if (!userId) {\r\n      setEmailError(\"No hay sesiÃ³n activa. Inicia sesiÃ³n y vuelve a intentar.\");\r\n      return;\r\n    }\r\n\r\n    const { data: userRow, error: userErr } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"id, role\")\r\n      .eq(\"id_auth\", userId)\r\n      .maybeSingle();\r\n\r\n    if (userErr || !userRow) {\r\n      setEmailError(userErr?.message || \"No se pudo leer el perfil\");\r\n      return;\r\n    }\r\n    if (userRow.role !== \"negocio\") {\r\n      setEmailError(\"Tu cuenta no es de negocio\");\r\n      return;\r\n    }\r\n\r\n    const { data: negocioRow, error: negErr } = await supabase\r\n      .from(\"negocios\")\r\n      .select(\"id\")\r\n      .eq(\"usuarioid\", userRow.id)\r\n      .maybeSingle();\r\n\r\n    if (negErr || !negocioRow) {\r\n      setEmailError(negErr?.message || \"No se pudo leer el negocio\");\r\n      return;\r\n    }\r\n\r\n    const { data: sucursales, error: sucErr } = await supabase\r\n      .from(\"sucursales\")\r\n      .select(\"id, direccion_id, status, tipo, fechacreacion\")\r\n      .eq(\"negocioid\", negocioRow.id)\r\n      .order(\"fechacreacion\", { ascending: false });\r\n\r\n    if (sucErr) {\r\n      setEmailError(sucErr.message || \"No se pudo leer sucursales\");\r\n      return;\r\n    }\r\n\r\n    const allSucursales = Array.isArray(sucursales) ? sucursales : [];\r\n    const draftSucursal = allSucursales.find(\r\n      (row) => String(row.status || \"draft\").toLowerCase() === \"draft\"\r\n    );\r\n    const targetSucursal = draftSucursal || allSucursales[0] || null;\r\n    let ensuredSucursal = targetSucursal;\r\n\r\n    const direccionData = {\r\n      owner_id: userRow.id,\r\n      calles: calles || null,\r\n      referencia: referencia || null,\r\n      ciudad: ciudad || null,\r\n      sector: sector || null,\r\n      lat: Number(latValue),\r\n      lng: Number(lngValue),\r\n      place_id: placeId,\r\n      label,\r\n      provider: provider || null,\r\n      provincia_id: provinciaId || null,\r\n      canton_id: cantonId || null,\r\n      parroquia_id: parroquiaId || null,\r\n      parroquia: parroquiaId ? null : (parroquiaText || null),\r\n      is_user_provided: true,\r\n    };\r\n\r\n    let direccionId = ensuredSucursal?.direccion_id || null;\r\n\r\n\r\n    if (direccionId) {\r\n      const { data: existingDir, error: existingDirErr } = await supabase\r\n        .from(\"direcciones\")\r\n        .select(\r\n          \"id, owner_id, calles, referencia, ciudad, sector, lat, lng, place_id, label, provider, provincia_id, canton_id, parroquia_id, parroquia, is_user_provided\"\r\n        )\r\n        .eq(\"id\", direccionId)\r\n        .maybeSingle();\r\n\r\n      if (existingDirErr) {\r\n        setEmailError(existingDirErr.message || \"No se pudo leer la direccion\");\r\n        return;\r\n      }\r\n\r\n      const needsUpdate = !areDireccionesEqual(existingDir, direccionData);\r\n      if (needsUpdate) {\r\n        const { error: dirErr } = await supabase\r\n          .from(\"direcciones\")\r\n          .update(direccionData)\r\n          .eq(\"id\", direccionId);\r\n        if (dirErr) {\r\n          setEmailError(dirErr.message || \"No se pudo actualizar la direccion\");\r\n          return;\r\n        }\r\n      }\r\n    } else {\r\n      const linkedDireccionIds = allSucursales\r\n        .map((row) => row.direccion_id)\r\n        .filter(Boolean);\r\n      if (ensuredSucursal?.direccion_id) {\r\n        linkedDireccionIds.push(ensuredSucursal.direccion_id);\r\n      }\r\n\r\n      let existingFreeDir = null;\r\n      let existingFreeErr = null;\r\n      if (linkedDireccionIds.length > 0) {\r\n        const { data, error } = await supabase\r\n          .from(\"direcciones\")\r\n          .select(\r\n            \"id, owner_id, calles, referencia, ciudad, sector, lat, lng, place_id, label, provider, provincia_id, canton_id, parroquia_id, parroquia, is_user_provided, created_at\"\r\n          )\r\n          .eq(\"owner_id\", userRow.id)\r\n          .eq(\"is_user_provided\", true)\r\n          .not(\"id\", \"in\", `(${linkedDireccionIds.join(\",\")})`)\r\n          .order(\"created_at\", { ascending: false })\r\n          .limit(1)\r\n          .maybeSingle();\r\n        existingFreeDir = data || null;\r\n        existingFreeErr = error || null;\r\n      } else {\r\n        const { data, error } = await supabase\r\n          .from(\"direcciones\")\r\n          .select(\r\n            \"id, owner_id, calles, referencia, ciudad, sector, lat, lng, place_id, label, provider, provincia_id, canton_id, parroquia_id, parroquia, is_user_provided, created_at\"\r\n          )\r\n          .eq(\"owner_id\", userRow.id)\r\n          .eq(\"is_user_provided\", true)\r\n          .order(\"created_at\", { ascending: false })\r\n          .limit(1)\r\n          .maybeSingle();\r\n        existingFreeDir = data || null;\r\n        existingFreeErr = error || null;\r\n      }\r\n\r\n      if (existingFreeErr) {\r\n        setEmailError(\r\n          existingFreeErr.message || \"No se pudo leer la direccion\"\r\n        );\r\n        return;\r\n      }\r\n\r\n      if (existingFreeDir?.id) {\r\n        const needsUpdate = !areDireccionesEqual(\r\n          existingFreeDir,\r\n          direccionData\r\n        );\r\n        if (needsUpdate) {\r\n          const { error: dirErr } = await supabase\r\n            .from(\"direcciones\")\r\n            .update(direccionData)\r\n            .eq(\"id\", existingFreeDir.id);\r\n          if (dirErr) {\r\n            setEmailError(\r\n              dirErr.message || \"No se pudo actualizar la direccion\"\r\n            );\r\n            return;\r\n          }\r\n        }\r\n        direccionId = existingFreeDir.id;\r\n      } else {\r\n        const { data: newDir, error: dirErr } = await supabase\r\n          .from(\"direcciones\")\r\n          .insert(direccionData)\r\n          .select(\"id\")\r\n          .maybeSingle();\r\n        if (dirErr || !newDir?.id) {\r\n          setEmailError(dirErr?.message || \"No se pudo guardar la direcci?n\");\r\n          return;\r\n        }\r\n        direccionId = newDir.id;\r\n      }\r\n    }\r\n\r\n    const tipoValue = isSucursalPrincipal ? \"principal\" : \"sucursal\";\r\n    const statusValue =\r\n      String(targetSucursal?.status || \"\").trim() || \"draft\";\r\n    const horariosValue =\r\n      horarios && typeof horarios === \"object\"\r\n        ? horarios\r\n        : DEFAULT_SUCURSAL_HORARIOS;\r\n\r\n    if (ensuredSucursal) {\r\n      const { error: updErr } = await supabase\r\n        .from(\"sucursales\")\r\n        .update({\r\n          direccion_id: direccionId,\r\n          tipo: tipoValue,\r\n          status: statusValue,\r\n          horarios: horariosValue,\r\n        })\r\n        .eq(\"id\", ensuredSucursal.id);\r\n\r\n      if (updErr) {\r\n        setEmailError(updErr.message || \"No se pudo actualizar la sucursal\");\r\n        return;\r\n      }\r\n    } else {\r\n      const { data: createdSucursal, error: insErr } = await supabase\r\n        .from(\"sucursales\")\r\n        .insert({\r\n          negocioid: negocioRow.id,\r\n          direccion_id: direccionId,\r\n          tipo: tipoValue,\r\n          horarios: horariosValue,\r\n          status: \"draft\",\r\n        })\r\n        .select(\"id\")\r\n        .maybeSingle();\r\n\r\n      if (insErr || !createdSucursal?.id) {\r\n        setEmailError(insErr.message || \"No se pudo crear la sucursal\");\r\n        return;\r\n      }\r\n      ensuredSucursal = createdSucursal;\r\n    }\r\n\r\n    const result = await runValidateRegistration();\r\n    if (!result?.ok || !result?.valid) {\r\n      setEmailError(result?.message || result?.error || \"AÃºn falta completar datos\");\r\n    } else {\r\n      setJustCompletedRegistration?.(true);\r\n    }\r\n    await bootstrapAuth({ force: true });\r\n  }, [\r\n    bootstrapAuth,\r\n    direccionPayload,\r\n    horarios,\r\n    isSucursalPrincipal,\r\n    setEmailError,\r\n    setJustCompletedRegistration,\r\n  ]);\r\n\r\n  const handleUserAddress = useCallback(async () => {\r\n    const role = usuario?.role || onboarding?.usuario?.role;\r\n    if (role === \"cliente\") {\r\n      await handleClientAddress();\r\n      return;\r\n    }\r\n    await handleBusinessAddress();\r\n  }, [handleBusinessAddress, handleClientAddress, onboarding?.usuario?.role, usuario?.role]);\r\n\r\n  const handleButtonBack = useCallback(() => {\r\n    const role = usuario?.role || onboarding?.usuario?.role;\r\n    if (step === AUTH_STEPS.ADD_PASSWORD || step === AUTH_STEPS.ADD_MFA) {\r\n      goToStep(AUTH_STEPS.ACCOUNT_VERIFY_METHOD);\r\n      return;\r\n    }\r\n    if (\r\n      step === AUTH_STEPS.VERIFY_EMAIL ||\r\n      step === AUTH_STEPS.ACCOUNT_VERIFY_METHOD ||\r\n      step === AUTH_STEPS.ACCOUNT_VERIFY_READY\r\n    ) {\r\n      goToStep(AUTH_STEPS.ACCOUNT_VERIFY_PROMPT);\r\n      return;\r\n    }\r\n    if (step === AUTH_STEPS.BUSINESS_VERIFY) {\r\n      goToStep(AUTH_STEPS.ACCOUNT_VERIFY_PROMPT);\r\n      return;\r\n    }\r\n    if (step === AUTH_STEPS.BUSINESS_CATEGORY) {\r\n      goToStep(AUTH_STEPS.BUSINESS_DATA);\r\n      return;\r\n    }\r\n    if (step === AUTH_STEPS.USER_ADDRESS) {\r\n      if (role === \"cliente\") {\r\n        goToStep(AUTH_STEPS.USER_PROFILE);\r\n        return;\r\n      }\r\n      goToStep(AUTH_STEPS.BUSINESS_DATA);\r\n      return;\r\n    }\r\n    if (step === AUTH_STEPS.BUSINESS_DATA) {\r\n      goToStep(AUTH_STEPS.USER_PROFILE);\r\n      return;\r\n    }\r\n    if (step === AUTH_STEPS.USER_PROFILE) {\r\n      goToEmailRegister();\r\n      return;\r\n    }\r\n    goToEmailRegister();\r\n  }, [goToEmailRegister, goToStep, onboarding?.usuario?.role, step, usuario?.role]);\r\n\r\n  return {\r\n    goToEmailLogin,\r\n    goToEmailRegister,\r\n    handleEmailLogin,\r\n    handleEmailRegister,\r\n    handleUserProfile,\r\n    handleBusinessData,\r\n    handleUserAddress,\r\n    handleRoleSelect,\r\n    skipUserProfile,\r\n    skipUserAddress,\r\n    startOAuth,\r\n    startGoogleOAuth,\r\n    startFacebookOAuth,\r\n    startAppleOAuth,\r\n    startTwitterOAuth,\r\n    startDiscordOAuth,\r\n    startGoogleOneTap,\r\n    startFacebookOneTap,\r\n    handleButtonBack,\r\n    validateNegocioCode,\r\n  };\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\useAuthFlow.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'step'. Either include it or remove the dependency array.","line":147,"column":5,"nodeType":"ArrayExpression","endLine":147,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [getActiveFormRef, step]","fix":{"range":[5208,5226],"text":"[getActiveFormRef, step]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from \"react\";\r\nimport { AUTH_STEPS } from \"../constants/authSteps\";\r\n\r\nexport default function useAuthFlow({ initialStep = AUTH_STEPS.WELCOME } = {}) {\r\n  const DEFAULT_HORARIOS = {\r\n    semanal: {\r\n      lunes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n      martes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n      miercoles: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n      jueves: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n      viernes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n      sabado: [],\r\n      domingo: [],\r\n    },\r\n    excepciones: [],\r\n  };\r\n  const [cardHeight, setCardHeight] = useState(null);\r\n  const [sliderHeight, setSliderHeight] = useState(null);\r\n  const [animating, setAnimating] = useState(false);\r\n  const [step, setStep] = useState(initialStep);\r\n  const [emailError, setEmailError] = useState(\"\");\r\n  const [welcomeError, setWelcomeError] = useState(\"\");\r\n  const [loginLoading, setLoginLoading] = useState(false);\r\n  const [oauthLoading, setOauthLoading] = useState(false);\r\n  const [oauthProvider, setOauthProvider] = useState(null);\r\n  const [welcomeLoading, setWelcomeLoading] = useState(false);\r\n  const [isAddressSearchModeOpen, setIsAddressSearchModeOpen] = useState(false);\r\n  const [isAddressPrefillReady, setIsAddressPrefillReady] = useState(false);\r\n\r\n  const cardRef = useRef(null);\r\n  const cardInnerRef = useRef(null);\r\n  const sliderRef = useRef(null);\r\n  const regPage1Ref = useRef(null);\r\n  const regPage2Ref = useRef(null);\r\n\r\n  const [email, setEmail] = useState(\"\");\r\n  const [password, setPassword] = useState(\"\");\r\n  const [passwordConfirm, setPasswordConfirm] = useState(\"\");\r\n  const [telefono, setTelefono] = useState(\"\");\r\n  const [fechaNacimiento, setFechaNacimiento] = useState(\"\");\r\n  const [codigo, setCodigo] = useState(\"\");\r\n  const [codeChecking, setCodeChecking] = useState(false);\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [showPasswordConfirm, setShowPasswordConfirm] = useState(false);\r\n  const [nombreDueno, setNombreDueno] = useState(\"\");\r\n  const [apellidoDueno, setApellidoDueno] = useState(\"\");\r\n  const [genero, setGenero] = useState(\"no_especificar\");\r\n  const [ownerPrefill, setOwnerPrefill] = useState({\r\n    nombre: \"\",\r\n    apellido: \"\",\r\n    fechaNacimiento: \"\",\r\n    genero: \"\",\r\n  });\r\n  const [businessPrefill, setBusinessPrefill] = useState({\r\n    nombreNegocio: \"\",\r\n    ruc: \"\",\r\n    categoriaNegocio: \"\",\r\n  });\r\n  const [nombreNegocio, setNombreNegocio] = useState(\"\");\r\n  const [categoriaNegocio, setCategoriaNegocio] = useState(\"\");\r\n  const [isSucursalPrincipal, setIsSucursalPrincipal] = useState(true);\r\n  const [sectorNegocio, setSectorNegocio] = useState(\"\");\r\n  const [calle1, setCalle1] = useState(\"\");\r\n  const [calle2, setCalle2] = useState(\"\");\r\n  const [horarios, setHorarios] = useState(DEFAULT_HORARIOS);\r\n  const [direccionPayload, setDireccionPayload] = useState({\r\n    place_id: \"\",\r\n    label: \"\",\r\n    display_label: \"\",\r\n    provider: \"\",\r\n    lat: null,\r\n    lng: null,\r\n    provincia_id: \"\",\r\n    canton_id: \"\",\r\n    parroquia_id: \"\",\r\n    parroquia: \"\",\r\n    ciudad: \"\",\r\n    sector: \"\",\r\n    calles: \"\",\r\n    house_number: \"\",\r\n    postcode: \"\",\r\n    referencia: \"\",\r\n    provincia: \"\",\r\n    canton: \"\",\r\n    country: \"\",\r\n  });\r\n\r\n  const sliderGap = 28;\r\n  const containerStyle = useMemo(\r\n    () => ({\r\n      display: \"flex\",\r\n      flexDirection: \"column\",\r\n      gap: sliderGap,\r\n      transition: \"opacity 250ms ease\",\r\n      filter: animating ? \"blur(1.2px)\" : \"none\",\r\n      opacity: animating ? 0.55 : 1,\r\n      width: \"100%\",\r\n      boxSizing: \"border-box\",\r\n    }),\r\n    [animating, sliderGap]\r\n  );\r\n\r\n  const getActiveFormRef = useCallback(\r\n    (targetStep = step) =>\r\n      [\r\n        AUTH_STEPS.BUSINESS_DATA,\r\n        AUTH_STEPS.BUSINESS_CATEGORY,\r\n        AUTH_STEPS.USER_ADDRESS,\r\n        AUTH_STEPS.BUSINESS_VERIFY,\r\n        AUTH_STEPS.ACCOUNT_VERIFY,\r\n        AUTH_STEPS.ACCOUNT_VERIFY_PROMPT,\r\n        AUTH_STEPS.VERIFY_EMAIL,\r\n        AUTH_STEPS.ACCOUNT_VERIFY_METHOD,\r\n        AUTH_STEPS.ACCOUNT_VERIFY_READY,\r\n        AUTH_STEPS.ADD_PASSWORD,\r\n        AUTH_STEPS.ADD_MFA,\r\n      ].includes(targetStep)\r\n        ? regPage2Ref.current\r\n        : regPage1Ref.current,\r\n    [step]\r\n  );\r\n\r\n  const measureHeights = useCallback(\r\n    (targetStep = step) => {\r\n      if (\r\n        targetStep !== AUTH_STEPS.USER_PROFILE &&\r\n        targetStep !== AUTH_STEPS.BUSINESS_DATA\r\n      ) {\r\n        return;\r\n      }\r\n      const inner = cardInnerRef.current;\r\n      const active = getActiveFormRef(targetStep);\r\n      if (!inner || !active) return;\r\n      const p2 = regPage1Ref.current;\r\n      const p3 = regPage2Ref.current;\r\n\r\n      const styles = window.getComputedStyle(inner);\r\n      const pt = parseFloat(styles.paddingTop || \"0\");\r\n      const pb = parseFloat(styles.paddingBottom || \"0\");\r\n      const hActive = active.scrollHeight;\r\n      const fallbackH = Math.max(p2?.scrollHeight || 0, p3?.scrollHeight || 0);\r\n      const contentH = hActive > 0 ? hActive : fallbackH;\r\n\r\n      setSliderHeight(Math.ceil(contentH));\r\n      setCardHeight(Math.ceil(contentH + pt + pb));\r\n    },\r\n    [getActiveFormRef]\r\n  );\r\n\r\n  useLayoutEffect(() => {\r\n    measureHeights(step);\r\n  }, [step, measureHeights]);\r\n\r\n  useEffect(() => {\r\n    const id = requestAnimationFrame(() => measureHeights(step));\r\n    return () => cancelAnimationFrame(id);\r\n  }, [step, measureHeights]);\r\n\r\n  useEffect(() => {\r\n    const active = getActiveFormRef(step);\r\n    if (!active) return;\r\n    const ro = new ResizeObserver(() => measureHeights(step));\r\n    ro.observe(active);\r\n    return () => ro.disconnect();\r\n  }, [getActiveFormRef, step, measureHeights]);\r\n\r\n  const goToStep = useCallback((nextStep) => {\r\n    setAnimating(true);\r\n    setStep(nextStep);\r\n    setTimeout(() => setAnimating(false), 360);\r\n  }, []);\r\n\r\n  return {\r\n    cardHeight,\r\n    sliderHeight,\r\n    animating,\r\n    step,\r\n    emailError,\r\n    welcomeError,\r\n    loginLoading,\r\n    oauthLoading,\r\n    oauthProvider,\r\n    welcomeLoading,\r\n    isAddressSearchModeOpen,\r\n    isAddressPrefillReady,\r\n    cardRef,\r\n    cardInnerRef,\r\n    sliderRef,\r\n    regPage1Ref,\r\n    regPage2Ref,\r\n    email,\r\n    password,\r\n    passwordConfirm,\r\n    telefono,\r\n    fechaNacimiento,\r\n    codigo,\r\n    codeChecking,\r\n    showPassword,\r\n    showPasswordConfirm,\r\n    nombreDueno,\r\n    apellidoDueno,\r\n    genero,\r\n    ownerPrefill,\r\n    businessPrefill,\r\n    nombreNegocio,\r\n    categoriaNegocio,\r\n    isSucursalPrincipal,\r\n    sectorNegocio,\r\n    calle1,\r\n    calle2,\r\n    horarios,\r\n    direccionPayload,\r\n    containerStyle,\r\n    setCardHeight,\r\n    setSliderHeight,\r\n    setAnimating,\r\n    setStep,\r\n    setEmailError,\r\n    setWelcomeError,\r\n    setLoginLoading,\r\n    setOauthLoading,\r\n    setOauthProvider,\r\n    setWelcomeLoading,\r\n    setIsAddressSearchModeOpen,\r\n    setIsAddressPrefillReady,\r\n    setEmail,\r\n    setPassword,\r\n    setPasswordConfirm,\r\n    setTelefono,\r\n    setFechaNacimiento,\r\n    setCodigo,\r\n    setCodeChecking,\r\n    setShowPassword,\r\n    setShowPasswordConfirm,\r\n    setNombreDueno,\r\n    setApellidoDueno,\r\n    setGenero,\r\n    setOwnerPrefill,\r\n    setBusinessPrefill,\r\n    setNombreNegocio,\r\n    setCategoriaNegocio,\r\n    setIsSucursalPrincipal,\r\n    setSectorNegocio,\r\n    setCalle1,\r\n    setCalle2,\r\n    setHorarios,\r\n    setDireccionPayload,\r\n    goToStep,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\useAuthPrefill.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'skipStepChange'. Either include it or remove the dependency array.","line":544,"column":6,"nodeType":"ArrayExpression","endLine":566,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [onboarding, setApellidoDueno, setBusinessPrefill, setCalle1, setCalle2, setCategoriaNegocio, setDireccionPayload, setEmailError, setStep, setNombreDueno, setFechaNacimiento, setGenero, setIsAddressPrefillReady, setNombreNegocio, setOwnerPrefill, setIsSucursalPrincipal, setHorarios, setSectorNegocio, setTelefono, usuario, skipStepChange]","fix":{"range":[17784,18231],"text":"[onboarding, setApellidoDueno, setBusinessPrefill, setCalle1, setCalle2, setCategoriaNegocio, setDireccionPayload, setEmailError, setStep, setNombreDueno, setFechaNacimiento, setGenero, setIsAddressPrefillReady, setNombreNegocio, setOwnerPrefill, setIsSucursalPrincipal, setHorarios, setSectorNegocio, setTelefono, usuario, skipStepChange]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef } from \"react\";\r\nimport { AUTH_STEPS } from \"../constants/authSteps\";\r\nimport { mapClientePrefill, mapNegocioPrefill } from \"../utils/authMappers\";\r\nimport {\r\n  formatBirthdateForInput,\r\n  normalizeUserName,\r\n} from \"../utils/userProfileUtils\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\n\r\nexport default function useAuthPrefill({\r\n  usuario,\r\n  onboarding,\r\n  setStep,\r\n  setEmailError,\r\n  setNombreDueno,\r\n  setApellidoDueno,\r\n  setGenero,\r\n  setTelefono,\r\n  setFechaNacimiento,\r\n  setOwnerPrefill,\r\n  setBusinessPrefill,\r\n  setNombreNegocio,\r\n  setCategoriaNegocio,\r\n  setIsSucursalPrincipal,\r\n  setHorarios,\r\n  setSectorNegocio,\r\n  setCalle1,\r\n  setCalle2,\r\n  setDireccionPayload,\r\n  setIsAddressPrefillReady,\r\n  skipStepChange = false,\r\n}) {\r\n  const choiceOpenedRef = useRef(false);\r\n  const direccionRequestRef = useRef(0);\r\n\r\n  useEffect(() => {\r\n    if (typeof usuario === \"undefined\") {\r\n      choiceOpenedRef.current = false;\r\n      setIsAddressPrefillReady?.(false);\r\n      setOwnerPrefill?.({\r\n        nombre: \"\",\r\n        apellido: \"\",\r\n        fechaNacimiento: \"\",\r\n        genero: \"\",\r\n      });\r\n      setGenero?.(\"no_especificar\");\r\n      setBusinessPrefill?.({\r\n        nombreNegocio: \"\",\r\n        ruc: \"\",\r\n        categoriaNegocio: \"\",\r\n      });\r\n      setCategoriaNegocio?.(\"\");\r\n      setIsSucursalPrincipal?.(false);\r\n      setDireccionPayload?.({\r\n        place_id: \"\",\r\n        label: \"\",\r\n        display_label: \"\",\r\n        provider: \"\",\r\n        lat: null,\r\n        lng: null,\r\n        provincia_id: \"\",\r\n        canton_id: \"\",\r\n        parroquia_id: \"\",\r\n        parroquia: \"\",\r\n        ciudad: \"\",\r\n        sector: \"\",\r\n        calles: \"\",\r\n        house_number: \"\",\r\n        postcode: \"\",\r\n        provincia: \"\",\r\n        canton: \"\",\r\n        country: \"\",\r\n      });\r\n    }\r\n  }, [\r\n    setBusinessPrefill,\r\n    setCategoriaNegocio,\r\n    setDireccionPayload,\r\n    setGenero,\r\n    setIsAddressPrefillReady,\r\n    setIsSucursalPrincipal,\r\n    setOwnerPrefill,\r\n    usuario,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    if (typeof usuario === \"undefined\") return;\r\n\r\n    const onboardingOk = onboarding?.ok === true;\r\n\r\n    if (!usuario) {\r\n      setIsAddressPrefillReady?.(false);\r\n      setOwnerPrefill?.({\r\n        nombre: \"\",\r\n        apellido: \"\",\r\n        fechaNacimiento: \"\",\r\n        genero: \"\",\r\n      });\r\n      setGenero?.(\"no_especificar\");\r\n      setBusinessPrefill?.({\r\n        nombreNegocio: \"\",\r\n        ruc: \"\",\r\n        categoriaNegocio: \"\",\r\n      });\r\n      setCategoriaNegocio?.(\"\");\r\n      setIsSucursalPrincipal?.(false);\r\n      setDireccionPayload?.({\r\n        place_id: \"\",\r\n        label: \"\",\r\n        display_label: \"\",\r\n        provider: \"\",\r\n        lat: null,\r\n        lng: null,\r\n        provincia_id: \"\",\r\n        canton_id: \"\",\r\n        parroquia_id: \"\",\r\n        parroquia: \"\",\r\n        ciudad: \"\",\r\n        sector: \"\",\r\n        calles: \"\",\r\n        house_number: \"\",\r\n        postcode: \"\",\r\n        provincia: \"\",\r\n        canton: \"\",\r\n        country: \"\",\r\n      });\r\n      if (onboardingOk && !choiceOpenedRef.current) {\r\n        choiceOpenedRef.current = true;\r\n        setStep(AUTH_STEPS.ROLE_SELECT);\r\n      }\r\n      return;\r\n    }\r\n\r\n    //1) Perfil existe pero SIN rol\r\n    if (!usuario.role) {\r\n      setIsAddressPrefillReady?.(false);\r\n      setOwnerPrefill?.({\r\n        nombre: \"\",\r\n        apellido: \"\",\r\n        fechaNacimiento: \"\",\r\n        genero: \"\",\r\n      });\r\n      setGenero?.(\"no_especificar\");\r\n      setBusinessPrefill?.({\r\n        nombreNegocio: \"\",\r\n        ruc: \"\",\r\n        categoriaNegocio: \"\",\r\n      });\r\n      setCategoriaNegocio?.(\"\");\r\n      setIsSucursalPrincipal?.(false);\r\n      setDireccionPayload?.({\r\n        place_id: \"\",\r\n        label: \"\",\r\n        display_label: \"\",\r\n        provider: \"\",\r\n        lat: null,\r\n        lng: null,\r\n        provincia_id: \"\",\r\n        canton_id: \"\",\r\n        parroquia_id: \"\",\r\n        parroquia: \"\",\r\n        ciudad: \"\",\r\n        sector: \"\",\r\n        calles: \"\",\r\n        house_number: \"\",\r\n        postcode: \"\",\r\n        provincia: \"\",\r\n        canton: \"\",\r\n        country: \"\",\r\n      });\r\n      if (!choiceOpenedRef.current) {\r\n        choiceOpenedRef.current = true;\r\n        setStep(AUTH_STEPS.ROLE_SELECT);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const u = usuario;\r\n    const boot = onboarding || {};\r\n    const neg = boot.negocio ?? null;\r\n    const allowAccess = !!boot.allowAccess;\r\n    const resolveClientSteps = (state) => {\r\n      const steps = state?.client_steps || {};\r\n      const profile = steps.profile || {};\r\n      const address = steps.address || {};\r\n      const profileCompleted = Boolean(profile.completed);\r\n      const addressCompleted = Boolean(address.completed);\r\n      const profileSkipped = Boolean(profile.skipped) && !profileCompleted;\r\n      const addressSkipped = Boolean(address.skipped) && !addressCompleted;\r\n      return {\r\n        profilePending: !profileCompleted && !profileSkipped,\r\n        addressPending: !addressCompleted && !addressSkipped,\r\n      };\r\n    };\r\n    const clientSteps = resolveClientSteps(boot);\r\n\r\n    if (\r\n      allowAccess &&\r\n      !(u.role === \"cliente\" && (clientSteps.profilePending || clientSteps.addressPending))\r\n    ) {\r\n      setIsAddressPrefillReady?.(true);\r\n      return;\r\n    }\r\n\r\n    //Si no hay allowAccess: decidir siguientes pasos segÇ§n rol\r\n    if (u.role === \"admin\") {\r\n      setIsAddressPrefillReady?.(true);\r\n      return;\r\n    }\r\n\r\n    if (u.role === \"cliente\") {\r\n      if (!allowAccess) {\r\n        setIsAddressPrefillReady?.(true);\r\n        setStep(AUTH_STEPS.EMAIL_LOGIN);\r\n        setEmailError(boot.reasons?.join(\", \") || \"Completa tu registro\");\r\n        return;\r\n      }\r\n\r\n      setIsAddressPrefillReady?.(false);\r\n      const prefill = mapClientePrefill({ usuario: u, onboarding: boot });\r\n      const prefillNombre = normalizeUserName(prefill.nombreDueno || \"\");\r\n      const prefillApellido = normalizeUserName(prefill.apellidoDueno || \"\");\r\n      const prefillFecha = formatBirthdateForInput(u.fecha_nacimiento);\r\n      const prefillGenero = u.genero || \"\";\r\n\r\n      if (clientSteps.profilePending) {\r\n        if (!skipStepChange) {\r\n          setStep(AUTH_STEPS.USER_PROFILE);\r\n        }\r\n      } else if (clientSteps.addressPending) {\r\n        if (!skipStepChange) {\r\n          setStep(AUTH_STEPS.USER_ADDRESS);\r\n        }\r\n      } else {\r\n        setIsAddressPrefillReady?.(true);\r\n        return;\r\n      }\r\n\r\n      setNombreDueno(prefillNombre);\r\n      setApellidoDueno(prefillApellido);\r\n      setTelefono(prefill.telefono);\r\n      setFechaNacimiento(prefillFecha);\r\n      setOwnerPrefill?.({\r\n        nombre: prefillNombre,\r\n        apellido: prefillApellido,\r\n        fechaNacimiento: prefillFecha,\r\n        genero: prefillGenero,\r\n      });\r\n      setGenero?.(prefillGenero || \"no_especificar\");\r\n\r\n      const requestId = ++direccionRequestRef.current;\r\n      const finalizeDireccion = () => {\r\n        if (requestId === direccionRequestRef.current) {\r\n          setIsAddressPrefillReady?.(true);\r\n        }\r\n      };\r\n\r\n      const loadDireccion = async () => {\r\n        if (!u?.id) {\r\n          finalizeDireccion();\r\n          return;\r\n        }\r\n\r\n        const { data: dirData, error: dirErr } = await supabase\r\n          .from(\"direcciones\")\r\n          .select(\"calles, referencia, sector, ciudad, parroquia, parroquia_id, lat, lng, place_id, label, provider, provincia_id, canton_id\")\r\n          .eq(\"owner_id\", u.id)\r\n          .eq(\"is_user_provided\", true)\r\n          .order(\"updated_at\", { ascending: false })\r\n          .order(\"created_at\", { ascending: false })\r\n          .maybeSingle();\r\n\r\n        if (requestId !== direccionRequestRef.current) return;\r\n        if (dirErr || !dirData) {\r\n          finalizeDireccion();\r\n          return;\r\n        }\r\n        setCalle1(dirData.calles || \"\");\r\n        setCalle2(\"\");\r\n        setSectorNegocio(dirData.sector || \"\");\r\n        const hasUbicacion =\r\n          Boolean(dirData.ciudad) ||\r\n          Boolean(dirData.parroquia_id) ||\r\n          Boolean(dirData.parroquia);\r\n        const hasDireccionFields =\r\n          Boolean(dirData.calles) &&\r\n          hasUbicacion &&\r\n          Boolean(dirData.sector) &&\r\n          Boolean(dirData.provincia_id) &&\r\n          Boolean(dirData.canton_id) &&\r\n          dirData.lat != null &&\r\n          dirData.lng != null;\r\n\r\n        if (hasDireccionFields) {\r\n          setDireccionPayload?.({\r\n            place_id: dirData.place_id || \"\",\r\n            label: dirData.label || \"\",\r\n            display_label: dirData.label || \"\",\r\n            provider: dirData.provider || \"\",\r\n            lat: dirData.lat ?? null,\r\n            lng: dirData.lng ?? null,\r\n            provincia_id: dirData.provincia_id || \"\",\r\n            canton_id: dirData.canton_id || \"\",\r\n            parroquia_id: dirData.parroquia_id || \"\",\r\n            parroquia: dirData.parroquia || \"\",\r\n            ciudad: dirData.ciudad || \"\",\r\n            sector: dirData.sector || \"\",\r\n            calles: dirData.calles || \"\",\r\n            house_number: \"\",\r\n            postcode: \"\",\r\n            referencia: dirData.referencia || \"\",\r\n            provincia: \"\",\r\n            canton: \"\",\r\n            country: \"\",\r\n          });\r\n        }\r\n        finalizeDireccion();\r\n      };\r\n\r\n      loadDireccion().catch(() => finalizeDireccion());\r\n      return;\r\n    }\r\n\r\n    if (u.role === \"negocio\") {\r\n      setIsAddressPrefillReady?.(false);\r\n      const prefill = mapNegocioPrefill({ usuario: u, onboarding: boot });\r\n      const missingOwner =\r\n        !u.nombre || !u.apellido || !u.fecha_nacimiento || !u.genero;\r\n      const reasons = boot.reasons || [];\r\n      const missingBusinessRow = reasons.includes(\"missing_business_row\");\r\n      const missingBusinessFields =\r\n        reasons.some((reason) => reason.startsWith(\"missing_business_fields\"));\r\n      const missingAddress =\r\n        reasons.includes(\"missing_address_row\") ||\r\n        reasons.includes(\"missing_address_fields\") ||\r\n        reasons.includes(\"missing_sucursales_row\") ||\r\n        reasons.includes(\"missing_sucursales_fields\");\r\n      const prefillNombre = normalizeUserName(prefill.nombreDueno || \"\");\r\n      const prefillApellido = normalizeUserName(prefill.apellidoDueno || \"\");\r\n      const prefillFecha = formatBirthdateForInput(u.fecha_nacimiento);\r\n      const prefillGenero = u.genero || \"\";\r\n      const prefillCategoria = prefill.categoriaNegocio || \"\";\r\n\r\n      if (missingOwner) {\r\n        if (!skipStepChange) {\r\n          setStep(AUTH_STEPS.USER_PROFILE);\r\n        }\r\n      } else if (missingBusinessRow || missingBusinessFields) {\r\n        if (!skipStepChange) {\r\n          setStep(AUTH_STEPS.BUSINESS_DATA);\r\n        }\r\n      } else if (missingAddress) {\r\n        if (!skipStepChange) {\r\n          setStep(AUTH_STEPS.USER_ADDRESS);\r\n        }\r\n      } else {\r\n        if (!skipStepChange) {\r\n          setStep(AUTH_STEPS.BUSINESS_DATA);\r\n        }\r\n      }\r\n\r\n      setNombreDueno(prefillNombre);\r\n      setApellidoDueno(prefillApellido);\r\n      setTelefono(prefill.telefono);\r\n      setFechaNacimiento(prefillFecha);\r\n      setOwnerPrefill?.({\r\n        nombre: prefillNombre,\r\n        apellido: prefillApellido,\r\n        fechaNacimiento: prefillFecha,\r\n        genero: prefillGenero,\r\n      });\r\n      setGenero?.(prefillGenero || \"no_especificar\");\r\n      setBusinessPrefill?.({\r\n        nombreNegocio: prefill.nombreNegocio || \"\",\r\n        ruc: prefill.ruc || \"\",\r\n        categoriaNegocio: prefillCategoria,\r\n      });\r\n      setNombreNegocio(prefill.nombreNegocio);\r\n      setCategoriaNegocio(prefillCategoria);\r\n      setSectorNegocio(prefill.sectorNegocio);\r\n      setCalle1(prefill.calle1);\r\n      setCalle2(prefill.calle2);\r\n\r\n      const requestId = ++direccionRequestRef.current;\r\n      const finalizeDireccion = () => {\r\n        if (requestId === direccionRequestRef.current) {\r\n          setIsAddressPrefillReady?.(true);\r\n        }\r\n      };\r\n      const loadSucursal = async () => {\r\n        let negocioId = neg?.id || null;\r\n        if (!negocioId && u?.id) {\r\n          const { data: negRow } = await supabase\r\n            .from(\"negocios\")\r\n            .select(\"id\")\r\n            .eq(\"usuarioid\", u.id)\r\n            .maybeSingle();\r\n          negocioId = negRow?.id || null;\r\n        }\r\n        if (!negocioId) {\r\n          finalizeDireccion();\r\n          return;\r\n        }\r\n\r\n        const { data, error } = await supabase\r\n          .from(\"sucursales\")\r\n          .select(\"id, direccion_id, status, tipo, horarios, fechacreacion\")\r\n          .eq(\"negocioid\", negocioId)\r\n          .order(\"fechacreacion\", { ascending: false });\r\n\r\n        if (requestId !== direccionRequestRef.current) return;\r\n        if (error || !data) {\r\n          finalizeDireccion();\r\n          return;\r\n        }\r\n\r\n        const rows = Array.isArray(data) ? data : [];\r\n        const draft = rows.find(\r\n          (row) => String(row.status || \"draft\").toLowerCase() === \"draft\"\r\n        );\r\n        const principal = rows.find(\r\n          (row) => String(row.tipo || \"\").toLowerCase() === \"principal\"\r\n        );\r\n        const picked = draft || principal || rows[0] || null;\r\n        if (picked?.tipo) {\r\n          setIsSucursalPrincipal(picked.tipo === \"principal\");\r\n        }\r\n        if (picked?.horarios) {\r\n          setHorarios?.(picked.horarios);\r\n        }\r\n        if (picked?.direccion_id) {\r\n          const { data: dirData, error: dirErr } = await supabase\r\n            .from(\"direcciones\")\r\n            .select(\"calles, referencia, sector, ciudad, parroquia, parroquia_id, lat, lng, place_id, label, provider, provincia_id, canton_id\")\r\n            .eq(\"id\", picked.direccion_id)\r\n            .maybeSingle();\r\n\r\n          if (requestId !== direccionRequestRef.current) return;\r\n          if (dirErr || !dirData) {\r\n            finalizeDireccion();\r\n            return;\r\n          }\r\n          setCalle1(dirData.calles || \"\");\r\n          setCalle2(\"\");\r\n          setSectorNegocio(dirData.sector || \"\");\r\n          const hasUbicacion =\r\n            Boolean(dirData.ciudad) ||\r\n            Boolean(dirData.parroquia_id) ||\r\n            Boolean(dirData.parroquia);\r\n          const hasDireccionFields =\r\n            Boolean(dirData.calles) &&\r\n            hasUbicacion &&\r\n            Boolean(dirData.sector) &&\r\n            Boolean(dirData.provincia_id) &&\r\n            Boolean(dirData.canton_id) &&\r\n            dirData.lat != null &&\r\n            dirData.lng != null;\r\n\r\n          if (hasDireccionFields) {\r\n            setDireccionPayload?.({\r\n              place_id: dirData.place_id || \"\",\r\n              label: dirData.label || \"\",\r\n              display_label: dirData.label || \"\",\r\n              provider: dirData.provider || \"\",\r\n              lat: dirData.lat ?? null,\r\n              lng: dirData.lng ?? null,\r\n              provincia_id: dirData.provincia_id || \"\",\r\n              canton_id: dirData.canton_id || \"\",\r\n              parroquia_id: dirData.parroquia_id || \"\",\r\n              parroquia: dirData.parroquia || \"\",\r\n              ciudad: dirData.ciudad || \"\",\r\n              sector: dirData.sector || \"\",\r\n              calles: dirData.calles || \"\",\r\n              house_number: \"\",\r\n              postcode: \"\",\r\n              referencia: dirData.referencia || \"\",\r\n              provincia: \"\",\r\n              canton: \"\",\r\n              country: \"\",\r\n            });\r\n          }\r\n          finalizeDireccion();\r\n          return;\r\n        }\r\n\r\n        const { data: fallbackDir, error: fallbackErr } = await supabase\r\n          .from(\"direcciones\")\r\n          .select(\"calles, referencia, sector, ciudad, parroquia, parroquia_id, lat, lng, place_id, label, provider, provincia_id, canton_id\")\r\n          .eq(\"owner_id\", u.id)\r\n          .eq(\"is_user_provided\", true)\r\n          .order(\"updated_at\", { ascending: false })\r\n          .order(\"created_at\", { ascending: false })\r\n          .maybeSingle();\r\n\r\n        if (requestId !== direccionRequestRef.current) return;\r\n        if (fallbackErr || !fallbackDir) {\r\n          finalizeDireccion();\r\n          return;\r\n        }\r\n        setCalle1(fallbackDir.calles || \"\");\r\n        setCalle2(\"\");\r\n        setSectorNegocio(fallbackDir.sector || \"\");\r\n        const hasUbicacion =\r\n          Boolean(fallbackDir.ciudad) ||\r\n          Boolean(fallbackDir.parroquia_id) ||\r\n          Boolean(fallbackDir.parroquia);\r\n        const hasDireccionFields =\r\n          Boolean(fallbackDir.calles) &&\r\n          hasUbicacion &&\r\n          Boolean(fallbackDir.sector) &&\r\n          Boolean(fallbackDir.provincia_id) &&\r\n          Boolean(fallbackDir.canton_id) &&\r\n          fallbackDir.lat != null &&\r\n          fallbackDir.lng != null;\r\n\r\n        if (hasDireccionFields) {\r\n          setDireccionPayload?.({\r\n            place_id: fallbackDir.place_id || \"\",\r\n            label: fallbackDir.label || \"\",\r\n            display_label: fallbackDir.label || \"\",\r\n            provider: fallbackDir.provider || \"\",\r\n            lat: fallbackDir.lat ?? null,\r\n            lng: fallbackDir.lng ?? null,\r\n            provincia_id: fallbackDir.provincia_id || \"\",\r\n            canton_id: fallbackDir.canton_id || \"\",\r\n            parroquia_id: fallbackDir.parroquia_id || \"\",\r\n            parroquia: fallbackDir.parroquia || \"\",\r\n            ciudad: fallbackDir.ciudad || \"\",\r\n            sector: fallbackDir.sector || \"\",\r\n            calles: fallbackDir.calles || \"\",\r\n            house_number: \"\",\r\n            postcode: \"\",\r\n            referencia: fallbackDir.referencia || \"\",\r\n            provincia: \"\",\r\n            canton: \"\",\r\n            country: \"\",\r\n          });\r\n        }\r\n        finalizeDireccion();\r\n      };\r\n\r\n      loadSucursal().catch(() => finalizeDireccion());\r\n    }\r\n  }, [\r\n    onboarding,\r\n    setApellidoDueno,\r\n    setBusinessPrefill,\r\n    setCalle1,\r\n    setCalle2,\r\n    setCategoriaNegocio,\r\n    setDireccionPayload,\r\n    setEmailError,\r\n    setStep,\r\n    setNombreDueno,\r\n    setFechaNacimiento,\r\n    setGenero,\r\n    setIsAddressPrefillReady,\r\n    setNombreNegocio,\r\n    setOwnerPrefill,\r\n    setIsSucursalPrincipal,\r\n    setHorarios,\r\n    setSectorNegocio,\r\n    setTelefono,\r\n    usuario,\r\n    setHorarios,\r\n  ]);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\useContactPhone.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\useEmailVerification.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\useLocationStep.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":160,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":21},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'locationTitle'. Either include it or remove the dependency array.","line":169,"column":6,"nodeType":"ArrayExpression","endLine":178,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [closeLocationDeniedModal, closeLocationModal, coords, direccionPayload?.lat, direccionPayload?.lng, locationTitle, openModal, requestLocation, stage]","fix":{"range":[5049,5230],"text":"[closeLocationDeniedModal, closeLocationModal, coords, direccionPayload?.lat, direccionPayload?.lng, locationTitle, openModal, requestLocation, stage]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useCallback, useEffect, useRef, useState } from \"react\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport { saveGpsFallbackLocation } from \"../../services/gpsFallbackClient\";\r\n\r\nexport default function useLocationStep({\r\n  stage,\r\n  coords,\r\n  direccionPayload,\r\n  setCoords,\r\n  setCoordsSource,\r\n  setMapZoom,\r\n  updateDireccionPayload,\r\n  programmaticMoveRef,\r\n  programmaticZoomRef,\r\n  closeZoom,\r\n  locationTitle,\r\n}) {\r\n  const { openModal, closeModal, activeModal } = useModal();\r\n  const [permissionState, setPermissionState] = useState(\"prompt\");\r\n  const [geoAttempted, setGeoAttempted] = useState(false);\r\n  const [geoErrorCode, setGeoErrorCode] = useState(null);\r\n  const [isRequestingLocation, setIsRequestingLocation] = useState(false);\r\n\r\n  const didAutoLocateRef = useRef(false);\r\n  const didPromptLocationRef = useRef(false);\r\n  const didDeniedLocationRef = useRef(false);\r\n  const updateDireccionPayloadRef = useRef(updateDireccionPayload);\r\n\r\n  useEffect(() => {\r\n    updateDireccionPayloadRef.current = updateDireccionPayload;\r\n  }, [updateDireccionPayload]);\r\n\r\n  const closeLocationModal = useCallback(() => {\r\n    if (activeModal === \"LocationPermission\") {\r\n      closeModal();\r\n    }\r\n  }, [activeModal, closeModal]);\r\n\r\n  const closeLocationDeniedModal = useCallback(() => {\r\n    if (activeModal === \"LocationDenied\") {\r\n      closeModal();\r\n    }\r\n  }, [activeModal, closeModal]);\r\n\r\n  const closeLocationUnavailableModal = useCallback(() => {\r\n    if (activeModal === \"LocationUnavailable\") {\r\n      closeModal();\r\n    }\r\n  }, [activeModal, closeModal]);\r\n\r\n  const requestLocation = useCallback(() => {\r\n    if (!navigator?.geolocation) {\r\n      return;\r\n    }\r\n    if (isRequestingLocation) return;\r\n    setIsRequestingLocation(true);\r\n    setGeoAttempted(true);\r\n    setGeoErrorCode(null);\r\n    navigator.geolocation.getCurrentPosition(\r\n      (position) => {\r\n        const nextCenter = {\r\n          lat: position.coords.latitude,\r\n          lng: position.coords.longitude,\r\n        };\r\n        programmaticMoveRef.current = true;\r\n        setCoords(nextCenter);\r\n        setCoordsSource(\"gps\");\r\n        programmaticZoomRef.current = true;\r\n        setMapZoom(closeZoom);\r\n        updateDireccionPayloadRef.current?.({\r\n          lat: nextCenter.lat,\r\n          lng: nextCenter.lng,\r\n        });\r\n        saveGpsFallbackLocation(nextCenter).catch(() => {});\r\n        setIsRequestingLocation(false);\r\n      },\r\n      (error) => {\r\n        setIsRequestingLocation(false);\r\n        const code = error?.code ?? null;\r\n        setGeoErrorCode(code);\r\n        if (code === 1) {\r\n          setPermissionState(\"denied\");\r\n          openModal(\"LocationDenied\");\r\n          return;\r\n        }\r\n        if (code === 2 || code === 3) {\r\n          openModal(\"LocationUnavailable\", {\r\n            onRetry: () => requestLocation(),\r\n          });\r\n        }\r\n      },\r\n      { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }\r\n    );\r\n  }, [\r\n    closeZoom,\r\n    isRequestingLocation,\r\n    openModal,\r\n    programmaticMoveRef,\r\n    programmaticZoomRef,\r\n    setCoords,\r\n    setCoordsSource,\r\n    setMapZoom,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    if (!navigator?.geolocation) {\r\n      return undefined;\r\n    }\r\n\r\n    const checkPermission = async () => {\r\n      if (stage !== \"map\") return;\r\n      if (!navigator.permissions?.query) {\r\n        return;\r\n      }\r\n      try {\r\n        const status = await navigator.permissions.query({\r\n          name: \"geolocation\",\r\n        });\r\n        if (!active) return;\r\n        const handlePermissionState = (state) => {\r\n          setPermissionState(state);\r\n          if (state === \"granted\") {\r\n            closeLocationModal();\r\n            closeLocationDeniedModal();\r\n            if (!didAutoLocateRef.current) {\r\n              const hasCoords =\r\n                coords ||\r\n                (direccionPayload?.lat != null && direccionPayload?.lng != null);\r\n              if (!hasCoords) {\r\n                didAutoLocateRef.current = true;\r\n                requestLocation();\r\n              }\r\n            }\r\n            return;\r\n          }\r\n          if (state === \"denied\") {\r\n            closeLocationModal();\r\n            if (!didDeniedLocationRef.current) {\r\n              didDeniedLocationRef.current = true;\r\n              openModal(\"LocationDenied\");\r\n            }\r\n            return;\r\n          }\r\n          closeLocationDeniedModal();\r\n          if (!didPromptLocationRef.current) {\r\n            didPromptLocationRef.current = true;\r\n            openModal(\"LocationPermission\", {\r\n              onConfirm: () => requestLocation(),\r\n              title: locationTitle,\r\n            });\r\n          }\r\n        };\r\n\r\n        handlePermissionState(status.state);\r\n        status.onchange = () => {\r\n          if (!active) return;\r\n          handlePermissionState(status.state);\r\n        };\r\n      } catch (error) {\r\n        return;\r\n      }\r\n    };\r\n\r\n    checkPermission();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, [\r\n    closeLocationDeniedModal,\r\n    closeLocationModal,\r\n    coords,\r\n    direccionPayload?.lat,\r\n    direccionPayload?.lng,\r\n    openModal,\r\n    requestLocation,\r\n    stage,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    if (stage !== \"map\") {\r\n      closeLocationModal();\r\n      closeLocationDeniedModal();\r\n      closeLocationUnavailableModal();\r\n    }\r\n  }, [\r\n    closeLocationDeniedModal,\r\n    closeLocationModal,\r\n    closeLocationUnavailableModal,\r\n    stage,\r\n  ]);\r\n\r\n  return {\r\n    requestLocation,\r\n    permissionState,\r\n    geoAttempted,\r\n    geoErrorCode,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\usePasswordAccess.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'useMemo' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"useMemo"},"fix":{"range":[31,40],"text":""},"desc":"Remove unused variable 'useMemo'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\n\r\nexport default function usePasswordAccess({ provider = \"email\" } = {}) {\r\n  const [passwordMode, setPasswordMode] = useState(\"add\");\r\n  const [passwordValue, setPasswordValue] = useState(\"\");\r\n  const [passwordConfirm, setPasswordConfirm] = useState(\"\");\r\n  const [currentPassword, setCurrentPassword] = useState(\"\");\r\n  const [passwordAttempted, setPasswordAttempted] = useState(false);\r\n  const [passwordEnabled, setPasswordEnabled] = useState(null);\r\n  const [showPasswordForm, setShowPasswordForm] = useState(false);\r\n  const [showPassword, setShowPassword] = useState(false);\r\n  const [showPasswordConfirm, setShowPasswordConfirm] = useState(false);\r\n  const [showCurrentPassword, setShowCurrentPassword] = useState(false);\r\n  const [focusedField, setFocusedField] = useState(null);\r\n  const [saving, setSaving] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [message, setMessage] = useState(\"\");\r\n\r\n  const passwordFormRef = useRef(null);\r\n  const currentPasswordRef = useRef(null);\r\n  const passwordInputRef = useRef(null);\r\n  const confirmInputRef = useRef(null);\r\n\r\n  const hasPassword = provider === \"email\" || provider === \"password\";\r\n  const passwordActive = passwordEnabled ?? hasPassword;\r\n\r\n  useEffect(() => {\r\n    if (!hasPassword) {\r\n      setShowPasswordForm(true);\r\n      setPasswordMode(\"add\");\r\n    }\r\n  }, [hasPassword]);\r\n\r\n  const handlePasswordFocus = useCallback((field) => {\r\n    setFocusedField(field);\r\n  }, []);\r\n\r\n  const handlePasswordBlur = useCallback(() => {\r\n    requestAnimationFrame(() => {\r\n      const active = document.activeElement;\r\n      if (active === currentPasswordRef.current) {\r\n        setFocusedField(\"current\");\r\n        return;\r\n      }\r\n      if (active === passwordInputRef.current) {\r\n        setFocusedField(\"new\");\r\n        return;\r\n      }\r\n      if (active === confirmInputRef.current) {\r\n        setFocusedField(\"confirm\");\r\n        return;\r\n      }\r\n      setFocusedField(null);\r\n    });\r\n  }, []);\r\n\r\n  const hasMinLength = passwordValue.length >= 8;\r\n  const hasNumber = /\\d/.test(passwordValue);\r\n  const hasSymbol = /[^A-Za-z0-9]/.test(passwordValue);\r\n  const hasNumberAndSymbol = hasNumber && hasSymbol;\r\n  const passwordsMatch =\r\n    passwordValue.length > 0 &&\r\n    passwordConfirm.length > 0 &&\r\n    passwordValue === passwordConfirm;\r\n  const showPasswordRules = focusedField === \"new\" || passwordValue.length > 0;\r\n  const showPasswordErrors = focusedField !== \"new\" && passwordValue.length > 0;\r\n  const showConfirmErrors =\r\n    focusedField !== \"confirm\" && passwordConfirm.length > 0;\r\n  const showConfirmRule =\r\n    hasMinLength && hasNumberAndSymbol && passwordConfirm.length > 0;\r\n  const canSavePassword = hasMinLength && hasNumberAndSymbol && passwordsMatch;\r\n  const showCurrentPasswordError =\r\n    passwordMode === \"change\" && passwordAttempted && !currentPassword.trim();\r\n\r\n  const handlePasswordCancel = () => {\r\n    setPasswordValue(\"\");\r\n    setPasswordConfirm(\"\");\r\n    setCurrentPassword(\"\");\r\n    setFocusedField(null);\r\n    setPasswordMode(\"add\");\r\n    setPasswordAttempted(false);\r\n    setShowPasswordForm(false);\r\n    setError(\"\");\r\n    setMessage(\"\");\r\n    document.activeElement?.blur();\r\n  };\r\n\r\n  const handlePasswordSave = useCallback(async () => {\r\n    setPasswordAttempted(true);\r\n    setError(\"\");\r\n    setMessage(\"\");\r\n    if (!canSavePassword) return;\r\n    if (passwordMode === \"change\" && !currentPassword.trim()) return;\r\n    setSaving(true);\r\n    try {\r\n      const { data, error: fnErr } = await supabase.functions.invoke(\r\n        \"set-password\",\r\n        {\r\n          body: { password: passwordValue },\r\n        },\r\n      );\r\n      if (fnErr || data?.ok === false) {\r\n        setError(\r\n          fnErr?.message || data?.message || \"No se pudo guardar la contrasena.\",\r\n        );\r\n        return { ok: false };\r\n      }\r\n      setPasswordEnabled(true);\r\n      setShowPasswordForm(false);\r\n      setPasswordMode(\"add\");\r\n      setPasswordAttempted(false);\r\n      setMessage(\"Contrasena guardada.\");\r\n      const session = (await supabase.auth.getSession())?.data?.session;\r\n      const userId = session?.user?.id;\r\n      if (userId) {\r\n        await supabase\r\n          .from(\"usuarios\")\r\n          .update({ has_password: true, must_change_password: false })\r\n          .eq(\"id_auth\", userId);\r\n      }\r\n      return { ok: true };\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  }, [canSavePassword, currentPassword, passwordMode, passwordValue]);\r\n\r\n  const openAddPassword = () => {\r\n    setPasswordMode(\"add\");\r\n    setCurrentPassword(\"\");\r\n    setPasswordValue(\"\");\r\n    setPasswordConfirm(\"\");\r\n    setPasswordAttempted(false);\r\n    setShowPasswordForm(true);\r\n  };\r\n\r\n  const openChangePassword = () => {\r\n    setPasswordMode(\"change\");\r\n    setCurrentPassword(\"\");\r\n    setPasswordValue(\"\");\r\n    setPasswordConfirm(\"\");\r\n    setPasswordAttempted(false);\r\n    setShowPasswordForm(true);\r\n  };\r\n\r\n  const removePassword = () => {\r\n    setPasswordEnabled(false);\r\n    setShowPasswordForm(false);\r\n  };\r\n\r\n  const passwordSaved = passwordEnabled === true;\r\n\r\n  return {\r\n    passwordActive,\r\n    showPasswordForm,\r\n    passwordMode,\r\n    currentPassword,\r\n    passwordValue,\r\n    passwordConfirm,\r\n    showPassword,\r\n    showPasswordConfirm,\r\n    showCurrentPassword,\r\n    hasMinLength,\r\n    hasNumberAndSymbol,\r\n    passwordsMatch,\r\n    showPasswordRules,\r\n    showPasswordErrors,\r\n    showConfirmErrors,\r\n    showConfirmRule,\r\n    canSavePassword,\r\n    showCurrentPasswordError,\r\n    onPasswordCancel: handlePasswordCancel,\r\n    onPasswordSave: handlePasswordSave,\r\n    onOpenAdd: openAddPassword,\r\n    onOpenChange: openChangePassword,\r\n    onRemovePassword: removePassword,\r\n    onToggleShowPassword: () => setShowPassword((prev) => !prev),\r\n    onToggleShowPasswordConfirm: () => setShowPasswordConfirm((prev) => !prev),\r\n    onToggleShowCurrentPassword: () =>\r\n      setShowCurrentPassword((prev) => !prev),\r\n    onChangeCurrentPassword: (event) => setCurrentPassword(event.target.value),\r\n    onChangePasswordValue: (event) => setPasswordValue(event.target.value),\r\n    onChangePasswordConfirm: (event) => setPasswordConfirm(event.target.value),\r\n    onFocusField: handlePasswordFocus,\r\n    onBlurField: handlePasswordBlur,\r\n    passwordFormRef,\r\n    currentPasswordRef,\r\n    passwordInputRef,\r\n    confirmInputRef,\r\n    passwordSaved,\r\n    saving,\r\n    error,\r\n    message,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\hooks\\useRegisterPasswordUI.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\AccountVerifyMethodStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\AccountVerifyPrompt.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\AccountVerifyReadyStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\AccountVerifyStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\AddPasswordStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\AddTwoFAStep.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'prepareEnrollment'. Either include it or remove the dependency array.","line":205,"column":6,"nodeType":"ArrayExpression","endLine":205,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [prepareEnrollment]","fix":{"range":[6464,6466],"text":"[prepareEnrollment]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { QrCode } from \"lucide-react\";\r\nimport QRCode from \"react-qr-code\";\r\nimport {\r\n  challengeAndVerifyTotp,\r\n  enrollTotp,\r\n  listMfaFactors,\r\n  pickActiveTotpFactor,\r\n  syncTotpFlags,\r\n  unenrollFactor,\r\n} from \"../../services/mfaService\";\r\n\r\nconst FRIENDLY_NAME = \"App autenticadora\";\r\n\r\nconst isActiveStatus = (status) =>\r\n  [\"verified\", \"active\"].includes(String(status || \"\").toLowerCase());\r\nconst isPendingStatus = (status) =>\r\n  [\"unverified\", \"pending\"].includes(String(status || \"\").toLowerCase());\r\nconst getFriendlyName = (factor) =>\r\n  factor?.friendly_name || factor?.friendlyName || \"\";\r\nconst getTotpFactors = (data) => {\r\n  if (!data) return [];\r\n  if (Array.isArray(data)) return data;\r\n  if (Array.isArray(data.totp)) return data.totp;\r\n  if (Array.isArray(data.all)) {\r\n    return data.all.filter(\r\n      (factor) => String(factor?.factor_type || \"\").toLowerCase() === \"totp\"\r\n    );\r\n  }\r\n  return [];\r\n};\r\n\r\nexport default function AddTwoFAStep({ innerRef, onCancel, onContinue }) {\r\n  const [loading, setLoading] = useState(true);\r\n  const [enrollError, setEnrollError] = useState(\"\");\r\n  const [mode, setMode] = useState(\"enroll\");\r\n  const [factorId, setFactorId] = useState(null);\r\n  const [qrCode, setQrCode] = useState(\"\");\r\n  const [qrUri, setQrUri] = useState(\"\");\r\n  const [secret, setSecret] = useState(\"\");\r\n  const [code, setCode] = useState(\"\");\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [verifyError, setVerifyError] = useState(\"\");\r\n  const preparingRef = useRef(false);\r\n  const initializedRef = useRef(false);\r\n\r\n  const canSubmit =\r\n    code.trim().length >= 6 && !submitting && !loading && Boolean(factorId);\r\n\r\n  const resetEnrollState = () => {\r\n    setFactorId(null);\r\n    setQrCode(\"\");\r\n    setQrUri(\"\");\r\n    setSecret(\"\");\r\n  };\r\n\r\n  const applyEnrollPayload = (data) => {\r\n    const totp = data?.totp || {};\r\n    setFactorId(data?.id || null);\r\n    setQrCode(totp.qr_code || \"\");\r\n    setQrUri(totp.uri || \"\");\r\n    setSecret(totp.secret || \"\");\r\n  };\r\n\r\n  const startEnroll = async () => {\r\n    const result = await enrollTotp({ friendlyName: FRIENDLY_NAME });\r\n    if (!result.ok) {\r\n      return result;\r\n    }\r\n    applyEnrollPayload(result.data);\r\n    return { ok: true };\r\n  };\r\n\r\n  const prepareEnrollment = async () => {\r\n    if (preparingRef.current || factorId) return;\r\n    preparingRef.current = true;\r\n    setLoading(true);\r\n    setEnrollError(\"\");\r\n    setMode(\"enroll\");\r\n    resetEnrollState();\r\n\r\n    const list = await listMfaFactors();\r\n    if (list.ok) {\r\n      const factors = getTotpFactors(list.data);\r\n      const named = factors.find(\r\n        (factor) => getFriendlyName(factor) === FRIENDLY_NAME\r\n      );\r\n      if (named && isActiveStatus(named?.status)) {\r\n        setMode(\"existing\");\r\n        setFactorId(named.id);\r\n        setLoading(false);\r\n        preparingRef.current = false;\r\n        return;\r\n      }\r\n      if (named) {\r\n        setMode(\"existing\");\r\n        setFactorId(named.id);\r\n        setLoading(false);\r\n        preparingRef.current = false;\r\n        return;\r\n      }\r\n      const active = pickActiveTotpFactor(factors);\r\n      if (active && isActiveStatus(active?.status)) {\r\n        setMode(\"existing\");\r\n        setFactorId(active.id);\r\n        setLoading(false);\r\n        preparingRef.current = false;\r\n        return;\r\n      }\r\n      const pending = factors.filter((factor) => isPendingStatus(factor?.status));\r\n      if (pending.length) {\r\n        for (const factor of pending) {\r\n          const removed = await unenrollFactor(factor.id);\r\n          if (!removed.ok) {\r\n            setEnrollError(\r\n              removed.error || \"No se pudo limpiar un intento anterior.\"\r\n            );\r\n            setLoading(false);\r\n            preparingRef.current = false;\r\n            return;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    const result = await startEnroll();\r\n    if (!result.ok) {\r\n      const isNameConflict =\r\n        result.errorCode === \"mfa_factor_name_conflict\" ||\r\n        String(result.error || \"\").includes(\"friendly name\");\r\n      if (isNameConflict) {\r\n        const retryList = await listMfaFactors();\r\n        const factors = retryList.ok ? getTotpFactors(retryList.data) : [];\r\n        const named = factors.find(\r\n          (factor) => getFriendlyName(factor) === FRIENDLY_NAME\r\n        );\r\n        if (named && isActiveStatus(named?.status)) {\r\n          setMode(\"existing\");\r\n          setFactorId(named.id);\r\n          setLoading(false);\r\n          preparingRef.current = false;\r\n          return;\r\n        }\r\n        if (named) {\r\n          setMode(\"existing\");\r\n          setFactorId(named.id);\r\n          setLoading(false);\r\n          preparingRef.current = false;\r\n          return;\r\n        }\r\n        const active = pickActiveTotpFactor(factors);\r\n        if (active && isActiveStatus(active?.status)) {\r\n          setMode(\"existing\");\r\n          setFactorId(active.id);\r\n          setLoading(false);\r\n          preparingRef.current = false;\r\n          return;\r\n        }\r\n        const pending = factors.filter((factor) => isPendingStatus(factor?.status));\r\n        if (pending.length) {\r\n          for (const factor of pending) {\r\n            const removed = await unenrollFactor(factor.id);\r\n            if (!removed.ok) {\r\n              setEnrollError(\r\n                removed.error || \"No se pudo limpiar un intento anterior.\"\r\n              );\r\n              setLoading(false);\r\n              preparingRef.current = false;\r\n              return;\r\n            }\r\n          }\r\n          const retry = await startEnroll();\r\n          if (retry.ok) {\r\n            setLoading(false);\r\n            preparingRef.current = false;\r\n            return;\r\n          }\r\n          setEnrollError(retry.error || \"No se pudo iniciar MFA\");\r\n          setLoading(false);\r\n          preparingRef.current = false;\r\n          return;\r\n        }\r\n      }\r\n      setEnrollError(result.error || \"No se pudo iniciar MFA\");\r\n      setLoading(false);\r\n      preparingRef.current = false;\r\n      return;\r\n    }\r\n\r\n    setLoading(false);\r\n    preparingRef.current = false;\r\n  };\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    (async () => {\r\n      if (initializedRef.current) return;\r\n      initializedRef.current = true;\r\n      await prepareEnrollment();\r\n      if (!active) return;\r\n    })();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, []);\r\n\r\n  const helperText = useMemo(() => {\r\n    if (loading) return \"Generando tu código...\";\r\n    if (enrollError) return \"No se pudo iniciar la configuración.\";\r\n    if (mode === \"existing\") {\r\n      return \"Ya tienes 2FA activo. Ingresa el código de tu app.\";\r\n    }\r\n    return \"Escanea el QR con tu app autenticadora y escribe el código.\";\r\n  }, [enrollError, loading, mode]);\r\n\r\n  const handleVerify = async () => {\r\n    if (!factorId) {\r\n      setVerifyError(\"No se pudo iniciar la verificación.\");\r\n      return;\r\n    }\r\n    setVerifyError(\"\");\r\n    setSubmitting(true);\r\n    const result = await challengeAndVerifyTotp({\r\n      factorId,\r\n      code: code.trim(),\r\n    });\r\n    if (!result.ok) {\r\n      setVerifyError(result.error || \"Código inválido\");\r\n      setSubmitting(false);\r\n      return;\r\n    }\r\n    await syncTotpFlags({ enabled: true });\r\n    setSubmitting(false);\r\n    onContinue?.();\r\n  };\r\n\r\n  const renderQr = () => {\r\n    if (qrCode) {\r\n      const trimmed = qrCode.trim();\r\n      const isSvg = trimmed.startsWith(\"<svg\");\r\n      if (isSvg) {\r\n        return (\r\n          <div\r\n            className=\"mx-auto h-40 w-40\"\r\n            dangerouslySetInnerHTML={{ __html: trimmed }}\r\n          />\r\n        );\r\n      }\r\n      return (\r\n        <img\r\n          src={qrCode}\r\n          alt=\"Código QR para app autenticadora\"\r\n          className=\"mx-auto h-40 w-40\"\r\n          loading=\"lazy\"\r\n        />\r\n      );\r\n    }\r\n    if (qrUri) {\r\n      return (\r\n        <div className=\"flex items-center justify-center\">\r\n          <QRCode value={qrUri} size={160} />\r\n        </div>\r\n      );\r\n    }\r\n    return <div className=\"text-xs text-gray-500\">No se pudo cargar el QR.</div>;\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex h-full flex-col pb-4 text-gray-700\" ref={innerRef}>\r\n      <div className=\"flex-1\">\r\n        <div className=\"text-lg font-semibold text-gray-900 text-center\">\r\n          Activar 2FA\r\n        </div>\r\n\r\n        <p className=\"mt-2 text-sm text-gray-600\">{helperText}</p>\r\n\r\n        {mode === \"enroll\" ? (\r\n          <div className=\"mt-4 rounded-xl border border-gray-200 bg-gray-50 p-4\">\r\n            {loading ? (\r\n              <div className=\"flex items-center justify-center gap-2 text-xs text-gray-400\">\r\n                <QrCode size={16} />\r\n                Generando QR...\r\n              </div>\r\n            ) : enrollError ? (\r\n              <div className=\"text-xs text-red-500\">\r\n                {enrollError}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={prepareEnrollment}\r\n                  className=\"ml-2 text-xs font-semibold text-[#5E30A5]\"\r\n                >\r\n                  Reintentar\r\n                </button>\r\n              </div>\r\n            ) : (\r\n              renderQr()\r\n            )}\r\n          </div>\r\n        ) : null}\r\n\r\n        {mode === \"enroll\" && secret ? (\r\n          <div className=\"mt-3 space-y-1\">\r\n            <div className=\"text-xs text-gray-500 ml-1\">Clave manual:</div>\r\n            <div className=\"rounded-lg border border-gray-200 bg-white px-3 py-2 text-[11px] text-gray-500\">\r\n              <span className=\"font-semibold text-gray-700\">{secret}</span>\r\n            </div>\r\n          </div>\r\n        ) : null}\r\n\r\n        <div className=\"mt-4 space-y-2\">\r\n          <label className=\"block text-xs text-gray-500 ml-1\">\r\n            Código de 6 dígitos\r\n          </label>\r\n          <input\r\n            type=\"text\"\r\n            inputMode=\"numeric\"\r\n            autoComplete=\"one-time-code\"\r\n            value={code}\r\n            onChange={(event) => setCode(event.target.value)}\r\n            className=\"w-full rounded-lg border border-gray-200 px-3 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#5E30A5]/30\"\r\n            placeholder=\"123456\"\r\n          />\r\n          {verifyError ? (\r\n            <div className=\"text-xs text-red-500\">{verifyError}</div>\r\n          ) : null}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"mt-5 flex gap-3\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={onCancel}\r\n          className=\"flex-1 rounded-lg border border-gray-200 py-2 text-sm font-semibold text-gray-600\"\r\n        >\r\n          Cancelar\r\n        </button>\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleVerify}\r\n          disabled={!canSubmit}\r\n          className=\"flex-1 rounded-lg bg-[#5E30A5] py-2 text-sm font-semibold text-white disabled:opacity-60\"\r\n        >\r\n          {submitting ? \"Verificando...\" : \"Confirmar\"}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\BusinessCategoryStep.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onGoWelcome' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"onGoWelcome"},"fix":{"range":[226,242],"text":""},"desc":"Remove unused variable 'onGoWelcome'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'categoryList' logical expression could make the dependencies of useEffect Hook (at line 47) change on every render. To fix this, wrap the initialization of 'categoryList' in its own useMemo() Hook.","line":16,"column":9,"nodeType":"VariableDeclarator","endLine":16,"endColumn":40},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'categoryList' logical expression could make the dependencies of useMemo Hook (at line 53) change on every render. To fix this, wrap the initialization of 'categoryList' in its own useMemo() Hook.","line":16,"column":9,"nodeType":"VariableDeclarator","endLine":16,"endColumn":40},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'categoryList' logical expression could make the dependencies of useMemo Hook (at line 68) change on every render. To fix this, wrap the initialization of 'categoryList' in its own useMemo() Hook.","line":16,"column":9,"nodeType":"VariableDeclarator","endLine":16,"endColumn":40},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'subcategoryMap' logical expression could make the dependencies of useEffect Hook (at line 47) change on every render. To fix this, wrap the initialization of 'subcategoryMap' in its own useMemo() Hook.","line":17,"column":9,"nodeType":"VariableDeclarator","endLine":17,"endColumn":45},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'subcategoryMap' logical expression could make the dependencies of useMemo Hook (at line 58) change on every render. To fix this, wrap the initialization of 'subcategoryMap' in its own useMemo() Hook.","line":17,"column":9,"nodeType":"VariableDeclarator","endLine":17,"endColumn":45}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import React, { useEffect, useMemo, useState } from \"react\";\r\n\r\nexport default function BusinessCategoryStep({\r\n  subtitle,\r\n  helperLabel,\r\n  categories,\r\n  subcategories,\r\n  currentCategory,\r\n  onConfirmCategory,\r\n  innerRef,\r\n  onGoWelcome,\r\n}) {\r\n  const [selectedParent, setSelectedParent] = useState(\"\");\r\n  const [selectedSub, setSelectedSub] = useState(\"\");\r\n\r\n  const categoryList = categories || [];\r\n  const subcategoryMap = subcategories || {};\r\n\r\n  useEffect(() => {\r\n    if (!currentCategory) {\r\n      setSelectedParent(\"\");\r\n      setSelectedSub(\"\");\r\n      return;\r\n    }\r\n\r\n    let parentId = \"\";\r\n    let subId = \"\";\r\n\r\n    for (const [key, list] of Object.entries(subcategoryMap)) {\r\n      const match = list?.find((item) => item.label === currentCategory);\r\n      if (match) {\r\n        parentId = key;\r\n        subId = match.id;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!parentId) {\r\n      const parentMatch = categoryList.find(\r\n        (item) => item.label === currentCategory\r\n      );\r\n      parentId = parentMatch?.id || \"\";\r\n    }\r\n\r\n    setSelectedParent(parentId);\r\n    setSelectedSub(subId);\r\n  }, [categoryList, currentCategory, subcategoryMap]);\r\n\r\n  const selectedParentLabel = useMemo(() => {\r\n    if (!selectedParent) return \"\";\r\n    const match = categoryList.find((item) => item.id === selectedParent);\r\n    return match?.label || \"\";\r\n  }, [categoryList, selectedParent]);\r\n\r\n  const subcategoryList = useMemo(() => {\r\n    if (!selectedParent) return [];\r\n    return subcategoryMap[selectedParent] || [];\r\n  }, [selectedParent, subcategoryMap]);\r\n\r\n  const selectedSubLabel = useMemo(() => {\r\n    if (!selectedSub) return \"\";\r\n    const match = subcategoryList.find((item) => item.id === selectedSub);\r\n    return match?.label || \"\";\r\n  }, [selectedSub, subcategoryList]);\r\n\r\n  const parentItems = useMemo(\r\n    () => categoryList.map((item) => ({ ...item, type: \"parent\" })),\r\n    [categoryList]\r\n  );\r\n  const subItems = useMemo(\r\n    () => subcategoryList.map((item) => ({ ...item, type: \"sub\" })),\r\n    [subcategoryList]\r\n  );\r\n\r\n  const labelClassName = \"block text-xs text-gray-500 ml-1 mb-0\";\r\n  const hasSubcategories = subcategoryList.length > 0;\r\n  const isReady = Boolean(selectedParent) && (!hasSubcategories || selectedSubLabel);\r\n\r\n  const handleSelectParent = (id) => {\r\n    setSelectedParent(id);\r\n    setSelectedSub(\"\");\r\n  };\r\n\r\n  const handleConfirm = () => {\r\n    if (!selectedParent) return;\r\n    const value = hasSubcategories ? selectedSubLabel : selectedParentLabel;\r\n    if (!value) return;\r\n    onConfirmCategory?.(value);\r\n  };\r\n\r\n  const handleClearParent = () => {\r\n    setSelectedParent(\"\");\r\n    setSelectedSub(\"\");\r\n  };\r\n\r\n  const showSubcategoryGrid = Boolean(selectedParent) && hasSubcategories;\r\n  const gridItems = showSubcategoryGrid\r\n    ? [\r\n        parentItems.find((item) => item.id === selectedParent),\r\n        ...subItems,\r\n      ].filter(Boolean)\r\n    : parentItems;\r\n\r\n  return (\r\n    <section\r\n      style={{ boxSizing: \"border-box\", position: \"relative\", zIndex: 1 }}\r\n      className=\"px-2 h-full\"\r\n    >\r\n      <div className=\"pb-4 flex h-full flex-col\" ref={innerRef}>\r\n        <div className=\"flex-1\">\r\n          <p className=\"text-sm text-gray-600 mt-3 mb-6 text-center\">\r\n            {subtitle || \"No te preocupes, puedes cambiarlo después\"}\r\n          </p>\r\n\r\n          <div className=\"space-y-4\">\r\n            <label className={labelClassName}>\r\n              {helperLabel ||\r\n                \"Así podremos mostrar tus promos a las personas correctas.\"}\r\n            </label>\r\n\r\n            <CategoryGrid\r\n              items={gridItems}\r\n              selectedParentId={selectedParent}\r\n              selectedSubId={selectedSub}\r\n              onSelectParent={handleSelectParent}\r\n              onSelectSub={setSelectedSub}\r\n              onClearParent={handleClearParent}\r\n              className=\"mt-3\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-auto pt-4\">\r\n          <button\r\n            onClick={handleConfirm}\r\n            disabled={!isReady}\r\n            className={`w-full py-2.5 rounded-lg font-semibold shadow ${\r\n              isReady\r\n                ? \"bg-[#10B981] text-white\"\r\n                : \"bg-gray-200 text-gray-500 cursor-not-allowed\"\r\n            }`}\r\n          >\r\n            Continuar\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </section>\r\n  );\r\n}\r\n\r\nfunction CategoryGrid({\r\n  items,\r\n  selectedParentId,\r\n  selectedSubId,\r\n  onSelectParent,\r\n  onSelectSub,\r\n  onClearParent,\r\n  className = \"\",\r\n}) {\r\n  return (\r\n    <div className={`grid grid-cols-3 gap-2 ${className}`}>\r\n      {items.map((item) => {\r\n        if (!item) return null;\r\n        const isParent = item.type === \"parent\";\r\n        const isActive = isParent\r\n          ? selectedParentId === item.id\r\n          : selectedSubId === item.id;\r\n        const iconColor = isActive ? \"text-[#5E30A5]\" : \"text-gray-500\";\r\n        const icon = item.icon || {};\r\n        const canSelect = !isParent || !isActive;\r\n        return (\r\n          <button\r\n            key={item.id}\r\n            type=\"button\"\r\n            onClick={() => {\r\n              if (!canSelect) return;\r\n              if (isParent) {\r\n                onSelectParent?.(item.id);\r\n              } else {\r\n                onSelectSub?.(item.id);\r\n              }\r\n            }}\r\n            className={`aspect-[4/3] rounded-xl border p-2 flex flex-col items-center justify-start text-center transition-colors relative ${\r\n              isActive\r\n                ? \"border-[#5E30A5] bg-[#5E30A5]/10\"\r\n                : \"border-gray-200 bg-white\"\r\n            }`}\r\n          >\r\n            {isParent && isActive && (\r\n              <span\r\n                role=\"button\"\r\n                tabIndex={0}\r\n                onClick={(event) => {\r\n                  event.stopPropagation();\r\n                  onClearParent?.();\r\n                }}\r\n                onKeyDown={(event) => {\r\n                  if (event.key !== \"Enter\" && event.key !== \" \") return;\r\n                  event.preventDefault();\r\n                  event.stopPropagation();\r\n                  onClearParent?.();\r\n                }}\r\n                className=\"absolute top-1 right-1 h-5 w-5 rounded-full border border-[#5E30A5] bg-white text-[#5E30A5] text-[12px] leading-none flex items-center justify-center\"\r\n                aria-label=\"Quitar categoria\"\r\n              >\r\n                ×\r\n              </span>\r\n            )}\r\n            <div\r\n              className={`w-8 h-8 flex items-center justify-center ${iconColor} flex-shrink-0 mt-0.5`}\r\n            >\r\n              <svg\r\n                viewBox={icon.viewBox || \"0 0 24 24\"}\r\n                className=\"w-5 h-5\"\r\n                fill=\"none\"\r\n                stroke=\"currentColor\"\r\n                strokeWidth=\"1.6\"\r\n                strokeLinecap=\"round\"\r\n                strokeLinejoin=\"round\"\r\n                aria-hidden=\"true\"\r\n              >\r\n                {(icon.paths || []).map((path) => (\r\n                  <path key={path} d={path} />\r\n                ))}\r\n              </svg>\r\n            </div>\r\n            <span className=\"text-[11px] font-semibold text-gray-700 mt-0.5 leading-[1.05] min-h-[22px]\">\r\n              {item.label}\r\n            </span>\r\n          </button>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\BusinessDataStep.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onGoWelcome' is defined but never used.","line":17,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"onGoWelcome"},"fix":{"range":[375,391],"text":""},"desc":"Remove unused variable 'onGoWelcome'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport ErrorBanner from \"../blocks/ErrorBanner\";\r\nimport { normalizeBusinessName } from \"../utils/businessDataUtils\";\r\n\r\nexport default function BusinessDataStep({\r\n  error,\r\n  inputClassName,\r\n  nombreNegocio,\r\n  categoriaNegocio,\r\n  categoriaPadre,\r\n  categoriaDetalle,\r\n  subtitle,\r\n  onChangeNombre,\r\n  onOpenCategory,\r\n  onSubmit,\r\n  innerRef,\r\n  onGoWelcome,\r\n}) {\r\n  const fieldClassName = `${inputClassName} !mt-0 !mb-0 !border-gray-200 focus:border-[#5E30A5] focus:ring-2 focus:ring-[#5E30A5]/30 focus:outline-none`;\r\n  const labelClassName = \"block text-xs text-gray-500 ml-1 mb-0\";\r\n  const selectedCategory = categoriaNegocio || \"\";\r\n  const parentLabel = categoriaPadre || \"\";\r\n  const subLabel = categoriaDetalle || \"\";\r\n  const showSubcategory = Boolean(subLabel);\r\n\r\n  return (\r\n    <section\r\n      style={{ boxSizing: \"border-box\", position: \"relative\", zIndex: 1 }}\r\n      className=\"px-2 h-full\"\r\n    >\r\n      <div className=\"pb-4 flex h-full flex-col\" ref={innerRef}>\r\n        <div className=\"flex-1\">\r\n          <p className=\"text-sm text-gray-600 mt-3 mb-6 text-center\">\r\n            {subtitle || \"Así te verán tus clientes\"}\r\n          </p>\r\n\r\n          {error && <ErrorBanner message={error} className=\"mb-2\" />}\r\n\r\n          <div className=\"space-y-6\">\r\n            <div className=\"space-y-1\">\r\n              <label className={labelClassName}>Nombre negocio</label>\r\n              <input\r\n                className={fieldClassName}\r\n                value={nombreNegocio}\r\n                maxLength={38}\r\n                onChange={(event) =>\r\n                  onChangeNombre(normalizeBusinessName(event.target.value))\r\n                }\r\n              />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <label className={labelClassName}>Categoría</label>\r\n              {showSubcategory ? (\r\n                <div className=\"flex flex-col gap-3\">\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={onOpenCategory}\r\n                    className={`${fieldClassName} flex items-center gap-2 px-3 !pr-0`}\r\n                  >\r\n                    <span className=\"flex-1 text-left text-gray-900\">\r\n                      {parentLabel}\r\n                    </span>\r\n                    <span className=\"flex items-center justify-center h-full px-3 border-l border-black text-gray-900\">\r\n                      <PencilIcon className=\"w-4 h-4\" />\r\n                    </span>\r\n                  </button>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={onOpenCategory}\r\n                    className={`${fieldClassName} flex items-center gap-2 px-3 !pr-0`}\r\n                  >\r\n                    <span className=\"flex-1 text-left text-gray-900\">\r\n                      {subLabel}\r\n                    </span>\r\n                    <span className=\"flex items-center justify-center h-full px-3 border-l border-black text-gray-900\">\r\n                      <PencilIcon className=\"w-4 h-4\" />\r\n                    </span>\r\n                  </button>\r\n                </div>\r\n              ) : (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={onOpenCategory}\r\n                  className={`${fieldClassName} flex items-center gap-2 px-3 !pr-0`}\r\n                >\r\n                  <span\r\n                    className={`flex-1 text-left ${\r\n                      selectedCategory ? \"text-gray-900\" : \"text-gray-400\"\r\n                    }`}\r\n                  >\r\n                    {selectedCategory || \"Elige una categoría\"}\r\n                  </span>\r\n                  <span className=\"flex items-center justify-center h-full px-3 border-l border-black text-gray-900\">\r\n                    <PencilIcon className=\"w-4 h-4\" />\r\n                  </span>\r\n                </button>\r\n              )}\r\n            </div>\r\n\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-auto pt-4\">\r\n          <button\r\n            onClick={onSubmit}\r\n            className=\"w-full bg-[#5E30A5] text-white font-semibold py-2.5 rounded-lg shadow\"\r\n          >\r\n            Continuar\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </section>\r\n  );\r\n}\r\n\r\nfunction PencilIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n      aria-hidden=\"true\"\r\n    >\r\n      <path d=\"M12 20h9\" />\r\n      <path d=\"M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z\" />\r\n    </svg>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\BusinessVerifyStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\EmailLoginStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\EmailRegisterStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\EmailVerifyStep.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'hasPhone' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":85,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":85,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"hasPhone"},"fix":{"range":[2564,2627],"text":""},"desc":"Remove unused variable 'hasPhone'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'phoneValid' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":86,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":86,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"phoneValid"},"fix":{"range":[2631,2723],"text":""},"desc":"Remove unused variable 'phoneValid'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo, useState } from \"react\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\n\r\nconst COUNTRY_CODES = [\r\n  { code: \"+593\", label: \"Ecuador\" },\r\n  { code: \"+57\", label: \"Colombia\" },\r\n  { code: \"+51\", label: \"Peru\" },\r\n  { code: \"+1\", label: \"USA/Canada\" },\r\n  { code: \"+34\", label: \"Espana\" },\r\n  { code: \"+52\", label: \"Mexico\" },\r\n];\r\n\r\nfunction PencilIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M12 20h9\" />\r\n      <path d=\"M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5z\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction ChevronIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M6 9l6 6 6-6\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nexport default function AccountVerifyStep({\r\n  innerRef,\r\n  email,\r\n  emailConfirmed,\r\n  phone,\r\n  onSkip,\r\n  onComplete,\r\n}) {\r\n  const [message, setMessage] = useState(\"\");\r\n  const [error, setError] = useState(\"\");\r\n  const [sending, setSending] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [editingPhone, setEditingPhone] = useState(!phone);\r\n  const [editingEmail, setEditingEmail] = useState(false);\r\n  const [emailValue, setEmailValue] = useState(email || \"\");\r\n  const [emailSent, setEmailSent] = useState(false);\r\n  const [dropdownOpen, setDropdownOpen] = useState(false);\r\n  const [phoneConfirmed, setPhoneConfirmed] = useState(Boolean(phone));\r\n  const { openModal } = useModal();\r\n\r\n  const initialPhone = String(phone || \"\");\r\n  const parsed = useMemo(() => {\r\n    if (!initialPhone) {\r\n      return { code: \"+593\", digits: \"\" };\r\n    }\r\n    const match = COUNTRY_CODES.find((c) => initialPhone.startsWith(c.code));\r\n    if (match) {\r\n      return { code: match.code, digits: initialPhone.slice(match.code.length) };\r\n    }\r\n    return { code: \"+593\", digits: initialPhone.replace(/\\D/g, \"\") };\r\n  }, [initialPhone]);\r\n\r\n  const [countryCode, setCountryCode] = useState(parsed.code);\r\n  const [digits, setDigits] = useState(parsed.digits);\r\n\r\n  const normalizedDigits = digits.replace(/\\D/g, \"\");\r\n  const isEcuador = countryCode === \"+593\";\r\n  const normalizedPhone = `${countryCode}${normalizedDigits}`;\r\n  const hasPhone = Boolean(phone) || normalizedDigits.length > 0;\r\n  const phoneValid = isEcuador ? normalizedDigits.length === 9 : normalizedDigits.length >= 6;\r\n\r\n  const handleDigitsChange = (value) => {\r\n    let next = String(value || \"\").replace(/\\D/g, \"\");\r\n    if (isEcuador) {\r\n      if (next.startsWith(\"0\")) {\r\n        next = next.replace(/^0+/, \"\");\r\n      }\r\n      next = next.slice(0, 9);\r\n    }\r\n    setDigits(next);\r\n  };\r\n\r\n  const handleSendEmail = async () => {\r\n    setError(\"\");\r\n    setMessage(\"\");\r\n    if (!emailValue) {\r\n      setError(\"Ingresa un email valido\");\r\n      return;\r\n    }\r\n    setSending(true);\r\n    try {\r\n      const { error: resendError } = await supabase.auth.resend({\r\n        type: \"signup\",\r\n        email: emailValue,\r\n      });\r\n      if (resendError) throw resendError;\r\n      setMessage(\"Te enviamos un correo de verificacion.\");\r\n      setEmailSent(true);\r\n    } catch (err) {\r\n      setError(err?.message || \"No se pudo enviar el codigo\");\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    setError(\"\");\r\n    setMessage(\"\");\r\n    if (!emailSent) return;\r\n    if (!phoneConfirmed) return;\r\n\r\n    if (!editingPhone || (phone && normalizedPhone === phone)) {\r\n      onComplete?.();\r\n      return;\r\n    }\r\n\r\n    setSaving(true);\r\n    try {\r\n      const session = (await supabase.auth.getSession())?.data?.session;\r\n      const userId = session?.user?.id;\r\n      if (!userId) {\r\n        setError(\"No hay sesion activa\");\r\n        return;\r\n      }\r\n      const { error: updErr } = await supabase\r\n        .from(\"usuarios\")\r\n        .update({ telefono: normalizedPhone })\r\n        .eq(\"id_auth\", userId);\r\n      if (updErr) {\r\n        setError(updErr.message || \"No se pudo guardar el telefono\");\r\n        return;\r\n      }\r\n      onComplete?.();\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex h-full flex-col pb-4\" ref={innerRef}>\r\n      <div className=\"space-y-6\">\r\n        <p className=\"text-sm text-gray-600 text-center\">\r\n          Esto es opcional, pero te ayudara a sacarle mas provecho a la app.\r\n        </p>\r\n        {!emailConfirmed ? (\r\n          <div className=\"space-y-4 text-sm text-gray-700 mt-2\">\r\n            {!emailSent ? (\r\n              <>\r\n                <div className=\"space-y-1\">\r\n                  <label className=\"block text-xs text-gray-500 ml-1\">\r\n                    Verifica tu correo electronico.\r\n                  </label>\r\n                  {!editingEmail ? (\r\n                    <div className=\"flex items-center justify-between rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-700\">\r\n                      <span>{emailValue || \"Sin correo\"}</span>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => setEditingEmail(true)}\r\n                        className=\"text-gray-400 hover:text-gray-600\"\r\n                        aria-label=\"Editar email\"\r\n                      >\r\n                        <PencilIcon className=\"h-4 w-4\" />\r\n                      </button>\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"relative\">\r\n                      <input\r\n                        type=\"email\"\r\n                        value={emailValue}\r\n                        onChange={(event) => setEmailValue(event.target.value)}\r\n                        className=\"w-full rounded-lg border border-gray-200 px-3 py-2 pr-12 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#5E30A5]/30\"\r\n                        placeholder=\"tu@email.com\"\r\n                      />\r\n                      {emailValue && emailValue.includes(\"@\") && (\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => setEditingEmail(false)}\r\n                          className=\"absolute right-0 top-0 h-full px-3 text-xs font-semibold text-[#5E30A5] border-l border-gray-200\"\r\n                        >\r\n                          OK\r\n                        </button>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                {error && (\r\n                  <div className=\"text-center text-xs text-red-500\">{error}</div>\r\n                )}\r\n                <div className=\"text-center text-xs text-gray-500\">\r\n                  Te enviaremos un codigo a este correo.\r\n                </div>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleSendEmail}\r\n                  disabled={sending}\r\n                  className=\"w-full text-sm font-semibold text-[#5E30A5] disabled:opacity-60\"\r\n                >\r\n                  {sending ? \"Enviando...\" : \"Enviar correo\"}\r\n                </button>\r\n              </>\r\n            ) : (\r\n              <>\r\n                <div className=\"text-center text-xs text-emerald-500\">\r\n                  {message}\r\n                </div>\r\n                <div className=\"text-center text-xs text-gray-500\">\r\n                  Revisa tu bandeja de entrada o spam. Y sigue las instrucciones\r\n                  del correo.\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n        ) : (\r\n          <div className=\"rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-4 text-sm text-gray-700\">\r\n            <div className=\"text-center text-sm font-semibold text-emerald-600\">\r\n              Correo verificado\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        <div className=\"space-y-2 mt-10\">\r\n          <div className=\"text-sm font-semibold text-gray-900\">\r\n            Informacion de contacto\r\n          </div>\r\n          {!editingPhone && phoneConfirmed && phone ? (\r\n            <div className=\"flex items-center justify-between rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-700\">\r\n              <span>{phone}</span>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setEditingPhone(true)}\r\n                className=\"text-gray-400 hover:text-gray-600\"\r\n                aria-label=\"Editar telefono\"\r\n              >\r\n                <PencilIcon className=\"h-4 w-4\" />\r\n              </button>\r\n            </div>\r\n          ) : (\r\n          <div className=\"space-y-1\">\r\n            <label className=\"block text-xs text-gray-500 ml-1\">Telefono</label>\r\n              <div className=\"relative flex items-stretch rounded-lg border border-gray-200 bg-white overflow-visible\">\r\n                <button\r\n                type=\"button\"\r\n                onClick={() => setDropdownOpen((prev) => !prev)}\r\n                className=\"flex items-center gap-1 px-3 text-sm text-gray-400 border-r border-gray-200\"\r\n              >\r\n                {countryCode}\r\n                <ChevronIcon className=\"h-4 w-4 text-gray-400\" />\r\n              </button>\r\n                <input\r\n                  type=\"text\"\r\n                  inputMode=\"numeric\"\r\n                  value={normalizedDigits}\r\n                  onChange={(event) => handleDigitsChange(event.target.value)}\r\n                  placeholder=\"Ej: 987654321\"\r\n                  className=\"flex-1 px-3 py-2 pr-12 text-sm text-gray-700 focus:outline-none\"\r\n                />\r\n                {normalizedDigits.length > 0 &&\r\n                  ((isEcuador && normalizedDigits.length === 9) ||\r\n                    (!isEcuador && normalizedDigits.length >= 6)) && (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setPhoneConfirmed(true)}\r\n                      className=\"absolute right-0 top-0 h-full px-3 text-xs font-semibold text-[#5E30A5] border-l border-gray-200\"\r\n                    >\r\n                      OK\r\n                    </button>\r\n                  )}\r\n                {dropdownOpen && (\r\n                  <div className=\"absolute left-0 top-full z-[60] mt-2 w-40 rounded-lg border border-gray-200 bg-white shadow-lg\">\r\n                    {COUNTRY_CODES.map((item) => (\r\n                      <button\r\n                        key={item.code}\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                          setCountryCode(item.code);\r\n                          setDropdownOpen(false);\r\n                          setPhoneConfirmed(false);\r\n                        }}\r\n                        className=\"w-full px-3 py-2 text-left text-sm text-gray-700 hover:bg-gray-50\"\r\n                      >\r\n                        {item.code} {item.label}\r\n                      </button>\r\n                    ))}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n      </div>\r\n\r\n      <div className=\"mt-auto pt-6 space-y-3\">\r\n        <div className=\"text-xs text-gray-500 text-center\">\r\n          Si prefieres, tambien puedes continuar sin verificar.\r\n          Podras publicar 1 promocion por una semana, aunque las cuentas\r\n          verificadas aparecen con mas visibilidad para los usuarios.\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleSave}\r\n          disabled={!emailSent || !phoneConfirmed || saving}\r\n          className=\"w-full bg-[#5E30A5] text-white font-semibold py-2.5 rounded-lg shadow disabled:opacity-60 disabled:cursor-not-allowed\"\r\n        >\r\n          {saving ? \"Guardando...\" : \"Listo\"}\r\n        </button>\r\n        <button\r\n          type=\"button\"\r\n          onClick={() =>\r\n            openModal(\"AccountVerifySkip\", {\r\n              onConfirm: () => onSkip?.(),\r\n            })\r\n          }\r\n          className=\"w-full text-sm font-semibold text-gray-500\"\r\n        >\r\n          Saltar\r\n        </button>\r\n      </div>\r\n\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\ErrorStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\OAuthCallbackStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\PendingStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\RoleSelectStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\UserAddressStep.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'addressLabel' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":85,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":85,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"addressLabel"},"fix":{"range":[3123,3135],"text":""},"desc":"Remove unused variable 'addressLabel'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'hasMapMoved' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":114,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":114,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"hasMapMoved"},"fix":{"range":[4410,4421],"text":""},"desc":"Remove unused variable 'hasMapMoved'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'hasMapZoomed' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":115,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":115,"endColumn":22,"suggestions":[{"messageId":"removeVar","data":{"varName":"hasMapZoomed"},"fix":{"range":[4468,4480],"text":""},"desc":"Remove unused variable 'hasMapZoomed'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'stage'. Either include it or remove the dependency array.","line":349,"column":6,"nodeType":"ArrayExpression","endLine":349,"endColumn":56,"suggestions":[{"desc":"Update the dependencies array to be: [coords, coordsSource, setCoords, setCoordsSource, stage]","fix":{"range":[11368,11418],"text":"[coords, coordsSource, setCoords, setCoordsSource, stage]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selected'. Either include it or remove the dependency array.","line":1979,"column":6,"nodeType":"ArrayExpression","endLine":1979,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [selected, selected?.nombre]","fix":{"range":[74444,74462],"text":"[selected, selected?.nombre]"}}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\r\nimport ErrorBanner from \"../blocks/ErrorBanner\";\r\nimport { searchAddresses } from \"../../services/addressSearchClient\";\r\nimport { reverseGeocode } from \"../../services/addressReverseClient\";\r\nimport { getGpsFallbackLocation } from \"../../services/gpsFallbackClient\";\r\nimport {\r\n  fetchProvincias,\r\n  fetchCantonesByProvincia,\r\n  fetchParroquiasByCanton,\r\n} from \"../../services/territoryClient\";\r\nimport LeafletMapPicker from \"../../components/maps/LeafletMapPicker\";\r\nimport AddressStepSearch from \"../../search/auth/AddressStepSearch\";\r\nimport { toTitleCaseEs } from \"../../utils/textCase\";\r\nimport useLocationStep from \"../hooks/useLocationStep\";\r\nimport { useModal } from \"../../modals/useModal\";\r\n\r\nconst DEFAULT_MAP_CENTER = { lat: -0.2200934426615961, lng: -78.51208009501421 };\r\nconst FALLBACK_ZOOM = 11;\r\nconst CLOSE_ZOOM = 16;\r\nconst DEFAULT_HORARIOS = {\r\n  semanal: {\r\n    lunes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    martes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    miercoles: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    jueves: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    viernes: [{ abre: \"10:00\", cierra: \"18:00\" }],\r\n    sabado: [],\r\n    domingo: [],\r\n  },\r\n  excepciones: [],\r\n};\r\nconst WEEK_DAYS = [\r\n  { key: \"lunes\", label: \"Lunes\" },\r\n  { key: \"martes\", label: \"Martes\" },\r\n  { key: \"miercoles\", label: \"Miercoles\" },\r\n  { key: \"jueves\", label: \"Jueves\" },\r\n  { key: \"viernes\", label: \"Viernes\" },\r\n  { key: \"sabado\", label: \"Sabado\" },\r\n  { key: \"domingo\", label: \"Domingo\" },\r\n];\r\nconst WEEKDAY_KEYS = [\"lunes\", \"martes\", \"miercoles\", \"jueves\", \"viernes\"];\r\nconst WEEKEND_KEYS = [\"sabado\", \"domingo\"];\r\nconst CLIENT_ADDRESS_TAGS = [\"Casa\", \"Oficina\", \"Trabajo\"];\r\nconst CLIENT_ADDRESS_OTHER = \"Otro\";\r\nconst CLIENT_ADDRESS_CUSTOM_KEY = \"custom\";\r\nconst CLIENT_ADDRESS_TAG_KEY = \"client_address_label\";\r\nconst CLIENT_ADDRESS_TAG_DRAFT_KEY = \"client_address_label_draft\";\r\nconst CLIENT_ADDRESS_MIN_LENGTH = 3;\r\nconst CLIENT_ADDRESS_MAX_DIGITS = 2;\r\n\r\n\r\n\r\nexport default function UserAddressStep({\r\n  innerRef,\r\n  searchModeOpen,\r\n  onSearchModeChange,\r\n  isAddressPrefillReady,\r\n  isSucursalPrincipal,\r\n  onChangeSucursalPrincipal,\r\n  horarios,\r\n  onChangeHorarios,\r\n  direccionPayload,\r\n  onChangeDireccionPayload,\r\n  subtitle,\r\n  error,\r\n  onSubmit,\r\n  mode = \"negocio\",\r\n  requireHorarios,\r\n  onSkip,\r\n  primaryLabel = \"Entrar\",\r\n}) {\r\n  const isBusiness = mode === \"negocio\";\r\n  const shouldRequireHorarios =\r\n    typeof requireHorarios === \"boolean\" ? requireHorarios : isBusiness;\r\n  const [stage, setStage] = useState(\"pending\");\r\n  const [searchValue, setSearchValue] = useState(\"\");\r\n  const isSearchModeOpen = Boolean(searchModeOpen);\r\n  const setIsSearchModeOpen = useCallback((next) => {\r\n    onSearchModeChange?.(next);\r\n  }, [onSearchModeChange]);\r\n  const [selectedSearchItem, setSelectedSearchItem] = useState(null);\r\n  const [isSearching, setIsSearching] = useState(false);\r\n  const [searchError, setSearchError] = useState(\"\");\r\n  const [hasSearched, setHasSearched] = useState(false);\r\n  const [addressLabel, setAddressLabel] = useState(\"\");\r\n  const [reverseError, setReverseError] = useState(\"\");\r\n  const [isReverseLoading, setIsReverseLoading] = useState(false);\r\n  const [coords, setCoords] = useState(null);\r\n  const [coordsSource, setCoordsSource] = useState(null);\r\n  const [localError, setLocalError] = useState(\"\");\r\n  const [mapStatus, setMapStatus] = useState(\"loading\");\r\n  const [mapZoom, setMapZoom] = useState(FALLBACK_ZOOM);\r\n  const [animateZoom, setAnimateZoom] = useState(false);\r\n  const [showZoomHint, setShowZoomHint] = useState(false);\r\n  const [expandedGroup, setExpandedGroup] = useState(null);\r\n  const [territory, setTerritory] = useState({\r\n    provincias: [],\r\n    cantonesByProvincia: {},\r\n    parroquiasByCanton: {},\r\n    provinciaById: {},\r\n    cantonById: {},\r\n    parroquiaById: {},\r\n  });\r\n  const [territoryError, setTerritoryError] = useState(\"\");\r\n  const [isLoadingTerritory, setIsLoadingTerritory] = useState(true);\r\n  const [provinciaId, setProvinciaId] = useState(\r\n    () => direccionPayload?.provincia_id || \"\"\r\n  );\r\n  const [cantonId, setCantonId] = useState(\r\n    () => direccionPayload?.canton_id || \"\"\r\n  );\r\n  const [parroquiaId, setParroquiaId] = useState(\"\");\r\n  const [searchResults, setSearchResults] = useState([]);\r\n  const [hasMapMoved, setHasMapMoved] = useState(false);\r\n  const [hasMapZoomed, setHasMapZoomed] = useState(false);\r\n  const [addressTag, setAddressTag] = useState(\"\");\r\n  const [activeTag, setActiveTag] = useState(\"\");\r\n  const [customTagInput, setCustomTagInput] = useState(\"\");\r\n  const [isCustomEditing, setIsCustomEditing] = useState(false);\r\n  const initialMoveSkippedRef = useRef(false);\r\n  const initialZoomSkippedRef = useRef(false);\r\n  const programmaticMoveRef = useRef(false);\r\n  const programmaticZoomRef = useRef(false);\r\n  const zoomSequenceRef = useRef(null);\r\n  const addressTagInitRef = useRef(false);\r\n  const customInputRef = useRef(null);\r\n  const { openModal } = useModal();\r\n  const weekdaysRef = useRef(null);\r\n  const weekendRef = useRef(null);\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n\r\n    const loadProvincias = async () => {\r\n      setIsLoadingTerritory(true);\r\n      setTerritoryError(\"\");\r\n      const result = await fetchProvincias();\r\n      if (!active) return;\r\n      if (!result.ok) {\r\n        setTerritoryError(result.error || \"No se pudo cargar provincias\");\r\n        setIsLoadingTerritory(false);\r\n        return;\r\n      }\r\n\r\n      const provinciaById = {};\r\n      (result.data || []).forEach((prov) => {\r\n        provinciaById[prov.id] = prov;\r\n      });\r\n\r\n      setTerritory((prev) => ({\r\n        ...prev,\r\n        provincias: result.data || [],\r\n        provinciaById,\r\n      }));\r\n      setIsLoadingTerritory(false);\r\n    };\r\n\r\n    loadProvincias();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!provinciaId && direccionPayload?.provincia_id) {\r\n      setProvinciaId(direccionPayload.provincia_id);\r\n    }\r\n    if (!cantonId && direccionPayload?.canton_id) {\r\n      setCantonId(direccionPayload.canton_id);\r\n    }\r\n  }, [direccionPayload?.canton_id, direccionPayload?.provincia_id, cantonId, provinciaId]);\r\n\r\n  useEffect(() => {\r\n    if (!provinciaId) {\r\n      setCantonId(\"\");\r\n      setParroquiaId(\"\");\r\n    }\r\n  }, [provinciaId]);\r\n\r\n  useEffect(() => {\r\n    if (!cantonId) {\r\n      setParroquiaId(\"\");\r\n    }\r\n  }, [cantonId]);\r\n\r\n  const buildDireccionPayload = useCallback(\r\n    (overrides = {}) => ({\r\n      place_id: \"\",\r\n      label: \"\",\r\n      display_label: \"\",\r\n      provider: \"\",\r\n      lat: null,\r\n      lng: null,\r\n      parroquia_id: \"\",\r\n      parroquia: \"\",\r\n      ciudad: \"\",\r\n      sector: \"\",\r\n      calles: \"\",\r\n      house_number: \"\",\r\n      postcode: \"\",\r\n      referencia: \"\",\r\n      provincia: \"\",\r\n      canton: \"\",\r\n      country: \"\",\r\n      ...direccionPayload,\r\n      provincia_id: direccionPayload?.provincia_id || provinciaId || \"\",\r\n      canton_id: direccionPayload?.canton_id || cantonId || \"\",\r\n      ...overrides,\r\n    }),\r\n    [direccionPayload, provinciaId, cantonId]\r\n  );\r\n\r\n  const updateDireccionPayload = useCallback(\r\n    (overrides = {}) => {\r\n      onChangeDireccionPayload?.(buildDireccionPayload(overrides));\r\n    },\r\n    [buildDireccionPayload, onChangeDireccionPayload]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (isBusiness) return;\r\n    if (addressTagInitRef.current) return;\r\n    const storedLabel =\r\n      typeof window !== \"undefined\"\r\n        ? localStorage.getItem(CLIENT_ADDRESS_TAG_KEY) || \"\"\r\n        : \"\";\r\n    const storedDraft =\r\n      typeof window !== \"undefined\"\r\n        ? localStorage.getItem(CLIENT_ADDRESS_TAG_DRAFT_KEY) || \"\"\r\n        : \"\";\r\n    const payloadReference = String(direccionPayload?.referencia || \"\").trim();\r\n    const initialLabel = (storedLabel || payloadReference || \"\").trim();\r\n    if (initialLabel) {\r\n      if (CLIENT_ADDRESS_TAGS.includes(initialLabel)) {\r\n        setActiveTag(initialLabel);\r\n        setAddressTag(initialLabel);\r\n        setCustomTagInput(\"\");\r\n        setIsCustomEditing(false);\r\n      } else {\r\n        setActiveTag(CLIENT_ADDRESS_CUSTOM_KEY);\r\n        setAddressTag(initialLabel);\r\n        setCustomTagInput(storedDraft || initialLabel);\r\n        setIsCustomEditing(false);\r\n      }\r\n    } else {\r\n      setActiveTag(\"\");\r\n      setAddressTag(\"\");\r\n      setCustomTagInput(storedDraft || \"\");\r\n      setIsCustomEditing(false);\r\n    }\r\n    addressTagInitRef.current = true;\r\n  }, [direccionPayload?.referencia, isBusiness]);\r\n\r\n  useEffect(() => {\r\n    if (isBusiness) return;\r\n    if (typeof window === \"undefined\") return;\r\n    localStorage.setItem(CLIENT_ADDRESS_TAG_KEY, addressTag);\r\n  }, [addressTag, isBusiness]);\r\n\r\n  useEffect(() => {\r\n    if (isBusiness) return;\r\n    if (typeof window === \"undefined\") return;\r\n    localStorage.setItem(CLIENT_ADDRESS_TAG_DRAFT_KEY, customTagInput);\r\n  }, [customTagInput, isBusiness]);\r\n\r\n  useEffect(() => {\r\n    if (!isCustomEditing) return;\r\n    const timer = setTimeout(() => {\r\n      customInputRef.current?.focus?.();\r\n    }, 0);\r\n    return () => clearTimeout(timer);\r\n  }, [isCustomEditing]);\r\n\r\n  useEffect(() => {\r\n    if (isBusiness) return;\r\n    const currentRef = String(direccionPayload?.referencia || \"\");\r\n    if (addressTag === currentRef) return;\r\n    updateDireccionPayload({ referencia: addressTag });\r\n  }, [addressTag, direccionPayload?.referencia, isBusiness, updateDireccionPayload]);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (zoomSequenceRef.current) {\r\n        clearTimeout(zoomSequenceRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n  const { requestLocation } = useLocationStep({\r\n    stage,\r\n    coords,\r\n    direccionPayload,\r\n    setCoords,\r\n    setCoordsSource,\r\n    setMapZoom,\r\n    updateDireccionPayload,\r\n    programmaticMoveRef,\r\n    programmaticZoomRef,\r\n    closeZoom: CLOSE_ZOOM,\r\n    locationTitle: isBusiness ? \"Ubicación del negocio\" : \"Ubicación\",\r\n  });\r\n\r\n  const isPrefillReady = Boolean(isAddressPrefillReady);\r\n  const hasSavedAddress =\r\n    Boolean(direccionPayload?.place_id) &&\r\n    Boolean(direccionPayload?.label) &&\r\n    direccionPayload?.lat != null &&\r\n    direccionPayload?.lng != null;\r\n\r\n  useEffect(() => {\r\n    if (!isPrefillReady) {\r\n      if (stage !== \"pending\") {\r\n        setStage(\"pending\");\r\n      }\r\n      return;\r\n    }\r\n    if (hasSavedAddress && stage !== \"summary\") {\r\n      setStage(\"summary\");\r\n    } else if (!hasSavedAddress && stage !== \"map\") {\r\n      setStage(\"map\");\r\n    }\r\n  }, [hasSavedAddress, isPrefillReady, stage]);\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    if (stage !== \"map\") {\r\n      return undefined;\r\n    }\r\n    if (coordsSource === \"gps\" || coords) {\r\n      return undefined;\r\n    }\r\n\r\n    const loadFallbackLocation = async () => {\r\n      const result = await getGpsFallbackLocation();\r\n      if (!active || !result?.ok || !result.location) return;\r\n      const fallbackCoords = {\r\n        lat: result.location.lat,\r\n        lng: result.location.lng,\r\n      };\r\n      if (coords) return;\r\n      programmaticMoveRef.current = true;\r\n      setCoords(fallbackCoords);\r\n      setCoordsSource(\"fallback\");\r\n    };\r\n\r\n    loadFallbackLocation();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, [coords, coordsSource, setCoords, setCoordsSource]);\r\n\r\n  const startConfirmZoom = () => {\r\n    if (animateZoom) return;\r\n    if (zoomSequenceRef.current) {\r\n      clearTimeout(zoomSequenceRef.current);\r\n    }\r\n    setAnimateZoom(true);\r\n    const currentZoom = Number.isFinite(mapZoom) ? Math.floor(mapZoom) : FALLBACK_ZOOM;\r\n    const startZoom = Math.min(currentZoom + 1, 18);\r\n    const steps = [];\r\n    for (let z = startZoom; z <= 18; z += 1) {\r\n      steps.push(z);\r\n    }\r\n    if (steps.length == 0) {\r\n      setAnimateZoom(false);\r\n      return;\r\n    }\r\n    let index = 0;\r\n    const tick = () => {\r\n      const nextZoom = steps[index];\r\n      programmaticZoomRef.current = true;\r\n      setMapZoom(nextZoom);\r\n      index += 1;\r\n      if (index >= steps.length) {\r\n        zoomSequenceRef.current = null;\r\n        setTimeout(() => {\r\n          setAnimateZoom(false);\r\n        }, 250);\r\n        return;\r\n      }\r\n      zoomSequenceRef.current = setTimeout(tick, 220);\r\n    };\r\n    tick();\r\n  };\r\n\r\n  const handleConfirm = async () => {\r\n    setLocalError(\"\");\r\n    setReverseError(\"\");\r\n    const center = displayCoords || mapCenter;\r\n    if (!center) {\r\n      setLocalError(\"Selecciona una ubicación válida.\");\r\n      return;\r\n    }\r\n\r\n    if (!isOffFallback) {\r\n      setLocalError(\"Selecciona una ubicación válida.\");\r\n      return;\r\n    }\r\n\r\n    if (mapZoom < 16) {\r\n      setShowZoomHint(true);\r\n      startConfirmZoom();\r\n      return;\r\n    }\r\n\r\n    setIsReverseLoading(true);\r\n    const result = await reverseGeocode(center.lat, center.lng);\r\n    setIsReverseLoading(false);\r\n    if (!result.ok) {\r\n      setReverseError(\"No se pudo obtener la dirección.\");\r\n      return;\r\n    }\r\n    const data = result.data || {};\r\n    const fields = data.display_fields || {};\r\n    const displayLabel = formatDisplayParts(data);\r\n    const rawLabel = data.raw_label || data.label || \"\";\r\n    setAddressLabel(displayLabel);\r\n    updateDireccionPayload({\r\n      place_id: data.id || \"\",\r\n      label: rawLabel,\r\n      display_label: displayLabel,\r\n      provider: data.provider || \"\",\r\n      lat: center.lat,\r\n      lng: center.lng,\r\n      parroquia_id: data.parroquia_id || \"\",\r\n      parroquia: fields.parroquia ?? data.parroquia ?? \"\",\r\n      ciudad: fields.ciudad ?? data.ciudad ?? \"\",\r\n      sector: fields.sector ?? data.sector ?? \"\",\r\n      calles: fields.calles ?? data.calles ?? \"\",\r\n      house_number: fields.house_number ?? data.house_number ?? \"\",\r\n      postcode: fields.postcode ?? data.postcode ?? \"\",\r\n      referencia: \"\",\r\n      provincia_id: data.provincia_id || provinciaId,\r\n      canton_id: data.canton_id || cantonId,\r\n      provincia: fields.provincia ?? data.provincia ?? \"\",\r\n      canton: fields.canton ?? data.canton ?? \"\",\r\n      country: fields.country ?? data.country ?? \"\",\r\n    });\r\n    setStage(\"summary\");\r\n  };\r\n\r\n  const resetDireccionPayload = (overrides = {}) => {\r\n    updateDireccionPayload({\r\n      place_id: \"\",\r\n      label: \"\",\r\n      display_label: \"\",\r\n      provider: \"\",\r\n      lat: null,\r\n      lng: null,\r\n      parroquia_id: \"\",\r\n      parroquia: \"\",\r\n      ciudad: \"\",\r\n      sector: \"\",\r\n      calles: \"\",\r\n      house_number: \"\",\r\n      postcode: \"\",\r\n      referencia: \"\",\r\n      provincia: \"\",\r\n      canton: \"\",\r\n      country: \"\",\r\n      provincia_id: overrides.provincia_id ?? provinciaId ?? \"\",\r\n      canton_id: overrides.canton_id ?? cantonId ?? \"\",\r\n    });\r\n  };\r\n\r\n  const handleSelectSuggestion = (item) => {\r\n    setSelectedSearchItem(item);\r\n  };\r\n\r\n  const applySearchSelection = (item) => {\r\n    const fields = item.display_fields || {};\r\n    const displayLabel = formatDisplayParts(item);\r\n    const rawLabel = item.raw_label || item.label || \"\";\r\n    setSearchValue(displayLabel);\r\n    setSearchResults([]);\r\n    setSearchError(\"\");\r\n    setHasSearched(false);\r\n    setIsSearchModeOpen(false);\r\n    if (item.lat && item.lng) {\r\n      programmaticMoveRef.current = true;\r\n      setCoords({\r\n        lat: Number(item.lat),\r\n        lng: Number(item.lng),\r\n      });\r\n      setCoordsSource(\"search\");\r\n      programmaticZoomRef.current = true;\r\n      setMapZoom(CLOSE_ZOOM);\r\n    }\r\n    updateDireccionPayload({\r\n      place_id: item.id,\r\n      label: rawLabel,\r\n      display_label: displayLabel,\r\n      provider: item.provider || \"\",\r\n      lat: item.lat ?? null,\r\n      lng: item.lng ?? null,\r\n      provincia_id: item.provincia_id || provinciaId || \"\",\r\n      canton_id: item.canton_id || cantonId || \"\",\r\n      parroquia_id: item.parroquia_id || \"\",\r\n      parroquia: fields.parroquia ?? item.parroquia ?? \"\",\r\n      ciudad: fields.ciudad ?? item.ciudad ?? \"\",\r\n      sector: fields.sector ?? item.sector ?? \"\",\r\n      calles: fields.calles ?? item.calles ?? item.street ?? \"\",\r\n      house_number: fields.house_number ?? item.house_number ?? \"\",\r\n      postcode: fields.postcode ?? item.postcode ?? \"\",\r\n      referencia: \"\",\r\n      provincia: fields.provincia ?? item.provincia ?? \"\",\r\n      canton: fields.canton ?? item.canton ?? \"\",\r\n      country: fields.country ?? item.country ?? \"\",\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    const loadCantones = async () => {\r\n      if (!provinciaId) return;\r\n      const result = await fetchCantonesByProvincia(provinciaId);\r\n      if (!active) return;\r\n      if (!result.ok) {\r\n        setTerritoryError(result.error || \"No se pudo cargar cantones\");\r\n        return;\r\n      }\r\n      const cantonById = {};\r\n      (result.data || []).forEach((canton) => {\r\n        cantonById[canton.id] = canton;\r\n      });\r\n      setTerritory((prev) => ({\r\n        ...prev,\r\n        cantonesByProvincia: {\r\n          ...prev.cantonesByProvincia,\r\n          [provinciaId]: result.data || [],\r\n        },\r\n        cantonById: {\r\n          ...prev.cantonById,\r\n          ...cantonById,\r\n        },\r\n      }));\r\n    };\r\n\r\n    loadCantones();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, [provinciaId]);\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    const loadParroquias = async () => {\r\n      if (!cantonId) return;\r\n      const result = await fetchParroquiasByCanton(cantonId);\r\n      if (!active) return;\r\n      if (!result.ok) {\r\n        setTerritoryError(result.error || \"No se pudo cargar parroquias\");\r\n        return;\r\n      }\r\n      const parroquiaById = {};\r\n      (result.data || []).forEach((parroquia) => {\r\n        parroquiaById[parroquia.id] = parroquia;\r\n      });\r\n      setTerritory((prev) => ({\r\n        ...prev,\r\n        parroquiasByCanton: {\r\n          ...prev.parroquiasByCanton,\r\n          [cantonId]: result.data || [],\r\n        },\r\n        parroquiaById: {\r\n          ...prev.parroquiaById,\r\n          ...parroquiaById,\r\n        },\r\n      }));\r\n    };\r\n\r\n    loadParroquias();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, [cantonId]);\r\n\r\n  const provinciaOptions = territory.provincias;\r\n  const cantonOptions = useMemo(\r\n    () => territory.cantonesByProvincia[provinciaId] || [],\r\n    [territory.cantonesByProvincia, provinciaId]\r\n  );\r\n  const parroquiaOptions = useMemo(\r\n    () => territory.parroquiasByCanton[cantonId] || [],\r\n    [territory.parroquiasByCanton, cantonId]\r\n  );\r\n\r\n  const provinciaNombre = territory.provinciaById[provinciaId]?.nombre || \"\";\r\n  const cantonNombre = territory.cantonById[cantonId]?.nombre || \"\";\r\n  const parroquiaNombre = territory.parroquiaById[parroquiaId]?.nombre || \"\";\r\n  const payloadProvincia = toTitleCaseEs(\r\n    direccionPayload?.provincia || provinciaNombre || \"\"\r\n  );\r\n  const payloadCanton = toTitleCaseEs(\r\n    direccionPayload?.canton || cantonNombre || \"\"\r\n  );\r\n  const payloadParroquia = toTitleCaseEs(\r\n    direccionPayload?.parroquia || parroquiaNombre || \"\"\r\n  );\r\n  const referenciaValue = String(direccionPayload?.referencia || \"\");\r\n  const customTagDigits = countDigits(customTagInput);\r\n  const customTagTrimmed = customTagInput.trim();\r\n  const customTagValid =\r\n    customTagTrimmed.length >= CLIENT_ADDRESS_MIN_LENGTH &&\r\n    customTagDigits <= CLIENT_ADDRESS_MAX_DIGITS;\r\n  const customBadgeLabel =\r\n    addressTag && !CLIENT_ADDRESS_TAGS.includes(addressTag)\r\n      ? addressTag\r\n      : CLIENT_ADDRESS_OTHER;\r\n  const badgeBase =\r\n    \"px-3 py-1.5 text-xs rounded-full border transition-colors\";\r\n  const currentHorarios =\r\n    horarios && typeof horarios === \"object\" ? horarios : DEFAULT_HORARIOS;\r\n  const hasAnyHorario = shouldRequireHorarios\r\n    ? WEEK_DAYS.some(\r\n      (day) => (currentHorarios?.semanal?.[day.key] || []).length > 0\r\n    )\r\n    : true;\r\n  const handleSelectTag = useCallback(\r\n    (tag) => {\r\n      setActiveTag(tag);\r\n      setAddressTag(tag);\r\n      setIsCustomEditing(false);\r\n    },\r\n    []\r\n  );\r\n  const handleStartCustom = useCallback(() => {\r\n    setActiveTag(CLIENT_ADDRESS_CUSTOM_KEY);\r\n    setIsCustomEditing(true);\r\n    if (!customTagInput && addressTag && !CLIENT_ADDRESS_TAGS.includes(addressTag)) {\r\n      setCustomTagInput(addressTag);\r\n    }\r\n  }, [addressTag, customTagInput]);\r\n  const handleCustomChange = useCallback((event) => {\r\n    const next = event.target.value;\r\n    if (countDigits(next) > CLIENT_ADDRESS_MAX_DIGITS) return;\r\n    setCustomTagInput(next);\r\n    setActiveTag(CLIENT_ADDRESS_CUSTOM_KEY);\r\n    setAddressTag(next.trim());\r\n  }, []);\r\n  const handleCustomConfirm = useCallback(() => {\r\n    const trimmed = customTagInput.trim();\r\n    if (trimmed.length < CLIENT_ADDRESS_MIN_LENGTH) return;\r\n    if (countDigits(trimmed) > CLIENT_ADDRESS_MAX_DIGITS) return;\r\n    setAddressTag(trimmed);\r\n    setCustomTagInput(trimmed);\r\n    setActiveTag(CLIENT_ADDRESS_CUSTOM_KEY);\r\n    setIsCustomEditing(false);\r\n  }, [customTagInput]);\r\n\r\n  const updateHorarios = useCallback(\r\n    (nextValue) => {\r\n      onChangeHorarios?.(nextValue);\r\n    },\r\n    [onChangeHorarios]\r\n  );\r\n\r\n  const handleToggleDay = useCallback(\r\n    (dayKey) => {\r\n      const next = {\r\n        ...currentHorarios,\r\n        semanal: { ...currentHorarios.semanal },\r\n      };\r\n      const entries = Array.isArray(next.semanal?.[dayKey])\r\n        ? next.semanal[dayKey]\r\n        : [];\r\n      if (entries.length > 0) {\r\n        next.semanal[dayKey] = [];\r\n      } else {\r\n        next.semanal[dayKey] = [{ abre: \"10:00\", cierra: \"18:00\" }];\r\n      }\r\n      updateHorarios(next);\r\n    },\r\n    [currentHorarios, updateHorarios]\r\n  );\r\n\r\n  const updateDayTime = useCallback(\r\n    (dayKey, field, value) => {\r\n      const next = {\r\n        ...currentHorarios,\r\n        semanal: { ...currentHorarios.semanal },\r\n      };\r\n      const existing = Array.isArray(next.semanal?.[dayKey])\r\n        ? next.semanal[dayKey][0]\r\n        : null;\r\n      const base = existing || { abre: \"10:00\", cierra: \"18:00\" };\r\n      next.semanal[dayKey] = [\r\n        {\r\n          ...base,\r\n          [field]: value,\r\n        },\r\n      ];\r\n      updateHorarios(next);\r\n    },\r\n    [currentHorarios, updateHorarios]\r\n  );\r\n\r\n  const getEntry = useCallback(\r\n    (dayKey) => currentHorarios?.semanal?.[dayKey]?.[0] || null,\r\n    [currentHorarios]\r\n  );\r\n\r\n  const getGroupInfo = useCallback(\r\n    (keys) => {\r\n      const entries = keys.map((key) => getEntry(key));\r\n      const activeEntries = entries.filter(Boolean);\r\n      const anySelected = activeEntries.length > 0;\r\n      const allSelected = activeEntries.length === keys.length;\r\n      let sameHours = false;\r\n      if (allSelected && activeEntries.length > 0) {\r\n        const base = activeEntries[0];\r\n        sameHours = activeEntries.every(\r\n          (entry) => entry.abre === base.abre && entry.cierra === base.cierra\r\n        );\r\n      }\r\n      if (!anySelected) {\r\n        return {\r\n          anySelected: false,\r\n          allSelected: false,\r\n          partial: false,\r\n          timeLabel: \"--:-- - --:--\",\r\n          showPersonalizado: false,\r\n          baseEntry: { abre: \"10:00\", cierra: \"18:00\" },\r\n        };\r\n      }\r\n      if (allSelected && sameHours) {\r\n        return {\r\n          anySelected: true,\r\n          allSelected: true,\r\n          partial: false,\r\n          timeLabel: `${activeEntries[0].abre} - ${activeEntries[0].cierra}`,\r\n          showPersonalizado: false,\r\n          baseEntry: activeEntries[0],\r\n        };\r\n      }\r\n      return {\r\n        anySelected: true,\r\n        allSelected: false,\r\n        partial: true,\r\n        timeLabel: \"Personalizado\",\r\n        showPersonalizado: true,\r\n        baseEntry: activeEntries[0] || { abre: \"10:00\", cierra: \"18:00\" },\r\n      };\r\n    },\r\n    [getEntry]\r\n  );\r\n\r\n  const toggleGroupSelection = useCallback(\r\n    (groupKey) => {\r\n      const keys = groupKey === \"weekdays\" ? WEEKDAY_KEYS : WEEKEND_KEYS;\r\n      const info = getGroupInfo(keys);\r\n      const next = {\r\n        ...currentHorarios,\r\n        semanal: { ...currentHorarios.semanal },\r\n      };\r\n      if (info.allSelected) {\r\n        keys.forEach((key) => {\r\n          next.semanal[key] = [];\r\n        });\r\n      } else {\r\n        const base = info.baseEntry || { abre: \"10:00\", cierra: \"18:00\" };\r\n        keys.forEach((key) => {\r\n          next.semanal[key] = [{ ...base }];\r\n        });\r\n      }\r\n      updateHorarios(next);\r\n    },\r\n    [currentHorarios, getGroupInfo, updateHorarios]\r\n  );\r\n\r\n  const updateGroupTime = useCallback(\r\n    (groupKey, field, value) => {\r\n      const keys = groupKey === \"weekdays\" ? WEEKDAY_KEYS : WEEKEND_KEYS;\r\n      const info = getGroupInfo(keys);\r\n      const base = info.baseEntry || { abre: \"10:00\", cierra: \"18:00\" };\r\n      const next = {\r\n        ...currentHorarios,\r\n        semanal: { ...currentHorarios.semanal },\r\n      };\r\n      keys.forEach((key) => {\r\n        next.semanal[key] = [\r\n          {\r\n            ...base,\r\n            [field]: value,\r\n          },\r\n        ];\r\n      });\r\n      updateHorarios(next);\r\n    },\r\n    [currentHorarios, getGroupInfo, updateHorarios]\r\n  );\r\n\r\n  const openGroupPicker = useCallback(\r\n    (groupKey, field, _currentLabel, showPersonalizado) => {\r\n      const keys = groupKey === \"weekdays\" ? WEEKDAY_KEYS : WEEKEND_KEYS;\r\n      const info = getGroupInfo(keys);\r\n      openModal(\"TimePicker\", {\r\n        title: \"Selecciona la hora\",\r\n        initialTime: info.baseEntry?.[field] || \"10:00\",\r\n        helperText: showPersonalizado\r\n          ? groupKey === \"weekdays\"\r\n            ? \"Modificaras el horario de todos los dias de Lunes a Viernes.\"\r\n            : \"Modificaras el horario de todos los dias de Fin de Semana.\"\r\n          : undefined,\r\n        onConfirm: (value) => updateGroupTime(groupKey, field, value),\r\n      });\r\n    },\r\n    [getGroupInfo, openModal, updateGroupTime]\r\n  );\r\n\r\n  const openTimePicker = useCallback(\r\n    (dayKey, field, currentValue) => {\r\n      openModal(\"TimePicker\", {\r\n        title: \"Selecciona la hora\",\r\n        initialTime: currentValue || \"10:00\",\r\n        onConfirm: (value) => updateDayTime(dayKey, field, value),\r\n      });\r\n    },\r\n    [openModal, updateDayTime]\r\n  );\r\n  const rawCiudad = String(direccionPayload?.ciudad || \"\");\r\n  const summaryCiudad = toTitleCaseEs(\r\n    (isBusiness\r\n      ? rawCiudad || payloadCanton || payloadParroquia\r\n      : rawCiudad || payloadParroquia || payloadCanton) || \"\"\r\n  );\r\n  const summaryCalle = direccionPayload?.calles\r\n    ? `${toTitleCaseEs(direccionPayload.calles)}${\r\n        direccionPayload?.house_number ? ` ${direccionPayload.house_number}` : \"\"\r\n      }`.trim()\r\n    : \"\";\r\n  const hasProvincia = Boolean(payloadProvincia);\r\n  const hasCiudad = Boolean(summaryCiudad);\r\n  const hasCalle = Boolean(summaryCalle);\r\n  const shouldShowCanton = isBusiness\r\n    ? !hasCiudad && payloadCanton\r\n    : (!hasProvincia || !hasCiudad) && payloadCanton;\r\n  const shouldShowSector = isBusiness\r\n    ? Boolean(direccionPayload?.sector)\r\n    : (!hasCalle || !hasCiudad) && direccionPayload?.sector;\r\n\r\n  const isManualFallback = mapStatus === \"error\";\r\n  const hasTerritorySelection = Boolean(\r\n    provinciaId && cantonId && parroquiaId\r\n  );\r\n  const shouldRenderMap = stage === \"map\" && isPrefillReady;\r\n  const canSelectCanton = Boolean(provinciaId);\r\n  const canSelectParroquia = Boolean(cantonId);\r\n  const canSearch =\r\n    searchValue.trim().length >= 4 &&\r\n    !isSearching &&\r\n    (!isManualFallback || hasTerritorySelection);\r\n  const shouldShowSearch = !isManualFallback || hasTerritorySelection;\r\n  const searchModeActive = isSearchModeOpen && shouldShowSearch;\r\n\r\n  const displayCoords =\r\n    coords ||\r\n    (direccionPayload?.lat != null && direccionPayload?.lng != null\r\n      ? { lat: Number(direccionPayload.lat), lng: Number(direccionPayload.lng) }\r\n      : null);\r\n  const mapCenter = displayCoords || DEFAULT_MAP_CENTER;\r\n  const isOffFallback = Boolean(\r\n    displayCoords &&\r\n      (Math.abs(displayCoords.lat - DEFAULT_MAP_CENTER.lat) > 0.0002 ||\r\n        Math.abs(displayCoords.lng - DEFAULT_MAP_CENTER.lng) > 0.0002)\r\n  );\r\n  const canConfirm = isOffFallback;\r\n\r\n\r\n\r\n  useEffect(() => {\r\n    if (!expandedGroup) return;\r\n    const handleOutside = (event) => {\r\n      const target = event.target;\r\n      const insideWeekdays = weekdaysRef.current?.contains(target);\r\n      const insideWeekend = weekendRef.current?.contains(target);\r\n      if (!insideWeekdays && !insideWeekend) {\r\n        setExpandedGroup(null);\r\n      }\r\n    };\r\n    document.addEventListener(\"mousedown\", handleOutside);\r\n    return () => document.removeEventListener(\"mousedown\", handleOutside);\r\n  }, [expandedGroup]);\r\n\r\n  const clearSearchState = () => {\r\n    setSearchValue(\"\");\r\n    setSearchResults([]);\r\n    setSearchError(\"\");\r\n    setHasSearched(false);\r\n    setAddressLabel(\"\");\r\n    setReverseError(\"\");\r\n    setSelectedSearchItem(null);\r\n    setCoords(null);\r\n    setCoordsSource(null);\r\n    setHasMapMoved(false);\r\n    setHasMapZoomed(false);\r\n    setIsSearchModeOpen(false);\r\n    programmaticZoomRef.current = true;\r\n    setMapZoom(FALLBACK_ZOOM);\r\n  };\r\n\r\n  const handleProvinciaChange = (value) => {\r\n    setProvinciaId(value);\r\n    setCantonId(\"\");\r\n    setParroquiaId(\"\");\r\n    clearSearchState();\r\n    resetDireccionPayload({ provincia_id: value, canton_id: \"\" });\r\n  };\r\n\r\n  const handleCantonChange = (value) => {\r\n    setCantonId(value);\r\n    setParroquiaId(\"\");\r\n    clearSearchState();\r\n    resetDireccionPayload({ provincia_id: provinciaId, canton_id: value });\r\n  };\r\n\r\n  const handleParroquiaChange = (value) => {\r\n    setParroquiaId(value);\r\n    clearSearchState();\r\n  };\r\n\r\n  const handleProvinciaClear = () => {\r\n    setProvinciaId(\"\");\r\n    setCantonId(\"\");\r\n    setParroquiaId(\"\");\r\n    clearSearchState();\r\n    resetDireccionPayload({ provincia_id: \"\", canton_id: \"\" });\r\n  };\r\n\r\n  const handleCantonClear = () => {\r\n    setCantonId(\"\");\r\n    setParroquiaId(\"\");\r\n    clearSearchState();\r\n    resetDireccionPayload({ provincia_id: provinciaId, canton_id: \"\" });\r\n  };\r\n\r\n  const handleParroquiaClear = () => {\r\n    setParroquiaId(\"\");\r\n    clearSearchState();\r\n  };\r\n\r\n  const handleSearch = async () => {\r\n    setLocalError(\"\");\r\n    const street = searchValue.trim();\r\n    if (isManualFallback) {\r\n      if (!provinciaId) {\r\n        setSearchError(\"Selecciona una provincia\");\r\n        return;\r\n      }\r\n      if (!cantonId) {\r\n        setSearchError(\"Selecciona un cantón\");\r\n        return;\r\n      }\r\n      if (!parroquiaId) {\r\n        setSearchError(\"Selecciona una ciudad/sector\");\r\n        return;\r\n      }\r\n    }\r\n    if (street.length < 4) {\r\n      setSearchError(\"Ingresa la calle\");\r\n      return;\r\n    }\r\n    const queryParts = [street];\r\n    if (isManualFallback) {\r\n      queryParts.push(parroquiaNombre, cantonNombre, provinciaNombre);\r\n    }\r\n    queryParts.push(\"Ecuador\");\r\n    const query = queryParts.filter(Boolean).join(\", \");\r\n\r\n    updateDireccionPayload({\r\n      place_id: \"\",\r\n      label: \"\",\r\n      display_label: \"\",\r\n      provider: \"\",\r\n      parroquia_id: \"\",\r\n      parroquia: \"\",\r\n      ciudad: \"\",\r\n      sector: \"\",\r\n      calles: \"\",\r\n      house_number: \"\",\r\n      postcode: \"\",\r\n      referencia: \"\",\r\n      provincia: \"\",\r\n      canton: \"\",\r\n      country: \"\",\r\n      provincia_id: provinciaId,\r\n      canton_id: cantonId,\r\n    });\r\n    setIsSearching(true);\r\n    setHasSearched(true);\r\n    setSearchError(\"\");\r\n    setSearchResults([]);\r\n    setReverseError(\"\");\r\n    setSelectedSearchItem(null);\r\n    setIsSearchModeOpen(true);\r\n\r\n    const result = await searchAddresses(query, {\r\n      limit: 6,\r\n      country: \"ec\",\r\n      language: \"es\",\r\n    });\r\n\r\n    if (!result.ok) {\r\n      setSearchError(\"No se pudo buscar direcciones\");\r\n      setSearchResults([]);\r\n    } else {\r\n      let results = Array.isArray(result.results) ? result.results : [];\r\n      if (coords?.lat != null && coords?.lng != null) {\r\n        results = sortByDistance(results, coords);\r\n      }\r\n      setSearchResults(results);\r\n    }\r\n\r\n    setIsSearching(false);\r\n  };\r\n\r\n  const handleConfirmSearch = () => {\r\n    if (!selectedSearchItem) return;\r\n    applySearchSelection(selectedSearchItem);\r\n    setSelectedSearchItem(null);\r\n  };\r\n\r\n  const searchInput = (\r\n    <div className=\"relative rounded-lg border border-gray-200 overflow-hidden focus-within:border-[#5E30A5] focus-within:ring-2 focus-within:ring-[#5E30A5]/30\">\r\n      <PinOutlineIcon className=\"absolute left-3 top-1/2 -translate-y-1/2 text-gray-300 h-4 w-4\" />\r\n      <input\r\n        className={`w-full pl-9 pr-12 py-2 text-sm border-0 focus:outline-none ${\r\n          searchValue.trim().length > 0 ? \"rounded-none\" : \"rounded-lg\"\r\n        }`}\r\n        placeholder=\"Busca la direccion si no la encuentras...\"\r\n        value={searchValue}\r\n        onFocus={() => setIsSearchModeOpen(true)}\r\n        onChange={(event) => {\r\n          const nextValue = event.target.value;\r\n          setSearchValue(nextValue);\r\n          setSearchResults([]);\r\n          setSearchError(\"\");\r\n          setHasSearched(false);\r\n          setSelectedSearchItem(null);\r\n          setIsSearchModeOpen(true);\r\n        }}\r\n      />\r\n      {searchValue.trim().length > 0 && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleSearch}\r\n          disabled={!canSearch}\r\n          className=\"absolute right-0 top-0 h-full px-3 flex items-center justify-center border-l border-gray-200 bg-[#5E30A5] text-white disabled:opacity-40 rounded-none\"\r\n          aria-label=\"Buscar direcci¢n\"\r\n        >\r\n          <SearchTiltIcon className=\"h-4 w-4 -rotate-12 text-white\" />\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n\r\n  const weekdayInfo = getGroupInfo(WEEKDAY_KEYS);\r\n  const weekendInfo = getGroupInfo(WEEKEND_KEYS);\r\n\r\n  const searchResultsList = (\r\n    <div className=\"-mx-3 flex-1 overflow-y-auto rounded-lg bg-white\">\r\n      {isSearching && (\r\n        <div className=\"px-3 py-2 text-xs text-gray-500\">Buscando...</div>\r\n      )}\r\n      {!isSearching && searchError && (\r\n        <div className=\"px-3 py-2 text-xs text-red-500\">{searchError}</div>\r\n      )}\r\n      {!isSearching &&\r\n        !searchError &&\r\n        hasSearched &&\r\n        searchResults.length === 0 && (\r\n          <div className=\"px-3 py-2 text-xs text-gray-500\">\r\n            Sin resultados\r\n          </div>\r\n        )}\r\n      {!isSearching &&\r\n        !searchError &&\r\n        searchResults.map((item) => (\r\n          <button\r\n            key={item.id || item.label}\r\n            type=\"button\"\r\n            onClick={() => handleSelectSuggestion(item)}\r\n            className={`w-full text-left px-3 py-3 text-sm transition border-b border-gray-200/60 last:border-b-0 ${\r\n              (selectedSearchItem?.id || selectedSearchItem?.label) ===\r\n              (item.id || item.label)\r\n                ? \"bg-[#F1ECFF] text-[#2F1A55]\"\r\n                : \"text-gray-700 hover:bg-gray-50\"\r\n            }`}\r\n          >\r\n            {formatDisplayParts(item)}\r\n          </button>\r\n        ))}\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <section\r\n      style={{ boxSizing: \"border-box\", position: \"relative\" }}\r\n      className=\"h-full\"\r\n    >\r\n      <div className=\"pb-4 flex h-full flex-col\" ref={innerRef}>\r\n        {!isPrefillReady || stage === \"pending\" ? (\r\n          <div className=\"flex-1 flex items-center justify-center text-sm text-gray-500\">\r\n            Cargando dirección...\r\n          </div>\r\n        ) : stage === \"map\" ? (\r\n          <AddressStepSearch\r\n            open={searchModeActive}\r\n            onBack={() => setIsSearchModeOpen(false)}\r\n            variant=\"inline\"\r\n            className=\"h-full\"\r\n            headerClassName=\"pt-3\"\r\n            contentClassName=\"flex flex-col gap-3 px-0\"\r\n            childrenClassName=\"flex h-full flex-col\"\r\n            searchBar={\r\n              <>\r\n                <p className=\"text-sm text-gray-600 text-center\">\r\n                  {subtitle ||\r\n                    \"Ayúdanos a conectar tu negocio con personas cerca de ti.\"}\r\n                </p>\r\n                <div className=\"mt-3 -mx-3\">{searchInput}</div>\r\n              </>\r\n            }\r\n            results={searchResultsList}\r\n            footer={\r\n              <div className=\"pb-4 space-y-2\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleConfirmSearch}\r\n                  disabled={!selectedSearchItem}\r\n                  className=\"w-full bg-[#5E30A5] text-white font-semibold py-2.5 rounded-lg shadow disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                >\r\n                  Confirmar\r\n                </button>\r\n                {onSkip && !isBusiness && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={onSkip}\r\n                    className=\"w-full text-sm font-semibold text-gray-500\"\r\n                  >\r\n                    Omitir por ahora\r\n                  </button>\r\n                )}\r\n              </div>\r\n            }\r\n          >\r\n            {!searchModeActive ? (\r\n              <>\r\n              <p className=\"text-sm text-gray-600 mt-3 mb-4 text-center\">\r\n                {subtitle ||\r\n                  \"Ayúdanos a conectar tu negocio con personas cerca de ti.\"}\r\n              </p>\r\n\r\n              {(localError || reverseError || error) && (\r\n                <ErrorBanner\r\n                  message={localError || reverseError || error}\r\n                  className=\"mb-3\"\r\n                />\r\n              )}\r\n\r\n              <div className=\"flex-1 flex flex-col gap-4\">\r\n                {shouldRenderMap ? (\r\n                  <div className=\"-mx-5 relative border-y border-gray-200 overflow-hidden\">\r\n                    {showZoomHint && (\r\n                      <div className=\"absolute left-0 right-0 top-1 z-[1001]\">\r\n                        <div className=\"rounded-2xl border border-emerald-200 bg-emerald-50 p-4 flex items-center gap-3 text-xs text-emerald-600 shadow-sm\">\r\n                          <PinOutlineIcon className=\"h-6 w-6 text-emerald-500\" />\r\n                          Asegúrate de señalar el punto correcto y pulsa confirmar.\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => setShowZoomHint(false)}\r\n                            className=\"ml-auto text-emerald-400 hover:text-emerald-600\"\r\n                            aria-label=\"Cerrar aviso\"\r\n                          >\r\n                            <XIcon className=\"h-4 w-4\" />\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n                    <LeafletMapPicker\r\n                      center={mapCenter}\r\n                      zoom={mapZoom}\r\n                      onReady={() => setMapStatus(\"ready\")}\r\n                      onError={() => setMapStatus(\"error\")}\r\n                      onCenterChange={(nextCenter) => {\r\n                        if (!initialMoveSkippedRef.current) {\r\n                          initialMoveSkippedRef.current = true;\r\n                          return;\r\n                        }\r\n                        if (programmaticMoveRef.current) {\r\n                          programmaticMoveRef.current = false;\r\n                          return;\r\n                        }\r\n                        setCoords(nextCenter);\r\n                        setCoordsSource(\"manual\");\r\n                        const movedEnough =\r\n                          Math.abs(nextCenter.lat - DEFAULT_MAP_CENTER.lat) >\r\n                            0.0002 ||\r\n                          Math.abs(nextCenter.lng - DEFAULT_MAP_CENTER.lng) >\r\n                            0.0002;\r\n                        if (movedEnough) {\r\n                          setHasMapMoved(true);\r\n                        }\r\n                        updateDireccionPayload({\r\n                          lat: nextCenter.lat,\r\n                          lng: nextCenter.lng,\r\n                        });\r\n                      }}\r\n                      onZoomChange={(nextZoom) => {\r\n                        if (!initialZoomSkippedRef.current) {\r\n                          initialZoomSkippedRef.current = true;\r\n                          return;\r\n                        }\r\n                        if (programmaticZoomRef.current) {\r\n                          programmaticZoomRef.current = false;\r\n                          setMapZoom(nextZoom);\r\n                          return;\r\n                        }\r\n                        setMapZoom(nextZoom);\r\n                        if (Math.abs(nextZoom - FALLBACK_ZOOM) >= 1) {\r\n                          setHasMapZoomed(true);\r\n                        }\r\n                      }}\r\n                      className=\"min-h-[320px] h-[320px] w-full\"\r\n                      animateZoom={animateZoom}\r\n                    />\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={requestLocation}\r\n                      className=\"absolute bottom-3 right-3 h-9 w-9 rounded-full bg-white/95 shadow-lg flex items-center justify-center text-gray-700 z-[1000]\"\r\n                      aria-label=\"Reintentar ubicación\"\r\n                    >\r\n                      <CompassIcon className=\"h-6 w-6\" />\r\n                    </button>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"-mx-5 min-h-[320px] h-[320px] w-full border-y border-gray-200 flex items-center justify-center text-xs text-gray-400\">\r\n                    Cargando mapa...\r\n                  </div>\r\n                )}\r\n                {isManualFallback && (\r\n                  <div className=\"space-y-3\">\r\n                    <SearchableSelect\r\n                      label=\"Provincia\"\r\n                      placeholder={\r\n                        isLoadingTerritory\r\n                          ? \"Cargando...\"\r\n                          : \"Selecciona provincia\"\r\n                      }\r\n                      value={provinciaId}\r\n                      options={provinciaOptions}\r\n                      disabled={isLoadingTerritory || Boolean(territoryError)}\r\n                      onChange={handleProvinciaChange}\r\n                      onClear={handleProvinciaClear}\r\n                    />\r\n\r\n                    <SearchableSelect\r\n                      label=\"Cantón\"\r\n                      placeholder=\"Selecciona Cantón\"\r\n                      value={cantonId}\r\n                      options={cantonOptions}\r\n                      disabled={!canSelectCanton}\r\n                      onChange={handleCantonChange}\r\n                      onClear={handleCantonClear}\r\n                    />\r\n\r\n                    <SearchableSelect\r\n                      label=\"Ciudad/sector\"\r\n                      placeholder=\"Selecciona ciudad/sector\"\r\n                      value={parroquiaId}\r\n                      options={parroquiaOptions}\r\n                      disabled={!canSelectParroquia}\r\n                      onChange={handleParroquiaChange}\r\n                      onClear={handleParroquiaClear}\r\n                    />\r\n\r\n                    {territoryError && (\r\n                      <div className=\"text-xs text-red-500 ml-1\">\r\n                        {territoryError}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                )}\r\n\r\n                {!searchModeActive && shouldShowSearch && (\r\n                  <div className=\"-mx-3\">{searchInput}</div>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"mt-auto pt-4\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleConfirm}\r\n                  disabled={!canConfirm || isReverseLoading}\r\n                  className=\"w-full bg-[#5E30A5] text-white font-semibold py-2.5 rounded-lg shadow disabled:opacity-60 disabled:cursor-not-allowed\"\r\n                >\r\n                  {isReverseLoading ? \"Confirmando...\" : \"Confirmar\"}\r\n                </button>\r\n                {onSkip && !isBusiness && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={onSkip}\r\n                    className=\"w-full text-sm font-semibold text-gray-500 mt-2\"\r\n                  >\r\n                    Omitir por ahora\r\n                  </button>\r\n                )}\r\n              </div>\r\n              </>\r\n            ) : null}\r\n          </AddressStepSearch>\r\n        ) : (\r\n          <>\r\n            {(localError || reverseError || error) && (\r\n              <ErrorBanner message={localError || reverseError || error} className=\"mb-3\" />\r\n            )}\r\n\r\n            <div className=\"flex-1 -mt-1\">\r\n              <div className=\"-mx-3 rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-4 text-sm text-gray-700 space-y-2 shadow-[inset_0_0_0_1px_rgba(74,222,128,0.08),0_0_0_1px_rgba(74,222,128,0.2),0_0_12px_rgba(74,222,128,0.25)]\">\r\n                {hasProvincia && (\r\n                  <div className=\"flex items-center gap-2 min-w-0\">\r\n                    <span className=\"text-gray-500 shrink-0\">Provincia:</span>\r\n                    <span className=\"truncate\">{payloadProvincia}</span>\r\n                  </div>\r\n                )}\r\n                {hasCiudad && (\r\n                  <div className=\"flex items-center gap-2 min-w-0\">\r\n                    <span className=\"text-gray-500 shrink-0\">Ciudad:</span>\r\n                    <span className=\"truncate\">{summaryCiudad}</span>\r\n                  </div>\r\n                )}\r\n                {shouldShowCanton && (\r\n                  <div className=\"flex items-center gap-2 min-w-0\">\r\n                    <span className=\"text-gray-500 shrink-0\">Canton:</span>\r\n                    <span className=\"truncate\">{payloadCanton}</span>\r\n                  </div>\r\n                )}\r\n                {isBusiness && payloadParroquia && (\r\n                  <div className=\"flex items-center gap-2 min-w-0\">\r\n                    <span className=\"text-gray-500 shrink-0\">Ciudad:</span>\r\n                    <span className=\"truncate\">{payloadParroquia}</span>\r\n                  </div>\r\n                )}\r\n                {shouldShowSector && (\r\n                  <div className=\"flex items-center gap-2 min-w-0\">\r\n                    <span className=\"text-gray-500 shrink-0\">Sector:</span>\r\n                    <span className=\"truncate\">{direccionPayload.sector}</span>\r\n                  </div>\r\n                )}\r\n                {summaryCalle && (\r\n                  <div className=\"flex items-center gap-2 min-w-0\">\r\n                    <span className=\"text-gray-500 shrink-0\">Calle:</span>\r\n                    <span className=\"truncate\">{summaryCalle}</span>\r\n                  </div>\r\n                )}\r\n                {direccionPayload?.postcode && (\r\n                  <div className=\"flex items-center gap-2 min-w-0\">\r\n                    <span className=\"text-gray-500 shrink-0\">Código postal:</span>\r\n                    <span className=\"truncate\">{direccionPayload.postcode}</span>\r\n                  </div>\r\n                )}\r\n                {isBusiness ? (\r\n                  <div className=\"space-y-1 pt-1\">\r\n                    <label className=\"block text-gray-500\">\r\n                      Referencia (opcional)\r\n                    </label>\r\n                    <input\r\n                      type=\"text\"\r\n                      maxLength={200}\r\n                      value={referenciaValue}\r\n                      onChange={(event) =>\r\n                        updateDireccionPayload({ referencia: event.target.value })\r\n                      }\r\n                      placeholder=\"Ej: Edificio azul, junto a la panadería\"\r\n                      className=\"w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:border-[#5E30A5] focus:ring-2 focus:ring-[#5E30A5]/30 focus:outline-none\"\r\n                    />\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"space-y-2 pt-1\">\r\n                    <label className=\"block text-gray-500\">\r\n                      Nombre de la dirección\r\n                    </label>\r\n                    <div className=\"flex flex-wrap gap-2\">\r\n                      {CLIENT_ADDRESS_TAGS.map((tag) => {\r\n                        const isSelected = activeTag === tag;\r\n                        return (\r\n                          <button\r\n                            key={tag}\r\n                            type=\"button\"\r\n                            onClick={() => handleSelectTag(tag)}\r\n                            className={`${badgeBase} ${\r\n                              isSelected\r\n                                ? \"border-[#5E30A5] text-[#5E30A5] bg-[#F5F0FF]\"\r\n                                : \"border-gray-300 text-gray-600\"\r\n                            }`}\r\n                          >\r\n                            {tag}\r\n                          </button>\r\n                        );\r\n                      })}\r\n                      <div className=\"basis-full flex\">\r\n                        {isCustomEditing ? (\r\n                          <div\r\n                            className={`${badgeBase} flex items-center gap-2 border-[#5E30A5] bg-[#F5F0FF] px-3 py-2 min-h-[38px] min-w-[180px]`}\r\n                          >\r\n                            <input\r\n                              ref={customInputRef}\r\n                              type=\"text\"\r\n                              value={customTagInput}\r\n                              onChange={handleCustomChange}\r\n                              placeholder=\"Otro\"\r\n                              className=\"bg-transparent text-[#5E30A5] placeholder:text-[#9C7BD5] text-xs focus:outline-none px-1\"\r\n                            />\r\n                            {customTagValid && (\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={handleCustomConfirm}\r\n                                className=\"text-[11px] font-semibold text-[#5E30A5]\"\r\n                              >\r\n                                OK\r\n                              </button>\r\n                            )}\r\n                          </div>\r\n                        ) : (\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={handleStartCustom}\r\n                            className={`${badgeBase} ${\r\n                              activeTag === CLIENT_ADDRESS_CUSTOM_KEY\r\n                                ? \"border-[#5E30A5] text-[#5E30A5] bg-[#F5F0FF]\"\r\n                                : \"border-gray-300 text-gray-600\"\r\n                            }`}\r\n                          >\r\n                            <span className=\"flex items-center gap-2\">\r\n                              {customBadgeLabel}\r\n                              <PencilIcon className=\"h-3 w-3\" />\r\n                            </span>\r\n                          </button>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n            {isBusiness && (\r\n              <div className=\"mt-1 space-y-2 h-[240px] flex flex-col\">\r\n                <div className=\"text-sm font-semibold text-gray-900\">Horario</div>\r\n                <div className=\"space-y-3 overflow-y-auto pr-1\">\r\n                <div ref={weekdaysRef} className=\"space-y-3\">\r\n                  <div className=\"flex items-center gap-3 text-sm text-gray-700\">\r\n                    {(() => {\r\n                      const isPrimaryActive =\r\n                        expandedGroup === \"weekdays\"\r\n                          ? Boolean(getEntry(WEEKDAY_KEYS[0]))\r\n                          : weekdayInfo.anySelected;\r\n                      return (\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() =>\r\n                            expandedGroup === \"weekdays\"\r\n                              ? handleToggleDay(WEEKDAY_KEYS[0])\r\n                              : toggleGroupSelection(\"weekdays\")\r\n                          }\r\n                          className={`h-5 w-5 rounded-full border flex items-center justify-center ${\r\n                            isPrimaryActive\r\n                              ? \"bg-[#4ADE80] border-[#4ADE80]\"\r\n                              : \"bg-gray-100 border-gray-200\"\r\n                          }`}\r\n                          aria-label=\"Activar Lunes a Viernes\"\r\n                        >\r\n                          {(expandedGroup === \"weekdays\" &&\r\n                            Boolean(getEntry(WEEKDAY_KEYS[0]))) ||\r\n                          (expandedGroup !== \"weekdays\" &&\r\n                            weekdayInfo.allSelected) ? (\r\n                            <CheckIcon className=\"h-3 w-3 text-white\" />\r\n                          ) : null}\r\n                          {expandedGroup !== \"weekdays\" &&\r\n                            weekdayInfo.partial && (\r\n                              <MinusIcon className=\"h-3 w-3 text-white\" />\r\n                            )}\r\n                        </button>\r\n                      );\r\n                    })()}\r\n                    <span className=\"font-medium\">\r\n                      {expandedGroup === \"weekdays\" ? \"Lunes\" : \"Lunes a Viernes\"}\r\n                    </span>\r\n                    <div className=\"ml-auto flex items-center gap-2\">\r\n                      {expandedGroup === \"weekdays\" ? (\r\n                        (() => {\r\n                          const entry = getEntry(WEEKDAY_KEYS[0]);\r\n                          const openTime = entry?.abre || \"--:--\";\r\n                          const closeTime = entry?.cierra || \"--:--\";\r\n                          return (\r\n                            <>\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() =>\r\n                                  openTimePicker(WEEKDAY_KEYS[0], \"abre\", openTime)\r\n                                }\r\n                                className=\"text-gray-700\"\r\n                              >\r\n                                {openTime}\r\n                              </button>\r\n                              <span className=\"text-gray-300\">-</span>\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() =>\r\n                                  openTimePicker(WEEKDAY_KEYS[0], \"cierra\", closeTime)\r\n                                }\r\n                                className=\"text-gray-700\"\r\n                              >\r\n                                {closeTime}\r\n                              </button>\r\n                            </>\r\n                          );\r\n                        })()\r\n                      ) : weekdayInfo.showPersonalizado ? (\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() =>\r\n                            openGroupPicker(\r\n                              \"weekdays\",\r\n                              \"abre\",\r\n                              weekdayInfo.timeLabel,\r\n                              true\r\n                            )\r\n                          }\r\n                          className=\"text-gray-700\"\r\n                        >\r\n                          Personalizado\r\n                        </button>\r\n                      ) : (\r\n                        <>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              openGroupPicker(\r\n                                \"weekdays\",\r\n                                \"abre\",\r\n                                weekdayInfo.timeLabel,\r\n                                false\r\n                              )\r\n                            }\r\n                            className=\"text-gray-700\"\r\n                          >\r\n                            {weekdayInfo.anySelected\r\n                              ? weekdayInfo.baseEntry?.abre || \"--:--\"\r\n                              : \"--:--\"}\r\n                          </button>\r\n                          <span className=\"text-gray-300\">-</span>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              openGroupPicker(\r\n                                \"weekdays\",\r\n                                \"cierra\",\r\n                                weekdayInfo.timeLabel,\r\n                                false\r\n                              )\r\n                            }\r\n                            className=\"text-gray-700\"\r\n                          >\r\n                            {weekdayInfo.anySelected\r\n                              ? weekdayInfo.baseEntry?.cierra || \"--:--\"\r\n                              : \"--:--\"}\r\n                          </button>\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() =>\r\n                        setExpandedGroup(\r\n                          expandedGroup === \"weekdays\" ? null : \"weekdays\"\r\n                        )\r\n                      }\r\n                      aria-label=\"Expandir Lunes a Viernes\"\r\n                    >\r\n                      <ChevronIcon\r\n                        className={`h-4 w-4 text-gray-400 transition ${\r\n                          expandedGroup === \"weekdays\" ? \"rotate-180\" : \"\"\r\n                        }`}\r\n                      />\r\n                    </button>\r\n                  </div>\r\n                  {expandedGroup === \"weekdays\" && (\r\n                    <div className=\"space-y-3\">\r\n                      {WEEKDAY_KEYS.slice(1).map((dayKey) => {\r\n                        const day = WEEK_DAYS.find((item) => item.key === dayKey);\r\n                        const entry = getEntry(dayKey);\r\n                        const isActive = Boolean(entry);\r\n                        const openTime = entry?.abre || \"--:--\";\r\n                        const closeTime = entry?.cierra || \"--:--\";\r\n                        return (\r\n                          <div\r\n                            key={dayKey}\r\n                            className=\"flex items-center gap-3 text-sm text-gray-700\"\r\n                          >\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleToggleDay(dayKey)}\r\n                              className={`h-5 w-5 rounded-full border flex items-center justify-center ${\r\n                                isActive\r\n                                  ? \"bg-[#4ADE80] border-[#4ADE80]\"\r\n                                  : \"bg-gray-100 border-gray-200\"\r\n                              }`}\r\n                              aria-label={`Activar ${day?.label || dayKey}`}\r\n                            >\r\n                              {isActive && (\r\n                                <CheckIcon className=\"h-3 w-3 text-white\" />\r\n                              )}\r\n                            </button>\r\n                            <span className=\"w-20\">{day?.label || dayKey}</span>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() =>\r\n                                openTimePicker(dayKey, \"abre\", openTime)\r\n                              }\r\n                              className=\"ml-auto text-gray-700\"\r\n                            >\r\n                              {openTime}\r\n                            </button>\r\n                            <span className=\"text-gray-300\">-</span>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() =>\r\n                                openTimePicker(dayKey, \"cierra\", closeTime)\r\n                              }\r\n                              className=\"text-gray-700\"\r\n                            >\r\n                              {closeTime}\r\n                            </button>\r\n                          </div>\r\n                        );\r\n                      })}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"h-px w-full bg-gradient-to-r from-transparent via-gray-200/80 to-transparent\" />\r\n\r\n                <div ref={weekendRef} className=\"space-y-3\">\r\n                  <div className=\"flex items-center gap-3 text-sm text-gray-700\">\r\n                    {(() => {\r\n                      const isPrimaryActive =\r\n                        expandedGroup === \"weekend\"\r\n                          ? Boolean(getEntry(WEEKEND_KEYS[0]))\r\n                          : weekendInfo.anySelected;\r\n                      return (\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() =>\r\n                            expandedGroup === \"weekend\"\r\n                              ? handleToggleDay(WEEKEND_KEYS[0])\r\n                              : toggleGroupSelection(\"weekend\")\r\n                          }\r\n                          className={`h-5 w-5 rounded-full border flex items-center justify-center ${\r\n                            isPrimaryActive\r\n                              ? \"bg-[#4ADE80] border-[#4ADE80]\"\r\n                              : \"bg-gray-100 border-gray-200\"\r\n                          }`}\r\n                          aria-label=\"Activar Fin de Semana\"\r\n                        >\r\n                          {(expandedGroup === \"weekend\" &&\r\n                            Boolean(getEntry(WEEKEND_KEYS[0]))) ||\r\n                          (expandedGroup !== \"weekend\" &&\r\n                            weekendInfo.allSelected) ? (\r\n                            <CheckIcon className=\"h-3 w-3 text-white\" />\r\n                          ) : null}\r\n                          {expandedGroup !== \"weekend\" &&\r\n                            weekendInfo.partial && (\r\n                              <MinusIcon className=\"h-3 w-3 text-white\" />\r\n                            )}\r\n                        </button>\r\n                      );\r\n                    })()}\r\n                    <span className=\"font-medium\">\r\n                      {expandedGroup === \"weekend\" ? \"Sabado\" : \"Fin de Semana\"}\r\n                    </span>\r\n                    <div className=\"ml-auto flex items-center gap-2\">\r\n                      {expandedGroup === \"weekend\" ? (\r\n                        (() => {\r\n                          const entry = getEntry(WEEKEND_KEYS[0]);\r\n                          const openTime = entry?.abre || \"--:--\";\r\n                          const closeTime = entry?.cierra || \"--:--\";\r\n                          return (\r\n                            <>\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() =>\r\n                                  openTimePicker(WEEKEND_KEYS[0], \"abre\", openTime)\r\n                                }\r\n                                className=\"text-gray-700\"\r\n                              >\r\n                                {openTime}\r\n                              </button>\r\n                              <span className=\"text-gray-300\">-</span>\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() =>\r\n                                  openTimePicker(WEEKEND_KEYS[0], \"cierra\", closeTime)\r\n                                }\r\n                                className=\"text-gray-700\"\r\n                              >\r\n                                {closeTime}\r\n                              </button>\r\n                            </>\r\n                          );\r\n                        })()\r\n                      ) : weekendInfo.showPersonalizado ? (\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() =>\r\n                            openGroupPicker(\r\n                              \"weekend\",\r\n                              \"abre\",\r\n                              weekendInfo.timeLabel,\r\n                              true\r\n                            )\r\n                          }\r\n                          className=\"text-gray-700\"\r\n                        >\r\n                          Personalizado\r\n                        </button>\r\n                      ) : (\r\n                        <>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              openGroupPicker(\r\n                                \"weekend\",\r\n                                \"abre\",\r\n                                weekendInfo.timeLabel,\r\n                                false\r\n                              )\r\n                            }\r\n                            className=\"text-gray-700\"\r\n                          >\r\n                            {weekendInfo.anySelected\r\n                              ? weekendInfo.baseEntry?.abre || \"--:--\"\r\n                              : \"--:--\"}\r\n                          </button>\r\n                          <span className=\"text-gray-300\">-</span>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() =>\r\n                              openGroupPicker(\r\n                                \"weekend\",\r\n                                \"cierra\",\r\n                                weekendInfo.timeLabel,\r\n                                false\r\n                              )\r\n                            }\r\n                            className=\"text-gray-700\"\r\n                          >\r\n                            {weekendInfo.anySelected\r\n                              ? weekendInfo.baseEntry?.cierra || \"--:--\"\r\n                              : \"--:--\"}\r\n                          </button>\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() =>\r\n                        setExpandedGroup(\r\n                          expandedGroup === \"weekend\" ? null : \"weekend\"\r\n                        )\r\n                      }\r\n                      aria-label=\"Expandir Fin de Semana\"\r\n                    >\r\n                      <ChevronIcon\r\n                        className={`h-4 w-4 text-gray-400 transition ${\r\n                          expandedGroup === \"weekend\" ? \"rotate-180\" : \"\"\r\n                        }`}\r\n                      />\r\n                    </button>\r\n                  </div>\r\n                  {expandedGroup === \"weekend\" && (\r\n                    <div className=\"space-y-3\">\r\n                      {WEEKEND_KEYS.slice(1).map((dayKey) => {\r\n                        const day = WEEK_DAYS.find((item) => item.key === dayKey);\r\n                        const entry = getEntry(dayKey);\r\n                        const isActive = Boolean(entry);\r\n                        const openTime = entry?.abre || \"--:--\";\r\n                        const closeTime = entry?.cierra || \"--:--\";\r\n                        return (\r\n                          <div\r\n                            key={dayKey}\r\n                            className=\"flex items-center gap-3 text-sm text-gray-700\"\r\n                          >\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleToggleDay(dayKey)}\r\n                              className={`h-5 w-5 rounded-full border flex items-center justify-center ${\r\n                                isActive\r\n                                  ? \"bg-[#4ADE80] border-[#4ADE80]\"\r\n                                  : \"bg-gray-100 border-gray-200\"\r\n                              }`}\r\n                              aria-label={`Activar ${day?.label || dayKey}`}\r\n                            >\r\n                              {isActive && (\r\n                                <CheckIcon className=\"h-3 w-3 text-white\" />\r\n                              )}\r\n                            </button>\r\n                            <span className=\"w-20\">{day?.label || dayKey}</span>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() =>\r\n                                openTimePicker(dayKey, \"abre\", openTime)\r\n                              }\r\n                              className=\"ml-auto text-gray-700\"\r\n                            >\r\n                              {openTime}\r\n                            </button>\r\n                            <span className=\"text-gray-300\">-</span>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() =>\r\n                                openTimePicker(dayKey, \"cierra\", closeTime)\r\n                              }\r\n                              className=\"text-gray-700\"\r\n                            >\r\n                              {closeTime}\r\n                            </button>\r\n                          </div>\r\n                        );\r\n                      })}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                <div className=\"h-px w-full bg-gradient-to-r from-transparent via-gray-200/80 to-transparent\" />\r\n              </div>\r\n            </div>\r\n            )}\r\n            {isBusiness && (\r\n              <label className=\"flex items-center gap-2 pt-2 pb-1 text-sm text-gray-700\">\r\n                <input\r\n                  type=\"checkbox\"\r\n                  checked={Boolean(isSucursalPrincipal)}\r\n                  onChange={(event) =>\r\n                    onChangeSucursalPrincipal?.(event.target.checked)\r\n                  }\r\n                  className=\"h-4 w-4 accent-[#5E30A5]\"\r\n                />\r\n                Este es mi sucursal principal\r\n              </label>\r\n            )}\r\n\r\n            <div className=\"mt-auto pt-4\">\r\n              <button\r\n                onClick={onSubmit}\r\n                disabled={!hasAnyHorario}\r\n                className=\"w-full bg-[#10B981] text-white font-semibold py-2.5 rounded-lg shadow disabled:opacity-60 disabled:cursor-not-allowed\"\r\n              >\r\n                {primaryLabel}\r\n              </button>\r\n              {onSkip && !isBusiness && (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={onSkip}\r\n                  className=\"w-full text-sm font-semibold text-gray-500 mt-2\"\r\n                >\r\n                  Omitir por ahora\r\n                </button>\r\n              )}\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n    </section>\r\n  );\r\n}\r\n\r\nfunction formatDisplayParts(item) {\r\n  const parts = Array.isArray(item?.display_parts) ? item.display_parts : [];\r\n  const filtered = parts.filter((value) => value);\r\n  if (filtered.length > 0) return filtered.join(\", \");\r\n  const fields = item?.display_fields || {};\r\n  const provincia = formatProvince(fields.provincia || item?.provincia || null);\r\n  const parroquiaOrCiudad =\r\n    fields.parroquia || fields.ciudad || item?.parroquia || item?.ciudad || null;\r\n  const sector = fields.sector || item?.sector || null;\r\n  const baseCalles = fields.calles || item?.calles || null;\r\n  const houseNumber = fields.house_number || item?.house_number || null;\r\n  const cantonFallback =\r\n    !parroquiaOrCiudad ? fields.canton || item?.canton || null : null;\r\n  let calles = fields.calles || null;\r\n  if (!calles && baseCalles) {\r\n    calles = baseCalles;\r\n  }\r\n  if (calles && houseNumber) {\r\n    calles = `${calles} ${houseNumber}`.trim();\r\n  }\r\n  const locality = parroquiaOrCiudad || cantonFallback;\r\n  const postcode = fields.postcode || item?.postcode || null;\r\n  const sectorWithPostcode = [postcode, sector].filter((value) => value).join(\" \").trim() || null;\r\n  const fallback = [\r\n    calles,\r\n    locality,\r\n    provincia,\r\n    sectorWithPostcode,\r\n  ].filter((value) => value);\r\n  if (fallback.length > 0) return fallback.join(\", \");\r\n  const rawLabel = String(item?.label || \"\").trim();\r\n  if (!rawLabel) return \"\";\r\n  const country =\r\n    String(fields.country || item?.country || \"\").trim() || \"Ecuador\";\r\n  const countryRe = new RegExp(`,\\\\s*${country}\\\\s*$`, \"i\");\r\n  return rawLabel.replace(countryRe, \"\").trim();\r\n}\r\n\r\nfunction formatProvince(value) {\r\n  const text = String(value || \"\").trim();\r\n  if (!text) return null;\r\n  return toTitleCaseEs(text);\r\n}\r\n\r\nfunction countDigits(value) {\r\n  const match = String(value || \"\").match(/\\d/g);\r\n  return match ? match.length : 0;\r\n}\r\n\r\n\r\nfunction haversineDistance(a, b) {\r\n  const toRad = (value) => (Number(value) * Math.PI) / 180;\r\n  const lat1 = toRad(a.lat);\r\n  const lat2 = toRad(b.lat);\r\n  const dLat = lat2 - lat1;\r\n  const dLng = toRad(b.lng) - toRad(a.lng);\r\n  const sinLat = Math.sin(dLat / 2);\r\n  const sinLng = Math.sin(dLng / 2);\r\n  const h = sinLat * sinLat +\r\n    Math.cos(lat1) * Math.cos(lat2) * sinLng * sinLng;\r\n  return 6371 * 2 * Math.asin(Math.min(1, Math.sqrt(h)));\r\n}\r\n\r\nfunction sortByDistance(results, origin) {\r\n  return [...results].sort((a, b) => {\r\n    const aValid = Number.isFinite(Number(a?.lat)) &&\r\n      Number.isFinite(Number(a?.lng));\r\n    const bValid = Number.isFinite(Number(b?.lat)) &&\r\n      Number.isFinite(Number(b?.lng));\r\n    if (!aValid && !bValid) return 0;\r\n    if (!aValid) return 1;\r\n    if (!bValid) return -1;\r\n    const distA = haversineDistance(origin, { lat: a.lat, lng: a.lng });\r\n    const distB = haversineDistance(origin, { lat: b.lat, lng: b.lng });\r\n    return distA - distB;\r\n  });\r\n}\r\n\r\nfunction SearchableSelect({\r\n  label,\r\n  placeholder,\r\n  value,\r\n  options,\r\n  onChange,\r\n  onClear,\r\n  disabled,\r\n}) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [inputValue, setInputValue] = useState(\"\");\r\n  const [isFocused, setIsFocused] = useState(false);\r\n  const inputRef = useRef(null);\r\n  const lastSelectedRef = useRef(null);\r\n\r\n  const selected = useMemo(\r\n    () => options.find((item) => item.id === value),\r\n    [options, value]\r\n  );\r\n\r\n  useEffect(() => {\r\n    setInputValue(selected?.nombre || \"\");\r\n    if (selected) {\r\n      lastSelectedRef.current = selected;\r\n    }\r\n  }, [selected?.nombre]);\r\n\r\n  const filtered = useMemo(() => {\r\n    const query = inputValue.trim().toLowerCase();\r\n    if (!query) return options;\r\n    return options.filter((item) =>\r\n      item.nombre.toLowerCase().includes(query)\r\n    );\r\n  }, [inputValue, options]);\r\n\r\n  const handleSelect = (item) => {\r\n    lastSelectedRef.current = item;\r\n    onChange?.(item.id);\r\n    setInputValue(item.nombre);\r\n    setIsOpen(false);\r\n    inputRef.current?.blur();\r\n  };\r\n\r\n  const handleClear = () => {\r\n    setInputValue(\"\");\r\n    setIsOpen(false);\r\n    lastSelectedRef.current = null;\r\n    onClear?.();\r\n    if (!isFocused) {\r\n      inputRef.current?.focus();\r\n    }\r\n  };\r\n\r\n  const handleBlur = () => {\r\n    setIsFocused(false);\r\n    setTimeout(() => {\r\n      setIsOpen(false);\r\n      const fallback = selected || lastSelectedRef.current;\r\n      if (!fallback) {\r\n        setInputValue(\"\");\r\n      } else {\r\n        setInputValue(fallback.nombre);\r\n      }\r\n    }, 120);\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-1\">\r\n      <label className=\"block text-xs text-gray-500 ml-1\">{label}</label>\r\n      <div className=\"relative\">\r\n        <input\r\n          ref={inputRef}\r\n          type=\"text\"\r\n          value={inputValue}\r\n          placeholder={placeholder}\r\n          onFocus={() => {\r\n            setIsFocused(true);\r\n            if (!disabled) setIsOpen(true);\r\n          }}\r\n          onClick={() => {\r\n            if (!disabled) setIsOpen(true);\r\n          }}\r\n          onChange={(event) => {\r\n            setInputValue(event.target.value);\r\n            if (!disabled) setIsOpen(true);\r\n          }}\r\n          onBlur={handleBlur}\r\n          disabled={disabled}\r\n          className=\"w-full border border-gray-200 rounded-lg px-3 py-2 pr-9 text-sm focus:border-[#5E30A5] focus:ring-2 focus:ring-[#5E30A5]/30 focus:outline-none disabled:bg-gray-50 disabled:text-gray-400\"\r\n        />\r\n        {inputValue && !disabled && (\r\n          <button\r\n            type=\"button\"\r\n            onMouseDown={(event) => event.preventDefault()}\r\n            onClick={handleClear}\r\n            className=\"absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600\"\r\n            aria-label={`Limpiar ${label}`}\r\n          >\r\n            <XIcon className=\"h-4 w-4\" />\r\n          </button>\r\n        )}\r\n        {isOpen && !disabled && (\r\n          <div className=\"absolute left-0 right-0 top-full mt-2 z-30 rounded-lg border border-gray-200 bg-white shadow-lg max-h-44 overflow-y-auto\">\r\n            {filtered.length === 0 ? (\r\n              <div className=\"px-3 py-2 text-xs text-gray-500\">\r\n                Sin resultados\r\n              </div>\r\n            ) : (\r\n              filtered.map((item) => (\r\n                <button\r\n                  key={item.id}\r\n                  type=\"button\"\r\n                  onMouseDown={(event) => {\r\n                    event.preventDefault();\r\n                    handleSelect(item);\r\n                  }}\r\n                  className=\"w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50\"\r\n                >\r\n                  {item.nombre}\r\n                </button>\r\n              ))\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction CheckIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"2\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M6 12l4 4 8-8\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction MinusIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"2\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M6 12h12\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction ChevronIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"2\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M6 9l6 6 6-6\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction XIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M6 6l12 12\" />\r\n      <path d=\"M18 6l-12 12\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction PencilIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M12 20h9\" />\r\n      <path d=\"M16.5 3.5a2.1 2.1 0 0 1 3 3L8 18l-4 1 1-4 11.5-11.5z\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction PinOutlineIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path d=\"M12 22s7-6.5 7-12a7 7 0 1 0-14 0c0 5.5 7 12 7 12z\" />\r\n      <circle cx=\"12\" cy=\"10\" r=\"3\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction SearchTiltIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <circle cx=\"11\" cy=\"11\" r=\"7\" />\r\n      <path d=\"M20 20l-3.5-3.5\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction CompassIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <circle cx=\"12\" cy=\"12\" r=\"8\" />\r\n      <path d=\"M12 3v4\" />\r\n      <path d=\"M12 17v4\" />\r\n      <path d=\"M3 12h4\" />\r\n      <path d=\"M17 12h4\" />\r\n      <circle cx=\"12\" cy=\"12\" r=\"2\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\UserProfileStep.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onGoWelcome' is defined but never used.","line":26,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":26,"endColumn":14,"suggestions":[{"messageId":"removeVar","data":{"varName":"onGoWelcome"},"fix":{"range":[510,526],"text":""},"desc":"Remove unused variable 'onGoWelcome'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"﻿import { useMemo } from \"react\";\r\nimport ErrorBanner from \"../blocks/ErrorBanner\";\r\nimport {\r\n  formatBirthdateInput,\r\n  getBirthdateStatus,\r\n  normalizeUserName,\r\n} from \"../utils/userProfileUtils\";\r\n\r\nexport default function UserProfileStep({\r\n  error,\r\n  inputClassName,\r\n  nombreDueno,\r\n  apellidoDueno,\r\n  genero,\r\n  fechaNacimiento,\r\n  subtitle,\r\n  underageMessage,\r\n  minAge = 18,\r\n  onChangeNombre,\r\n  onChangeApellido,\r\n  onChangeGenero,\r\n  onChangeFechaNacimiento,\r\n  onSubmit,\r\n  onSkip,\r\n  innerRef,\r\n  onGoWelcome,\r\n  primaryDisabled,\r\n}) {\r\n  const birthStatus = useMemo(\r\n    () => getBirthdateStatus(fechaNacimiento, minAge),\r\n    [fechaNacimiento, minAge]\r\n  );\r\n  const fieldClassName = `${inputClassName} !mt-0 !mb-0 !border-gray-200 focus:border-[#5E30A5] focus:ring-2 focus:ring-[#5E30A5]/30 focus:outline-none`;\r\n  const labelClassName = \"block text-xs text-gray-500 ml-1 mb-0\";\r\n  const genderOptions = [\r\n    { label: \"Femenino\", value: \"femenino\" },\r\n    { label: \"Masculino\", value: \"masculino\" },\r\n    { label: \"No-binario\", value: \"no_binario\" },\r\n    { label: \"Prefiero no especificar\", value: \"no_especificar\" },\r\n  ];\r\n  const selectedGenero = genero || \"no_especificar\";\r\n  const optionBase =\r\n    \"px-3 py-1.5 text-xs border rounded-full transition-colors\";\r\n\r\n  return (\r\n    <section\r\n      style={{ boxSizing: \"border-box\", position: \"relative\", zIndex: 1 }}\r\n      className=\"px-2 h-full\"\r\n    >\r\n      <div className=\"pb-4 flex h-full flex-col\" ref={innerRef}>\r\n        <p className=\"text-sm text-gray-600 mt-3 mb-6 text-center\">\r\n          {subtitle || \"Eres quien administrará el negocio en la app.\"}\r\n        </p>\r\n\r\n        {error && <ErrorBanner message={error} className=\"mb-2\" />}\r\n\r\n        <div className=\"space-y-6\">\r\n          <div className=\"space-y-1\">\r\n            <label className={labelClassName}>Nombre(s)</label>\r\n            <input\r\n              className={fieldClassName}\r\n              value={nombreDueno}\r\n              maxLength={26}\r\n              onChange={(event) =>\r\n                onChangeNombre(normalizeUserName(event.target.value))\r\n              }\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-1\">\r\n            <label className={labelClassName}>Apellido(s)</label>\r\n            <input\r\n              className={fieldClassName}\r\n              value={apellidoDueno}\r\n              maxLength={26}\r\n              onChange={(event) =>\r\n                onChangeApellido(normalizeUserName(event.target.value))\r\n              }\r\n            />\r\n          </div>\r\n\r\n          <div className=\"space-y-1\">\r\n            <label className={labelClassName}>¿Cuándo naciste?</label>\r\n            <input\r\n              className={fieldClassName}\r\n              value={fechaNacimiento}\r\n              maxLength={10}\r\n              inputMode=\"numeric\"\r\n              placeholder=\"DD/MM/AAAA\"\r\n              onChange={(event) =>\r\n                onChangeFechaNacimiento(formatBirthdateInput(event.target.value))\r\n              }\r\n            />\r\n\r\n            {birthStatus.isValid && birthStatus.isUnderage ? (\r\n              <div className=\"text-xs text-red-500\">\r\n                {underageMessage ||\r\n                  \"Tienes que ser mayor de edad para ser el administrador de un negocio.\"}\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <label className={labelClassName}>\r\n              ¿Con qué género te identificas?\r\n            </label>\r\n            <div className=\"flex flex-wrap gap-2\">\r\n              {genderOptions.map((option) => {\r\n                const isSelected = selectedGenero === option.value;\r\n                return (\r\n                  <button\r\n                    key={option.value}\r\n                    type=\"button\"\r\n                    onClick={() => onChangeGenero?.(option.value)}\r\n                    className={`${optionBase} ${\r\n                      isSelected\r\n                        ? \"border-[#5E30A5] text-[#5E30A5] bg-[#F5F0FF]\"\r\n                        : \"border-gray-300 text-gray-600\"\r\n                    }`}\r\n                  >\r\n                    {option.label}\r\n                  </button>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-auto\">\r\n          <div className=\"pt-10\">\r\n            <button\r\n              onClick={onSubmit}\r\n              disabled={primaryDisabled}\r\n              className=\"w-full bg-[#5E30A5] text-white font-semibold py-2.5 rounded-lg shadow disabled:opacity-60\"\r\n            >\r\n              Continuar\r\n            </button>\r\n            {onSkip && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={onSkip}\r\n                className=\"w-full text-sm font-semibold text-gray-500 mt-2\"\r\n              >\r\n                Omitir por ahora\r\n              </button>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </section>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\VerifyEmailStep.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\steps\\WelcomeStep.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onApple' is defined but never used.","line":16,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":10,"suggestions":[{"messageId":"removeVar","data":{"varName":"onApple"},"fix":{"range":[399,411],"text":""},"desc":"Remove unused variable 'onApple'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { Link } from \"react-router-dom\";\r\nimport AuthCard from \"../blocks/AuthCard\";\r\nimport AuthHeader from \"../blocks/AuthHeader\";\r\nimport ErrorBanner from \"../blocks/ErrorBanner\";\r\nimport OAuthButtons from \"../blocks/OAuthButtons\";\r\n\r\nexport default function WelcomeStep({\r\n  error,\r\n  loading,\r\n  oauthLoading,\r\n  oauthProvider,\r\n  onEmail,\r\n  onGoogle,\r\n  onFacebook,\r\n  onApple,\r\n  onTwitter,\r\n  onDiscord,\r\n}) {\r\n  return (\r\n    <div className=\"relative w-full max-w-sm\">\r\n      <AuthCard className=\"p-6\">\r\n        {error && <ErrorBanner message={error} className=\"mb-3 text-center\" />}\r\n\r\n        <div className=\"space-y-4\">\r\n          <AuthHeader\r\n            title=\"Elige como continuar...\"\r\n            subtitle=\"Si ya tienes cuenta, elige una opción y entrarás automaticamente.\"\r\n            titleClassName=\"text-center text-xl font-bold text-[#5E30A5] mb-1\"\r\n            subtitleClassName=\"text-center text-sm text-gray-500 mb-4\"\r\n          />\r\n\r\n          <Link\r\n            to=\"/auth\"\r\n            onClick={onEmail}\r\n            className=\"w-full block bg-[#FFC21C] text-white font-semibold py-3 rounded-lg shadow active:scale-[0.98]\"\r\n          >\r\n            <div className=\"flex items-center justify-center gap-2\">\r\n              <MailIcon />\r\n              <span>Continuar con correo</span>\r\n            </div>\r\n          </Link>\r\n\r\n          <div className=\"flex items-center gap-3 text-xs text-gray-400\">\r\n            <span\r\n              className=\"flex-1 h-px\"\r\n              style={{ background: \"linear-gradient(270deg, rgba(173, 173, 173, 0.9) 0%, rgba(209,213,219,0.75) 95%, rgba(194, 194, 194, 0.2) 100%)\" }}\r\n            />\r\n            <span className=\"font-semibold\">O</span>\r\n            <span\r\n              className=\"flex-1 h-px\"\r\n              style={{ background: \"linear-gradient(90deg, rgba(173, 173, 173, 0.9) 0%, rgba(209,213,219,0.75) 95%, rgba(194, 194, 194, 0.2) 100%)\" }}\r\n            />\r\n          </div>\r\n\r\n          <OAuthButtons\r\n            loading={loading}\r\n            oauthLoading={oauthLoading}\r\n            oauthProvider={oauthProvider}\r\n            onGoogle={onGoogle}\r\n            onFacebook={onFacebook}\r\n            // onApple={onApple}\r\n            onTwitter={onTwitter}\r\n            onDiscord={onDiscord}\r\n          />\r\n\r\n          <div className=\"text-center pt-2 text-sm text-gray-500\">\r\n            Si eres nuevo, te ayudaremos a{\" \"}\r\n            <Link to=\"/auth\" className=\"text-sm text-[#5E30A5] font-bold\">\r\n              crear tu cuenta.\r\n            </Link>\r\n          </div>\r\n        </div>\r\n      </AuthCard>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction MailIcon() {\r\n  return (\r\n    <svg\r\n      aria-hidden=\"true\"\r\n      focusable=\"false\"\r\n      height=\"24\"\r\n      width=\"24\"\r\n      viewBox=\"0 0 24 24\"\r\n      fill=\"none\"\r\n    >\r\n      <rect x=\"3\" y=\"5\" width=\"18\" height=\"14\" rx=\"2\" stroke=\"currentColor\" strokeWidth=\"1.6\" />\r\n      <path d=\"M4 7l7.82 6.165a2 2 0 002.36 0L22 7\" stroke=\"currentColor\" strokeWidth=\"1.6\" strokeLinecap=\"round\" />\r\n    </svg>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\utils\\authMappers.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\utils\\businessDataUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\auth\\utils\\userProfileUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cache\\CacheOutlet.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cache\\CacheView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cache\\cacheKeys.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cache\\cacheStore.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'removed' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":31,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"removed"},"fix":{"range":[767,782],"text":""},"desc":"Remove unused variable 'removed'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'removedScroll' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":36,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":35,"suggestions":[{"messageId":"removeVar","data":{"varName":"removedScroll"},"fix":{"range":[1000,1021],"text":""},"desc":"Remove unused variable 'removedScroll'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { create } from \"zustand\";\r\n\r\nconst initialState = {\r\n  views: {},\r\n  order: {},\r\n  activeKeys: {},\r\n  preloadedScopes: {},\r\n  scrollPositions: {},\r\n};\r\n\r\nexport const useCacheStore = create((set, get) => ({\r\n  ...initialState,\r\n  mount: (key, element, scope) =>\r\n    set((state) => {\r\n      if (state.views[key]) return state;\r\n      const nextOrder = { ...state.order };\r\n      const scoped = nextOrder[scope] ? [...nextOrder[scope]] : [];\r\n      scoped.push(key);\r\n      nextOrder[scope] = scoped;\r\n      return {\r\n        views: {\r\n          ...state.views,\r\n          [key]: { element, scope },\r\n        },\r\n        order: nextOrder,\r\n      };\r\n    }),\r\n  unmount: (key) =>\r\n    set((state) => {\r\n      if (!state.views[key]) return state;\r\n      const { [key]: removed, ...restViews } = state.views;\r\n      const nextOrder = {};\r\n      Object.keys(state.order).forEach((scope) => {\r\n        nextOrder[scope] = state.order[scope].filter((item) => item !== key);\r\n      });\r\n      const { [key]: removedScroll, ...restScroll } = state.scrollPositions;\r\n      return {\r\n        views: restViews,\r\n        order: nextOrder,\r\n        scrollPositions: restScroll,\r\n      };\r\n    }),\r\n  setActive: (scope, key) =>\r\n    set((state) => ({\r\n      activeKeys: {\r\n        ...state.activeKeys,\r\n        [scope]: key,\r\n      },\r\n    })),\r\n  preloadScope: (scope, entries) => {\r\n    if (get().preloadedScopes[scope]) return;\r\n    entries.forEach((entry) => {\r\n      get().mount(entry.key, entry.element, scope);\r\n    });\r\n    set((state) => ({\r\n      preloadedScopes: {\r\n        ...state.preloadedScopes,\r\n        [scope]: true,\r\n      },\r\n    }));\r\n  },\r\n  has: (key) => Boolean(get().views[key]),\r\n  isPreloaded: (scope) => Boolean(get().preloadedScopes[scope]),\r\n  setScrollPosition: (key, value) =>\r\n    set((state) => ({\r\n      scrollPositions: {\r\n        ...state.scrollPositions,\r\n        [key]: value,\r\n      },\r\n    })),\r\n  getScrollPosition: (key) => get().scrollPositions[key] ?? 0,\r\n  clearAll: () => set({ ...initialState }),\r\n}));\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\base\\ClienteEscanerBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\base\\ClienteHistorialBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\base\\ClienteInicioBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\base\\ClientePerfilBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\historial\\HistorialEmpty.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\historial\\HistorialItem.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\historial\\HistorialItemActivo.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'formatDateIsoToDdMmYyyy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"formatDateIsoToDdMmYyyy"},"fix":{"range":[204,268],"text":""},"desc":"Remove unused variable 'formatDateIsoToDdMmYyyy'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useRef, useState } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { MapPin } from \"lucide-react\";\r\nimport { sanitizeText } from \"../../utils/sanitize\";\r\nimport { formatDateIsoToDdMmYyyy } from \"../../utils/dateUtils\";\r\n\r\nconst VALID_WINDOW_MS = 5 * 60 * 1000;\r\n\r\nconst createSeededRng = (seed) => {\r\n  let t = seed >>> 0;\r\n  return () => {\r\n    t += 0x6d2b79f5;\r\n    let r = Math.imul(t ^ (t >>> 15), t | 1);\r\n    r ^= r + Math.imul(r ^ (r >>> 7), r | 61);\r\n    return ((r ^ (r >>> 14)) >>> 0) / 4294967296;\r\n  };\r\n};\r\n\r\nconst createQrModules = (seed = 9321) => {\r\n  const size = 25;\r\n  const modules = [];\r\n  const rng = createSeededRng(seed);\r\n  const isFinder = (x, y) =>\r\n    (x < 7 && y < 7) ||\r\n    (x >= size - 7 && y < 7) ||\r\n    (x < 7 && y >= size - 7);\r\n  const isTiming = (x, y) => x === 6 || y === 6;\r\n\r\n  for (let y = 0; y < size; y += 1) {\r\n    for (let x = 0; x < size; x += 1) {\r\n      if (x === 0 || y === 0 || x === size - 1 || y === size - 1) continue;\r\n      if (isFinder(x, y)) continue;\r\n      if (isTiming(x, y)) {\r\n        modules.push([x, y]);\r\n        continue;\r\n      }\r\n      if (rng() > 0.58) modules.push([x, y]);\r\n    }\r\n  }\r\n\r\n  return modules;\r\n};\r\n\r\nconst QR_MODULES = createQrModules();\r\n\r\nconst QrGlyph = ({ className, style, holeFill = \"white\" }) => (\r\n  <svg\r\n    viewBox=\"0 0 25 25\"\r\n    className={className}\r\n    style={style}\r\n    aria-hidden=\"true\"\r\n    focusable=\"false\"\r\n    shapeRendering=\"crispEdges\"\r\n  >\r\n    <rect width=\"25\" height=\"25\" fill=\"transparent\" />\r\n    <rect x=\"0\" y=\"0\" width=\"7\" height=\"7\" fill=\"currentColor\" />\r\n    <rect x=\"1\" y=\"1\" width=\"5\" height=\"5\" fill={holeFill} />\r\n    <rect x=\"2\" y=\"2\" width=\"3\" height=\"3\" fill=\"currentColor\" />\r\n    <rect x=\"18\" y=\"0\" width=\"7\" height=\"7\" fill=\"currentColor\" />\r\n    <rect x=\"19\" y=\"1\" width=\"5\" height=\"5\" fill={holeFill} />\r\n    <rect x=\"20\" y=\"2\" width=\"3\" height=\"3\" fill=\"currentColor\" />\r\n    <rect x=\"0\" y=\"18\" width=\"7\" height=\"7\" fill=\"currentColor\" />\r\n    <rect x=\"1\" y=\"19\" width=\"5\" height=\"5\" fill={holeFill} />\r\n    <rect x=\"2\" y=\"20\" width=\"3\" height=\"3\" fill=\"currentColor\" />\r\n    {QR_MODULES.map(([x, y]) => (\r\n      <rect\r\n        key={`${x}-${y}`}\r\n        x={x}\r\n        y={y}\r\n        width=\"1\"\r\n        height=\"1\"\r\n        fill=\"currentColor\"\r\n      />\r\n    ))}\r\n  </svg>\r\n);\r\n\r\nconst QrBadge = ({ progress, className }) => {\r\n  const clamped = Math.max(0, Math.min(1, progress));\r\n  const openingDeg = (1 - clamped) * 360;\r\n  const mask = `conic-gradient(transparent ${openingDeg}deg, #000 ${openingDeg}deg 360deg)`;\r\n  const maskOpening = `conic-gradient(#000 ${openingDeg}deg, transparent ${openingDeg}deg 360deg)`;\r\n  const tone =\r\n    clamped > 0.4\r\n      ? { base: \"#22C55E\", glow: \"#8fd300\", hole: \"#f3fae4\" }\r\n      : clamped > 0.15\r\n      ? { base: \"#F59E0B\", glow: \"#FFD166\", hole: \"#FFF4D6\" }\r\n      : { base: \"#EF4444\", glow: \"#FF8A8A\", hole: \"#FFE3E3\" };\r\n  const lineOpacity = clamped <= 0 ? 0 : 0.8;\r\n\r\n  return (\r\n    <div\r\n      className={`relative ${className || \"h-14 w-14\"} rounded-xl bg-white/80 flex items-center justify-center overflow-hidden`}\r\n    >\r\n      <QrGlyph className=\"absolute inset-2 h-[calc(100%-16px)] w-[calc(100%-16px)] text-slate-300\" />\r\n      <div\r\n        className=\"absolute -inset-1 rounded-2xl\"\r\n        style={{\r\n          WebkitMaskImage: mask,\r\n          maskImage: mask,\r\n          background: tone.glow,\r\n          opacity: 0.12,\r\n          filter: \"blur(10px)\",\r\n        }}\r\n      />\r\n      <div\r\n        className=\"absolute -inset-1 rounded-2xl\"\r\n        style={{\r\n          WebkitMaskImage: maskOpening,\r\n          maskImage: maskOpening,\r\n          background: \"#8A8F98\",\r\n          opacity: 0.1,\r\n          filter: \"blur(10px)\",\r\n        }}\r\n      />\r\n      <div\r\n        className=\"absolute inset-0 rounded-xl\"\r\n        style={{\r\n          WebkitMaskImage: mask,\r\n          maskImage: mask,\r\n          border: `1px solid ${tone.base}`,\r\n        }}\r\n      />\r\n      <div\r\n        className=\"absolute inset-0 rounded-xl\"\r\n        style={{\r\n          WebkitMaskImage: maskOpening,\r\n          maskImage: maskOpening,\r\n          border: \"1px solid #E6E9EF\",\r\n        }}\r\n      />\r\n      <div\r\n        className=\"absolute inset-2\"\r\n        style={{\r\n          WebkitMaskImage: mask,\r\n          maskImage: mask,\r\n        }}\r\n      >\r\n        <QrGlyph className=\"h-full w-full\" style={{ color: tone.base }} holeFill={tone.hole} />\r\n      </div>\r\n      <div className=\"pointer-events-none absolute inset-2 overflow-visible\">\r\n        <div\r\n          className=\"absolute left-1/2 top-1/2 h-[140%] w-px\"\r\n          style={{\r\n            background: tone.base,\r\n            opacity: lineOpacity,\r\n            transition: \"opacity 220ms ease\",\r\n            transform: \"translate(-50%, -100%) rotate(0deg)\",\r\n            transformOrigin: \"bottom center\",\r\n          }}\r\n        />\r\n        <div\r\n          className=\"absolute left-1/2 top-1/2 h-[140%] w-px\"\r\n          style={{\r\n            background: tone.base,\r\n            opacity: lineOpacity,\r\n            transition: \"opacity 220ms ease\",\r\n            transform: `translate(-50%, -100%) rotate(${openingDeg}deg)`,\r\n            transformOrigin: \"bottom center\",\r\n          }}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst PacmanTimer = ({ timeLeftMs }) => {\r\n  const progress = Math.max(0, Math.min(1, timeLeftMs / VALID_WINDOW_MS));\r\n  const mouthDeg = 50 * (1 - progress) + 10;\r\n  const color =\r\n    progress > 0.4 ? \"#10B981\" : progress > 0.15 ? \"#F59E0B\" : \"#EF4444\";\r\n\r\n  return (\r\n    <div\r\n      className=\"absolute top-5 left-5 w-6 h-6 rounded-full\"\r\n      style={{\r\n        background: `conic-gradient(transparent ${mouthDeg}deg, ${color} ${mouthDeg}deg 360deg)`,\r\n        border: `2px solid ${color}`,\r\n        opacity: 0.92,\r\n        boxShadow: `0 4px 10px ${color}33`,\r\n      }}\r\n    >\r\n      <div\r\n        className=\"w-2 h-2 rounded-full absolute\"\r\n        style={{\r\n          background: `${color}66`,\r\n          top: \"50%\",\r\n          left: \"50%\",\r\n          transform: \"translate(-50%, -50%)\",\r\n        }}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default function HistorialItemActivo({ item, now }) {\r\n  const navigate = useNavigate();\r\n  const promo = item?.promo || {};\r\n  const localNameRef = useRef(null);\r\n  const addressWrapperRef = useRef(null);\r\n  const addressMeasureRef = useRef(null);\r\n  const [isAddressMarquee, setIsAddressMarquee] = useState(false);\r\n  const [addressDistance, setAddressDistance] = useState(0);\r\n  const [addressDuration, setAddressDuration] = useState(\"8s\");\r\n  const [isLocalNameWrapped, setIsLocalNameWrapped] = useState(false);\r\n  const safePromo = {\r\n    ...promo,\r\n    titulo: sanitizeText(promo.titulo),\r\n    descripcion: sanitizeText(promo.descripcion),\r\n    descripcionExtra: sanitizeText(promo.descripcionExtra),\r\n    sector: sanitizeText(promo.sector),\r\n    ubicacion: sanitizeText(promo.ubicacion || promo.sector),\r\n    nombreLocal: sanitizeText(promo.nombreLocal),\r\n  };\r\n\r\n  const goDetalle = () => {\r\n    if (promo?.id) navigate(`/detalle/${promo.id}`);\r\n  };\r\n\r\n  const timeLeftMs = item?.expiresAt\r\n    ? new Date(item.expiresAt).getTime() - now\r\n    : item?.timeLeftMs ?? 0;\r\n  const qrProgress = Math.max(0, Math.min(1, timeLeftMs / VALID_WINDOW_MS));\r\n  const isClickable = timeLeftMs > 0;\r\n  const statusTone =\r\n    qrProgress > 0.4\r\n      ? \"#22C55E\"\r\n      : qrProgress > 0.15\r\n      ? \"#F59E0B\"\r\n      : \"#EF4444\";\r\n  const minutesLeft = Math.max(1, Math.ceil(timeLeftMs / 60000));\r\n  const tagText = qrProgress > 0.15 ? `${minutesLeft} minutos` : \"Expirará pronto.\";\r\n  const fullDescripcion = [safePromo.descripcion, safePromo.descripcionExtra]\r\n    .filter(Boolean)\r\n    .join(\" \");\r\n  const shadowGradient = isLocalNameWrapped\r\n    ? \"linear-gradient(174deg, rgba(0,0,0,0.86) 0%, rgba(0,0,0,0.20) 58%, rgba(0,0,0,0) 80%)\"\r\n    : \"linear-gradient(174deg, rgba(0,0,0,0.86) 0%, rgba(0,0,0,0.20) 28%, rgba(0,0,0,0) 62%)\";\r\n\r\n  useEffect(() => {\r\n    const el = localNameRef.current;\r\n    if (!el || typeof window === \"undefined\") return undefined;\r\n\r\n    const measure = () => {\r\n      const styles = window.getComputedStyle(el);\r\n      const fontSize = parseFloat(styles.fontSize || \"0\");\r\n      const lineHeightRaw = styles.lineHeight;\r\n      const lineHeight =\r\n        lineHeightRaw && lineHeightRaw !== \"normal\"\r\n          ? parseFloat(lineHeightRaw)\r\n          : fontSize * 1.2;\r\n      const lines = lineHeight ? Math.round(el.offsetHeight / lineHeight) : 1;\r\n      setIsLocalNameWrapped(lines > 1);\r\n    };\r\n\r\n    measure();\r\n    window.addEventListener(\"resize\", measure);\r\n    return () => window.removeEventListener(\"resize\", measure);\r\n  }, [safePromo.nombreLocal]);\r\n\r\n  useEffect(() => {\r\n    const wrapper = addressWrapperRef.current;\r\n    const measure = addressMeasureRef.current;\r\n    if (!wrapper || !measure) return undefined;\r\n\r\n    const update = () => {\r\n      const availableWidth = wrapper.clientWidth;\r\n      const textWidth = measure.scrollWidth;\r\n      const overflow = textWidth > availableWidth + 1;\r\n      setIsAddressMarquee(overflow);\r\n      if (!overflow) {\r\n        setAddressDistance(0);\r\n        setAddressDuration(\"0s\");\r\n        return;\r\n      }\r\n      const distance = Math.max(0, textWidth - availableWidth);\r\n      const duration = Math.min(12, Math.max(6, distance / 24));\r\n      setAddressDistance(distance);\r\n      setAddressDuration(`${duration}s`);\r\n    };\r\n\r\n    update();\r\n    window.addEventListener(\"resize\", update);\r\n    return () => window.removeEventListener(\"resize\", update);\r\n  }, [safePromo.sector, safePromo.ubicacion]);\r\n\r\n  return (\r\n    <article\r\n      className={`relative overflow-hidden bg-white ${\r\n        isClickable ? \"cursor-pointer\" : \"cursor-default\"\r\n      }`}\r\n      onClick={isClickable ? goDetalle : undefined}\r\n    >\r\n\r\n\r\n      <div className=\"flex flex-col gap-3 px-6 pt-9 pb-6\">\r\n        <div\r\n          className=\"relative w-full aspect-[2/1] rounded-t-xl bg-[#F8F5FF] bg-cover bg-center ring-1 ring-white/80 overflow-hidden\"\r\n          style={{\r\n            backgroundImage: promo.imagen ? `url(${promo.imagen})` : undefined,\r\n          }}\r\n        >\r\n          <div\r\n            className=\"absolute inset-0\"\r\n            style={{\r\n              background: shadowGradient,\r\n              filter: \"blur(6px)\",\r\n              transform: \"scaleY(1.08)\",\r\n            }}\r\n          />\r\n          <span\r\n            ref={localNameRef}\r\n            className=\"absolute left-3 top-2 max-w-[calc(100%-32px)] text-[20px] font-bold tracking-[0.2px] text-[#D4A21C] leading-tight\"\r\n          >\r\n            {safePromo.nombreLocal}\r\n          </span>\r\n          {timeLeftMs > 0 && (\r\n            <>\r\n              <div className=\"absolute right-3 top-1/2 -translate-y-1/2 h-[120px] w-[120px] rounded-xl bg-white/90\" />\r\n              <div className=\"absolute right-3 top-1/2 -translate-y-1/2 h-[120px] w-[120px] flex items-center justify-center\">\r\n                <QrBadge progress={qrProgress} className=\"h-full w-full\" />\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n        <div className=\"flex flex-col gap-1\">\r\n            <div className=\"flex items-center gap-2 pr-3 pl-2\">\r\n              <div className=\"flex-1 min-w-0\">\r\n                <span className=\"block text-[20px] font-semibold text-[#5E30A5] leading-snug truncate\">\r\n                  {safePromo.titulo}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          <p className=\"text-[17px] text-slate-500 line-clamp-3 pr-3 pl-2\">\r\n            {fullDescripcion}\r\n          </p>\r\n          <div className=\"mt-2 flex items-center gap-2 text-[16px] text-slate-400 pr-3 pl-2\">\r\n            <span className=\"inline-flex items-center gap-1 min-w-0 flex-1\">\r\n              <MapPin size={18} />\r\n              <span\r\n                ref={addressWrapperRef}\r\n                className=\"relative flex-1 min-w-0 overflow-hidden\"\r\n              >\r\n                <span\r\n                  className={`block truncate ${\r\n                    isAddressMarquee ? \"opacity-0\" : \"opacity-100\"\r\n                  }`}\r\n                >\r\n                  {safePromo.sector}\r\n                  {safePromo.ubicacion ? `, ${safePromo.ubicacion}` : \"\"}\r\n                </span>\r\n                <span\r\n                  ref={addressMeasureRef}\r\n                  className=\"absolute invisible whitespace-nowrap\"\r\n                >\r\n                  {safePromo.sector}\r\n                  {safePromo.ubicacion ? `, ${safePromo.ubicacion}` : \"\"}\r\n                </span>\r\n                {isAddressMarquee && (\r\n                  <span className=\"pointer-events-none absolute inset-0\">\r\n                    <span\r\n                      className=\"historial-title-track historial-title-track--animate\"\r\n                      style={{\r\n                        \"--historial-title-distance\": `${addressDistance}px`,\r\n                        \"--historial-title-duration\": addressDuration,\r\n                      }}\r\n                    >\r\n                      {safePromo.sector}\r\n                      {safePromo.ubicacion ? `, ${safePromo.ubicacion}` : \"\"}\r\n                    </span>\r\n                  </span>\r\n                )}\r\n              </span>\r\n            </span>\r\n            <span\r\n              className=\"shrink-0 inline-flex rounded-md px-2 py-1 text-[12px] font-semibold ml-auto\"\r\n              style={{\r\n                color: statusTone,\r\n                background:\r\n                  statusTone === \"#22C55E\"\r\n                    ? \"rgba(34,197,94,0.24)\"\r\n                    : statusTone === \"#F59E0B\"\r\n                    ? \"rgba(245,158,11,0.24)\"\r\n                    : \"rgba(239,68,68,0.24)\",\r\n                border:\r\n                  statusTone === \"#22C55E\"\r\n                    ? \"1px solid rgba(34,197,94,0.4)\"\r\n                    : statusTone === \"#F59E0B\"\r\n                    ? \"1px solid rgba(245,158,11,0.4)\"\r\n                    : \"1px solid rgba(239,68,68,0.4)\",\r\n                boxShadow:\r\n                  statusTone === \"#22C55E\"\r\n                    ? \"0 0 12px rgba(34,197,94,0.3)\"\r\n                    : statusTone === \"#F59E0B\"\r\n                    ? \"0 0 12px rgba(245,158,11,0.3)\"\r\n                    : \"0 0 12px rgba(239,68,68,0.3)\",\r\n              }}\r\n            >\r\n              {tagText}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </article>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\historial\\HistorialList.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[52,60],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport HistorialItem from \"./HistorialItem\";\r\nimport HistorialItemActivo from \"./HistorialItemActivo\";\r\n\r\nexport default function HistorialList({ items, variant, now }) {\r\n  return (\r\n    <motion.div\r\n      layout\r\n      initial={{ opacity: 0 }}\r\n      animate={{ opacity: 1 }}\r\n      transition={{ duration: 0.3 }}\r\n      className=\"w-full flex flex-col gap-0\"\r\n    >\r\n      {items.length > 0 && (\r\n        <div className=\"h-px w-full bg-gradient-to-r from-transparent via-[#5E30A5]/20 to-transparent\" />\r\n      )}\r\n      <AnimatePresence initial={false}>\r\n        {items.map((item, index) => (\r\n          <motion.div\r\n            key={item.id}\r\n            layout\r\n            initial={{ opacity: 0, y: 6 }}\r\n            animate={{ opacity: 1, y: 0 }}\r\n            exit={{ opacity: 0, y: -6 }}\r\n            transition={{ duration: 0.22 }}\r\n            className=\"w-full\"\r\n          >\r\n            {index > 0 && (\r\n              <div className=\"h-px w-full bg-gradient-to-r from-transparent via-[#5E30A5]/20 to-transparent\" />\r\n            )}\r\n            {variant === \"activos\" ? (\r\n              <HistorialItemActivo item={item} now={now} />\r\n            ) : (\r\n              <HistorialItem item={item} variant={variant} now={now} />\r\n            )}\r\n          </motion.div>\r\n        ))}\r\n      </AnimatePresence>\r\n      {items.length > 0 && (\r\n        <div className=\"h-px w-full bg-gradient-to-r from-transparent via-[#5E30A5]/20 to-transparent\" />\r\n      )}\r\n    </motion.div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\historial\\HistorialPromosPreview.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\historial\\HistorialSkeleton.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\historial\\HistorialView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\hooks\\useClienteUI.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\hooks\\useSearchDock.js","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'enabled' and 'rootSelector'. Either include them or remove the dependency array.","line":39,"column":6,"nodeType":"ArrayExpression","endLine":39,"endColumn":62,"suggestions":[{"desc":"Update the dependencies array to be: [dockOffset, enabled, headerId, heroSearchSelector, heroSelector, rootSelector]","fix":{"range":[1574,1630],"text":"[dockOffset, enabled, headerId, heroSearchSelector, heroSelector, rootSelector]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useCallback, useLayoutEffect, useState } from \"react\";\r\n\r\nexport function useSearchDock({\r\n  headerId = \"cliente-header\",\r\n  heroSelector = \"[data-hero-container]\",\r\n  heroSearchSelector = \"[data-hero-searchbar]\",\r\n  scrollContainerId = \"cliente-main-scroll\",\r\n  dockOffset = 24,\r\n  rootSelector = null,\r\n  enabled = true,\r\n} = {}) {\r\n  const [docked, setDocked] = useState(false);\r\n  const [heroVisible, setHeroVisible] = useState(true);\r\n\r\n  const update = useCallback(() => {\r\n    if (!enabled) {\r\n      setDocked((prev) => (prev ? false : prev));\r\n      setHeroVisible((prev) => (prev ? prev : true));\r\n      return;\r\n    }\r\n    const headerEl = document.getElementById(headerId);\r\n    const rootEl = rootSelector ? document.querySelector(rootSelector) : document;\r\n    const heroEl = rootEl?.querySelector?.(heroSelector);\r\n    const heroSearchEl = rootEl?.querySelector?.(heroSearchSelector);\r\n    if (!headerEl || !heroEl) {\r\n      setDocked((prev) => (prev ? false : prev));\r\n      setHeroVisible((prev) => (prev ? prev : true));\r\n      return;\r\n    }\r\n\r\n    const headerHeight = headerEl.offsetHeight || 0;\r\n    const rect = (heroSearchEl || heroEl).getBoundingClientRect();\r\n    const threshold = Math.max(0, headerHeight - dockOffset);\r\n    const nextDocked = Math.round(rect.bottom) <= threshold;\r\n    const nextHeroVisible =\r\n      rect.bottom > headerHeight && rect.top < window.innerHeight;\r\n    setDocked((prev) => (prev === nextDocked ? prev : nextDocked));\r\n    setHeroVisible((prev) => (prev === nextHeroVisible ? prev : nextHeroVisible));\r\n  }, [dockOffset, headerId, heroSearchSelector, heroSelector]);\r\n\r\n  useLayoutEffect(() => {\r\n    if (!enabled) {\r\n      return undefined;\r\n    }\r\n    update();\r\n    const scrollContainer = scrollContainerId\r\n      ? document.getElementById(scrollContainerId)\r\n      : null;\r\n    const options = { passive: true };\r\n    if (scrollContainer) {\r\n      scrollContainer.addEventListener(\"scroll\", update, options);\r\n    }\r\n    window.addEventListener(\"scroll\", update, options);\r\n    window.addEventListener(\"resize\", update);\r\n    return () => {\r\n      if (scrollContainer) {\r\n        scrollContainer.removeEventListener(\"scroll\", update);\r\n      }\r\n      window.removeEventListener(\"scroll\", update);\r\n      window.removeEventListener(\"resize\", update);\r\n    };\r\n  }, [enabled, scrollContainerId, update]);\r\n\r\n  return { docked, heroVisible };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\inicio\\ClienteInicio.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'isActive'. Either include it or remove the dependency array.","line":110,"column":6,"nodeType":"ArrayExpression","endLine":110,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [headerVisible, isActive]","fix":{"range":[4221,4236],"text":"[headerVisible, isActive]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useLayoutEffect, useMemo, useState } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport MenuFilters from \"../../components/menus/MenuFilters\";\r\nimport PromoCardCercanas from \"../../components/cards/PromoCardCercanas\";\r\nimport {\r\n  HeaderPanelContainer,\r\n  SearchbarPanel,\r\n} from \"../../components/header-panels\";\r\nimport ClienteInicioSearch from \"../../search/cliente/ClienteInicioSearch\";\r\nimport SearchResults from \"../../search/SearchResults\";\r\nimport { useSearchMode } from \"../../search/hooks/useSearchMode\";\r\nimport SearchIdle from \"../../search/SearchIdle\";\r\nimport { usePromoSearch } from \"../../hooks/usePromoSearch\";\r\nimport { sanitizeText } from \"../../utils/sanitize\";\r\nimport LoaderOverlay from \"../../components/ui/LoaderOverlay\";\r\nimport { useClienteHeader } from \"../layout/ClienteHeaderContext\";\r\nimport { useCacheStore } from \"../../cache/cacheStore\";\r\nimport { CACHE_KEYS } from \"../../cache/cacheKeys\";\r\nimport { useClienteUI } from \"../hooks/useClienteUI\";\r\nimport { useSearchDock } from \"../hooks/useSearchDock\";\r\nimport InicioHero from \"./InicioHero\";\r\nimport InicioBeneficios from \"./InicioBeneficios\";\r\nimport InicioEmptyState from \"./InicioEmptyState\";\r\nimport InicioPromosPreview from \"./InicioPromosPreview\";\r\nimport ClienteInicioSkeleton from \"./ClienteInicioSkeleton\";\r\n\r\nexport default function ClienteInicio() {\r\n  const { filtersOpen, setFiltersOpen } = useClienteUI();\r\n  const [dockTarget, setDockTarget] = useState(null);\r\n\r\n  const loadPromos = useAppStore((s) => s.loadPromos);\r\n  const startPromosAutoRefresh = useAppStore((s) => s.startPromosAutoRefresh);\r\n  const setPromosVisible = useAppStore((s) => s.setPromosVisible);\r\n  const promos = useAppStore((s) => s.promos);\r\n  const promosLoadedAt = useAppStore((s) => s.promosLoadedAt);\r\n  const promosRefreshing = useAppStore((s) => s.promosRefreshing);\r\n  const ratings = useAppStore((s) => s.ratings);\r\n  const initRatings = useAppStore((s) => s.initRatings);\r\n  const loading = useAppStore((s) => s.loading);\r\n  const usuario = useAppStore((s) => s.usuario);\r\n\r\n  useEffect(() => {\r\n    if (!promosLoadedAt && promos.length === 0) {\r\n      loadPromos({ force: true });\r\n    }\r\n  }, [loadPromos, promos.length, promosLoadedAt]);\r\n\r\n  useEffect(() => {\r\n    if (promos.length > 0) initRatings(promos);\r\n  }, [promos, initRatings]);\r\n\r\n  const { query, setQuery, isSearching, onFocus, onBack } = useSearchMode();\r\n  const { filterPromos } = usePromoSearch(query);\r\n  const searchResults = filterPromos(promos);\r\n  const hasQuery = query.trim().length > 0;\r\n  const isActive = useCacheStore(\r\n    (state) => state.activeKeys.cliente === CACHE_KEYS.CLIENTE_INICIO\r\n  );\r\n  const { docked: searchDocked, heroVisible } = useSearchDock({\r\n    enabled: isActive,\r\n    rootSelector: `[data-cache-key=\"${CACHE_KEYS.CLIENTE_INICIO}\"]`,\r\n  });\r\n  const { setHeaderOptions, headerEntering } = useClienteHeader();\r\n\r\n  const usePromosPreview = true;\r\n\r\n  const safeResults = useMemo(\r\n    () =>\r\n      searchResults.map((p) => ({\r\n        ...p,\r\n        titulo: sanitizeText(p.titulo),\r\n        descripcion: sanitizeText(p.descripcion),\r\n        sector: sanitizeText(p.sector),\r\n        nombreLocal: sanitizeText(p.nombreLocal),\r\n      })),\r\n    [searchResults]\r\n  );\r\n\r\n  const hotPromos = useMemo(() => promos.slice(0, 8), [promos]);\r\n\r\n  const mode = isSearching ? \"search\" : \"default\";\r\n  const showSearchDock = searchDocked || mode === \"search\";\r\n  const hideHeroSearch = showSearchDock && !heroVisible;\r\n\r\n  const headerVisible = !(loading && promos.length === 0);\r\n\r\n  useEffect(() => {\r\n    if (!headerVisible || !isActive) {\r\n      setDockTarget(null);\r\n      return undefined;\r\n    }\r\n    let frameId;\r\n    let tries = 0;\r\n    const resolveTarget = () => {\r\n      const target = document.getElementById(\"cliente-header-search-dock\");\r\n      if (target) {\r\n        setDockTarget(target);\r\n        return;\r\n      }\r\n      tries += 1;\r\n      if (tries < 20) {\r\n        frameId = requestAnimationFrame(resolveTarget);\r\n      }\r\n    };\r\n    resolveTarget();\r\n    return () => {\r\n      if (frameId) cancelAnimationFrame(frameId);\r\n    };\r\n  }, [headerVisible]);\r\n\r\n  useLayoutEffect(() => {\r\n    if (!isActive) return undefined;\r\n    setHeaderOptions({\r\n      mode,\r\n      onSearchBack: onBack,\r\n      headerVisible,\r\n    });\r\n    return () => {\r\n      setHeaderOptions({ mode: \"default\", onSearchBack: null, headerVisible: true });\r\n    };\r\n  }, [headerVisible, isActive, mode, onBack, setHeaderOptions]);\r\n\r\n  useEffect(() => {\r\n    startPromosAutoRefresh();\r\n    setPromosVisible(mode === \"default\");\r\n    return () => {\r\n      setPromosVisible(false);\r\n    };\r\n  }, [mode, setPromosVisible, startPromosAutoRefresh]);\r\n\r\n  if (loading && promos.length === 0) {\r\n    return (\r\n      <LoaderOverlay>\r\n        <ClienteInicioSkeleton />\r\n      </LoaderOverlay>\r\n    );\r\n  }\r\n\r\n  if (!isActive) {\r\n    return <div className=\"pb-16\" />;\r\n  }\r\n\r\n  return (\r\n    <div className=\"pb-16\">\r\n      <ClienteInicioSearch\r\n        open={isSearching}\r\n        onBack={onBack}\r\n        searchBar={\r\n          dockTarget\r\n            ? createPortal(\r\n                <HeaderPanelContainer\r\n                  open={showSearchDock}\r\n                  panelClassName=\"hero-search-dock\"\r\n                  panelProps={{ \"aria-hidden\": !showSearchDock }}\r\n                >\r\n                  <SearchbarPanel\r\n                    value={query}\r\n                    onChange={setQuery}\r\n                    onFocus={onFocus}\r\n                    onCancel={onBack}\r\n                    showBack={false}\r\n                    autoFocus={mode === \"search\"}\r\n                  />\r\n                </HeaderPanelContainer>,\r\n                dockTarget\r\n              )\r\n            : null\r\n        }\r\n        results={\r\n          hasQuery ? (\r\n            <SearchResults\r\n              title=\"Resultados\"\r\n              items={safeResults}\r\n              renderItem={(p) => (\r\n                <PromoCardCercanas\r\n                  key={p.id}\r\n                  promo={p}\r\n                  rating={ratings[p.id]}\r\n                  className=\"w-full\"\r\n                />\r\n              )}\r\n              emptyState={<InicioEmptyState variant=\"search\" onClear={onBack} />}\r\n              showEmpty\r\n              wrapperClassName=\"mt-6\"\r\n              listClassName=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\"\r\n              titleClassName=\"text-sm font-semibold text-[#2F1A55] mb-3\"\r\n            />\r\n          ) : null\r\n        }\r\n        suggestions={\r\n          !hasQuery ? (\r\n            <SearchIdle\r\n              hotPromos={hotPromos}\r\n              ratings={ratings}\r\n              onSelectSuggestion={(term) => setQuery(term)}\r\n            />\r\n          ) : null\r\n        }\r\n      >\r\n        <div className={headerEntering ? \"cliente-merge-enter\" : \"\"}>\r\n          <InicioHero\r\n            usuario={usuario}\r\n            searchValue={query}\r\n            onSearchChange={setQuery}\r\n            onSearchFocus={onFocus}\r\n            hideSearch={hideHeroSearch}\r\n          />\r\n        </div>\r\n        <div className=\"mt-4\">\r\n          {filtersOpen && (\r\n            <MenuFilters onClose={() => setFiltersOpen(false)} />\r\n          )}\r\n        </div>\r\n\r\n        {!usePromosPreview && promos.length === 0 ? (\r\n          <InicioEmptyState variant=\"promos\" />\r\n        ) : (\r\n          <>\r\n            <div\r\n              className={`transition-opacity duration-300 ${\r\n                promosRefreshing ? \"opacity-80\" : \"opacity-100\"\r\n              }`}\r\n            >\r\n              <InicioPromosPreview />\r\n            </div>\r\n            {/*\r\n            <InicioPromos sections={sections} ratings={ratings} />\r\n            */}\r\n            <InicioBeneficios usuario={usuario} />\r\n          </>\r\n        )}\r\n      </ClienteInicioSearch>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\inicio\\ClienteInicioSkeleton.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\inicio\\InicioBeneficios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\inicio\\InicioEmptyState.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\inicio\\InicioHero.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[28,67],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Compass, Link2, Rocket, Crown } from \"lucide-react\";\r\nimport {\r\n  formatCompactNumber,\r\n  getTierJourney,\r\n  getTierProgress,\r\n} from \"../services/clienteUI\";\r\nimport SearchBar from \"../../search/SearchBar\";\r\n\r\nexport default function InicioHero({\r\n  usuario,\r\n  searchValue,\r\n  onSearchChange,\r\n  onSearchFocus,\r\n  hideSearch = false,\r\n}) {\r\n  const { points, progress, nextGoal } = getTierProgress(usuario);\r\n  const { current, next, currentKey, nextKey } = getTierJourney(usuario);\r\n  const iconMap = {\r\n    explorador: Compass,\r\n    conector: Link2,\r\n    impulsor: Rocket,\r\n    embajador: Crown,\r\n  };\r\n  const CurrentIcon = iconMap[currentKey] || Compass;\r\n  const NextIcon = iconMap[nextKey] || Link2;\r\n  const referidos = Math.min(99, Number(usuario?.referidosCount || 0));\r\n\r\n  return (\r\n    <motion.section\r\n      initial={{ opacity: 0, y: 12 }}\r\n      animate={{ opacity: 1, y: 0 }}\r\n      transition={{ duration: 0.6 }}\r\n      className=\"pt-0\"\r\n      data-hero-container\r\n    >\r\n      <div className=\"hero-bleed text-white shadow-sm\">\r\n        <div className=\"relative z-10 max-w-6xl mx-auto px-4 pb-3\">\r\n          <div className=\"relative h-5 w-full rounded-full bg-white/15 overflow-hidden\">\r\n            <div className=\"absolute inset-0\">\r\n              <div\r\n                className=\"h-full rounded-full\"\r\n                style={{\r\n                  width: `${Math.round(progress * 100)}%`,\r\n                  background:\r\n                    \"linear-gradient(90deg, rgba(255,255,255,0.85), #FFFFFF)\",\r\n                }}\r\n              />\r\n            </div>\r\n            <div className=\"relative z-10 flex h-full items-center justify-end pr-3 text-[11px] font-medium text-white/85\">\r\n              {formatCompactNumber(points)} / {formatCompactNumber(nextGoal)}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-3 grid grid-cols-3 items-end gap-3\">\r\n            <div className=\"flex flex-col items-start gap-1\">\r\n              <div className=\"flex items-center gap-2 text-xs font-semibold text-white\">\r\n                <CurrentIcon size={14} />\r\n                {current.label}\r\n              </div>\r\n              <span className=\"text-[9px] uppercase tracking-[0.2em] text-white/60\">\r\n                Actual\r\n              </span>\r\n            </div>\r\n            <div className=\"relative flex justify-center -top-3\">\r\n              <div className=\"inline-flex items-center gap-2 rounded-full border border-white/25 bg-white/10 px-2.5 py-0.5 text-[11px] font-semibold text-[#E5D6FF] -mt-0.5\">\r\n                <span className=\"flex items-center gap-2 text-[11px] font-semibold text-[#E5D6FF]\">\r\n                  Referidos\r\n                </span>\r\n                <span className=\"text-[11px] font-semibold text-[#E5D6FF]\">\r\n                  {referidos}\r\n                </span>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex flex-col items-end gap-1\">\r\n              <div className=\"flex items-center gap-2 text-xs font-semibold text-white/70\">\r\n                <NextIcon size={14} />\r\n                {next.label}\r\n              </div>\r\n              <span className=\"text-[9px] uppercase tracking-[0.2em] text-white/60\">\r\n                Siguiente\r\n              </span>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-4 flex justify-center\">\r\n            <p className=\"max-w-[275px] text-center text-[18px] font-light leading-snug text-white\">\r\n              Encuentra promos y suma puntos sin complicarte.\r\n            </p>\r\n          </div>\r\n\r\n          <div\r\n            className=\"mt-5 hero-search-reveal\"\r\n            data-hero-searchbar\r\n            aria-hidden={hideSearch}\r\n            data-state={hideSearch ? \"hidden\" : \"visible\"}\r\n          >\r\n            <SearchBar\r\n              value={searchValue}\r\n              onChange={onSearchChange}\r\n              onFocus={onSearchFocus}\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </motion.section>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\inicio\\InicioPromos.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\inicio\\InicioPromosPreview.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":7,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":7,"endColumn":25},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":190,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":190,"endColumn":24}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport InicioPromos from \"./InicioPromos\";\r\nimport PromoCardCercanas from \"../../components/cards/PromoCardCercanas\";\r\nimport PromoCardHot from \"../../components/cards/PromoCardHot\";\r\nimport PromoCardNuevas from \"../../components/cards/PromoCardNuevas\";\r\n\r\nexport const MOCK_PROMOS = [\r\n  {\r\n    id: \"mock-1\",\r\n    titulo: \"2x1 en pizzas artesanales\",\r\n    descripcion: \"Lleva una pizza grande y la segunda va por la casa.\",\r\n    descripcionExtra: \"Reservas disponibles hasta las 18h.\",\r\n    nombreLocal: \"Don Giovanni\",\r\n    ubicacion: \"Calle A\",\r\n    sector: \"La Mariscal\",\r\n    fin: \"2025-12-30\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1542281286-9e0a16bb7366?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-2\",\r\n    titulo: \"Combo burger + bebida\",\r\n    descripcion: \"Menu completo con papas y bebida a precio especial.\",\r\n    descripcionExtra: \"Incluye una salsa especial de la casa.\",\r\n    nombreLocal: \"Urban Grill\",\r\n    ubicacion: \"Calle B\",\r\n    sector: \"La Carolina\",\r\n    fin: \"2025-11-18\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-3\",\r\n    titulo: \"Descuento en bowls saludables\",\r\n    descripcion: \"20% en bowls frescos de lunes a jueves.\",\r\n    descripcionExtra: \"Incluye topping extra sin costo.\",\r\n    nombreLocal: \"Green Spot\",\r\n    ubicacion: \"Calle C\",\r\n    sector: \"Cumbaya\",\r\n    fin: \"2025-10-02\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1512621776951-a57141f2eefd?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-4\",\r\n    titulo: \"Cafe + croissant\",\r\n    descripcion: \"Promo desayuno rapido para iniciar el dia.\",\r\n    descripcionExtra: \"Ideal para llevar, sin costo extra.\",\r\n    nombreLocal: \"Maison Cafe\",\r\n    ubicacion: \"Calle D\",\r\n    sector: \"La Carolina\",\r\n    fin: \"2025-09-14\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1459257868276-5e65389e2722?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-5\",\r\n    titulo: \"Entradas de cine 2x1\",\r\n    descripcion: \"Valido de lunes a miercoles en horarios seleccionados.\",\r\n    descripcionExtra: \"Incluye palomitas pequenas sin costo.\",\r\n    nombreLocal: \"Cine Plaza\",\r\n    ubicacion: \"Calle E\",\r\n    sector: \"Centro\",\r\n    fin: \"2025-08-25\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-6\",\r\n    titulo: \"Descuento en sneakers\",\r\n    descripcion: \"Hasta 30% en modelos seleccionados.\",\r\n    descripcionExtra: \"Aplica en colores seleccionados.\",\r\n    nombreLocal: \"Run Club\",\r\n    ubicacion: \"Calle F\",\r\n    sector: \"La Floresta\",\r\n    fin: \"2025-09-30\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-7\",\r\n    titulo: \"Promo sushi night\",\r\n    descripcion: \"Rolls mixtos con entrada incluida.\",\r\n    descripcionExtra: \"Incluye bebida fria de cortesia.\",\r\n    nombreLocal: \"Maki House\",\r\n    ubicacion: \"Calle G\",\r\n    sector: \"La Carolina\",\r\n    fin: \"2025-10-11\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1546069901-eacef0df6022?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-8\",\r\n    titulo: \"Spa express\",\r\n    descripcion: \"Masaje de 30 min con descuento especial.\",\r\n    descripcionExtra: \"Incluye aromaterapia sin costo.\",\r\n    nombreLocal: \"Zen Room\",\r\n    ubicacion: \"Calle H\",\r\n    sector: \"Norte\",\r\n    fin: \"2025-12-05\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1501004318641-b39e6451bec6?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-9\",\r\n    titulo: \"Clase de indoor cycling\",\r\n    descripcion: \"Primera clase gratis para nuevos usuarios.\",\r\n    descripcionExtra: \"Incluye toalla y bebida.\",\r\n    nombreLocal: \"Spin Lab\",\r\n    ubicacion: \"Calle I\",\r\n    sector: \"La Mariscal\",\r\n    fin: \"2025-11-02\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1546483875-ad9014c88eba?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-10\",\r\n    titulo: \"Tacos 3x2\",\r\n    descripcion: \"Sabores mixtos en tortillas artesanales.\",\r\n    descripcionExtra: \"Incluye topping extra de la casa.\",\r\n    nombreLocal: \"La Taqueria\",\r\n    ubicacion: \"Calle J\",\r\n    sector: \"Centro\",\r\n    fin: \"2025-07-20\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1550547660-4fd6f5d5f0e8?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-11\",\r\n    titulo: \"Helado doble\",\r\n    descripcion: \"Segundo scoop sin costo extra.\",\r\n    descripcionExtra: \"Incluye cono artesanal.\",\r\n    nombreLocal: \"Gelato Lab\",\r\n    ubicacion: \"Calle K\",\r\n    sector: \"Cumbaya\",\r\n    fin: \"2025-10-19\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1497034825429-c343d7c6a68f?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-12\",\r\n    titulo: \"Happy hour mocktails\",\r\n    descripcion: \"Dos bebidas por el precio de una.\",\r\n    descripcionExtra: \"Incluye snack ligero.\",\r\n    nombreLocal: \"Rooftop\",\r\n    ubicacion: \"Calle L\",\r\n    sector: \"La Carolina\",\r\n    fin: \"2025-09-09\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1486427944299-d1955d23e34d?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-13\",\r\n    titulo: \"Taller de ceramica\",\r\n    descripcion: \"Reserva tu cupo con 15% off.\",\r\n    descripcionExtra: \"Incluye pieza para horneado.\",\r\n    nombreLocal: \"Studio Clay\",\r\n    ubicacion: \"Calle M\",\r\n    sector: \"La Floresta\",\r\n    fin: \"2025-08-12\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1519710164239-da123dc03ef4?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-14\",\r\n    titulo: \"Box de brunch\",\r\n    descripcion: \"Entrega en 45 min con bebida incluida.\",\r\n    descripcionExtra: \"Incluye servilletas y cubiertos.\",\r\n    nombreLocal: \"Brunch & Co\",\r\n    ubicacion: \"Calle N\",\r\n    sector: \"Cumbaya\",\r\n    fin: \"2025-12-22\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1481931098730-318b6f776db0?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n  {\r\n    id: \"mock-15\",\r\n    titulo: \"Entrada + postre\",\r\n    descripcion: \"Combo especial para compartir.\",\r\n    descripcionExtra: \"Incluye bebida caliente o fria.\",\r\n    nombreLocal: \"Bistro 19\",\r\n    ubicacion: \"Calle O\",\r\n    sector: \"Centro\",\r\n    fin: \"2025-11-28\",\r\n    imagen:\r\n      \"https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=800&q=60\",\r\n  },\r\n];\r\n\r\nexport const HOT_PROMOS = MOCK_PROMOS.slice(10, 15);\r\n\r\nconst SECTIONS = [\r\n  {\r\n    id: \"nuevas\",\r\n    title: \"Nuevas\",\r\n    promos: MOCK_PROMOS.slice(0, 5),\r\n    CardComponent: PromoCardNuevas,\r\n    autoScroll: true,\r\n    autoScrollInterval: 5000,\r\n    loop: true,\r\n  },\r\n  {\r\n    id: \"cercanas\",\r\n    title: \"Cerca de ti\",\r\n    promos: MOCK_PROMOS.slice(5, 10),\r\n    CardComponent: PromoCardCercanas,\r\n    loop: true,\r\n  },\r\n  {\r\n    id: \"hot\",\r\n    title: \"Hot\",\r\n    promos: HOT_PROMOS,\r\n    CardComponent: PromoCardHot,\r\n    loop: true,\r\n  },\r\n];\r\n\r\nexport default function InicioPromosPreview() {\r\n  return <InicioPromos sections={SECTIONS} ratings={{}} />;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\layout\\ClienteFooter.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[140,179],"text":""},"desc":"Remove unused variable 'motion'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":39,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":40,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1507,1513],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { Link, useLocation } from \"react-router-dom\";\r\nimport { Home, QrCode, Tag, User } from \"lucide-react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\n\r\nexport default function ClienteFooter() {\r\n  const location = useLocation();\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (!usuario || !onboarding?.allowAccess) return null;\r\n  if (usuario?.role !== \"cliente\") return null;\r\n\r\n  const notiCount =\r\n    usuario?.notificaciones?.length ||\r\n    usuario?.notificacionesCount ||\r\n    0;\r\n\r\n  const links = [\r\n    { path: \"/cliente/inicio\", label: \"Inicio\", Icon: Home },\r\n    { path: \"/cliente/escanear\", label: \"Escanear\", Icon: QrCode },\r\n    { path: \"/cliente/historial\", label: \"Historial\", Icon: Tag, badge: notiCount },\r\n    { path: \"/cliente/perfil\", label: \"Perfil\", Icon: User },\r\n  ];\r\n\r\n  const isActive = (path) =>\r\n    location.pathname === path ||\r\n    (path === \"/cliente/inicio\" && location.pathname.startsWith(\"/cliente/inicio\"));\r\n\r\n  return (\r\n    <nav\r\n      className=\"md:hidden fixed bottom-0 left-0 right-0 z-50 border-t border-[#E9E2F7] bg-white\"\r\n      style={{ paddingBottom: \"env(safe-area-inset-bottom)\" }}\r\n    >\r\n      <div className=\"flex items-center justify-around py-2\">\r\n        {links.map(({ path, label, Icon, badge }) => {\r\n          const active = isActive(path);\r\n          return (\r\n            <Link\r\n              key={path}\r\n              to={path}\r\n              className=\"relative flex flex-col items-center text-[11px] font-medium\"\r\n            >\r\n              <motion.div\r\n                initial={false}\r\n                animate={{\r\n                  scale: active ? 1.15 : 1,\r\n                  color: active ? \"#5E30A5\" : \"#94A3B8\",\r\n                }}\r\n                transition={{ type: \"spring\", stiffness: 260, damping: 18 }}\r\n              >\r\n                <Icon size={20} />\r\n              </motion.div>\r\n              <motion.span\r\n                className=\"mt-1\"\r\n                animate={{\r\n                  opacity: active ? 1 : 0.7,\r\n                  color: active ? \"#5E30A5\" : \"#94A3B8\",\r\n                }}\r\n              >\r\n                {label}\r\n              </motion.span>\r\n              {active && (\r\n                <motion.div\r\n                  layoutId=\"clienteActiveIndicator\"\r\n                  className=\"absolute -bottom-1 h-1 w-8 rounded-full bg-[#5E30A5]\"\r\n                  transition={{ type: \"spring\", stiffness: 240, damping: 18 }}\r\n                />\r\n              )}\r\n              {badge > 0 && (\r\n                <span className=\"absolute -top-1 -right-1 inline-flex items-center justify-center px-1.5 py-0.5 text-[10px] font-semibold leading-none text-white bg-[#5E30A5] rounded-full shadow\">\r\n                  {badge > 99 ? \"99+\" : badge}\r\n                </span>\r\n              )}\r\n            </Link>\r\n          );\r\n        })}\r\n      </div>\r\n    </nav>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\layout\\ClienteHeader.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onOpenMenu' is defined but never used.","line":25,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"onOpenMenu"},"fix":{"range":[627,642],"text":""},"desc":"Remove unused variable 'onOpenMenu'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useRef, useState } from \"react\";\r\nimport {\r\n  HeaderPanelContainer,\r\n  LocationPanel,\r\n  NotificationsPanel,\r\n  QueuePanel,\r\n} from \"../../components/header-panels\";\r\nimport { ChevronLeft, LogOut } from \"lucide-react\";\r\nimport {\r\n  HeaderActions,\r\n  TabTitle,\r\n  UserIdentity,\r\n} from \"../../components/header-elements\";\r\nimport SearchHeader from \"../../search/SearchHeader\";\r\nimport { useClienteHeader } from \"./ClienteHeaderContext\";\r\nimport {\r\n  getAvatarSrc,\r\n  getTierMeta,\r\n  getUserShortName,\r\n} from \"../services/clienteUI\";\r\n\r\nexport default function ClienteHeader({\r\n  usuario,\r\n  avatarSrc,\r\n  onOpenMenu,\r\n  onOpenNotifications,\r\n  onLogout,\r\n  isElevated = false,\r\n}) {\r\n  const [locationOpen, setLocationOpen] = useState(false);\r\n  const [locationVisible, setLocationVisible] = useState(false);\r\n  const [notificationsOpen, setNotificationsOpen] = useState(false);\r\n  const [notificationsVisible, setNotificationsVisible] = useState(false);\r\n  const [queueOpen, setQueueOpen] = useState(false);\r\n  const [queueVisible, setQueueVisible] = useState(false);\r\n  const { mode, onSearchBack, profileDockOpen, profileTitle } =\r\n    useClienteHeader();\r\n  const scrollDistanceRef = useRef(0);\r\n  const lastScrollTopRef = useRef(0);\r\n  const tier = getTierMeta(usuario);\r\n  const displayName = getUserShortName(usuario);\r\n  const notiCount =\r\n    usuario?.notificaciones?.length || usuario?.notificacionesCount || 0;\r\n  const safeAvatar = getAvatarSrc(usuario, avatarSrc);\r\n  const scrollCloseThreshold = 38;\r\n\r\n  const getScrollTop = (target) => {\r\n    if (target && typeof target.scrollTop === \"number\") {\r\n      return target.scrollTop;\r\n    }\r\n    return document.scrollingElement?.scrollTop || window.scrollY || 0;\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (locationOpen) return;\r\n    if (!locationVisible) return;\r\n    const id = setTimeout(() => setLocationVisible(false), 240);\r\n    return () => clearTimeout(id);\r\n  }, [locationOpen, locationVisible]);\r\n\r\n  useEffect(() => {\r\n    if (notificationsOpen) return;\r\n    if (!notificationsVisible) return;\r\n    const id = setTimeout(() => setNotificationsVisible(false), 240);\r\n    return () => clearTimeout(id);\r\n  }, [notificationsOpen, notificationsVisible]);\r\n\r\n  useEffect(() => {\r\n    if (queueOpen) return;\r\n    if (!queueVisible) return;\r\n    const id = setTimeout(() => setQueueVisible(false), 240);\r\n    return () => clearTimeout(id);\r\n  }, [queueOpen, queueVisible]);\r\n\r\n  useEffect(() => {\r\n    if (!locationOpen && !notificationsOpen && !queueOpen) return undefined;\r\n    scrollDistanceRef.current = 0;\r\n    lastScrollTopRef.current = getScrollTop(document.scrollingElement);\r\n    const handleScroll = (event) => {\r\n      const current = getScrollTop(event.target);\r\n      const delta = current - lastScrollTopRef.current;\r\n      lastScrollTopRef.current = current;\r\n      if (!Number.isFinite(delta)) return;\r\n      scrollDistanceRef.current += Math.abs(delta);\r\n      if (scrollDistanceRef.current >= scrollCloseThreshold) {\r\n        setLocationOpen(false);\r\n        setNotificationsOpen(false);\r\n        setQueueOpen(false);\r\n      }\r\n    };\r\n    const captureOpts = { passive: true, capture: true };\r\n    document.addEventListener(\"scroll\", handleScroll, captureOpts);\r\n    return () => {\r\n      document.removeEventListener(\"scroll\", handleScroll, captureOpts);\r\n    };\r\n  }, [locationOpen, notificationsOpen, queueOpen]);\r\n\r\n  useEffect(() => {\r\n    if (mode !== \"search\") return;\r\n    setLocationOpen(false);\r\n    setLocationVisible(false);\r\n    setNotificationsOpen(false);\r\n    setNotificationsVisible(false);\r\n    setQueueOpen(false);\r\n    setQueueVisible(false);\r\n  }, [mode]);\r\n\r\n  const profileRounded = mode === \"profile\" && !profileDockOpen;\r\n  const headerClass = `${isElevated ? \"shadow-md\" : \"shadow-none\"} relative text-white${\r\n    profileRounded ? \" profile-header-rounded\" : \"\"\r\n  }`;\r\n  const headerSurfaceClass = `relative z-10 bg-[#5E30A5] transition-[border-radius] duration-250${\r\n    profileRounded ? \" rounded-b-lg\" : \"\"\r\n  }`;\r\n\r\n  return (\r\n    <div id=\"cliente-header\" className={headerClass}>\r\n      <div className={headerSurfaceClass}>\r\n        {mode === \"search\" ? (\r\n          <SearchHeader title=\"Qrew\" onBack={onSearchBack} />\r\n        ) : mode === \"profile\" ? (\r\n          <div className=\"max-w-6xl mx-auto px-4 pt-3 pb-2\">\r\n            <TabTitle\r\n              title={profileTitle || \"Configuracion\"}\r\n              action={\r\n                <button\r\n                  type=\"button\"\r\n                  aria-label=\"Cerrar sesion\"\r\n                  onClick={onLogout}\r\n                  className=\"h-10 w-10 inline-flex items-center justify-center rounded-full text-white/80 hover:text-white hover:bg-white/10 transition\"\r\n                >\r\n                  <LogOut size={18} />\r\n                </button>\r\n              }\r\n            />\r\n            {onSearchBack ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={onSearchBack}\r\n                aria-label=\"Volver\"\r\n                className=\"absolute left-4 top-3 h-10 w-10 inline-flex items-center justify-center rounded-full text-white/80 hover:text-white hover:bg-white/10 transition\"\r\n              >\r\n                <ChevronLeft size={20} />\r\n              </button>\r\n            ) : null}\r\n          </div>\r\n        ) : (\r\n          <div className=\"max-w-6xl mx-auto px-4 pt-3 pb-2\">\r\n            <div className=\"flex items-center justify-between gap-4\">\r\n              <UserIdentity\r\n                avatarSrc={safeAvatar}\r\n                tier={tier}\r\n                displayName={displayName}\r\n              />\r\n\r\n              <HeaderActions\r\n                onToggleLocation={() => {\r\n                  setNotificationsOpen(false);\r\n                  setQueueOpen(false);\r\n                  if (!locationOpen) {\r\n                    setLocationVisible(true);\r\n                    setLocationOpen(true);\r\n                  } else {\r\n                    setLocationOpen(false);\r\n                  }\r\n                }}\r\n                locationOpen={locationOpen}\r\n                locationPanel={\r\n                  locationVisible ? (\r\n                    <HeaderPanelContainer\r\n                      open={locationOpen}\r\n                      wrapperClassName=\"header-panel-anchor\"\r\n                      panelClassName=\"hero-search-dock\"\r\n                      panelProps={{ \"aria-hidden\": !locationOpen }}\r\n                    >\r\n                      <LocationPanel open={locationOpen} />\r\n                    </HeaderPanelContainer>\r\n                  ) : null\r\n                }\r\n                onToggleNotifications={() => {\r\n                  setLocationOpen(false);\r\n                  setQueueOpen(false);\r\n                  if (!notificationsOpen) {\r\n                    setNotificationsVisible(true);\r\n                    setNotificationsOpen(true);\r\n                  } else {\r\n                    setNotificationsOpen(false);\r\n                  }\r\n                  if (typeof onOpenNotifications === \"function\") {\r\n                    onOpenNotifications();\r\n                  }\r\n                }}\r\n                notificationsOpen={notificationsOpen}\r\n                notificationsPanel={\r\n                  notificationsVisible ? (\r\n                    <HeaderPanelContainer\r\n                      open={notificationsOpen}\r\n                      wrapperClassName=\"header-panel-anchor\"\r\n                      panelClassName=\"hero-search-dock\"\r\n                      panelProps={{ \"aria-hidden\": !notificationsOpen }}\r\n                    >\r\n                      <NotificationsPanel\r\n                        notifications={usuario?.notificaciones || []}\r\n                      />\r\n                    </HeaderPanelContainer>\r\n                  ) : null\r\n                }\r\n                onToggleQueue={() => {\r\n                  setLocationOpen(false);\r\n                  setNotificationsOpen(false);\r\n                  if (!queueOpen) {\r\n                    setQueueVisible(true);\r\n                    setQueueOpen(true);\r\n                  } else {\r\n                    setQueueOpen(false);\r\n                  }\r\n                }}\r\n                queueOpen={queueOpen}\r\n                queuePanel={\r\n                  queueVisible ? (\r\n                    <HeaderPanelContainer\r\n                      open={queueOpen}\r\n                      wrapperClassName=\"header-panel-anchor\"\r\n                      panelClassName=\"hero-search-dock\"\r\n                      panelProps={{ \"aria-hidden\": !queueOpen }}\r\n                    >\r\n                      <QueuePanel />\r\n                    </HeaderPanelContainer>\r\n                  ) : null\r\n                }\r\n                notiCount={notiCount}\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n      <div\r\n        id=\"cliente-header-search-dock\"\r\n        className={`absolute left-0 right-0 top-full z-40 ${\r\n          mode === \"profile\" ? \"profile-header-dock\" : \"\"\r\n        }`}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\layout\\ClienteHeaderContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":90,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":90,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, {\r\n  createContext,\r\n  useCallback,\r\n  useContext,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\n\r\nconst ClienteHeaderContext = createContext({\r\n  mode: \"default\",\r\n  onSearchBack: null,\r\n  headerVisible: true,\r\n  headerEntering: false,\r\n  profileDockOpen: true,\r\n  profileTitle: \"Configuracion\",\r\n  setHeaderOptions: () => {},\r\n});\r\n\r\nexport function ClienteHeaderProvider({ children }) {\r\n  const [mode, setMode] = useState(\"default\");\r\n  const [onSearchBack, setOnSearchBack] = useState(null);\r\n  const [headerVisible, setHeaderVisible] = useState(true);\r\n  const [headerEntering, setHeaderEntering] = useState(false);\r\n  const [profileDockOpen, setProfileDockOpen] = useState(true);\r\n  const [profileTitle, setProfileTitle] = useState(\"Configuracion\");\r\n  const prevHeaderVisible = useRef(headerVisible);\r\n\r\n  const setHeaderOptions = useCallback((options = {}) => {\r\n    const nextMode = options.mode || \"default\";\r\n    setMode(nextMode);\r\n    setOnSearchBack(() => options.onSearchBack || null);\r\n    const nextHeaderVisible =\r\n      typeof options.headerVisible === \"boolean\" ? options.headerVisible : true;\r\n    setHeaderVisible(nextHeaderVisible);\r\n    if (typeof options.profileDockOpen === \"boolean\") {\r\n      setProfileDockOpen(options.profileDockOpen);\r\n    }\r\n    if (typeof options.profileTitle === \"string\") {\r\n      setProfileTitle(options.profileTitle);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const wasVisible = prevHeaderVisible.current;\r\n    if (!wasVisible && headerVisible) {\r\n      setHeaderEntering(true);\r\n      const timer = setTimeout(() => {\r\n        setHeaderEntering(false);\r\n      }, 360);\r\n      prevHeaderVisible.current = headerVisible;\r\n      return () => clearTimeout(timer);\r\n    }\r\n    if (!headerVisible) {\r\n      setHeaderEntering(false);\r\n    }\r\n    prevHeaderVisible.current = headerVisible;\r\n    return undefined;\r\n  }, [headerVisible]);\r\n\r\n  const value = useMemo(\r\n    () => ({\r\n      mode,\r\n      onSearchBack,\r\n      headerVisible,\r\n      headerEntering,\r\n      profileDockOpen,\r\n      profileTitle,\r\n      setHeaderOptions,\r\n    }),\r\n    [\r\n      mode,\r\n      onSearchBack,\r\n      headerVisible,\r\n      headerEntering,\r\n      profileDockOpen,\r\n      profileTitle,\r\n      setHeaderOptions,\r\n    ]\r\n  );\r\n\r\n  return (\r\n    <ClienteHeaderContext.Provider value={value}>\r\n      {children}\r\n    </ClienteHeaderContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useClienteHeader() {\r\n  return useContext(ClienteHeaderContext);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\layout\\ClienteLayout.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'setAccessMethods' and 'setUser'. Either include them or remove the dependency array.","line":239,"column":6,"nodeType":"ArrayExpression","endLine":239,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [bootstrap, usuario, openModal, setAccessMethods, setUser]","fix":{"range":[9008,9039],"text":"[bootstrap, usuario, openModal, setAccessMethods, setUser]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from \"react\";\r\nimport { Outlet, useLocation } from \"react-router-dom\";\r\nimport ClienteHeader from \"./ClienteHeader\";\r\nimport ClienteFooter from \"./ClienteFooter\";\r\nimport MenuLateral from \"../../components/menus/MenuLateral\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport { getAvatarSrc } from \"../services/clienteUI\";\r\nimport { ClienteHeaderProvider, useClienteHeader } from \"./ClienteHeaderContext\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport {\r\n  getSecureStorageMode,\r\n  loadBiometricToken,\r\n  loadPinHash,\r\n} from \"../../services/secureStorageService\";\r\nimport CacheOutlet from \"../../cache/CacheOutlet\";\r\nimport { useCacheStore } from \"../../cache/cacheStore\";\r\nimport { CACHE_KEYS } from \"../../cache/cacheKeys\";\r\nimport ClienteInicioBase from \"../base/ClienteInicioBase\";\r\nimport ClienteEscanerBase from \"../base/ClienteEscanerBase\";\r\nimport ClienteHistorialBase from \"../base/ClienteHistorialBase\";\r\nimport ClientePerfilBase from \"../base/ClientePerfilBase\";\r\n\r\nconst FALLBACK_HEADER_HEIGHT = 76;\r\n\r\nfunction ClienteLayoutInner({ children }) {\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n  const logout = useAppStore((s) => s.logout);\r\n  const setAccessMethods = useAppStore((s) => s.setAccessMethods);\r\n  const setUser = useAppStore((s) => s.setUser);\r\n  const { openModal } = useModal();\r\n\r\n  const [menuOpen, setMenuOpen] = useState(false);\r\n  const [headerHeight, setHeaderHeight] = useState(FALLBACK_HEADER_HEIGHT);\r\n  const [headerElevated, setHeaderElevated] = useState(false);\r\n  const [viewportMetrics, setViewportMetrics] = useState({\r\n    height: 0,\r\n    offsetTop: 0,\r\n  });\r\n  const headerRef = useRef(null);\r\n  const mainRef = useRef(null);\r\n  const { mode, headerVisible, headerEntering } = useClienteHeader();\r\n  const location = useLocation();\r\n  const suspendViewportResize = useAppStore(\r\n    (state) => state.suspendViewportResize\r\n  );\r\n  const suspendViewportAfterNext = useAppStore(\r\n    (state) => state.suspendViewportAfterNext\r\n  );\r\n  const setSuspendViewportResize = useAppStore(\r\n    (state) => state.setSuspendViewportResize\r\n  );\r\n  const setSuspendViewportAfterNext = useAppStore(\r\n    (state) => state.setSuspendViewportAfterNext\r\n  );\r\n  const activeCacheKey = useCacheStore(\r\n    (state) => state.activeKeys.cliente || null\r\n  );\r\n  const preloadScope = useCacheStore((state) => state.preloadScope);\r\n  const isPreloaded = useCacheStore(\r\n    (state) => Boolean(state.preloadedScopes.cliente)\r\n  );\r\n  const setScrollPosition = useCacheStore((state) => state.setScrollPosition);\r\n  const getScrollPosition = useCacheStore((state) => state.getScrollPosition);\r\n\r\n  const cacheEntries = useMemo(\r\n    () => [\r\n      { key: CACHE_KEYS.CLIENTE_INICIO, element: <ClienteInicioBase /> },\r\n      { key: CACHE_KEYS.CLIENTE_ESCANEAR, element: <ClienteEscanerBase /> },\r\n      { key: CACHE_KEYS.CLIENTE_HISTORIAL, element: <ClienteHistorialBase /> },\r\n      { key: CACHE_KEYS.CLIENTE_PERFIL, element: <ClientePerfilBase /> },\r\n    ],\r\n    []\r\n  );\r\n  const useCache = children == null;\r\n  const fallbackPath = \"/cliente/inicio\";\r\n  const hideUntilPreloaded =\r\n    useCache && !isPreloaded && location.pathname !== fallbackPath;\r\n\r\n  useLayoutEffect(() => {\r\n    if (!useCache) return;\r\n    if (isPreloaded) return;\r\n    preloadScope(\"cliente\", cacheEntries);\r\n  }, [cacheEntries, isPreloaded, preloadScope, useCache]);\r\n\r\n  const updateHeaderHeight = useCallback(() => {\r\n    if (!headerVisible) {\r\n      setHeaderHeight(0);\r\n      return;\r\n    }\r\n    if (!headerRef.current) {\r\n      setHeaderHeight(FALLBACK_HEADER_HEIGHT);\r\n      return;\r\n    }\r\n    setHeaderHeight(headerRef.current.offsetHeight || FALLBACK_HEADER_HEIGHT);\r\n  }, [headerVisible]);\r\n\r\n  useLayoutEffect(() => {\r\n    updateHeaderHeight();\r\n    let observer;\r\n    if (\r\n      headerVisible &&\r\n      typeof ResizeObserver !== \"undefined\" &&\r\n      headerRef.current\r\n    ) {\r\n      observer = new ResizeObserver(() => updateHeaderHeight());\r\n      observer.observe(headerRef.current);\r\n    } else if (headerVisible) {\r\n      window.addEventListener(\"resize\", updateHeaderHeight);\r\n    }\r\n    return () => {\r\n      if (observer) {\r\n        observer.disconnect();\r\n      } else if (headerVisible) {\r\n        window.removeEventListener(\"resize\", updateHeaderHeight);\r\n      }\r\n    };\r\n  }, [headerVisible, updateHeaderHeight]);\r\n\r\n  useEffect(() => {\r\n    const updateViewport = () => {\r\n      if (suspendViewportResize) return;\r\n      const vv = window.visualViewport;\r\n      const height = vv?.height ?? window.innerHeight;\r\n      const offsetTop = vv?.offsetTop ?? 0;\r\n      setViewportMetrics((prev) =>\r\n        prev.height === height && prev.offsetTop === offsetTop\r\n          ? prev\r\n          : { height, offsetTop }\r\n      );\r\n      if (suspendViewportAfterNext) {\r\n        setSuspendViewportAfterNext(false);\r\n        setSuspendViewportResize(true);\r\n      }\r\n    };\r\n    updateViewport();\r\n    window.visualViewport?.addEventListener(\"resize\", updateViewport);\r\n    window.visualViewport?.addEventListener(\"scroll\", updateViewport);\r\n    window.addEventListener(\"resize\", updateViewport);\r\n    return () => {\r\n      window.visualViewport?.removeEventListener(\"resize\", updateViewport);\r\n      window.visualViewport?.removeEventListener(\"scroll\", updateViewport);\r\n      window.removeEventListener(\"resize\", updateViewport);\r\n    };\r\n  }, [\r\n    setSuspendViewportAfterNext,\r\n    setSuspendViewportResize,\r\n    suspendViewportAfterNext,\r\n    suspendViewportResize,\r\n  ]);\r\n\r\n  const updateHeaderElevation = useCallback(() => {\r\n    const mainTop = mainRef.current?.scrollTop || 0;\r\n    const docTop =\r\n      document.scrollingElement?.scrollTop || window.scrollY || 0;\r\n    const next = mainTop > 0 || docTop > 0;\r\n    setHeaderElevated((prev) => (prev === next ? prev : next));\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    updateHeaderElevation();\r\n    const current = mainRef.current;\r\n    if (current) {\r\n      current.addEventListener(\"scroll\", updateHeaderElevation, {\r\n        passive: true,\r\n      });\r\n    }\r\n    window.addEventListener(\"scroll\", updateHeaderElevation, {\r\n      passive: true,\r\n    });\r\n    return () => {\r\n      if (current) {\r\n        current.removeEventListener(\"scroll\", updateHeaderElevation);\r\n      }\r\n      window.removeEventListener(\"scroll\", updateHeaderElevation);\r\n    };\r\n  }, [updateHeaderElevation]);\r\n\r\n  useEffect(() => {\r\n    const current = mainRef.current;\r\n    if (!current || !activeCacheKey) return undefined;\r\n    const handleScroll = () => {\r\n      setScrollPosition(activeCacheKey, current.scrollTop);\r\n    };\r\n    current.addEventListener(\"scroll\", handleScroll, { passive: true });\r\n    return () => {\r\n      current.removeEventListener(\"scroll\", handleScroll);\r\n    };\r\n  }, [activeCacheKey, setScrollPosition]);\r\n\r\n  useEffect(() => {\r\n    const current = mainRef.current;\r\n    if (!current || !activeCacheKey) return;\r\n    const targetTop = getScrollPosition(activeCacheKey);\r\n    current.scrollTop = targetTop;\r\n    document.activeElement?.blur();\r\n  }, [activeCacheKey, getScrollPosition]);\r\n\r\n  useEffect(() => {\r\n    if (bootstrap || !usuario) return;\r\n    if (typeof window === \"undefined\") return;\r\n    let active = true;\r\n    (async () => {\r\n      const storageMode = await getSecureStorageMode();\r\n      if (!active || storageMode.mode === \"blocked\") return;\r\n      const { data } = await supabase.auth.getSession();\r\n      const token = data?.session?.access_token;\r\n      if (!active || !token) return;\r\n      const userId = data?.session?.user?.id ?? null;\r\n      if (!userId) return;\r\n      const skipKey = `access_methods_prompt_skip_${usuario.id || usuario.id_auth || \"user\"}`;\r\n      const localPin = await loadPinHash(userId);\r\n      const localBio = await loadBiometricToken(userId);\r\n      if (!active) return;\r\n      const nextPin = Boolean(localPin);\r\n      const nextBio = Boolean(localBio);\r\n      setAccessMethods({ pin: nextPin, fingerprint: nextBio });\r\n      const updates = {};\r\n      if (usuario.has_pin !== nextPin) updates.has_pin = nextPin;\r\n      if (usuario.has_biometrics !== nextBio) updates.has_biometrics = nextBio;\r\n      if (Object.keys(updates).length) {\r\n        await supabase.from(\"usuarios\").update(updates).eq(\"id_auth\", userId);\r\n        if (active) {\r\n          setUser({ ...usuario, ...updates });\r\n        }\r\n      }\r\n      if (window.localStorage.getItem(skipKey) === \"1\") return;\r\n      if (localPin || localBio) return;\r\n      const key = `access_methods_prompt_token_${usuario.id || usuario.id_auth || \"user\"}`;\r\n      const lastToken = window.sessionStorage.getItem(key);\r\n      if (lastToken === token) return;\r\n      window.sessionStorage.setItem(key, token);\r\n      openModal(\"AccessMethods\");\r\n    })();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, [bootstrap, usuario, openModal]);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (hideUntilPreloaded) return null;\r\n\r\n  const viewportHeight = viewportMetrics.height;\r\n\r\n  return (\r\n    <div\r\n      className=\"relative overflow-x-hidden\"\r\n      style={{\r\n        \"--cliente-bg\": \"#FAF8FF\",\r\n        \"--cliente-surface\": \"#FFFFFF\",\r\n        \"--cliente-ink\": \"#2F1A55\",\r\n        \"--cliente-accent\": \"#5E30A5\",\r\n        \"--cliente-accent-2\": \"#4B2488\",\r\n        \"--cliente-header-height\": `${headerHeight}px`,\r\n        \"--cliente-viewport-offset\": `${viewportMetrics.offsetTop}px`,\r\n        background: \"#FAF8FF\",\r\n        height: viewportHeight ? `${viewportHeight}px` : \"100dvh\",\r\n        minHeight: viewportHeight ? `${viewportHeight}px` : \"100vh\",\r\n        overflow: \"hidden\",\r\n      }}\r\n    >\r\n      <div className=\"relative flex h-full min-h-0 flex-col\">\r\n        {headerVisible ? (\r\n          <div\r\n            ref={headerRef}\r\n            className={`fixed left-0 right-0 z-40 ${\r\n              headerEntering ? \"cliente-merge-enter\" : \"\"\r\n            }`}\r\n            style={{ top: \"var(--cliente-viewport-offset, 0px)\" }}\r\n          >\r\n          <ClienteHeader\r\n            usuario={usuario}\r\n            avatarSrc={getAvatarSrc(usuario)}\r\n            onOpenMenu={() => setMenuOpen(true)}\r\n            isElevated={headerElevated}\r\n            onLogout={logout}\r\n          />\r\n          </div>\r\n        ) : null}\r\n\r\n        <main\r\n          ref={mainRef}\r\n          id=\"cliente-main-scroll\"\r\n          className={`hide-scrollbar transition-all duration-300 z-0 ${\r\n            menuOpen ? \"blur-sm\" : \"\"\r\n          }`}\r\n          style={{\r\n            position: \"fixed\",\r\n            top: \"var(--cliente-viewport-offset, 0px)\",\r\n            left: 0,\r\n            right: 0,\r\n            bottom: \"50px\",\r\n            paddingTop: headerHeight,\r\n            minHeight: 0,\r\n            overflowY: \"auto\",\r\n          }}\r\n        >\r\n          {useCache ? <CacheOutlet scope=\"cliente\" /> : children}\r\n          {useCache ? <Outlet /> : null}\r\n          <div\r\n            className=\"text-[10px] uppercase tracking-[0.3em] text-black/30\"\r\n            style={{ position: \"fixed\", bottom: 110, right: 16 }}\r\n          >\r\n            ALPHA v0.0.1\r\n          </div>\r\n        </main>\r\n\r\n        {mode !== \"search\" ? <ClienteFooter /> : null}\r\n\r\n        <MenuLateral\r\n          visible={menuOpen}\r\n          onClose={() => setMenuOpen(false)}\r\n          usuario={usuario}\r\n          logout={logout}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function ClienteLayout({ children }) {\r\n  return (\r\n    <ClienteHeaderProvider>\r\n      <ClienteLayoutInner>{children}</ClienteLayoutInner>\r\n    </ClienteHeaderProvider>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\services\\clienteUI.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\views\\ClienteEscanerView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\views\\ClienteHistorialView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\views\\ClienteInicioView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\cliente\\views\\ClientePerfilView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\cards\\HistorialItemCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\cards\\PromoCardCercanas.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\cards\\PromoCardHot.jsx","messages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useRef\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":16,"column":19,"nodeType":"Identifier","endLine":16,"endColumn":25},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useRef\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":17,"column":27,"nodeType":"Identifier","endLine":17,"endColumn":33},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useRef\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":18,"column":24,"nodeType":"Identifier","endLine":18,"endColumn":30},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":19,"column":37,"nodeType":"Identifier","endLine":19,"endColumn":45},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":20,"column":49,"nodeType":"Identifier","endLine":20,"endColumn":57},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":21,"column":49,"nodeType":"Identifier","endLine":21,"endColumn":57},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":22,"column":45,"nodeType":"Identifier","endLine":22,"endColumn":53},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":23,"column":45,"nodeType":"Identifier","endLine":23,"endColumn":53},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":24,"column":41,"nodeType":"Identifier","endLine":24,"endColumn":49},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useRef\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":25,"column":29,"nodeType":"Identifier","endLine":25,"endColumn":35},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useRef\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":26,"column":36,"nodeType":"Identifier","endLine":26,"endColumn":42},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useState\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":27,"column":55,"nodeType":"Identifier","endLine":27,"endColumn":63},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":40,"column":3,"nodeType":"Identifier","endLine":40,"endColumn":12},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":84,"column":3,"nodeType":"Identifier","endLine":84,"endColumn":12},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":102,"column":3,"nodeType":"Identifier","endLine":102,"endColumn":12},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":130,"column":3,"nodeType":"Identifier","endLine":130,"endColumn":12}],"suppressedMessages":[],"errorCount":16,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useRef, useState } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { sanitizeText } from \"../../utils/sanitize\";\r\nimport badgeHot from \"../../assets/badges/badge-promo-hot.png\";\r\nimport embersBg from \"../../assets/images/embers-bg.png\";\r\nimport sparklesOverlay from \"../../assets/overlays/hot-sparkles-overlay.png\";\r\n\r\nexport default function PromoCardHot({ promo, className, wrapperProps }) {\r\n  const navigate = useNavigate();\r\n  if (!promo) return null;\r\n\r\n  const goDetalle = () => navigate(`/detalle/${promo.id}`);\r\n  const titulo = sanitizeText(promo.titulo || \"Promo hot\");\r\n  const descripcion = sanitizeText(promo.descripcion || \"Sin descripcion\");\r\n  const nombreLocal = sanitizeText(promo.nombreLocal || \"Local\");\r\n  const cardRef = useRef(null);\r\n  const localWrapperRef = useRef(null);\r\n  const localTextRef = useRef(null);\r\n  const [isMarquee, setIsMarquee] = useState(false);\r\n  const [marqueeDistance, setMarqueeDistance] = useState(0);\r\n  const [marqueeDuration, setMarqueeDuration] = useState(\"6s\");\r\n  const [isCardVisible, setIsCardVisible] = useState(false);\r\n  const [isNameVisible, setIsNameVisible] = useState(false);\r\n  const [isAnimating, setIsAnimating] = useState(false);\r\n  const animationTimerRef = useRef(null);\r\n  const stableVisibilityTimerRef = useRef(null);\r\n  const [isVisibilityStable, setIsVisibilityStable] = useState(false);\r\n  const visibilityEligible = isMarquee && isCardVisible && isNameVisible;\r\n\r\n  const baseClass = className || \"flex-shrink-0 w-[310px] pr-0\";\r\n  const {\r\n    className: wrapperClassName,\r\n    style: wrapperStyle,\r\n    ...restWrapperProps\r\n  } = wrapperProps || {};\r\n  const mergedClassName = [baseClass, wrapperClassName]\r\n    .filter(Boolean)\r\n    .join(\" \");\r\n\r\n  useEffect(() => {\r\n    const wrapper = localWrapperRef.current;\r\n    const text = localTextRef.current;\r\n    if (!wrapper || !text) return undefined;\r\n\r\n    const update = () => {\r\n      const availableWidth = wrapper.clientWidth;\r\n      const textWidth = text.scrollWidth;\r\n      const overflow = textWidth > availableWidth + 1;\r\n      setIsMarquee(overflow);\r\n      if (!overflow) {\r\n        setMarqueeDistance(0);\r\n        setMarqueeDuration(\"0s\");\r\n        return;\r\n      }\r\n      const distance = Math.max(0, textWidth - availableWidth / 2);\r\n      const duration = Math.min(12, Math.max(6, distance / 24));\r\n      setMarqueeDistance(distance);\r\n      setMarqueeDuration(`${duration}s`);\r\n    };\r\n\r\n    update();\r\n\r\n    const resizeObserver =\r\n      typeof ResizeObserver !== \"undefined\"\r\n        ? new ResizeObserver(update)\r\n        : null;\r\n\r\n    if (resizeObserver) {\r\n      resizeObserver.observe(wrapper);\r\n      resizeObserver.observe(text);\r\n    } else {\r\n      window.addEventListener(\"resize\", update);\r\n    }\r\n\r\n    return () => {\r\n      if (resizeObserver) {\r\n        resizeObserver.disconnect();\r\n      } else {\r\n        window.removeEventListener(\"resize\", update);\r\n      }\r\n    };\r\n  }, [nombreLocal]);\r\n\r\n  useEffect(() => {\r\n    if (stableVisibilityTimerRef.current) {\r\n      clearTimeout(stableVisibilityTimerRef.current);\r\n      stableVisibilityTimerRef.current = null;\r\n    }\r\n\r\n    stableVisibilityTimerRef.current = setTimeout(() => {\r\n      setIsVisibilityStable(visibilityEligible);\r\n    }, 150);\r\n\r\n    return () => {\r\n      if (stableVisibilityTimerRef.current) {\r\n        clearTimeout(stableVisibilityTimerRef.current);\r\n        stableVisibilityTimerRef.current = null;\r\n      }\r\n    };\r\n  }, [visibilityEligible]);\r\n\r\n  useEffect(() => {\r\n    if (animationTimerRef.current) {\r\n      clearTimeout(animationTimerRef.current);\r\n      animationTimerRef.current = null;\r\n    }\r\n\r\n    if (!isVisibilityStable || isAnimating) return undefined;\r\n\r\n    if (\r\n      typeof window !== \"undefined\" &&\r\n      window.matchMedia &&\r\n      window.matchMedia(\"(prefers-reduced-motion: reduce)\").matches\r\n    ) {\r\n      return undefined;\r\n    }\r\n\r\n    animationTimerRef.current = setTimeout(() => {\r\n      setIsAnimating(true);\r\n    }, 2000);\r\n\r\n    return () => {\r\n      if (animationTimerRef.current) {\r\n        clearTimeout(animationTimerRef.current);\r\n        animationTimerRef.current = null;\r\n      }\r\n    };\r\n  }, [isVisibilityStable, isAnimating]);\r\n\r\n  useEffect(() => {\r\n    if (typeof IntersectionObserver === \"undefined\") {\r\n      setIsCardVisible(true);\r\n      setIsNameVisible(true);\r\n      return undefined;\r\n    }\r\n\r\n    const card = cardRef.current;\r\n    const name = localWrapperRef.current;\r\n\r\n    if (!card || !name) return undefined;\r\n\r\n    const cardObserver = new IntersectionObserver(\r\n      (entries) => {\r\n        const entry = entries[0];\r\n        setIsCardVisible(entry.intersectionRatio >= 0.6);\r\n      },\r\n      { threshold: [0, 0.6, 1] }\r\n    );\r\n\r\n    const nameObserver = new IntersectionObserver(\r\n      (entries) => {\r\n        const entry = entries[0];\r\n        setIsNameVisible(entry.intersectionRatio >= 0.98);\r\n      },\r\n      { threshold: [0, 0.5, 0.98, 1] }\r\n    );\r\n\r\n    cardObserver.observe(card);\r\n    nameObserver.observe(name);\r\n\r\n    return () => {\r\n      cardObserver.disconnect();\r\n      nameObserver.disconnect();\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div\r\n      className={mergedClassName}\r\n      style={wrapperStyle}\r\n      {...restWrapperProps}\r\n    >\r\n      <article\r\n        ref={cardRef}\r\n        onClick={goDetalle}\r\n        className=\"cursor-pointer rounded-[20px] shadow-lg overflow-hidden relative text-white aspect-[2/1] min-h-[150px]\"\r\n      >\r\n        <div className=\"absolute inset-0\">\r\n          <div className=\"absolute inset-y-0 left-0 w-[65%]\">\r\n            {promo.imagen ? (\r\n              <img\r\n                src={promo.imagen}\r\n                alt={titulo}\r\n                className=\"h-full w-full object-cover\"\r\n              />\r\n            ) : (\r\n              <div className=\"h-full w-full bg-[#2B0B0B]\" />\r\n            )}\r\n          </div>\r\n\r\n          <img\r\n            src={sparklesOverlay}\r\n            alt=\"\"\r\n            className=\"absolute inset-y-0 left-0 h-full w-full object-cover object-left\"\r\n            aria-hidden=\"true\"\r\n          />\r\n\r\n          <div\r\n            className=\"absolute inset-y-0 left-[35%] w-[65%]\"\r\n            style={{\r\n              WebkitMaskImage:\r\n                \"linear-gradient(270deg, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 78%, rgba(0,0,0,0.7) 84%, rgba(0,0,0,0.1) 92%, rgba(0,0,0,0) 100%)\",\r\n              maskImage:\r\n                \"linear-gradient(270deg, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 78%, rgba(0,0,0,0.7) 84%, rgba(0,0,0,0.1) 92%, rgba(0,0,0,0) 100%)\",\r\n              WebkitMaskSize: \"100% 100%\",\r\n              maskSize: \"100% 100%\",\r\n              WebkitMaskRepeat: \"no-repeat\",\r\n              maskRepeat: \"no-repeat\",\r\n            }}\r\n          >\r\n            <img\r\n              src={embersBg}\r\n              alt=\"\"\r\n              className=\"h-full w-full object-cover mix-blend-screen\"\r\n              aria-hidden=\"true\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"relative z-10 h-full flex flex-col px-0 pt-2 pb-3\">\r\n          <div\r\n            className=\"relative inline-flex w-fit ml-[41%] items-center gap-0.5\"\r\n            style={{ opacity: 0.85, mixBlendMode: \"screen\" }}\r\n          >\r\n            <img src={badgeHot} alt=\"Hot\" className=\"h-8 w-auto\" />\r\n            <span\r\n              ref={localWrapperRef}\r\n              className={`hot-local-marquee -ml-1 text-[12px] font-semibold tracking-[0.10em] text-white/985 uppercase ${\r\n                isAnimating ? \"hot-local-marquee--animate\" : \"\"\r\n              }`}\r\n              style={{\r\n                \"--hot-marquee-distance\": `${marqueeDistance}px`,\r\n                \"--hot-marquee-duration\": marqueeDuration,\r\n              }}\r\n            >\r\n              <span\r\n                className={`hot-local-marquee-track ${\r\n                  isAnimating ? \"hot-local-marquee-track--animate\" : \"\"\r\n                }`}\r\n                onAnimationEnd={() => setIsAnimating(false)}\r\n              >\r\n                <span ref={localTextRef} className=\"hot-local-marquee-text\">\r\n                  {nombreLocal}\r\n                </span>\r\n              </span>\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"-mt-1 ml-[41%] px-3\">\r\n            <h3 className=\"text-[15px] font-bold leading-snug text-white line-clamp-2 min-h-[2.1em]\">\r\n              {titulo}\r\n            </h3>\r\n            <p className=\"text-[12px] text-white/85 line-clamp-3 min-h-[3.3em]\">\r\n              {descripcion}\r\n            </p>\r\n\r\n            <div className=\"mt-2 h-px w-full bg-[#FFFFFF]/45\" />\r\n\r\n            <div className=\"mt-2 space-y-1 text-[12px] text-white/90\">\r\n              <div className=\"flex items-center gap-2\">\r\n              <svg\r\n                width=\"12\"\r\n                height=\"12\"\r\n                viewBox=\"0 0 24 24\"\r\n                className=\"text-[#F6C35B]\"\r\n                aria-hidden=\"true\"\r\n              >\r\n                <path\r\n                  fill=\"currentColor\"\r\n                  fillRule=\"evenodd\"\r\n                  clipRule=\"evenodd\"\r\n                  d=\"M12 22s8-6.2 8-12a8 8 0 1 0-16 0c0 5.8 8 12 8 12Zm0-9a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z\"\r\n                />\r\n              </svg>\r\n                <span className=\"font-semibold\">{nombreLocal}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </article>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\cards\\PromoCardNuevas.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'formatDateIsoToDdMmYyyy' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"formatDateIsoToDdMmYyyy"},"fix":{"range":[127,191],"text":""},"desc":"Remove unused variable 'formatDateIsoToDdMmYyyy'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { Calendar, MapPin } from \"lucide-react\";\r\nimport { formatDateIsoToDdMmYyyy } from \"../../utils/dateUtils\";\r\nimport { sanitizeText } from \"../../utils/sanitize\";\r\n\r\nexport default function PromoCardNuevas({ promo, className, wrapperProps }) {\r\n  const navigate = useNavigate();\r\n  if (!promo) return null;\r\n\r\n  const goDetalle = () => navigate(`/detalle/${promo.id}`);\r\n  const titulo = sanitizeText(promo.titulo || \"Promo nueva\");\r\n  const descripcion = sanitizeText(promo.descripcion || \"Sin descripcion\");\r\n  const nombreLocal = sanitizeText(promo.nombreLocal || \"Local\");\r\n  const ubicacion = sanitizeText(promo.ubicacion || promo.sector || \"Ubicacion\");\r\n\r\n  const baseClass = className || \"flex-shrink-0 w-[90%] sm:w-[420px] pr-0\";\r\n  const {\r\n    className: wrapperClassName,\r\n    style: wrapperStyle,\r\n    ...restWrapperProps\r\n  } = wrapperProps || {};\r\n  const mergedClassName = [baseClass, wrapperClassName]\r\n    .filter(Boolean)\r\n    .join(\" \");\r\n\r\n  return (\r\n    <div\r\n      className={mergedClassName}\r\n      style={wrapperStyle}\r\n      {...restWrapperProps}\r\n    >\r\n      <article\r\n        onClick={goDetalle}\r\n        className=\"cursor-pointer rounded-2xl border border-[#E9E2F7] bg-white shadow-sm overflow-hidden flex aspect-[5/2]\"\r\n      >\r\n        <div className=\"w-32 sm:w-36 bg-[#F3EEFF] flex-shrink-0\">\r\n          {promo.imagen ? (\r\n            <img\r\n              src={promo.imagen}\r\n              alt={titulo}\r\n              className=\"h-full w-full object-cover\"\r\n            />\r\n          ) : (\r\n            <div className=\"h-full w-full bg-[#F3EEFF]\" />\r\n          )}\r\n        </div>\r\n        <div className=\"flex-1 p-4\">\r\n          <h3 className=\"text-sm font-semibold text-[#2F1A55] line-clamp-1\">\r\n            {titulo}\r\n          </h3>\r\n          <p className=\"mt-1 text-xs text-slate-500 line-clamp-2\">\r\n            {descripcion}\r\n          </p>\r\n          <div className=\"mt-3 text-sm font-semibold text-[#5E30A5]\">\r\n            {nombreLocal}\r\n          </div>\r\n          <div className=\"mt-2 flex flex-wrap gap-3 text-[11px] text-slate-500\">\r\n            <span className=\"inline-flex items-center gap-1\">\r\n              <MapPin size={11} />\r\n              {ubicacion}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </article>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\cards\\PromoCardVariant.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\desktop\\Footer.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\desktop\\FooterAlt.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[29,68],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/desktop/Footer.jsx\r\n\r\nimport { motion } from \"framer-motion\";\r\nimport { Phone, Info, Github, Heart } from \"lucide-react\";\r\n\r\nexport default function Footer() {\r\n  return (\r\n    <footer className=\"bg-[#5E30A5] text-[#FFC21C] text-center md:text-left py-4 px-6 relative z-40\">\r\n      <div className=\"max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4\">\r\n\r\n        {/* Información general */}\r\n        <div className=\"text-sm opacity-90\">\r\n          <p className=\"font-semibold text-white tracking-wide\">\r\n            Referidos App\r\n          </p>\r\n          <p className=\"text-[#FFC21C]/90 text-xs\">\r\n            Conecta clientes, negocios y recompensas.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Íconos de acción */}\r\n        <div className=\"flex gap-6 text-[#FFC21C]/90\">\r\n          <motion.a\r\n            href=\"tel:+593987654321\"\r\n            whileHover={{ scale: 1.2 }}\r\n            whileTap={{ scale: 0.95 }}\r\n            className=\"flex items-center gap-1 hover:text-white transition\"\r\n          >\r\n            <Phone size={16} />\r\n            <span className=\"text-xs hidden sm:inline\">Soporte</span>\r\n          </motion.a>\r\n\r\n          <motion.a\r\n            href=\"#\"\r\n            whileHover={{ scale: 1.2 }}\r\n            whileTap={{ scale: 0.95 }}\r\n            className=\"flex items-center gap-1 hover:text-white transition\"\r\n          >\r\n            <Info size={16} />\r\n            <span className=\"text-xs hidden sm:inline\">Acerca de</span>\r\n          </motion.a>\r\n\r\n          <motion.a\r\n            href=\"https://github.com/\"\r\n            target=\"_blank\"\r\n            rel=\"noopener noreferrer\"\r\n            whileHover={{ rotate: 10 }}\r\n            whileTap={{ scale: 0.9 }}\r\n            className=\"hover:text-white transition\"\r\n          >\r\n            <Github size={18} />\r\n          </motion.a>\r\n        </div>\r\n\r\n        {/* Versión y créditos */}\r\n        <div className=\"flex items-center gap-2 text-xs text-white/70\">\r\n          <span>ALPHA v0.0.1</span>\r\n          <span>•</span>\r\n          <span className=\"flex items-center gap-1\">\r\n            Hecho con <Heart size={12} className=\"text-red-400\" /> en Ecuador\r\n          </span>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Línea decorativa animada */}\r\n      <motion.div\r\n        layoutId=\"footerBar\"\r\n        className=\"absolute bottom-0 left-0 w-full h-[3px] bg-gradient-to-r from-[#FFC21C] via-white to-[#FFC21C]\"\r\n        initial={{ opacity: 0, scaleX: 0 }}\r\n        animate={{ opacity: 1, scaleX: 1 }}\r\n        transition={{ duration: 1, delay: 0.2 }}\r\n      />\r\n    </footer>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\desktop\\FooterWEB.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\desktop\\FooterWEBup.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[99,138],"text":""},"desc":"Remove unused variable 'motion'."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useLayoutEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":21,"column":3,"nodeType":"Identifier","endLine":21,"endColumn":18}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/desktop/HeaderAlt2.jsx\r\nimport React, { useLayoutEffect, useRef } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Phone, Info, Github, Heart } from \"lucide-react\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\n\r\nexport default function Header({\r\n  locAllowed,\r\n  hideLocationBar,\r\n  onCloseLocationBar,\r\n  onHeaderHeightChange,\r\n}) {\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const headerRef = useRef(null);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (!usuario || !onboarding?.allowAccess) return null;\r\n\r\n  useLayoutEffect(() => {\r\n    if (headerRef.current && onHeaderHeightChange) {\r\n      onHeaderHeightChange(headerRef.current.offsetHeight);\r\n    }\r\n  });\r\n\r\n  return (\r\n    <>\r\n      {!hideLocationBar && locAllowed === false && (\r\n        <div className=\"w-full bg-[#FFF3CD]\">\r\n          <div className=\"max-w-5xl mx-auto px-4 py-2\">\r\n            <div className=\"flex items-center justify-between bg-[#FFF8D8] text-[#6B5E00] rounded-lg px-3 py-2 shadow-sm\">\r\n              <span className=\"text-xs sm:text-sm\">\r\n                La app usa tu ubicacion para mostrar promos cercanas.\r\n              </span>\r\n              <button\r\n                onClick={onCloseLocationBar}\r\n                className=\"text-sm leading-none\"\r\n              >\r\n                X\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <header\r\n        ref={headerRef}\r\n        className=\"bg-[#5E30A5] text-[#FFC21C] text-center md:text-left py-4 px-6 relative z-40 hidden md:block\"\r\n      >\r\n        <div className=\"max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4\">\r\n          <div className=\"text-sm opacity-90\">\r\n            <p className=\"font-semibold text-white tracking-wide\">\r\n              Referidos App\r\n            </p>\r\n            <p className=\"text-[#FFC21C]/90 text-xs\">\r\n              Conecta clientes, negocios y recompensas.\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"flex gap-6 text-[#FFC21C]/90 items-center\">\r\n            <motion.a\r\n              href=\"tel:+593995705833\"\r\n              whileHover={{ scale: 1.1 }}\r\n              whileTap={{ scale: 0.95 }}\r\n              className=\"flex items-center gap-1 hover:text-white transition text-sm\"\r\n            >\r\n              <Phone size={16} />\r\n              <span className=\"text-xs hidden sm:inline\">Soporte</span>\r\n            </motion.a>\r\n\r\n            <motion.a\r\n              href=\"#\"\r\n              whileHover={{ scale: 1.1 }}\r\n              whileTap={{ scale: 0.95 }}\r\n              className=\"flex items-center gap-1 hover:text-white transition text-sm\"\r\n            >\r\n              <Info size={16} />\r\n              <span className=\"text-xs hidden sm:inline\">Acerca de</span>\r\n            </motion.a>\r\n\r\n            <motion.a\r\n              href=\"https://github.com/\"\r\n              target=\"_blank\"\r\n              rel=\"noopener noreferrer\"\r\n              whileHover={{ rotate: 10, scale: 1.02 }}\r\n              whileTap={{ scale: 0.95 }}\r\n              className=\"hover:text-white transition\"\r\n            >\r\n              <Github size={18} />\r\n            </motion.a>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-2 text-xs text-white/70\">\r\n            <span>ALPHA v0.0.1</span>\r\n            <span>+</span>\r\n            <span className=\"flex items-center gap-1\">\r\n              Hecho con <Heart size={12} className=\"text-red-400\" /> en Ecuador\r\n            </span>\r\n          </div>\r\n        </div>\r\n\r\n        <motion.div\r\n          layoutId=\"footerBar\"\r\n          className=\"absolute bottom-0 left-0 w-full h-[3px] bg-gradient-to-r from-[#FFC21C] via-white to-[#FFC21C]\"\r\n          initial={{ opacity: 0, scaleX: 0 }}\r\n          animate={{ opacity: 1, scaleX: 1 }}\r\n          transition={{ duration: 1, delay: 0.2 }}\r\n        />\r\n      </header>\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\desktop\\HeaderWEB.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[189,228],"text":""},"desc":"Remove unused variable 'motion'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":76,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":48,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[2432,2444],"text":""},"desc":"Remove unused variable 'Icon'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":99,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":99,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[3264,3276],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/desktop/HeaderAlt.jsx\r\nimport { Link, useLocation } from \"react-router-dom\";\r\nimport {\r\n  Home,\r\n  Tag,\r\n  QrCode,\r\n  Camera,\r\n  Shield,\r\n  User,\r\n} from \"lucide-react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\n\r\nexport default function HeaderAlt() {\r\n  const location = useLocation();\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (!usuario || !onboarding?.allowAccess) return null;\r\n  if (!usuario.role) return null;\r\n\r\n  const role = usuario?.role || \"cliente\";\r\n\r\n  const HOME_PATHS = {\r\n    cliente: \"/cliente/inicio\",\r\n    negocio: \"/negocio/inicio\",\r\n    admin: \"/admin/inicio\",\r\n  };\r\n\r\n  let links = [];\r\n\r\n  if (role === \"cliente\") {\r\n    links = [\r\n      { path: \"/cliente/inicio\", label: \"Inicio\", icon: Home },\r\n      { path: \"/cliente/escanear\", label: \"Escanear\", icon: QrCode },\r\n      { path: \"/cliente/historial\", label: \"Historial\", icon: Tag },\r\n      { path: \"/cliente/perfil\", label: \"Perfil\", icon: User },\r\n    ];\r\n  }\r\n\r\n  if (role === \"negocio\") {\r\n    links = [\r\n      { path: \"/negocio/inicio\", label: \"Inicio\", icon: Home },\r\n      { path: \"/negocio/escanear\", label: \"Escanear\", icon: Camera },\r\n      { path: \"/negocio/mis-promos\", label: \"Promos\", icon: Tag },\r\n      { path: \"/negocio/perfil\", label: \"Perfil\", icon: User },\r\n    ];\r\n  }\r\n\r\n  if (role === \"admin\") {\r\n    links = [\r\n      { path: \"/admin/inicio\", label: \"Inicio\", icon: Home },\r\n      { path: \"/admin/promos\", label: \"Promos\", icon: Tag },\r\n      { path: \"/admin/qr-validos\", label: \"QR\", icon: QrCode },\r\n      { path: \"/admin/panel\", label: \"Admin\", icon: Shield },\r\n    ];\r\n  }\r\n\r\n  if (links.length === 0) return null;\r\n\r\n  const isActive = (path) =>\r\n    location.pathname === path ||\r\n    (path === HOME_PATHS[role] &&\r\n      location.pathname.startsWith(HOME_PATHS[role]));\r\n\r\n  return (\r\n    <header className=\"bg-[#5E30A5] text-[#FFC21C] shadow-lg\">\r\n      {/* Desktop: barra superior */}\r\n      <div className=\"hidden md:flex justify-between items-center px-6 py-3\">\r\n        <h1 className=\"text-xl font-semibold tracking-wide select-none\">\r\n          Referidos App\r\n        </h1>\r\n        <nav className=\"flex gap-6 text-sm\">\r\n          {links.map(({ path, label, icon: Icon }) => {\r\n            const active = isActive(path);\r\n            return (\r\n              <Link\r\n                key={path}\r\n                to={path}\r\n                className={`flex items-center gap-1 transition ${\r\n                  active ? \"font-bold text-white\" : \"opacity-80 hover:opacity-100\"\r\n                }`}\r\n              >\r\n                <Icon size={18} />\r\n                {label}\r\n              </Link>\r\n            );\r\n          })}\r\n        </nav>\r\n        <span className=\"text-[10px] text-white/70 absolute bottom-1 right-3\">\r\n          ALPHA v0.0.1\r\n        </span>\r\n      </div>\r\n\r\n      {/* Mobile: barra inferior animada */}\r\n      <nav className=\"md:hidden fixed bottom-0 left-0 w-full bg-[#5E30A5] border-t border-white/20 flex justify-around py-2 z-50\">\r\n        {links.map(({ path, label, icon: Icon }) => {\r\n          const active = isActive(path);\r\n          return (\r\n            <Link\r\n              key={path}\r\n              to={path}\r\n              className=\"relative flex flex-col items-center text-[11px] font-medium\"\r\n            >\r\n              <motion.div\r\n                initial={false}\r\n                animate={{\r\n                  scale: active ? 1.2 : 1,\r\n                  color: active ? \"#ffffff\" : \"#FFC21C\",\r\n                }}\r\n                transition={{ type: \"spring\", stiffness: 300, damping: 15 }}\r\n              >\r\n                <Icon size={22} />\r\n              </motion.div>\r\n              <motion.span\r\n                className=\"mt-1\"\r\n                animate={{\r\n                  opacity: active ? 1 : 0.7,\r\n                  color: active ? \"#ffffff\" : \"#FFC21C\",\r\n                }}\r\n              >\r\n                {label}\r\n              </motion.span>\r\n\r\n              {active && (\r\n                <motion.div\r\n                  layoutId=\"activeIndicator\"\r\n                  className=\"absolute -bottom-[2px] w-6 h-[2px] bg-white rounded-full\"\r\n                  transition={{ type: \"spring\", stiffness: 250, damping: 20 }}\r\n                />\r\n              )}\r\n            </Link>\r\n          );\r\n        })}\r\n      </nav>\r\n    </header>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\errors\\AppErrorBoundary.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\footer\\Footer.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[208,247],"text":""},"desc":"Remove unused variable 'motion'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":92,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":46,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[3091,3097],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/footer/Footer.jsx\r\nimport React from \"react\";\r\nimport { Link, useLocation } from \"react-router-dom\";\r\nimport { Home, Tag, QrCode, Camera, Shield, User, Octagon, Plus } from \"lucide-react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport ClienteFooter from \"../../cliente/layout/ClienteFooter\";\r\n\r\nexport default function Footer() {\r\n  const location = useLocation();\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (!usuario || !onboarding?.allowAccess) return null;\r\n  if (!usuario.role) return null;\r\n\r\n  const role = usuario?.role || \"cliente\";\r\n\r\n  if (role === \"cliente\") {\r\n    return <ClienteFooter />;\r\n  }\r\n  const notiCount =\r\n    usuario?.notificaciones?.length ||\r\n    usuario?.notificacionesCount ||\r\n    0;\r\n\r\n   // ICONO COMPUESTO 'GESTIONAR'\r\n  const GestionarIcon = ({ size = 22 }) => (\r\n    <span\r\n      className=\"relative inline-flex items-center justify-center\"\r\n      style={{ width: size, height: size }}\r\n    >\r\n      <Octagon size={size} />\r\n      <Plus size={Math.round(size * 0.6)} className=\"absolute\" />\r\n    </span>\r\n  );\r\n\r\n\r\n  // RUTAS INICIO POR ROL\r\n  const HOME_PATHS = {\r\n    cliente: \"/cliente/inicio\",\r\n    negocio: \"/negocio/inicio\",\r\n    admin: \"/admin/inicio\",\r\n  };\r\n\r\n  // Marca activo cuando coincide EXACTO o empieza por el home real\r\n  const isActive = (path) =>\r\n    location.pathname === path ||\r\n    (path === HOME_PATHS[role] &&\r\n      location.pathname.startsWith(HOME_PATHS[role]));\r\n\r\n  // BOTONES POR ROL\r\n  let linksMobile = [];\r\n\r\n  if (role === \"cliente\") {\r\n    linksMobile = [\r\n      { path: \"/cliente/inicio\", label: \"Inicio\", Icon: Home },\r\n      { path: \"/cliente/escanear\", label: \"Escanear\", Icon: QrCode },\r\n      { path: \"/cliente/historial\", label: \"Historial\", Icon: Tag, badge: notiCount },\r\n      { path: \"/cliente/perfil\", label: \"Perfil\", Icon: User },\r\n    ];\r\n  }\r\n\r\n  if (role === \"negocio\") {\r\n    linksMobile = [\r\n      { path: \"/negocio/inicio\", label: \"Inicio\", Icon: Home },\r\n      { path: \"/negocio/escanear\", label: \"Escanear\", Icon: Camera },\r\n      { path: \"/negocio/gestionar\", label: \"Gestionar\", Icon: GestionarIcon },\r\n      { path: \"/negocio/perfil\", label: \"Perfil\", Icon: User },\r\n    ];\r\n  }\r\n\r\n  if (role === \"admin\") {\r\n    linksMobile = [\r\n      { path: \"/admin/inicio\", label: \"Inicio\", Icon: Home },\r\n      { path: \"/admin/promos\", label: \"Promos\", Icon: Tag },\r\n      { path: \"/admin/qr-validos\", label: \"QR\", Icon: QrCode },\r\n      { path: \"/admin/panel\", label: \"Admin\", Icon: Shield },\r\n    ];\r\n  }\r\n\r\n  if (linksMobile.length === 0) return null;\r\n\r\n  return (\r\n    <nav\r\n      className=\"md:hidden fixed bottom-0 left-0 w-full bg-[#5E30A5] border-t border-white/20 z-50\"\r\n      style={{ paddingBottom: \"env(safe-area-inset-bottom)\" }}\r\n    >\r\n      <div className=\"flex justify-around py-2\">\r\n        {linksMobile.map(({ path, label, Icon, badge }) => {\r\n          const active = isActive(path);\r\n\r\n          return (\r\n            <Link\r\n              key={path}\r\n              to={path}\r\n              className=\"relative flex flex-col items-center text-[11px] font-medium\"\r\n            >\r\n              <motion.div\r\n                initial={false}\r\n                animate={{\r\n                  scale: active ? 1.2 : 1,\r\n                  color: active ? \"#FFFFFF\" : \"#CBB3F0\",\r\n                }}\r\n                transition={{ type: \"spring\", stiffness: 300, damping: 15 }}\r\n              >\r\n                <Icon size={22} />\r\n              </motion.div>\r\n\r\n              <motion.span\r\n                className={label === \"Gestionar\" ? \"mt-0\" : \"mt-1\"}\r\n                animate={{\r\n                  opacity: active ? 1 : 0.7,\r\n                  color: active ? \"#FFFFFF\" : \"#CBB3F0\",\r\n                }}\r\n              >\r\n                {label}\r\n              </motion.span>\r\n\r\n              {active && (\r\n                <motion.div\r\n                  layoutId=\"activeIndicator\"\r\n                  className=\"absolute -bottom-[2px] w-6 h-[2px] bg-white rounded-full\"\r\n                  transition={{ type: \"spring\", stiffness: 250, damping: 20 }}\r\n                />\r\n              )}\r\n\r\n              {badge > 0 && (\r\n                <span className=\"absolute -top-1 right-3 inline-flex items-center justify-center px-1.5 py-0.5 text-[10px] font-semibold leading-none text-white bg-red-500 rounded-full shadow\">\r\n                  {badge > 99 ? \"99+\" : badge}\r\n                </span>\r\n              )}\r\n            </Link>\r\n          );\r\n        })}\r\n      </div>\r\n      <div\r\n        aria-hidden=\"true\"\r\n        className=\"pointer-events-none\"\r\n        style={{\r\n          position: \"absolute\",\r\n          left: 0,\r\n          right: 0,\r\n          bottom: \"calc(-1 * env(safe-area-inset-bottom))\",\r\n          height: \"env(safe-area-inset-bottom)\",\r\n          background: \"#5E30A5\",\r\n        }}\r\n      />\r\n    </nav>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\gestionar\\GestionarPanel.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[76,115],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/GestionarPanel.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\n\r\nexport default function GestionarPanel({ activeId, children }) {\r\n  return (\r\n    <motion.div\r\n      key={activeId}\r\n      initial={{ opacity: 0, y: 12 }}\r\n      animate={{ opacity: 1, y: 0 }}\r\n      transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n      className=\"mt-6\"\r\n    >\r\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\">\r\n        {children}\r\n      </div>\r\n    </motion.div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\gestionar\\GestionarTabs.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[75,114],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/GestionarTabs.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\n\r\nexport default function GestionarTabs({ tabs, activeId, onChange }) {\r\n  return (\r\n    <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-1 shadow-sm\">\r\n      <div className=\"grid grid-cols-4 gap-1\">\r\n        {tabs.map((tab) => {\r\n          const active = tab.id === activeId;\r\n\r\n          return (\r\n            <button\r\n              key={tab.id}\r\n              type=\"button\"\r\n              onClick={() => onChange(tab.id)}\r\n              className={`relative flex flex-col items-center justify-center gap-1 rounded-xl px-2 py-2.5 text-[11px] font-semibold transition ${\r\n                active\r\n                  ? \"text-[#5E30A5]\"\r\n                  : \"text-slate-500 hover:text-[#5E30A5]\"\r\n              }`}\r\n              aria-pressed={active}\r\n            >\r\n              {active && (\r\n                <motion.span\r\n                  layoutId=\"gestionarTab\"\r\n                  className=\"absolute inset-0 rounded-xl bg-[#5E30A5]/10\"\r\n                  transition={{ type: \"spring\", stiffness: 260, damping: 26 }}\r\n                />\r\n              )}\r\n              <motion.span\r\n                className=\"relative z-10\"\r\n                animate={{ scale: active ? 1.12 : 1 }}\r\n                transition={{ type: \"spring\", stiffness: 300, damping: 20 }}\r\n              >\r\n                <tab.Icon size={18} />\r\n              </motion.span>\r\n              <span className=\"relative z-10 leading-none\">{tab.label}</span>\r\n            </button>\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\gestionar\\sections\\Dispositivos.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[83,122],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Dispositivos.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Laptop, MonitorSmartphone, Smartphone, Wifi } from \"lucide-react\";\r\n\r\nexport default function Dispositivos() {\r\n  const devices = [\r\n    {\r\n      name: \"Terminal principal\",\r\n      detail: \"POS - Mostrador\",\r\n      status: \"Activo\",\r\n      lastSeen: \"Hace 2 min\",\r\n      Icon: MonitorSmartphone,\r\n    },\r\n    {\r\n      name: \"Tablet cocina\",\r\n      detail: \"Ordenes\",\r\n      status: \"Activo\",\r\n      lastSeen: \"Hace 12 min\",\r\n      Icon: Laptop,\r\n    },\r\n    {\r\n      name: \"Telefono gerente\",\r\n      detail: \"Panel mobile\",\r\n      status: \"En pausa\",\r\n      lastSeen: \"Hace 1 hora\",\r\n      Icon: Smartphone,\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Dispositivos vinculados\r\n          </div>\r\n          <div className=\"text-xs text-slate-500\">\r\n            Controla accesos y sesiones activas en tu negocio.\r\n          </div>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5] shadow-sm transition hover:border-[#5E30A5]/40\"\r\n        >\r\n          Agregar dispositivo\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"grid gap-3\">\r\n        {devices.map((device) => (\r\n          <motion.div\r\n            key={device.name}\r\n            whileHover={{ y: -2 }}\r\n            className=\"flex flex-col gap-3 rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-4 shadow-sm sm:flex-row sm:items-center sm:justify-between\"\r\n          >\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"flex h-11 w-11 items-center justify-center rounded-xl bg-white text-[#5E30A5] shadow-sm\">\r\n                <device.Icon size={20} />\r\n              </div>\r\n              <div>\r\n                <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                  {device.name}\r\n                </div>\r\n                <div className=\"text-xs text-slate-500\">{device.detail}</div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-4 text-xs text-slate-500\">\r\n              <div className=\"inline-flex items-center gap-2\">\r\n                <span\r\n                  className={`h-2.5 w-2.5 rounded-full ${\r\n                    device.status === \"Activo\" ? \"bg-emerald-400\" : \"bg-amber-400\"\r\n                  }`}\r\n                />\r\n                {device.status}\r\n              </div>\r\n              <div className=\"flex items-center gap-1\">\r\n                <Wifi size={14} />\r\n                {device.lastSeen}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                type=\"button\"\r\n                className=\"rounded-lg border border-[#E9E2F7] bg-white px-3 py-1.5 text-xs font-semibold text-slate-500 transition hover:text-[#5E30A5]\"\r\n              >\r\n                Detalles\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                className=\"rounded-lg bg-[#5E30A5] px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-[#4B2488]\"\r\n              >\r\n                Cerrar sesion\r\n              </button>\r\n            </div>\r\n          </motion.div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-white p-4\">\r\n        <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n          Recomendaciones de seguridad\r\n        </div>\r\n        <p className=\"mt-1 text-xs text-slate-500\">\r\n          Revisa dispositivos sin uso reciente y elimina accesos innecesarios.\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\gestionar\\sections\\Grupos.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[77,116],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Grupos.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { BadgeCheck, Crown, Target, Users } from \"lucide-react\";\r\n\r\nexport default function Grupos() {\r\n  const groups = [\r\n    {\r\n      name: \"Clientes frecuentes\",\r\n      desc: \"Visitan mas de 3 veces por mes\",\r\n      count: \"420\",\r\n      Icon: Crown,\r\n      tone: \"bg-amber-50 text-amber-600\",\r\n    },\r\n    {\r\n      name: \"Nuevos\",\r\n      desc: \"Primeras 2 semanas\",\r\n      count: \"180\",\r\n      Icon: Users,\r\n      tone: \"bg-sky-50 text-sky-600\",\r\n    },\r\n    {\r\n      name: \"VIP\",\r\n      desc: \"Top 5% en gasto\",\r\n      count: \"38\",\r\n      Icon: BadgeCheck,\r\n      tone: \"bg-emerald-50 text-emerald-600\",\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Segmentos de clientes\r\n          </div>\r\n          <div className=\"text-xs text-slate-500\">\r\n            Crea experiencias personalizadas y comunica con precision.\r\n          </div>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"rounded-xl bg-[#5E30A5] px-4 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-[#4B2488]\"\r\n        >\r\n          Crear grupo\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"grid gap-4 lg:grid-cols-3\">\r\n        {groups.map((group) => (\r\n          <motion.div\r\n            key={group.name}\r\n            whileHover={{ y: -2 }}\r\n            className=\"rounded-xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className={`rounded-xl px-2.5 py-1 text-xs font-semibold ${group.tone}`}>\r\n                <group.Icon size={16} />\r\n              </div>\r\n              <div className=\"text-lg font-bold text-[#2F1A55]\">\r\n                {group.count}\r\n              </div>\r\n            </div>\r\n            <div className=\"mt-3 text-sm font-semibold text-[#2F1A55]\">\r\n              {group.name}\r\n            </div>\r\n            <div className=\"text-xs text-slate-500\">{group.desc}</div>\r\n            <div className=\"mt-4 h-2 w-full rounded-full bg-slate-100\">\r\n              <div className=\"h-2 w-2/3 rounded-full bg-[#5E30A5]/60\" />\r\n            </div>\r\n          </motion.div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-4\">\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n          <Target size={16} />\r\n          Reglas sugeridas\r\n        </div>\r\n        <div className=\"mt-3 grid gap-3 sm:grid-cols-2\">\r\n          {[\r\n            \"Clientes con 3 visitas en 30 dias\",\r\n            \"Ticket promedio mayor a $25\",\r\n            \"Sin compra en los ultimos 14 dias\",\r\n            \"Invitar amigos recientes\",\r\n          ].map((rule) => (\r\n            <div\r\n              key={rule}\r\n              className=\"rounded-lg border border-[#E9E2F7] bg-white px-3 py-2 text-xs text-slate-500\"\r\n            >\r\n              {rule}\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\gestionar\\sections\\Metricas.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[79,118],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Metricas.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { ArrowUpRight, BarChart3, DollarSign, Sparkles, Ticket, Users } from \"lucide-react\";\r\n\r\nexport default function Metricas() {\r\n  const kpis = [\r\n    {\r\n      label: \"Promos activas\",\r\n      value: \"12\",\r\n      delta: \"+8%\",\r\n      Icon: Ticket,\r\n    },\r\n    {\r\n      label: \"Visitas hoy\",\r\n      value: \"1,240\",\r\n      delta: \"+12%\",\r\n      Icon: BarChart3,\r\n    },\r\n    {\r\n      label: \"Referidos\",\r\n      value: \"86\",\r\n      delta: \"+5%\",\r\n      Icon: Users,\r\n    },\r\n    {\r\n      label: \"Ingresos\",\r\n      value: \"$2,840\",\r\n      delta: \"+3%\",\r\n      Icon: DollarSign,\r\n    },\r\n  ];\r\n\r\n  const bars = [40, 65, 55, 80, 48, 72, 60];\r\n  const topPromos = [\r\n    { name: \"2x1 Almuerzos\", share: 68 },\r\n    { name: \"Happy Hour\", share: 52 },\r\n    { name: \"Combo Familiar\", share: 41 },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n        {kpis.map((item) => (\r\n          <motion.div\r\n            key={item.label}\r\n            whileHover={{ y: -2 }}\r\n            className=\"rounded-xl border border-[#E9E2F7] bg-[#F8F5FF] p-4 shadow-sm\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"rounded-xl bg-white p-2 text-[#5E30A5] shadow-sm\">\r\n                <item.Icon size={18} />\r\n              </div>\r\n              <div className=\"inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-600\">\r\n                {item.delta}\r\n                <ArrowUpRight size={12} />\r\n              </div>\r\n            </div>\r\n            <div className=\"mt-3 text-2xl font-bold text-[#2F1A55]\">\r\n              {item.value}\r\n            </div>\r\n            <div className=\"text-xs text-slate-500\">{item.label}</div>\r\n          </motion.div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"grid gap-4 lg:grid-cols-[1.4fr_1fr]\">\r\n        <div className=\"rounded-xl border border-[#E9E2F7] bg-white p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                Rendimiento semanal\r\n              </div>\r\n              <div className=\"text-xs text-slate-500\">Ultimos 7 dias</div>\r\n            </div>\r\n            <div className=\"flex items-center gap-1 text-xs text-[#5E30A5]\">\r\n              <Sparkles size={14} />\r\n              Tendencia positiva\r\n            </div>\r\n          </div>\r\n          <div className=\"mt-4 grid h-24 grid-cols-7 items-end gap-2\">\r\n            {bars.map((height, index) => (\r\n              <div\r\n                key={`${height}-${index}`}\r\n                className=\"rounded-lg border border-[#5E30A5]/20 bg-[#5E30A5]/15\"\r\n                style={{ height: `${height}%` }}\r\n              />\r\n            ))}\r\n          </div>\r\n          <div className=\"mt-3 text-xs text-slate-500\">\r\n            32% mas conversion que la semana pasada.\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E9E2F7] bg-white p-4\">\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Top promociones\r\n          </div>\r\n          <div className=\"mt-3 space-y-3\">\r\n            {topPromos.map((promo) => (\r\n              <div key={promo.name} className=\"space-y-1\">\r\n                <div className=\"flex items-center justify-between text-xs\">\r\n                  <span className=\"font-semibold text-slate-600\">\r\n                    {promo.name}\r\n                  </span>\r\n                  <span className=\"text-slate-400\">{promo.share}%</span>\r\n                </div>\r\n                <div className=\"h-2 w-full rounded-full bg-slate-100\">\r\n                  <div\r\n                    className=\"h-2 rounded-full bg-[#5E30A5]/60\"\r\n                    style={{ width: `${promo.share}%` }}\r\n                  />\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\gestionar\\sections\\Seguridad.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[94,133],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Seguridad.jsx\r\nimport React, { useState } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { KeyRound, Lock, ShieldCheck, Smartphone } from \"lucide-react\";\r\n\r\nexport default function Seguridad() {\r\n  const [settings, setSettings] = useState({\r\n    twoFactor: true,\r\n    loginAlerts: true,\r\n    deviceLock: false,\r\n  });\r\n\r\n  const toggle = (key) => {\r\n    setSettings((prev) => ({ ...prev, [key]: !prev[key] }));\r\n  };\r\n\r\n  const rows = [\r\n    {\r\n      key: \"twoFactor\",\r\n      title: \"Autenticacion en dos pasos\",\r\n      desc: \"Protege accesos sensibles con verificacion extra.\",\r\n      Icon: ShieldCheck,\r\n    },\r\n    {\r\n      key: \"loginAlerts\",\r\n      title: \"Alertas de inicio de sesion\",\r\n      desc: \"Recibe notificaciones ante accesos nuevos.\",\r\n      Icon: Smartphone,\r\n    },\r\n    {\r\n      key: \"deviceLock\",\r\n      title: \"Bloqueo de dispositivos\",\r\n      desc: \"Solicita PIN en terminales del negocio.\",\r\n      Icon: Lock,\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Seguridad y accesos\r\n          </div>\r\n          <div className=\"text-xs text-slate-500\">\r\n            Ajusta permisos y monitorea actividad en tiempo real.\r\n          </div>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5] shadow-sm\"\r\n        >\r\n          Revisar permisos\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"grid gap-3\">\r\n        {rows.map((row) => {\r\n          const enabled = settings[row.key];\r\n          return (\r\n            <motion.div\r\n              key={row.key}\r\n              whileHover={{ y: -2 }}\r\n              className=\"flex items-center justify-between rounded-xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n            >\r\n              <div className=\"flex items-start gap-3\">\r\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-[#F8F5FF] text-[#5E30A5]\">\r\n                  <row.Icon size={18} />\r\n                </div>\r\n                <div>\r\n                  <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                    {row.title}\r\n                  </div>\r\n                  <div className=\"text-xs text-slate-500\">{row.desc}</div>\r\n                </div>\r\n              </div>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => toggle(row.key)}\r\n                className={`relative h-6 w-11 rounded-full transition ${\r\n                  enabled ? \"bg-[#5E30A5]\" : \"bg-slate-200\"\r\n                }`}\r\n                aria-pressed={enabled}\r\n              >\r\n                <span\r\n                  className={`absolute top-0.5 h-5 w-5 rounded-full bg-white shadow-sm transition ${\r\n                    enabled ? \"translate-x-5\" : \"translate-x-0.5\"\r\n                  }`}\r\n                />\r\n              </button>\r\n            </motion.div>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      <div className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-4\">\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n          <KeyRound size={16} />\r\n          Accesos recientes\r\n        </div>\r\n        <div className=\"mt-3 space-y-3 text-xs text-slate-500\">\r\n          <div className=\"flex items-center justify-between rounded-lg border border-[#E9E2F7] bg-white px-3 py-2\">\r\n            <span>Panel web - Quito, EC</span>\r\n            <span>Hace 3 min</span>\r\n          </div>\r\n          <div className=\"flex items-center justify-between rounded-lg border border-[#E9E2F7] bg-white px-3 py-2\">\r\n            <span>Tablet cocina - Guayaquil</span>\r\n            <span>Hace 2 horas</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-elements\\HeaderActions.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-elements\\TabTitle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-elements\\UserIdentity.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-elements\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-panels\\HeaderPanelContainer.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-panels\\LocationPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-panels\\NotificationsPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-panels\\QueuePanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-panels\\SearchbarPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header-panels\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header\\Header.jsx","messages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useLayoutEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":92,"column":3,"nodeType":"Identifier","endLine":92,"endColumn":18}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/header/Header.jsx\r\nimport React, { useLayoutEffect, useRef, useState } from \"react\";\r\nimport { Link, useLocation } from \"react-router-dom\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport HeaderCliente from \"./cliente/HeaderCliente\";\r\nimport HeaderNegocio from \"./negocio/HeaderNegocio\";\r\n\r\nconst BRAND_YELLOW = \"#FFF3CD\";\r\n\r\nconst AVATAR_FEMALE = \"https://cdn-icons-png.flaticon.com/512/4474/4474849.png\";\r\nconst AVATAR_MALE = \"https://cdn-icons-png.flaticon.com/512/4474/4474855.png\";\r\n\r\nconst COLLAPSED_HEIGHT = 80;\r\nconst SWIPE_THRESHOLD = 40;\r\n\r\nexport default function Header({\r\n  locAllowed,\r\n  hideLocationBar,\r\n  onCloseLocationBar,\r\n  onOpenTier,\r\n  onOpenGrupo,\r\n  onOpenMenu,\r\n  onHeaderHeightChange,\r\n}) {\r\n  const [expanded, setExpanded] = useState(false);\r\n  const [locationBarHeight, setLocationBarHeight] = useState(0);\r\n  const [overlayTop, setOverlayTop] = useState(0);\r\n  const location = useLocation();\r\n  const collapsedRef = useRef(null);\r\n  const expandedRef = useRef(null);\r\n  const locationBarRef = useRef(null);\r\n  const desktopRef = useRef(null);\r\n  const swipeRef = useRef({ startY: 0, active: false, handled: false });\r\n\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (!usuario || !onboarding?.allowAccess) return null;\r\n\r\n  const avatarSrc =\r\n    usuario?.genero === \"f\"\r\n      ? AVATAR_FEMALE\r\n      : usuario?.genero === \"m\"\r\n      ? AVATAR_MALE\r\n      : AVATAR_MALE;\r\n\r\n  const role = usuario?.role || \"cliente\";\r\n  const isCliente = role === \"cliente\";\r\n  const HOME_PATHS = {\r\n    cliente: \"/cliente/inicio\",\r\n    negocio: \"/negocio/inicio\",\r\n    admin: \"/admin/inicio\",\r\n  };\r\n\r\n  let links = [];\r\n  if (role === \"cliente\") {\r\n    links = [\r\n      { path: \"/cliente/inicio\", label: \"Inicio\" },\r\n      { path: \"/cliente/escanear\", label: \"Escanear\" },\r\n      { path: \"/cliente/historial\", label: \"Historial\" },\r\n      { path: \"/cliente/perfil\", label: \"Perfil\" },\r\n    ];\r\n  }\r\n\r\n  if (role === \"negocio\") {\r\n    links = [\r\n      { path: \"/negocio/inicio\", label: \"Inicio\" },\r\n      { path: \"/negocio/escanear\", label: \"Escanear\" },\r\n      { path: \"/negocio/mis-promos\", label: \"Promos\" },\r\n      { path: \"/negocio/perfil\", label: \"Perfil\" },\r\n    ];\r\n  }\r\n\r\n  if (role === \"admin\") {\r\n    links = [\r\n      { path: \"/admin/inicio\", label: \"Inicio\" },\r\n      { path: \"/admin/promos\", label: \"Promos\" },\r\n      { path: \"/admin/qr-validos\", label: \"QR Validos\" },\r\n      { path: \"/admin/panel\", label: \"Admin\" },\r\n    ];\r\n  }\r\n\r\n  const homePath = HOME_PATHS[role] || \"/\";\r\n  const isActive = (path) =>\r\n    location.pathname === path ||\r\n    (path === homePath && location.pathname.startsWith(homePath));\r\n  const isNegocio = role === \"negocio\";\r\n  const negocio = onboarding?.negocio || null;\r\n\r\n  useLayoutEffect(() => {\r\n    const currentLocationBarHeight =\r\n      !hideLocationBar && locAllowed === false && locationBarRef.current\r\n        ? locationBarRef.current.offsetHeight\r\n        : 0;\r\n\r\n    if (currentLocationBarHeight !== locationBarHeight) {\r\n      setLocationBarHeight(currentLocationBarHeight);\r\n    }\r\n\r\n    const baseHeight =\r\n      collapsedRef.current?.offsetHeight ||\r\n      desktopRef.current?.offsetHeight ||\r\n      COLLAPSED_HEIGHT;\r\n\r\n    const expandedHeight = expanded\r\n      ? expandedRef.current?.scrollHeight || 0\r\n      : 0;\r\n\r\n    const totalHeight = baseHeight + expandedHeight + currentLocationBarHeight;\r\n\r\n    setOverlayTop(totalHeight);\r\n\r\n    if (onHeaderHeightChange) {\r\n      onHeaderHeightChange(totalHeight);\r\n    }\r\n  }, [\r\n    expanded,\r\n    locAllowed,\r\n    hideLocationBar,\r\n    onHeaderHeightChange,\r\n    locationBarHeight,\r\n  ]);\r\n\r\n  const beginSwipe = (event) => {\r\n    swipeRef.current.startY = event.clientY;\r\n    swipeRef.current.active = true;\r\n    swipeRef.current.handled = false;\r\n  };\r\n\r\n  const moveSwipe = (event, direction) => {\r\n    const state = swipeRef.current;\r\n    if (!state.active || state.handled) return;\r\n\r\n    const delta = event.clientY - state.startY;\r\n\r\n    if (direction === \"down\" && delta > SWIPE_THRESHOLD) {\r\n      setExpanded(true);\r\n      state.handled = true;\r\n    }\r\n\r\n    if (direction === \"up\" && delta < -SWIPE_THRESHOLD) {\r\n      setExpanded(false);\r\n      state.handled = true;\r\n    }\r\n  };\r\n\r\n  const endSwipe = () => {\r\n    swipeRef.current.active = false;\r\n    swipeRef.current.handled = false;\r\n  };\r\n\r\n  const handlePointerMove = (event) => {\r\n    moveSwipe(event, expanded ? \"up\" : \"down\");\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed top-0 left-0 w-full z-50\">\r\n      {!hideLocationBar && locAllowed === false && (\r\n        <div\r\n          ref={locationBarRef}\r\n          style={{ width: \"100%\", background: BRAND_YELLOW }}\r\n        >\r\n          <div\r\n            style={{\r\n              maxWidth: 960,\r\n              margin: \"0 auto\",\r\n              padding: \"6px 16px\",\r\n            }}\r\n          >\r\n            <div\r\n              style={{\r\n                color: \"#6B5E00\",\r\n                borderRadius: 8,\r\n                padding: \"8px 12px\",\r\n                display: \"flex\",\r\n                justifyContent: \"space-between\",\r\n                alignItems: \"center\",\r\n                boxShadow: \"0 4px 10px rgba(0,0,0,0.04)\",\r\n                background: \"#FFF8D8\",\r\n              }}\r\n            >\r\n              <span style={{ fontSize: 13 }}>\r\n                La app usa tu ubicacion para mostrar promos cercanas.\r\n              </span>\r\n\r\n              <button\r\n                onClick={onCloseLocationBar}\r\n                style={{\r\n                  background: \"transparent\",\r\n                  border: 0,\r\n                  fontSize: 14,\r\n                  cursor: \"pointer\",\r\n                }}\r\n              >\r\n                X\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      <header\r\n        className={`${isCliente ? \"text-[#2F1A55]\" : \"text-white\"} shadow-md`}\r\n        style={\r\n          isCliente\r\n            ? {\r\n                background: \"#FFFFFF\",\r\n                borderBottom: \"1px solid #E9E2F7\",\r\n              }\r\n            : { background: \"#5E30A5\" }\r\n        }\r\n      >\r\n        {isNegocio ? (\r\n          <HeaderNegocio\r\n            usuario={usuario}\r\n            negocio={negocio}\r\n            avatarSrc={avatarSrc}\r\n            expanded={expanded}\r\n            setExpanded={setExpanded}\r\n            onOpenMenu={onOpenMenu}\r\n            collapsedRef={collapsedRef}\r\n            expandedRef={expandedRef}\r\n            collapsedHeight={COLLAPSED_HEIGHT}\r\n            onSwipeStart={beginSwipe}\r\n            onSwipeMove={handlePointerMove}\r\n            onSwipeEnd={endSwipe}\r\n          />\r\n        ) : (\r\n          <HeaderCliente\r\n            usuario={usuario}\r\n            avatarSrc={avatarSrc}\r\n            expanded={expanded}\r\n            setExpanded={setExpanded}\r\n            onOpenMenu={onOpenMenu}\r\n            onOpenTier={onOpenTier}\r\n            onOpenGrupo={onOpenGrupo}\r\n            collapsedRef={collapsedRef}\r\n            expandedRef={expandedRef}\r\n            collapsedHeight={COLLAPSED_HEIGHT}\r\n            onSwipeStart={beginSwipe}\r\n            onSwipeMove={handlePointerMove}\r\n            onSwipeEnd={endSwipe}\r\n          />\r\n        )}\r\n\r\n        <div className=\"max-w-6xl mx-auto px-4\">\r\n          <div\r\n            ref={desktopRef}\r\n            className=\"hidden md:flex justify-between items-center py-4\"\r\n          >\r\n            <Link\r\n              to={homePath}\r\n              className={`text-xl font-bold tracking-wide ${\r\n                isCliente ? \"text-[#2F1A55]\" : \"text-white\"\r\n              }`}\r\n            >\r\n              Referidos App\r\n            </Link>\r\n\r\n            <nav className=\"flex gap-6 items-center\">\r\n              {links.map((link) => (\r\n                <Link\r\n                  key={link.path}\r\n                  to={link.path}\r\n                  className={`transition-colors ${\r\n                    isCliente\r\n                      ? `hover:text-[#5E30A5] ${\r\n                          isActive(link.path) ? \"text-[#5E30A5]\" : \"text-slate-500\"\r\n                        }`\r\n                      : `hover:text-[#FFC21C] ${\r\n                          isActive(link.path) ? \"text-[#FFC21C]\" : \"\"\r\n                        }`\r\n                  }`}\r\n                >\r\n                  {link.label}\r\n                </Link>\r\n              ))}\r\n\r\n              <a\r\n                href=\"https://wa.me/593999999999\"\r\n                target=\"_blank\"\r\n                rel=\"noopener noreferrer\"\r\n                className={`ml-4 font-semibold px-3 py-1 rounded-xl transition ${\r\n                  isCliente\r\n                    ? \"bg-[#5E30A5] text-white hover:bg-[#4B2488]\"\r\n                    : \"bg-[#FFC21C] text-[#5E30A5] hover:opacity-90\"\r\n                }`}\r\n              >\r\n                Soporte\r\n              </a>\r\n            </nav>\r\n          </div>\r\n        </div>\r\n      </header>\r\n\r\n      <div\r\n        className=\"fixed left-0 right-0 bottom-0 md:hidden transition-opacity duration-200\"\r\n        style={{\r\n          top: overlayTop,\r\n          opacity: expanded ? 1 : 0,\r\n          pointerEvents: expanded ? \"auto\" : \"none\",\r\n          background: \"rgba(0,0,0,0.35)\",\r\n          zIndex: 40,\r\n        }}\r\n        onClick={() => setExpanded(false)}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header\\cliente\\HeaderCliente.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\header\\negocio\\HeaderNegocio.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\maps\\LeafletMapPicker.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'lat', 'lng', 'tileAttribution', 'tileUrl', and 'zoom'. Either include them or remove the dependency array.","line":106,"column":6,"nodeType":"ArrayExpression","endLine":106,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [lat, lng, tileAttribution, tileUrl, zoom]","fix":{"range":[3122,3124],"text":"[lat, lng, tileAttribution, tileUrl, zoom]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useRef } from \"react\";\r\nimport L from \"leaflet\";\r\n\r\nexport default function LeafletMapPicker({\r\n  center,\r\n  zoom = 16,\r\n  animateZoom = false,\r\n  onCenterChange,\r\n  onZoomChange,\r\n  onReady,\r\n  onError,\r\n  className = \"\",\r\n}) {\r\n  const containerRef = useRef(null);\r\n  const mapRef = useRef(null);\r\n  const onCenterChangeRef = useRef(onCenterChange);\r\n  const onZoomChangeRef = useRef(onZoomChange);\r\n  const onReadyRef = useRef(onReady);\r\n  const onErrorRef = useRef(onError);\r\n  const mapTilerKey = import.meta.env.VITE_MAPTILER_KEY;\r\n  const tileUrl = mapTilerKey\r\n    ? `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${mapTilerKey}`\r\n    : \"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\";\r\n  const tileAttribution = mapTilerKey\r\n    ? \"&copy; <a href=\\\"https://www.maptiler.com/copyright/\\\">MapTiler</a> &copy; <a href=\\\"https://www.openstreetmap.org/copyright\\\">OpenStreetMap</a>\"\r\n    : \"&copy; <a href=\\\"https://www.openstreetmap.org/copyright\\\">OpenStreetMap</a>\";\r\n  const lat = Number(center?.lat ?? 0);\r\n  const lng = Number(center?.lng ?? 0);\r\n\r\n  useEffect(() => {\r\n    onCenterChangeRef.current = onCenterChange;\r\n  }, [onCenterChange]);\r\n\r\n  useEffect(() => {\r\n    onZoomChangeRef.current = onZoomChange;\r\n  }, [onZoomChange]);\r\n\r\n  useEffect(() => {\r\n    onReadyRef.current = onReady;\r\n  }, [onReady]);\r\n\r\n  useEffect(() => {\r\n    onErrorRef.current = onError;\r\n  }, [onError]);\r\n\r\n  useEffect(() => {\r\n    if (!containerRef.current || mapRef.current) return;\r\n\r\n    let mapInstance;\r\n    let handleMoveEnd;\r\n    let handleZoomEnd;\r\n\r\n    try {\r\n      mapInstance = L.map(containerRef.current, {\r\n        zoomControl: false,\r\n        attributionControl: true,\r\n        doubleClickZoom: false,\r\n      });\r\n\r\n      if (mapInstance.attributionControl?.setPosition) {\r\n        mapInstance.attributionControl.setPosition(\"bottomleft\");\r\n      }\r\n\r\n      L.tileLayer(tileUrl, {\r\n        attribution: tileAttribution,\r\n        maxZoom: 20,\r\n      }).addTo(mapInstance);\r\n\r\n      if (mapInstance.attributionControl?.setPrefix) {\r\n        mapInstance.attributionControl.setPrefix(\"\");\r\n      }\r\n\r\n      mapInstance.setView([lat, lng], zoom, { animate: false });\r\n\r\n      handleMoveEnd = () => {\r\n        const nextCenter = mapInstance.getCenter();\r\n        onCenterChangeRef.current?.({\r\n          lat: nextCenter.lat,\r\n          lng: nextCenter.lng,\r\n        });\r\n      };\r\n      handleZoomEnd = () => {\r\n        const nextZoom = mapInstance.getZoom();\r\n        onZoomChangeRef.current?.(nextZoom);\r\n      };\r\n\r\n      mapInstance.on(\"moveend\", handleMoveEnd);\r\n      mapInstance.on(\"zoomend\", handleZoomEnd);\r\n      mapRef.current = mapInstance;\r\n      onReadyRef.current?.();\r\n    } catch (error) {\r\n      if (mapInstance) {\r\n        mapInstance.remove();\r\n      }\r\n      mapRef.current = null;\r\n      onErrorRef.current?.(error);\r\n      return undefined;\r\n    }\r\n\r\n    return () => {\r\n      mapInstance?.off(\"moveend\", handleMoveEnd);\r\n      mapInstance?.off(\"zoomend\", handleZoomEnd);\r\n      mapInstance?.remove();\r\n      mapRef.current = null;\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const map = mapRef.current;\r\n    if (!map || !Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n    const current = map.getCenter();\r\n    const currentZoom = map.getZoom();\r\n    const targetZoom = Number.isFinite(zoom) ? zoom : currentZoom;\r\n    const centerChanged =\r\n      Math.abs(current.lat - lat) >= 0.000001 ||\r\n      Math.abs(current.lng - lng) >= 0.000001;\r\n    const zoomChanged = Math.abs(currentZoom - targetZoom) >= 0.01;\r\n    if (!centerChanged && !zoomChanged) return;\r\n    map.setView([lat, lng], targetZoom, { animate: animateZoom });\r\n  }, [lat, lng, zoom, animateZoom]);\r\n\r\n  return (\r\n    <div className={`relative ${className}`}>\r\n      <div ref={containerRef} className=\"h-full w-full\" />\r\n      <div className=\"pointer-events-none absolute left-1/2 top-1/2 z-[1000] -translate-x-1/2 -translate-y-full\">\r\n        <PinIcon className=\"h-9 w-9 text-[#5E30A5]\" />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction PinIcon({ className = \"\" }) {\r\n  return (\r\n    <svg\r\n      viewBox=\"0 0 24 24\"\r\n      className={className}\r\n      fill=\"none\"\r\n      stroke=\"currentColor\"\r\n      strokeWidth=\"1.8\"\r\n      strokeLinecap=\"round\"\r\n      strokeLinejoin=\"round\"\r\n    >\r\n      <path\r\n        fillRule=\"evenodd\"\r\n        clipRule=\"evenodd\"\r\n        d=\"M12 22s7-6.5 7-12a7 7 0 1 0-14 0c0 5.5 7 12 7 12zm0-15a3 3 0 1 0 0 6a3 3 0 1 0 0-6z\"\r\n        fill=\"currentColor\"\r\n        stroke=\"currentColor\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\menus\\MenuFilters.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\menus\\MenuLateral.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalAbandonarRegistro.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalAccessMethods.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'setFingerprintEnabled' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":28,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":51,"suggestions":[{"messageId":"removeVar","data":{"varName":"setFingerprintEnabled"},"fix":{"range":[999,1022],"text":""},"desc":"Remove unused variable 'setFingerprintEnabled'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ArrowLeft, Fingerprint, Lock } from \"lucide-react\";\r\nimport { useCallback, useEffect, useRef, useState } from \"react\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport usePinSetup from \"../../hooks/usePinSetup\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport {\r\n  generatePinSalt,\r\n  getSecureStorageMode,\r\n  hashPin,\r\n  saveBiometricToken,\r\n  loadDeviceSecret,\r\n  saveDeviceSecret,\r\n  savePinHash,\r\n} from \"../../services/secureStorageService\";\r\n\r\nexport default function ModalAccessMethods({\r\n  initialView = \"select\",\r\n  initialFingerprintEnabled = false,\r\n  initialPinEnabled = false,\r\n  errorMessage = \"\",\r\n}) {\r\n  const { closeModal, openModal } = useModal();\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const setAccessMethods = useAppStore((s) => s.setAccessMethods);\r\n  const setUser = useAppStore((s) => s.setUser);\r\n  const [view, setView] = useState(initialView);\r\n  const [fingerprintEnabled, setFingerprintEnabled] = useState(\r\n    initialFingerprintEnabled,\r\n  );\r\n  const [pinEnabled, setPinEnabled] = useState(initialPinEnabled);\r\n  const [error, setError] = useState(errorMessage);\r\n  const [skipPrompt, setSkipPrompt] = useState(false);\r\n  const [webauthnAvailable, setWebauthnAvailable] = useState(true);\r\n  const skipKey = usuario?.id || usuario?.id_auth\r\n    ? `access_methods_prompt_skip_${usuario.id || usuario.id_auth}`\r\n    : null;\r\n  const prevViewRef = useRef(view);\r\n\r\n  useEffect(() => {\r\n    if (!skipKey) return;\r\n    const stored = window.localStorage.getItem(skipKey);\r\n    setSkipPrompt(stored === \"1\");\r\n  }, [skipKey]);\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    (async () => {\r\n      const status = await getSecureStorageMode();\r\n      if (!active) return;\r\n      setWebauthnAvailable(status.mode !== \"blocked\");\r\n    })();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, []);\r\n\r\n  const savePin = useCallback(async (pinValue) => {\r\n    const session = (await supabase.auth.getSession())?.data?.session;\r\n    const userId = session?.user?.id;\r\n    if (!userId) {\r\n      return { ok: false, error: \"No se pudo obtener sesion.\" };\r\n    }\r\n    if (!webauthnAvailable) {\r\n      return { ok: false, error: \"No disponible en este dispositivo.\" };\r\n    }\r\n    const existingSecret = await loadDeviceSecret(userId);\r\n    if (!existingSecret) {\r\n      const bytes = window.crypto.getRandomValues(new Uint8Array(32));\r\n      const token = btoa(String.fromCharCode(...bytes));\r\n      await saveDeviceSecret(userId, { token, createdAt: new Date().toISOString() });\r\n    }\r\n    const salt = generatePinSalt();\r\n    const hash = await hashPin(pinValue, salt);\r\n    const saved = await savePinHash(userId, {\r\n      salt,\r\n      hash,\r\n      iterations: 160000,\r\n      algo: \"PBKDF2-SHA256\",\r\n    });\r\n    if (!saved.ok) {\r\n      return { ok: false, error: \"No se pudo guardar el PIN.\" };\r\n    }\r\n    const { error: updErr } = await supabase\r\n      .from(\"usuarios\")\r\n      .update({ has_pin: true })\r\n      .eq(\"id_auth\", userId);\r\n    if (updErr) {\r\n      return { ok: false, error: updErr.message || \"No se pudo guardar el PIN.\" };\r\n    }\r\n    setAccessMethods({ pin: true });\r\n    if (usuario) {\r\n      setUser({ ...usuario, has_pin: true });\r\n    }\r\n    return { ok: true };\r\n  }, [webauthnAvailable, setAccessMethods, setUser, usuario]);\r\n\r\n  const pinSetup = usePinSetup({ onSavePin: savePin });\r\n\r\n  useEffect(() => {\r\n    if (prevViewRef.current !== view && view === \"pin\") {\r\n      pinSetup.focusHiddenInput();\r\n    }\r\n    prevViewRef.current = view;\r\n  }, [pinSetup, view]);\r\n\r\n  const handleFingerprint = async () => {\r\n    setError(\"\");\r\n    if (!webauthnAvailable) {\r\n      setError(\"No disponible en este dispositivo.\");\r\n      return;\r\n    }\r\n    const { data } = await supabase.auth.getUser();\r\n    const authUser = data?.user;\r\n    openModal(\"FingerprintPrompt\", {\r\n      userId: authUser?.id ?? null,\r\n      email: authUser?.email ?? null,\r\n      displayName: usuario?.nombre || usuario?.alias || \"Usuario\",\r\n      onConfirm: async (credentialId) => {\r\n        const session = (await supabase.auth.getSession())?.data?.session;\r\n        const userId = session?.user?.id;\r\n      if (!userId) {\r\n        openModal(\"AccessMethods\", {\r\n          initialView: \"select\",\r\n          initialPinEnabled: pinEnabled,\r\n          errorMessage: \"No se pudo obtener sesion.\",\r\n        });\r\n        return;\r\n      }\r\n      const existingSecret = await loadDeviceSecret(userId);\r\n      if (!existingSecret) {\r\n        const bytes = window.crypto.getRandomValues(new Uint8Array(32));\r\n        const token = btoa(String.fromCharCode(...bytes));\r\n        await saveDeviceSecret(userId, { token, createdAt: new Date().toISOString() });\r\n      }\r\n      if (credentialId) {\r\n        await saveBiometricToken(userId, {\r\n          credentialId,\r\n            createdAt: new Date().toISOString(),\r\n          });\r\n        }\r\n        const { error: updErr } = await supabase\r\n          .from(\"usuarios\")\r\n          .update({ has_biometrics: true })\r\n          .eq(\"id_auth\", userId);\r\n        if (updErr) {\r\n          openModal(\"AccessMethods\", {\r\n            initialView: \"select\",\r\n            initialPinEnabled: pinEnabled,\r\n            errorMessage: \"No se pudo anadir huella.\",\r\n          });\r\n          return;\r\n        }\r\n        setAccessMethods({ fingerprint: true });\r\n        if (usuario) {\r\n          setUser({ ...usuario, has_biometrics: true });\r\n        }\r\n        openModal(\"AccessMethods\", {\r\n          initialView: \"select\",\r\n          initialPinEnabled: pinEnabled,\r\n          initialFingerprintEnabled: true,\r\n        });\r\n      },\r\n      onError: (message) => {\r\n        openModal(\"AccessMethods\", {\r\n          initialView: \"select\",\r\n          initialPinEnabled: pinEnabled,\r\n          errorMessage: message || \"No se pudo anadir huella.\",\r\n        });\r\n      },\r\n      onCancel: () => {\r\n        openModal(\"AccessMethods\", {\r\n          initialView: \"select\",\r\n          initialPinEnabled: pinEnabled,\r\n          initialFingerprintEnabled: fingerprintEnabled,\r\n        });\r\n      },\r\n    });\r\n  };\r\n\r\n  const handlePinConfirm = async () => {\r\n    const result = await pinSetup.handlePinConfirm();\r\n    if (!result?.ok) return;\r\n    setPinEnabled(true);\r\n    pinSetup.resetPinForm();\r\n    setView(\"select\");\r\n  };\r\n\r\n  const cardBase =\r\n    \"flex h-20 flex-col items-center justify-center rounded-xl border text-xs font-semibold\";\r\n  const cardActive = \"border-[#5E30A5] bg-[#F4EDFF] text-[#2F1A55]\";\r\n  const cardInactive = \"border-gray-200 bg-white text-gray-700\";\r\n\r\n  if (view === \"pin\") {\r\n    const firstEmpty = pinSetup.pinSlots.findIndex((char) => !char);\r\n    const activeIndex = firstEmpty === -1 ? pinSetup.pinSlots.length - 1 : firstEmpty;\r\n    return (\r\n      <div className=\"w-full max-w-sm rounded-2xl bg-white p-6 text-gray-700 shadow-2xl\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => {\r\n              pinSetup.resetPinForm();\r\n              setView(\"select\");\r\n              setError(\"\");\r\n            }}\r\n            className=\"h-8 w-8 rounded-full border border-gray-200 text-gray-600 flex items-center justify-center\"\r\n            aria-label=\"Volver\"\r\n          >\r\n            <ArrowLeft size={16} />\r\n          </button>\r\n          <div className=\"text-sm font-semibold text-gray-900\">PIN</div>\r\n        </div>\r\n\r\n        <div className=\"mt-5 space-y-5\">\r\n          <p className=\"text-xs text-gray-500 text-center\">\r\n            {pinSetup.pinStep === \"confirm\"\r\n              ? \"Ingresar el PIN de nuevo.\"\r\n              : \"Ingresa un PIN.\"}\r\n          </p>\r\n          <div className=\"relative flex items-center justify-center gap-2\">\r\n            <input\r\n              ref={pinSetup.registerHiddenRef}\r\n              value={pinSetup.pinValue}\r\n              onChange={(event) => pinSetup.updatePinValueDirect(event.target.value)}\r\n              onFocus={() => pinSetup.setPinFocus(true)}\r\n              onBlur={() => pinSetup.setPinFocus(false)}\r\n              inputMode=\"numeric\"\r\n              autoComplete=\"one-time-code\"\r\n              className=\"absolute inset-0 h-full w-full opacity-0\"\r\n              aria-label=\"PIN\"\r\n            />\r\n            {pinSetup.pinSlots.map((char, index) => {\r\n              const displayChar = char\r\n                ? pinSetup.pinReveal[index]\r\n                  ? char\r\n                  : \"•\"\r\n                : \"\";\r\n              const isActive = pinSetup.pinFocused && index === activeIndex;\r\n              return (\r\n                <div\r\n                  key={`pin-modal-${index}`}\r\n                  className={`h-11 w-11 rounded-xl border bg-white text-center text-lg font-semibold text-[#5E30A5] flex items-center justify-center ${\r\n                    isActive\r\n                      ? \"border-[#5E30A5] ring-2 ring-[#5E30A5]/20\"\r\n                      : \"border-[#D8CFF2]\"\r\n                  }`}\r\n                >\r\n                  {displayChar || (isActive ? (\r\n                    <span className=\"pin-caret inline-flex h-5 w-px bg-[#5E30A5]\" />\r\n                  ) : null)}\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n          {pinSetup.pinStep === \"confirm\" ? (\r\n            <div className=\"text-xs pl-1 text-center\">\r\n              {(() => {\r\n                const color = pinSetup.pinComplete\r\n                  ? pinSetup.pinMatches\r\n                    ? \"text-emerald-600\"\r\n                    : \"text-red-500\"\r\n                  : \"text-slate-400\";\r\n                return (\r\n                  <span className={`inline-flex items-center gap-2 ${color}`}>\r\n                    {pinSetup.pinComplete ? (\r\n                      pinSetup.pinMatches ? (\r\n                        <svg\r\n                          viewBox=\"0 0 24 24\"\r\n                          className=\"h-3 w-3\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          strokeWidth=\"2\"\r\n                          strokeLinecap=\"round\"\r\n                          strokeLinejoin=\"round\"\r\n                        >\r\n                          <path d=\"M20 6L9 17l-5-5\" />\r\n                        </svg>\r\n                      ) : (\r\n                        <svg\r\n                          viewBox=\"0 0 24 24\"\r\n                          className=\"h-3 w-3\"\r\n                          fill=\"none\"\r\n                          stroke=\"currentColor\"\r\n                          strokeWidth=\"2\"\r\n                          strokeLinecap=\"round\"\r\n                          strokeLinejoin=\"round\"\r\n                        >\r\n                          <path d=\"M18 6L6 18\" />\r\n                          <path d=\"M6 6l12 12\" />\r\n                        </svg>\r\n                      )\r\n                    ) : (\r\n                      <svg\r\n                        viewBox=\"0 0 24 24\"\r\n                        className=\"h-3 w-3\"\r\n                        fill=\"none\"\r\n                        stroke=\"currentColor\"\r\n                        strokeWidth=\"2\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                      >\r\n                        <path d=\"M18 6L6 18\" />\r\n                        <path d=\"M6 6l12 12\" />\r\n                      </svg>\r\n                    )}\r\n                    El PIN debe coincidir\r\n                  </span>\r\n                );\r\n              })()}\r\n            </div>\r\n          ) : null}\r\n          <div className=\"mt-2 flex items-center justify-between text-sm font-semibold px-4\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={pinSetup.resetPinForm}\r\n              className=\"text-[#2F1A55]\"\r\n            >\r\n              Cancelar\r\n            </button>\r\n            {pinSetup.pinStep === \"confirm\" ? (\r\n              <button\r\n                type=\"button\"\r\n                onClick={handlePinConfirm}\r\n                disabled={!pinSetup.pinComplete || !pinSetup.pinMatches || pinSetup.saving}\r\n                className={\r\n                  pinSetup.pinComplete && pinSetup.pinMatches\r\n                    ? \"text-[#5E30A5]\"\r\n                    : \"text-slate-400\"\r\n                }\r\n              >\r\n                {pinSetup.saving ? \"Guardando...\" : \"Confirmar\"}\r\n              </button>\r\n            ) : (\r\n              <button\r\n                type=\"button\"\r\n                onClick={pinSetup.handlePinNext}\r\n                disabled={!pinSetup.pinComplete}\r\n                className={pinSetup.pinComplete ? \"text-[#5E30A5]\" : \"text-slate-400\"}\r\n              >\r\n                Siguiente\r\n              </button>\r\n            )}\r\n          </div>\r\n          {pinSetup.error && (\r\n            <div className=\"text-center text-xs text-red-500\">\r\n              {pinSetup.error}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"w-full max-w-sm rounded-2xl bg-white p-6 text-gray-700 shadow-2xl\">\r\n      <div className=\"text-center text-sm font-semibold text-gray-900\">\r\n        Simplifica el inicio de sesion anadiendo uno de los siguientes metodos de inicio\r\n      </div>\r\n      <div className=\"mt-5 grid grid-cols-2 gap-4\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleFingerprint}\r\n          disabled={!webauthnAvailable}\r\n          className={`${cardBase} ${fingerprintEnabled ? cardActive : cardInactive}`}\r\n        >\r\n          <Fingerprint className=\"mb-2 h-5 w-5 text-[#5E30A5]\" />\r\n          Huella\r\n        </button>\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => {\r\n            setError(\"\");\r\n            setView(\"pin\");\r\n          }}\r\n          disabled={!webauthnAvailable}\r\n          className={`${cardBase} ${pinEnabled ? cardActive : cardInactive}`}\r\n        >\r\n          <Lock className=\"mb-2 h-5 w-5 text-[#5E30A5]\" />\r\n          PIN\r\n        </button>\r\n      </div>\r\n      <div className=\"mt-6 flex items-center gap-2 text-xs text-gray-600\">\r\n        <input\r\n          type=\"checkbox\"\r\n          checked={skipPrompt}\r\n          onChange={(event) => {\r\n            const next = event.target.checked;\r\n            setSkipPrompt(next);\r\n            if (skipKey) {\r\n              if (next) {\r\n                window.localStorage.setItem(skipKey, \"1\");\r\n              } else {\r\n                window.localStorage.removeItem(skipKey);\r\n              }\r\n            }\r\n          }}\r\n          className=\"h-4 w-4 rounded border-gray-300 text-[#5E30A5] focus:ring-[#5E30A5]/30\"\r\n        />\r\n        <span>No volver a mostrar este mensaje.</span>\r\n      </div>\r\n      <div className=\"mt-3 text-[11px] text-gray-500 text-center\">\r\n        No uses biometria en dispositivos compartidos\r\n      </div>\r\n      {error && (\r\n        <div className=\"mt-3 text-center text-xs text-red-500\">{error}</div>\r\n      )}\r\n      {fingerprintEnabled || pinEnabled ? (\r\n        <button\r\n          type=\"button\"\r\n          onClick={closeModal}\r\n          className=\"mt-2 w-full rounded-lg bg-[#5E30A5] py-2.5 text-sm font-semibold text-white\"\r\n        >\r\n          Listo\r\n        </button>\r\n      ) : (\r\n        <button\r\n          type=\"button\"\r\n          onClick={closeModal}\r\n          className=\"mt-2 w-full text-sm font-semibold text-gray-500\"\r\n        >\r\n          Ahora no\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalAccountVerifySkip.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalBase.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'height' is assigned a value but never used.","line":5,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":60,"suggestions":[{"messageId":"removeVar","data":{"varName":"height"},"fix":{"range":[172,189],"text":""},"desc":"Remove unused variable 'height'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/modals/ModalBase.jsx\r\nimport React from \"react\";\r\nimport { useModal } from \"../../modals/useModal\";\r\n\r\nexport default function ModalBase({ children, title, height = \"auto\" }) {\r\n  const { closeModal } = useModal();\r\n\r\n  return (\r\n    <div\r\n      style={{\r\n        margin: \"0 auto\",\r\n        background: \"white\",\r\n        borderRadius: 20,\r\n        width: \"92vw\",\r\n        maxWidth: 420,\r\n        padding: 20,\r\n        maxHeight: \"85vh\",\r\n        overflowY: \"auto\",\r\n        boxShadow: \"0 8px 25px rgba(0,0,0,0.15)\",\r\n        position: \"relative\",\r\n      }}\r\n    >\r\n      {/* TITULO */}\r\n      <h2\r\n        style={{\r\n          fontSize: 20,\r\n          fontWeight: 700,\r\n          textAlign: \"center\",\r\n          color: \"#5E30A5\",\r\n          marginBottom: 16,\r\n        }}\r\n      >\r\n        {title}\r\n      </h2>\r\n\r\n      {/* BOTÓN CERRAR */}\r\n      <button\r\n        onClick={closeModal}\r\n        style={{\r\n          position: \"absolute\",\r\n          top: 12,\r\n          right: 12,\r\n          fontSize: 22,\r\n          color: \"#444\",\r\n          background: \"none\",\r\n          border: \"none\",\r\n          cursor: \"pointer\",\r\n        }}\r\n      >\r\n        ✕\r\n      </button>\r\n\r\n      {/* CONTENIDO */}\r\n      <div>{children}</div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalBeneficios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalCliente.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalCodigoNegocio.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalConfirmAction.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalConfirmarCambios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalCuentaExistente.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalEliminarCuenta.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalEmailReauth.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalEmailVerification.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalFingerprintPrompt.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalForcePasswordChange.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalGrupo.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalLocationDenied.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalLocationPermission.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalLocationUnavailable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalNotifications.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalPasswordReauth.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalPinVerify.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalSplashChoiceOverlay.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'setCodeValid' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":33,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"setCodeValid"},"fix":{"range":[1194,1208],"text":""},"desc":"Remove unused variable 'setCodeValid'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/modals/ModalSplashChoiceOverlay.jsx\r\nimport { useEffect, useState } from \"react\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport { CODE_RE } from \"../../utils/validators\";\r\n\r\nconst cards = [\r\n  { key: \"cliente\", title: \"Cliente\", desc: \"Gana y canjea promociones escaneando códigos.\" },\r\n  { key: \"negocio\", title: \"Negocio\", desc: \"Administra promos y canjes para tus sucursales.\" },\r\n];\r\n\r\n//const DEFAULT_CODES = [\"REF-123456\", \"REF-654321\"];\r\n\r\nconst isPartialFormat = (code) => {\r\n  if (!code) return true;\r\n  if (code === \"R\" || code === \"RE\" || code === \"REF\" || code === \"REF-\") return true;\r\n  if (!code.startsWith(\"REF-\")) return false;\r\n  const tail = code.slice(4);\r\n  return /^[0-9]{0,6}$/.test(tail);\r\n};\r\n\r\nexport default function ModalSplashChoiceOverlay({\r\n  authCreds,\r\n  onCliente,\r\n  onNegocio,\r\n  onBack = null,\r\n}) {\r\n  const [selected, setSelected] = useState(null);\r\n  const [mounted, setMounted] = useState(false);\r\n  const [error, setError] = useState(\"\");\r\n  const [showCodeModal, setShowCodeModal] = useState(false);\r\n  const [code, setCode] = useState(\"\");\r\n  const [codeFormatOk, setCodeFormatOk] = useState(true);\r\n  const [codeValid, setCodeValid] = useState(false);\r\n  const [persisting, setPersisting] = useState(false);\r\n  const { closeModal } = useModal();\r\n\r\n  useEffect(() => {\r\n    const id = requestAnimationFrame(() => setMounted(true));\r\n    return () => cancelAnimationFrame(id);\r\n  }, []);\r\n\r\n  const proceedNegocio = async (codeVal) => {\r\n    if (!onNegocio) return;\r\n    try {\r\n      setPersisting(true);\r\n      await onNegocio(codeVal);\r\n    } finally {\r\n      setPersisting(false);\r\n    }\r\n  };\r\n\r\n  const handleNext = () => {\r\n    if (!selected) return;\r\n    if (selected === \"cliente\") {\r\n      onCliente?.(authCreds);\r\n      return;\r\n    }\r\n    setError(\"\");\r\n    //setShowCodeModal(true); Ya no se solicita código de registro para negocio.\r\n  };\r\n\r\n  const handleCodeChange = (val) => {\r\n    const upper = val.toUpperCase();\r\n    setCode(upper);\r\n    const formatOk = isPartialFormat(upper);\r\n    setCodeFormatOk(formatOk);\r\n    // Validación de código de registro (comentada)\r\n    //const ok = formatOk && CODE_RE.test(upper) && DEFAULT_CODES.includes(upper);\r\n    //setCodeValid(ok);\r\n  };\r\n\r\n  const confirmCode = () => {\r\n    // Validación de código de registro (comentada)\r\n    //if (!codeValid || persisting) return;\r\n    proceedNegocio(code);\r\n    setShowCodeModal(false);\r\n  };\r\n\r\n  return (\r\n    <div className=\"w-screen h-screen bg-[#5E30A5] text-white flex items-center justify-center p-6 relative\">\r\n      <button\r\n        onClick={() => {\r\n          if (onBack) onBack();\r\n          else closeModal();\r\n        }}\r\n        className=\"absolute left-8 w-9 h-25 rounded-xl bg-[#5624a1ff] text-white shadow-lg flex items-center justify-center active:scale-95 transition\"\r\n        style={{ top: \"42%\", transform: \"translate(-50%, 0)\", zIndex: 20 }}\r\n        aria-label=\"Volver\"\r\n      >\r\n        <svg width=\"25\" height=\"25\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n          <path d=\"M15 5L8 12L15 19\" stroke=\"white\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\r\n        </svg>\r\n      </button>\r\n      <div\r\n        className={`w-full max-w-xl bg-white/5 backdrop-blur-xl rounded-3xl border border-white/10 shadow-2xl transition-all duration-500 ${\r\n          mounted ? \"opacity-100 translate-y-0\" : \"opacity-0 translate-y-4\"\r\n        }`}\r\n      >\r\n        <div className=\"p-8 space-y-6\">\r\n          {error && <div className=\"text-center text-sm text-red-300\">{error}</div>}\r\n          <div className=\"space-y-1 text-center\">\r\n            <p className=\"text-sm uppercase tracking-[0.25em] text-white/60\">Tipo de cuenta</p>\r\n            <h1 className=\"text-2xl font-semibold text-white\">¿Cómo quieres continuar?</h1>\r\n            <p className=\"text-sm text-white/60\">Elige tu rol para entrar con la experiencia adecuada.</p>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            {cards.map((card, idx) => {\r\n              const isActive = selected === card.key;\r\n              return (\r\n                <button\r\n                  key={card.key}\r\n                  onClick={() => setSelected(card.key)}\r\n                  className={`text-left rounded-2xl border transition-all duration-300 p-5 h-full ${\r\n                    isActive\r\n                      ? \"border-[#FFC21C]/80 bg-white/10 shadow-lg shadow-[#ffc21c1f]\"\r\n                      : \"border-white/10 bg-white/0 hover:bg-white/5\"\r\n                  }`}\r\n                  style={{\r\n                    animation: mounted ? `fadeIn 0.35s ease ${idx * 0.05}s both` : \"none\",\r\n                  }}\r\n                >\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                      <h2 className=\"text-lg font-semibold text-white\">{card.title}</h2>\r\n                      <p className=\"text-sm text-white/60 mt-1\">{card.desc}</p>\r\n                    </div>\r\n                    <span\r\n                      className={`w-3.5 h-3.5 rounded-full border ${\r\n                        isActive ? \"bg-[#FFC21C] border-[#FFC21C]\" : \"border-white/40\"\r\n                      }`}\r\n                    />\r\n                  </div>\r\n                </button>\r\n              );\r\n            })}\r\n          </div>\r\n\r\n          <div className=\"pt-2\">\r\n            <button\r\n              onClick={handleNext}\r\n              disabled={!selected || persisting}\r\n              className={`w-full py-3 rounded-xl font-semibold transition-all ${\r\n                selected && !persisting\r\n                  ? \"bg-[#FFC21C] text-[#0F172A] shadow-lg shadow-[#ffc21c33] active:scale-[0.99]\"\r\n                  : \"bg-white/10 text-white/60 cursor-not-allowed\"\r\n              }`}\r\n            >\r\n              {persisting ? \"Guardando...\" : \"Registrarse\"}\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"text-center text-xs text-white/50\">\r\n            Pantalla de bienvenida. Selecciona tu rol y continúa con la experiencia adecuada.\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {showCodeModal && (\r\n        <div\r\n          className=\"absolute inset-0 flex items-center justify-center p-6 bg-black/20 backdrop-blur-[2px]\"\r\n          style={{ zIndex: 30 }}\r\n        >\r\n          <div className=\"w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 text-[#0F172A] relative\">\r\n            <h3 className=\"text-center text-xl font-bold text-[#5E30A5] mb-2\">Código de registro</h3>\r\n            <p className=\"text-sm text-gray-600 mb-3 text-center\">Solo necesario para negocios</p>\r\n            <input\r\n              autoFocus\r\n              className={`w-full border rounded-lg px-3 py-2 text-sm uppercase tracking-wide transition-colors ${\r\n                codeFormatOk\r\n                  ? \"border-gray-400 text-gray-900 focus:border-[#5E30A5] focus:outline-none focus:ring-2 focus:ring-[#5E30A5]/40\"\r\n                  : \"border-red-500 text-red-600 focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-200\"\r\n              }`}\r\n              placeholder=\"REF-435526\"\r\n              value={code}\r\n              onChange={(e) => handleCodeChange(e.target.value)}\r\n            />\r\n            <a\r\n              href={\r\n                \"https://wa.me/593000000000?text=\" +\r\n                encodeURIComponent(\"Hola! Deseo recibir un codigo de registro para registrar mi negocio.\")\r\n              }\r\n              target=\"_blank\"\r\n              rel=\"noreferrer\"\r\n              className=\"text-xs text-[#5E30A5] underline block mt-2\"\r\n            >\r\n              Solicitar código para negocio\r\n            </a>\r\n\r\n            <div className=\"flex gap-3 mt-4\">\r\n              <button\r\n                onClick={() => setShowCodeModal(false)}\r\n                className=\"flex-1 py-2.5 rounded-lg border border-gray-300 text-gray-600 font-semibold\"\r\n              >\r\n                Volver\r\n              </button>\r\n              <button\r\n                onClick={confirmCode}\r\n                disabled={!codeValid || persisting}\r\n                className={`flex-1 py-2.5 rounded-lg font-semibold ${\r\n                  codeValid && !persisting ? \"bg-[#5E30A5] text-white shadow\" : \"bg-gray-200 text-gray-500 cursor-not-allowed\"\r\n                }`}\r\n              >\r\n                {persisting ? \"Guardando...\" : \"Continuar\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalSplashEmailConfirmation.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalSupportQueue.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'onCancelQueue' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"onCancelQueue"},"fix":{"range":[172,186],"text":""},"desc":"Remove unused variable 'onCancelQueue'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { Loader2, X } from \"lucide-react\";\r\nimport { useModal } from \"../../modals/useModal\";\r\n\r\nexport default function ModalSupportQueue({\r\n  onCancelQueue,\r\n  onConfirmUnderstand,\r\n  onRequestCancel,\r\n}) {\r\n  const { closeModal } = useModal();\r\n\r\n  return (\r\n    <div className=\"w-full max-w-sm rounded-2xl bg-white p-6 text-gray-700 shadow-2xl\">\r\n      <div className=\"flex items-start justify-between gap-3\">\r\n        <div className=\"text-sm font-semibold text-gray-900\">\r\n          Buscando asesor disponible\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => {\r\n            closeModal();\r\n            onConfirmUnderstand?.();\r\n          }}\r\n          className=\"text-gray-400 hover:text-gray-600\"\r\n          aria-label=\"Cerrar\"\r\n        >\r\n          <X size={16} />\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"mt-4 flex items-center gap-3 rounded-xl border border-gray-100 bg-gray-50 px-3 py-2 text-xs text-gray-600\">\r\n        <Loader2 className=\"animate-spin text-[#5E30A5]\" size={16} />\r\n        Estamos buscando un asesor disponible.\r\n      </div>\r\n\r\n      <p className=\"mt-4 text-xs text-gray-500\">\r\n        Puede tomar varios minutos. Puedes cerrar este mensaje y te\r\n        notificaremos cuando haya un asesor disponible.\r\n      </p>\r\n\r\n      <div className=\"mt-5 flex gap-3\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => {\r\n            closeModal();\r\n            onConfirmUnderstand?.();\r\n          }}\r\n          className=\"flex-1 rounded-lg border border-gray-200 py-2 text-sm font-semibold text-gray-600\"\r\n        >\r\n          Entiendo\r\n        </button>\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => {\r\n            closeModal();\r\n            onRequestCancel?.();\r\n          }}\r\n          className=\"flex-1 rounded-lg bg-[#5E30A5] py-2 text-sm font-semibold text-white\"\r\n        >\r\n          Cancelar\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalSupportQueueCancel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalTier.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalTimePicker.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalTwoFADisable.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalTwoFAEnroll.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'prepareEnrollment'. Either include it or remove the dependency array.","line":126,"column":6,"nodeType":"ArrayExpression","endLine":126,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [prepareEnrollment]","fix":{"range":[3754,3756],"text":"[prepareEnrollment]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState } from \"react\";\r\nimport { QrCode, ShieldCheck, X } from \"lucide-react\";\r\nimport QRCode from \"react-qr-code\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport {\r\n  challengeAndVerifyTotp,\r\n  enrollTotp,\r\n  listMfaFactors,\r\n  syncTotpFlags,\r\n  unenrollFactor,\r\n} from \"../../services/mfaService\";\r\n\r\nconst FRIENDLY_NAME = \"App autenticadora\";\r\n\r\nconst isActiveStatus = (status) =>\r\n  [\"verified\", \"active\"].includes(String(status || \"\").toLowerCase());\r\n\r\nexport default function ModalTwoFAEnroll({ onComplete }) {\r\n  const { closeModal } = useModal();\r\n  const [loading, setLoading] = useState(true);\r\n  const [enrollError, setEnrollError] = useState(\"\");\r\n  const [mode, setMode] = useState(\"enroll\");\r\n  const [factorId, setFactorId] = useState(null);\r\n  const [qrCode, setQrCode] = useState(\"\");\r\n  const [qrUri, setQrUri] = useState(\"\");\r\n  const [secret, setSecret] = useState(\"\");\r\n  const [code, setCode] = useState(\"\");\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const [verifyError, setVerifyError] = useState(\"\");\r\n\r\n  const canSubmit =\r\n    code.trim().length >= 6 && !submitting && !loading && Boolean(factorId);\r\n\r\n  const resetEnrollState = () => {\r\n    setFactorId(null);\r\n    setQrCode(\"\");\r\n    setQrUri(\"\");\r\n    setSecret(\"\");\r\n  };\r\n\r\n  const applyEnrollPayload = (data) => {\r\n    const totp = data?.totp || {};\r\n    setFactorId(data?.id || null);\r\n    setQrCode(totp.qr_code || \"\");\r\n    setQrUri(totp.uri || \"\");\r\n    setSecret(totp.secret || \"\");\r\n  };\r\n\r\n  const startEnroll = async () => {\r\n    const result = await enrollTotp({ friendlyName: FRIENDLY_NAME });\r\n    if (!result.ok) {\r\n      return result;\r\n    }\r\n    applyEnrollPayload(result.data);\r\n    return { ok: true };\r\n  };\r\n\r\n  const prepareEnrollment = async () => {\r\n    setLoading(true);\r\n    setEnrollError(\"\");\r\n    setMode(\"enroll\");\r\n    resetEnrollState();\r\n\r\n    const list = await listMfaFactors();\r\n    if (list.ok) {\r\n      const factors = list.data?.totp || [];\r\n      const active = factors.find((factor) => isActiveStatus(factor?.status));\r\n      if (active) {\r\n        setMode(\"existing\");\r\n        setFactorId(active.id);\r\n        setLoading(false);\r\n        return;\r\n      }\r\n      const pending = factors.find(\r\n        (factor) => String(factor?.status || \"\").toLowerCase() === \"unverified\"\r\n      );\r\n      if (pending) {\r\n        await unenrollFactor(pending.id);\r\n      }\r\n    }\r\n\r\n    const result = await startEnroll();\r\n    if (!result.ok) {\r\n      if (result.errorCode === \"mfa_factor_name_conflict\") {\r\n        const retryList = await listMfaFactors();\r\n        const factors = retryList.ok ? retryList.data?.totp || [] : [];\r\n        const active = factors.find((factor) => isActiveStatus(factor?.status));\r\n        if (active) {\r\n          setMode(\"existing\");\r\n          setFactorId(active.id);\r\n          setLoading(false);\r\n          return;\r\n        }\r\n        const pending = factors.find(\r\n          (factor) => String(factor?.status || \"\").toLowerCase() === \"unverified\"\r\n        );\r\n        if (pending) {\r\n          await unenrollFactor(pending.id);\r\n          const retry = await startEnroll();\r\n          if (retry.ok) {\r\n            setLoading(false);\r\n            return;\r\n          }\r\n          setEnrollError(retry.error || \"No se pudo iniciar MFA\");\r\n          setLoading(false);\r\n          return;\r\n        }\r\n      }\r\n      setEnrollError(result.error || \"No se pudo iniciar MFA\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    setLoading(false);\r\n  };\r\n\r\n  useEffect(() => {\r\n    let active = true;\r\n    (async () => {\r\n      await prepareEnrollment();\r\n      if (!active) return;\r\n    })();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, []);\r\n\r\n  const helperText = useMemo(() => {\r\n    if (loading) return \"Generando tu codigo...\";\r\n    if (enrollError) return \"No se pudo iniciar la configuracion.\";\r\n    if (mode === \"existing\") {\r\n      return \"Ya tienes 2FA activo. Ingresa el codigo de tu app.\";\r\n    }\r\n    return \"Escanea el QR con tu app autenticadora y escribe el codigo.\";\r\n  }, [enrollError, loading, mode]);\r\n\r\n  const handleVerify = async () => {\r\n    if (!factorId) {\r\n      setVerifyError(\"No se pudo iniciar la verificacion.\");\r\n      return;\r\n    }\r\n    setVerifyError(\"\");\r\n    setSubmitting(true);\r\n    const result = await challengeAndVerifyTotp({\r\n      factorId,\r\n      code: code.trim(),\r\n    });\r\n    if (!result.ok) {\r\n      setVerifyError(result.error || \"Codigo invalido\");\r\n      setSubmitting(false);\r\n      return;\r\n    }\r\n    await syncTotpFlags({ enabled: true });\r\n    setSubmitting(false);\r\n    closeModal();\r\n    onComplete?.();\r\n  };\r\n\r\n  const renderQr = () => {\r\n    if (qrCode) {\r\n      const trimmed = qrCode.trim();\r\n      const isSvg = trimmed.startsWith(\"<svg\");\r\n      if (isSvg) {\r\n        return (\r\n          <div\r\n            className=\"mx-auto h-40 w-40\"\r\n            dangerouslySetInnerHTML={{ __html: trimmed }}\r\n          />\r\n        );\r\n      }\r\n      return (\r\n        <img\r\n          src={qrCode}\r\n          alt=\"Codigo QR para app autenticadora\"\r\n          className=\"mx-auto h-40 w-40\"\r\n          loading=\"lazy\"\r\n        />\r\n      );\r\n    }\r\n    if (qrUri) {\r\n      return (\r\n        <div className=\"flex items-center justify-center\">\r\n          <QRCode value={qrUri} size={160} />\r\n        </div>\r\n      );\r\n    }\r\n    return (\r\n      <div className=\"text-xs text-gray-500\">No se pudo cargar el QR.</div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div className=\"w-full max-w-sm rounded-2xl bg-white p-6 text-gray-700 shadow-2xl\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-gray-900\">\r\n          <ShieldCheck size={16} />\r\n          Activar 2FA\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          onClick={closeModal}\r\n          className=\"text-gray-400 hover:text-gray-600\"\r\n          aria-label=\"Cerrar\"\r\n        >\r\n          <X size={16} />\r\n        </button>\r\n      </div>\r\n\r\n      <p className=\"mt-3 text-xs text-gray-500\">{helperText}</p>\r\n\r\n      {mode === \"enroll\" ? (\r\n        <div className=\"mt-4 rounded-xl border border-gray-200 bg-gray-50 p-4\">\r\n          {loading ? (\r\n            <div className=\"flex items-center justify-center gap-2 text-xs text-gray-400\">\r\n              <QrCode size={16} />\r\n              Generando QR...\r\n            </div>\r\n          ) : enrollError ? (\r\n            <div className=\"text-xs text-red-500\">\r\n              {enrollError}\r\n              <button\r\n                type=\"button\"\r\n                onClick={prepareEnrollment}\r\n                className=\"ml-2 text-xs font-semibold text-[#5E30A5]\"\r\n              >\r\n                Reintentar\r\n              </button>\r\n            </div>\r\n          ) : (\r\n            renderQr()\r\n          )}\r\n        </div>\r\n      ) : null}\r\n\r\n      {mode === \"enroll\" && secret ? (\r\n        <div className=\"mt-3 rounded-lg border border-gray-200 bg-white px-3 py-2 text-[11px] text-gray-500\">\r\n          Clave manual: <span className=\"font-semibold text-gray-700\">{secret}</span>\r\n        </div>\r\n      ) : null}\r\n\r\n      <div className=\"mt-4 space-y-2\">\r\n        <label className=\"block text-xs text-gray-500 ml-1\">\r\n          Codigo de 6 digitos\r\n        </label>\r\n        <input\r\n          type=\"text\"\r\n          inputMode=\"numeric\"\r\n          autoComplete=\"one-time-code\"\r\n          value={code}\r\n          onChange={(event) => setCode(event.target.value)}\r\n          className=\"w-full rounded-lg border border-gray-200 px-3 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#5E30A5]/30\"\r\n          placeholder=\"123456\"\r\n        />\r\n        {verifyError ? (\r\n          <div className=\"text-xs text-red-500\">{verifyError}</div>\r\n        ) : null}\r\n      </div>\r\n\r\n      <div className=\"mt-5 flex gap-3\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={closeModal}\r\n          className=\"flex-1 rounded-lg border border-gray-200 py-2 text-sm font-semibold text-gray-600\"\r\n        >\r\n          Cancelar\r\n        </button>\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleVerify}\r\n          disabled={!canSubmit}\r\n          className=\"flex-1 rounded-lg bg-[#5E30A5] py-2 text-sm font-semibold text-white disabled:opacity-60\"\r\n        >\r\n          {submitting ? \"Verificando...\" : \"Confirmar\"}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\modals\\ModalTwoFAVerify.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\search\\SearchBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\search\\SearchContainer.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\search\\SearchEmpty.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\search\\SearchHeader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\search\\SearchIdle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\search\\SearchResults.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\search\\useSearchMode.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\sections\\PromoSection.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'CardComponent' is assigned a value but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"CardComponent"},"fix":{"range":[351,389],"text":""},"desc":"Remove unused variable 'CardComponent'."}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useEffect\" is called conditionally. React Hooks must be called in the exact same order in every component render. Did you accidentally call a React Hook after an early return?","line":60,"column":3,"nodeType":"Identifier","endLine":60,"endColumn":12}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useRef, useState } from \"react\";\r\nimport PromoCardCercanas from \"../cards/PromoCardCercanas\";\r\nimport SectionTitle from \"./SectionTitle\";\r\nimport { useCarousel } from \"../../hooks/useCarousel\";\r\nimport { useAutoCarousel } from \"../../hooks/useAutoCarousel\";\r\n\r\nexport default function PromoSection({\r\n  title,\r\n  promos,\r\n  ratings,\r\n  CardComponent = PromoCardCercanas,\r\n  autoScroll = false,\r\n  autoScrollInterval = 5000,\r\n  loop = true,\r\n  loopPeek = 0,\r\n  gapClassName = \"gap-2\",\r\n}) {\r\n  const ref = useRef(null);\r\n  const [autoActive, setAutoActive] = useState(true);\r\n  const resumeTimerRef = useRef(null);\r\n  const resumeDelayMs = 4000;\r\n  const loopEnabled = loop && promos?.length > 1;\r\n  const { canLeft, canRight, scroll, scrollToStart } = useCarousel(ref, {\r\n    loop: loopEnabled,\r\n    itemsCount: promos?.length || 0,\r\n    loopPeek,\r\n    onInteract: () => {\r\n      if (!autoScroll) return;\r\n      setAutoActive(false);\r\n      if (resumeTimerRef.current) {\r\n        clearTimeout(resumeTimerRef.current);\r\n      }\r\n      resumeTimerRef.current = setTimeout(() => {\r\n        setAutoActive(true);\r\n        scroll(\"right\");\r\n      }, resumeDelayMs);\r\n    },\r\n  });\r\n\r\n  useAutoCarousel({\r\n    enabled: autoScroll && promos?.length > 1 && autoActive,\r\n    intervalMs: autoScrollInterval,\r\n    onTick: () => {\r\n      if (loopEnabled) {\r\n        scroll(\"right\");\r\n        return;\r\n      }\r\n      if (canRight) {\r\n        scroll(\"right\");\r\n        return;\r\n      }\r\n      if (canLeft) {\r\n        scrollToStart();\r\n      }\r\n    },\r\n  });\r\n\r\n  if (!promos || promos.length === 0) return null;\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (resumeTimerRef.current) {\r\n        clearTimeout(resumeTimerRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  const renderItems = loopEnabled\r\n    ? [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].flatMap((loopIndex) =>\r\n        promos.map((promo, index) => ({\r\n          promo,\r\n          key: `${promo.id}-${loopIndex}`,\r\n          loopIndex,\r\n          index,\r\n        }))\r\n      )\r\n    : promos.map((promo, index) => ({\r\n        promo,\r\n        key: promo.id,\r\n        loopIndex: 0,\r\n        index,\r\n      }));\r\n\r\n  const snapProps = {\r\n    style: { scrollSnapAlign: \"center\", scrollSnapStop: \"always\" },\r\n  };\r\n  const snapType = loopEnabled ? \"none\" : \"x mandatory\";\r\n\r\n  return (\r\n    <div className=\"mb-8 relative\">\r\n      <div className=\"flex items-center justify-between px-2\">\r\n        <SectionTitle>{title}</SectionTitle>\r\n        <div className=\"hidden md:flex items-center gap-2\" />\r\n      </div>\r\n\r\n\r\n      <div\r\n        ref={ref}\r\n        className={`flex overflow-x-auto ${gapClassName} no-scrollbar scroll-smooth px-2 pt-2`}\r\n        style={{ scrollSnapType: snapType }}\r\n      >\r\n        {renderItems.map(({ promo, key, loopIndex, index }) => (\r\n          <CardComponent\r\n            key={key}\r\n            promo={promo}\r\n            rating={ratings?.[promo.id]}\r\n            wrapperProps={{\r\n              ...snapProps,\r\n              \"data-carousel-item\": true,\r\n              \"data-carousel-index\": index,\r\n              \"data-carousel-dup\": loopIndex,\r\n            }}\r\n          />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\sections\\SectionTitle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\Badge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\ConfirmDialog.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\LoaderOverlay.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\SearchBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\Spinner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\Table.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\skeleton\\SkeletonAvatar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\skeleton\\SkeletonBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\skeleton\\SkeletonBlock.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\skeleton\\SkeletonCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\skeleton\\SkeletonList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\components\\ui\\skeleton\\SkeletonText.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\constants\\branding.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\errors\\ErrorRuntimeBridge.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\useAppLogger.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\useAutoCarousel.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\useBootstrapAuth.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\useCarousel.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'loopPeek' is assigned a value but never used.","line":9,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":13,"suggestions":[{"messageId":"removeVar","data":{"varName":"loopPeek"},"fix":{"range":[195,214],"text":""},"desc":"Remove unused variable 'loopPeek'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has an unnecessary dependency: 'getLoopCenterDup'. Either exclude it or remove the dependency array.","line":223,"column":6,"nodeType":"ArrayExpression","endLine":231,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [clampScrollLeft, getItems, getLoopGeometry, idleThresholdMs, jumpTo, ref]","fix":{"range":[7171,7304],"text":"[clampScrollLeft, getItems, getLoopGeometry, idleThresholdMs, jumpTo, ref]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useLayoutEffect has a missing dependency: 'ref'. Either include it or remove the dependency array.","line":285,"column":6,"nodeType":"ArrayExpression","endLine":285,"endColumn":58,"suggestions":[{"desc":"Update the dependencies array to be: [centerInitialItem, itemsCount, loopEnabled, ref, update]","fix":{"range":[8857,8909],"text":"[centerInitialItem, itemsCount, loopEnabled, ref, update]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/hooks/useCarousel.js\r\nimport { useCallback, useEffect, useLayoutEffect, useRef, useState } from \"react\";\r\n\r\nexport function useCarousel(\r\n  ref,\r\n  {\r\n    loop = false,\r\n    itemsCount = 0,\r\n    loopPeek = 0,\r\n    onInteract,\r\n    snap = true,\r\n    snapDelay = 140,\r\n    itemSelector = \"[data-carousel-item]\",\r\n  } = {}\r\n) {\r\n  const [canLeft, setCanLeft] = useState(false);\r\n  const [canRight, setCanRight] = useState(false);\r\n  const readyRef = useRef(false);\r\n  const jumpingRef = useRef(false);\r\n  const snappingRef = useRef(false);\r\n  const snapTimerRef = useRef(null);\r\n  const reanchorTimerRef = useRef(null);\r\n  const finalSnapTimerRef = useRef(null);\r\n  const skipSnapUntilRef = useRef(0);\r\n  const lastScrollLeftRef = useRef(0);\r\n  const lastScrollTimeRef = useRef(0);\r\n  const velocityRef = useRef(0);\r\n  const interactingRef = useRef(false);\r\n  const interactionTimerRef = useRef(null);\r\n  const idleThresholdMs = 140;\r\n  const stableIdleMs = 220;\r\n  const loopEnabled = loop && itemsCount > 1;\r\n\r\n  const getItems = useCallback(\r\n    (el) => Array.from(el.querySelectorAll(itemSelector)),\r\n    [itemSelector]\r\n  );\r\n\r\n  const jumpTo = useCallback((el, nextLeft, { suppressSnap = false } = {}) => {\r\n    if (!el || jumpingRef.current) return;\r\n    jumpingRef.current = true;\r\n    const prevBehavior = el.style.scrollBehavior;\r\n    const prevSnapType = el.style.scrollSnapType;\r\n    if (suppressSnap) {\r\n      el.style.scrollSnapType = \"none\";\r\n    }\r\n    el.style.scrollBehavior = \"auto\";\r\n    el.scrollLeft = nextLeft;\r\n    requestAnimationFrame(() => {\r\n      el.style.scrollBehavior = prevBehavior || \"\";\r\n      if (suppressSnap) {\r\n        el.style.scrollSnapType = prevSnapType || \"\";\r\n      }\r\n      jumpingRef.current = false;\r\n    });\r\n  }, []);\r\n\r\n  const clampScrollLeft = useCallback((el, left) => {\r\n    const max = Math.max(0, el.scrollWidth - el.clientWidth);\r\n    return Math.max(0, Math.min(left, max));\r\n  }, []);\r\n\r\n  const getClosestItem = useCallback(\r\n    (el, items = getItems(el), preferDup = null) => {\r\n      if (!items.length) return null;\r\n      let candidates = items;\r\n      if (preferDup !== null) {\r\n        const filtered = items.filter(\r\n          (item) => item.dataset.carouselDup === preferDup\r\n        );\r\n        if (filtered.length) candidates = filtered;\r\n      }\r\n      const center = el.scrollLeft + el.clientWidth / 2;\r\n      let closest = { item: candidates[0], index: 0, distance: Infinity };\r\n      candidates.forEach((item, index) => {\r\n        const itemCenter = item.offsetLeft + item.offsetWidth / 2;\r\n        const distance = Math.abs(itemCenter - center);\r\n        if (distance < closest.distance) {\r\n          closest = { item, index, distance };\r\n        }\r\n      });\r\n      return closest;\r\n    },\r\n    [getItems]\r\n  );\r\n\r\n  const getLoopCenterDup = useCallback((items) => {\r\n    const dupValues = Array.from(\r\n      new Set(\r\n        items\r\n          .map((item) => item.dataset.carouselDup)\r\n          .filter((dup) => dup != null)\r\n      )\r\n    );\r\n    if (!dupValues.length) return null;\r\n    dupValues.sort((a, b) => Number(a) - Number(b));\r\n    return dupValues[Math.floor(dupValues.length / 2)];\r\n  }, []);\r\n\r\n  const getLoopGeometry = useCallback((items) => {\r\n    const dupValues = Array.from(\r\n      new Set(\r\n        items\r\n          .map((item) => item.dataset.carouselDup)\r\n          .filter((dup) => dup != null)\r\n      )\r\n    );\r\n    if (dupValues.length < 2) return null;\r\n    dupValues.sort((a, b) => Number(a) - Number(b));\r\n    const centerIndex = Math.floor(dupValues.length / 2);\r\n    const centerDup = dupValues[centerIndex];\r\n    const nextDup = dupValues[centerIndex + 1];\r\n    if (!centerDup || !nextDup) return null;\r\n    const findFirst = (dup) =>\r\n      items.find(\r\n        (item) =>\r\n          item.dataset.carouselDup === dup &&\r\n          item.dataset.carouselIndex === \"0\"\r\n      );\r\n    const centerFirst = findFirst(centerDup);\r\n    const nextFirst = findFirst(nextDup);\r\n    if (!centerFirst || !nextFirst) return null;\r\n    const span = nextFirst.offsetLeft - centerFirst.offsetLeft;\r\n    if (!span) return null;\r\n    return {\r\n      centerDup,\r\n      centerStart: centerFirst.offsetLeft,\r\n      span,\r\n    };\r\n  }, []);\r\n\r\n  const centerItem = useCallback(\r\n    (el, item, behavior = \"smooth\") => {\r\n      if (!el || !item) return;\r\n      const target =\r\n        item.offsetLeft + item.offsetWidth / 2 - el.clientWidth / 2;\r\n      const nextLeft = clampScrollLeft(el, target);\r\n      if (behavior === \"auto\") {\r\n        jumpTo(el, nextLeft);\r\n        return;\r\n      }\r\n      el.scrollTo({ left: nextLeft, behavior });\r\n    },\r\n    [clampScrollLeft, jumpTo]\r\n  );\r\n\r\n  const centerInitialItem = useCallback(\r\n    (behavior = \"auto\") => {\r\n      const el = ref.current;\r\n      if (!el) return;\r\n      const items = getItems(el);\r\n      if (!items.length) return;\r\n      let target = items[0];\r\n      if (loopEnabled) {\r\n        const centerDup = getLoopCenterDup(items);\r\n        const candidate = items.find(\r\n          (item) =>\r\n            item.dataset.carouselDup === centerDup &&\r\n            item.dataset.carouselIndex === \"0\"\r\n        );\r\n        if (candidate) target = candidate;\r\n      }\r\n      centerItem(el, target, behavior);\r\n    },\r\n    [centerItem, getItems, getLoopCenterDup, loopEnabled, ref]\r\n  );\r\n\r\n  const update = useCallback(() => {\r\n    const el = ref.current;\r\n    if (!el) return;\r\n    const items = getItems(el);\r\n\r\n    if (!items.length) {\r\n      setCanLeft(false);\r\n      setCanRight(false);\r\n      return;\r\n    }\r\n\r\n    const closestAny = getClosestItem(el, items, null);\r\n    if (!closestAny) {\r\n      setCanLeft(false);\r\n      setCanRight(false);\r\n      return;\r\n    }\r\n\r\n    if (loopEnabled) {\r\n      const canScroll = el.scrollWidth - el.clientWidth > 2;\r\n      setCanLeft(canScroll);\r\n      setCanRight(canScroll);\r\n      return;\r\n    }\r\n\r\n    setCanLeft(closestAny.index > 0);\r\n    setCanRight(closestAny.index < items.length - 1);\r\n  }, [getClosestItem, getItems, loopEnabled, ref]);\r\n\r\n  const reanchorIfNeeded = useCallback(() => {\r\n    const el = ref.current;\r\n    if (!el) return true;\r\n    if (!readyRef.current || jumpingRef.current) return false;\r\n    if (interactingRef.current) return false;\r\n    const idleFor = performance.now() - lastScrollTimeRef.current;\r\n    if (idleFor < idleThresholdMs) return false;\r\n    const items = getItems(el);\r\n    if (!items.length) return true;\r\n    const geometry = getLoopGeometry(items);\r\n    if (!geometry) return true;\r\n    if (snapTimerRef.current) {\r\n      clearTimeout(snapTimerRef.current);\r\n    }\r\n    skipSnapUntilRef.current = performance.now() + 80;\r\n    const viewportCenter = el.scrollLeft + el.clientWidth / 2;\r\n    const offsetFromCenter = viewportCenter - geometry.centerStart;\r\n    const shiftCopies = Math.floor(offsetFromCenter / geometry.span);\r\n    if (shiftCopies === 0) return true;\r\n    const shift = -shiftCopies * geometry.span;\r\n    const nextLeft = clampScrollLeft(el, el.scrollLeft + shift);\r\n    if (Math.abs(el.scrollLeft - nextLeft) < 0.5) {\r\n      return true;\r\n    }\r\n    jumpTo(el, nextLeft, { suppressSnap: true });\r\n    return true;\r\n  }, [\r\n    clampScrollLeft,\r\n    getItems,\r\n    getLoopCenterDup,\r\n    getLoopGeometry,\r\n    idleThresholdMs,\r\n    jumpTo,\r\n    ref,\r\n  ]);\r\n\r\n  const scroll = (dir) => {\r\n    const el = ref.current;\r\n    if (!el) return;\r\n\r\n    const items = getItems(el);\r\n    if (!items.length) return;\r\n    const centerDup = loopEnabled ? getLoopCenterDup(items) : null;\r\n    const closest = getClosestItem(\r\n      el,\r\n      items,\r\n      loopEnabled && centerDup ? centerDup : null\r\n    );\r\n    if (!closest) return;\r\n    const delta = dir === \"right\" ? 1 : -1;\r\n    let nextIndex = closest.index + delta;\r\n    if (!loopEnabled) {\r\n      if (nextIndex < 0 || nextIndex >= items.length) return;\r\n    }\r\n    if (loopEnabled && centerDup) {\r\n      const dupItems = items.filter(\r\n        (item) => item.dataset.carouselDup === centerDup\r\n      );\r\n      nextIndex = Math.max(0, Math.min(nextIndex, dupItems.length - 1));\r\n      centerItem(el, dupItems[nextIndex], \"smooth\");\r\n      return;\r\n    }\r\n    nextIndex = Math.max(0, Math.min(nextIndex, items.length - 1));\r\n    centerItem(el, items[nextIndex], \"smooth\");\r\n  };\r\n\r\n  const scrollToStart = () => {\r\n    const el = ref.current;\r\n    if (!el) return;\r\n    if (loopEnabled) {\r\n      centerInitialItem(\"smooth\");\r\n      return;\r\n    }\r\n    const items = getItems(el);\r\n    if (!items.length) return;\r\n    centerItem(el, items[0], \"smooth\");\r\n  };\r\n\r\n  useLayoutEffect(() => {\r\n    readyRef.current = false;\r\n    const id = requestAnimationFrame(() => {\r\n      const el = ref.current;\r\n      if (!el) return;\r\n      centerInitialItem(\"auto\");\r\n      readyRef.current = true;\r\n      update();\r\n    });\r\n    return () => cancelAnimationFrame(id);\r\n  }, [centerInitialItem, itemsCount, loopEnabled, update]);\r\n\r\n  useEffect(() => {\r\n    const el = ref.current;\r\n    if (!el) return;\r\n    const reanchorDelayMs = snapDelay + 120;\r\n\r\n    const snapToClosest = () => {\r\n      if (!snap || snappingRef.current) return;\r\n      if (loopEnabled && !readyRef.current) return;\r\n      if (jumpingRef.current) return;\r\n      if (performance.now() < skipSnapUntilRef.current) return;\r\n      if (loopEnabled) {\r\n        if (interactingRef.current) return;\r\n        const idleFor = performance.now() - lastScrollTimeRef.current;\r\n        if (idleFor < idleThresholdMs) return;\r\n      }\r\n      const items = getItems(el);\r\n      if (!items.length) return;\r\n      const closest = getClosestItem(el, items, null);\r\n      if (!closest) return;\r\n      snappingRef.current = true;\r\n      centerItem(el, closest.item, \"smooth\");\r\n      requestAnimationFrame(() => {\r\n        snappingRef.current = false;\r\n      });\r\n    };\r\n\r\n    const ensureFinalSnap = () => {\r\n      if (!loopEnabled || !snap) return true;\r\n      if (jumpingRef.current || snappingRef.current) return false;\r\n      if (interactingRef.current) return true;\r\n      const idleFor = performance.now() - lastScrollTimeRef.current;\r\n      if (idleFor < stableIdleMs) return false;\r\n      const items = getItems(el);\r\n      if (!items.length) return true;\r\n      const closest = getClosestItem(el, items, null);\r\n      if (!closest) return true;\r\n      snappingRef.current = true;\r\n      centerItem(el, closest.item, \"smooth\");\r\n      requestAnimationFrame(() => {\r\n        snappingRef.current = false;\r\n      });\r\n      return true;\r\n    };\r\n\r\n    const scheduleSnap = () => {\r\n      if (!snap) return;\r\n      if (loopEnabled && !readyRef.current) return;\r\n      if (performance.now() < skipSnapUntilRef.current) return;\r\n      if (snapTimerRef.current) {\r\n        clearTimeout(snapTimerRef.current);\r\n      }\r\n      snapTimerRef.current = setTimeout(() => {\r\n        snapToClosest();\r\n        if (loopEnabled) {\r\n          if (interactingRef.current) {\r\n            scheduleSnap();\r\n            return;\r\n          }\r\n          const idleFor = performance.now() - lastScrollTimeRef.current;\r\n          if (idleFor < idleThresholdMs) {\r\n            scheduleSnap();\r\n          }\r\n        }\r\n      }, snapDelay);\r\n    };\r\n\r\n    const scheduleFinalSnap = () => {\r\n      if (!loopEnabled) return;\r\n      if (finalSnapTimerRef.current) {\r\n        clearTimeout(finalSnapTimerRef.current);\r\n      }\r\n      finalSnapTimerRef.current = setTimeout(() => {\r\n        const done = ensureFinalSnap();\r\n        if (!done) {\r\n          scheduleFinalSnap();\r\n        }\r\n      }, stableIdleMs + 40);\r\n    };\r\n\r\n    const scheduleReanchor = () => {\r\n      if (!loopEnabled) return;\r\n      if (reanchorTimerRef.current) {\r\n        clearTimeout(reanchorTimerRef.current);\r\n      }\r\n      reanchorTimerRef.current = setTimeout(() => {\r\n        if (snappingRef.current || jumpingRef.current) {\r\n          scheduleReanchor();\r\n          return;\r\n        }\r\n        const done = reanchorIfNeeded();\r\n        if (!done) {\r\n          scheduleReanchor();\r\n        }\r\n        scheduleFinalSnap();\r\n      }, reanchorDelayMs);\r\n    };\r\n\r\n    const handleScroll = () => {\r\n      const now = performance.now();\r\n      const prevLeft = lastScrollLeftRef.current;\r\n      const prevTime = lastScrollTimeRef.current || now;\r\n      const delta = el.scrollLeft - prevLeft;\r\n      const dt = Math.max(1, now - prevTime);\r\n      velocityRef.current = Math.abs(delta) / dt;\r\n      lastScrollLeftRef.current = el.scrollLeft;\r\n      lastScrollTimeRef.current = now;\r\n      update();\r\n      if (!loopEnabled) {\r\n        scheduleSnap();\r\n      }\r\n      scheduleReanchor();\r\n      scheduleFinalSnap();\r\n    };\r\n\r\n    update();\r\n    lastScrollLeftRef.current = el.scrollLeft;\r\n    lastScrollTimeRef.current = performance.now();\r\n    if (loopEnabled && !readyRef.current) {\r\n      return undefined;\r\n    }\r\n    el.addEventListener(\"scroll\", handleScroll);\r\n    const handleInteract = (event) => {\r\n      onInteract?.();\r\n      interactingRef.current = true;\r\n      if (interactionTimerRef.current) {\r\n        clearTimeout(interactionTimerRef.current);\r\n        interactionTimerRef.current = null;\r\n      }\r\n      if (event?.type === \"wheel\") {\r\n        interactionTimerRef.current = setTimeout(() => {\r\n          interactingRef.current = false;\r\n          interactionTimerRef.current = null;\r\n        }, idleThresholdMs);\r\n      }\r\n    };\r\n    const handleRelease = () => {\r\n      interactingRef.current = false;\r\n      if (interactionTimerRef.current) {\r\n        clearTimeout(interactionTimerRef.current);\r\n        interactionTimerRef.current = null;\r\n      }\r\n      if (loopEnabled) {\r\n        scheduleSnap();\r\n      }\r\n      scheduleReanchor();\r\n      scheduleFinalSnap();\r\n    };\r\n    el.addEventListener(\"pointerdown\", handleInteract);\r\n    el.addEventListener(\"touchstart\", handleInteract);\r\n    el.addEventListener(\"wheel\", handleInteract, { passive: true });\r\n    el.addEventListener(\"pointerup\", handleRelease);\r\n    el.addEventListener(\"touchend\", handleRelease);\r\n    el.addEventListener(\"touchcancel\", handleRelease);\r\n    window.addEventListener(\"mouseup\", handleRelease);\r\n    window.addEventListener(\"resize\", update);\r\n\r\n    return () => {\r\n      el.removeEventListener(\"scroll\", handleScroll);\r\n      el.removeEventListener(\"pointerdown\", handleInteract);\r\n      el.removeEventListener(\"touchstart\", handleInteract);\r\n      el.removeEventListener(\"wheel\", handleInteract);\r\n      el.removeEventListener(\"pointerup\", handleRelease);\r\n      el.removeEventListener(\"touchend\", handleRelease);\r\n      el.removeEventListener(\"touchcancel\", handleRelease);\r\n      window.removeEventListener(\"mouseup\", handleRelease);\r\n      window.removeEventListener(\"resize\", update);\r\n      if (snapTimerRef.current) {\r\n        clearTimeout(snapTimerRef.current);\r\n      }\r\n      if (reanchorTimerRef.current) {\r\n        clearTimeout(reanchorTimerRef.current);\r\n      }\r\n      if (finalSnapTimerRef.current) {\r\n        clearTimeout(finalSnapTimerRef.current);\r\n      }\r\n      if (interactionTimerRef.current) {\r\n        clearTimeout(interactionTimerRef.current);\r\n      }\r\n    };\r\n  }, [\r\n    centerItem,\r\n    getClosestItem,\r\n    getItems,\r\n    loopEnabled,\r\n    onInteract,\r\n    reanchorIfNeeded,\r\n    ref,\r\n    snap,\r\n    snapDelay,\r\n    update,\r\n  ]);\r\n\r\n  return { canLeft, canRight, scroll, scrollToStart };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\useMfaGate.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\usePinSetup.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\usePromoSearch.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\hooks\\useSearchDock.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\landing\\LandingPage.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":499,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":499,"endColumn":41,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[19078,19084],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from \"react\";\r\nimport { useLocation } from \"react-router-dom\";\r\n\r\nconst HERO_METRICS = [\r\n  { label: \"Clientes activos\", value: \"+20k\" },\r\n  { label: \"Negocios aliados\", value: \"+1.2k\" },\r\n  { label: \"Canjes mensuales\", value: \"+95k\" },\r\n];\r\n\r\nconst HOW_STEPS = [\r\n  {\r\n    title: \"Escanea un QR\",\r\n    description: \"Cada visita suma puntos y valida tu canje en segundos.\",\r\n    Icon: QrIcon,\r\n  },\r\n  {\r\n    title: \"Activa grupos\",\r\n    description: \"Invita a tu gente favorita y multiplica tus beneficios.\",\r\n    Icon: GroupIcon,\r\n  },\r\n  {\r\n    title: \"Gana y canjea\",\r\n    description: \"Tus puntos se convierten en promociones reales.\",\r\n    Icon: PointsIcon,\r\n  },\r\n];\r\n\r\nconst ROLE_STEPS = {\r\n  cliente: [\r\n    \"Descarga la app y crea tu cuenta en 1 minuto.\",\r\n    \"Escanea en tu negocio favorito y suma puntos al instante.\",\r\n    \"Comparte tu grupo y canjea promociones exclusivas.\",\r\n  ],\r\n  negocio: [\r\n    \"Registra tu negocio y verifica tu cuenta.\",\r\n    \"Crea promociones, QR y reglas de canje personalizadas.\",\r\n    \"Mide resultados en tiempo real y fideliza clientes.\",\r\n  ],\r\n};\r\n\r\nconst ROLE_BENEFITS = [\r\n  {\r\n    title: \"Clientes\",\r\n    highlight: \"Ahorros reales en cada visita\",\r\n    bullets: [\r\n      \"Puntos acumulados que se ven al instante.\",\r\n      \"Grupos para compartir beneficios con tu gente.\",\r\n      \"Promos verificadas y sin letras pequenas.\",\r\n    ],\r\n  },\r\n  {\r\n    title: \"Negocios\",\r\n    highlight: \"Fideliza y vende mas\",\r\n    bullets: [\r\n      \"Control total sobre tus promociones.\",\r\n      \"Canjes rapidos con QR y validacion segura.\",\r\n      \"Panel para seguir crecimiento y recurrencia.\",\r\n    ],\r\n  },\r\n];\r\n\r\nconst TRUST_ITEMS = [\r\n  {\r\n    title: \"Verificacion activa\",\r\n    description: \"Negocios y usuarios revisados para evitar fraude.\",\r\n    Icon: ShieldIcon,\r\n  },\r\n  {\r\n    title: \"Moderacion continua\",\r\n    description: \"Promos claras, sin engaños ni ruido.\",\r\n    Icon: CheckIcon,\r\n  },\r\n  {\r\n    title: \"Soporte humano\",\r\n    description: \"Un equipo listo para ayudarte cuando lo necesites.\",\r\n    Icon: SupportIcon,\r\n  },\r\n];\r\n\r\nconst FAQ_ITEMS = [\r\n  {\r\n    question: \"Cuanto cuesta usar Referidos?\",\r\n    answer: \"La app es gratis para clientes. Los negocios eligen su plan segun sus objetivos.\",\r\n  },\r\n  {\r\n    question: \"Necesito internet para usarla?\",\r\n    answer: \"Solo necesitas conexion para registrar y canjear puntos.\",\r\n  },\r\n  {\r\n    question: \"Puedo cambiarme de rol?\",\r\n    answer: \"Si. Puedes registrar un negocio desde tu cuenta cuando quieras.\",\r\n  },\r\n  {\r\n    question: \"Que pasa si pierdo mis puntos?\",\r\n    answer: \"Tus puntos quedan respaldados en tu cuenta, no en tu telefono.\",\r\n  },\r\n  {\r\n    question: \"Como se verifican los negocios?\",\r\n    answer: \"Validamos identidad, ubicacion y reglas de canje antes de publicar.\",\r\n  },\r\n];\r\n\r\nexport default function LandingPage() {\r\n  const [role, setRole] = useState(\"cliente\");\r\n  const location = useLocation();\r\n\r\n  const meta = useMemo(\r\n    () => ({\r\n      title: \"Referidos | Promociones reales con QR, grupos y puntos\",\r\n      description:\r\n        \"Gana y canjea promociones con QR. Crea grupos, suma puntos y haz que cada visita cuente. Hecho para clientes y negocios.\",\r\n      ogImage: `${window.location.origin}/screenshots/desktop-1.png`,\r\n    }),\r\n    []\r\n  );\r\n\r\n  useEffect(() => {\r\n    const url = `${window.location.origin}${location.pathname}`;\r\n    document.title = meta.title;\r\n    document.documentElement.lang = \"es\";\r\n\r\n    const setMeta = (name, content) => {\r\n      let tag = document.querySelector(`meta[name=\"${name}\"]`);\r\n      if (!tag) {\r\n        tag = document.createElement(\"meta\");\r\n        tag.setAttribute(\"name\", name);\r\n        document.head.appendChild(tag);\r\n      }\r\n      tag.setAttribute(\"content\", content);\r\n    };\r\n\r\n    const setProperty = (property, content) => {\r\n      let tag = document.querySelector(`meta[property=\"${property}\"]`);\r\n      if (!tag) {\r\n        tag = document.createElement(\"meta\");\r\n        tag.setAttribute(\"property\", property);\r\n        document.head.appendChild(tag);\r\n      }\r\n      tag.setAttribute(\"content\", content);\r\n    };\r\n\r\n    const setLink = (rel, href) => {\r\n      let tag = document.querySelector(`link[rel=\"${rel}\"]`);\r\n      if (!tag) {\r\n        tag = document.createElement(\"link\");\r\n        tag.setAttribute(\"rel\", rel);\r\n        document.head.appendChild(tag);\r\n      }\r\n      tag.setAttribute(\"href\", href);\r\n    };\r\n\r\n    setMeta(\"description\", meta.description);\r\n    setMeta(\"robots\", \"index,follow\");\r\n    setProperty(\"og:type\", \"website\");\r\n    setProperty(\"og:title\", meta.title);\r\n    setProperty(\"og:description\", meta.description);\r\n    setProperty(\"og:image\", meta.ogImage);\r\n    setProperty(\"og:url\", url);\r\n    setMeta(\"twitter:card\", \"summary_large_image\");\r\n    setMeta(\"twitter:title\", meta.title);\r\n    setMeta(\"twitter:description\", meta.description);\r\n    setMeta(\"twitter:image\", meta.ogImage);\r\n    setLink(\"canonical\", url);\r\n  }, [location.pathname, meta]);\r\n\r\n  return (\r\n    <div\r\n      className=\"relative min-h-screen overflow-hidden bg-[#FFF7ED] text-slate-900\"\r\n      style={{\r\n        fontFamily: '\"Space Grotesk\", \"Sora\", \"Trebuchet MS\", sans-serif',\r\n      }}\r\n    >\r\n      <style>{`\r\n        @keyframes floaty {\r\n          0% { transform: translateY(0px); }\r\n          50% { transform: translateY(-10px); }\r\n          100% { transform: translateY(0px); }\r\n        }\r\n        @keyframes fadeUp {\r\n          0% { opacity: 0; transform: translateY(18px); }\r\n          100% { opacity: 1; transform: translateY(0); }\r\n        }\r\n        @keyframes glowPulse {\r\n          0% { opacity: 0.4; }\r\n          50% { opacity: 0.7; }\r\n          100% { opacity: 0.4; }\r\n        }\r\n        .floaty { animation: floaty 8s ease-in-out infinite; }\r\n        .fade-up { animation: fadeUp 0.6s ease both; }\r\n        .glow-pulse { animation: glowPulse 5s ease-in-out infinite; }\r\n        @media (prefers-reduced-motion: reduce) {\r\n          .floaty, .fade-up, .glow-pulse { animation: none; }\r\n        }\r\n      `}</style>\r\n\r\n      <div className=\"pointer-events-none absolute inset-0\">\r\n        <div\r\n          className=\"absolute -top-32 right-10 h-72 w-72 rounded-full blur-[120px] glow-pulse\"\r\n          style={{ background: \"radial-gradient(circle, #FDBA74, #FB7185)\" }}\r\n        />\r\n        <div\r\n          className=\"absolute bottom-0 left-0 h-72 w-72 rounded-full blur-[140px] glow-pulse\"\r\n          style={{ background: \"radial-gradient(circle, #38BDF8, #A78BFA)\" }}\r\n        />\r\n      </div>\r\n\r\n      <header className=\"relative z-10 mx-auto flex w-full max-w-6xl items-center justify-between px-6 pt-8\">\r\n        <div className=\"text-lg font-semibold tracking-tight\">\r\n          Referidos\r\n          <span className=\"ml-2 rounded-full bg-[#111827] px-2 py-1 text-[10px] uppercase tracking-[0.2em] text-white\">\r\n            beta\r\n          </span>\r\n        </div>\r\n        <div className=\"hidden items-center gap-3 text-sm text-slate-600 md:flex\">\r\n          <span>QR</span>\r\n          <span>Grupos</span>\r\n          <span>Puntos</span>\r\n        </div>\r\n      </header>\r\n\r\n      <section className=\"relative z-10 mx-auto flex w-full max-w-6xl flex-col gap-10 px-6 pb-16 pt-12 md:flex-row md:items-center\">\r\n        <div className=\"flex-1 space-y-6\">\r\n          <p className=\"inline-flex items-center gap-2 rounded-full border border-[#F59E0B]/30 bg-white/80 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-[#B45309] shadow-sm\">\r\n            Promos que se pueden tocar\r\n          </p>\r\n          <h1 className=\"text-4xl font-semibold leading-tight text-slate-900 md:text-6xl\">\r\n            Convierte cada visita en\r\n            <span className=\"block text-[#F97316]\">puntos reales</span>\r\n            con QR, grupos y recompensas claras.\r\n          </h1>\r\n          <p className=\"max-w-xl text-base leading-7 text-slate-700 md:text-lg\">\r\n            Referidos es la app que conecta negocios y clientes con promociones\r\n            transparentes. Escanea, suma puntos y canjea beneficios sin friccion.\r\n          </p>\r\n          <div className=\"flex flex-wrap items-center gap-3\">\r\n            <a\r\n              href=\"/auth\"\r\n              className=\"rounded-full bg-[#0F172A] px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-black/20 transition-transform hover:-translate-y-0.5\"\r\n            >\r\n              Empezar ahora\r\n            </a>\r\n            <a\r\n              href=\"#como-empezar\"\r\n              className=\"rounded-full border border-slate-300 bg-white px-6 py-3 text-sm font-semibold text-slate-700 transition-transform hover:-translate-y-0.5\"\r\n            >\r\n              Ver como funciona\r\n            </a>\r\n          </div>\r\n\r\n          <div className=\"flex flex-wrap gap-4 pt-2 text-xs text-slate-600\">\r\n            {HERO_METRICS.map((metric) => (\r\n              <div key={metric.label} className=\"flex items-center gap-2\">\r\n                <span className=\"text-lg font-semibold text-slate-900\">\r\n                  {metric.value}\r\n                </span>\r\n                <span>{metric.label}</span>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex-1\">\r\n          <div className=\"relative mx-auto max-w-md\">\r\n            <div className=\"floaty absolute -top-6 left-10 h-16 w-16 rounded-2xl bg-white shadow-xl\" />\r\n            <div className=\"floaty absolute -bottom-10 right-6 h-20 w-20 rounded-full bg-[#0EA5E9] opacity-80 blur-xl\" />\r\n            <div className=\"relative overflow-hidden rounded-[32px] border border-white/60 bg-white/70 p-4 shadow-2xl backdrop-blur\">\r\n              <img\r\n                src=\"/screenshots/mobile-1.png\"\r\n                alt=\"Vista previa de la app\"\r\n                loading=\"lazy\"\r\n                className=\"w-full rounded-2xl\"\r\n              />\r\n              <div className=\"mt-4 grid grid-cols-3 gap-3\">\r\n                {[\"QR rapido\", \"Grupos\", \"Canjes\"].map((label) => (\r\n                  <div\r\n                    key={label}\r\n                    className=\"rounded-xl bg-[#0F172A] px-3 py-2 text-center text-[11px] font-semibold uppercase tracking-[0.18em] text-white\"\r\n                  >\r\n                    {label}\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      <section className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-16\">\r\n        <div className=\"rounded-[32px] border border-white/70 bg-white/80 p-8 shadow-xl backdrop-blur\">\r\n          <h2 className=\"text-2xl font-semibold text-slate-900 md:text-3xl\">\r\n            Descargas listas para cada dispositivo\r\n          </h2>\r\n          <p className=\"mt-2 text-sm text-slate-600 md:text-base\">\r\n            Instala en tu telefono o escritorio. La experiencia PWA funciona en\r\n            segundos.\r\n          </p>\r\n          <div className=\"mt-6 flex flex-wrap items-center gap-3\">\r\n            <StoreButton\r\n              href=\"https://play.google.com/store\"\r\n              label=\"Descargar Android\"\r\n              Icon={AndroidIcon}\r\n            />\r\n            <StoreButton\r\n              href=\"https://apps.apple.com/\"\r\n              label=\"Descargar Apple\"\r\n              Icon={AppleIcon}\r\n            />\r\n            <StoreButton\r\n              href=\"https://www.microsoft.com/store/apps\"\r\n              label=\"Descargar Windows\"\r\n              Icon={WindowsIcon}\r\n            />\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      <section id=\"como-empezar\" className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-16\">\r\n        <div className=\"flex flex-col gap-6 md:flex-row md:items-center md:justify-between\">\r\n          <div>\r\n            <h2 className=\"text-3xl font-semibold text-slate-900 md:text-4xl\">\r\n              Como empezar en minutos\r\n            </h2>\r\n            <p className=\"mt-2 text-base text-slate-600\">\r\n              Dos caminos claros para que todo sea simple desde el primer dia.\r\n            </p>\r\n          </div>\r\n          <div className=\"flex rounded-full border border-slate-200 bg-white p-1 text-sm font-semibold\">\r\n            {[\"cliente\", \"negocio\"].map((tab) => (\r\n              <button\r\n                key={tab}\r\n                type=\"button\"\r\n                onClick={() => setRole(tab)}\r\n                className={`rounded-full px-5 py-2 transition-all ${\r\n                  role === tab\r\n                    ? \"bg-[#0F172A] text-white shadow\"\r\n                    : \"text-slate-600 hover:text-slate-900\"\r\n                }`}\r\n              >\r\n                Soy {tab}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-8 grid gap-4 md:grid-cols-3\">\r\n          {ROLE_STEPS[role].map((step, idx) => (\r\n            <div\r\n              key={step}\r\n              className=\"fade-up rounded-[28px] border border-white/70 bg-white/80 p-6 text-sm text-slate-700 shadow-lg\"\r\n              style={{ animationDelay: `${idx * 0.08}s` }}\r\n            >\r\n              <div className=\"mb-3 text-xs font-semibold uppercase tracking-[0.3em] text-[#F97316]\">\r\n                Paso {idx + 1}\r\n              </div>\r\n              <p className=\"text-base text-slate-800\">{step}</p>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </section>\r\n\r\n      <section className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-16\">\r\n        <div className=\"grid gap-6 md:grid-cols-3\">\r\n          {HOW_STEPS.map((step) => (\r\n            <div\r\n              key={step.title}\r\n              className=\"rounded-[30px] border border-white/70 bg-white/80 p-7 shadow-xl\"\r\n            >\r\n              <div className=\"mb-4 inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-[#0F172A] text-white\">\r\n                <step.Icon />\r\n              </div>\r\n              <h3 className=\"text-xl font-semibold text-slate-900\">\r\n                {step.title}\r\n              </h3>\r\n              <p className=\"mt-2 text-sm text-slate-600\">{step.description}</p>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </section>\r\n\r\n      <section className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-16\">\r\n        <div className=\"grid gap-6 md:grid-cols-2\">\r\n          {ROLE_BENEFITS.map((lane) => (\r\n            <div\r\n              key={lane.title}\r\n              className=\"rounded-[32px] border border-white/70 bg-[#0F172A] p-8 text-white shadow-2xl\"\r\n            >\r\n              <p className=\"text-xs uppercase tracking-[0.3em] text-white/70\">\r\n                {lane.title}\r\n              </p>\r\n              <h3 className=\"mt-3 text-2xl font-semibold\">{lane.highlight}</h3>\r\n              <ul className=\"mt-4 space-y-2 text-sm text-white/80\">\r\n                {lane.bullets.map((bullet) => (\r\n                  <li key={bullet} className=\"flex items-start gap-2\">\r\n                    <span className=\"mt-1 inline-flex h-2 w-2 rounded-full bg-[#F97316]\" />\r\n                    {bullet}\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </section>\r\n\r\n      <section className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-16\">\r\n        <div className=\"rounded-[40px] border border-white/70 bg-white/80 p-8 shadow-xl\">\r\n          <div className=\"flex flex-col gap-6 md:flex-row md:items-center md:justify-between\">\r\n            <div>\r\n              <h2 className=\"text-3xl font-semibold text-slate-900\">\r\n                QR, grupos y puntos sin friccion\r\n              </h2>\r\n              <p className=\"mt-2 text-sm text-slate-600 md:text-base\">\r\n                Tres elementos simples que hacen que la experiencia fluya.\r\n              </p>\r\n            </div>\r\n            <img\r\n              src=\"/screenshots/desktop-1.png\"\r\n              alt=\"Panel de Referidos\"\r\n              loading=\"lazy\"\r\n              className=\"w-full max-w-md rounded-2xl border border-white/80 shadow-lg md:w-80\"\r\n            />\r\n          </div>\r\n          <div className=\"mt-8 grid gap-4 md:grid-cols-3\">\r\n            {HOW_STEPS.map((step) => (\r\n              <div\r\n                key={step.title}\r\n                className=\"rounded-2xl border border-slate-200 bg-white p-5 text-sm text-slate-600\"\r\n              >\r\n                <div className=\"mb-3 flex items-center gap-2 text-base font-semibold text-slate-900\">\r\n                  <step.Icon />\r\n                  {step.title}\r\n                </div>\r\n                {step.description}\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      <section className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-16\">\r\n        <div className=\"grid gap-6 md:grid-cols-3\">\r\n          {TRUST_ITEMS.map((item) => (\r\n            <div\r\n              key={item.title}\r\n              className=\"rounded-[28px] border border-white/70 bg-white/80 p-6 shadow-lg\"\r\n            >\r\n              <div className=\"mb-3 inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-[#F97316] text-white\">\r\n                <item.Icon />\r\n              </div>\r\n              <h3 className=\"text-lg font-semibold text-slate-900\">\r\n                {item.title}\r\n              </h3>\r\n              <p className=\"mt-2 text-sm text-slate-600\">{item.description}</p>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </section>\r\n\r\n      <section className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-16\">\r\n        <div className=\"rounded-[32px] border border-white/70 bg-white/80 p-8 shadow-xl\">\r\n          <h2 className=\"text-3xl font-semibold text-slate-900\">\r\n            Preguntas frecuentes\r\n          </h2>\r\n          <div className=\"mt-6 grid gap-4 md:grid-cols-2\">\r\n            {FAQ_ITEMS.map((item) => (\r\n              <details\r\n                key={item.question}\r\n                className=\"rounded-2xl border border-slate-200 bg-white px-5 py-4 text-sm text-slate-700\"\r\n              >\r\n                <summary className=\"cursor-pointer text-base font-semibold text-slate-900\">\r\n                  {item.question}\r\n                </summary>\r\n                <p className=\"mt-2 text-sm text-slate-600\">{item.answer}</p>\r\n              </details>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </section>\r\n\r\n      <footer className=\"relative z-10 mx-auto w-full max-w-6xl px-6 pb-10\">\r\n        <div className=\"flex flex-wrap items-center justify-between gap-4 border-t border-slate-200 pt-6 text-xs text-slate-500\">\r\n          <span>© {new Date().getFullYear()} Referidos</span>\r\n          <div className=\"flex flex-wrap gap-4\">\r\n            <a href=\"/legal/es/terms\" className=\"hover:text-slate-700\">\r\n              Terminos\r\n            </a>\r\n            <a href=\"/legal/es/privacy\" className=\"hover:text-slate-700\">\r\n              Privacidad\r\n            </a>\r\n            <a href=\"/legal/es/data-deletion\" className=\"hover:text-slate-700\">\r\n              Eliminacion de datos\r\n            </a>\r\n          </div>\r\n        </div>\r\n      </footer>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction StoreButton({ href, label, Icon }) {\r\n  return (\r\n    <a\r\n      href={href}\r\n      target=\"_blank\"\r\n      rel=\"noreferrer\"\r\n      className=\"flex items-center gap-3 rounded-full border border-slate-200 bg-white px-5 py-3 text-sm font-semibold text-slate-700 shadow-sm transition-transform hover:-translate-y-0.5\"\r\n    >\r\n      <Icon />\r\n      {label}\r\n    </a>\r\n  );\r\n}\r\n\r\nfunction QrIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M4 4h6v6H4V4zm0 10h6v6H4v-6zm10-10h6v6h-6V4zm0 10h3v3h-3v-3zm3 3h3v3h-3v-3z\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.8\"\r\n        strokeLinejoin=\"round\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction GroupIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.67 0-8 1.34-8 4v2h10v-2c0-1.1.9-2.08 2.2-2.9C10.74 13.42 9.36 13 8 13zm8 0c-.72 0-1.5.08-2.3.24 1.78.9 3.3 2.08 3.3 3.76v2h7v-2c0-2.66-5.33-4-8-4z\"\r\n        fill=\"currentColor\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction PointsIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M12 2l2.3 5.3L20 8l-4.4 3.6L16.8 18 12 15.3 7.2 18l1.2-6.4L4 8l5.7-.7L12 2z\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.6\"\r\n        strokeLinejoin=\"round\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction ShieldIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M12 3l7 3v6c0 4.2-2.7 7.9-7 9-4.3-1.1-7-4.8-7-9V6l7-3z\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.6\"\r\n      />\r\n      <path\r\n        d=\"M9 12l2 2 4-4\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.6\"\r\n        strokeLinecap=\"round\"\r\n        strokeLinejoin=\"round\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction CheckIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M20 6L9 17l-5-5\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.8\"\r\n        strokeLinecap=\"round\"\r\n        strokeLinejoin=\"round\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction SupportIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M12 3a7 7 0 00-7 7v4a3 3 0 003 3h1v-6H6v-1a6 6 0 0112 0v1h-3v6h1a3 3 0 003-3v-4a7 7 0 00-7-7z\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.6\"\r\n        strokeLinejoin=\"round\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction AndroidIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M7 8h10v8a2 2 0 01-2 2H9a2 2 0 01-2-2V8z\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.6\"\r\n      />\r\n      <path\r\n        d=\"M9 6l-1.5-2M15 6l1.5-2\"\r\n        stroke=\"currentColor\"\r\n        strokeWidth=\"1.6\"\r\n        strokeLinecap=\"round\"\r\n      />\r\n      <circle cx=\"10\" cy=\"11\" r=\"0.8\" fill=\"currentColor\" />\r\n      <circle cx=\"14\" cy=\"11\" r=\"0.8\" fill=\"currentColor\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction AppleIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M16.4 2c0 1.1-.4 2.1-1.1 2.9-.7.8-1.9 1.4-3 1.3-.1-1 .4-2.1 1-2.8.7-.8 2-1.4 3.1-1.4z\"\r\n        fill=\"currentColor\"\r\n      />\r\n      <path\r\n        d=\"M20.2 17c-.5 1.1-.8 1.6-1.4 2.6-.9 1.4-2.2 3.1-3.8 3.1-1.4 0-1.8-.9-3.8-.9-2 0-2.5.9-3.8.9-1.6 0-2.8-1.6-3.7-3-.7-1.1-1.2-2.4-1.2-3.8 0-2.3 1.2-3.5 2.9-3.5 1.4 0 2.4.9 3.7.9 1.2 0 2.4-.9 3.9-.9 1.4 0 2.6.7 3.4 1.8-1.8 1-1.5 3.8 1.8 4.8z\"\r\n        fill=\"currentColor\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction WindowsIcon() {\r\n  return (\r\n    <svg width=\"22\" height=\"22\" viewBox=\"0 0 24 24\" fill=\"none\">\r\n      <path\r\n        d=\"M3 5l8-1v8H3V5zm0 7h8v8l-8-1v-7zm10-8l8-1v9h-8V4zm0 9h8v9l-8-1v-8z\"\r\n        fill=\"currentColor\"\r\n      />\r\n    </svg>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\MainLayout.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\footer\\BottomNavBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-elements\\HeaderActions.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-elements\\TabTitle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-elements\\UserIdentity.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-elements\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-panels\\HeaderPanelContainer.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-panels\\LocationPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-panels\\NotificationsPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-panels\\QueuePanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-panels\\SearchbarPanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\layouts\\header-panels\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\LegalLayout.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\LegalRouter.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\blocks\\LegalContent.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\blocks\\LegalFooter.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\blocks\\LegalHeader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\index.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\pages\\DataDeletionPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\pages\\PrivacyPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\legal\\pages\\TermsPage.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\lib\\supabaseClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\main.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\modals\\ModalProvider.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'updateViewport'. Either include it or remove the dependency array.","line":60,"column":6,"nodeType":"ArrayExpression","endLine":60,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [updateViewport]","fix":{"range":[2207,2209],"text":"[updateViewport]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/modals/ModalProvider.jsx\r\nimport React, { useEffect, useRef, useState } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { useModalStore } from \"./modalStore\";\r\nimport { modalRegistry } from \"./modalRegistry\";\r\n\r\nexport default function ModalProvider() {\r\n  const activeModal = useModalStore((s) => s.activeModal);\r\n  const modalProps = useModalStore((s) => s.modalProps);\r\n  const closeModal = useModalStore((s) => s.closeModal);\r\n  const modalContentRef = useRef(null);\r\n  const viewportLockRef = useRef(false);\r\n  const unlockTimerRef = useRef(null);\r\n  const keyboardOpenRef = useRef(false);\r\n  const [viewportH, setViewportH] = useState(\r\n    typeof window !== \"undefined\"\r\n      ? (window.visualViewport?.height ?? window.innerHeight)\r\n      : 0\r\n  );\r\n  const [baseH, setBaseH] = useState(\r\n    typeof window !== \"undefined\" ? window.innerHeight : 0\r\n  );\r\n  const isFullScreenOverlay =\r\n    activeModal === \"SplashChoiceOverlay\" || activeModal === \"SplashEmailConfirmation\";\r\n  const disableBackdropClose =\r\n    activeModal === \"SplashEmailConfirmation\" || activeModal === \"ForcePasswordChange\";\r\n\r\n  const updateViewport = (force = false) => {\r\n    if (!force && viewportLockRef.current) return;\r\n    const vh = window.visualViewport?.height ?? window.innerHeight;\r\n    const base = window.innerHeight;\r\n    setBaseH((prev) => (prev === 0 ? base : prev));\r\n    if (activeModal === \"AccessMethods\") {\r\n      const delta = base - vh;\r\n      if (!keyboardOpenRef.current) {\r\n        setViewportH(vh);\r\n        if (delta > 20) {\r\n          keyboardOpenRef.current = true;\r\n          viewportLockRef.current = true;\r\n        }\r\n      } else if (delta < 10) {\r\n        keyboardOpenRef.current = false;\r\n        viewportLockRef.current = false;\r\n        setViewportH(vh);\r\n      }\r\n      return;\r\n    }\r\n    setViewportH(vh);\r\n  };\r\n\r\n  useEffect(() => {\r\n    const update = () => updateViewport();\r\n    update();\r\n    window.visualViewport?.addEventListener(\"resize\", update);\r\n    window.addEventListener(\"resize\", update);\r\n    return () => {\r\n      window.visualViewport?.removeEventListener(\"resize\", update);\r\n      window.removeEventListener(\"resize\", update);\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (activeModal === \"AccessMethods\") {\r\n      keyboardOpenRef.current = false;\r\n      viewportLockRef.current = false;\r\n    } else {\r\n      keyboardOpenRef.current = false;\r\n      viewportLockRef.current = false;\r\n      if (unlockTimerRef.current) {\r\n        window.clearTimeout(unlockTimerRef.current);\r\n        unlockTimerRef.current = null;\r\n      }\r\n    }\r\n  }, [activeModal]);\r\n\r\n  useEffect(() => {\r\n    if (!activeModal) return;\r\n    const bodyStyle = document.body.style;\r\n    const htmlStyle = document.documentElement.style;\r\n    const prevBodyOverflow = bodyStyle.overflow;\r\n    const prevBodyTouch = bodyStyle.touchAction;\r\n    const prevHtmlOverflow = htmlStyle.overflow;\r\n    bodyStyle.overflow = \"hidden\";\r\n    bodyStyle.touchAction = \"none\";\r\n    htmlStyle.overflow = \"hidden\";\r\n    return () => {\r\n      bodyStyle.overflow = prevBodyOverflow;\r\n      bodyStyle.touchAction = prevBodyTouch;\r\n      htmlStyle.overflow = prevHtmlOverflow;\r\n    };\r\n  }, [activeModal]);\r\n\r\n  if (!activeModal) return null;\r\n  if (typeof document === \"undefined\") return null;\r\n\r\n  const ModalComponent = modalRegistry[activeModal];\r\n  if (!ModalComponent) return null;\r\n\r\n  return createPortal(\r\n    <div\r\n      style={{\r\n        position: \"fixed\",\r\n        inset: 0,\r\n        background: isFullScreenOverlay ? \"transparent\" : \"rgba(0,0,0,0.45)\",\r\n        backdropFilter: isFullScreenOverlay ? \"none\" : \"blur(3px)\",\r\n        display: \"flex\",\r\n        alignItems: \"center\",\r\n        justifyContent: \"center\",\r\n        padding: isFullScreenOverlay ? \"0\" : \"24px 14px\",\r\n        overflow: \"hidden\",\r\n        minHeight: viewportH ? `${viewportH}px` : \"100vh\",\r\n        height: viewportH ? `${viewportH}px` : \"100dvh\",\r\n        boxSizing: \"border-box\",\r\n        zIndex: 9999,\r\n      }}\r\n      onClick={disableBackdropClose ? undefined : closeModal}\r\n    >\r\n      <div\r\n        onClick={(e) => e.stopPropagation()}\r\n        style={{\r\n          width: \"100%\",\r\n          height: \"100%\",\r\n          display: \"flex\",\r\n          justifyContent: \"center\",\r\n          alignItems: \"center\",\r\n          transform:\r\n            !isFullScreenOverlay &&\r\n            viewportH &&\r\n            baseH &&\r\n            viewportH > baseH * 0.95\r\n              ? \"translateY(-64px)\"\r\n              : \"translateY(0)\",\r\n          transition: \"transform 180ms ease\",\r\n        }}\r\n      >\r\n        <div ref={modalContentRef} className=\"w-full\">\r\n          <ModalComponent {...modalProps} />\r\n        </div>\r\n      </div>\r\n    </div>,\r\n    document.body\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\modals\\modalRegistry.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\modals\\modalStore.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\modals\\useModal.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\base\\NegocioEscanerBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\base\\NegocioGestionarBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\base\\NegocioInicioBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\base\\NegocioPerfilBase.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\gestionar\\GestionarPanel.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[76,115],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/GestionarPanel.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\n\r\nexport default function GestionarPanel({ activeId, children }) {\r\n  return (\r\n    <motion.div\r\n      key={activeId}\r\n      initial={{ opacity: 0, y: 12 }}\r\n      animate={{ opacity: 1, y: 0 }}\r\n      transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n      className=\"mt-6\"\r\n    >\r\n      <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-5 shadow-sm\">\r\n        {children}\r\n      </div>\r\n    </motion.div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\gestionar\\GestionarTabs.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[75,114],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/GestionarTabs.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\n\r\nexport default function GestionarTabs({ tabs, activeId, onChange }) {\r\n  return (\r\n    <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-1 shadow-sm\">\r\n      <div className=\"grid grid-cols-4 gap-1\">\r\n        {tabs.map((tab) => {\r\n          const active = tab.id === activeId;\r\n\r\n          return (\r\n            <button\r\n              key={tab.id}\r\n              type=\"button\"\r\n              onClick={() => onChange(tab.id)}\r\n              className={`relative flex flex-col items-center justify-center gap-1 rounded-xl px-2 py-2.5 text-[11px] font-semibold transition ${\r\n                active\r\n                  ? \"text-[#5E30A5]\"\r\n                  : \"text-slate-500 hover:text-[#5E30A5]\"\r\n              }`}\r\n              aria-pressed={active}\r\n            >\r\n              {active && (\r\n                <motion.span\r\n                  layoutId=\"gestionarTab\"\r\n                  className=\"absolute inset-0 rounded-xl bg-[#5E30A5]/10\"\r\n                  transition={{ type: \"spring\", stiffness: 260, damping: 26 }}\r\n                />\r\n              )}\r\n              <motion.span\r\n                className=\"relative z-10\"\r\n                animate={{ scale: active ? 1.12 : 1 }}\r\n                transition={{ type: \"spring\", stiffness: 300, damping: 20 }}\r\n              >\r\n                <tab.Icon size={18} />\r\n              </motion.span>\r\n              <span className=\"relative z-10 leading-none\">{tab.label}</span>\r\n            </button>\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\gestionar\\sections\\Dispositivos.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[83,122],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Dispositivos.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { Laptop, MonitorSmartphone, Smartphone, Wifi } from \"lucide-react\";\r\n\r\nexport default function Dispositivos() {\r\n  const devices = [\r\n    {\r\n      name: \"Terminal principal\",\r\n      detail: \"POS - Mostrador\",\r\n      status: \"Activo\",\r\n      lastSeen: \"Hace 2 min\",\r\n      Icon: MonitorSmartphone,\r\n    },\r\n    {\r\n      name: \"Tablet cocina\",\r\n      detail: \"Ordenes\",\r\n      status: \"Activo\",\r\n      lastSeen: \"Hace 12 min\",\r\n      Icon: Laptop,\r\n    },\r\n    {\r\n      name: \"Telefono gerente\",\r\n      detail: \"Panel mobile\",\r\n      status: \"En pausa\",\r\n      lastSeen: \"Hace 1 hora\",\r\n      Icon: Smartphone,\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Dispositivos vinculados\r\n          </div>\r\n          <div className=\"text-xs text-slate-500\">\r\n            Controla accesos y sesiones activas en tu negocio.\r\n          </div>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5] shadow-sm transition hover:border-[#5E30A5]/40\"\r\n        >\r\n          Agregar dispositivo\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"grid gap-3\">\r\n        {devices.map((device) => (\r\n          <motion.div\r\n            key={device.name}\r\n            whileHover={{ y: -2 }}\r\n            className=\"flex flex-col gap-3 rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-4 shadow-sm sm:flex-row sm:items-center sm:justify-between\"\r\n          >\r\n            <div className=\"flex items-center gap-3\">\r\n              <div className=\"flex h-11 w-11 items-center justify-center rounded-xl bg-white text-[#5E30A5] shadow-sm\">\r\n                <device.Icon size={20} />\r\n              </div>\r\n              <div>\r\n                <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                  {device.name}\r\n                </div>\r\n                <div className=\"text-xs text-slate-500\">{device.detail}</div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-4 text-xs text-slate-500\">\r\n              <div className=\"inline-flex items-center gap-2\">\r\n                <span\r\n                  className={`h-2.5 w-2.5 rounded-full ${\r\n                    device.status === \"Activo\" ? \"bg-emerald-400\" : \"bg-amber-400\"\r\n                  }`}\r\n                />\r\n                {device.status}\r\n              </div>\r\n              <div className=\"flex items-center gap-1\">\r\n                <Wifi size={14} />\r\n                {device.lastSeen}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"flex items-center gap-2\">\r\n              <button\r\n                type=\"button\"\r\n                className=\"rounded-lg border border-[#E9E2F7] bg-white px-3 py-1.5 text-xs font-semibold text-slate-500 transition hover:text-[#5E30A5]\"\r\n              >\r\n                Detalles\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                className=\"rounded-lg bg-[#5E30A5] px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-[#4B2488]\"\r\n              >\r\n                Cerrar sesion\r\n              </button>\r\n            </div>\r\n          </motion.div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"rounded-xl border border-dashed border-[#E9E2F7] bg-white p-4\">\r\n        <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n          Recomendaciones de seguridad\r\n        </div>\r\n        <p className=\"mt-1 text-xs text-slate-500\">\r\n          Revisa dispositivos sin uso reciente y elimina accesos innecesarios.\r\n        </p>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\gestionar\\sections\\Grupos.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[77,116],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Grupos.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { BadgeCheck, Crown, Target, Users } from \"lucide-react\";\r\n\r\nexport default function Grupos() {\r\n  const groups = [\r\n    {\r\n      name: \"Clientes frecuentes\",\r\n      desc: \"Visitan mas de 3 veces por mes\",\r\n      count: \"420\",\r\n      Icon: Crown,\r\n      tone: \"bg-amber-50 text-amber-600\",\r\n    },\r\n    {\r\n      name: \"Nuevos\",\r\n      desc: \"Primeras 2 semanas\",\r\n      count: \"180\",\r\n      Icon: Users,\r\n      tone: \"bg-sky-50 text-sky-600\",\r\n    },\r\n    {\r\n      name: \"VIP\",\r\n      desc: \"Top 5% en gasto\",\r\n      count: \"38\",\r\n      Icon: BadgeCheck,\r\n      tone: \"bg-emerald-50 text-emerald-600\",\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Segmentos de clientes\r\n          </div>\r\n          <div className=\"text-xs text-slate-500\">\r\n            Crea experiencias personalizadas y comunica con precision.\r\n          </div>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"rounded-xl bg-[#5E30A5] px-4 py-2 text-xs font-semibold text-white shadow-sm transition hover:bg-[#4B2488]\"\r\n        >\r\n          Crear grupo\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"grid gap-4 lg:grid-cols-3\">\r\n        {groups.map((group) => (\r\n          <motion.div\r\n            key={group.name}\r\n            whileHover={{ y: -2 }}\r\n            className=\"rounded-xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className={`rounded-xl px-2.5 py-1 text-xs font-semibold ${group.tone}`}>\r\n                <group.Icon size={16} />\r\n              </div>\r\n              <div className=\"text-lg font-bold text-[#2F1A55]\">\r\n                {group.count}\r\n              </div>\r\n            </div>\r\n            <div className=\"mt-3 text-sm font-semibold text-[#2F1A55]\">\r\n              {group.name}\r\n            </div>\r\n            <div className=\"text-xs text-slate-500\">{group.desc}</div>\r\n            <div className=\"mt-4 h-2 w-full rounded-full bg-slate-100\">\r\n              <div className=\"h-2 w-2/3 rounded-full bg-[#5E30A5]/60\" />\r\n            </div>\r\n          </motion.div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-4\">\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n          <Target size={16} />\r\n          Reglas sugeridas\r\n        </div>\r\n        <div className=\"mt-3 grid gap-3 sm:grid-cols-2\">\r\n          {[\r\n            \"Clientes con 3 visitas en 30 dias\",\r\n            \"Ticket promedio mayor a $25\",\r\n            \"Sin compra en los ultimos 14 dias\",\r\n            \"Invitar amigos recientes\",\r\n          ].map((rule) => (\r\n            <div\r\n              key={rule}\r\n              className=\"rounded-lg border border-[#E9E2F7] bg-white px-3 py-2 text-xs text-slate-500\"\r\n            >\r\n              {rule}\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\gestionar\\sections\\Metricas.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[79,118],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Metricas.jsx\r\nimport React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { ArrowUpRight, BarChart3, DollarSign, Sparkles, Ticket, Users } from \"lucide-react\";\r\n\r\nexport default function Metricas() {\r\n  const kpis = [\r\n    {\r\n      label: \"Promos activas\",\r\n      value: \"12\",\r\n      delta: \"+8%\",\r\n      Icon: Ticket,\r\n    },\r\n    {\r\n      label: \"Visitas hoy\",\r\n      value: \"1,240\",\r\n      delta: \"+12%\",\r\n      Icon: BarChart3,\r\n    },\r\n    {\r\n      label: \"Referidos\",\r\n      value: \"86\",\r\n      delta: \"+5%\",\r\n      Icon: Users,\r\n    },\r\n    {\r\n      label: \"Ingresos\",\r\n      value: \"$2,840\",\r\n      delta: \"+3%\",\r\n      Icon: DollarSign,\r\n    },\r\n  ];\r\n\r\n  const bars = [40, 65, 55, 80, 48, 72, 60];\r\n  const topPromos = [\r\n    { name: \"2x1 Almuerzos\", share: 68 },\r\n    { name: \"Happy Hour\", share: 52 },\r\n    { name: \"Combo Familiar\", share: 41 },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n        {kpis.map((item) => (\r\n          <motion.div\r\n            key={item.label}\r\n            whileHover={{ y: -2 }}\r\n            className=\"rounded-xl border border-[#E9E2F7] bg-[#F8F5FF] p-4 shadow-sm\"\r\n          >\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"rounded-xl bg-white p-2 text-[#5E30A5] shadow-sm\">\r\n                <item.Icon size={18} />\r\n              </div>\r\n              <div className=\"inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2 py-0.5 text-[11px] font-semibold text-emerald-600\">\r\n                {item.delta}\r\n                <ArrowUpRight size={12} />\r\n              </div>\r\n            </div>\r\n            <div className=\"mt-3 text-2xl font-bold text-[#2F1A55]\">\r\n              {item.value}\r\n            </div>\r\n            <div className=\"text-xs text-slate-500\">{item.label}</div>\r\n          </motion.div>\r\n        ))}\r\n      </div>\r\n\r\n      <div className=\"grid gap-4 lg:grid-cols-[1.4fr_1fr]\">\r\n        <div className=\"rounded-xl border border-[#E9E2F7] bg-white p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                Rendimiento semanal\r\n              </div>\r\n              <div className=\"text-xs text-slate-500\">Ultimos 7 dias</div>\r\n            </div>\r\n            <div className=\"flex items-center gap-1 text-xs text-[#5E30A5]\">\r\n              <Sparkles size={14} />\r\n              Tendencia positiva\r\n            </div>\r\n          </div>\r\n          <div className=\"mt-4 grid h-24 grid-cols-7 items-end gap-2\">\r\n            {bars.map((height, index) => (\r\n              <div\r\n                key={`${height}-${index}`}\r\n                className=\"rounded-lg border border-[#5E30A5]/20 bg-[#5E30A5]/15\"\r\n                style={{ height: `${height}%` }}\r\n              />\r\n            ))}\r\n          </div>\r\n          <div className=\"mt-3 text-xs text-slate-500\">\r\n            32% mas conversion que la semana pasada.\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-[#E9E2F7] bg-white p-4\">\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Top promociones\r\n          </div>\r\n          <div className=\"mt-3 space-y-3\">\r\n            {topPromos.map((promo) => (\r\n              <div key={promo.name} className=\"space-y-1\">\r\n                <div className=\"flex items-center justify-between text-xs\">\r\n                  <span className=\"font-semibold text-slate-600\">\r\n                    {promo.name}\r\n                  </span>\r\n                  <span className=\"text-slate-400\">{promo.share}%</span>\r\n                </div>\r\n                <div className=\"h-2 w-full rounded-full bg-slate-100\">\r\n                  <div\r\n                    className=\"h-2 rounded-full bg-[#5E30A5]/60\"\r\n                    style={{ width: `${promo.share}%` }}\r\n                  />\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\gestionar\\sections\\Seguridad.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[94,133],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/gestionar/sections/Seguridad.jsx\r\nimport React, { useState } from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { KeyRound, Lock, ShieldCheck, Smartphone } from \"lucide-react\";\r\n\r\nexport default function Seguridad() {\r\n  const [settings, setSettings] = useState({\r\n    twoFactor: true,\r\n    loginAlerts: true,\r\n    deviceLock: false,\r\n  });\r\n\r\n  const toggle = (key) => {\r\n    setSettings((prev) => ({ ...prev, [key]: !prev[key] }));\r\n  };\r\n\r\n  const rows = [\r\n    {\r\n      key: \"twoFactor\",\r\n      title: \"Autenticacion en dos pasos\",\r\n      desc: \"Protege accesos sensibles con verificacion extra.\",\r\n      Icon: ShieldCheck,\r\n    },\r\n    {\r\n      key: \"loginAlerts\",\r\n      title: \"Alertas de inicio de sesion\",\r\n      desc: \"Recibe notificaciones ante accesos nuevos.\",\r\n      Icon: Smartphone,\r\n    },\r\n    {\r\n      key: \"deviceLock\",\r\n      title: \"Bloqueo de dispositivos\",\r\n      desc: \"Solicita PIN en terminales del negocio.\",\r\n      Icon: Lock,\r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n            Seguridad y accesos\r\n          </div>\r\n          <div className=\"text-xs text-slate-500\">\r\n            Ajusta permisos y monitorea actividad en tiempo real.\r\n          </div>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"rounded-xl border border-[#E9E2F7] bg-white px-3 py-2 text-xs font-semibold text-[#5E30A5] shadow-sm\"\r\n        >\r\n          Revisar permisos\r\n        </button>\r\n      </div>\r\n\r\n      <div className=\"grid gap-3\">\r\n        {rows.map((row) => {\r\n          const enabled = settings[row.key];\r\n          return (\r\n            <motion.div\r\n              key={row.key}\r\n              whileHover={{ y: -2 }}\r\n              className=\"flex items-center justify-between rounded-xl border border-[#E9E2F7] bg-white p-4 shadow-sm\"\r\n            >\r\n              <div className=\"flex items-start gap-3\">\r\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-[#F8F5FF] text-[#5E30A5]\">\r\n                  <row.Icon size={18} />\r\n                </div>\r\n                <div>\r\n                  <div className=\"text-sm font-semibold text-[#2F1A55]\">\r\n                    {row.title}\r\n                  </div>\r\n                  <div className=\"text-xs text-slate-500\">{row.desc}</div>\r\n                </div>\r\n              </div>\r\n\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => toggle(row.key)}\r\n                className={`relative h-6 w-11 rounded-full transition ${\r\n                  enabled ? \"bg-[#5E30A5]\" : \"bg-slate-200\"\r\n                }`}\r\n                aria-pressed={enabled}\r\n              >\r\n                <span\r\n                  className={`absolute top-0.5 h-5 w-5 rounded-full bg-white shadow-sm transition ${\r\n                    enabled ? \"translate-x-5\" : \"translate-x-0.5\"\r\n                  }`}\r\n                />\r\n              </button>\r\n            </motion.div>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      <div className=\"rounded-xl border border-[#E9E2F7] bg-[#F9F7FF] p-4\">\r\n        <div className=\"flex items-center gap-2 text-sm font-semibold text-[#2F1A55]\">\r\n          <KeyRound size={16} />\r\n          Accesos recientes\r\n        </div>\r\n        <div className=\"mt-3 space-y-3 text-xs text-slate-500\">\r\n          <div className=\"flex items-center justify-between rounded-lg border border-[#E9E2F7] bg-white px-3 py-2\">\r\n            <span>Panel web - Quito, EC</span>\r\n            <span>Hace 3 min</span>\r\n          </div>\r\n          <div className=\"flex items-center justify-between rounded-lg border border-[#E9E2F7] bg-white px-3 py-2\">\r\n            <span>Tablet cocina - Guayaquil</span>\r\n            <span>Hace 2 horas</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\hooks\\useNegocioUI.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\InicioBeneficios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\InicioEmptyState.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\InicioHero.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":2,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[28,67],"text":""},"desc":"Remove unused variable 'motion'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { motion } from \"framer-motion\";\r\nimport {\r\n  BarChart3,\r\n  Crown,\r\n  LayoutGrid,\r\n  MapPin,\r\n  PlusCircle,\r\n  Store,\r\n} from \"lucide-react\";\r\nimport { Link } from \"react-router-dom\";\r\nimport negocioFallback from \"../../assets/bg-home.png\";\r\nimport {\r\n  getNegocioDireccion,\r\n  getNegocioImagen,\r\n  getNegocioNombre,\r\n  getNegocioPlanMeta,\r\n  getNegocioRoleLabel,\r\n  getNegocioSector,\r\n} from \"../services/negocioUI\";\r\n\r\nexport default function InicioHero({ usuario, negocio, stats }) {\r\n  const planMeta = getNegocioPlanMeta({ negocio, usuario });\r\n  const nombre = getNegocioNombre({ negocio, usuario });\r\n  const sector = getNegocioSector({ negocio, usuario });\r\n  const direccion = getNegocioDireccion({ negocio, usuario });\r\n  const imagen = getNegocioImagen({ negocio, usuario }) || negocioFallback;\r\n  const roleLabel = getNegocioRoleLabel(usuario);\r\n  const hasImage = Boolean(imagen);\r\n  const safeStats = stats || { activas: 0, pendientes: 0, inactivas: 0 };\r\n\r\n  return (\r\n    <motion.section\r\n      initial={{ opacity: 0, y: 12 }}\r\n      animate={{ opacity: 1, y: 0 }}\r\n      transition={{ duration: 0.6 }}\r\n      className=\"pt-0\"\r\n      data-hero-container\r\n    >\r\n      <div className=\"hero-bleed text-white shadow-sm\">\r\n        <div className=\"relative z-10 max-w-6xl mx-auto px-4 pb-5 pt-2\">\r\n          <div className=\"relative\">\r\n            <div className=\"relative flex flex-col gap-4\">\r\n              <div className=\"flex items-start gap-4\">\r\n                <div className=\"relative h-16 w-16 rounded-2xl border border-white/20 bg-white/10 overflow-hidden flex items-center justify-center\">\r\n                  {hasImage ? (\r\n                    <img\r\n                      src={imagen}\r\n                      alt={`Logo de ${nombre}`}\r\n                      className=\"h-full w-full object-cover\"\r\n                    />\r\n                  ) : (\r\n                    <Store size={28} className=\"text-white/70\" />\r\n                  )}\r\n                </div>\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <div className=\"flex items-center justify-between gap-2\">\r\n                    <h1 className=\"text-xl font-semibold leading-tight text-white\">\r\n                      {nombre}\r\n                    </h1>\r\n                    <span\r\n                      className=\"inline-flex items-center whitespace-nowrap rounded-xl border border-white/15 bg-[#3B1A66] px-[clamp(12px,4vw,20px)] py-[clamp(12px,3vw,14px)] text-[clamp(9px,2.4vw,12px)] font-semibold uppercase tracking-[0.18em] leading-none text-white min-w-0 shrink\"\r\n                      style={{ mixBlendMode: \"screen\", opacity: 0.92 }}\r\n                    >\r\n                      {roleLabel}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-white/75\">\r\n                    <span className=\"inline-flex items-center gap-1\">\r\n                      <Store size={12} />\r\n                      {sector}\r\n                    </span>\r\n                    <span className=\"inline-flex items-center gap-1\">\r\n                      <MapPin size={12} />\r\n                      {direccion}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n                <div className=\"hidden sm:flex flex-col items-end gap-2 text-right\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"rounded-full border border-white/20 bg-white/10 px-3 py-1 text-[11px] font-semibold text-white/90\">\r\n                      Plan {planMeta.label}\r\n                    </span>\r\n                    <Link\r\n                      to=\"/negocio/perfil?tab=plan\"\r\n                      className=\"text-[10px] font-semibold uppercase tracking-[0.18em] text-white/75 hover:text-white\"\r\n                    >\r\n                      Ver beneficios\r\n                    </Link>\r\n                  </div>\r\n                  <Link\r\n                    to=\"/negocio/perfil?tab=plan\"\r\n                    className=\"inline-flex items-center gap-1 rounded-full border border-white/30 bg-white/10 px-3 py-1 text-[10px] font-semibold text-white/90 transition hover:bg-white/20\"\r\n                  >\r\n                    <Crown size={12} className=\"text-[#FFC21C]\" />\r\n                    Mejorar\r\n                  </Link>\r\n                </div>\r\n              </div>\r\n              <div className=\"flex items-center justify-between gap-2 text-[11px] text-white/75 sm:hidden\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-3 py-1 text-[11px] font-semibold text-white/90\">\r\n                    Plan {planMeta.label}\r\n                  </span>\r\n                  <Link\r\n                    to=\"/negocio/perfil?tab=plan\"\r\n                    className=\"text-[10px] font-semibold uppercase tracking-[0.18em] text-white/75 hover:text-white\"\r\n                  >\r\n                    Ver beneficios\r\n                  </Link>\r\n                </div>\r\n                <Link\r\n                  to=\"/negocio/perfil?tab=plan\"\r\n                  className=\"inline-flex items-center gap-1 rounded-full border border-white/30 bg-white/10 px-3 py-1 text-[10px] font-semibold text-white/90 transition hover:bg-white/20\"\r\n                >\r\n                  <Crown size={12} className=\"text-[#FFC21C]\" />\r\n                  Mejorar\r\n                </Link>\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-3 gap-2 text-center\">\r\n                <div className=\"rounded-2xl border border-white/15 bg-white/10 px-3 py-2\">\r\n                  <div className=\"text-[10px] uppercase tracking-[0.2em] text-white/60\">\r\n                    Activas\r\n                  </div>\r\n                  <div className=\"text-lg font-semibold text-white\">\r\n                    {safeStats.activas}\r\n                  </div>\r\n                </div>\r\n                <div className=\"rounded-2xl border border-white/15 bg-white/10 px-3 py-2\">\r\n                  <div className=\"text-[10px] uppercase tracking-[0.2em] text-white/60\">\r\n                    Pendientes\r\n                  </div>\r\n                  <div className=\"text-lg font-semibold text-white\">\r\n                    {safeStats.pendientes}\r\n                  </div>\r\n                </div>\r\n                <div className=\"rounded-2xl border border-white/15 bg-white/10 px-3 py-2\">\r\n                  <div className=\"text-[10px] uppercase tracking-[0.2em] text-white/60\">\r\n                    Inactivas\r\n                  </div>\r\n                  <div className=\"text-lg font-semibold text-white\">\r\n                    {safeStats.inactivas}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex flex-col items-center gap-3 pt-1\">\r\n                <div className=\"flex justify-center\">\r\n                  <Link\r\n                    to=\"/negocio/gestionar\"\r\n                    className=\"inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-xs font-semibold text-[#5E30A5] shadow-sm transition hover:bg-[#F3EEFF]\"\r\n                  >\r\n                    <PlusCircle size={14} />\r\n                    Crear promo\r\n                  </Link>\r\n                </div>\r\n                <div className=\"flex flex-wrap justify-center gap-3\">\r\n                  <Link\r\n                    to=\"/negocio/gestionar\"\r\n                    className=\"inline-flex items-center gap-2 rounded-xl border border-white/30 bg-white/10 px-4 py-2 text-xs font-semibold text-white\"\r\n                  >\r\n                    <LayoutGrid size={14} />\r\n                    Gestionar\r\n                  </Link>\r\n                  <Link\r\n                    to=\"/negocio/gestionar\"\r\n                    className=\"inline-flex items-center gap-2 rounded-xl border border-white/30 bg-white/10 px-4 py-2 text-xs font-semibold text-white\"\r\n                  >\r\n                    <BarChart3 size={14} />\r\n                    Ver metricas\r\n                  </Link>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </motion.section>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\InicioKPIs.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\InicioPromos.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\InicioPromosPreview.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":4,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":4,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport InicioPromos from \"./InicioPromos\";\r\n\r\nexport const MOCK_PROMOS = [\r\n  {\r\n    id: \"negocio-mock-1\",\r\n    titulo: \"Descuento en almuerzos ejecutivos\",\r\n    descripcion: \"Aplica de lunes a viernes hasta las 15h.\",\r\n    estado: \"activo\",\r\n    fechacreacion: \"2026-01-05\",\r\n  },\r\n  {\r\n    id: \"negocio-mock-2\",\r\n    titulo: \"2x1 en bebidas frias\",\r\n    descripcion: \"Happy hour desde las 16h.\",\r\n    estado: \"pendiente\",\r\n    fechacreacion: \"2026-01-03\",\r\n  },\r\n  {\r\n    id: \"negocio-mock-3\",\r\n    titulo: \"Combo familiar\",\r\n    descripcion: \"Ideal para grupos de 4 personas.\",\r\n    estado: \"activo\",\r\n    fechacreacion: \"2026-01-02\",\r\n  },\r\n  {\r\n    id: \"negocio-mock-4\",\r\n    titulo: \"Promo desayuno\",\r\n    descripcion: \"Cafe + sandwich a precio especial.\",\r\n    estado: \"inactivo\",\r\n    fechacreacion: \"2025-12-28\",\r\n  },\r\n  {\r\n    id: \"negocio-mock-5\",\r\n    titulo: \"Postres de temporada\",\r\n    descripcion: \"Agrega un postre con 20% off.\",\r\n    estado: \"activo\",\r\n    fechacreacion: \"2025-12-20\",\r\n  },\r\n];\r\n\r\nexport default function InicioPromosPreview() {\r\n  return <InicioPromos promos={MOCK_PROMOS} />;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\InicioSkeleton.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\inicio\\NegocioInicio.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\layout\\NegocioFooter.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[147,186],"text":""},"desc":"Remove unused variable 'motion'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'Icon' is defined but never used.","line":34,"column":36,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":40,"suggestions":[{"messageId":"removeVar","data":{"varName":"Icon"},"fix":{"range":[1395,1401],"text":""},"desc":"Remove unused variable 'Icon'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { Link, useLocation } from \"react-router-dom\";\r\nimport { Home, LayoutGrid, QrCode, User } from \"lucide-react\";\r\nimport { motion } from \"framer-motion\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\n\r\nexport default function NegocioFooter() {\r\n  const location = useLocation();\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (!usuario || !onboarding?.allowAccess) return null;\r\n  if (usuario?.role !== \"negocio\") return null;\r\n\r\n  const links = [\r\n    { path: \"/negocio/inicio\", label: \"Inicio\", Icon: Home },\r\n    { path: \"/negocio/escanear\", label: \"Escanear\", Icon: QrCode },\r\n    { path: \"/negocio/gestionar\", label: \"Gestionar\", Icon: LayoutGrid },\r\n    { path: \"/negocio/perfil\", label: \"Perfil\", Icon: User },\r\n  ];\r\n\r\n  const isActive = (path) =>\r\n    location.pathname === path ||\r\n    (path === \"/negocio/inicio\" && location.pathname.startsWith(\"/negocio/inicio\"));\r\n\r\n  return (\r\n    <nav\r\n      className=\"md:hidden fixed bottom-0 left-0 right-0 z-50 border-t border-[#E9E2F7] bg-white\"\r\n      style={{ paddingBottom: \"env(safe-area-inset-bottom)\" }}\r\n    >\r\n      <div className=\"flex items-center justify-around py-2\">\r\n        {links.map(({ path, label, Icon }) => {\r\n          const active = isActive(path);\r\n          return (\r\n            <Link\r\n              key={path}\r\n              to={path}\r\n              className=\"relative flex flex-col items-center text-[11px] font-medium\"\r\n            >\r\n              <motion.div\r\n                initial={false}\r\n                animate={{\r\n                  scale: active ? 1.15 : 1,\r\n                  color: active ? \"#5E30A5\" : \"#94A3B8\",\r\n                }}\r\n                transition={{ type: \"spring\", stiffness: 260, damping: 18 }}\r\n              >\r\n                <Icon size={20} />\r\n              </motion.div>\r\n              <motion.span\r\n                className=\"mt-1\"\r\n                animate={{\r\n                  opacity: active ? 1 : 0.7,\r\n                  color: active ? \"#5E30A5\" : \"#94A3B8\",\r\n                }}\r\n              >\r\n                {label}\r\n              </motion.span>\r\n              {active && (\r\n                <motion.div\r\n                  layoutId=\"negocioActiveIndicator\"\r\n                  className=\"absolute -bottom-1 h-1 w-8 rounded-full bg-[#5E30A5]\"\r\n                  transition={{ type: \"spring\", stiffness: 240, damping: 18 }}\r\n                />\r\n              )}\r\n            </Link>\r\n          );\r\n        })}\r\n      </div>\r\n    </nav>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\layout\\NegocioHeader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\layout\\NegocioHeaderContext.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":90,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":90,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, {\r\n  createContext,\r\n  useCallback,\r\n  useContext,\r\n  useEffect,\r\n  useMemo,\r\n  useRef,\r\n  useState,\r\n} from \"react\";\r\n\r\nconst NegocioHeaderContext = createContext({\r\n  mode: \"default\",\r\n  onSearchBack: null,\r\n  headerVisible: true,\r\n  headerEntering: false,\r\n  profileDockOpen: true,\r\n  profileTitle: \"Configuracion\",\r\n  setHeaderOptions: () => {},\r\n});\r\n\r\nexport function NegocioHeaderProvider({ children }) {\r\n  const [mode, setMode] = useState(\"default\");\r\n  const [onSearchBack, setOnSearchBack] = useState(null);\r\n  const [headerVisible, setHeaderVisible] = useState(true);\r\n  const [headerEntering, setHeaderEntering] = useState(false);\r\n  const [profileDockOpen, setProfileDockOpen] = useState(true);\r\n  const [profileTitle, setProfileTitle] = useState(\"Configuracion\");\r\n  const prevHeaderVisible = useRef(headerVisible);\r\n\r\n  const setHeaderOptions = useCallback((options = {}) => {\r\n    const nextMode = options.mode || \"default\";\r\n    setMode(nextMode);\r\n    setOnSearchBack(() => options.onSearchBack || null);\r\n    const nextHeaderVisible =\r\n      typeof options.headerVisible === \"boolean\" ? options.headerVisible : true;\r\n    setHeaderVisible(nextHeaderVisible);\r\n    if (typeof options.profileDockOpen === \"boolean\") {\r\n      setProfileDockOpen(options.profileDockOpen);\r\n    }\r\n    if (typeof options.profileTitle === \"string\") {\r\n      setProfileTitle(options.profileTitle);\r\n    }\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const wasVisible = prevHeaderVisible.current;\r\n    if (!wasVisible && headerVisible) {\r\n      setHeaderEntering(true);\r\n      const timer = setTimeout(() => {\r\n        setHeaderEntering(false);\r\n      }, 360);\r\n      prevHeaderVisible.current = headerVisible;\r\n      return () => clearTimeout(timer);\r\n    }\r\n    if (!headerVisible) {\r\n      setHeaderEntering(false);\r\n    }\r\n    prevHeaderVisible.current = headerVisible;\r\n    return undefined;\r\n  }, [headerVisible]);\r\n\r\n  const value = useMemo(\r\n    () => ({\r\n      mode,\r\n      onSearchBack,\r\n      headerVisible,\r\n      headerEntering,\r\n      profileDockOpen,\r\n      profileTitle,\r\n      setHeaderOptions,\r\n    }),\r\n    [\r\n      mode,\r\n      onSearchBack,\r\n      headerVisible,\r\n      headerEntering,\r\n      profileDockOpen,\r\n      profileTitle,\r\n      setHeaderOptions,\r\n    ]\r\n  );\r\n\r\n  return (\r\n    <NegocioHeaderContext.Provider value={value}>\r\n      {children}\r\n    </NegocioHeaderContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useNegocioHeader() {\r\n  return useContext(NegocioHeaderContext);\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\layout\\NegocioLayout.jsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'setAccessMethods' and 'setUser'. Either include them or remove the dependency array.","line":240,"column":6,"nodeType":"ArrayExpression","endLine":240,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [bootstrap, usuario, openModal, setAccessMethods, setUser]","fix":{"range":[9041,9072],"text":"[bootstrap, usuario, openModal, setAccessMethods, setUser]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from \"react\";\r\nimport { Outlet, useLocation } from \"react-router-dom\";\r\nimport NegocioHeader from \"./NegocioHeader\";\r\nimport NegocioFooter from \"./NegocioFooter\";\r\nimport MenuLateral from \"../../components/menus/MenuLateral\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport { getAvatarSrc } from \"../services/negocioUI\";\r\nimport { NegocioHeaderProvider, useNegocioHeader } from \"./NegocioHeaderContext\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport {\r\n  getSecureStorageMode,\r\n  loadBiometricToken,\r\n  loadPinHash,\r\n} from \"../../services/secureStorageService\";\r\nimport CacheOutlet from \"../../cache/CacheOutlet\";\r\nimport { useCacheStore } from \"../../cache/cacheStore\";\r\nimport { CACHE_KEYS } from \"../../cache/cacheKeys\";\r\nimport NegocioInicioBase from \"../base/NegocioInicioBase\";\r\nimport NegocioEscanerBase from \"../base/NegocioEscanerBase\";\r\nimport NegocioGestionarBase from \"../base/NegocioGestionarBase\";\r\nimport NegocioPerfilBase from \"../base/NegocioPerfilBase\";\r\n\r\nconst FALLBACK_HEADER_HEIGHT = 76;\r\n\r\nfunction NegocioLayoutInner({ children }) {\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const bootstrap = useAppStore((s) => s.bootstrap);\r\n  const logout = useAppStore((s) => s.logout);\r\n  const setAccessMethods = useAppStore((s) => s.setAccessMethods);\r\n  const setUser = useAppStore((s) => s.setUser);\r\n  const { openModal } = useModal();\r\n\r\n  const [menuOpen, setMenuOpen] = useState(false);\r\n  const [headerHeight, setHeaderHeight] = useState(FALLBACK_HEADER_HEIGHT);\r\n  const [headerElevated, setHeaderElevated] = useState(false);\r\n  const [viewportMetrics, setViewportMetrics] = useState({\r\n    height: 0,\r\n    offsetTop: 0,\r\n  });\r\n  const rootRef = useRef(null);\r\n  const headerRef = useRef(null);\r\n  const mainRef = useRef(null);\r\n  const { mode, headerVisible, headerEntering } = useNegocioHeader();\r\n  const location = useLocation();\r\n  const suspendViewportResize = useAppStore(\r\n    (state) => state.suspendViewportResize\r\n  );\r\n  const suspendViewportAfterNext = useAppStore(\r\n    (state) => state.suspendViewportAfterNext\r\n  );\r\n  const setSuspendViewportResize = useAppStore(\r\n    (state) => state.setSuspendViewportResize\r\n  );\r\n  const setSuspendViewportAfterNext = useAppStore(\r\n    (state) => state.setSuspendViewportAfterNext\r\n  );\r\n  const activeCacheKey = useCacheStore(\r\n    (state) => state.activeKeys.negocio || null\r\n  );\r\n  const preloadScope = useCacheStore((state) => state.preloadScope);\r\n  const isPreloaded = useCacheStore(\r\n    (state) => Boolean(state.preloadedScopes.negocio)\r\n  );\r\n  const setScrollPosition = useCacheStore((state) => state.setScrollPosition);\r\n  const getScrollPosition = useCacheStore((state) => state.getScrollPosition);\r\n\r\n  const cacheEntries = useMemo(\r\n    () => [\r\n      { key: CACHE_KEYS.NEGOCIO_INICIO, element: <NegocioInicioBase /> },\r\n      { key: CACHE_KEYS.NEGOCIO_ESCANEAR, element: <NegocioEscanerBase /> },\r\n      { key: CACHE_KEYS.NEGOCIO_GESTIONAR, element: <NegocioGestionarBase /> },\r\n      { key: CACHE_KEYS.NEGOCIO_PERFIL, element: <NegocioPerfilBase /> },\r\n    ],\r\n    []\r\n  );\r\n  const useCache = children == null;\r\n  const fallbackPath = \"/negocio/inicio\";\r\n  const hideUntilPreloaded =\r\n    useCache && !isPreloaded && location.pathname !== fallbackPath;\r\n\r\n  useLayoutEffect(() => {\r\n    if (!useCache) return;\r\n    if (isPreloaded) return;\r\n    preloadScope(\"negocio\", cacheEntries);\r\n  }, [cacheEntries, isPreloaded, preloadScope, useCache]);\r\n\r\n  const updateHeaderHeight = useCallback(() => {\r\n    if (!headerVisible) {\r\n      setHeaderHeight(0);\r\n      return;\r\n    }\r\n    if (!headerRef.current) {\r\n      setHeaderHeight(FALLBACK_HEADER_HEIGHT);\r\n      return;\r\n    }\r\n    setHeaderHeight(headerRef.current.offsetHeight || FALLBACK_HEADER_HEIGHT);\r\n  }, [headerVisible]);\r\n\r\n  useLayoutEffect(() => {\r\n    updateHeaderHeight();\r\n    let observer;\r\n    if (\r\n      headerVisible &&\r\n      typeof ResizeObserver !== \"undefined\" &&\r\n      headerRef.current\r\n    ) {\r\n      observer = new ResizeObserver(() => updateHeaderHeight());\r\n      observer.observe(headerRef.current);\r\n    } else if (headerVisible) {\r\n      window.addEventListener(\"resize\", updateHeaderHeight);\r\n    }\r\n    return () => {\r\n      if (observer) {\r\n        observer.disconnect();\r\n      } else if (headerVisible) {\r\n        window.removeEventListener(\"resize\", updateHeaderHeight);\r\n      }\r\n    };\r\n  }, [headerVisible, updateHeaderHeight]);\r\n\r\n  useEffect(() => {\r\n    const updateViewport = () => {\r\n      if (suspendViewportResize) return;\r\n      const vv = window.visualViewport;\r\n      const height = vv?.height ?? window.innerHeight;\r\n      const offsetTop = vv?.offsetTop ?? 0;\r\n      setViewportMetrics((prev) =>\r\n        prev.height === height && prev.offsetTop === offsetTop\r\n          ? prev\r\n          : { height, offsetTop }\r\n      );\r\n      if (suspendViewportAfterNext) {\r\n        setSuspendViewportAfterNext(false);\r\n        setSuspendViewportResize(true);\r\n      }\r\n    };\r\n    updateViewport();\r\n    window.visualViewport?.addEventListener(\"resize\", updateViewport);\r\n    window.visualViewport?.addEventListener(\"scroll\", updateViewport);\r\n    window.addEventListener(\"resize\", updateViewport);\r\n    return () => {\r\n      window.visualViewport?.removeEventListener(\"resize\", updateViewport);\r\n      window.visualViewport?.removeEventListener(\"scroll\", updateViewport);\r\n      window.removeEventListener(\"resize\", updateViewport);\r\n    };\r\n  }, [\r\n    setSuspendViewportAfterNext,\r\n    setSuspendViewportResize,\r\n    suspendViewportAfterNext,\r\n    suspendViewportResize,\r\n  ]);\r\n\r\n  const updateHeaderElevation = useCallback(() => {\r\n    const mainTop = mainRef.current?.scrollTop || 0;\r\n    const docTop =\r\n      document.scrollingElement?.scrollTop || window.scrollY || 0;\r\n    const next = mainTop > 0 || docTop > 0;\r\n    setHeaderElevated((prev) => (prev === next ? prev : next));\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    updateHeaderElevation();\r\n    const current = mainRef.current;\r\n    if (current) {\r\n      current.addEventListener(\"scroll\", updateHeaderElevation, {\r\n        passive: true,\r\n      });\r\n    }\r\n    window.addEventListener(\"scroll\", updateHeaderElevation, {\r\n      passive: true,\r\n    });\r\n    return () => {\r\n      if (current) {\r\n        current.removeEventListener(\"scroll\", updateHeaderElevation);\r\n      }\r\n      window.removeEventListener(\"scroll\", updateHeaderElevation);\r\n    };\r\n  }, [updateHeaderElevation]);\r\n\r\n  useEffect(() => {\r\n    const current = mainRef.current;\r\n    if (!current || !activeCacheKey) return undefined;\r\n    const handleScroll = () => {\r\n      setScrollPosition(activeCacheKey, current.scrollTop);\r\n    };\r\n    current.addEventListener(\"scroll\", handleScroll, { passive: true });\r\n    return () => {\r\n      current.removeEventListener(\"scroll\", handleScroll);\r\n    };\r\n  }, [activeCacheKey, setScrollPosition]);\r\n\r\n  useEffect(() => {\r\n    const current = mainRef.current;\r\n    if (!current || !activeCacheKey) return;\r\n    const targetTop = getScrollPosition(activeCacheKey);\r\n    current.scrollTop = targetTop;\r\n    document.activeElement?.blur();\r\n  }, [activeCacheKey, getScrollPosition]);\r\n\r\n  useEffect(() => {\r\n    if (bootstrap || !usuario) return;\r\n    if (typeof window === \"undefined\") return;\r\n    let active = true;\r\n    (async () => {\r\n      const storageMode = await getSecureStorageMode();\r\n      if (!active || storageMode.mode === \"blocked\") return;\r\n      const { data } = await supabase.auth.getSession();\r\n      const token = data?.session?.access_token;\r\n      if (!active || !token) return;\r\n      const userId = data?.session?.user?.id ?? null;\r\n      if (!userId) return;\r\n      const skipKey = `access_methods_prompt_skip_${usuario.id || usuario.id_auth || \"user\"}`;\r\n      const localPin = await loadPinHash(userId);\r\n      const localBio = await loadBiometricToken(userId);\r\n      if (!active) return;\r\n      const nextPin = Boolean(localPin);\r\n      const nextBio = Boolean(localBio);\r\n      setAccessMethods({ pin: nextPin, fingerprint: nextBio });\r\n      const updates = {};\r\n      if (usuario.has_pin !== nextPin) updates.has_pin = nextPin;\r\n      if (usuario.has_biometrics !== nextBio) updates.has_biometrics = nextBio;\r\n      if (Object.keys(updates).length) {\r\n        await supabase.from(\"usuarios\").update(updates).eq(\"id_auth\", userId);\r\n        if (active) {\r\n          setUser({ ...usuario, ...updates });\r\n        }\r\n      }\r\n      if (window.localStorage.getItem(skipKey) === \"1\") return;\r\n      if (localPin || localBio) return;\r\n      const key = `access_methods_prompt_token_${usuario.id || usuario.id_auth || \"user\"}`;\r\n      const lastToken = window.sessionStorage.getItem(key);\r\n      if (lastToken === token) return;\r\n      window.sessionStorage.setItem(key, token);\r\n      openModal(\"AccessMethods\");\r\n    })();\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, [bootstrap, usuario, openModal]);\r\n\r\n  if (bootstrap || typeof usuario === \"undefined\") return null;\r\n  if (hideUntilPreloaded) return null;\r\n\r\n  const viewportHeight = viewportMetrics.height;\r\n\r\n  return (\r\n    <div\r\n      ref={rootRef}\r\n      className=\"relative overflow-x-hidden\"\r\n      style={{\r\n        \"--negocio-bg\": \"#FAF8FF\",\r\n        \"--negocio-surface\": \"#FFFFFF\",\r\n        \"--negocio-ink\": \"#2F1A55\",\r\n        \"--negocio-accent\": \"#5E30A5\",\r\n        \"--negocio-accent-2\": \"#4B2488\",\r\n        \"--negocio-header-bg\": \"#5E30A5\",\r\n        \"--cliente-header-height\": `${headerHeight}px`,\r\n        \"--cliente-viewport-offset\": `${viewportMetrics.offsetTop}px`,\r\n        background: \"#FAF8FF\",\r\n        height: viewportHeight ? `${viewportHeight}px` : \"100dvh\",\r\n        minHeight: viewportHeight ? `${viewportHeight}px` : \"100vh\",\r\n        overflow: \"hidden\",\r\n      }}\r\n    >\r\n      <div className=\"relative flex h-full min-h-0 flex-col\">\r\n        {headerVisible ? (\r\n          <div\r\n            ref={headerRef}\r\n            className={`fixed left-0 right-0 z-40 ${\r\n              headerEntering ? \"cliente-merge-enter\" : \"\"\r\n            }`}\r\n            style={{ top: \"var(--cliente-viewport-offset, 0px)\" }}\r\n          >\r\n            <NegocioHeader\r\n              usuario={usuario}\r\n              avatarSrc={getAvatarSrc(usuario)}\r\n              onOpenMenu={() => setMenuOpen(true)}\r\n              isElevated={headerElevated}\r\n              onLogout={logout}\r\n            />\r\n          </div>\r\n        ) : null}\r\n\r\n        <main\r\n          ref={mainRef}\r\n          id=\"cliente-main-scroll\"\r\n          className={`hide-scrollbar transition-all duration-300 z-0 ${\r\n            menuOpen ? \"blur-sm\" : \"\"\r\n          }`}\r\n          style={{\r\n            position: \"fixed\",\r\n            top: \"var(--cliente-viewport-offset, 0px)\",\r\n            left: 0,\r\n            right: 0,\r\n            bottom: \"50px\",\r\n            paddingTop: headerHeight,\r\n            minHeight: 0,\r\n            overflowY: \"auto\",\r\n          }}\r\n        >\r\n          {useCache ? <CacheOutlet scope=\"negocio\" /> : children}\r\n          {useCache ? <Outlet /> : null}\r\n          <div\r\n            className=\"text-[10px] uppercase tracking-[0.3em] text-black/30\"\r\n            style={{ position: \"fixed\", bottom: 110, right: 16 }}\r\n          >\r\n            ALPHA v0.0.1\r\n          </div>\r\n        </main>\r\n\r\n        {mode !== \"search\" ? <NegocioFooter /> : null}\r\n\r\n        <MenuLateral\r\n          visible={menuOpen}\r\n          onClose={() => setMenuOpen(false)}\r\n          usuario={usuario}\r\n          logout={logout}\r\n        />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function NegocioLayout({ children }) {\r\n  return (\r\n    <NegocioHeaderProvider>\r\n      <NegocioLayoutInner>{children}</NegocioLayoutInner>\r\n    </NegocioHeaderProvider>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\services\\negocioUI.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\views\\NegocioEscanerView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\views\\NegocioGestionarView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\views\\NegocioInicioView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\negocio\\views\\NegocioPerfilView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\AppGate.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\AuthEntry.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\PromoDetalle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\Promos.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\RecuperarPassword.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminDatos.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminDevErrors.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminDocumentation.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminInicio.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminLegal.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminLogs.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminNegocios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminObservability.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminPrelaunchAnalytics.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminPromos.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminQRs.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminReportes.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminSistema.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminUsuarios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminUsuariosClientes.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminUsuariosNegocios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminVersioningOverview.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\admin\\AdminVersioningReleases.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\cliente\\ClienteEscaner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\cliente\\ClienteHistorial.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\cliente\\ClienteInicio.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\cliente\\ClientePerfil.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\negocio\\NegocioEscaner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\negocio\\NegocioGestionar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\negocio\\NegocioInicio.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\pages\\negocio\\NegocioPerfil.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\cliente\\ClientePerfil.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[150,158],"text":""},"desc":"Remove unused variable 'motion'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":137,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":137,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"navigate"},"fix":{"range":[5253,5284],"text":""},"desc":"Remove unused variable 'navigate'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'loadSessions'. Either include it or remove the dependency array.","line":304,"column":5,"nodeType":"ArrayExpression","endLine":310,"endColumn":6,"suggestions":[{"desc":"Update the dependencies array to be: [handleCloseAllSessions, handleCloseSession, loadSessions, sessions, sessionsError, sessionsLoading]","fix":{"range":[11324,11453],"text":"[handleCloseAllSessions, handleCloseSession, loadSessions, sessions, sessionsError, sessionsLoading]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'passwordAttempted' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":441,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":441,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"passwordAttempted"},"fix":{"range":[16108,16125],"text":""},"desc":"Remove unused variable 'passwordAttempted'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'requestLocalVerification', 'requestPasswordVerification', and 'setUser'. Either include them or remove the dependency array.","line":1078,"column":6,"nodeType":"ArrayExpression","endLine":1078,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [requestLocalVerification, requestPasswordVerification, setUser]","fix":{"range":[39155,39157],"text":"[requestLocalVerification, requestPasswordVerification, setUser]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'pushEnabled' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1144,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":1144,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"pushEnabled"},"fix":{"range":[41403,41414],"text":""},"desc":"Remove unused variable 'pushEnabled'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'PersonalDataPanel' function makes the dependencies of useMemo Hook (at line 1676) change on every render. Move it inside the useMemo callback. Alternatively, wrap the definition of 'PersonalDataPanel' in its own useCallback() Hook.","line":1425,"column":3,"nodeType":"FunctionDeclaration","endLine":1598,"endColumn":4},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initial'. Either include it or remove the dependency array.","line":1452,"column":8,"nodeType":"ArrayExpression","endLine":1458,"endColumn":6,"suggestions":[{"desc":"Update the dependencies array to be: [initial.nombres, initial.apellidos, initial.direccion, initial.email, initial.telefono, initial]","fix":{"range":[50852,50983],"text":"[initial.nombres, initial.apellidos, initial.direccion, initial.email, initial.telefono, initial]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'logout'. Either include it or remove the dependency array.","line":1715,"column":5,"nodeType":"ArrayExpression","endLine":1715,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [logout, setProfileTab]","fix":{"range":[59335,59350],"text":"[logout, setProfileTab]"}}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState, useCallback, useEffect, useRef } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport {\r\n  AlertTriangle,\r\n  Bell,\r\n  CreditCard,\r\n  Crown,\r\n  Fingerprint,\r\n  Globe,\r\n  HelpCircle,\r\n  IdCard,\r\n  KeyRound,\r\n  Laptop,\r\n  Link2,\r\n  LogOut,\r\n  MessageSquare,\r\n  Monitor,\r\n  Palette,\r\n  Sparkles,\r\n  ShieldCheck,\r\n  Smartphone,\r\n  Tablet,\r\n  RefreshCcw,\r\n  TriangleAlert,\r\n  Shield,\r\n  UserCircle,\r\n  X,\r\n} from \"lucide-react\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { useClienteUI } from \"../../cliente/hooks/useClienteUI\";\r\nimport usePinSetup from \"../../hooks/usePinSetup\";\r\nimport {\r\n  formatReadableDate,\r\n  formatCompactNumber,\r\n  getAvatarSrc,\r\n  getPlanFallback,\r\n  getRoleLabel,\r\n  getTierMeta,\r\n  getTierProgress,\r\n} from \"../../cliente/services/clienteUI\";\r\nimport ProfileTabs from \"../shared/ProfileTabs\";\r\nimport ProfilePanel from \"../shared/ProfilePanel\";\r\nimport {\r\n  HeaderPanelContainer,\r\n  SearchbarPanel,\r\n} from \"../../components/header-panels\";\r\nimport { useClienteHeader } from \"../../cliente/layout/ClienteHeaderContext\";\r\nimport { useCacheStore } from \"../../cache/cacheStore\";\r\nimport { CACHE_KEYS } from \"../../cache/cacheKeys\";\r\nimport ProfileOverview from \"../shared/sections/ProfileOverview\";\r\nimport PersonalData from \"../shared/sections/PersonalData\";\r\nimport Access from \"../shared/sections/Access\";\r\nimport LinkedAccounts from \"../shared/sections/LinkedAccounts\";\r\nimport TwoFA from \"../shared/sections/TwoFA\";\r\nimport Sessions from \"../shared/sections/Sessions\";\r\nimport Notifications from \"../shared/sections/Notifications\";\r\nimport Beneficios from \"../shared/sections/Beneficios\";\r\nimport ManageAccount from \"../shared/sections/ManageAccount\";\r\nimport AppAppearance from \"../shared/sections/AppAppearance\";\r\nimport Language from \"../shared/sections/Language\";\r\nimport Help from \"../shared/sections/Help\";\r\nimport SupportChat from \"../shared/sections/SupportChat\";\r\nimport SupportEmail from \"../shared/sections/SupportEmail\";\r\nimport Feedback from \"../shared/sections/Feedback\";\r\nimport AccountStatusCard from \"../shared/blocks/AccountStatusCard\";\r\nimport AliasCard from \"../shared/blocks/AliasCard\";\r\nimport BenefitsCard from \"../shared/blocks/BenefitsCard\";\r\nimport DangerZone from \"../shared/blocks/DangerZone\";\r\nimport ExploreTiersCard from \"../shared/blocks/ExploreTiersCard\";\r\nimport FingerprintAccessCard from \"../shared/blocks/FingerprintAccessCard\";\r\nimport FontSelector from \"../shared/blocks/FontSelector\";\r\nimport IdentityCard from \"../shared/blocks/IdentityCard\";\r\nimport LanguageSelector from \"../shared/blocks/LanguageSelector\";\r\nimport LinkedAccountsCard from \"../shared/blocks/LinkedAccountsCard\";\r\nimport PasswordAccessCard from \"../shared/blocks/PasswordAccessCard\";\r\nimport PinAccessCard from \"../shared/blocks/PinAccessCard\";\r\nimport PersonalDataBlock from \"../shared/blocks/PersonalDataBlock\";\r\nimport TierCurrentCard from \"../shared/blocks/TierCurrentCard\";\r\nimport TierNextCard from \"../shared/blocks/TierNextCard\";\r\nimport SessionsList from \"../shared/blocks/SessionsList\";\r\nimport ThemeSelector from \"../shared/blocks/ThemeSelector\";\r\nimport TwoFACard from \"../shared/blocks/TwoFACard\";\r\nimport useMfaState from \"../shared/hooks/useMfaState\";\r\nimport SupportHelpOptions from \"../shared/blocks/SupportHelpOptions\";\r\nimport FaqContent from \"../shared/blocks/FaqContent\";\r\nimport SupportFeedbackForm from \"../shared/blocks/SupportFeedbackForm\";\r\nimport NotificationsPreferencesCard, {\r\n  DEFAULT_NOTIFICATION_PREFS,\r\n  NOTIFICATION_CHANNELS,\r\n} from \"../shared/blocks/NotificationsPreferencesCard\";\r\nimport VerificationCard from \"../shared/blocks/VerificationCard\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport {\r\n  listCurrentUserSessions,\r\n  revokeAllSessions,\r\n  revokeSessionById,\r\n} from \"../../services/sessionDevicesService\";\r\nimport {\r\n  deleteBiometricToken,\r\n  deletePinHash,\r\n  generatePinSalt,\r\n  hashPin,\r\n  loadDeviceSecret,\r\n  saveBiometricToken,\r\n  saveDeviceSecret,\r\n  savePinHash,\r\n} from \"../../services/secureStorageService\";\r\nimport { logCatalogBreadcrumb } from \"../../services/loggingClient\";\r\n\r\nconst getDeviceIcon = (session) => {\r\n  const raw = `${session?.device || \"\"} ${session?.platform || \"\"}`.toLowerCase();\r\n  if (raw.includes(\"movil\") || raw.includes(\"android\") || raw.includes(\"ios\")) {\r\n    return Smartphone;\r\n  }\r\n  if (raw.includes(\"tablet\")) return Tablet;\r\n  if (raw.includes(\"pwa\")) return Monitor;\r\n  return Laptop;\r\n};\r\nlet accessInfoDismissed = false;\r\n\r\nexport default function ClientePerfil() {\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const setUser = useAppStore((s) => s.setUser);\r\n  const logout = useAppStore((s) => s.logout);\r\n  const accessMethods = useAppStore((s) => s.accessMethods);\r\n  const requestLocalVerification = useAppStore(\r\n    (s) => s.security.requestLocalVerification\r\n  );\r\n  const requestPasswordVerification = useAppStore(\r\n    (s) => s.security.requestPasswordVerification\r\n  );\r\n  const { openModal } = useModal();\r\n  const { setHeaderOptions } = useClienteHeader();\r\n  const navigate = useNavigate();\r\n  const isActive = useCacheStore(\r\n    (state) => state.activeKeys.cliente === CACHE_KEYS.CLIENTE_PERFIL\r\n  );\r\n  const { profileTab, setProfileTab } = useClienteUI({\r\n    defaultProfileTab: \"overview\",\r\n  });\r\n  const [profileView, setProfileView] = useState(\"tabs\");\r\n  const [tabsActiveKey, setTabsActiveKey] = useState(null);\r\n  const tabTransitionRef = useRef(null);\r\n  const [searchValue, setSearchValue] = useState(\"\");\r\n  const [dockTarget, setDockTarget] = useState(null);\r\n  const showSearchDock = profileView === \"tabs\";\r\n  const [dockOpenForHeader, setDockOpenForHeader] = useState(showSearchDock);\r\n  const prevShowSearchDockRef = useRef(showSearchDock);\r\n  const [sessions, setSessions] = useState([]);\r\n  const [sessionsLoading, setSessionsLoading] = useState(false);\r\n  const [sessionsError, setSessionsError] = useState(null);\r\n  const twoFASms = false;\r\n  const {\r\n    loading: mfaLoading,\r\n    error: mfaError,\r\n    totpEnabled,\r\n    totpFactorId,\r\n    refresh: refreshMfa,\r\n  } = useMfaState();\r\n  const [twoFADismissed, setTwoFADismissed] = useState(false);\r\n  const [aliasStatus, setAliasStatus] = useState(null);\r\n  const [helpView, setHelpView] = useState(\"menu\");\r\n\r\n  const loadSessions = useCallback(async () => {\r\n    setSessionsLoading(true);\r\n    setSessionsError(null);\r\n    const result = await listCurrentUserSessions();\r\n    if (!result?.ok) {\r\n      setSessionsError(result?.error || \"No se pudieron cargar las sesiones.\");\r\n      setSessionsLoading(false);\r\n      return;\r\n    }\r\n    setSessions(result.sessions || []);\r\n    setSessionsLoading(false);\r\n  }, []);\r\n\r\n  const handleCloseSession = useCallback(\r\n    async (session) => {\r\n      if (!session?.sessionId) return;\r\n      setSessionsLoading(true);\r\n      setSessionsError(null);\r\n      const result = await revokeSessionById(session.sessionId);\r\n      if (!result?.ok) {\r\n        setSessionsError(result?.error || \"No se pudo cerrar la sesion.\");\r\n        setSessionsLoading(false);\r\n        return;\r\n      }\r\n      if (result?.current_session_revoked) {\r\n        await logout();\r\n        return;\r\n      }\r\n      await loadSessions();\r\n    },\r\n    [loadSessions, logout],\r\n  );\r\n\r\n  const handleCloseAllSessions = useCallback(async () => {\r\n    setSessionsLoading(true);\r\n    setSessionsError(null);\r\n    const result = await revokeAllSessions();\r\n    if (!result?.ok) {\r\n      setSessionsError(result?.error || \"No se pudieron cerrar las sesiones.\");\r\n      setSessionsLoading(false);\r\n      return;\r\n    }\r\n    await logout();\r\n  }, [logout]);\r\n\r\n  useEffect(() => {\r\n    if (profileView !== \"tabs\" || profileTab !== \"sessions\") return;\r\n    loadSessions();\r\n  }, [loadSessions, profileTab, profileView]);\r\n\r\n  const SessionsPanel = useCallback(\r\n    () => (\r\n      <Sessions\r\n        title=\"Sesiones y dispositivos\"\r\n        subtitle=\"Controla los accesos activos en tu cuenta.\"\r\n        subtitleAction={\r\n          <button\r\n            type=\"button\"\r\n            className=\"rounded-xl border border-[#E9E2F7] bg-white p-2 text-slate-500 transition hover:text-[#5E30A5] disabled:opacity-60\"\r\n            title=\"Refrescar sesiones\"\r\n            onClick={loadSessions}\r\n            disabled={sessionsLoading}\r\n            aria-label=\"Refrescar sesiones\"\r\n          >\r\n            <RefreshCcw\r\n              size={16}\r\n              className={sessionsLoading ? \"animate-spin\" : undefined}\r\n            />\r\n          </button>\r\n        }\r\n        blocks={[\r\n          <SessionsList\r\n            key=\"sessions-list\"\r\n            items={sessions}\r\n            renderLeading={(session) => {\r\n              const Icon = getDeviceIcon(session);\r\n              return <Icon size={18} />;\r\n            }}\r\n            getPrimaryText={(session) => session.device}\r\n            getSecondaryText={(session) =>\r\n              `${session.location} - ${session.lastActive}`\r\n            }\r\n            renderTrailing={(session) =>\r\n              session.current ? (\r\n                <span className=\"rounded-xl bg-[#F3EEFF] px-2 py-1 text-[10px] font-semibold text-[#5E30A5]\">\r\n                  Actual\r\n                </span>\r\n              ) : (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => handleCloseSession(session)}\r\n                  className=\"rounded-xl border border-red-200 px-2 py-1 text-[10px] font-semibold text-red-600 transition hover:bg-red-50\"\r\n                >\r\n                  Cerrar\r\n                </button>\r\n              )}\r\n          />,\r\n          sessionsLoading && sessions.length === 0 ? (\r\n            <div\r\n              key=\"sessions-loading\"\r\n              className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] px-4 py-3 text-[11px] text-slate-500 text-center\"\r\n            >\r\n              Cargando sesiones...\r\n            </div>\r\n          ) : null,\r\n          sessionsError ? (\r\n            <div\r\n              key=\"sessions-error\"\r\n              className=\"rounded-2xl border border-red-100 bg-red-50 px-4 py-3 text-[11px] text-red-500 text-center\"\r\n            >\r\n              {sessionsError}\r\n            </div>\r\n          ) : null,\r\n        ]}\r\n        footer={\r\n          <button\r\n            type=\"button\"\r\n            onClick={handleCloseAllSessions}\r\n            disabled={sessionsLoading}\r\n            className=\"w-full rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-left text-xs font-semibold text-red-600 transition hover:bg-red-100\"\r\n          >\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"h-8 w-8 rounded-xl bg-red-100 text-red-600 flex items-center justify-center\">\r\n                <LogOut size={16} />\r\n              </span>\r\n              <div>\r\n                <div>Cerrar todas</div>\r\n                <div className=\"mt-1 text-[11px] font-normal text-red-500\">\r\n                  Esto cierra sesion en todos los dispositivos, incluido el\r\n                  actual.\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </button>\r\n        }\r\n      />\r\n    ),\r\n    [\r\n      handleCloseAllSessions,\r\n      handleCloseSession,\r\n      sessions,\r\n      sessionsError,\r\n      sessionsLoading,\r\n    ]\r\n  );\r\n\r\n  const aliasConfig = useMemo(\r\n    () => ({\r\n      panelTitle: \"Nombre en pantalla\",\r\n      emptyMessage: \"Haz que tu perfil se sienta tuyo, anade un alias.\",\r\n      editMessage: \"Esto es lo que los demas veran.\",\r\n      viewMessage: \"Esto es lo que los demas veran.\",\r\n      editTitle: \"Elige tu alias\",\r\n      fieldLabel: \"Alias\",\r\n      placeholder: \"Ingresa un alias\",\r\n      displayLabel: \"Alias\",\r\n      emptyValue: \"Sin alias.\",\r\n      valueClass: \"mt-1 block text-[13px] text-slate-500\",\r\n      minLettersText: \"El alias debe contener al menos cuatro letras\",\r\n    }),\r\n    []\r\n  );\r\n\r\n  const TwoFAPanel = useCallback(\r\n    () => (\r\n      <TwoFA\r\n        title=\"Autenticacion en dos pasos\"\r\n        subtitle=\"Refuerza tu seguridad con factores adicionales.\"\r\n        blocks={[\r\n          <TwoFACard\r\n            key=\"twofa\"\r\n            factors={[\r\n              {\r\n                id: \"totp\",\r\n                title: \"App autenticadora\",\r\n                description: \"TOTP para accesos seguros.\",\r\n                toggle: {\r\n                  active: totpEnabled,\r\n                  onChange: () => {\r\n                    if (mfaLoading) return;\r\n                    if (totpEnabled) {\r\n                      openModal(\"TwoFADisable\", {\r\n                        factorId: totpFactorId,\r\n                        onDisabled: refreshMfa,\r\n                      });\r\n                      return;\r\n                    }\r\n                    openModal(\"TwoFAEnroll\", {\r\n                      onComplete: refreshMfa,\r\n                    });\r\n                  },\r\n                  disabled: mfaLoading,\r\n                },\r\n              },\r\n              {\r\n                id: \"sms\",\r\n                title: \"SMS\",\r\n                badge: \"No disponible aun\",\r\n                description: \"Codigo enviado al telefono.\",\r\n                disabled: true,\r\n                toggle: {\r\n                  active: twoFASms,\r\n                  onChange: () => {},\r\n                  disabled: true,\r\n                },\r\n              },\r\n            ]}\r\n          />,\r\n          mfaError ? (\r\n            <div\r\n              key=\"mfa-error\"\r\n              className=\"rounded-2xl border border-red-100 bg-red-50 px-4 py-3 text-[11px] text-red-500\"\r\n            >\r\n              {mfaError}\r\n            </div>\r\n          ) : null,\r\n        ]}\r\n        notice={\r\n          !twoFADismissed ? (\r\n            <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4 flex items-center gap-3 text-xs text-slate-500\">\r\n              <ShieldCheck size={16} className=\"text-[#5E30A5]\" />\r\n              Mantener 2FA activo reduce riesgos de acceso no autorizado.\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setTwoFADismissed(true)}\r\n                className=\"ml-auto text-slate-400 hover:text-slate-500\"\r\n                aria-label=\"Cerrar aviso\"\r\n              >\r\n                <X size={14} />\r\n              </button>\r\n            </div>\r\n          ) : null\r\n        }\r\n      />\r\n    ),\r\n    [\r\n      twoFADismissed,\r\n      twoFASms,\r\n      totpEnabled,\r\n      mfaLoading,\r\n      mfaError,\r\n      openModal,\r\n      refreshMfa,\r\n      totpFactorId,\r\n    ]\r\n  );\r\n\r\n  const AccessPanel = useCallback(function AccessPanel({ usuario: accessUser }) {\r\n    const { openModal } = useModal();\r\n    const setAccessMethods = useAppStore((s) => s.setAccessMethods);\r\n    const setSuspendViewportResize = useAppStore(\r\n      (s) => s.setSuspendViewportResize\r\n    );\r\n    const setSuspendViewportAfterNext = useAppStore(\r\n      (s) => s.setSuspendViewportAfterNext\r\n    );\r\n    const freezeViewportAfterNextUpdate = useAppStore(\r\n      (s) => s.freezeViewportAfterNextUpdate\r\n    );\r\n    const onboarding = useAppStore((s) => s.onboarding);\r\n    const emailVerifiedSessionAt = useAppStore((s) => s.emailVerifiedSessionAt);\r\n    const setEmailVerifiedSessionAt = useAppStore(\r\n      (s) => s.setEmailVerifiedSessionAt\r\n    );\r\n    const [fingerprintEnabled, setFingerprintEnabled] = useState(false);\r\n    const [pinEnabled, setPinEnabled] = useState(false);\r\n    const [showPasswordForm, setShowPasswordForm] = useState(false);\r\n    const [passwordMode, setPasswordMode] = useState(\"add\");\r\n    const [currentPassword, setCurrentPassword] = useState(\"\");\r\n    const [passwordValue, setPasswordValue] = useState(\"\");\r\n    const [passwordConfirm, setPasswordConfirm] = useState(\"\");\r\n    const [showPassword, setShowPassword] = useState(false);\r\n    const [showPasswordConfirm, setShowPasswordConfirm] = useState(false);\r\n    const [showCurrentPassword, setShowCurrentPassword] = useState(false);\r\n    const [passwordAttempted, setPasswordAttempted] = useState(false);\r\n    const [showPinForm, setShowPinForm] = useState(false);\r\n    const [focusedField, setFocusedField] = useState(null);\r\n    const [authProvider, setAuthProvider] = useState(null);\r\n    const [passwordEnabled, setPasswordEnabled] = useState(null);\r\n    const [removalBlocked, setRemovalBlocked] = useState(false);\r\n    const [dismissedMethodsWarning, setDismissedMethodsWarning] = useState(false);\r\n    const [dismissedInfo, setDismissedInfo] = useState(accessInfoDismissed);\r\n    const [emailWarningOpen, setEmailWarningOpen] = useState(false);\r\n    const [emailWarningPulse, setEmailWarningPulse] = useState(false);\r\n    const passwordFormRef = useRef(null);\r\n    const currentPasswordRef = useRef(null);\r\n    const passwordInputRef = useRef(null);\r\n    const confirmInputRef = useRef(null);\r\n    const prevUserIdRef = useRef(null);\r\n    const provider = (authProvider || accessUser?.provider || \"\").toLowerCase();\r\n    const emailConfirmed = Boolean(onboarding?.email_confirmed);\r\n    const emailRecentlyVerified =\r\n      Boolean(emailVerifiedSessionAt) &&\r\n      Date.now() - emailVerifiedSessionAt < 2 * 60 * 60 * 1000;\r\n    const hasPassword =\r\n      Boolean(accessUser?.has_password) ||\r\n      provider === \"email\" ||\r\n      provider === \"password\";\r\n    const passwordActive = passwordEnabled ?? hasPassword;\r\n    const methodsCount =\r\n      (passwordActive ? 1 : 0) +\r\n      (fingerprintEnabled ? 1 : 0) +\r\n      (pinEnabled ? 1 : 0);\r\n    const showMethodsWarning =\r\n      (methodsCount === 0 || removalBlocked) && !dismissedMethodsWarning;\r\n    const showEmailWarning = !emailConfirmed && emailWarningOpen;\r\n    const emailWarningClass = emailWarningPulse\r\n      ? \"animate-[pulse_1.6s_ease-in-out_1]\"\r\n      : \"\";\r\n\r\n    useEffect(() => {\r\n      if (!emailConfirmed) {\r\n        setEmailWarningOpen(true);\r\n      }\r\n    }, [emailConfirmed]);\r\n\r\n    useEffect(() => {\r\n      if (!emailWarningPulse) return undefined;\r\n      const timer = setTimeout(() => setEmailWarningPulse(false), 1600);\r\n      return () => clearTimeout(timer);\r\n    }, [emailWarningPulse]);\r\n\r\n    const triggerEmailWarning = useCallback(() => {\r\n      if (emailWarningOpen) {\r\n        setEmailWarningPulse(true);\r\n        return;\r\n      }\r\n      setEmailWarningOpen(true);\r\n    }, [emailWarningOpen]);\r\n\r\n    useEffect(() => {\r\n      let active = true;\r\n      const loadProvider = async () => {\r\n        const { data } = await supabase.auth.getSession();\r\n        const nextProvider = data?.session?.user?.app_metadata?.provider ?? null;\r\n        if (active) {\r\n          setAuthProvider(nextProvider);\r\n        }\r\n      };\r\n      loadProvider();\r\n      return () => {\r\n        active = false;\r\n      };\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n      if (passwordEnabled === null) {\r\n        setPasswordEnabled(hasPassword);\r\n        return;\r\n      }\r\n      if (!hasPassword && passwordEnabled) {\r\n        setPasswordEnabled(false);\r\n      }\r\n    }, [hasPassword, passwordEnabled]);\r\n\r\n    useEffect(() => {\r\n      if (passwordActive && showPasswordForm && passwordMode === \"add\") {\r\n        setShowPasswordForm(false);\r\n      }\r\n    }, [passwordActive, showPasswordForm, passwordMode]);\r\n\r\n    useEffect(() => {\r\n      if (methodsCount === 0) {\r\n        setDismissedMethodsWarning(false);\r\n      }\r\n    }, [methodsCount]);\r\n\r\n    useEffect(() => {\r\n      setAccessMethods({\r\n        fingerprint: fingerprintEnabled,\r\n        pin: pinEnabled,\r\n        password: passwordActive,\r\n      });\r\n    }, [fingerprintEnabled, passwordActive, pinEnabled, setAccessMethods]);\r\n\r\n    useEffect(() => {\r\n      const currentId = accessUser?.id_auth ?? null;\r\n      if (prevUserIdRef.current !== currentId) {\r\n        prevUserIdRef.current = currentId;\r\n        accessInfoDismissed = false;\r\n        setDismissedInfo(false);\r\n      }\r\n      setFingerprintEnabled(Boolean(accessUser?.has_biometrics));\r\n      setPinEnabled(Boolean(accessUser?.has_pin));\r\n    }, [accessUser?.id_auth, accessUser?.has_biometrics, accessUser?.has_pin]);\r\n\r\n    useEffect(() => {\r\n      if (methodsCount > 1 && removalBlocked) {\r\n        setRemovalBlocked(false);\r\n      }\r\n    }, [methodsCount, removalBlocked]);\r\n\r\n    const handlePasswordFocus = useCallback((field) => {\r\n      setFocusedField(field);\r\n    }, []);\r\n\r\n    const handlePasswordBlur = useCallback(() => {\r\n      requestAnimationFrame(() => {\r\n        const active = document.activeElement;\r\n        if (active === currentPasswordRef.current) {\r\n          setFocusedField(\"current\");\r\n          return;\r\n        }\r\n        if (active === passwordInputRef.current) {\r\n          setFocusedField(\"new\");\r\n          return;\r\n        }\r\n        if (active === confirmInputRef.current) {\r\n          setFocusedField(\"confirm\");\r\n          return;\r\n        }\r\n        setFocusedField(null);\r\n      });\r\n    }, []);\r\n\r\n    const hasMinLength = passwordValue.length >= 8;\r\n    const hasNumber = /\\d/.test(passwordValue);\r\n    const hasSymbol = /[^A-Za-z0-9]/.test(passwordValue);\r\n    const hasNumberAndSymbol = hasNumber && hasSymbol;\r\n    const passwordsMatch =\r\n      passwordValue.length > 0 &&\r\n      passwordConfirm.length > 0 &&\r\n      passwordValue === passwordConfirm;\r\n    const showPasswordRules = focusedField === \"new\" || passwordValue.length > 0;\r\n    const showPasswordErrors = focusedField !== \"new\" && passwordValue.length > 0;\r\n    const showConfirmErrors =\r\n      focusedField !== \"confirm\" && passwordConfirm.length > 0;\r\n    const showConfirmRule =\r\n      hasMinLength && hasNumberAndSymbol && passwordConfirm.length > 0;\r\n    const canSavePassword = hasMinLength && hasNumberAndSymbol && passwordsMatch;\r\n    const showCurrentPasswordError = false;\r\n\r\n    const handlePasswordCancel = () => {\r\n      setPasswordValue(\"\");\r\n      setPasswordConfirm(\"\");\r\n      setCurrentPassword(\"\");\r\n      setFocusedField(null);\r\n      setPasswordMode(\"add\");\r\n      setPasswordAttempted(false);\r\n      setShowPasswordForm(false);\r\n      document.activeElement?.blur();\r\n    };\r\n\r\n    const handlePasswordSave = async () => {\r\n      setPasswordAttempted(true);\r\n      if (!canSavePassword) return;\r\n      setPasswordEnabled(true);\r\n      setShowPasswordForm(false);\r\n      setPasswordMode(\"add\");\r\n      setPasswordAttempted(false);\r\n      const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n      if (userId) {\r\n        await supabase\r\n          .from(\"usuarios\")\r\n          .update({ has_password: true, must_change_password: false })\r\n          .eq(\"id_auth\", userId);\r\n      }\r\n      if (accessUser) {\r\n        setUser({\r\n          ...accessUser,\r\n          has_password: true,\r\n          must_change_password: false,\r\n        });\r\n      }\r\n    };\r\n\r\n    const openAddPassword = () => {\r\n      if (!emailConfirmed) {\r\n        triggerEmailWarning();\r\n        openModal(\"EmailVerification\", {\r\n          email: accessUser?.email ?? null,\r\n        });\r\n        return;\r\n      }\r\n      if (!emailRecentlyVerified) {\r\n        openModal(\"EmailReauth\", {\r\n          email: accessUser?.email ?? null,\r\n          onConfirm: () => {\r\n            setEmailVerifiedSessionAt(Date.now());\r\n            setPasswordMode(\"add\");\r\n            setCurrentPassword(\"\");\r\n            setPasswordValue(\"\");\r\n            setPasswordConfirm(\"\");\r\n            setPasswordAttempted(false);\r\n            setShowPasswordForm(true);\r\n          },\r\n        });\r\n        return;\r\n      }\r\n      setPasswordMode(\"add\");\r\n      setCurrentPassword(\"\");\r\n      setPasswordValue(\"\");\r\n      setPasswordConfirm(\"\");\r\n      setPasswordAttempted(false);\r\n      setShowPasswordForm(true);\r\n    };\r\n\r\n    const openChangePassword = () => {\r\n      requestPasswordVerification({\r\n        requireVerifiedEmail: true,\r\n        onBlocked: triggerEmailWarning,\r\n        onVerified: () => {\r\n          setPasswordMode(\"change\");\r\n          setCurrentPassword(\"\");\r\n          setPasswordValue(\"\");\r\n          setPasswordConfirm(\"\");\r\n          setPasswordAttempted(false);\r\n          setShowPasswordForm(true);\r\n        },\r\n        email: accessUser?.email ?? null,\r\n      });\r\n    };\r\n\r\n    const savePin = useCallback(async (nextPin) => {\r\n      const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n      if (!userId) {\r\n        return { ok: false, error: \"No se pudo obtener sesion.\" };\r\n      }\r\n      const existingSecret = await loadDeviceSecret(userId);\r\n      if (!existingSecret) {\r\n        const bytes = window.crypto.getRandomValues(new Uint8Array(32));\r\n        const token = btoa(String.fromCharCode(...bytes));\r\n        await saveDeviceSecret(userId, { token, createdAt: new Date().toISOString() });\r\n      }\r\n      const salt = generatePinSalt();\r\n      const hash = await hashPin(nextPin, salt);\r\n      const saved = await savePinHash(userId, {\r\n        salt,\r\n        hash,\r\n        iterations: 160000,\r\n        algo: \"PBKDF2-SHA256\",\r\n      });\r\n      if (!saved.ok) {\r\n        return { ok: false, error: \"No se pudo guardar el PIN.\" };\r\n      }\r\n      const { error: updErr } = await supabase\r\n        .from(\"usuarios\")\r\n        .update({ has_pin: true })\r\n        .eq(\"id_auth\", userId);\r\n      if (updErr) {\r\n        return { ok: false, error: updErr.message || \"No se pudo guardar el PIN.\" };\r\n      }\r\n      return { ok: true };\r\n    }, [accessUser?.id_auth, accessUser?.id]);\r\n\r\n    const pinSetup = usePinSetup({ onSavePin: savePin });\r\n    const pinValue = pinSetup.pinValue;\r\n    const pinSlots = pinSetup.pinSlots;\r\n    const pinReveal = pinSetup.pinReveal;\r\n    const pinStep = pinSetup.pinStep;\r\n    const pinComplete = pinSetup.pinComplete;\r\n    const pinMatches = pinSetup.pinMatches;\r\n    const pinFocused = pinSetup.pinFocused;\r\n\r\n    const resetPinForm = useCallback(() => {\r\n      pinSetup.resetPinForm();\r\n      setShowPinForm(false);\r\n      setSuspendViewportResize(false);\r\n      setSuspendViewportAfterNext(false);\r\n      document.activeElement?.blur();\r\n    }, [pinSetup, setSuspendViewportAfterNext, setSuspendViewportResize]);\r\n\r\n    const openPinForm = () => {\r\n      pinSetup.resetPinForm();\r\n      setShowPinForm(true);\r\n      window.requestAnimationFrame(() => {\r\n        pinSetup.focusHiddenInput();\r\n      });\r\n    };\r\n\r\n    const handlePinNext = () => {\r\n      if (!pinComplete) return;\r\n      setSuspendViewportAfterNext(false);\r\n      setSuspendViewportResize(true);\r\n      pinSetup.handlePinNext();\r\n      window.requestAnimationFrame(() => {\r\n        pinSetup.focusHiddenInput();\r\n      });\r\n    };\r\n\r\n    const handlePinConfirm = async () => {\r\n      const result = await pinSetup.handlePinConfirm();\r\n      if (!result?.ok) return;\r\n      setPinEnabled(true);\r\n      if (accessUser) {\r\n        setUser({ ...accessUser, has_pin: true });\r\n      }\r\n      resetPinForm();\r\n    };\r\n\r\n    const handleRemoveFingerprint = () => {\r\n      if (methodsCount <= 1) {\r\n        setRemovalBlocked(true);\r\n        setDismissedMethodsWarning(false);\r\n        return;\r\n      }\r\n      requestLocalVerification({\r\n        onVerified: () => {\r\n          openModal(\"ConfirmAction\", {\r\n            title: \"Quitar huella\",\r\n            message: \"Seguro que deseas quitar la huella?\",\r\n            confirmLabel: \"Confirmar\",\r\n            cancelLabel: \"Cancelar\",\r\n            onConfirm: async () => {\r\n              const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n              if (userId) {\r\n                await supabase\r\n                  .from(\"usuarios\")\r\n                  .update({ has_biometrics: false })\r\n                  .eq(\"id_auth\", userId);\r\n                await deleteBiometricToken(userId);\r\n              }\r\n              setFingerprintEnabled(false);\r\n              if (accessUser) {\r\n                setUser({ ...accessUser, has_biometrics: false });\r\n              }\r\n            },\r\n          });\r\n        },\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    const handleRemovePin = () => {\r\n      if (methodsCount <= 1) {\r\n        setRemovalBlocked(true);\r\n        setDismissedMethodsWarning(false);\r\n        return;\r\n      }\r\n      requestLocalVerification({\r\n        onVerified: () => {\r\n          openModal(\"ConfirmAction\", {\r\n            title: \"Quitar PIN\",\r\n            message: \"Seguro que deseas quitar el PIN?\",\r\n            confirmLabel: \"Confirmar\",\r\n            cancelLabel: \"Cancelar\",\r\n            onConfirm: async () => {\r\n              const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n              if (userId) {\r\n                await supabase\r\n                  .from(\"usuarios\")\r\n                  .update({ has_pin: false })\r\n                  .eq(\"id_auth\", userId);\r\n                await deletePinHash(userId);\r\n              }\r\n              setPinEnabled(false);\r\n              if (accessUser) {\r\n                setUser({ ...accessUser, has_pin: false });\r\n              }\r\n            },\r\n          });\r\n        },\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    const handlePinPointerDown = (event) => {\r\n      event.preventDefault();\r\n      pinSetup.focusHiddenInput();\r\n    };\r\n\r\n    const registerHiddenRef = (el) => {\r\n      pinSetup.registerHiddenRef(el);\r\n    };\r\n\r\n    const handlePinFocus = useCallback(() => {\r\n      const vv = window.visualViewport;\r\n      const height = vv?.height ?? window.innerHeight;\r\n      const keyboardOpen = height < window.innerHeight - 40;\r\n      if (keyboardOpen) {\r\n        setSuspendViewportAfterNext(false);\r\n        setSuspendViewportResize(true);\r\n      } else {\r\n        freezeViewportAfterNextUpdate();\r\n      }\r\n      pinSetup.setPinFocus(true);\r\n    }, [\r\n      freezeViewportAfterNextUpdate,\r\n      pinSetup,\r\n      setSuspendViewportAfterNext,\r\n      setSuspendViewportResize,\r\n    ]);\r\n\r\n    const handlePinBlur = useCallback(() => {\r\n      if (!showPinForm) {\r\n        setSuspendViewportResize(false);\r\n        setSuspendViewportAfterNext(false);\r\n      }\r\n      pinSetup.setPinFocus(false);\r\n    }, [\r\n      pinSetup,\r\n      setSuspendViewportAfterNext,\r\n      setSuspendViewportResize,\r\n      showPinForm,\r\n    ]);\r\n\r\n    const handleTogglePinForm = () => {\r\n      if (showPinForm) {\r\n        resetPinForm();\r\n        return;\r\n      }\r\n        requestLocalVerification({\r\n          onVerified: () => {\r\n            openPinForm();\r\n          },\r\n          onBlocked: triggerEmailWarning,\r\n        requireVerifiedEmail: true,\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    const handleAddFingerprint = () => {\r\n      requestLocalVerification({\r\n        onVerified: () => {\r\n          openModal(\"FingerprintPrompt\", {\r\n            onConfirm: async (credentialId) => {\r\n              const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n              if (!userId) return;\r\n              const existingSecret = await loadDeviceSecret(userId);\r\n              if (!existingSecret) {\r\n                const bytes = window.crypto.getRandomValues(new Uint8Array(32));\r\n                const token = btoa(String.fromCharCode(...bytes));\r\n                await saveDeviceSecret(userId, { token, createdAt: new Date().toISOString() });\r\n              }\r\n              if (!credentialId) return;\r\n              await saveBiometricToken(userId, {\r\n                credentialId,\r\n                createdAt: new Date().toISOString(),\r\n              });\r\n              await supabase\r\n                .from(\"usuarios\")\r\n                .update({ has_biometrics: true })\r\n                .eq(\"id_auth\", userId);\r\n              setFingerprintEnabled(true);\r\n              if (accessUser) {\r\n                setUser({ ...accessUser, has_biometrics: true });\r\n              }\r\n            },\r\n            userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n            email: accessUser?.email ?? null,\r\n            displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n          });\r\n        },\r\n        onBlocked: triggerEmailWarning,\r\n        requireVerifiedEmail: true,\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    return (\r\n      <Access\r\n        warningBlock={\r\n          showEmailWarning || showMethodsWarning ? (\r\n            <div className=\"space-y-2\">\r\n              {showEmailWarning ? (\r\n                <div\r\n                  className={`relative left-1/2 right-1/2 w-screen -mx-[50vw] ${emailWarningClass}`}\r\n                >\r\n                  <div className=\"flex items-center gap-3 border border-orange-200 bg-orange-50 px-4 py-2 text-xs text-orange-600\">\r\n                    <AlertTriangle size={14} className=\"shrink-0\" />\r\n                    <div className=\"flex-1 overflow-hidden text-ellipsis whitespace-nowrap\">\r\n                      Antes de realizar cambios sensibles,{\" \"}\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() =>\r\n                          openModal(\"EmailVerification\", {\r\n                            email: accessUser?.email ?? null,\r\n                          })\r\n                        }\r\n                        className=\"underline underline-offset-2\"\r\n                      >\r\n                        verifica tu correo\r\n                      </button>\r\n                    </div>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => {\r\n                        setEmailWarningOpen(false);\r\n                        setEmailWarningPulse(false);\r\n                      }}\r\n                      className=\"text-orange-400 hover:text-orange-500\"\r\n                      aria-label=\"Cerrar aviso\"\r\n                    >\r\n                      <X size={14} />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ) : null}\r\n              {showMethodsWarning ? (\r\n                <div className=\"rounded-2xl border border-red-200 bg-red-50 p-4 flex items-center gap-3 text-xs text-red-500\">\r\n                  <TriangleAlert size={16} className=\"text-red-500\" />\r\n                  Es necesario al menos un metodo de verificacion.\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setDismissedMethodsWarning(true)}\r\n                    className=\"ml-auto text-red-400 hover:text-red-500\"\r\n                    aria-label=\"Cerrar aviso\"\r\n                  >\r\n                    <X size={14} />\r\n                  </button>\r\n                </div>\r\n              ) : null}\r\n            </div>\r\n          ) : null\r\n        }\r\n        blocks={[\r\n          <PasswordAccessCard\r\n            key=\"password\"\r\n            passwordActive={passwordActive}\r\n            showPasswordForm={showPasswordForm}\r\n            passwordMode={passwordMode}\r\n            currentPassword={currentPassword}\r\n            passwordValue={passwordValue}\r\n            passwordConfirm={passwordConfirm}\r\n            showPassword={showPassword}\r\n            showPasswordConfirm={showPasswordConfirm}\r\n            showCurrentPassword={showCurrentPassword}\r\n            hasMinLength={hasMinLength}\r\n            hasNumberAndSymbol={hasNumberAndSymbol}\r\n            passwordsMatch={passwordsMatch}\r\n            showPasswordRules={showPasswordRules}\r\n            showPasswordErrors={showPasswordErrors}\r\n            showConfirmErrors={showConfirmErrors}\r\n            showConfirmRule={showConfirmRule}\r\n            canSavePassword={canSavePassword}\r\n            showCurrentPasswordError={showCurrentPasswordError}\r\n            onPasswordCancel={handlePasswordCancel}\r\n            onPasswordSave={handlePasswordSave}\r\n            onOpenAdd={openAddPassword}\r\n            onOpenChange={openChangePassword}\r\n            onToggleShowPassword={() => setShowPassword((prev) => !prev)}\r\n            onToggleShowPasswordConfirm={() =>\r\n              setShowPasswordConfirm((prev) => !prev)\r\n            }\r\n            onToggleShowCurrentPassword={() =>\r\n              setShowCurrentPassword((prev) => !prev)\r\n            }\r\n            onChangeCurrentPassword={(event) =>\r\n              setCurrentPassword(event.target.value)\r\n            }\r\n            onChangePasswordValue={(event) =>\r\n              setPasswordValue(event.target.value)\r\n            }\r\n            onChangePasswordConfirm={(event) =>\r\n              setPasswordConfirm(event.target.value)\r\n            }\r\n            onFocusField={handlePasswordFocus}\r\n            onBlurField={handlePasswordBlur}\r\n            passwordFormRef={passwordFormRef}\r\n            currentPasswordRef={currentPasswordRef}\r\n            passwordInputRef={passwordInputRef}\r\n            confirmInputRef={confirmInputRef}\r\n          />,\r\n          <FingerprintAccessCard\r\n            key=\"fingerprint\"\r\n            enabled={fingerprintEnabled}\r\n            onAdd={handleAddFingerprint}\r\n            onRemove={handleRemoveFingerprint}\r\n          />,\r\n            <PinAccessCard\r\n              key=\"pin\"\r\n              showPinForm={showPinForm}\r\n              pinEnabled={pinEnabled}\r\n              pinStep={pinStep}\r\n              pinValue={pinValue}\r\n              pinSlots={pinSlots}\r\n              pinReveal={pinReveal}\r\n              pinComplete={pinComplete}\r\n              pinMatches={pinMatches}\r\n              pinFocused={pinFocused}\r\n              onRemovePin={handleRemovePin}\r\n              onTogglePinForm={handleTogglePinForm}\r\n              onPinPointerDown={handlePinPointerDown}\r\n              onPinValueChange={pinSetup.updatePinValueDirect}\r\n              onPinFocus={handlePinFocus}\r\n              onPinBlur={handlePinBlur}\r\n              registerHiddenRef={registerHiddenRef}\r\n              onResetPinForm={resetPinForm}\r\n              onPinNext={handlePinNext}\r\n              onPinConfirm={handlePinConfirm}\r\n            />,\r\n        ]}\r\n        infoBlock={\r\n          !dismissedInfo ? (\r\n            <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4 flex items-center gap-3 text-xs text-slate-500\">\r\n              <KeyRound size={16} className=\"text-[#5E30A5]\" />\r\n              Cambios sensibles requieren verificacion antes de guardarse.\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  accessInfoDismissed = true;\r\n                  setDismissedInfo(true);\r\n                }}\r\n                className=\"ml-auto text-slate-400 hover:text-slate-500\"\r\n                aria-label=\"Cerrar aviso\"\r\n              >\r\n                <X size={14} />\r\n              </button>\r\n            </div>\r\n          ) : null\r\n        }\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const LinkedAccountsPanel = useCallback(function LinkedAccountsPanel({\r\n    usuario: linkedUser,\r\n  }) {\r\n    const [linked, setLinked] = useState({});\r\n    const [verified] = useState(false);\r\n    const [dismissedInfo, setDismissedInfo] = useState(false);\r\n\r\n    useEffect(() => {\r\n      const provider = (linkedUser?.provider || \"\").toLowerCase();\r\n      if (!provider) return;\r\n      const mapped =\r\n        provider === \"google\"\r\n          ? \"Google\"\r\n          : provider === \"facebook\"\r\n            ? \"Facebook\"\r\n            : provider === \"apple\"\r\n              ? \"Apple\"\r\n              : provider === \"instagram\"\r\n                ? \"Instagram\"\r\n                : provider === \"discord\"\r\n                  ? \"Discord\"\r\n                  : null;\r\n      if (!mapped) return;\r\n      setLinked((prev) => ({ ...prev, [mapped]: true }));\r\n    }, [linkedUser?.provider]);\r\n\r\n    const toggleProvider = useCallback((providerKey) => {\r\n      setLinked((prev) => ({ ...prev, [providerKey]: !prev[providerKey] }));\r\n    }, []);\r\n\r\n    return (\r\n      <LinkedAccounts\r\n        blocks={[\r\n          <LinkedAccountsCard\r\n            key=\"linked-accounts\"\r\n            linked={linked}\r\n            verified={verified}\r\n            onToggle={toggleProvider}\r\n          />,\r\n        ]}\r\n        infoBlock={\r\n          !dismissedInfo ? (\r\n            <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4 flex items-center gap-3 text-xs text-slate-500\">\r\n              <KeyRound size={16} className=\"text-[#5E30A5]\" />\r\n              Cambios sensibles requieren verificacion antes de guardarse.\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setDismissedInfo(true)}\r\n                className=\"ml-auto text-slate-400 hover:text-slate-500\"\r\n                aria-label=\"Cerrar aviso\"\r\n              >\r\n                <X size={14} />\r\n              </button>\r\n            </div>\r\n          ) : null\r\n        }\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const NotificationsPanel = useCallback(function NotificationsPanel() {\r\n    const { openModal } = useModal();\r\n    const [prefs, setPrefs] = useState(DEFAULT_NOTIFICATION_PREFS);\r\n    const [permission, setPermission] = useState(\"default\");\r\n    const [pushEnabled, setPushEnabled] = useState(false);\r\n    const [dismissedWarning, setDismissedWarning] = useState(false);\r\n\r\n    useEffect(() => {\r\n      if (typeof window === \"undefined\") return;\r\n      const nextPermission =\r\n        typeof Notification !== \"undefined\" ? Notification.permission : \"default\";\r\n      setPermission(nextPermission);\r\n\r\n      if (!(\"serviceWorker\" in navigator)) return;\r\n      navigator.serviceWorker.ready\r\n        .then((reg) => reg.pushManager?.getSubscription?.())\r\n        .then((sub) => {\r\n          setPushEnabled(Boolean(sub));\r\n        })\r\n        .catch(() => {\r\n          setPushEnabled(false);\r\n        });\r\n    }, []);\r\n\r\n    const toggle = useCallback(\r\n      (section) => {\r\n        setPrefs((prev) => ({\r\n          ...prev,\r\n          [section]: !prev[section],\r\n        }));\r\n        openModal(\"Notifications\");\r\n      },\r\n      [openModal]\r\n    );\r\n\r\n    const statusLabel =\r\n      permission === \"granted\"\r\n        ? \"Permitidas\"\r\n        : permission === \"denied\"\r\n          ? \"Bloqueadas\"\r\n          : \"No configuradas\";\r\n\r\n    const showChannels = permission === \"granted\";\r\n    const showWarning = !showChannels && !dismissedWarning;\r\n\r\n    return (\r\n      <Notifications\r\n        blocks={[\r\n          <NotificationsPreferencesCard\r\n            key=\"notifications\"\r\n            permission={permission}\r\n            statusLabel={statusLabel}\r\n            channels={NOTIFICATION_CHANNELS}\r\n            prefs={prefs}\r\n            onToggle={toggle}\r\n            showChannels={showChannels}\r\n            showWarning={showWarning}\r\n            onDismissWarning={() => setDismissedWarning(true)}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const AppAppearancePanel = useCallback(function AppAppearancePanel() {\r\n    const [theme, setTheme] = useState(\"claro\");\r\n    const [font, setFont] = useState(\"actual\");\r\n\r\n    return (\r\n      <AppAppearance\r\n        blocks={[\r\n          <ThemeSelector key=\"theme\" value={theme} onChange={setTheme} />,\r\n          <FontSelector key=\"font\" value={font} onChange={setFont} />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const LanguagePanel = useCallback(function LanguagePanel() {\r\n    const [language, setLanguage] = useState(\"es\");\r\n\r\n    return (\r\n      <Language\r\n        blocks={[\r\n          <LanguageSelector\r\n            key=\"language-selector\"\r\n            value={language}\r\n            onChange={setLanguage}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const handleHelpSelect = useCallback((option) => {\r\n    logCatalogBreadcrumb(\"support.help.select\", {\r\n      option: option || \"unknown\",\r\n      role: \"cliente\",\r\n    });\r\n    if (option === \"Preguntas frecuentes\") {\r\n      setHelpView(\"faq\");\r\n      return;\r\n    }\r\n    if (option === \"Chatear con un asesor\") {\r\n      setHelpView(\"support_chat\");\r\n      return;\r\n    }\r\n    if (option === \"Recibir soporte por correo\") {\r\n      setHelpView(\"support_email\");\r\n    }\r\n  }, []);\r\n\r\n  const HelpPanel = useCallback(\r\n    function HelpPanel() {\r\n      return (\r\n          <Help\r\n            blocks={[\r\n              helpView === \"faq\" ? (\r\n                <FaqContent\r\n                  key=\"faq\"\r\n                  audience=\"cliente\"\r\n                  onBack={() => setHelpView(\"menu\")}\r\n                />\r\n              ) : helpView === \"support_chat\" ? (\r\n                <SupportChat\r\n                  key=\"support-chat\"\r\n                  role=\"cliente\"\r\n                  onBack={() => setHelpView(\"menu\")}\r\n                />\r\n              ) : helpView === \"support_email\" ? (\r\n                <SupportEmail\r\n                  key=\"support-email\"\r\n                  onBack={() => setHelpView(\"menu\")}\r\n                />\r\n              ) : (\r\n                <SupportHelpOptions\r\n                  key=\"support-help\"\r\n                  options={[\r\n                    \"Preguntas frecuentes\",\r\n                    \"Recibir soporte por correo\",\r\n                    \"Chatear con un asesor\",\r\n                  ]}\r\n                  onSelect={handleHelpSelect}\r\n                />\r\n              ),\r\n            ]}\r\n          />\r\n        );\r\n      },\r\n    [handleHelpSelect, helpView]\r\n    );\r\n\r\n  const FeedbackPanel = useCallback(function FeedbackPanel() {\r\n    const [message, setMessage] = useState(\"\");\r\n    const [email, setEmail] = useState(\"\");\r\n\r\n    return (\r\n      <Feedback\r\n        blocks={[\r\n          <SupportFeedbackForm\r\n            key=\"support-feedback\"\r\n            message={message}\r\n            email={email}\r\n            onChangeMessage={setMessage}\r\n            onChangeEmail={setEmail}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const BeneficiosPanel = useCallback(\r\n    ({ usuario: benefitsUser }) => {\r\n      const plan = getPlanFallback(benefitsUser?.role);\r\n      const tier = getTierMeta(benefitsUser);\r\n      const progress = getTierProgress(benefitsUser);\r\n\r\n      return (\r\n        <Beneficios\r\n          title=\"Tier (Liga)\"\r\n          subtitle=\"Avanza y desbloquea beneficios.\"\r\n          blocks={[\r\n            <TierCurrentCard\r\n              key=\"tier-current\"\r\n              badgeLabel={tier.label}\r\n              pointsLabel={formatCompactNumber(progress.points)}\r\n              goalLabel={formatCompactNumber(progress.nextGoal)}\r\n              progress={progress.progress}\r\n              perks={plan?.perks || []}\r\n            />,\r\n            <TierNextCard key=\"tier-next\" perks={plan?.perks || []} />,\r\n            <ExploreTiersCard key=\"tier-explore\" />,\r\n          ]}\r\n        />\r\n      );\r\n    },\r\n    []\r\n  );\r\n\r\n  const ManageAccountPanel = useCallback(\r\n    ({ usuario: manageUser, setUser: setManageUser, verification }) => (\r\n      <ManageAccount\r\n        blocks={[\r\n          !verification.accountVerified ? (\r\n            <AccountStatusCard\r\n              key=\"account-status\"\r\n              subtitle=\"Verifica tu cuenta para acceder a mejores beneficios.\"\r\n            />\r\n          ) : null,\r\n          <DangerZone key=\"danger-zone\" usuario={manageUser} setUser={setManageUser} />,\r\n        ]}\r\n      />\r\n    ),\r\n    []\r\n  );\r\n\r\n  const openVerificationMethods = useCallback(() => {\r\n    setProfileTab(\"security-access\");\r\n    setProfileView(\"panel\");\r\n  }, [setProfileTab, setProfileView]);\r\n\r\n  const OverviewPanel = useCallback(\r\n    ({ usuario: overviewUser, setUser: setOverviewUser, verification }) => {\r\n      const createdAtRaw = overviewUser?.fechacreacion;\r\n      const createdAtValue =\r\n        typeof createdAtRaw === \"string\" &&\r\n        createdAtRaw.includes(\" \") &&\r\n        !createdAtRaw.includes(\"T\")\r\n          ? createdAtRaw.replace(\" \", \"T\")\r\n          : createdAtRaw;\r\n      const createdAtLabel = formatReadableDate(createdAtValue);\r\n      const showRole = overviewUser?.role && overviewUser.role !== \"cliente\";\r\n      const metaLine = `${\r\n        showRole ? `${getRoleLabel(overviewUser)} - ` : \"\"\r\n      }Miembro desde ${createdAtLabel}`;\r\n      const tier = getTierMeta(overviewUser);\r\n      const plan = getPlanFallback(overviewUser?.role);\r\n\r\n      return (\r\n        <ProfileOverview\r\n          verificationBlock={\r\n            !verification.accountVerified ? (\r\n              <VerificationCard />\r\n            ) : null\r\n          }\r\n          identityBlock={\r\n            <IdentityCard\r\n              title=\"Identidad\"\r\n              name={overviewUser?.nombre || \"Usuario\"}\r\n              meta={metaLine}\r\n              avatarSrc={getAvatarSrc(overviewUser)}\r\n              showVerified={verification.accountVerified}\r\n              onAvatarSelect={() =>\r\n                setAliasStatus({\r\n                  type: \"success\",\r\n                  text: \"Imagen seleccionada (pendiente de guardado)\",\r\n                })\r\n              }\r\n            />\r\n          }\r\n          primaryBlock={\r\n            <BenefitsCard\r\n              key=\"overview-benefits\"\r\n              title=\"Tier\"\r\n              badgeLabel={tier.label}\r\n              BadgeIcon={Sparkles}\r\n              perks={plan?.perks || []}\r\n            />\r\n          }\r\n          secondaryBlock={\r\n            <AliasCard\r\n              key=\"overview-alias\"\r\n              usuario={overviewUser}\r\n              setUser={setOverviewUser}\r\n              config={aliasConfig}\r\n              status={aliasStatus}\r\n              onStatus={setAliasStatus}\r\n            />\r\n          }\r\n        />\r\n      );\r\n    },\r\n    [aliasConfig, aliasStatus]\r\n  );\r\n\r\n  function PersonalDataPanel({ usuario: personalUser, setUser: setPersonalUser, verification }) {\r\n    const initial = useMemo(() => {\r\n      const nombre = personalUser?.nombre || \"\";\r\n      const parts = nombre.split(\" \").filter(Boolean);\r\n      return {\r\n        nombres: personalUser?.nombres || parts.slice(0, 1).join(\" \") || nombre,\r\n        apellidos: personalUser?.apellidos || parts.slice(1).join(\" \"),\r\n        direccion:\r\n          personalUser?.direccion ||\r\n          personalUser?.ubicacion ||\r\n          personalUser?.ciudad ||\r\n          \"\",\r\n        email: personalUser?.email || \"\",\r\n        telefono: personalUser?.telefono || personalUser?.phone || \"\",\r\n      };\r\n    }, [personalUser]);\r\n\r\n    const [form, setForm] = useState(initial);\r\n    const [confirmedSensitive, setConfirmedSensitive] = useState(false);\r\n    const [editing, setEditing] = useState({\r\n      names: false,\r\n      contact: false,\r\n    });\r\n    const [expandedEmail, setExpandedEmail] = useState(false);\r\n\r\n    useEffect(() => {\r\n      setForm(initial);\r\n    }, [\r\n      initial.nombres,\r\n      initial.apellidos,\r\n      initial.direccion,\r\n      initial.email,\r\n      initial.telefono,\r\n    ]);\r\n\r\n    useEffect(() => {\r\n      if (editing.contact) {\r\n        setExpandedEmail(false);\r\n      }\r\n    }, [editing.contact]);\r\n\r\n    const emailChanged = form.email !== initial.email;\r\n    const phoneChanged = form.telefono !== initial.telefono;\r\n    const needsSensitiveVerification = emailChanged || phoneChanged;\r\n    const baseVerified =\r\n      (!emailChanged || verification.emailVerified) &&\r\n      (!phoneChanged || verification.phoneVerified);\r\n    const provider = (personalUser?.provider || \"\").toLowerCase();\r\n    const hasPasswordFallback = provider === \"email\" || provider === \"password\";\r\n\r\n    const handleChange = (field) => (event) => {\r\n      setForm((prev) => ({ ...prev, [field]: event.target.value }));\r\n    };\r\n\r\n    const handleSaveNames = () => {\r\n      if (!personalUser) return;\r\n      const nombreCompleto = [form.nombres, form.apellidos]\r\n        .filter(Boolean)\r\n        .join(\" \");\r\n      setPersonalUser({\r\n        ...personalUser,\r\n        nombres: form.nombres,\r\n        apellidos: form.apellidos,\r\n        nombre: nombreCompleto || personalUser?.nombre,\r\n      });\r\n      if (form.nombres?.trim() && form.apellidos?.trim()) {\r\n        setEditing((prev) => ({ ...prev, names: false }));\r\n      }\r\n    };\r\n\r\n    const persistContact = (overrideSensitive = false) => {\r\n      if (!personalUser) return;\r\n      if (!baseVerified) return;\r\n      if (!overrideSensitive && needsSensitiveVerification && !confirmedSensitive) {\r\n        return;\r\n      }\r\n      setPersonalUser({ ...personalUser, email: form.email, telefono: form.telefono });\r\n      if (form.email?.trim() && form.telefono?.trim()) {\r\n        setEditing((prev) => ({ ...prev, contact: false }));\r\n      }\r\n    };\r\n\r\n    const handleSaveContact = () => {\r\n      if (needsSensitiveVerification && !confirmedSensitive) {\r\n        openModal(\"ConfirmarCambios\", {\r\n          hasFingerprint: accessMethods?.fingerprint,\r\n          hasPin: accessMethods?.pin,\r\n          hasPassword: accessMethods?.password || hasPasswordFallback,\r\n          userId: personalUser?.id_auth ?? personalUser?.id ?? null,\r\n          email: personalUser?.email ?? null,\r\n          displayName: personalUser?.nombre ?? personalUser?.alias ?? \"Usuario\",\r\n          onConfirm: () => {\r\n            setConfirmedSensitive(true);\r\n            requestAnimationFrame(() => {\r\n              persistContact(true);\r\n            });\r\n          },\r\n          onOpenMethods: openVerificationMethods,\r\n        });\r\n        return;\r\n      }\r\n      persistContact(false);\r\n    };\r\n\r\n    const handleCancelNames = () => {\r\n      setForm((prev) => ({\r\n        ...prev,\r\n        nombres: initial.nombres || \"\",\r\n        apellidos: initial.apellidos || \"\",\r\n      }));\r\n      setEditing((prev) => ({\r\n        ...prev,\r\n        names: false,\r\n      }));\r\n      document.activeElement?.blur();\r\n    };\r\n\r\n    const handleCancelContact = () => {\r\n      setForm((prev) => ({\r\n        ...prev,\r\n        email: initial.email || \"\",\r\n        telefono: initial.telefono || \"\",\r\n      }));\r\n      setConfirmedSensitive(false);\r\n      setEditing((prev) => ({\r\n        ...prev,\r\n        contact: false,\r\n      }));\r\n      document.activeElement?.blur();\r\n    };\r\n\r\n    const fullName = [form.nombres, form.apellidos].filter(Boolean).join(\" \");\r\n    const addressItems = form.direccion?.trim()\r\n      ? [{ label: \"Casa\", value: form.direccion || \"Sin direccion\" }]\r\n      : [];\r\n    const showSaveNames = Boolean(form.nombres?.trim() || form.apellidos?.trim());\r\n    const showSaveContact = Boolean(form.email?.trim() || form.telefono?.trim());\r\n    const saveContactDisabled = !baseVerified;\r\n\r\n    return (\r\n      <PersonalData\r\n        blocks={[\r\n          <PersonalDataBlock\r\n            key=\"personal-data\"\r\n            editingNames={editing.names}\r\n            editingContact={editing.contact}\r\n            fullName={fullName}\r\n            nombres={form.nombres}\r\n            apellidos={form.apellidos}\r\n            addressItems={addressItems}\r\n            email={form.email}\r\n            telefono={form.telefono}\r\n            expandedEmail={expandedEmail}\r\n            emailVerified={verification.emailVerified}\r\n            onEditNames={() => setEditing((prev) => ({ ...prev, names: true }))}\r\n            onEditAddress={() => {}}\r\n            onEditContact={() => setEditing((prev) => ({ ...prev, contact: true }))}\r\n            onChangeNombres={handleChange(\"nombres\")}\r\n            onChangeApellidos={handleChange(\"apellidos\")}\r\n            onChangeEmail={handleChange(\"email\")}\r\n            onChangeTelefono={handleChange(\"telefono\")}\r\n            onCancelNames={handleCancelNames}\r\n            onCancelContact={handleCancelContact}\r\n            onSaveNames={handleSaveNames}\r\n            onSaveContact={handleSaveContact}\r\n            showSaveNames={showSaveNames}\r\n            showSaveContact={showSaveContact}\r\n            saveContactDisabled={saveContactDisabled}\r\n            onToggleExpandedEmail={() => setExpandedEmail((prev) => !prev)}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }\r\n\r\n  const tabGroups = useMemo(\r\n    () => [\r\n      {\r\n        title: \"Cuenta\",\r\n        items: [\r\n          { key: \"overview\", label: \"Perfil\", icon: UserCircle },\r\n          { key: \"personal\", label: \"Datos personales\", icon: IdCard },\r\n          { key: \"manage\", label: \"Gestionar cuenta\", icon: AlertTriangle },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Seguridad\",\r\n        items: [\r\n          { key: \"security-access\", label: \"Acceso\", icon: KeyRound },\r\n          { key: \"security-links\", label: \"Cuentas vinculadas\", icon: Link2 },\r\n          { key: \"twofa\", label: \"2FA\", icon: Fingerprint },\r\n          { key: \"sessions\", label: \"Sesiones\", icon: Monitor },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Plan/Tier\",\r\n        items: [\r\n          { key: \"plan\", label: \"Beneficios\", icon: Crown },\r\n          { key: \"payments\", label: \"Pagos\", icon: CreditCard, disabled: true },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Preferencias\",\r\n        items: [\r\n          { key: \"notifications\", label: \"Notificaciones\", icon: Bell },\r\n          { key: \"appearance\", label: \"Apariencia\", icon: Palette },\r\n          { key: \"language\", label: \"Idioma\", icon: Globe },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Soporte\",\r\n        items: [\r\n          { key: \"help\", label: \"Ayuda\", icon: HelpCircle },\r\n          { key: \"feedback\", label: \"Dejar un comentario\", icon: MessageSquare },\r\n        ],\r\n      },\r\n      {\r\n        items: [\r\n          { key: \"signout\", label: \"Cerrar sesion\", icon: LogOut, tone: \"danger\" },\r\n        ],\r\n      },\r\n    ],\r\n    []\r\n  );\r\n\r\n  const tabLabelMap = useMemo(() => {\r\n    const map = {};\r\n    tabGroups.forEach((group) => {\r\n      group.items?.forEach((item) => {\r\n        map[item.key] = item.label;\r\n      });\r\n    });\r\n    return map;\r\n  }, [tabGroups]);\r\n\r\n  const sections = useMemo(\r\n    () => ({\r\n      personal: PersonalDataPanel,\r\n      \"security-access\": AccessPanel,\r\n      \"security-links\": LinkedAccountsPanel,\r\n      overview: OverviewPanel,\r\n      twofa: TwoFAPanel,\r\n      sessions: SessionsPanel,\r\n      notifications: NotificationsPanel,\r\n      plan: BeneficiosPanel,\r\n      appearance: AppAppearancePanel,\r\n      language: LanguagePanel,\r\n      help: HelpPanel,\r\n      feedback: FeedbackPanel,\r\n      manage: ManageAccountPanel,\r\n    }),\r\n    [\r\n      AccessPanel,\r\n      LinkedAccountsPanel,\r\n      NotificationsPanel,\r\n      BeneficiosPanel,\r\n      AppAppearancePanel,\r\n      LanguagePanel,\r\n      HelpPanel,\r\n      FeedbackPanel,\r\n      ManageAccountPanel,\r\n      OverviewPanel,\r\n      PersonalDataPanel,\r\n      SessionsPanel,\r\n      TwoFAPanel,\r\n    ]\r\n  );\r\n\r\n  const handleTabChange = useCallback(\r\n    (nextTab) => {\r\n      if (nextTab === \"signout\") {\r\n        if (tabTransitionRef.current) {\r\n          clearTimeout(tabTransitionRef.current);\r\n        }\r\n        setTabsActiveKey(\"signout\");\r\n        tabTransitionRef.current = setTimeout(() => {\r\n          setTabsActiveKey(null);\r\n          logout();\r\n        }, 140);\r\n        return;\r\n      }\r\n      if (tabTransitionRef.current) {\r\n        clearTimeout(tabTransitionRef.current);\r\n      }\r\n      setTabsActiveKey(nextTab);\r\n      setProfileTab(nextTab);\r\n      tabTransitionRef.current = setTimeout(() => {\r\n        setProfileView(\"panel\");\r\n      }, 140);\r\n    },\r\n    [setProfileTab]\r\n  );\r\n\r\n  const handleBack = useCallback(() => {\r\n    setProfileView(\"tabs\");\r\n    setTabsActiveKey(null);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isActive) {\r\n      setHeaderOptions({\r\n        mode: \"default\",\r\n        onSearchBack: null,\r\n        headerVisible: true,\r\n        profileDockOpen: true,\r\n        profileTitle: \"Configuracion\",\r\n      });\r\n      return undefined;\r\n    }\r\n    const headerTitle =\r\n      profileView === \"panel\"\r\n        ? tabLabelMap[profileTab] || \"Configuracion\"\r\n        : \"Configuracion\";\r\n    setHeaderOptions({\r\n      mode: \"profile\",\r\n      onSearchBack: profileView === \"panel\" ? handleBack : null,\r\n      headerVisible: true,\r\n      profileDockOpen: dockOpenForHeader,\r\n      profileTitle: headerTitle,\r\n    });\r\n    return () => {\r\n      setHeaderOptions({\r\n        mode: \"default\",\r\n        onSearchBack: null,\r\n        headerVisible: true,\r\n        profileDockOpen: true,\r\n        profileTitle: \"Configuracion\",\r\n      });\r\n    };\r\n  }, [\r\n    dockOpenForHeader,\r\n    handleBack,\r\n    isActive,\r\n    profileTab,\r\n    profileView,\r\n    setHeaderOptions,\r\n    tabLabelMap,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    const prev = prevShowSearchDockRef.current;\r\n    prevShowSearchDockRef.current = showSearchDock;\r\n\r\n    if (!showSearchDock) {\r\n      setDockOpenForHeader(false);\r\n      return undefined;\r\n    }\r\n\r\n    if (!prev && showSearchDock) {\r\n      const timer = setTimeout(() => {\r\n        setDockOpenForHeader(true);\r\n      }, 125);\r\n      return () => clearTimeout(timer);\r\n    }\r\n\r\n    setDockOpenForHeader(true);\r\n    return undefined;\r\n  }, [showSearchDock]);\r\n\r\n\r\n  useEffect(() => {\r\n    if (!isActive) {\r\n      setDockTarget(null);\r\n      setDockOpenForHeader(false);\r\n      return;\r\n    }\r\n    setDockTarget(document.getElementById(\"cliente-header-search-dock\"));\r\n  }, [isActive]);\r\n\r\n  useEffect(() => {\r\n    if (profileView !== \"tabs\") {\r\n      setTabsActiveKey(null);\r\n    }\r\n  }, [profileView]);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (tabTransitionRef.current) {\r\n        clearTimeout(tabTransitionRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"flex h-full flex-col bg-white\">\r\n      {isActive && dockTarget\r\n        ? createPortal(\r\n            <HeaderPanelContainer\r\n              open\r\n              panelClassName=\"hero-search-dock profile-search-dock\"\r\n              panelProps={{\r\n                \"aria-hidden\": !showSearchDock,\r\n                style: { pointerEvents: showSearchDock ? \"auto\" : \"none\" },\r\n              }}\r\n            >\r\n              <div className=\"profile-search-clip\">\r\n                <motion.div\r\n                  className=\"profile-search-panel\"\r\n                  initial={false}\r\n                  animate={{\r\n                    y: showSearchDock ? \"0%\" : \"-100%\",\r\n                  }}\r\n                  transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n                >\r\n                  <SearchbarPanel\r\n                    value={searchValue}\r\n                    onChange={setSearchValue}\r\n                  />\r\n                </motion.div>\r\n              </div>\r\n            </HeaderPanelContainer>,\r\n            dockTarget\r\n          )\r\n        : null}\r\n      <div className=\"relative flex-1 overflow-y-auto bg-white\">\r\n        <AnimatePresence mode=\"wait\">\r\n          {profileView === \"tabs\" ? (\r\n            <motion.div\r\n              key=\"profile-tabs-screen\"\r\n              initial={{ x: 40, opacity: 0 }}\r\n              animate={{ x: 0, opacity: 1 }}\r\n              exit={{ x: -40, opacity: 0 }}\r\n              transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n              className=\"w-full\"\r\n            >\r\n              <div className=\"w-full flex flex-col items-center gap-4 pt-16 pb-6\">\r\n                <div className=\"w-[98%] max-w-md bg-white\">\r\n                  <ProfileTabs\r\n                    groups={tabGroups}\r\n                    active={tabsActiveKey}\r\n                    onChange={handleTabChange}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </motion.div>\r\n          ) : (\r\n            <motion.div\r\n              key=\"profile-panel\"\r\n              initial={{ x: 40, opacity: 0 }}\r\n              animate={{ x: 0, opacity: 1 }}\r\n              exit={{ x: -40, opacity: 0 }}\r\n              transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n              className=\"w-full flex flex-col items-center gap-4 pt-16 pb-6\"\r\n            >\r\n              <div className=\"w-[90%] max-w-md\">\r\n                <ProfilePanel\r\n                  activeTab={profileTab}\r\n                  sections={sections}\r\n                  usuario={usuario}\r\n                  setUser={setUser}\r\n                />\r\n              </div>\r\n            </motion.div>\r\n          )}\r\n        </AnimatePresence>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\negocio\\NegocioPerfil.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'motion' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":3,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":33,"suggestions":[{"messageId":"removeVar","data":{"varName":"motion"},"fix":{"range":[150,158],"text":""},"desc":"Remove unused variable 'motion'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'navigate' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":133,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":133,"endColumn":17,"suggestions":[{"messageId":"removeVar","data":{"varName":"navigate"},"fix":{"range":[5155,5186],"text":""},"desc":"Remove unused variable 'navigate'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'loadOwnerSessions'. Either include it or remove the dependency array.","line":303,"column":5,"nodeType":"ArrayExpression","endLine":309,"endColumn":6,"suggestions":[{"desc":"Update the dependencies array to be: [handleCloseAllOwners, handleCloseOwnerSession, loadOwnerSessions, ownerSessions, sessionsError, sessionsLoading]","fix":{"range":[11545,11682],"text":"[handleCloseAllOwners, handleCloseOwnerSession, loadOwnerSessions, ownerSessions, sessionsError, sessionsLoading]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'passwordAttempted' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":423,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":423,"endColumn":31,"suggestions":[{"messageId":"removeVar","data":{"varName":"passwordAttempted"},"fix":{"range":[15748,15765],"text":""},"desc":"Remove unused variable 'passwordAttempted'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'requestLocalVerification', 'requestPasswordVerification', and 'setUser'. Either include them or remove the dependency array.","line":1060,"column":6,"nodeType":"ArrayExpression","endLine":1060,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [requestLocalVerification, requestPasswordVerification, setUser]","fix":{"range":[38799,38801],"text":"[requestLocalVerification, requestPasswordVerification, setUser]"}}]},{"ruleId":"no-unused-vars","severity":2,"message":"'pushEnabled' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":1126,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":1126,"endColumn":23,"suggestions":[{"messageId":"removeVar","data":{"varName":"pushEnabled"},"fix":{"range":[41047,41058],"text":""},"desc":"Remove unused variable 'pushEnabled'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'PersonalDataPanel' function makes the dependencies of useMemo Hook (at line 1731) change on every render. Move it inside the useMemo callback. Alternatively, wrap the definition of 'PersonalDataPanel' in its own useCallback() Hook.","line":1480,"column":3,"nodeType":"FunctionDeclaration","endLine":1653,"endColumn":4},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initial'. Either include it or remove the dependency array.","line":1507,"column":8,"nodeType":"ArrayExpression","endLine":1513,"endColumn":6,"suggestions":[{"desc":"Update the dependencies array to be: [initial.nombres, initial.apellidos, initial.direccion, initial.email, initial.telefono, initial]","fix":{"range":[53097,53228],"text":"[initial.nombres, initial.apellidos, initial.direccion, initial.email, initial.telefono, initial]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'logout'. Either include it or remove the dependency array.","line":1780,"column":5,"nodeType":"ArrayExpression","endLine":1780,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [logout, setProfileTab]","fix":{"range":[61953,61968],"text":"[logout, setProfileTab]"}}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useMemo, useState, useCallback, useEffect, useRef } from \"react\";\r\nimport { createPortal } from \"react-dom\";\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport {\r\n  AlertTriangle,\r\n  Bell,\r\n  CreditCard,\r\n  Crown,\r\n  Fingerprint,\r\n  Globe,\r\n  HelpCircle,\r\n  IdCard,\r\n  KeyRound,\r\n  Laptop,\r\n  Link2,\r\n  LogOut,\r\n  MessageSquare,\r\n  Monitor,\r\n  Palette,\r\n  Sparkles,\r\n  ShieldCheck,\r\n  Smartphone,\r\n  RefreshCcw,\r\n  TriangleAlert,\r\n  Shield,\r\n  Tablet,\r\n  UserCircle,\r\n  X,\r\n} from \"lucide-react\";\r\nimport { useAppStore } from \"../../store/appStore\";\r\nimport usePinSetup from \"../../hooks/usePinSetup\";\r\nimport { useLocation, useNavigate } from \"react-router-dom\";\r\nimport { useNegocioUI } from \"../../negocio/hooks/useNegocioUI\";\r\nimport {\r\n  formatReadableDate,\r\n  getAvatarSrc,\r\n  getPlanFallback,\r\n  getRoleLabel,\r\n} from \"../../cliente/services/clienteUI\";\r\nimport ProfileTabs from \"../shared/ProfileTabs\";\r\nimport ProfilePanel from \"../shared/ProfilePanel\";\r\nimport {\r\n  HeaderPanelContainer,\r\n  SearchbarPanel,\r\n} from \"../../layouts/header-panels\";\r\nimport { useNegocioHeader } from \"../../negocio/layout/NegocioHeaderContext\";\r\nimport { useCacheStore } from \"../../cache/cacheStore\";\r\nimport { CACHE_KEYS } from \"../../cache/cacheKeys\";\r\nimport ProfileOverview from \"../shared/sections/ProfileOverview\";\r\nimport PersonalData from \"../shared/sections/PersonalData\";\r\nimport Access from \"../shared/sections/Access\";\r\nimport LinkedAccounts from \"../shared/sections/LinkedAccounts\";\r\nimport TwoFA from \"../shared/sections/TwoFA\";\r\nimport Sessions from \"../shared/sections/Sessions\";\r\nimport Notifications from \"../shared/sections/Notifications\";\r\nimport Beneficios from \"../shared/sections/Beneficios\";\r\nimport ManageAccount from \"../shared/sections/ManageAccount\";\r\nimport AppAppearance from \"../shared/sections/AppAppearance\";\r\nimport Language from \"../shared/sections/Language\";\r\nimport Help from \"../shared/sections/Help\";\r\nimport SupportChat from \"../shared/sections/SupportChat\";\r\nimport SupportEmail from \"../shared/sections/SupportEmail\";\r\nimport Feedback from \"../shared/sections/Feedback\";\r\nimport AccountStatusCard from \"../shared/blocks/AccountStatusCard\";\r\nimport BenefitsCard from \"../shared/blocks/BenefitsCard\";\r\nimport DangerZone from \"../shared/blocks/DangerZone\";\r\nimport FingerprintAccessCard from \"../shared/blocks/FingerprintAccessCard\";\r\nimport FontSelector from \"../shared/blocks/FontSelector\";\r\nimport IdentityCard from \"../shared/blocks/IdentityCard\";\r\nimport LanguageSelector from \"../shared/blocks/LanguageSelector\";\r\nimport NegocioIdentityCard from \"../shared/blocks/NegocioIdentityCard\";\r\nimport LinkedAccountsCard from \"../shared/blocks/LinkedAccountsCard\";\r\nimport PlanBenefitsCard from \"../shared/blocks/PlanBenefitsCard\";\r\nimport PasswordAccessCard from \"../shared/blocks/PasswordAccessCard\";\r\nimport PinAccessCard from \"../shared/blocks/PinAccessCard\";\r\nimport PersonalDataBlock from \"../shared/blocks/PersonalDataBlock\";\r\nimport SessionsList from \"../shared/blocks/SessionsList\";\r\nimport ThemeSelector from \"../shared/blocks/ThemeSelector\";\r\nimport TwoFACard from \"../shared/blocks/TwoFACard\";\r\nimport useMfaState from \"../shared/hooks/useMfaState\";\r\nimport SupportHelpOptions from \"../shared/blocks/SupportHelpOptions\";\r\nimport FaqContent from \"../shared/blocks/FaqContent\";\r\nimport SupportFeedbackForm from \"../shared/blocks/SupportFeedbackForm\";\r\nimport NotificationsPreferencesCard, {\r\n  DEFAULT_NOTIFICATION_PREFS,\r\n  NOTIFICATION_CHANNELS,\r\n} from \"../shared/blocks/NotificationsPreferencesCard\";\r\nimport VerificationCard from \"../shared/blocks/VerificationCard\";\r\nimport { useModal } from \"../../modals/useModal\";\r\nimport { supabase } from \"../../lib/supabaseClient\";\r\nimport {\r\n  listCurrentUserSessions,\r\n  revokeAllSessions,\r\n  revokeSessionById,\r\n} from \"../../services/sessionDevicesService\";\r\nimport {\r\n  deleteBiometricToken,\r\n  deletePinHash,\r\n  generatePinSalt,\r\n  hashPin,\r\n  loadDeviceSecret,\r\n  saveBiometricToken,\r\n  saveDeviceSecret,\r\n  savePinHash,\r\n} from \"../../services/secureStorageService\";\r\nimport { logCatalogBreadcrumb } from \"../../services/loggingClient\";\r\n\r\nconst getDeviceIcon = (session) => {\r\n  const raw = `${session?.device || \"\"} ${session?.platform || \"\"}`.toLowerCase();\r\n  if (raw.includes(\"movil\") || raw.includes(\"android\") || raw.includes(\"ios\")) {\r\n    return Smartphone;\r\n  }\r\n  if (raw.includes(\"tablet\")) return Tablet;\r\n  if (raw.includes(\"pwa\")) return Monitor;\r\n  return Laptop;\r\n};\r\nlet accessInfoDismissed = false;\r\n\r\nexport default function NegocioPerfil() {\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const setUser = useAppStore((s) => s.setUser);\r\n  const logout = useAppStore((s) => s.logout);\r\n  const accessMethods = useAppStore((s) => s.accessMethods);\r\n  const requestLocalVerification = useAppStore(\r\n    (s) => s.security.requestLocalVerification\r\n  );\r\n  const requestPasswordVerification = useAppStore(\r\n    (s) => s.security.requestPasswordVerification\r\n  );\r\n  const { openModal } = useModal();\r\n  const { setHeaderOptions } = useNegocioHeader();\r\n  const navigate = useNavigate();\r\n  const isActive = useCacheStore(\r\n    (state) => state.activeKeys.negocio === CACHE_KEYS.NEGOCIO_PERFIL\r\n  );\r\n  const { profileTab, setProfileTab } = useNegocioUI({\r\n    defaultProfileTab: \"overview\",\r\n  });\r\n  const location = useLocation();\r\n  const [profileView, setProfileView] = useState(\"tabs\");\r\n  const [tabsActiveKey, setTabsActiveKey] = useState(null);\r\n  const tabTransitionRef = useRef(null);\r\n  const [searchValue, setSearchValue] = useState(\"\");\r\n  const [dockTarget, setDockTarget] = useState(null);\r\n  const showSearchDock = profileView === \"tabs\";\r\n  const [dockOpenForHeader, setDockOpenForHeader] = useState(showSearchDock);\r\n  const prevShowSearchDockRef = useRef(showSearchDock);\r\n  const deepLinkAppliedRef = useRef(false);\r\n  const [ownerSessions, setOwnerSessions] = useState([]);\r\n  const [sessionsLoading, setSessionsLoading] = useState(false);\r\n  const [sessionsError, setSessionsError] = useState(null);\r\n  const twoFASms = false;\r\n  const {\r\n    loading: mfaLoading,\r\n    error: mfaError,\r\n    totpEnabled,\r\n    totpFactorId,\r\n    refresh: refreshMfa,\r\n  } = useMfaState();\r\n  const [twoFADismissed, setTwoFADismissed] = useState(false);\r\n  const [helpView, setHelpView] = useState(\"menu\");\r\n\r\n  const loadOwnerSessions = useCallback(async () => {\r\n    setSessionsLoading(true);\r\n    setSessionsError(null);\r\n    const result = await listCurrentUserSessions();\r\n    if (!result?.ok) {\r\n      setSessionsError(result?.error || \"No se pudieron cargar las sesiones.\");\r\n      setSessionsLoading(false);\r\n      return;\r\n    }\r\n    setOwnerSessions(result.sessions || []);\r\n    setSessionsLoading(false);\r\n  }, []);\r\n\r\n  const handleCloseOwnerSession = useCallback(\r\n    async (session) => {\r\n      if (!session?.sessionId) return;\r\n      setSessionsLoading(true);\r\n      setSessionsError(null);\r\n      const result = await revokeSessionById(session.sessionId);\r\n      if (!result?.ok) {\r\n        setSessionsError(result?.error || \"No se pudo cerrar la sesion.\");\r\n        setSessionsLoading(false);\r\n        return;\r\n      }\r\n      if (result?.current_session_revoked) {\r\n        await logout();\r\n        return;\r\n      }\r\n      await loadOwnerSessions();\r\n    },\r\n    [loadOwnerSessions, logout],\r\n  );\r\n\r\n  const handleCloseAllOwners = useCallback(async () => {\r\n    setSessionsLoading(true);\r\n    setSessionsError(null);\r\n    const result = await revokeAllSessions();\r\n    if (!result?.ok) {\r\n      setSessionsError(result?.error || \"No se pudieron cerrar las sesiones.\");\r\n      setSessionsLoading(false);\r\n      return;\r\n    }\r\n    await logout();\r\n  }, [logout]);\r\n\r\n  useEffect(() => {\r\n    if (profileView !== \"tabs\" || profileTab !== \"sessions\") return;\r\n    loadOwnerSessions();\r\n  }, [loadOwnerSessions, profileTab, profileView]);\r\n\r\n  const SessionsPanel = useCallback(\r\n    () => (\r\n      <div className=\"flex flex-col gap-6\">\r\n        <Sessions\r\n          title=\"Sesiones de cuenta propietario\"\r\n          subtitle=\"Controla los accesos activos en tu cuenta.\"\r\n          subtitleAction={\r\n            <button\r\n              type=\"button\"\r\n              className=\"rounded-xl border border-[#E9E2F7] bg-white p-2 text-slate-500 transition hover:text-[#5E30A5] disabled:opacity-60\"\r\n              title=\"Refrescar sesiones\"\r\n              onClick={loadOwnerSessions}\r\n              disabled={sessionsLoading}\r\n              aria-label=\"Refrescar sesiones\"\r\n            >\r\n              <RefreshCcw\r\n                size={16}\r\n                className={sessionsLoading ? \"animate-spin\" : undefined}\r\n              />\r\n            </button>\r\n          }\r\n          blocks={[\r\n            <SessionsList\r\n              key=\"owner-sessions\"\r\n              items={ownerSessions}\r\n              renderLeading={(session) => {\r\n                const Icon = getDeviceIcon(session);\r\n                return <Icon size={18} />;\r\n              }}\r\n              getPrimaryText={(session) => session.device}\r\n              getSecondaryText={(session) =>\r\n                `${session.location} - ${session.lastActive}`\r\n              }\r\n              renderTrailing={(session) =>\r\n                session.current ? (\r\n                  <span className=\"rounded-xl bg-[#F3EEFF] px-2 py-1 text-[10px] font-semibold text-[#5E30A5]\">\r\n                    Actual\r\n                  </span>\r\n                ) : (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => handleCloseOwnerSession(session)}\r\n                    className=\"rounded-xl border border-red-200 px-2 py-1 text-[10px] font-semibold text-red-600 transition hover:bg-red-50\"\r\n                  >\r\n                    Cerrar\r\n                  </button>\r\n                )}\r\n            />,\r\n            sessionsLoading && ownerSessions.length === 0 ? (\r\n              <div\r\n                key=\"sessions-loading\"\r\n                className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] px-4 py-3 text-[11px] text-slate-500 text-center\"\r\n              >\r\n                Cargando sesiones...\r\n              </div>\r\n            ) : null,\r\n            sessionsError ? (\r\n              <div\r\n                key=\"sessions-error\"\r\n                className=\"rounded-2xl border border-red-100 bg-red-50 px-4 py-3 text-[11px] text-red-500 text-center\"\r\n              >\r\n                {sessionsError}\r\n              </div>\r\n            ) : null,\r\n          ]}\r\n          footer={\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleCloseAllOwners}\r\n              disabled={sessionsLoading}\r\n              className=\"w-full rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-left text-xs font-semibold text-red-600 transition hover:bg-red-100\"\r\n            >\r\n              <div className=\"flex items-center gap-2\">\r\n                <span className=\"h-8 w-8 rounded-xl bg-red-100 text-red-600 flex items-center justify-center\">\r\n                  <LogOut size={16} />\r\n                </span>\r\n                <div>\r\n                  <div>Cerrar todas</div>\r\n                  <div className=\"mt-1 text-[11px] font-normal text-red-500\">\r\n                    Esto cierra sesion en todos los dispositivos, incluido el\r\n                    actual.\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </button>\r\n          }\r\n        />\r\n      </div>\r\n    ),\r\n    [\r\n      handleCloseAllOwners,\r\n      handleCloseOwnerSession,\r\n      ownerSessions,\r\n      sessionsError,\r\n      sessionsLoading,\r\n    ]\r\n  );\r\n\r\n  const TwoFAPanel = useCallback(\r\n    () => (\r\n      <TwoFA\r\n        title=\"Autenticacion en dos pasos\"\r\n        subtitle=\"Refuerza tu seguridad con factores adicionales.\"\r\n        blocks={[\r\n          <TwoFACard\r\n            key=\"twofa\"\r\n            factors={[\r\n              {\r\n                id: \"totp\",\r\n                title: \"App autenticadora\",\r\n                description: \"TOTP para accesos seguros.\",\r\n                toggle: {\r\n                  active: totpEnabled,\r\n                  onChange: () => {\r\n                    if (mfaLoading) return;\r\n                    if (totpEnabled) {\r\n                      openModal(\"TwoFADisable\", {\r\n                        factorId: totpFactorId,\r\n                        onDisabled: refreshMfa,\r\n                      });\r\n                      return;\r\n                    }\r\n                    openModal(\"TwoFAEnroll\", {\r\n                      onComplete: refreshMfa,\r\n                    });\r\n                  },\r\n                  disabled: mfaLoading,\r\n                },\r\n              },\r\n              {\r\n                id: \"sms\",\r\n                title: \"SMS\",\r\n                badge: \"No disponible aun\",\r\n                description: \"Codigo enviado al telefono.\",\r\n                disabled: true,\r\n                toggle: {\r\n                  active: twoFASms,\r\n                  onChange: () => {},\r\n                  disabled: true,\r\n                },\r\n              },\r\n            ]}\r\n          />,\r\n          mfaError ? (\r\n            <div\r\n              key=\"mfa-error\"\r\n              className=\"rounded-2xl border border-red-100 bg-red-50 px-4 py-3 text-[11px] text-red-500\"\r\n            >\r\n              {mfaError}\r\n            </div>\r\n          ) : null,\r\n        ]}\r\n        notice={\r\n          !twoFADismissed ? (\r\n            <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4 flex items-center gap-3 text-xs text-slate-500\">\r\n              <ShieldCheck size={16} className=\"text-[#5E30A5]\" />\r\n              Mantener 2FA activo reduce riesgos de acceso no autorizado.\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setTwoFADismissed(true)}\r\n                className=\"ml-auto text-slate-400 hover:text-slate-500\"\r\n                aria-label=\"Cerrar aviso\"\r\n              >\r\n                <X size={14} />\r\n              </button>\r\n            </div>\r\n          ) : null\r\n        }\r\n      />\r\n    ),\r\n    [\r\n      twoFADismissed,\r\n      twoFASms,\r\n      totpEnabled,\r\n      mfaLoading,\r\n      mfaError,\r\n      openModal,\r\n      refreshMfa,\r\n      totpFactorId,\r\n    ]\r\n  );\r\n\r\n  const AccessPanel = useCallback(function AccessPanel({ usuario: accessUser }) {\r\n    const { openModal } = useModal();\r\n    const setAccessMethods = useAppStore((s) => s.setAccessMethods);\r\n    const setSuspendViewportResize = useAppStore(\r\n      (s) => s.setSuspendViewportResize\r\n    );\r\n    const setSuspendViewportAfterNext = useAppStore(\r\n      (s) => s.setSuspendViewportAfterNext\r\n    );\r\n    const freezeViewportAfterNextUpdate = useAppStore(\r\n      (s) => s.freezeViewportAfterNextUpdate\r\n    );\r\n    const onboarding = useAppStore((s) => s.onboarding);\r\n    const emailVerifiedSessionAt = useAppStore((s) => s.emailVerifiedSessionAt);\r\n    const setEmailVerifiedSessionAt = useAppStore(\r\n      (s) => s.setEmailVerifiedSessionAt\r\n    );\r\n    const [fingerprintEnabled, setFingerprintEnabled] = useState(false);\r\n    const [pinEnabled, setPinEnabled] = useState(false);\r\n    const [showPasswordForm, setShowPasswordForm] = useState(false);\r\n    const [passwordMode, setPasswordMode] = useState(\"add\");\r\n    const [currentPassword, setCurrentPassword] = useState(\"\");\r\n    const [passwordValue, setPasswordValue] = useState(\"\");\r\n    const [passwordConfirm, setPasswordConfirm] = useState(\"\");\r\n    const [showPassword, setShowPassword] = useState(false);\r\n      const [showPasswordConfirm, setShowPasswordConfirm] = useState(false);\r\n      const [showCurrentPassword, setShowCurrentPassword] = useState(false);\r\n      const [passwordAttempted, setPasswordAttempted] = useState(false);\r\n      const [showPinForm, setShowPinForm] = useState(false);\r\n      const [focusedField, setFocusedField] = useState(null);\r\n    const [authProvider, setAuthProvider] = useState(null);\r\n    const [passwordEnabled, setPasswordEnabled] = useState(null);\r\n    const [removalBlocked, setRemovalBlocked] = useState(false);\r\n    const [dismissedMethodsWarning, setDismissedMethodsWarning] = useState(false);\r\n    const [dismissedInfo, setDismissedInfo] = useState(accessInfoDismissed);\r\n    const [emailWarningOpen, setEmailWarningOpen] = useState(false);\r\n    const [emailWarningPulse, setEmailWarningPulse] = useState(false);\r\n    const passwordFormRef = useRef(null);\r\n    const currentPasswordRef = useRef(null);\r\n    const passwordInputRef = useRef(null);\r\n    const confirmInputRef = useRef(null);\r\n      const prevUserIdRef = useRef(null);\r\n    const provider = (authProvider || accessUser?.provider || \"\").toLowerCase();\r\n    const emailConfirmed = Boolean(onboarding?.email_confirmed);\r\n    const emailRecentlyVerified =\r\n      Boolean(emailVerifiedSessionAt) &&\r\n      Date.now() - emailVerifiedSessionAt < 2 * 60 * 60 * 1000;\r\n    const hasPassword =\r\n      Boolean(accessUser?.has_password) ||\r\n      provider === \"email\" ||\r\n      provider === \"password\";\r\n    const passwordActive = passwordEnabled ?? hasPassword;\r\n    const methodsCount =\r\n      (passwordActive ? 1 : 0) +\r\n      (fingerprintEnabled ? 1 : 0) +\r\n      (pinEnabled ? 1 : 0);\r\n    const showMethodsWarning =\r\n      (methodsCount === 0 || removalBlocked) && !dismissedMethodsWarning;\r\n    const showEmailWarning = !emailConfirmed && emailWarningOpen;\r\n    const emailWarningClass = emailWarningPulse\r\n      ? \"animate-[pulse_1.6s_ease-in-out_1]\"\r\n      : \"\";\r\n\r\n    useEffect(() => {\r\n      if (!emailConfirmed) {\r\n        setEmailWarningOpen(true);\r\n      }\r\n    }, [emailConfirmed]);\r\n\r\n    useEffect(() => {\r\n      if (!emailWarningPulse) return undefined;\r\n      const timer = setTimeout(() => setEmailWarningPulse(false), 1600);\r\n      return () => clearTimeout(timer);\r\n    }, [emailWarningPulse]);\r\n\r\n    const triggerEmailWarning = useCallback(() => {\r\n      if (emailWarningOpen) {\r\n        setEmailWarningPulse(true);\r\n        return;\r\n      }\r\n      setEmailWarningOpen(true);\r\n    }, [emailWarningOpen]);\r\n\r\n    useEffect(() => {\r\n      let active = true;\r\n      const loadProvider = async () => {\r\n        const { data } = await supabase.auth.getSession();\r\n        const nextProvider = data?.session?.user?.app_metadata?.provider ?? null;\r\n        if (active) {\r\n          setAuthProvider(nextProvider);\r\n        }\r\n      };\r\n      loadProvider();\r\n      return () => {\r\n        active = false;\r\n      };\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n      if (passwordEnabled === null) {\r\n        setPasswordEnabled(hasPassword);\r\n        return;\r\n      }\r\n      if (!hasPassword && passwordEnabled) {\r\n        setPasswordEnabled(false);\r\n      }\r\n    }, [hasPassword, passwordEnabled]);\r\n\r\n    useEffect(() => {\r\n      if (passwordActive && showPasswordForm && passwordMode === \"add\") {\r\n        setShowPasswordForm(false);\r\n      }\r\n    }, [passwordActive, showPasswordForm, passwordMode]);\r\n\r\n    useEffect(() => {\r\n      if (methodsCount === 0) {\r\n        setDismissedMethodsWarning(false);\r\n      }\r\n    }, [methodsCount]);\r\n\r\n    useEffect(() => {\r\n      setAccessMethods({\r\n        fingerprint: fingerprintEnabled,\r\n        pin: pinEnabled,\r\n        password: passwordActive,\r\n      });\r\n    }, [fingerprintEnabled, passwordActive, pinEnabled, setAccessMethods]);\r\n\r\n    useEffect(() => {\r\n      const currentId = accessUser?.id_auth ?? null;\r\n      if (prevUserIdRef.current !== currentId) {\r\n        prevUserIdRef.current = currentId;\r\n        accessInfoDismissed = false;\r\n        setDismissedInfo(false);\r\n      }\r\n      setFingerprintEnabled(Boolean(accessUser?.has_biometrics));\r\n      setPinEnabled(Boolean(accessUser?.has_pin));\r\n    }, [accessUser?.id_auth, accessUser?.has_biometrics, accessUser?.has_pin]);\r\n\r\n    useEffect(() => {\r\n      if (methodsCount > 1 && removalBlocked) {\r\n        setRemovalBlocked(false);\r\n      }\r\n    }, [methodsCount, removalBlocked]);\r\n\r\n    const handlePasswordFocus = useCallback((field) => {\r\n      setFocusedField(field);\r\n    }, []);\r\n\r\n    const handlePasswordBlur = useCallback(() => {\r\n      requestAnimationFrame(() => {\r\n        const active = document.activeElement;\r\n        if (active === currentPasswordRef.current) {\r\n          setFocusedField(\"current\");\r\n          return;\r\n        }\r\n        if (active === passwordInputRef.current) {\r\n          setFocusedField(\"new\");\r\n          return;\r\n        }\r\n        if (active === confirmInputRef.current) {\r\n          setFocusedField(\"confirm\");\r\n          return;\r\n        }\r\n        setFocusedField(null);\r\n      });\r\n    }, []);\r\n\r\n    const hasMinLength = passwordValue.length >= 8;\r\n    const hasNumber = /\\d/.test(passwordValue);\r\n    const hasSymbol = /[^A-Za-z0-9]/.test(passwordValue);\r\n    const hasNumberAndSymbol = hasNumber && hasSymbol;\r\n    const passwordsMatch =\r\n      passwordValue.length > 0 &&\r\n      passwordConfirm.length > 0 &&\r\n      passwordValue === passwordConfirm;\r\n    const showPasswordRules = focusedField === \"new\" || passwordValue.length > 0;\r\n    const showPasswordErrors = focusedField !== \"new\" && passwordValue.length > 0;\r\n    const showConfirmErrors =\r\n      focusedField !== \"confirm\" && passwordConfirm.length > 0;\r\n    const showConfirmRule =\r\n      hasMinLength && hasNumberAndSymbol && passwordConfirm.length > 0;\r\n    const canSavePassword = hasMinLength && hasNumberAndSymbol && passwordsMatch;\r\n    const showCurrentPasswordError = false;\r\n\r\n    const handlePasswordCancel = () => {\r\n      setPasswordValue(\"\");\r\n      setPasswordConfirm(\"\");\r\n      setCurrentPassword(\"\");\r\n      setFocusedField(null);\r\n      setPasswordMode(\"add\");\r\n      setPasswordAttempted(false);\r\n      setShowPasswordForm(false);\r\n      document.activeElement?.blur();\r\n    };\r\n\r\n    const handlePasswordSave = async () => {\r\n      setPasswordAttempted(true);\r\n      if (!canSavePassword) return;\r\n      setPasswordEnabled(true);\r\n      setShowPasswordForm(false);\r\n      setPasswordMode(\"add\");\r\n      setPasswordAttempted(false);\r\n      const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n      if (userId) {\r\n        await supabase\r\n          .from(\"usuarios\")\r\n          .update({ has_password: true, must_change_password: false })\r\n          .eq(\"id_auth\", userId);\r\n      }\r\n      if (accessUser) {\r\n        setUser({\r\n          ...accessUser,\r\n          has_password: true,\r\n          must_change_password: false,\r\n        });\r\n      }\r\n    };\r\n\r\n    const openAddPassword = () => {\r\n      if (!emailConfirmed) {\r\n        triggerEmailWarning();\r\n        openModal(\"EmailVerification\", {\r\n          email: accessUser?.email ?? null,\r\n        });\r\n        return;\r\n      }\r\n      if (!emailRecentlyVerified) {\r\n        openModal(\"EmailReauth\", {\r\n          email: accessUser?.email ?? null,\r\n          onConfirm: () => {\r\n            setEmailVerifiedSessionAt(Date.now());\r\n            setPasswordMode(\"add\");\r\n            setCurrentPassword(\"\");\r\n            setPasswordValue(\"\");\r\n            setPasswordConfirm(\"\");\r\n            setPasswordAttempted(false);\r\n            setShowPasswordForm(true);\r\n          },\r\n        });\r\n        return;\r\n      }\r\n      setPasswordMode(\"add\");\r\n      setCurrentPassword(\"\");\r\n      setPasswordValue(\"\");\r\n      setPasswordConfirm(\"\");\r\n      setPasswordAttempted(false);\r\n      setShowPasswordForm(true);\r\n    };\r\n\r\n    const openChangePassword = () => {\r\n      requestPasswordVerification({\r\n        requireVerifiedEmail: true,\r\n        onBlocked: triggerEmailWarning,\r\n        onVerified: () => {\r\n          setPasswordMode(\"change\");\r\n          setCurrentPassword(\"\");\r\n          setPasswordValue(\"\");\r\n          setPasswordConfirm(\"\");\r\n          setPasswordAttempted(false);\r\n          setShowPasswordForm(true);\r\n        },\r\n        email: accessUser?.email ?? null,\r\n      });\r\n    };\r\n\r\n    const savePin = useCallback(async (nextPin) => {\r\n      const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n      if (!userId) {\r\n        return { ok: false, error: \"No se pudo obtener sesion.\" };\r\n      }\r\n      const existingSecret = await loadDeviceSecret(userId);\r\n      if (!existingSecret) {\r\n        const bytes = window.crypto.getRandomValues(new Uint8Array(32));\r\n        const token = btoa(String.fromCharCode(...bytes));\r\n        await saveDeviceSecret(userId, { token, createdAt: new Date().toISOString() });\r\n      }\r\n      const salt = generatePinSalt();\r\n      const hash = await hashPin(nextPin, salt);\r\n      const saved = await savePinHash(userId, {\r\n        salt,\r\n        hash,\r\n        iterations: 160000,\r\n        algo: \"PBKDF2-SHA256\",\r\n      });\r\n      if (!saved.ok) {\r\n        return { ok: false, error: \"No se pudo guardar el PIN.\" };\r\n      }\r\n      const { error: updErr } = await supabase\r\n        .from(\"usuarios\")\r\n        .update({ has_pin: true })\r\n        .eq(\"id_auth\", userId);\r\n      if (updErr) {\r\n        return { ok: false, error: updErr.message || \"No se pudo guardar el PIN.\" };\r\n      }\r\n      return { ok: true };\r\n    }, [accessUser?.id_auth, accessUser?.id]);\r\n\r\n    const pinSetup = usePinSetup({ onSavePin: savePin });\r\n    const pinValue = pinSetup.pinValue;\r\n    const pinSlots = pinSetup.pinSlots;\r\n    const pinReveal = pinSetup.pinReveal;\r\n    const pinStep = pinSetup.pinStep;\r\n    const pinComplete = pinSetup.pinComplete;\r\n    const pinMatches = pinSetup.pinMatches;\r\n    const pinFocused = pinSetup.pinFocused;\r\n\r\n    const resetPinForm = useCallback(() => {\r\n      pinSetup.resetPinForm();\r\n      setShowPinForm(false);\r\n      setSuspendViewportResize(false);\r\n      setSuspendViewportAfterNext(false);\r\n      document.activeElement?.blur();\r\n    }, [pinSetup, setSuspendViewportAfterNext, setSuspendViewportResize]);\r\n\r\n    const openPinForm = () => {\r\n      pinSetup.resetPinForm();\r\n      setShowPinForm(true);\r\n      window.requestAnimationFrame(() => {\r\n        pinSetup.focusHiddenInput();\r\n      });\r\n    };\r\n\r\n    const handlePinNext = () => {\r\n      if (!pinComplete) return;\r\n      setSuspendViewportAfterNext(false);\r\n      setSuspendViewportResize(true);\r\n      pinSetup.handlePinNext();\r\n      window.requestAnimationFrame(() => {\r\n        pinSetup.focusHiddenInput();\r\n      });\r\n    };\r\n\r\n    const handlePinConfirm = async () => {\r\n      const result = await pinSetup.handlePinConfirm();\r\n      if (!result?.ok) return;\r\n      setPinEnabled(true);\r\n      if (accessUser) {\r\n        setUser({ ...accessUser, has_pin: true });\r\n      }\r\n      resetPinForm();\r\n    };\r\n\r\n    const handleRemoveFingerprint = () => {\r\n      if (methodsCount <= 1) {\r\n        setRemovalBlocked(true);\r\n        setDismissedMethodsWarning(false);\r\n        return;\r\n      }\r\n      requestLocalVerification({\r\n        onVerified: () => {\r\n          openModal(\"ConfirmAction\", {\r\n            title: \"Quitar huella\",\r\n            message: \"Seguro que deseas quitar la huella?\",\r\n            confirmLabel: \"Confirmar\",\r\n            cancelLabel: \"Cancelar\",\r\n            onConfirm: async () => {\r\n              const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n              if (userId) {\r\n                await supabase\r\n                  .from(\"usuarios\")\r\n                  .update({ has_biometrics: false })\r\n                  .eq(\"id_auth\", userId);\r\n                await deleteBiometricToken(userId);\r\n              }\r\n              setFingerprintEnabled(false);\r\n              if (accessUser) {\r\n                setUser({ ...accessUser, has_biometrics: false });\r\n              }\r\n            },\r\n          });\r\n        },\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    const handleRemovePin = () => {\r\n      if (methodsCount <= 1) {\r\n        setRemovalBlocked(true);\r\n        setDismissedMethodsWarning(false);\r\n        return;\r\n      }\r\n      requestLocalVerification({\r\n        onVerified: () => {\r\n          openModal(\"ConfirmAction\", {\r\n            title: \"Quitar PIN\",\r\n            message: \"Seguro que deseas quitar el PIN?\",\r\n            confirmLabel: \"Confirmar\",\r\n            cancelLabel: \"Cancelar\",\r\n            onConfirm: async () => {\r\n              const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n              if (userId) {\r\n                await supabase\r\n                  .from(\"usuarios\")\r\n                  .update({ has_pin: false })\r\n                  .eq(\"id_auth\", userId);\r\n                await deletePinHash(userId);\r\n              }\r\n              setPinEnabled(false);\r\n              if (accessUser) {\r\n                setUser({ ...accessUser, has_pin: false });\r\n              }\r\n            },\r\n          });\r\n        },\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    const handlePinPointerDown = (event) => {\r\n      event.preventDefault();\r\n      pinSetup.focusHiddenInput();\r\n    };\r\n\r\n    const registerHiddenRef = (el) => {\r\n      pinSetup.registerHiddenRef(el);\r\n    };\r\n\r\n    const handlePinFocus = useCallback(() => {\r\n      const vv = window.visualViewport;\r\n      const height = vv?.height ?? window.innerHeight;\r\n      const keyboardOpen = height < window.innerHeight - 40;\r\n      if (keyboardOpen) {\r\n        setSuspendViewportAfterNext(false);\r\n        setSuspendViewportResize(true);\r\n      } else {\r\n        freezeViewportAfterNextUpdate();\r\n      }\r\n      pinSetup.setPinFocus(true);\r\n    }, [\r\n      freezeViewportAfterNextUpdate,\r\n      pinSetup,\r\n      setSuspendViewportAfterNext,\r\n      setSuspendViewportResize,\r\n    ]);\r\n\r\n    const handlePinBlur = useCallback(() => {\r\n      if (!showPinForm) {\r\n        setSuspendViewportResize(false);\r\n        setSuspendViewportAfterNext(false);\r\n      }\r\n      pinSetup.setPinFocus(false);\r\n    }, [\r\n      pinSetup,\r\n      setSuspendViewportAfterNext,\r\n      setSuspendViewportResize,\r\n      showPinForm,\r\n    ]);\r\n\r\n    const handleTogglePinForm = () => {\r\n      if (showPinForm) {\r\n        resetPinForm();\r\n        return;\r\n      }\r\n        requestLocalVerification({\r\n          onVerified: () => {\r\n            openPinForm();\r\n          },\r\n        onBlocked: triggerEmailWarning,\r\n        requireVerifiedEmail: true,\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    const handleAddFingerprint = () => {\r\n      requestLocalVerification({\r\n        onVerified: () => {\r\n          openModal(\"FingerprintPrompt\", {\r\n            onConfirm: async (credentialId) => {\r\n              const userId = accessUser?.id_auth ?? accessUser?.id ?? null;\r\n              if (!userId) return;\r\n              const existingSecret = await loadDeviceSecret(userId);\r\n              if (!existingSecret) {\r\n                const bytes = window.crypto.getRandomValues(new Uint8Array(32));\r\n                const token = btoa(String.fromCharCode(...bytes));\r\n                await saveDeviceSecret(userId, { token, createdAt: new Date().toISOString() });\r\n              }\r\n              if (!credentialId) return;\r\n              await saveBiometricToken(userId, {\r\n                credentialId,\r\n                createdAt: new Date().toISOString(),\r\n              });\r\n              await supabase\r\n                .from(\"usuarios\")\r\n                .update({ has_biometrics: true })\r\n                .eq(\"id_auth\", userId);\r\n              setFingerprintEnabled(true);\r\n              if (accessUser) {\r\n                setUser({ ...accessUser, has_biometrics: true });\r\n              }\r\n            },\r\n            userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n            email: accessUser?.email ?? null,\r\n            displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n          });\r\n        },\r\n        onBlocked: triggerEmailWarning,\r\n        requireVerifiedEmail: true,\r\n        userId: accessUser?.id_auth ?? accessUser?.id ?? null,\r\n        email: accessUser?.email ?? null,\r\n        displayName: accessUser?.nombre ?? accessUser?.alias ?? \"Usuario\",\r\n      });\r\n    };\r\n\r\n    return (\r\n      <Access\r\n        warningBlock={\r\n          showEmailWarning || showMethodsWarning ? (\r\n            <div className=\"space-y-2\">\r\n              {showEmailWarning ? (\r\n                <div\r\n                  className={`relative left-1/2 right-1/2 w-screen -mx-[50vw] ${emailWarningClass}`}\r\n                >\r\n                  <div className=\"flex items-center gap-3 border border-orange-200 bg-orange-50 px-4 py-2 text-xs text-orange-600\">\r\n                    <AlertTriangle size={14} className=\"shrink-0\" />\r\n                    <div className=\"flex-1 overflow-hidden text-ellipsis whitespace-nowrap\">\r\n                      Antes de realizar cambios sensibles,{\" \"}\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() =>\r\n                          openModal(\"EmailVerification\", {\r\n                            email: accessUser?.email ?? null,\r\n                          })\r\n                        }\r\n                        className=\"underline underline-offset-2\"\r\n                      >\r\n                        verifica tu correo\r\n                      </button>\r\n                    </div>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => {\r\n                        setEmailWarningOpen(false);\r\n                        setEmailWarningPulse(false);\r\n                      }}\r\n                      className=\"text-orange-400 hover:text-orange-500\"\r\n                      aria-label=\"Cerrar aviso\"\r\n                    >\r\n                      <X size={14} />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              ) : null}\r\n              {showMethodsWarning ? (\r\n                <div className=\"rounded-2xl border border-red-200 bg-red-50 p-4 flex items-center gap-3 text-xs text-red-500\">\r\n                  <TriangleAlert size={16} className=\"text-red-500\" />\r\n                  Es necesario al menos un metodo de verificacion.\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setDismissedMethodsWarning(true)}\r\n                    className=\"ml-auto text-red-400 hover:text-red-500\"\r\n                    aria-label=\"Cerrar aviso\"\r\n                  >\r\n                    <X size={14} />\r\n                  </button>\r\n                </div>\r\n              ) : null}\r\n            </div>\r\n          ) : null\r\n        }\r\n        blocks={[\r\n          <PasswordAccessCard\r\n            key=\"password\"\r\n            passwordActive={passwordActive}\r\n            showPasswordForm={showPasswordForm}\r\n            passwordMode={passwordMode}\r\n            currentPassword={currentPassword}\r\n            passwordValue={passwordValue}\r\n            passwordConfirm={passwordConfirm}\r\n            showPassword={showPassword}\r\n            showPasswordConfirm={showPasswordConfirm}\r\n            showCurrentPassword={showCurrentPassword}\r\n            hasMinLength={hasMinLength}\r\n            hasNumberAndSymbol={hasNumberAndSymbol}\r\n            passwordsMatch={passwordsMatch}\r\n            showPasswordRules={showPasswordRules}\r\n            showPasswordErrors={showPasswordErrors}\r\n            showConfirmErrors={showConfirmErrors}\r\n            showConfirmRule={showConfirmRule}\r\n            canSavePassword={canSavePassword}\r\n            showCurrentPasswordError={showCurrentPasswordError}\r\n            onPasswordCancel={handlePasswordCancel}\r\n            onPasswordSave={handlePasswordSave}\r\n            onOpenAdd={openAddPassword}\r\n            onOpenChange={openChangePassword}\r\n            onToggleShowPassword={() => setShowPassword((prev) => !prev)}\r\n            onToggleShowPasswordConfirm={() =>\r\n              setShowPasswordConfirm((prev) => !prev)\r\n            }\r\n            onToggleShowCurrentPassword={() =>\r\n              setShowCurrentPassword((prev) => !prev)\r\n            }\r\n            onChangeCurrentPassword={(event) =>\r\n              setCurrentPassword(event.target.value)\r\n            }\r\n            onChangePasswordValue={(event) =>\r\n              setPasswordValue(event.target.value)\r\n            }\r\n            onChangePasswordConfirm={(event) =>\r\n              setPasswordConfirm(event.target.value)\r\n            }\r\n            onFocusField={handlePasswordFocus}\r\n            onBlurField={handlePasswordBlur}\r\n            passwordFormRef={passwordFormRef}\r\n            currentPasswordRef={currentPasswordRef}\r\n            passwordInputRef={passwordInputRef}\r\n            confirmInputRef={confirmInputRef}\r\n          />,\r\n          <FingerprintAccessCard\r\n            key=\"fingerprint\"\r\n            enabled={fingerprintEnabled}\r\n            onAdd={handleAddFingerprint}\r\n            onRemove={handleRemoveFingerprint}\r\n          />,\r\n            <PinAccessCard\r\n              key=\"pin\"\r\n              showPinForm={showPinForm}\r\n              pinEnabled={pinEnabled}\r\n              pinStep={pinStep}\r\n              pinValue={pinValue}\r\n              pinSlots={pinSlots}\r\n              pinReveal={pinReveal}\r\n              pinComplete={pinComplete}\r\n              pinMatches={pinMatches}\r\n              pinFocused={pinFocused}\r\n              onRemovePin={handleRemovePin}\r\n              onTogglePinForm={handleTogglePinForm}\r\n              onPinPointerDown={handlePinPointerDown}\r\n              onPinValueChange={pinSetup.updatePinValueDirect}\r\n              onPinFocus={handlePinFocus}\r\n              onPinBlur={handlePinBlur}\r\n              registerHiddenRef={registerHiddenRef}\r\n              onResetPinForm={resetPinForm}\r\n              onPinNext={handlePinNext}\r\n              onPinConfirm={handlePinConfirm}\r\n            />,\r\n        ]}\r\n        infoBlock={\r\n          !dismissedInfo ? (\r\n            <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4 flex items-center gap-3 text-xs text-slate-500\">\r\n              <KeyRound size={16} className=\"text-[#5E30A5]\" />\r\n              Cambios sensibles requieren verificacion antes de guardarse.\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => {\r\n                  accessInfoDismissed = true;\r\n                  setDismissedInfo(true);\r\n                }}\r\n                className=\"ml-auto text-slate-400 hover:text-slate-500\"\r\n                aria-label=\"Cerrar aviso\"\r\n              >\r\n                <X size={14} />\r\n              </button>\r\n            </div>\r\n          ) : null\r\n        }\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const LinkedAccountsPanel = useCallback(function LinkedAccountsPanel({\r\n    usuario: linkedUser,\r\n  }) {\r\n    const [linked, setLinked] = useState({});\r\n    const [verified] = useState(false);\r\n    const [dismissedInfo, setDismissedInfo] = useState(false);\r\n\r\n    useEffect(() => {\r\n      const provider = (linkedUser?.provider || \"\").toLowerCase();\r\n      if (!provider) return;\r\n      const mapped =\r\n        provider === \"google\"\r\n          ? \"Google\"\r\n          : provider === \"facebook\"\r\n            ? \"Facebook\"\r\n            : provider === \"apple\"\r\n              ? \"Apple\"\r\n              : provider === \"instagram\"\r\n                ? \"Instagram\"\r\n                : provider === \"discord\"\r\n                  ? \"Discord\"\r\n                  : null;\r\n      if (!mapped) return;\r\n      setLinked((prev) => ({ ...prev, [mapped]: true }));\r\n    }, [linkedUser?.provider]);\r\n\r\n    const toggleProvider = useCallback((providerKey) => {\r\n      setLinked((prev) => ({ ...prev, [providerKey]: !prev[providerKey] }));\r\n    }, []);\r\n\r\n    return (\r\n      <LinkedAccounts\r\n        blocks={[\r\n          <LinkedAccountsCard\r\n            key=\"linked-accounts\"\r\n            linked={linked}\r\n            verified={verified}\r\n            onToggle={toggleProvider}\r\n          />,\r\n        ]}\r\n        infoBlock={\r\n          !dismissedInfo ? (\r\n            <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4 flex items-center gap-3 text-xs text-slate-500\">\r\n              <KeyRound size={16} className=\"text-[#5E30A5]\" />\r\n              Cambios sensibles requieren verificacion antes de guardarse.\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setDismissedInfo(true)}\r\n                className=\"ml-auto text-slate-400 hover:text-slate-500\"\r\n                aria-label=\"Cerrar aviso\"\r\n              >\r\n                <X size={14} />\r\n              </button>\r\n            </div>\r\n          ) : null\r\n        }\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const NotificationsPanel = useCallback(function NotificationsPanel() {\r\n    const { openModal } = useModal();\r\n    const [prefs, setPrefs] = useState(DEFAULT_NOTIFICATION_PREFS);\r\n    const [permission, setPermission] = useState(\"default\");\r\n    const [pushEnabled, setPushEnabled] = useState(false);\r\n    const [dismissedWarning, setDismissedWarning] = useState(false);\r\n\r\n    useEffect(() => {\r\n      if (typeof window === \"undefined\") return;\r\n      const nextPermission =\r\n        typeof Notification !== \"undefined\" ? Notification.permission : \"default\";\r\n      setPermission(nextPermission);\r\n\r\n      if (!(\"serviceWorker\" in navigator)) return;\r\n      navigator.serviceWorker.ready\r\n        .then((reg) => reg.pushManager?.getSubscription?.())\r\n        .then((sub) => {\r\n          setPushEnabled(Boolean(sub));\r\n        })\r\n        .catch(() => {\r\n          setPushEnabled(false);\r\n        });\r\n    }, []);\r\n\r\n    const toggle = useCallback(\r\n      (section) => {\r\n        setPrefs((prev) => ({\r\n          ...prev,\r\n          [section]: !prev[section],\r\n        }));\r\n        openModal(\"Notifications\");\r\n      },\r\n      [openModal]\r\n    );\r\n\r\n    const statusLabel =\r\n      permission === \"granted\"\r\n        ? \"Permitidas\"\r\n        : permission === \"denied\"\r\n          ? \"Bloqueadas\"\r\n          : \"No configuradas\";\r\n\r\n    const showChannels = permission === \"granted\";\r\n    const showWarning = !showChannels && !dismissedWarning;\r\n\r\n    return (\r\n      <Notifications\r\n        blocks={[\r\n          <NotificationsPreferencesCard\r\n            key=\"notifications\"\r\n            permission={permission}\r\n            statusLabel={statusLabel}\r\n            channels={NOTIFICATION_CHANNELS}\r\n            prefs={prefs}\r\n            onToggle={toggle}\r\n            showChannels={showChannels}\r\n            showWarning={showWarning}\r\n            onDismissWarning={() => setDismissedWarning(true)}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const AppAppearancePanel = useCallback(function AppAppearancePanel() {\r\n    const [theme, setTheme] = useState(\"claro\");\r\n    const [font, setFont] = useState(\"actual\");\r\n\r\n    return (\r\n      <AppAppearance\r\n        blocks={[\r\n          <ThemeSelector key=\"theme\" value={theme} onChange={setTheme} />,\r\n          <FontSelector key=\"font\" value={font} onChange={setFont} />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const LanguagePanel = useCallback(function LanguagePanel() {\r\n    const [language, setLanguage] = useState(\"es\");\r\n\r\n    return (\r\n      <Language\r\n        blocks={[\r\n          <LanguageSelector\r\n            key=\"language-selector\"\r\n            value={language}\r\n            onChange={setLanguage}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const handleHelpSelect = useCallback((option) => {\r\n    logCatalogBreadcrumb(\"support.help.select\", {\r\n      option: option || \"unknown\",\r\n      role: \"negocio\",\r\n    });\r\n    if (option === \"Preguntas frecuentes\") {\r\n      setHelpView(\"faq\");\r\n      return;\r\n    }\r\n    if (option === \"Chatear con un asesor\") {\r\n      setHelpView(\"support_chat\");\r\n      return;\r\n    }\r\n    if (option === \"Recibir soporte por correo\") {\r\n      setHelpView(\"support_email\");\r\n    }\r\n  }, []);\r\n\r\n  const HelpPanel = useCallback(\r\n    function HelpPanel() {\r\n      return (\r\n          <Help\r\n            blocks={[\r\n              helpView === \"faq\" ? (\r\n                <FaqContent\r\n                  key=\"faq\"\r\n                  audience=\"negocio\"\r\n                  onBack={() => setHelpView(\"menu\")}\r\n                />\r\n              ) : helpView === \"support_chat\" ? (\r\n                <SupportChat\r\n                  key=\"support-chat\"\r\n                  role=\"negocio\"\r\n                  onBack={() => setHelpView(\"menu\")}\r\n                />\r\n              ) : helpView === \"support_email\" ? (\r\n                <SupportEmail\r\n                  key=\"support-email\"\r\n                  onBack={() => setHelpView(\"menu\")}\r\n                />\r\n              ) : (\r\n                <SupportHelpOptions\r\n                  key=\"support-help\"\r\n                  options={[\r\n                    \"Preguntas frecuentes\",\r\n                    \"Recibir soporte por correo\",\r\n                    \"Chatear con un asesor\",\r\n                  ]}\r\n                  onSelect={handleHelpSelect}\r\n                />\r\n              ),\r\n            ]}\r\n          />\r\n        );\r\n      },\r\n    [handleHelpSelect, helpView]\r\n    );\r\n\r\n  const FeedbackPanel = useCallback(function FeedbackPanel() {\r\n    const [message, setMessage] = useState(\"\");\r\n    const [email, setEmail] = useState(\"\");\r\n\r\n    return (\r\n      <Feedback\r\n        blocks={[\r\n          <SupportFeedbackForm\r\n            key=\"support-feedback\"\r\n            message={message}\r\n            email={email}\r\n            onChangeMessage={setMessage}\r\n            onChangeEmail={setEmail}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }, []);\r\n\r\n  const BeneficiosPanel = useCallback(\r\n    ({ usuario: benefitsUser }) => {\r\n      const plan = getPlanFallback(benefitsUser?.role);\r\n      return (\r\n        <Beneficios\r\n          title=\"Tier (Liga)\"\r\n          subtitle=\"Revisa tu suscripcion actual.\"\r\n          blocks={[\r\n            <PlanBenefitsCard\r\n              key=\"plan-benefits\"\r\n              planLabel={plan?.plan}\r\n              perks={plan?.perks || []}\r\n              history={plan?.upgrades || []}\r\n            />,\r\n          ]}\r\n        />\r\n      );\r\n    },\r\n    []\r\n  );\r\n\r\n  const ManageAccountPanel = useCallback(\r\n    ({ usuario: manageUser, setUser: setManageUser, verification }) => {\r\n      const plan = getPlanFallback(manageUser?.role);\r\n      return (\r\n        <ManageAccount\r\n          blocks={[\r\n            !verification.accountVerified ? (\r\n              <AccountStatusCard\r\n                key=\"account-status\"\r\n                subtitle=\"Verifica la cuenta para que puedas empezar a publicar promociones.\"\r\n                benefitsTitle=\"Beneficios a los que puedes acceder:\"\r\n                benefits={plan?.perks || []}\r\n                footer={\r\n                  <p className=\"text-[11px] text-slate-400 text-center\">\r\n                    Estos beneficios aplican al plan GRATUITO. Para ver planes\r\n                    pagados y con mejores beneficios revisa los planes{\" \"}\r\n                    <button\r\n                      type=\"button\"\r\n                      className=\"inline p-0 font-semibold text-[#5E30A5] hover:underline\"\r\n                    >\r\n                      Ver Planes\r\n                    </button>\r\n                    .\r\n                  </p>\r\n                }\r\n              />\r\n            ) : null,\r\n            <DangerZone key=\"danger-zone\" usuario={manageUser} setUser={setManageUser} />,\r\n          ]}\r\n        />\r\n      );\r\n    },\r\n    []\r\n  );\r\n\r\n  const openVerificationMethods = useCallback(() => {\r\n    setProfileTab(\"security-access\");\r\n    setProfileView(\"panel\");\r\n  }, [setProfileTab, setProfileView]);\r\n  const openNegocioIdentity = useCallback(() => {\r\n    setProfileTab(\"manage\");\r\n    setProfileView(\"panel\");\r\n  }, [setProfileTab, setProfileView]);\r\n  const negocioItems = useMemo(() => {\r\n    const fromOnboarding = Array.isArray(onboarding?.negocios)\r\n      ? onboarding.negocios\r\n      : onboarding?.negocio\r\n      ? [onboarding.negocio]\r\n      : [];\r\n    const fromUser = Array.isArray(usuario?.negocios)\r\n      ? usuario.negocios\r\n      : usuario?.negocio\r\n      ? [usuario.negocio]\r\n      : [];\r\n    const base =\r\n      fromOnboarding.length > 0\r\n        ? fromOnboarding\r\n        : fromUser.length > 0\r\n        ? fromUser\r\n        : [\r\n            {\r\n              nombre: usuario?.negocioNombre || usuario?.negocio || \"\",\r\n              sector: usuario?.sector || \"\",\r\n              direccion: usuario?.direccion || usuario?.ubicacion || \"\",\r\n            },\r\n          ];\r\n    return base.map((item, index) => ({\r\n      id: item?.id || item?.negocioId || `negocio-${index}`,\r\n      nombre:\r\n        item?.nombre || item?.negocioNombre || item?.nombre_negocio || \"\",\r\n      sector: item?.sector || \"\",\r\n      direccion: item?.direccion || item?.ubicacion || \"\",\r\n    }));\r\n  }, [onboarding, usuario]);\r\n\r\n  const negocioDisplayItems = useMemo(() => {\r\n    const items = negocioItems.length\r\n      ? negocioItems\r\n      : [\r\n          {\r\n            id: \"negocio-principal\",\r\n            nombre: \"\",\r\n            sector: \"\",\r\n            direccion: \"\",\r\n          },\r\n        ];\r\n    return items.map((item, index) => {\r\n      const nombre = (item?.nombre || \"\").trim();\r\n      const sector = (item?.sector || \"\").trim();\r\n      const direccion = (item?.direccion || \"\").trim();\r\n      const missing = !(nombre && sector && direccion);\r\n      return {\r\n        id: item?.id || `negocio-${index}`,\r\n        label: index === 0 ? \"Principal\" : `Sucursal ${index}`,\r\n        value: nombre || \"No haz ingresado el nombre de tu negocio aun.\",\r\n        missing,\r\n        raw: item,\r\n        index,\r\n      };\r\n    });\r\n  }, [negocioItems]);\r\n\r\n  const negocioMissing = useMemo(\r\n    () => negocioDisplayItems.some((item) => item.missing),\r\n    [negocioDisplayItems]\r\n  );\r\n\r\n  const OverviewPanel = useCallback(\r\n    ({ usuario: overviewUser, verification }) => {\r\n      const createdAtRaw = overviewUser?.fechacreacion;\r\n      const createdAtValue =\r\n        typeof createdAtRaw === \"string\" &&\r\n        createdAtRaw.includes(\" \") &&\r\n        !createdAtRaw.includes(\"T\")\r\n          ? createdAtRaw.replace(\" \", \"T\")\r\n          : createdAtRaw;\r\n      const createdAtLabel = formatReadableDate(createdAtValue);\r\n      const showRole = overviewUser?.role && overviewUser.role !== \"cliente\";\r\n      const metaLine = `${\r\n        showRole ? `${getRoleLabel(overviewUser)} - ` : \"\"\r\n      }Miembro desde ${createdAtLabel}`;\r\n      const plan = getPlanFallback(overviewUser?.role);\r\n\r\n      return (\r\n        <ProfileOverview\r\n          headerBadge=\"Cuenta de Negocio\"\r\n          verificationBlock={\r\n            !verification.accountVerified ? (\r\n              <VerificationCard />\r\n            ) : null\r\n          }\r\n          identityBlock={\r\n            <IdentityCard\r\n              title=\"Identidad del propietario\"\r\n              name={overviewUser?.nombre || \"Usuario\"}\r\n              meta={metaLine}\r\n              avatarSrc={getAvatarSrc(overviewUser)}\r\n              showVerified={verification.accountVerified}\r\n            />\r\n          }\r\n          primaryBlock={\r\n            <BenefitsCard\r\n              key=\"overview-benefits\"\r\n              title=\"Plan\"\r\n              badgeLabel={plan?.plan || \"FREE\"}\r\n              BadgeIcon={Sparkles}\r\n              perks={plan?.perks || []}\r\n            />\r\n          }\r\n          secondaryBlock={\r\n            <NegocioIdentityCard\r\n              key=\"overview-negocio\"\r\n              title=\"Identidad del Negocio\"\r\n              subtitle=\"Define como te ven tus clientes y manten tu info actualizada\"\r\n              warningText=\"Completa la informacion de tu negocio, para una mejor experiencia.\"\r\n              showWarning={negocioMissing}\r\n              items={negocioDisplayItems}\r\n              onEdit={openNegocioIdentity}\r\n            />\r\n          }\r\n        />\r\n      );\r\n    },\r\n    [negocioDisplayItems, negocioMissing, openNegocioIdentity]\r\n  );\r\n\r\n  function PersonalDataPanel({ usuario: personalUser, setUser: setPersonalUser, verification }) {\r\n    const initial = useMemo(() => {\r\n      const nombre = personalUser?.nombre || \"\";\r\n      const parts = nombre.split(\" \").filter(Boolean);\r\n      return {\r\n        nombres: personalUser?.nombres || parts.slice(0, 1).join(\" \") || nombre,\r\n        apellidos: personalUser?.apellidos || parts.slice(1).join(\" \"),\r\n        direccion:\r\n          personalUser?.direccion ||\r\n          personalUser?.ubicacion ||\r\n          personalUser?.ciudad ||\r\n          \"\",\r\n        email: personalUser?.email || \"\",\r\n        telefono: personalUser?.telefono || personalUser?.phone || \"\",\r\n      };\r\n    }, [personalUser]);\r\n\r\n    const [form, setForm] = useState(initial);\r\n    const [confirmedSensitive, setConfirmedSensitive] = useState(false);\r\n    const [editing, setEditing] = useState({\r\n      names: false,\r\n      contact: false,\r\n    });\r\n    const [expandedEmail, setExpandedEmail] = useState(false);\r\n\r\n    useEffect(() => {\r\n      setForm(initial);\r\n    }, [\r\n      initial.nombres,\r\n      initial.apellidos,\r\n      initial.direccion,\r\n      initial.email,\r\n      initial.telefono,\r\n    ]);\r\n\r\n    useEffect(() => {\r\n      if (editing.contact) {\r\n        setExpandedEmail(false);\r\n      }\r\n    }, [editing.contact]);\r\n\r\n    const emailChanged = form.email !== initial.email;\r\n    const phoneChanged = form.telefono !== initial.telefono;\r\n    const needsSensitiveVerification = emailChanged || phoneChanged;\r\n    const baseVerified =\r\n      (!emailChanged || verification.emailVerified) &&\r\n      (!phoneChanged || verification.phoneVerified);\r\n    const provider = (personalUser?.provider || \"\").toLowerCase();\r\n    const hasPasswordFallback = provider === \"email\" || provider === \"password\";\r\n\r\n    const handleChange = (field) => (event) => {\r\n      setForm((prev) => ({ ...prev, [field]: event.target.value }));\r\n    };\r\n\r\n    const handleSaveNames = () => {\r\n      if (!personalUser) return;\r\n      const nombreCompleto = [form.nombres, form.apellidos]\r\n        .filter(Boolean)\r\n        .join(\" \");\r\n      setPersonalUser({\r\n        ...personalUser,\r\n        nombres: form.nombres,\r\n        apellidos: form.apellidos,\r\n        nombre: nombreCompleto || personalUser?.nombre,\r\n      });\r\n      if (form.nombres?.trim() && form.apellidos?.trim()) {\r\n        setEditing((prev) => ({ ...prev, names: false }));\r\n      }\r\n    };\r\n\r\n    const persistContact = (overrideSensitive = false) => {\r\n      if (!personalUser) return;\r\n      if (!baseVerified) return;\r\n      if (!overrideSensitive && needsSensitiveVerification && !confirmedSensitive) {\r\n        return;\r\n      }\r\n      setPersonalUser({ ...personalUser, email: form.email, telefono: form.telefono });\r\n      if (form.email?.trim() && form.telefono?.trim()) {\r\n        setEditing((prev) => ({ ...prev, contact: false }));\r\n      }\r\n    };\r\n\r\n    const handleSaveContact = () => {\r\n      if (needsSensitiveVerification && !confirmedSensitive) {\r\n        openModal(\"ConfirmarCambios\", {\r\n          hasFingerprint: accessMethods?.fingerprint,\r\n          hasPin: accessMethods?.pin,\r\n          hasPassword: accessMethods?.password || hasPasswordFallback,\r\n          userId: personalUser?.id_auth ?? personalUser?.id ?? null,\r\n          email: personalUser?.email ?? null,\r\n          displayName: personalUser?.nombre ?? personalUser?.alias ?? \"Usuario\",\r\n          onConfirm: () => {\r\n            setConfirmedSensitive(true);\r\n            requestAnimationFrame(() => {\r\n              persistContact(true);\r\n            });\r\n          },\r\n          onOpenMethods: openVerificationMethods,\r\n        });\r\n        return;\r\n      }\r\n      persistContact(false);\r\n    };\r\n\r\n    const handleCancelNames = () => {\r\n      setForm((prev) => ({\r\n        ...prev,\r\n        nombres: initial.nombres || \"\",\r\n        apellidos: initial.apellidos || \"\",\r\n      }));\r\n      setEditing((prev) => ({\r\n        ...prev,\r\n        names: false,\r\n      }));\r\n      document.activeElement?.blur();\r\n    };\r\n\r\n    const handleCancelContact = () => {\r\n      setForm((prev) => ({\r\n        ...prev,\r\n        email: initial.email || \"\",\r\n        telefono: initial.telefono || \"\",\r\n      }));\r\n      setConfirmedSensitive(false);\r\n      setEditing((prev) => ({\r\n        ...prev,\r\n        contact: false,\r\n      }));\r\n      document.activeElement?.blur();\r\n    };\r\n\r\n    const fullName = [form.nombres, form.apellidos].filter(Boolean).join(\" \");\r\n    const addressItems = form.direccion?.trim()\r\n      ? [{ label: \"Casa\", value: form.direccion || \"Sin direccion\" }]\r\n      : [];\r\n    const showSaveNames = Boolean(form.nombres?.trim() || form.apellidos?.trim());\r\n    const showSaveContact = Boolean(form.email?.trim() || form.telefono?.trim());\r\n    const saveContactDisabled = !baseVerified;\r\n\r\n    return (\r\n      <PersonalData\r\n        blocks={[\r\n          <PersonalDataBlock\r\n            key=\"personal-data\"\r\n            editingNames={editing.names}\r\n            editingContact={editing.contact}\r\n            fullName={fullName}\r\n            nombres={form.nombres}\r\n            apellidos={form.apellidos}\r\n            addressItems={addressItems}\r\n            email={form.email}\r\n            telefono={form.telefono}\r\n            expandedEmail={expandedEmail}\r\n            emailVerified={verification.emailVerified}\r\n            onEditNames={() => setEditing((prev) => ({ ...prev, names: true }))}\r\n            onEditAddress={() => {}}\r\n            onEditContact={() => setEditing((prev) => ({ ...prev, contact: true }))}\r\n            onChangeNombres={handleChange(\"nombres\")}\r\n            onChangeApellidos={handleChange(\"apellidos\")}\r\n            onChangeEmail={handleChange(\"email\")}\r\n            onChangeTelefono={handleChange(\"telefono\")}\r\n            onCancelNames={handleCancelNames}\r\n            onCancelContact={handleCancelContact}\r\n            onSaveNames={handleSaveNames}\r\n            onSaveContact={handleSaveContact}\r\n            showSaveNames={showSaveNames}\r\n            showSaveContact={showSaveContact}\r\n            saveContactDisabled={saveContactDisabled}\r\n            onToggleExpandedEmail={() => setExpandedEmail((prev) => !prev)}\r\n          />,\r\n        ]}\r\n      />\r\n    );\r\n  }\r\n\r\n  const tabGroups = useMemo(\r\n    () => [\r\n      {\r\n        title: \"Cuenta\",\r\n        items: [\r\n          { key: \"overview\", label: \"Perfil\", icon: UserCircle },\r\n          { key: \"personal\", label: \"Datos personales\", icon: IdCard },\r\n          { key: \"manage\", label: \"Gestionar cuenta\", icon: AlertTriangle },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Seguridad\",\r\n        items: [\r\n          { key: \"security-access\", label: \"Acceso\", icon: KeyRound },\r\n          { key: \"security-links\", label: \"Cuentas vinculadas\", icon: Link2 },\r\n          { key: \"twofa\", label: \"2FA\", icon: Fingerprint },\r\n          { key: \"sessions\", label: \"Sesiones\", icon: Monitor },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Plan/Tier\",\r\n        items: [\r\n          { key: \"plan\", label: \"Beneficios\", icon: Crown },\r\n          { key: \"payments\", label: \"Pagos\", icon: CreditCard, disabled: true },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Preferencias\",\r\n        items: [\r\n          { key: \"notifications\", label: \"Notificaciones\", icon: Bell },\r\n          { key: \"appearance\", label: \"Apariencia\", icon: Palette },\r\n          { key: \"language\", label: \"Idioma\", icon: Globe },\r\n        ],\r\n      },\r\n      {\r\n        title: \"Soporte\",\r\n        items: [\r\n          { key: \"help\", label: \"Ayuda\", icon: HelpCircle },\r\n          { key: \"feedback\", label: \"Dejar un comentario\", icon: MessageSquare },\r\n        ],\r\n      },\r\n      {\r\n        items: [\r\n          { key: \"signout\", label: \"Cerrar sesion\", icon: LogOut, tone: \"danger\" },\r\n        ],\r\n      },\r\n    ],\r\n    []\r\n  );\r\n\r\n  const tabLabelMap = useMemo(() => {\r\n    const map = {};\r\n    tabGroups.forEach((group) => {\r\n      group.items?.forEach((item) => {\r\n        map[item.key] = item.label;\r\n      });\r\n    });\r\n    return map;\r\n  }, [tabGroups]);\r\n\r\n  const sections = useMemo(\r\n    () => ({\r\n      overview: OverviewPanel,\r\n      personal: PersonalDataPanel,\r\n      \"security-access\": AccessPanel,\r\n      \"security-links\": LinkedAccountsPanel,\r\n      twofa: TwoFAPanel,\r\n      sessions: SessionsPanel,\r\n      notifications: NotificationsPanel,\r\n      plan: BeneficiosPanel,\r\n      appearance: AppAppearancePanel,\r\n      language: LanguagePanel,\r\n      help: HelpPanel,\r\n      feedback: FeedbackPanel,\r\n      manage: ManageAccountPanel,\r\n    }),\r\n    [\r\n      AccessPanel,\r\n      BeneficiosPanel,\r\n      LinkedAccountsPanel,\r\n      NotificationsPanel,\r\n      AppAppearancePanel,\r\n      LanguagePanel,\r\n      HelpPanel,\r\n      FeedbackPanel,\r\n      ManageAccountPanel,\r\n      OverviewPanel,\r\n      PersonalDataPanel,\r\n      SessionsPanel,\r\n      TwoFAPanel,\r\n    ]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (deepLinkAppliedRef.current) return;\r\n    const params = new URLSearchParams(location.search);\r\n    const targetTab = params.get(\"tab\");\r\n    if (!targetTab || !sections[targetTab]) return;\r\n    deepLinkAppliedRef.current = true;\r\n    setProfileTab(targetTab);\r\n    setProfileView(\"panel\");\r\n  }, [location.search, sections, setProfileTab]);\r\n\r\n  const handleTabChange = useCallback(\r\n    (nextTab) => {\r\n      if (nextTab === \"signout\") {\r\n        if (tabTransitionRef.current) {\r\n          clearTimeout(tabTransitionRef.current);\r\n        }\r\n        setTabsActiveKey(\"signout\");\r\n        tabTransitionRef.current = setTimeout(() => {\r\n          setTabsActiveKey(null);\r\n          logout();\r\n        }, 140);\r\n        return;\r\n      }\r\n      if (tabTransitionRef.current) {\r\n        clearTimeout(tabTransitionRef.current);\r\n      }\r\n      setTabsActiveKey(nextTab);\r\n      setProfileTab(nextTab);\r\n      tabTransitionRef.current = setTimeout(() => {\r\n        setProfileView(\"panel\");\r\n      }, 140);\r\n    },\r\n    [setProfileTab]\r\n  );\r\n\r\n  const handleBack = useCallback(() => {\r\n    setProfileView(\"tabs\");\r\n    setTabsActiveKey(null);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (!isActive) {\r\n      setHeaderOptions({\r\n        mode: \"default\",\r\n        onSearchBack: null,\r\n        headerVisible: true,\r\n        profileDockOpen: true,\r\n        profileTitle: \"Configuracion\",\r\n      });\r\n      return undefined;\r\n    }\r\n    const headerTitle =\r\n      profileView === \"panel\"\r\n        ? tabLabelMap[profileTab] || \"Configuracion\"\r\n        : \"Configuracion\";\r\n    setHeaderOptions({\r\n      mode: \"profile\",\r\n      onSearchBack: profileView === \"panel\" ? handleBack : null,\r\n      headerVisible: true,\r\n      profileDockOpen: dockOpenForHeader,\r\n      profileTitle: headerTitle,\r\n    });\r\n    return () => {\r\n      setHeaderOptions({\r\n        mode: \"default\",\r\n        onSearchBack: null,\r\n        headerVisible: true,\r\n        profileDockOpen: true,\r\n        profileTitle: \"Configuracion\",\r\n      });\r\n    };\r\n  }, [\r\n    dockOpenForHeader,\r\n    handleBack,\r\n    isActive,\r\n    profileTab,\r\n    profileView,\r\n    setHeaderOptions,\r\n    tabLabelMap,\r\n  ]);\r\n\r\n  useEffect(() => {\r\n    const prev = prevShowSearchDockRef.current;\r\n    prevShowSearchDockRef.current = showSearchDock;\r\n\r\n    if (!showSearchDock) {\r\n      setDockOpenForHeader(false);\r\n      return undefined;\r\n    }\r\n\r\n    if (!prev && showSearchDock) {\r\n      const timer = setTimeout(() => {\r\n        setDockOpenForHeader(true);\r\n      }, 125);\r\n      return () => clearTimeout(timer);\r\n    }\r\n\r\n    setDockOpenForHeader(true);\r\n    return undefined;\r\n  }, [showSearchDock]);\r\n\r\n\r\n  useEffect(() => {\r\n    if (!isActive) {\r\n      setDockTarget(null);\r\n      setDockOpenForHeader(false);\r\n      return;\r\n    }\r\n    setDockTarget(document.getElementById(\"negocio-header-search-dock\"));\r\n  }, [isActive]);\r\n\r\n  useEffect(() => {\r\n    if (profileView !== \"tabs\") {\r\n      setTabsActiveKey(null);\r\n    }\r\n  }, [profileView]);\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (tabTransitionRef.current) {\r\n        clearTimeout(tabTransitionRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"flex h-full flex-col bg-white\">\r\n      {isActive && dockTarget\r\n        ? createPortal(\r\n            <HeaderPanelContainer\r\n              open\r\n              panelClassName=\"hero-search-dock profile-search-dock\"\r\n              panelProps={{\r\n                \"aria-hidden\": !showSearchDock,\r\n                style: { pointerEvents: showSearchDock ? \"auto\" : \"none\" },\r\n              }}\r\n            >\r\n              <div className=\"profile-search-clip\">\r\n                <motion.div\r\n                  className=\"profile-search-panel\"\r\n                  initial={false}\r\n                  animate={{\r\n                    y: showSearchDock ? \"0%\" : \"-100%\",\r\n                  }}\r\n                  transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n                >\r\n                  <SearchbarPanel\r\n                    value={searchValue}\r\n                    onChange={setSearchValue}\r\n                  />\r\n                </motion.div>\r\n              </div>\r\n            </HeaderPanelContainer>,\r\n            dockTarget\r\n          )\r\n        : null}\r\n      <div className=\"relative flex-1 overflow-y-auto bg-white\">\r\n        <AnimatePresence mode=\"wait\">\r\n          {profileView === \"tabs\" ? (\r\n            <motion.div\r\n              key=\"profile-tabs-screen\"\r\n              initial={{ x: 40, opacity: 0 }}\r\n              animate={{ x: 0, opacity: 1 }}\r\n              exit={{ x: -40, opacity: 0 }}\r\n              transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n              className=\"w-full\"\r\n            >\r\n              <div className=\"w-full flex flex-col items-center gap-4 pt-16 pb-6\">\r\n                <div className=\"w-[98%] max-w-md bg-white\">\r\n                  <ProfileTabs\r\n                    groups={tabGroups}\r\n                    active={tabsActiveKey}\r\n                    onChange={handleTabChange}\r\n                  />\r\n                </div>\r\n              </div>\r\n            </motion.div>\r\n          ) : (\r\n            <motion.div\r\n              key=\"profile-panel\"\r\n              initial={{ x: 40, opacity: 0 }}\r\n              animate={{ x: 0, opacity: 1 }}\r\n              exit={{ x: -40, opacity: 0 }}\r\n              transition={{ duration: 0.25, ease: \"easeOut\" }}\r\n              className=\"w-full flex flex-col items-center gap-4 pt-16 pb-6\"\r\n            >\r\n              <div className=\"w-[90%] max-w-md\">\r\n                <ProfilePanel\r\n                  activeTab={profileTab}\r\n                  sections={sections}\r\n                  usuario={usuario}\r\n                  setUser={setUser}\r\n                />\r\n              </div>\r\n            </motion.div>\r\n          )}\r\n        </AnimatePresence>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\ProfilePanel.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\ProfileTabs.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\AccountStatusCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\AliasCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\BenefitsCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\DangerZone.jsx","messages":[{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":44,"column":17,"nodeType":"BlockStatement","messageId":"unexpected","endLine":44,"endColumn":19,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[1382,1382],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]},{"ruleId":"no-empty","severity":2,"message":"Empty block statement.","line":50,"column":17,"nodeType":"BlockStatement","messageId":"unexpected","endLine":50,"endColumn":19,"suggestions":[{"messageId":"suggestComment","data":{"type":"block"},"fix":{"range":[1575,1575],"text":" /* empty */ "},"desc":"Add comment inside empty block statement."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { AlertTriangle, LogOut, Power, Trash2 } from \"lucide-react\";\r\nimport { useModal } from \"../../../modals/useModal\";\r\nimport { deleteUserAccount } from \"../../../services/authService\";\r\nimport { useAppStore } from \"../../../store/appStore\";\r\nimport { supabase } from \"../../../lib/supabaseClient\";\r\n\r\nexport default function DangerZone({ usuario, setUser }) {\r\n  const navigate = useNavigate();\r\n  const { openModal, closeModal } = useModal();\r\n  const logout = useAppStore((s) => s.logout);\r\n  const [deleting, setDeleting] = useState(false);\r\n  const [deleteError, setDeleteError] = useState(\"\");\r\n\r\n  const confirmDelete = () => {\r\n    setDeleteError(\"\");\r\n\r\n    if (!usuario?.id_auth) {\r\n      setDeleteError(\"No se pudo identificar la cuenta.\");\r\n      return;\r\n    }\r\n\r\n    openModal(\"EliminarCuenta\", {\r\n      deleting,\r\n      onConfirm: async () => {\r\n        if (deleting) return;\r\n\r\n        setDeleting(true);\r\n        const res = await deleteUserAccount(usuario.id_auth);\r\n        setDeleting(false);\r\n\r\n        closeModal();\r\n\r\n        if (!res.ok) {\r\n          setDeleteError(res.error || \"No se pudo eliminar la cuenta\");\r\n          return;\r\n        }\r\n\r\n        setUser(null);\r\n\r\n        try {\r\n          localStorage.removeItem(\"referidos_app_user\");\r\n        } catch {}\r\n\r\n        try {\r\n          const sbKey = supabase.auth.storageKey;\r\n          localStorage.removeItem(sbKey);\r\n          localStorage.removeItem(`${sbKey}-code-verifier`);\r\n        } catch {}\r\n\r\n        window.location.replace(\"/\");\r\n      },\r\n      onCancel: () => {\r\n        setDeleting(false);\r\n      },\r\n    });\r\n  };\r\n\r\n  return (\r\n    <section className=\"relative rounded-[28px] border border-red-200 bg-red-50 px-4 pb-5 pt-5\">\r\n      <div className=\"flex items-center gap-2\">\r\n        <span className=\"inline-flex items-center gap-2 rounded-full bg-red-50 px-3 py-1.5 text-[12px] uppercase tracking-[0.2em] text-red-600\">\r\n          <AlertTriangle size={16} />\r\n          Zona peligrosa\r\n        </span>\r\n      </div>\r\n\r\n      <div className=\"mt-4 space-y-4\">\r\n        <div className=\"rounded-2xl border border-red-200 bg-white p-4 flex items-center justify-between\">\r\n        <div>\r\n          <p className=\"text-xs font-semibold text-black/70\">Cerrar sesion</p>\r\n          <p className=\"text-[11px] text-black/50\">\r\n            Finaliza la sesion actual en este dispositivo.\r\n          </p>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          onClick={logout}\r\n          className=\"inline-flex items-center gap-2 rounded-2xl border border-red-200 bg-red-50 px-3 py-2 text-xs font-semibold text-red-600\"\r\n        >\r\n          <LogOut size={14} />\r\n          Salir\r\n        </button>\r\n        </div>\r\n\r\n        <div className=\"rounded-2xl border border-red-200 bg-white p-4 flex items-center justify-between\">\r\n        <div>\r\n          <p className=\"text-xs font-semibold text-black/70\">Desactivar cuenta</p>\r\n          <p className=\"text-[11px] text-black/50\">\r\n            Oculta temporalmente tu perfil. Puedes reactivarlo luego.\r\n          </p>\r\n        </div>\r\n        <button\r\n          type=\"button\"\r\n          className=\"inline-flex items-center gap-2 rounded-2xl border border-red-200 bg-white px-3 py-2 text-xs font-semibold text-red-500\"\r\n        >\r\n          <Power size={14} />\r\n          Desactivar\r\n        </button>\r\n        </div>\r\n\r\n        <div className=\"rounded-2xl border border-red-300 bg-white p-4 flex flex-col gap-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <p className=\"text-xs font-semibold text-black/70\">Eliminar cuenta</p>\r\n            <p className=\"text-[11px] text-black/50\">\r\n              Esta accion es irreversible. Se borraran tus datos.\r\n            </p>\r\n          </div>\r\n          <button\r\n            type=\"button\"\r\n            onClick={confirmDelete}\r\n            className=\"inline-flex items-center gap-2 rounded-2xl bg-red-600 px-3 py-2 text-xs font-semibold text-white\"\r\n          >\r\n            <Trash2 size={14} />\r\n            Eliminar\r\n          </button>\r\n        </div>\r\n        {deleteError && (\r\n          <div className=\"text-[11px] text-red-600\">{deleteError}</div>\r\n        )}\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => navigate(\"/cliente/inicio\")}\r\n          className=\"text-[11px] text-black/50 underline text-left\"\r\n        >\r\n          Volver al inicio\r\n        </button>\r\n        </div>\r\n      </div>\r\n    </section>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\ExploreTiersCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\FaqContent.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\FingerprintAccessCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\FontSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\IdentityCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\LanguageSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\LinkedAccountsCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\NegocioIdentityCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\NotificationsPreferencesCard.jsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":18,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":18,"endColumn":40},{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":24,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":24,"endColumn":35}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport { Bell, X } from \"lucide-react\";\r\n\r\nconst Toggle = ({ active, onChange }) => (\r\n  <button\r\n    type=\"button\"\r\n    onClick={onChange}\r\n    className={`w-12 h-7 rounded-full border transition flex items-center ${\r\n      active\r\n        ? \"bg-[#5E30A5] border-[#5E30A5] justify-end\"\r\n        : \"bg-slate-200 border-slate-300 justify-start\"\r\n    }`}\r\n  >\r\n    <span className=\"h-5 w-5 rounded-full bg-white shadow-sm mx-1\" />\r\n  </button>\r\n);\r\n\r\nexport const DEFAULT_NOTIFICATION_PREFS = {\r\n  promos: true,\r\n  novedades: true,\r\n  seguridad: true,\r\n};\r\n\r\nexport const NOTIFICATION_CHANNELS = [\r\n  { key: \"promos\", label: \"Notificaciones de Promos\" },\r\n  { key: \"novedades\", label: \"Novedades\" },\r\n  { key: \"seguridad\", label: \"Seguridad\" },\r\n];\r\n\r\nexport default function NotificationsPreferencesCard({\r\n  permission = \"default\",\r\n  statusLabel,\r\n  channels = NOTIFICATION_CHANNELS,\r\n  prefs = DEFAULT_NOTIFICATION_PREFS,\r\n  showChannels = true,\r\n  showWarning = false,\r\n  onToggle,\r\n  onDismissWarning,\r\n}) {\r\n  const label =\r\n    statusLabel ||\r\n    (permission === \"granted\"\r\n      ? \"Permitidas\"\r\n      : permission === \"denied\"\r\n        ? \"Bloqueadas\"\r\n        : \"No configuradas\");\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex items-stretch justify-between overflow-hidden rounded-2xl border border-[#E9E2F7] bg-white\">\r\n        <span className=\"px-4 py-3 text-xs font-semibold text-[#2F1A55]\">\r\n          Estado de notificaciones\r\n        </span>\r\n        <span\r\n          className={`flex items-center px-4 py-3 text-[11px] font-semibold ${\r\n            permission === \"granted\"\r\n              ? \"bg-emerald-50 text-emerald-600\"\r\n              : permission === \"denied\"\r\n                ? \"bg-amber-100 text-amber-700\"\r\n                : \"bg-slate-100 text-slate-500\"\r\n          }`}\r\n        >\r\n          {label}\r\n        </span>\r\n      </div>\r\n\r\n      {showChannels ? (\r\n        <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4 space-y-3\">\r\n          {channels.map((item) => (\r\n            <div key={item.key} className=\"flex items-center justify-between\">\r\n              <span className=\"inline-flex items-center gap-2 text-xs font-semibold text-[#2F1A55]\">\r\n                <Bell size={14} className=\"text-[#5E30A5]\" />\r\n                {item.label}\r\n              </span>\r\n              <Toggle\r\n                active={Boolean(prefs[item.key])}\r\n                onChange={() => onToggle?.(item.key)}\r\n              />\r\n            </div>\r\n          ))}\r\n        </div>\r\n      ) : showWarning ? (\r\n        <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] p-4 text-xs text-slate-500 flex items-center gap-3\">\r\n          <Bell size={16} className=\"text-[#5E30A5]\" />\r\n          <span className=\"flex-1\">\r\n            Es necesario activar notificaciones en las configuraciones del dispositivo para recibirlas.\r\n          </span>\r\n          <button\r\n            type=\"button\"\r\n            onClick={onDismissWarning}\r\n            className=\"text-slate-400 hover:text-slate-500\"\r\n            aria-label=\"Cerrar aviso\"\r\n          >\r\n            <X size={14} />\r\n          </button>\r\n        </div>\r\n      ) : null}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\PasswordAccessCard.jsx","messages":[{"ruleId":"no-constant-condition","severity":2,"message":"Unexpected constant condition.","line":111,"column":12,"nodeType":"Literal","messageId":"unexpected","endLine":111,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport {\r\n  Asterisk,\r\n  Check,\r\n  Eye,\r\n  EyeOff,\r\n  Pencil,\r\n  Plus,\r\n  X,\r\n} from \"lucide-react\";\r\n\r\nexport default function PasswordAccessCard({\r\n  passwordActive,\r\n  showPasswordForm,\r\n  passwordMode,\r\n  currentPassword,\r\n  passwordValue,\r\n  passwordConfirm,\r\n  showPassword,\r\n  showPasswordConfirm,\r\n  showCurrentPassword,\r\n  hasMinLength,\r\n  hasNumberAndSymbol,\r\n  passwordsMatch,\r\n  showPasswordRules,\r\n  showPasswordErrors,\r\n  showConfirmErrors,\r\n  showConfirmRule,\r\n  canSavePassword,\r\n  showCurrentPasswordError,\r\n  onPasswordCancel,\r\n  onPasswordSave,\r\n  onOpenAdd,\r\n  onOpenChange,\r\n  onToggleShowPassword,\r\n  onToggleShowPasswordConfirm,\r\n  onToggleShowCurrentPassword,\r\n  onChangeCurrentPassword,\r\n  onChangePasswordValue,\r\n  onChangePasswordConfirm,\r\n  onFocusField,\r\n  onBlurField,\r\n  passwordFormRef,\r\n  currentPasswordRef,\r\n  passwordInputRef,\r\n  confirmInputRef,\r\n  hideClose = false,\r\n  hideCancel = false,\r\n}) {\r\n  return (\r\n    <div className=\"rounded-2xl border border-[#E9E2F7] bg-white p-4\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-2 -ml-0.5\">\r\n          <span className=\"flex items-center text-[#5E30A5]\">\r\n            <Asterisk size={10} />\r\n            <span className=\"-ml-1\">\r\n              <Asterisk size={10} />\r\n            </span>\r\n            <span className=\"-ml-1\">\r\n              <Asterisk size={10} />\r\n            </span>\r\n          </span>\r\n          <span className=\"text-xs font-semibold text-[#2F1A55] -ml-1\">\r\n            {showPasswordForm\r\n              ? passwordMode === \"change\"\r\n                ? \"Cambiar contraseña\"\r\n                : \"Añadir una contraseña\"\r\n              : \"Contraseña\"}\r\n          </span>\r\n          {passwordActive ? (\r\n            <span className=\"inline-flex items-center justify-center rounded-full bg-emerald-50 p-1 text-emerald-600\">\r\n              <Check size={12} />\r\n            </span>\r\n          ) : null}\r\n        </div>\r\n        {showPasswordForm ? (\r\n          hideClose ? null : (\r\n            <button\r\n              type=\"button\"\r\n              onClick={onPasswordCancel}\r\n              className=\"h-8 w-8 rounded-full border border-slate-900 bg-white text-slate-900 flex items-center justify-center\"\r\n              aria-label=\"Cerrar contraseña\"\r\n            >\r\n              <X size={14} />\r\n            </button>\r\n          )\r\n        ) : passwordActive ? (\r\n          <div className=\"flex items-center gap-2\">\r\n            <button\r\n              type=\"button\"\r\n              className=\"h-8 w-8 rounded-full border border-slate-400 bg-white text-slate-700 flex items-center justify-center\"\r\n              aria-label=\"Editar contraseña\"\r\n              onClick={onOpenChange}\r\n            >\r\n              <Pencil size={14} />\r\n            </button>\r\n          </div>\r\n        ) : (\r\n          <button\r\n            type=\"button\"\r\n            onClick={onOpenAdd}\r\n            className=\"h-8 w-8 rounded-full border border-emerald-300 text-emerald-500 flex items-center justify-center\"\r\n            aria-label=\"Agregar contraseña\"\r\n          >\r\n            <Plus size={14} />\r\n          </button>\r\n        )}\r\n      </div>\r\n      {showPasswordForm ? (\r\n        <div className=\"mt-6 space-y-7\" ref={passwordFormRef}>\r\n          {false ? (\r\n                <div className=\"space-y-2 mb-8\">\r\n              <div className=\"relative rounded-xl border border-[#E9E2F7] bg-white px-3 py-2\">\r\n                <span className=\"absolute -top-3 left-3 bg-white px-2 text-[13px] text-slate-500\">\r\n                  Contraseña anterior\r\n                </span>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <input\r\n                    ref={currentPasswordRef}\r\n                    type={showCurrentPassword ? \"text\" : \"password\"}\r\n                    value={currentPassword}\r\n                    onChange={onChangeCurrentPassword}\r\n                    onFocus={() => onFocusField(\"current\")}\r\n                    onBlur={onBlurField}\r\n                    className=\"w-full bg-transparent text-sm text-slate-600 focus:outline-none\"\r\n                  />\r\n                  {currentPassword.length > 0 ? (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={onToggleShowCurrentPassword}\r\n                      className=\"text-slate-400 hover:text-slate-600\"\r\n                      aria-label={\r\n                        showCurrentPassword\r\n                          ? \"Ocultar contraseña\"\r\n                          : \"Mostrar contraseña\"\r\n                      }\r\n                    >\r\n                      {showCurrentPassword ? (\r\n                        <EyeOff size={16} />\r\n                      ) : (\r\n                        <Eye size={16} />\r\n                      )}\r\n                    </button>\r\n                  ) : null}\r\n                </div>\r\n              </div>\r\n              {showCurrentPasswordError ? (\r\n                <div className=\"flex items-center gap-2 text-xs text-red-500 pl-1\">\r\n                  <X size={12} />\r\n                  La contraseña no coincide con la anterior\r\n                </div>\r\n              ) : null}\r\n            </div>\r\n          ) : null}\r\n          <div className=\"relative rounded-xl border border-[#E9E2F7] bg-white px-3 py-2\">\r\n            <span className=\"absolute -top-3 left-3 bg-white px-2 text-[13px] text-slate-500\">\r\n              {passwordMode === \"change\" ? \"Nueva contraseña\" : \"Contraseña\"}\r\n            </span>\r\n            <div className=\"flex items-center gap-2\">\r\n              <input\r\n                ref={passwordInputRef}\r\n                type={showPassword ? \"text\" : \"password\"}\r\n                value={passwordValue}\r\n                onChange={onChangePasswordValue}\r\n                onFocus={() => onFocusField(\"new\")}\r\n                onBlur={onBlurField}\r\n                className=\"w-full bg-transparent text-sm text-slate-600 focus:outline-none\"\r\n              />\r\n              {passwordValue.length > 0 ? (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={onToggleShowPassword}\r\n                  className=\"text-slate-400 hover:text-slate-600\"\r\n                  aria-label={\r\n                    showPassword ? \"Ocultar contraseña\" : \"Mostrar contraseña\"\r\n                  }\r\n                >\r\n                  {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}\r\n                </button>\r\n              ) : null}\r\n            </div>\r\n          </div>\r\n          {showPasswordRules ? (\r\n            <div className=\"space-y-2 text-xs pl-1 -mt-4\">\r\n              {[\r\n                {\r\n                  key: \"length\",\r\n                  ok: hasMinLength,\r\n                  label: \"Al menos 8 caracteres\",\r\n                },\r\n                {\r\n                  key: \"symbols\",\r\n                  ok: hasNumberAndSymbol,\r\n                  label: \"Incluye un simbolo y un numero\",\r\n                },\r\n              ].map((item) => {\r\n                if (showPasswordErrors && item.ok) return null;\r\n                const color = item.ok\r\n                  ? \"text-emerald-600\"\r\n                  : showPasswordErrors\r\n                    ? \"text-red-500\"\r\n                    : \"text-slate-400\";\r\n                const Icon = item.ok ? Check : X;\r\n                return (\r\n                  <div key={item.key} className={`flex items-center gap-2 ${color}`}>\r\n                    <Icon size={12} />\r\n                    {item.label}\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          ) : null}\r\n          <div className=\"relative rounded-xl border border-[#E9E2F7] bg-white px-3 py-2\">\r\n            <span className=\"absolute -top-3 left-3 bg-white px-2 text-[13px] text-slate-500\">\r\n              {passwordMode === \"change\"\r\n                ? \"Confirmar contraseña\"\r\n                : \"Verificar contraseña\"}\r\n            </span>\r\n            <div className=\"flex items-center gap-2\">\r\n              <input\r\n                ref={confirmInputRef}\r\n                type={showPasswordConfirm ? \"text\" : \"password\"}\r\n                value={passwordConfirm}\r\n                onChange={onChangePasswordConfirm}\r\n                onFocus={() => onFocusField(\"confirm\")}\r\n                onBlur={onBlurField}\r\n                className=\"w-full bg-transparent text-sm text-slate-600 focus:outline-none\"\r\n              />\r\n              {passwordConfirm.length > 0 ? (\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={onToggleShowPasswordConfirm}\r\n                  className=\"text-slate-400 hover:text-slate-600\"\r\n                  aria-label={\r\n                    showPasswordConfirm\r\n                      ? \"Ocultar contraseña\"\r\n                      : \"Mostrar contraseña\"\r\n                  }\r\n                >\r\n                  {showPasswordConfirm ? (\r\n                    <EyeOff size={16} />\r\n                  ) : (\r\n                    <Eye size={16} />\r\n                  )}\r\n                </button>\r\n              ) : null}\r\n            </div>\r\n          </div>\r\n          {showConfirmRule ? (\r\n            <div className=\"space-y-2 text-xs pl-1 -mt-4\">\r\n              {(() => {\r\n                if (showConfirmErrors && passwordsMatch) return null;\r\n                const color = passwordsMatch\r\n                  ? \"text-emerald-600\"\r\n                  : showConfirmErrors\r\n                    ? \"text-red-500\"\r\n                    : \"text-slate-400\";\r\n                const Icon = passwordsMatch ? Check : X;\r\n                return (\r\n                  <div className={`flex items-center gap-2 ${color}`}>\r\n                    <Icon size={12} />\r\n                    Las contraseñas deben coincidir\r\n                  </div>\r\n                );\r\n              })()}\r\n            </div>\r\n          ) : null}\r\n          <div className=\"mt-2 flex items-center justify-between text-sm font-semibold px-4\">\r\n            {hideCancel ? <span /> : (\r\n              <button\r\n                type=\"button\"\r\n                onClick={onPasswordCancel}\r\n                className=\"text-[#2F1A55]\"\r\n              >\r\n                Cancelar\r\n              </button>\r\n            )}\r\n            <button\r\n              type=\"button\"\r\n              onClick={onPasswordSave}\r\n              disabled={!canSavePassword}\r\n              className={canSavePassword ? \"text-[#5E30A5]\" : \"text-slate-400\"}\r\n            >\r\n              Guardar\r\n            </button>\r\n          </div>\r\n        </div>\r\n      ) : null}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\PersonalDataBlock.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\PinAccessCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\PlanBenefitsCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\SessionsList.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\SupportChatHubBlock.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'usuario' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":12,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":16,"suggestions":[{"messageId":"removeVar","data":{"varName":"usuario"},"fix":{"range":[646,692],"text":""},"desc":"Remove unused variable 'usuario'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from \"react\";\r\nimport { MessageSquareText } from \"lucide-react\";\r\nimport { useLocation } from \"react-router-dom\";\r\nimport { useAppStore } from \"../../../store/appStore\";\r\nimport { useModal } from \"../../../modals/useModal\";\r\nimport { SUPPORT_CHAT_CATEGORIES } from \"../data/supportChatCategories\";\r\nimport { createSupportChatThread } from \"../services/supportChatClient\";\r\nimport { cancelSupportThread } from \"@referidos/support-sdk/supportClient\";\r\nimport { logCatalogBreadcrumb } from \"../../../services/loggingClient\";\r\n\r\nexport default function SupportChatHubBlock({ role, onShowTickets }) {\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const onboarding = useAppStore((s) => s.onboarding);\r\n  const location = useLocation();\r\n  const { openModal } = useModal();\r\n  const [category, setCategory] = useState(\"acceso\");\r\n  const [summary, setSummary] = useState(\"\");\r\n  const [includeContext, setIncludeContext] = useState(true);\r\n  const [loading, setLoading] = useState(false);\r\n  const [created, setCreated] = useState(null);\r\n  const [queueCanceled, setQueueCanceled] = useState(false);\r\n\r\n  const categories = useMemo(\r\n    () => SUPPORT_CHAT_CATEGORIES.filter((item) => item.roles.includes(role)),\r\n    [role]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!categories.length) return;\r\n    if (!categories.some((item) => item.id === category)) {\r\n      setCategory(categories[0].id);\r\n    }\r\n  }, [categories, category]);\r\n\r\n  const context = useMemo(() => {\r\n    if (!includeContext) return {};\r\n    return {\r\n      route: location.pathname,\r\n      role,\r\n      negocio_id: onboarding?.negocio?.id ?? null,\r\n      promo_id: onboarding?.promo_id ?? null,\r\n      app_version: import.meta.env.VITE_APP_VERSION ?? \"web\",\r\n      device: navigator.platform ?? \"unknown\",\r\n      browser: navigator.userAgent ?? \"unknown\",\r\n    };\r\n  }, [includeContext, location.pathname, onboarding, role]);\r\n\r\n  const canSubmit = summary.trim().length > 4 && !loading;\r\n\r\n  const handleCreate = async () => {\r\n    if (!canSubmit) return;\r\n    logCatalogBreadcrumb(\"support.flow.step\", {\r\n      step: \"create_ticket_click\",\r\n      category,\r\n      include_context: includeContext,\r\n    });\r\n    setLoading(true);\r\n    const payload = {\r\n      category,\r\n      summary: summary.trim(),\r\n      context,\r\n      client_request_id: crypto.randomUUID(),\r\n    };\r\n    const result = await createSupportChatThread(payload);\r\n    setLoading(false);\r\n    if (!result.ok) {\r\n      setCreated({ error: result.error || \"No se pudo crear el ticket.\" });\r\n      return;\r\n    }\r\n    const threadPublicId = result.data?.thread_public_id;\r\n    setCreated(result.data);\r\n    setQueueCanceled(false);\r\n    const queueModalProps = {\r\n      onConfirmUnderstand: () => {},\r\n      onRequestCancel: () => {\r\n        openModal(\"SupportQueueCancel\", {\r\n          onContinueQueue: () => openModal(\"SupportQueue\", queueModalProps),\r\n          onConfirmCancel: async () => {\r\n            if (!threadPublicId) return;\r\n            logCatalogBreadcrumb(\"support.ticket.cancel.start\", {\r\n              thread_public_id: threadPublicId,\r\n            });\r\n            const cancelResult = await cancelSupportThread({\r\n              thread_public_id: threadPublicId,\r\n            });\r\n            if (cancelResult.ok) {\r\n              logCatalogBreadcrumb(\"support.ticket.cancel.ok\", {\r\n                thread_public_id: threadPublicId,\r\n              });\r\n              setQueueCanceled(true);\r\n            } else {\r\n              logCatalogBreadcrumb(\"support.ticket.cancel.error\", {\r\n                thread_public_id: threadPublicId,\r\n                error: cancelResult?.error || \"cancel_failed\",\r\n              });\r\n            }\r\n          },\r\n        });\r\n      },\r\n    };\r\n    openModal(\"SupportQueue\", queueModalProps);\r\n  };\r\n\r\n  const handleOpenWhatsapp = () => {\r\n    if (created?.wa_link) {\r\n      logCatalogBreadcrumb(\"support.ticket.whatsapp.open\", {\r\n        thread_public_id: created?.thread_public_id || null,\r\n      });\r\n      window.open(created.wa_link, \"_blank\", \"noopener\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"space-y-3\">\r\n        <div className=\"text-[12px] font-semibold text-[#2F1A55]\">\r\n          Selecciona la categoria\r\n        </div>\r\n        <div className=\"grid gap-3 sm:grid-cols-2\">\r\n          {categories.map((item) => (\r\n            <button\r\n              key={item.id}\r\n              type=\"button\"\r\n              onClick={() => {\r\n                setCategory(item.id);\r\n                logCatalogBreadcrumb(\"support.help.select\", {\r\n                  option: \"chat_category\",\r\n                  category: item.id,\r\n                });\r\n              }}\r\n              className={`rounded-2xl border px-4 py-3 text-left transition ${\r\n                category === item.id\r\n                  ? \"border-[#5E30A5] bg-[#F5F0FF] text-[#2F1A55]\"\r\n                  : \"border-[#E9E2F7] bg-white text-slate-600 hover:bg-[#FAF8FF]\"\r\n              }`}\r\n            >\r\n              <div className=\"text-sm font-semibold\">{item.label}</div>\r\n              <div className=\"text-xs text-slate-500 mt-1\">\r\n                {item.description}\r\n              </div>\r\n            </button>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"space-y-2\">\r\n        <label className=\"text-xs font-semibold text-[#2F1A55]\">\r\n          Describe tu caso en una linea\r\n        </label>\r\n        <input\r\n          value={summary}\r\n          onChange={(e) => setSummary(e.target.value)}\r\n          placeholder=\"Ej: No puedo validar un QR en mi negocio\"\r\n          className=\"w-full rounded-2xl border border-[#E9E2F7] px-4 py-3 text-sm text-slate-700 outline-none focus:border-[#5E30A5]\"\r\n        />\r\n      </div>\r\n\r\n      <label className=\"flex items-center gap-3 text-xs text-slate-500\">\r\n        <input\r\n          type=\"checkbox\"\r\n          checked={includeContext}\r\n          onChange={(e) => setIncludeContext(e.target.checked)}\r\n        />\r\n        Adjuntar contexto tecnico (ruta, version, dispositivo)\r\n      </label>\r\n\r\n      <div className=\"flex flex-col gap-3\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleCreate}\r\n          disabled={!canSubmit}\r\n          className={`rounded-2xl px-4 py-3 text-sm font-semibold text-white transition ${\r\n            canSubmit ? \"bg-[#5E30A5] hover:bg-[#4B2488]\" : \"bg-[#C9B6E8]\"\r\n          }`}\r\n        >\r\n          {loading ? \"Creando ticket...\" : \"Crear ticket y abrir WhatsApp\"}\r\n        </button>\r\n        <button\r\n          type=\"button\"\r\n          onClick={onShowTickets}\r\n          className=\"text-sm font-semibold text-[#5E30A5]\"\r\n        >\r\n          Ver mis tickets\r\n        </button>\r\n      </div>\r\n\r\n      {created?.error ? (\r\n        <div className=\"rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-600\">\r\n          {created.error}\r\n        </div>\r\n      ) : null}\r\n\r\n      {created?.wa_link ? (\r\n        <div className=\"rounded-3xl border border-[#E9E2F7] bg-white p-5 space-y-4\">\r\n          <div className=\"flex items-center gap-3 text-sm font-semibold text-[#2F1A55]\">\r\n            <MessageSquareText size={18} />\r\n            Mensaje listo para WhatsApp\r\n          </div>\r\n          <div className=\"rounded-2xl border border-[#E9E2F7] bg-[#FAF8FF] px-4 py-3 text-xs text-slate-600 whitespace-pre-line\">\r\n            {created.wa_message_text}\r\n          </div>\r\n          {!queueCanceled ? (\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleOpenWhatsapp}\r\n              className=\"w-full rounded-2xl bg-[#25D366] px-4 py-3 text-sm font-semibold text-white\"\r\n            >\r\n              Abrir WhatsApp\r\n            </button>\r\n          ) : null}\r\n          {queueCanceled ? (\r\n            <div className=\"text-xs text-slate-500\">\r\n              Busqueda de asesor cancelada.\r\n            </div>\r\n          ) : null}\r\n        </div>\r\n      ) : null}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\SupportChatTicketsBlock.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\SupportFeedbackForm.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\SupportHelpOptions.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\ThemeSelector.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\TierCurrentCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\TierNextCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\TwoFACard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\blocks\\VerificationCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\data\\faqContent.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\data\\supportChatCategories.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\hooks\\useMfaState.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\Access.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\AppAppearance.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\Beneficios.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\Feedback.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\Help.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\Language.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\LinkedAccounts.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\ManageAccount.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\Notifications.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\PersonalData.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\ProfileOverview.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\Sessions.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\SupportChat.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\SupportEmail.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\sections\\TwoFA.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\profile\\shared\\services\\supportChatClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\router\\guards\\RequireAuth.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\router\\guards\\RequireRole.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\router\\guards\\pwaGuard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\routes.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\EscanerCamera.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":43,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":19},{"ruleId":"no-unused-vars","severity":2,"message":"'err' is defined but never used.","line":62,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":19}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useRef } from \"react\";\r\n\r\nexport default function EscanerCamera({\r\n  active = true,\r\n  disabled = false,\r\n  onDetected,\r\n  onSupportChange,\r\n  onPermissionChange,\r\n  onFallback,\r\n  onStatus,\r\n}) {\r\n  const videoRef = useRef(null);\r\n  const detectorRef = useRef(null);\r\n  const rafRef = useRef(null);\r\n  const streamRef = useRef(null);\r\n  const disabledRef = useRef(disabled);\r\n\r\n  useEffect(() => {\r\n    if (!active) return undefined;\r\n    let cancelled = false;\r\n\r\n    const start = async () => {\r\n      try {\r\n        const supportsBarcode = \"BarcodeDetector\" in window;\r\n        onSupportChange?.(supportsBarcode);\r\n        if (supportsBarcode) {\r\n          detectorRef.current = new window.BarcodeDetector({\r\n            formats: [\"qr_code\"],\r\n          });\r\n        }\r\n\r\n        const stream = await navigator.mediaDevices.getUserMedia({\r\n          video: { facingMode: \"environment\" },\r\n        });\r\n        if (cancelled) return;\r\n        streamRef.current = stream;\r\n        onPermissionChange?.(true);\r\n        if (videoRef.current) {\r\n          videoRef.current.srcObject = stream;\r\n        }\r\n\r\n        if (supportsBarcode) scanLoop();\r\n      } catch (err) {\r\n        onPermissionChange?.(false);\r\n        onFallback?.();\r\n        onStatus?.(\"Activa la camara o pega el codigo manualmente.\");\r\n      }\r\n    };\r\n\r\n    const scanLoop = async () => {\r\n      try {\r\n        if (\r\n          !disabledRef.current &&\r\n          detectorRef.current &&\r\n          videoRef.current?.readyState >= 2\r\n        ) {\r\n          const codes = await detectorRef.current.detect(videoRef.current);\r\n          if (codes.length) {\r\n            onDetected?.(codes[0].rawValue);\r\n          }\r\n        }\r\n      } catch (err) {\r\n        onStatus?.(\"No se pudo leer el QR.\");\r\n      } finally {\r\n        rafRef.current = requestAnimationFrame(scanLoop);\r\n      }\r\n    };\r\n\r\n    start();\r\n\r\n    return () => {\r\n      cancelled = true;\r\n      if (rafRef.current) cancelAnimationFrame(rafRef.current);\r\n      if (streamRef.current) {\r\n        streamRef.current.getTracks().forEach((track) => track.stop());\r\n      }\r\n    };\r\n  }, [active, onDetected, onFallback, onPermissionChange, onStatus, onSupportChange]);\r\n\r\n  useEffect(() => {\r\n    disabledRef.current = disabled;\r\n  }, [disabled]);\r\n\r\n  return (\r\n    <div className=\"relative w-full max-w-sm self-center\">\r\n      <div\r\n        className=\"relative w-full aspect-square rounded-2xl overflow-hidden shadow-sm border border-[#E9E2F7] bg-white\"\r\n      >\r\n        <video\r\n          ref={videoRef}\r\n          className=\"w-full h-full object-cover\"\r\n          autoPlay\r\n          playsInline\r\n          muted\r\n        />\r\n        <div className=\"absolute inset-0 pointer-events-none\">\r\n          <div className=\"absolute top-0 left-0 w-full h-1 bg-[#5E30A5] animate-pulse\" />\r\n          <div className=\"absolute inset-6 rounded-2xl border border-white/40\" />\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\EscanerFallback.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\EscanerPermisos.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\EscanerView.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'statusMsg' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":91,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":91,"endColumn":19,"suggestions":[{"messageId":"removeVar","data":{"varName":"statusMsg"},"fix":{"range":[3393,3402],"text":""},"desc":"Remove unused variable 'statusMsg'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'statusType' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":92,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":92,"endColumn":20,"suggestions":[{"messageId":"removeVar","data":{"varName":"statusType"},"fix":{"range":[3444,3454],"text":""},"desc":"Remove unused variable 'statusType'."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useCallback, useEffect, useMemo, useState } from \"react\";\r\nimport { Camera, QrCode } from \"lucide-react\";\r\nimport { useAppStore } from \"../store/appStore\";\r\nimport { redeemValidQr } from \"../services/qrService\";\r\nimport { handleError } from \"../utils/errorUtils\";\r\nimport { sanitizeText } from \"../utils/sanitize\";\r\nimport EscanerCamera from \"./EscanerCamera\";\r\nimport EscanerPermisos from \"./EscanerPermisos\";\r\nimport EscanerFallback from \"./EscanerFallback\";\r\n\r\nconst parseCode = (raw) => {\r\n  if (!raw) throw new Error(\"QR vacio\");\r\n  const value = raw.trim();\r\n  if (value.startsWith(\"qrv-\")) return { type: \"valid\", code: value };\r\n  if (value.startsWith(\"qrs-\")) return { type: \"static\", code: value };\r\n  throw new Error(\"QR no reconocido\");\r\n};\r\n\r\nconst ResultCard = ({ data }) => {\r\n  if (!data) return null;\r\n  return (\r\n    <div className=\"w-full rounded-2xl border border-[#E9E2F7] bg-white shadow-sm p-4 flex flex-col gap-2\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <p className=\"text-xs text-slate-500\">Estado</p>\r\n        <span\r\n          className=\"px-3 py-1 rounded-full text-[10px] font-semibold\"\r\n          style={{\r\n            background:\r\n              data.status === \"valido\"\r\n                ? \"#10B98122\"\r\n                : data.status === \"canjeado\"\r\n                ? \"#1DA1F222\"\r\n                : \"#EF444422\",\r\n            color:\r\n              data.status === \"valido\"\r\n                ? \"#10B981\"\r\n                : data.status === \"canjeado\"\r\n                ? \"#1DA1F2\"\r\n                : \"#EF4444\",\r\n            border: \"1px solid rgba(0,0,0,0.06)\",\r\n          }}\r\n        >\r\n          {data.status}\r\n        </span>\r\n      </div>\r\n      <div className=\"flex flex-col gap-1\">\r\n        <p className=\"text-sm font-semibold text-[#2F1A55]\">\r\n          {sanitizeText(data.promoTitulo || \"Promo\")}\r\n        </p>\r\n        <p className=\"text-xs text-slate-500\">\r\n          Cliente: {sanitizeText(data.clienteNombre || data.clienteId || \"N/D\")}\r\n        </p>\r\n        <p className=\"text-xs text-slate-500\">\r\n          Negocio: {sanitizeText(data.negocioNombre || \"N/D\")}\r\n        </p>\r\n        {data.status === \"valido\" && data.expiresAt && (\r\n          <p className=\"text-[11px] text-slate-400\">\r\n            Expira: {new Date(data.expiresAt).toLocaleTimeString()}\r\n          </p>\r\n        )}\r\n        {data.status === \"canjeado\" && data.redeemedAt && (\r\n          <p className=\"text-[11px] text-slate-400\">\r\n            Canjeado: {new Date(data.redeemedAt).toLocaleTimeString()}\r\n          </p>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default function EscanerView() {\r\n  const usuario = useAppStore((s) => s.usuario);\r\n  const scannerPermissionPrompted = useAppStore(\r\n    (s) => s.scannerPermissionPrompted\r\n  );\r\n  const setScannerPermissionPrompted = useAppStore(\r\n    (s) => s.setScannerPermissionPrompted\r\n  );\r\n  const manualFallbackShown = useAppStore(\r\n    (s) => s.scannerManualFallbackShown\r\n  );\r\n  const setManualFallbackShown = useAppStore(\r\n    (s) => s.setScannerManualFallbackShown\r\n  );\r\n  const isNegocio = usuario?.role === \"negocio\";\r\n\r\n  const [cameraAvailable, setCameraAvailable] = useState(null);\r\n  const [scanSupported, setScanSupported] = useState(null);\r\n  const [camGranted, setCamGranted] = useState(null);\r\n  const [manualValue, setManualValue] = useState(\"\");\r\n  const [statusMsg, setStatusMsg] = useState(\"\");\r\n  const [statusType, setStatusType] = useState(\"info\");\r\n  const [result, setResult] = useState(null);\r\n  const [processing, setProcessing] = useState(false);\r\n  const [manualRequested, setManualRequested] = useState(false);\r\n  useEffect(() => {\r\n    if (typeof window === \"undefined\") return;\r\n    setScanSupported(\"BarcodeDetector\" in window);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (typeof navigator === \"undefined\") return;\r\n    setCameraAvailable(!!navigator.mediaDevices?.getUserMedia);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (typeof navigator === \"undefined\") return;\r\n    if (!navigator.permissions?.query) return;\r\n    let active = true;\r\n    navigator.permissions\r\n      .query({ name: \"camera\" })\r\n      .then((status) => {\r\n        if (!active) return;\r\n        if (status.state === \"granted\") {\r\n          setCamGranted(true);\r\n          if (!scannerPermissionPrompted) {\r\n            setScannerPermissionPrompted(true);\r\n          }\r\n        } else if (status.state === \"denied\") {\r\n          setCamGranted(false);\r\n          if (!scannerPermissionPrompted) {\r\n            setScannerPermissionPrompted(true);\r\n          }\r\n        }\r\n      })\r\n      .catch(() => {});\r\n    return () => {\r\n      active = false;\r\n    };\r\n  }, [scannerPermissionPrompted, setScannerPermissionPrompted]);\r\n\r\n  const isPwaAndroid = useMemo(() => {\r\n    if (typeof window === \"undefined\" || typeof navigator === \"undefined\") {\r\n      return false;\r\n    }\r\n    const standalone =\r\n      window.matchMedia?.(\"(display-mode: standalone)\")?.matches ||\r\n      window.navigator.standalone ||\r\n      false;\r\n    const isAndroid = /Android/i.test(navigator.userAgent);\r\n    return Boolean(standalone && isAndroid);\r\n  }, []);\r\n\r\n  const requestCameraPermission = useCallback(() => {\r\n    setScannerPermissionPrompted(true);\r\n    if (typeof navigator === \"undefined\") return;\r\n    if (isPwaAndroid) {\r\n      window.location.href =\r\n        \"intent://settings#Intent;action=android.settings.APPLICATION_DETAILS_SETTINGS;end\";\r\n      return;\r\n    }\r\n    if (!navigator.mediaDevices?.getUserMedia) {\r\n      setCameraAvailable(false);\r\n      setCamGranted(false);\r\n      return;\r\n    }\r\n    navigator.mediaDevices\r\n      .getUserMedia({ video: { facingMode: \"environment\" } })\r\n      .then((stream) => {\r\n        stream.getTracks().forEach((track) => track.stop());\r\n        setCamGranted(true);\r\n      })\r\n      .catch(() => {\r\n        setCamGranted(false);\r\n      });\r\n  }, [isPwaAndroid, setScannerPermissionPrompted]);\r\n\r\n  const handleCode = async (raw) => {\r\n    if (!raw || processing) return;\r\n    setProcessing(true);\r\n    setStatusMsg(\"\");\r\n    setResult(null);\r\n    try {\r\n      const parsed = parseCode(raw);\r\n      if (!isNegocio) {\r\n        if (parsed.type === \"valid\") {\r\n          setStatusMsg(\"Muestra este QR al negocio para canjear tu promo.\");\r\n        } else {\r\n          setStatusMsg(\"Este es un QR base. Genera tu QR valido en el detalle.\");\r\n        }\r\n        setStatusType(\"info\");\r\n        return;\r\n      }\r\n\r\n      if (parsed.type !== \"valid\") {\r\n        setStatusMsg(\"Este QR no es canjeable. Solicita un QR valido.\");\r\n        setStatusType(\"info\");\r\n        return;\r\n      }\r\n\r\n      const { ok, data, error } = await redeemValidQr(parsed.code);\r\n      if (!ok) {\r\n        if (error?.includes(\"expired\") || error?.includes(\"expir\")) {\r\n          setStatusMsg(\"Este QR ha expirado.\");\r\n          setStatusType(\"expirado\");\r\n        } else if (error?.includes(\"canjeado\") || error?.includes(\"redeemed\")) {\r\n          setStatusMsg(\"Este QR ya fue canjeado.\");\r\n          setStatusType(\"canjeado\");\r\n        } else {\r\n          setStatusMsg(error || \"No se pudo canjear.\");\r\n          setStatusType(\"info\");\r\n        }\r\n        return;\r\n      }\r\n\r\n      setResult({\r\n        ...data,\r\n        expiresAt: data.expiresAt,\r\n        redeemedAt: data.redeemedAt,\r\n      });\r\n\r\n      if (data.status === \"valido\") {\r\n        setStatusMsg(\"QR valido. Canje registrado correctamente.\");\r\n        setStatusType(\"valido\");\r\n      } else if (data.status === \"canjeado\") {\r\n        setStatusMsg(\"Este QR ya fue canjeado.\");\r\n        setStatusType(\"canjeado\");\r\n      } else {\r\n        setStatusMsg(\"Este QR ha expirado.\");\r\n        setStatusType(\"expirado\");\r\n      }\r\n    } catch (err) {\r\n      setStatusMsg(handleError(err));\r\n      setStatusType(\"info\");\r\n    } finally {\r\n      setProcessing(false);\r\n    }\r\n  };\r\n\r\n  const canScan = scanSupported !== false && cameraAvailable !== false;\r\n  const showCamera = canScan && camGranted === true;\r\n  const showPermissionIntro =\r\n    !scannerPermissionPrompted && camGranted !== true && cameraAvailable !== false;\r\n  const showPermisos =\r\n    scannerPermissionPrompted && (!canScan || camGranted !== true);\r\n  const showManual = manualFallbackShown;\r\n  const manualReady =\r\n    manualValue.replace(/[^0-9a-zA-Z]/g, \"\").length === 6;\r\n  const manualDisabled = processing || !manualReady;\r\n\r\n  const handleManualOpen = useCallback(() => {\r\n    if (manualRequested) return;\r\n    setManualRequested(true);\r\n    setManualFallbackShown(true);\r\n  }, [manualRequested, setManualFallbackShown]);\r\n\r\n  return (\r\n    <div\r\n      className={`w-full flex flex-col ${showPermissionIntro ? \"\" : \"px-4 pt-4\"}`}\r\n      style={{\r\n        minHeight:\r\n          \"calc(100dvh - var(--cliente-header-height, 0px) - 80px - env(safe-area-inset-bottom))\",\r\n        paddingBottom: showPermissionIntro\r\n          ? 0\r\n          : \"calc(10px + env(safe-area-inset-bottom))\",\r\n      }}\r\n    >\r\n      {!showPermissionIntro && (\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          {showPermisos ? (\r\n            <h1 className=\"text-base font-semibold text-[#2F1A55]\">\r\n              Ingresa el codigo manualmente\r\n            </h1>\r\n          ) : isNegocio ? (\r\n            <h1 className=\"text-base font-semibold text-[#2F1A55]\">\r\n              Escaner de canje\r\n            </h1>\r\n          ) : (\r\n            <div />\r\n          )}\r\n          {processing && (\r\n            <span className=\"text-xs text-slate-400\">Procesando...</span>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      <div className=\"flex flex-1 flex-col\">\r\n        {showCamera && !showManual && (\r\n          <div className=\"space-y-4\">\r\n            <EscanerCamera\r\n              active={showCamera && !showManual}\r\n              disabled={processing}\r\n              onDetected={handleCode}\r\n              onSupportChange={setScanSupported}\r\n              onPermissionChange={setCamGranted}\r\n              onFallback={() => {\r\n                setCamGranted(false);\r\n              }}\r\n              onStatus={(msg) => {\r\n                setStatusMsg(msg);\r\n                setStatusType(\"info\");\r\n              }}\r\n            />\r\n          </div>\r\n        )}\r\n\r\n        {showPermissionIntro && (\r\n          <div className=\"relative flex flex-1 items-center justify-center overflow-hidden\">\r\n            <div className=\"absolute inset-0 bg-gradient-to-b from-[#F7F2FF] via-white to-white\" />\r\n            <div className=\"absolute -top-20 -right-10 h-52 w-52 rounded-full bg-[#E9DFFF] opacity-70 blur-3xl\" />\r\n            <div className=\"absolute -bottom-24 -left-10 h-56 w-56 rounded-full bg-[#EFE7FF] opacity-80 blur-3xl\" />\r\n            <div className=\"relative z-10 w-full h-full max-w-md px-6 text-center\">\r\n              <div className=\"relative mx-auto h-36 w-36\">\r\n                <div className=\"absolute inset-0 rounded-[36px] bg-[#F3EEFF] shadow-[0_20px_50px_rgba(94,48,165,0.18)]\" />\r\n                <div className=\"absolute inset-0 flex items-center justify-center text-[#5E30A5]\">\r\n                  <Camera size={62} strokeWidth={1.6} />\r\n                </div>\r\n                <div className=\"absolute -bottom-3 -right-3 h-12 w-12 rounded-full border-2 border-white bg-[#5E30A5] text-white flex items-center justify-center shadow-sm\">\r\n                  <QrCode size={18} strokeWidth={2} />\r\n                </div>\r\n              </div>\r\n\r\n              <h2 className=\"mt-8 text-2xl font-semibold text-[#2F1A55]\">\r\n                Activa la camara para escanear codigos\r\n              </h2>\r\n              <p className=\"mt-3 text-[15px] text-slate-500\">\r\n                Al permitir acceso a la camara podras leer los codigos en\r\n                segundos.\r\n              </p>\r\n\r\n              <div className=\"mt-8 flex flex-col gap-3\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={requestCameraPermission}\r\n                  className=\"w-full rounded-2xl bg-[#5E30A5] px-4 py-3.5 text-sm font-semibold text-white shadow-sm transition hover:bg-[#4B2488]\"\r\n                >\r\n                  Continuar\r\n                </button>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setScannerPermissionPrompted(true)}\r\n                  className=\"w-full rounded-2xl border border-[#E9E2F7] px-4 py-3.5 text-sm font-semibold text-[#5E30A5] transition hover:bg-[#F5F3FF]\"\r\n                >\r\n                  En otro momento\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {showPermisos && (\r\n          <div\r\n            className={`flex flex-1 flex-col items-center ${\r\n              showManual ? \"pt-6\" : \"justify-center\"\r\n            }`}\r\n          >\r\n            <div\r\n              className=\"w-full max-w-xl transition-transform duration-500 ease-out\"\r\n            >\r\n              <EscanerPermisos\r\n                camSupported={canScan}\r\n                camGranted={camGranted}\r\n                onManual={handleManualOpen}\r\n                onRequestCamera={requestCameraPermission}\r\n                showButton={!showManual}\r\n                manualDisabled={manualRequested}\r\n                manualOpen={showManual}\r\n                manualContent={\r\n                  <div className=\"w-full\">\r\n                    <EscanerFallback\r\n                      value={manualValue}\r\n                      onChange={setManualValue}\r\n                      onSubmit={() => handleCode(manualValue)}\r\n                      disabled={manualDisabled}\r\n                    />\r\n                  </div>\r\n                }\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {!showPermissionIntro && (\r\n        <div className=\"mt-5 flex flex-col gap-3 w-full max-w-lg self-center\">\r\n          <ResultCard data={result} />\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\ScannerView.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerCameraBlock.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerHeader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerManualEntry.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerPermissionCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerPermissionIntro.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerProcessingHint.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerResultCard.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\scanner\\blocks\\ScannerStatusBanner.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\SearchBar.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\SearchEmpty.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\SearchHeader.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\SearchIdle.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\SearchMode.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\SearchOverlay.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\SearchResults.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\auth\\AddressStepSearch.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\cliente\\ClienteInicioSearch.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\hooks\\useSearchKeyboard.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\hooks\\useSearchMode.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\negocio\\NegocioGestionarSearch.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\search\\profile\\PerfilSearch.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\addressReverseClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\addressSearchClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\authService.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'error' is defined but never used.","line":293,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":293,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/services/authService.js\r\nimport { supabase } from \"../lib/supabaseClient\";\r\nimport { logCatalogBreadcrumb } from \"./loggingClient\";\r\n\r\nconst wait = (ms) => new Promise((r) => setTimeout(r, ms));\r\n\r\nasync function waitForUser(id_auth, attempts = 12, delay = 500) {\r\n  for (let i = 0; i < attempts; i++) {\r\n    const { data, error } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"*\")\r\n      .eq(\"id_auth\", id_auth)\r\n      .maybeSingle();\r\n    if (error) break;\r\n    if (data) return data;\r\n    await wait(delay);\r\n  }\r\n  return null;\r\n}\r\n\r\nconst DEFAULT_REDIRECT =\r\n  typeof window !== \"undefined\" ? window.location.origin : undefined;\r\n\r\nexport async function signInWithOAuth(provider, opts = {}) {\r\n  const {\r\n    redirectTo = import.meta.env.VITE_AUTH_REDIRECT_URL ?? DEFAULT_REDIRECT,\r\n    scopes,\r\n    queryParams,\r\n  } = opts;\r\n  logCatalogBreadcrumb(\"auth.signin.start\", {\r\n    method: \"oauth\",\r\n    provider: provider || \"unknown\",\r\n  });\r\n\r\n  const { data: res, error } = await supabase.auth.signInWithOAuth({\r\n    provider,\r\n    options: {\r\n      redirectTo,\r\n      scopes,\r\n      queryParams,\r\n      // Redirigimos manualmente para controlar el flujo en UI.\r\n      skipBrowserRedirect: true,\r\n    },\r\n  });\r\n\r\n  if (error) {\r\n    logCatalogBreadcrumb(\"auth.signin.error\", {\r\n      method: \"oauth\",\r\n      provider: provider || \"unknown\",\r\n      error: error.message || \"oauth_failed\",\r\n    });\r\n    throw error;\r\n  }\r\n  if (res?.url) {\r\n    logCatalogBreadcrumb(\"auth.signin.ok\", {\r\n      method: \"oauth\",\r\n      provider: provider || \"unknown\",\r\n      redirected: true,\r\n    });\r\n    window.location.assign(res.url);\r\n    return { ok: true, redirected: true };\r\n  }\r\n  logCatalogBreadcrumb(\"auth.signin.error\", {\r\n    method: \"oauth\",\r\n    provider: provider || \"unknown\",\r\n    error: \"oauth_url_missing\",\r\n  });\r\n  return { ok: false, error: \"No se pudo iniciar el flujo OAuth\" };\r\n}\r\n\r\nexport async function signInWithGoogleIdToken({ token, nonce }) {\r\n  logCatalogBreadcrumb(\"auth.signin.start\", {\r\n    method: \"google_id_token\",\r\n    has_nonce: Boolean(nonce),\r\n  });\r\n  const payload = {\r\n    provider: \"google\",\r\n    token,\r\n  };\r\n  if (nonce) payload.nonce = nonce;\r\n  const { data, error } = await supabase.auth.signInWithIdToken(payload);\r\n  if (error) {\r\n    logCatalogBreadcrumb(\"auth.signin.error\", {\r\n      method: \"google_id_token\",\r\n      error: error.message || \"id_token_failed\",\r\n    });\r\n    throw error;\r\n  }\r\n  logCatalogBreadcrumb(\"auth.signin.ok\", {\r\n    method: \"google_id_token\",\r\n  });\r\n  return data;\r\n}\r\n\r\nexport async function signInWithEmail(email, password) {\r\n  logCatalogBreadcrumb(\"auth.signin.start\", {\r\n    method: \"email_password\",\r\n  });\r\n  try {\r\n    const {\r\n      data: signInData,\r\n      error: signInError\r\n    } = await supabase.auth.signInWithPassword({ email, password });\r\n\r\n    if (signInError) throw signInError;\r\n    if (!signInData?.user) throw new Error(\"No se pudo iniciar sesión\");\r\n\r\n    const authUserId = signInData.user.id;\r\n    const userData = await waitForUser(authUserId);\r\n\r\n    const provider = signInData.user.app_metadata?.provider ?? null;\r\n\r\n    if (!userData) {\r\n      logCatalogBreadcrumb(\"auth.signin.ok\", {\r\n        method: \"email_password\",\r\n        pending_profile: true,\r\n      });\r\n      return {\r\n        ok: true,\r\n        user: {\r\n          id_auth: authUserId,\r\n          email: signInData.user.email,\r\n          provider,\r\n        },\r\n        pendingProfile: true,\r\n      };\r\n    }\r\n    const userWithProvider = { ...userData, provider };\r\n    logCatalogBreadcrumb(\"auth.signin.ok\", {\r\n      method: \"email_password\",\r\n      pending_profile: false,\r\n    });\r\n    return { ok: true, user: userWithProvider };\r\n  } catch (error) {\r\n    logCatalogBreadcrumb(\"auth.signin.error\", {\r\n      method: \"email_password\",\r\n      error: error.message ?? String(error),\r\n    });\r\n    return { ok: false, error: error.message ?? String(error) };\r\n  }\r\n}\r\n\r\nexport async function signUpWithEmail({ email, password }) {\r\n  logCatalogBreadcrumb(\"auth.signup.start\", {\r\n    method: \"email_password\",\r\n  });\r\n  try {\r\n    const {\r\n      data: signUpData,\r\n      error: signUpError\r\n    } = await supabase.auth.signUp({\r\n      email,\r\n      password,\r\n    });\r\n\r\n    if (signUpError) throw signUpError;\r\n    logCatalogBreadcrumb(\"auth.signup.ok\", {\r\n      method: \"email_password\",\r\n      has_session: Boolean(signUpData?.session),\r\n      needs_email_confirm: Boolean(signUpData?.user && !signUpData?.session),\r\n    });\r\n    return { ok: true, data: signUpData };\r\n\r\n  } catch (error) {\r\n    logCatalogBreadcrumb(\"auth.signup.error\", {\r\n      method: \"email_password\",\r\n      error: error.message ?? String(error),\r\n    });\r\n    return { ok: false, error: error.message ?? String(error) };\r\n  }  \r\n}\r\n\r\nexport async function signOut({ scope = \"local\" } = {}) {\r\n  const normalizedScope = scope === \"global\" ? \"global\" : \"local\";\r\n  logCatalogBreadcrumb(\"auth.signout.start\", { scope: normalizedScope });\r\n  const { error } = await supabase.auth.signOut({ scope: normalizedScope });\r\n  if (error) {\r\n    logCatalogBreadcrumb(\"auth.signout.error\", {\r\n      scope: normalizedScope,\r\n      error: error.message || \"signout_failed\",\r\n    });\r\n    throw error;\r\n  }\r\n  logCatalogBreadcrumb(\"auth.signout.ok\", { scope: normalizedScope });\r\n}\r\n\r\nexport async function deleteUserAccount(id_auth) {\r\n  logCatalogBreadcrumb(\"auth.account_delete.start\", {\r\n    has_user_id: Boolean(id_auth),\r\n  });\r\n  if (!id_auth) return { ok: false, error: \"No se pudo identificar la cuenta\" };\r\n\r\n  try {\r\n    const {\r\n      data: { session },\r\n    } = await supabase.auth.getSession();\r\n\r\n    if (!session?.access_token) {\r\n      logCatalogBreadcrumb(\"auth.account_delete.error\", {\r\n        error: \"missing_session_access_token\",\r\n      });\r\n      return {\r\n        ok: false,\r\n        error: \"Tu sesi\\u00f3n expir\\u00f3. Vuelve a iniciar sesi\\u00f3n e intenta de nuevo.\",\r\n      };\r\n    }\r\n\r\n    const { data, error } = await supabase.functions.invoke(\"delete-account\", {\r\n      headers: {\r\n        Authorization: `Bearer ${session.access_token}`,\r\n      },\r\n      body: { userId: id_auth },\r\n    });\r\n\r\n    if (error) {\r\n      //error de Edge invocada (network / non-2xx)\r\n      logCatalogBreadcrumb(\"auth.account_delete.error\", {\r\n        error: error.message ?? String(error),\r\n      });\r\n      return { ok: false, error: error.message ?? String(error) };\r\n    }\r\n\r\n    //La función devuelve { ok: true } o { ok: false, message } (a veces con status)\r\n    if (data?.ok === false) {\r\n      const msg = (data?.message || \"\").toLowerCase();\r\n      //Si la función dice que ya estaba eliminada, tratamos como éxito\r\n      if (msg.includes(\"ya fue eliminada\") || msg.includes(\"already\") || msg.includes(\"not found\")) {\r\n        logCatalogBreadcrumb(\"auth.account_delete.ok\", {\r\n          already_deleted: true,\r\n        });\r\n        return { ok: true };\r\n      }\r\n      logCatalogBreadcrumb(\"auth.account_delete.error\", {\r\n        error: data?.message || \"delete_account_failed\",\r\n      });\r\n      return { ok: false, error: data?.message || \"No se pudo eliminar la cuenta\" };\r\n    }\r\n\r\n    logCatalogBreadcrumb(\"auth.account_delete.ok\", {\r\n      already_deleted: false,\r\n    });\r\n    return { ok: true };\r\n  } catch (error) {\r\n    logCatalogBreadcrumb(\"auth.account_delete.error\", {\r\n      error: error?.message ?? String(error),\r\n    });\r\n    return { ok: false, error: error?.message ?? String(error) };\r\n  }\r\n}\r\n\r\nexport async function updateUserProfile({ id_auth, ...payload }) {\r\n  logCatalogBreadcrumb(\"auth.profile_update.start\", {\r\n    has_user_id: Boolean(id_auth),\r\n    fields: Object.keys(payload || {}).slice(0, 20),\r\n  });\r\n  if (!id_auth) return { ok: false, error: \"Falta id_auth para actualizar perfil\" };\r\n  try {\r\n    const { data, error } = await supabase\r\n      .from(\"usuarios\")\r\n      .update(payload)\r\n      .eq(\"id_auth\", id_auth)\r\n      .select()\r\n      .maybeSingle();\r\n\r\n    if (error) throw error;\r\n    logCatalogBreadcrumb(\"auth.profile_update.ok\", {\r\n      has_user: Boolean(data),\r\n    });\r\n    return { ok: true, user: data };\r\n  } catch (error) {\r\n    logCatalogBreadcrumb(\"auth.profile_update.error\", {\r\n      error: error.message ?? String(error),\r\n    });\r\n    return { ok: false, error: error.message ?? String(error) };\r\n  }\r\n}\r\n\r\nexport async function getSessionUserProfile() {\r\n  try {\r\n    const {\r\n      data: { session },\r\n    } = await supabase.auth.getSession();\r\n\r\n    if (!session) return null;\r\n\r\n    const { data: userData } = await supabase\r\n      .from(\"usuarios\")\r\n      .select(\"*\")\r\n      .eq(\"id_auth\", session.user.id)\r\n      .maybeSingle();\r\n\r\n    return userData || null;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\commentService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\errorPolicyService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\gpsFallbackClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\loggingClient.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'observabilityClient' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":81,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":81,"endColumn":26}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  getBreadcrumbTemplate,\r\n  createErrorRuntime,\r\n  createObservabilityClient,\r\n  createPolicyRuntime,\r\n} from \"@referidos/observability\";\r\nimport { supabase } from \"../lib/supabaseClient\";\r\n\r\nconst importEnv = import.meta.env || {};\r\nconst DEFAULT_TENANT_HINT = importEnv.VITE_DEFAULT_TENANT_ID || \"ReferidosAPP\";\r\nconst DEFAULT_APP_ID = importEnv.VITE_APP_ID || \"referidos-app\";\r\nconst DEFAULT_ENV = importEnv.MODE || importEnv.VITE_ENV || \"development\";\r\nconst DEFAULT_VERSION =\r\n  importEnv.VITE_APP_VERSION ||\r\n  importEnv.VITE_VERSION_LABEL ||\r\n  importEnv.VITE_RELEASE ||\r\n  importEnv.VITE_COMMIT_SHA ||\r\n  \"dev\";\r\nconst DEFAULT_BUILD_ID =\r\n  importEnv.VITE_BUILD_ID ||\r\n  importEnv.VITE_SOURCE_COMMIT_SHA ||\r\n  importEnv.VITE_COMMIT_SHA ||\r\n  \"\";\r\nconst DEFAULT_RELEASE_ID =\r\n  importEnv.VITE_VERSION_RELEASE_ID || importEnv.VITE_RELEASE_ID || \"\";\r\nconst DEFAULT_SOURCE_COMMIT_SHA =\r\n  importEnv.VITE_SOURCE_COMMIT_SHA || importEnv.VITE_COMMIT_SHA || \"\";\r\n\r\nconst LOG_LEVELS = new Set([\"fatal\", \"error\", \"warn\", \"info\", \"debug\"]);\r\nconst LOG_CATEGORIES = new Set([\r\n  \"auth\",\r\n  \"onboarding\",\r\n  \"scanner\",\r\n  \"promos\",\r\n  \"payments\",\r\n  \"network\",\r\n  \"ui_flow\",\r\n  \"performance\",\r\n  \"security\",\r\n  \"audit\",\r\n]);\r\n\r\nconst OBS_SINGLETON_KEY = \"__referidos_observability_client__\";\r\nconst POLICY_SINGLETON_KEY = \"__referidos_observability_policy__\";\r\nconst RUNTIME_SINGLETON_KEY = \"__referidos_observability_runtime__\";\r\n\r\nconst globalScope = globalThis;\r\nif (!globalScope[OBS_SINGLETON_KEY]) {\r\n  globalScope[OBS_SINGLETON_KEY] = createObservabilityClient({\r\n    supabase,\r\n    endpoint: \"obs-ingest\",\r\n    policyEndpoint: \"obs-policy\",\r\n    tenantHint: DEFAULT_TENANT_HINT,\r\n    appId: DEFAULT_APP_ID,\r\n    source: \"web\",\r\n    captureUnhandled: false,\r\n    env: {\r\n      ...importEnv,\r\n      VITE_APP_ID: DEFAULT_APP_ID,\r\n      VITE_APP_VERSION: DEFAULT_VERSION,\r\n      VITE_BUILD_ID: DEFAULT_BUILD_ID,\r\n      MODE: DEFAULT_ENV,\r\n    },\r\n  });\r\n}\r\nif (!globalScope[POLICY_SINGLETON_KEY]) {\r\n  globalScope[POLICY_SINGLETON_KEY] = createPolicyRuntime();\r\n}\r\nif (!globalScope[RUNTIME_SINGLETON_KEY]) {\r\n  globalScope[RUNTIME_SINGLETON_KEY] = createErrorRuntime({\r\n    observabilityClient: globalScope[OBS_SINGLETON_KEY],\r\n    policyRuntime: globalScope[POLICY_SINGLETON_KEY],\r\n    appConfig: {\r\n      appId: DEFAULT_APP_ID,\r\n      tenantHint: DEFAULT_TENANT_HINT,\r\n      source: \"web\",\r\n    },\r\n  });\r\n}\r\n\r\nconst observabilityClient = globalScope[OBS_SINGLETON_KEY];\r\nconst runtime = globalScope[RUNTIME_SINGLETON_KEY];\r\n\r\nlet initialized = false;\r\nlet releaseRegistered = false;\r\nlet loggerEnabled = true;\r\n\r\nconst registerReleaseOnce = async () => {\r\n  if (releaseRegistered) return;\r\n  releaseRegistered = true;\r\n  try {\r\n    await supabase.functions.invoke(\"obs-release\", {\r\n      body: {\r\n        tenant_hint: DEFAULT_TENANT_HINT,\r\n        app_id: DEFAULT_APP_ID,\r\n        app_version: DEFAULT_VERSION,\r\n        build_id: DEFAULT_BUILD_ID,\r\n        env: DEFAULT_ENV,\r\n        meta: {\r\n          versioning: {\r\n            release_id: DEFAULT_RELEASE_ID || null,\r\n            source_commit_sha: DEFAULT_SOURCE_COMMIT_SHA || null,\r\n            version_label: DEFAULT_VERSION,\r\n            env_key: DEFAULT_ENV,\r\n            app_id: DEFAULT_APP_ID,\r\n          },\r\n        },\r\n      },\r\n    });\r\n  } catch {\r\n    // Best-effort release registration.\r\n  }\r\n};\r\n\r\nconst sanitizeLevel = (value) => {\r\n  const next = typeof value === \"string\" ? value.toLowerCase() : \"info\";\r\n  return LOG_LEVELS.has(next) ? next : \"info\";\r\n};\r\n\r\nconst sanitizeCategory = (value) => {\r\n  const next = typeof value === \"string\" ? value.toLowerCase() : \"ui_flow\";\r\n  return LOG_CATEGORIES.has(next) ? next : \"ui_flow\";\r\n};\r\n\r\nexport const initLogger = () => {\r\n  if (initialized) return;\r\n  initialized = true;\r\n  runtime.init();\r\n  runtime.setEnabled(loggerEnabled);\r\n  void registerReleaseOnce();\r\n};\r\n\r\nexport const setLoggerEnabled = (value) => {\r\n  loggerEnabled = Boolean(value);\r\n  runtime.setEnabled(loggerEnabled);\r\n};\r\n\r\nexport const setLoggerUser = ({ role } = {}) => {\r\n  runtime.setContext({\r\n    role: role || null,\r\n  });\r\n};\r\n\r\nexport const setLoggerContext = (partial = {}) => {\r\n  runtime.setContext(partial || {});\r\n};\r\n\r\nexport const logEvent = ({\r\n  level = \"info\",\r\n  category = \"ui_flow\",\r\n  message,\r\n  context = {},\r\n  context_extra = {},\r\n}) => {\r\n  if (!loggerEnabled) return;\r\n  const safeLevel = sanitizeLevel(level);\r\n  const safeCategory = sanitizeCategory(category);\r\n  runtime.logEvent({\r\n    level: safeLevel,\r\n    category: safeCategory,\r\n    message: message || \"\",\r\n    context,\r\n    context_extra,\r\n  });\r\n};\r\n\r\nexport const logBreadcrumb = (message, context = {}) => {\r\n  runtime.addBreadcrumb(message, context || {});\r\n};\r\n\r\nexport const logCatalogBreadcrumb = (code, data = {}, overrides = {}) => {\r\n  const key = typeof code === \"string\" ? code.trim() : \"\";\r\n  if (!key) return;\r\n  const template = getBreadcrumbTemplate(key);\r\n  runtime.addBreadcrumb({\r\n    code: key,\r\n    type: overrides?.type || template?.type || \"ui\",\r\n    channel: overrides?.channel || template?.channel || \"manual\",\r\n    message: overrides?.message || template?.message || key,\r\n    timestamp: overrides?.timestamp || new Date().toISOString(),\r\n    data: data || {},\r\n  });\r\n};\r\n\r\nexport const logError = (error, context = {}) => {\r\n  if (!loggerEnabled) return;\r\n  runtime.logError(error, context || {});\r\n};\r\n\r\nexport const reportError = async (error, payload = {}) => {\r\n  if (!loggerEnabled) return null;\r\n  return await runtime.reportError(error, payload || {});\r\n};\r\n\r\nexport const subscribeErrorEvents = (listener) => {\r\n  return runtime.subscribeErrors(listener);\r\n};\r\n\r\nexport const flushLogs = async () => {\r\n  return await runtime.flush();\r\n};\r\n\r\nexport const evaluateErrorPolicy = async (payload = {}) => {\r\n  return await runtime.evaluatePolicy(payload);\r\n};\r\n\r\nexport const beginPolicyAction = (actionKey) => {\r\n  return runtime.beginPolicyAction(actionKey);\r\n};\r\n\r\nexport const endPolicyAction = (actionKey) => {\r\n  runtime.endPolicyAction(actionKey);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\mfaService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\onboardingClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\promoService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\qrService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\registrationClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\secureStorageService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\sessionDevicesService.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\services\\territoryClient.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\store\\appStore.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'resolvedEmail' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":172,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":172,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"resolvedEmail"},"fix":{"range":[5433,5487],"text":""},"desc":"Remove unused variable 'resolvedEmail'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'resolvedName' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":173,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":173,"endColumn":29,"suggestions":[{"messageId":"removeVar","data":{"varName":"resolvedName"},"fix":{"range":[5499,5582],"text":""},"desc":"Remove unused variable 'resolvedName'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'promosVisible' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":301,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":301,"endColumn":30,"suggestions":[{"messageId":"removeVar","data":{"varName":"promosVisible"},"fix":{"range":[9996,10028],"text":""},"desc":"Remove unused variable 'promosVisible'."}]},{"ruleId":"no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":460,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":460,"endColumn":21}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/store/appStore.js\r\nimport { create } from \"zustand\";\r\nimport { persist } from \"zustand/middleware\";\r\nimport {\r\n  signInWithEmail,\r\n  signUpWithEmail,\r\n  signOut,\r\n} from \"../services/authService\";\r\nimport { endSupportSession } from \"@referidos/support-sdk/supportClient\";\r\nimport { getActivePromos } from \"../services/promoService\";\r\nimport {\r\n  generatePromoQr,\r\n  generateValidQr,\r\n  getActiveValidQr,\r\n  redeemValidQr,\r\n} from \"../services/qrService\";\r\nimport { addComentario } from \"../services/commentService\";\r\nimport { handleError } from \"../utils/errorUtils\";\r\nimport { runOnboardingCheck } from \"../services/onboardingClient\";\r\nimport { registerCurrentSessionDevice } from \"../services/sessionDevicesService\";\r\nimport {\r\n  beginPolicyAction,\r\n  endPolicyAction,\r\n  evaluateErrorPolicy,\r\n  logCatalogBreadcrumb,\r\n  reportError,\r\n} from \"../services/loggingClient\";\r\nimport { supabase } from \"../lib/supabaseClient\";\r\nimport { clearUserSecurityMaterial, loadBiometricToken } from \"../services/secureStorageService\";\r\nimport { useCacheStore } from \"../cache/cacheStore\";\r\nimport { useModalStore } from \"../modals/modalStore\";\r\n\r\nlet promosRefreshTimer = null;\r\nlet promosVisibilityHandler = null;\r\nlet promosAutoRefreshActive = false;\r\nlet bootstrapInFlightPromise = null;\r\n\r\nconst SECURITY_LEVELS = {\r\n  NONE: \"none\",\r\n  UNLOCK_LOCAL: \"unlock_local\",\r\n  REAUTH_SENSITIVE: \"reauth_sensitive\",\r\n};\r\n\r\nconst SECURITY_LEVEL_ORDER = {\r\n  [SECURITY_LEVELS.NONE]: 0,\r\n  [SECURITY_LEVELS.UNLOCK_LOCAL]: 1,\r\n  [SECURITY_LEVELS.REAUTH_SENSITIVE]: 2,\r\n};\r\n\r\nconst UNLOCK_LOCAL_TTL_MS = 10 * 60 * 1000;\r\nconst REAUTH_SENSITIVE_TTL_MS = 5 * 60 * 1000;\r\nconst SESSION_BOOTSTRAP_ACTION_KEY = \"bootstrap:session-register\";\r\nconst SESSION_POLICY_RETRY_CAP = 3;\r\n\r\nconst sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\r\n\r\nconst createRandomBuffer = (size) => {\r\n  const data = new Uint8Array(size);\r\n  window.crypto.getRandomValues(data);\r\n  return data;\r\n};\r\n\r\nconst bufferFromBase64Url = (value) => {\r\n  if (!value) return null;\r\n  const base = value.replace(/-/g, \"+\").replace(/_/g, \"/\");\r\n  const pad = base.length % 4 ? \"=\".repeat(4 - (base.length % 4)) : \"\";\r\n  const binary = window.atob(base + pad);\r\n  const bytes = new Uint8Array(binary.length);\r\n  for (let i = 0; i < binary.length; i += 1) {\r\n    bytes[i] = binary.charCodeAt(i);\r\n  }\r\n  return bytes;\r\n};\r\n\r\nconst defaultSecurityState = {\r\n  unlockLevel: SECURITY_LEVELS.NONE,\r\n  unlockedAt: null,\r\n  unlockMethod: null,\r\n  unlockExpiresAt: null,\r\n  pendingAction: null,\r\n  pendingLevel: null,\r\n  pendingMethod: null,\r\n  rules: {},\r\n};\r\n\r\nexport const useAppStore = create(\r\n  persist(\r\n    (set, get) => {\r\n      const updateSecurity = (partial) =>\r\n        set((state) => ({\r\n          security: {\r\n            ...state.security,\r\n            ...partial,\r\n          },\r\n        }));\r\n\r\n      const resolveUnlockLevel = () => {\r\n        const security = get().security;\r\n        if (\r\n          security?.unlockExpiresAt &&\r\n          Date.now() > security.unlockExpiresAt\r\n        ) {\r\n          updateSecurity({\r\n            unlockLevel: SECURITY_LEVELS.NONE,\r\n            unlockedAt: null,\r\n            unlockMethod: null,\r\n            unlockExpiresAt: null,\r\n            pendingAction: null,\r\n            pendingLevel: null,\r\n            pendingMethod: null,\r\n          });\r\n          return SECURITY_LEVELS.NONE;\r\n        }\r\n        return security?.unlockLevel || SECURITY_LEVELS.NONE;\r\n      };\r\n\r\n      const securityActions = {\r\n        require: (action) => {\r\n          const security = get().security;\r\n          const requiredLevel =\r\n            security?.rules?.[action] ?? SECURITY_LEVELS.NONE;\r\n          const currentLevel = resolveUnlockLevel();\r\n          if (\r\n            SECURITY_LEVEL_ORDER[currentLevel] >=\r\n            SECURITY_LEVEL_ORDER[requiredLevel]\r\n          ) {\r\n            updateSecurity({\r\n              pendingAction: null,\r\n              pendingLevel: null,\r\n              pendingMethod: null,\r\n            });\r\n            return { ok: true, requiredLevel, currentLevel };\r\n          }\r\n          const pendingMethod =\r\n            requiredLevel === SECURITY_LEVELS.REAUTH_SENSITIVE\r\n              ? \"password\"\r\n              : \"local\";\r\n          updateSecurity({\r\n            pendingAction: action,\r\n            pendingLevel: requiredLevel,\r\n            pendingMethod,\r\n          });\r\n          return {\r\n            ok: false,\r\n            requiredLevel,\r\n            currentLevel,\r\n            pendingMethod,\r\n          };\r\n        },\r\n        requestLocalVerification: ({\r\n          onVerified,\r\n          onBlocked,\r\n          requireVerifiedEmail = false,\r\n          userId,\r\n          email,\r\n          displayName,\r\n        } = {}) => {\r\n          const { accessMethods, usuario } = get();\r\n          const onboarding = get().onboarding;\r\n          const modalApi = useModalStore.getState();\r\n          if (requireVerifiedEmail && !onboarding?.email_confirmed) {\r\n            onBlocked?.();\r\n            return { ok: false, reason: \"email_unverified\" };\r\n          }\r\n          const hasFingerprint =\r\n            Boolean(accessMethods?.fingerprint) ||\r\n            Boolean(usuario?.has_biometrics);\r\n          const hasPin =\r\n            Boolean(accessMethods?.pin) ||\r\n            Boolean(usuario?.has_pin);\r\n          const resolvedUserId = userId ?? usuario?.id_auth ?? usuario?.id ?? null;\r\n          const resolvedEmail = email ?? usuario?.email ?? null;\r\n          const resolvedName = displayName ?? usuario?.nombre ?? usuario?.alias ?? \"Usuario\";\r\n\r\n          if (hasFingerprint) {\r\n            (async () => {\r\n              try {\r\n                if (!window.PublicKeyCredential || !window.crypto?.getRandomValues) return;\r\n                const available =\r\n                  await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?.();\r\n                if (available === false) return;\r\n                if (!resolvedUserId) return;\r\n                const token = await loadBiometricToken(resolvedUserId);\r\n                const credentialId = token?.credentialId;\r\n                if (!credentialId) return;\r\n                const credentialBuffer = bufferFromBase64Url(credentialId);\r\n                if (!credentialBuffer) return;\r\n                const publicKey = {\r\n                  challenge: createRandomBuffer(32),\r\n                  allowCredentials: [\r\n                    { type: \"public-key\", id: credentialBuffer },\r\n                  ],\r\n                  userVerification: \"required\",\r\n                  timeout: 45000,\r\n                };\r\n                await navigator.credentials.get({ publicKey });\r\n                onVerified?.();\r\n              } catch {\r\n                // no-op\r\n              }\r\n            })();\r\n            return { ok: false, method: \"fingerprint\" };\r\n          }\r\n\r\n          if (hasPin) {\r\n            modalApi.openModal(\"PinVerify\", {\r\n              userId: resolvedUserId,\r\n              onConfirm: onVerified,\r\n            });\r\n            return { ok: false, method: \"pin\" };\r\n          }\r\n\r\n          onVerified?.();\r\n          return { ok: true, method: \"none\" };\r\n        },\r\n        requestPasswordVerification: ({\r\n          onVerified,\r\n          onBlocked,\r\n          requireVerifiedEmail = false,\r\n          email,\r\n        } = {}) => {\r\n          const onboarding = get().onboarding;\r\n          const modalApi = useModalStore.getState();\r\n          if (requireVerifiedEmail && !onboarding?.email_confirmed) {\r\n            onBlocked?.();\r\n            return { ok: false, reason: \"email_unverified\" };\r\n          }\r\n          modalApi.openModal(\"PasswordReauth\", {\r\n            email,\r\n            onConfirm: onVerified,\r\n          });\r\n          return { ok: false, method: \"password\" };\r\n        },\r\n        unlockWithBiometrics: (ttlMs = UNLOCK_LOCAL_TTL_MS) => {\r\n          const now = Date.now();\r\n          updateSecurity({\r\n            unlockLevel: SECURITY_LEVELS.UNLOCK_LOCAL,\r\n            unlockedAt: now,\r\n            unlockMethod: \"biometrics\",\r\n            unlockExpiresAt: now + ttlMs,\r\n            pendingAction: null,\r\n            pendingLevel: null,\r\n            pendingMethod: null,\r\n          });\r\n          return { ok: true };\r\n        },\r\n        unlockWithPin: (ttlMs = UNLOCK_LOCAL_TTL_MS) => {\r\n          const now = Date.now();\r\n          updateSecurity({\r\n            unlockLevel: SECURITY_LEVELS.UNLOCK_LOCAL,\r\n            unlockedAt: now,\r\n            unlockMethod: \"pin\",\r\n            unlockExpiresAt: now + ttlMs,\r\n            pendingAction: null,\r\n            pendingLevel: null,\r\n            pendingMethod: null,\r\n          });\r\n          return { ok: true };\r\n        },\r\n        unlockWithPassword: (ttlMs = REAUTH_SENSITIVE_TTL_MS) => {\r\n          const now = Date.now();\r\n          updateSecurity({\r\n            unlockLevel: SECURITY_LEVELS.REAUTH_SENSITIVE,\r\n            unlockedAt: now,\r\n            unlockMethod: \"password\",\r\n            unlockExpiresAt: now + ttlMs,\r\n            pendingAction: null,\r\n            pendingLevel: null,\r\n            pendingMethod: null,\r\n          });\r\n          return { ok: true };\r\n        },\r\n        reset: () => {\r\n          updateSecurity({\r\n            ...defaultSecurityState,\r\n          });\r\n        },\r\n        setRule: (action, level) => {\r\n          updateSecurity({\r\n            rules: {\r\n              ...(get().security?.rules || {}),\r\n              [action]: level,\r\n            },\r\n          });\r\n        },\r\n        setRules: (rules = {}) => {\r\n          updateSecurity({\r\n            rules: { ...rules },\r\n          });\r\n        },\r\n      };\r\n\r\n      const schedulePromosRefresh = () => {\r\n        if (!promosAutoRefreshActive) return;\r\n        if (promosRefreshTimer) {\r\n          clearTimeout(promosRefreshTimer);\r\n          promosRefreshTimer = null;\r\n        }\r\n        if (typeof document === \"undefined\") return;\r\n        if (document.visibilityState === \"hidden\") return;\r\n        const { promosVisible } = get();\r\n        const intervalMs = 12 * 60 * 60 * 1000;\r\n        promosRefreshTimer = setTimeout(async () => {\r\n          if (!promosAutoRefreshActive) return;\r\n          await get().loadPromos({ silent: true, force: true });\r\n          schedulePromosRefresh();\r\n        }, intervalMs);\r\n      };\r\n\r\n      return {\r\n      /**\r\n       * MODELO DE ESTADO\r\n       * bootstrap === true -> resolviendo sesi??n + onboarding\r\n       * usuario === undefined -> onboarding a??n no respondi??\r\n       * usuario === null -> sin sesi??n\r\n       * usuario === objeto -> usuario devuelto por onboarding (parcial o completo)\r\n       */\r\n      \r\n      bootstrap: true,\r\n      bootstrapError: false,\r\n      usuario: undefined,\r\n      onboarding: undefined, // ??ltimo payload de onboarding (allowAccess/reasons/negocio/provider)\r\n      ratings: {},\r\n      promos: [],\r\n      promosLoadedAt: null,\r\n      promosRefreshing: false,\r\n      promosVisible: false,\r\n      scannerPermissionPrompted: false,\r\n      scannerManualFallbackShown: false,\r\n      negocios: [],\r\n      accessMethods: {\r\n        fingerprint: false,\r\n        pin: false,\r\n        password: false,\r\n      },\r\n      suspendViewportResize: false,\r\n      suspendViewportAfterNext: false,\r\n      justCompletedRegistration: false,\r\n      emailVerifiedSessionAt: null,\r\n      loading: false,\r\n      error: null,\r\n      security: {\r\n        ...defaultSecurityState,\r\n        ...securityActions,\r\n      },\r\n      setUser: (usuario) => set({ usuario }),\r\n      setAccessMethods: (methods) =>\r\n        set((state) => ({\r\n          accessMethods: {\r\n            ...state.accessMethods,\r\n            ...methods,\r\n          },\r\n        })),\r\n      setSuspendViewportResize: (value) => set({ suspendViewportResize: value }),\r\n      setSuspendViewportAfterNext: (value) =>\r\n        set({ suspendViewportAfterNext: value }),\r\n      freezeViewportAfterNextUpdate: () =>\r\n        set({ suspendViewportAfterNext: true, suspendViewportResize: false }),\r\n      setScannerPermissionPrompted: (value) =>\r\n        set({ scannerPermissionPrompted: value }),\r\n      setScannerManualFallbackShown: (value) =>\r\n        set({ scannerManualFallbackShown: value }),\r\n      setJustCompletedRegistration: (value) =>\r\n        set({ justCompletedRegistration: value }),\r\n      setEmailVerifiedSessionAt: (value) =>\r\n        set({ emailVerifiedSessionAt: value }),\r\n\r\n      //-----------------------\r\n      // AUTH\r\n      //-----------------------\r\n      login: async (email, password) => {\r\n        logCatalogBreadcrumb(\"auth.signin.start\", {\r\n          method: \"store_login\",\r\n        });\r\n        set({ loading: true, error: null });\r\n        try {\r\n          const result = await signInWithEmail(email, password);\r\n          if (!result.ok) {\r\n            logCatalogBreadcrumb(\"auth.signin.error\", {\r\n              method: \"store_login\",\r\n              error: result.error || \"login_failed\",\r\n            });\r\n            set({ loading: false, error: result.error });\r\n            return { ok: false, error: result.error };\r\n          }\r\n\r\n          //login SIEMPRE fuerza onboarding\r\n          const boot = await get().bootstrapAuth({ force: true });\r\n          set({ loading: false });\r\n          \r\n          if (!boot.ok) {\r\n            logCatalogBreadcrumb(\"auth.signin.error\", {\r\n              method: \"store_login_bootstrap\",\r\n              error: boot.error || \"bootstrap_failed\",\r\n            });\r\n            set({ error: boot.error ?? \"No se pudo validar onboarding\" });\r\n            return { ok: false, error: boot.error ?? \"No se pudo validar onboarding\" };\r\n          }\r\n\r\n          logCatalogBreadcrumb(\"auth.signin.ok\", {\r\n            method: \"store_login\",\r\n          });\r\n          return { ok: true };\r\n        } catch (error) {\r\n          const message = handleError(error);\r\n          logCatalogBreadcrumb(\"auth.signin.error\", {\r\n            method: \"store_login\",\r\n            error: message,\r\n          });\r\n          set({ loading: false, error: message });\r\n          return { ok: false, error: message };\r\n        }\r\n      },\r\n\r\n      register: async ({ email, password, telefono, nombre, role = \"cliente\" }) => {\r\n        logCatalogBreadcrumb(\"auth.signup.start\", {\r\n          method: \"store_register\",\r\n          role,\r\n        });\r\n        set({ loading: true, error: null });\r\n        try {\r\n          const result = await signUpWithEmail({ email, password, telefono, nombre, role });\r\n          if (!result.ok) {\r\n            logCatalogBreadcrumb(\"auth.signup.error\", {\r\n              method: \"store_register\",\r\n              role,\r\n              error: result.error || \"register_failed\",\r\n            });\r\n            set({ loading: false, error: result.error });\r\n            return { ok: false, error: result.error };\r\n          }\r\n          // No seteamos usuario aqu??\r\n          // El onboarding se resolver?? al hacer login\r\n          set({ loading: false });\r\n          logCatalogBreadcrumb(\"auth.signup.ok\", {\r\n            method: \"store_register\",\r\n            role,\r\n          });\r\n          return { ok: true, data: result.data, warning: result.warning };\r\n        } catch (error) {\r\n          const message = handleError(error);\r\n          logCatalogBreadcrumb(\"auth.signup.error\", {\r\n            method: \"store_register\",\r\n            role,\r\n            error: message,\r\n          });\r\n          set({ loading: false, error: message });\r\n          return { ok: false, error: message };\r\n        }\r\n      },\r\n\r\n        logout: async () => {\r\n          logCatalogBreadcrumb(\"auth.signout.start\", { scope: \"local\" });\r\n          let userId = null;\r\n          const currentUser = get().usuario;\r\n          const isSupport = currentUser?.role === \"soporte\";\r\n          try {\r\n            const { data } = await supabase.auth.getSession();\r\n            userId = data?.session?.user?.id ?? null;\r\n          } catch (e) {\r\n            userId = null;\r\n          }\r\n          try{\r\n            if (isSupport) {\r\n              await endSupportSession({ reason: \"logout\" });\r\n            }\r\n            await signOut({ scope: \"local\" });\r\n            logCatalogBreadcrumb(\"auth.signout.ok\", { scope: \"local\" });\r\n          } catch (e) {\r\n            logCatalogBreadcrumb(\"auth.signout.error\", {\r\n              scope: \"local\",\r\n              error: e?.message || \"logout_failed\",\r\n            });\r\n            //opcional: log o toast\r\n          } finally {\r\n            if (userId) {\r\n              await clearUserSecurityMaterial(userId);\r\n            }\r\n            useCacheStore.getState().clearAll();\r\n            set({\r\n              bootstrap: false,\r\n              bootstrapError: false,\r\n              usuario: null,\r\n            onboarding: null,\r\n            promos: [],\r\n            negocios: [],\r\n            scannerPermissionPrompted: false,\r\n            scannerManualFallbackShown: false,\r\n            justCompletedRegistration: false,\r\n            emailVerifiedSessionAt: null,\r\n            security: {\r\n              ...defaultSecurityState,\r\n              ...securityActions,\r\n            },\r\n          });\r\n        }\r\n      },\r\n\r\n      //---------------------\r\n      // BOOTSTRAP AUTH\r\n      //---------------------\r\n      bootstrapAuth: async ({ force = false } = {}) => {\r\n        logCatalogBreadcrumb(\"auth.bootstrap.start\", {\r\n          force: Boolean(force),\r\n        });\r\n        if (bootstrapInFlightPromise) {\r\n          return await bootstrapInFlightPromise;\r\n        }\r\n\r\n        bootstrapInFlightPromise = (async () => {\r\n          try {\r\n            const previousUser = get().usuario ?? null;\r\n            const previousOnboarding = get().onboarding ?? null;\r\n            set({\r\n              bootstrap: true,\r\n              bootstrapError: false,\r\n              usuario: undefined,\r\n              onboarding: undefined,\r\n              error: null,\r\n            });\r\n\r\n            const { data: { session } = {} } = await supabase.auth.getSession();\r\n            //Sin sesi??n\r\n            if (!session?.access_token) {\r\n              logCatalogBreadcrumb(\"auth.bootstrap.ok\", {\r\n                has_session: false,\r\n              });\r\n              set({\r\n                bootstrap: false,\r\n                bootstrapError: false,\r\n                usuario: null,\r\n                onboarding: null,\r\n              });\r\n              return { ok: true, usuario: null };\r\n            }\r\n\r\n            // Hard guard: si hay session cacheada pero token invalido para este proyecto,\r\n            // limpiamos session local para evitar loops de 401 en Edge Functions protegidas.\r\n            const {\r\n              data: userProbeData,\r\n              error: userProbeError,\r\n            } = await supabase.auth.getUser(session.access_token);\r\n            if (userProbeError || !userProbeData?.user?.id) {\r\n              try {\r\n                await supabase.auth.signOut({ scope: \"local\" });\r\n              } catch {\r\n                // no-op\r\n              }\r\n              logCatalogBreadcrumb(\"auth.bootstrap.ok\", {\r\n                has_session: false,\r\n                cleared_invalid_session: true,\r\n              });\r\n              set({\r\n                bootstrap: false,\r\n                bootstrapError: false,\r\n                usuario: null,\r\n                onboarding: null,\r\n              });\r\n              return { ok: true, usuario: null };\r\n            }\r\n\r\n            let sessionRegister = { ok: false };\r\n            const canStart = beginPolicyAction(SESSION_BOOTSTRAP_ACTION_KEY);\r\n            if (!canStart) {\r\n              return {\r\n                ok: false,\r\n                code: \"session_register_in_flight\",\r\n                error: \"Validacion de sesion en progreso\",\r\n                recoverable: true,\r\n              };\r\n            }\r\n\r\n            try {\r\n              let attempts = 0;\r\n              while (attempts < SESSION_POLICY_RETRY_CAP) {\r\n                sessionRegister = await registerCurrentSessionDevice();\r\n                if (sessionRegister?.ok) break;\r\n\r\n                const errCode = String(sessionRegister?.code || \"\").toLowerCase();\r\n                const policyEval = await evaluateErrorPolicy({\r\n                  errorCode: errCode || \"session_register_failed\",\r\n                  route: \"/app\",\r\n                  context: {\r\n                    flow: \"bootstrap_auth\",\r\n                    flow_step: \"session_register\",\r\n                    role: get()?.usuario?.role || null,\r\n                  },\r\n                  actionKey: SESSION_BOOTSTRAP_ACTION_KEY,\r\n                });\r\n                const policy = policyEval?.policy || {};\r\n\r\n                if (policy?.ui?.show) {\r\n                  const modalApi = useModalStore.getState();\r\n                  modalApi.openModal(\"ConfirmAction\", {\r\n                    title: \"Problema de conexion\",\r\n                    message:\r\n                      \"No pudimos validar la sesion en este momento. Reintentaremos automaticamente.\",\r\n                    confirmLabel: \"Entendido\",\r\n                    cancelLabel: \"Cerrar\",\r\n                  });\r\n                }\r\n\r\n                if (policy?.retry?.allowed) {\r\n                  attempts += 1;\r\n                  await sleep(Math.max(250, Number(policy?.retry?.backoff_ms || 0)));\r\n                  continue;\r\n                }\r\n\r\n                break;\r\n              }\r\n            } finally {\r\n              endPolicyAction(SESSION_BOOTSTRAP_ACTION_KEY);\r\n            }\r\n\r\n            if (!sessionRegister?.ok) {\r\n              const errCode = String(sessionRegister?.code || \"\").toLowerCase();\r\n              const errMsg =\r\n                sessionRegister?.error ||\r\n                sessionRegister?.message ||\r\n                \"No se pudo registrar la sesion activa\";\r\n              const policyEval = await evaluateErrorPolicy({\r\n                errorCode: errCode || \"session_register_failed\",\r\n                route: \"/app\",\r\n                context: {\r\n                  flow: \"bootstrap_auth\",\r\n                  flow_step: \"session_register\",\r\n                  role: get()?.usuario?.role || null,\r\n                },\r\n                actionKey: SESSION_BOOTSTRAP_ACTION_KEY,\r\n              });\r\n              const policy = policyEval?.policy || {};\r\n              const mustTerminateSession =\r\n                policy?.auth?.signOut === \"local\" || policy?.auth?.signOut === \"global\";\r\n\r\n              if (mustTerminateSession) {\r\n                try {\r\n                  await signOut({ scope: \"local\" });\r\n                } catch {\r\n                  // no-op\r\n                }\r\n              }\r\n\r\n              if (policy?.uam?.degrade_to === SECURITY_LEVELS.REAUTH_SENSITIVE) {\r\n                get().security.setRules({\r\n                  transfer_points: SECURITY_LEVELS.REAUTH_SENSITIVE,\r\n                  redeem_qr: SECURITY_LEVELS.REAUTH_SENSITIVE,\r\n                  update_profile: SECURITY_LEVELS.REAUTH_SENSITIVE,\r\n                  admin_sensitive_action: SECURITY_LEVELS.REAUTH_SENSITIVE,\r\n                });\r\n              }\r\n\r\n              if (policy?.ui?.show) {\r\n                const modalApi = useModalStore.getState();\r\n                modalApi.openModal(\"ConfirmAction\", {\r\n                  title: mustTerminateSession ? \"Sesion expirada\" : \"No se pudo validar la sesion\",\r\n                  message: mustTerminateSession\r\n                    ? \"Tu sesion ya no es valida en este dispositivo. Vuelve a iniciar sesion.\"\r\n                    : \"Hubo un problema temporal al validar tu sesion. Intenta nuevamente.\",\r\n                  confirmLabel: \"Entendido\",\r\n                  cancelLabel: \"Cerrar\",\r\n                });\r\n              }\r\n\r\n              void reportError(new Error(errMsg), {\r\n                code: errCode || \"session_register_failed\",\r\n                context: {\r\n                  source: \"bootstrap_session_register_failed\",\r\n                  error_code: errCode || \"session_register_failed\",\r\n                  recoverable: !mustTerminateSession,\r\n                },\r\n              });\r\n\r\n              set({\r\n                bootstrap: false,\r\n                bootstrapError: !mustTerminateSession,\r\n                usuario: mustTerminateSession ? null : previousUser,\r\n                onboarding: mustTerminateSession ? null : previousOnboarding,\r\n                error: errMsg,\r\n              });\r\n              logCatalogBreadcrumb(\"auth.bootstrap.error\", {\r\n                step: \"session_register\",\r\n                error: errMsg,\r\n                code: errCode || null,\r\n                recoverable: !mustTerminateSession,\r\n              });\r\n              return {\r\n                ok: false,\r\n                error: errMsg,\r\n                code: errCode || null,\r\n                recoverable: !mustTerminateSession,\r\n              };\r\n            }\r\n\r\n            const check = await runOnboardingCheck();\r\n            if (!check?.ok) {\r\n              const errMsg = check?.error || \"No se pudo ejecutar onboarding\";\r\n              set({\r\n                bootstrap: false,\r\n                bootstrapError: false,\r\n                usuario: null,\r\n                onboarding: check ?? null,\r\n                error: errMsg,\r\n              });\r\n              logCatalogBreadcrumb(\"auth.bootstrap.error\", {\r\n                step: \"onboarding_check\",\r\n                error: errMsg,\r\n              });\r\n              return { ok: false, error: errMsg };\r\n            }\r\n\r\n            const nextUser = check?.usuario ?? null;\r\n            const emailConfirmed = Boolean(check?.email_confirmed);\r\n            const currentVerifiedAt = get().emailVerifiedSessionAt;\r\n            const nextVerifiedAt =\r\n              emailConfirmed && !currentVerifiedAt ? Date.now() : currentVerifiedAt;\r\n            set({\r\n              bootstrap: false,\r\n              bootstrapError: false,\r\n              usuario: nextUser,\r\n              onboarding: check,\r\n              emailVerifiedSessionAt: nextVerifiedAt,\r\n            });\r\n            logCatalogBreadcrumb(\"auth.bootstrap.ok\", {\r\n              has_session: true,\r\n              role: nextUser?.role || null,\r\n              allow_access: check?.allowAccess === true,\r\n            });\r\n\r\n            return { ok: true, usuario: nextUser };\r\n          } catch (error) {\r\n            const message = handleError(error);\r\n            logCatalogBreadcrumb(\"auth.bootstrap.error\", {\r\n              step: \"exception\",\r\n              error: message,\r\n            });\r\n            set({\r\n              bootstrap: false,\r\n              bootstrapError: true,\r\n              usuario: null,\r\n              onboarding: null,\r\n              error: message,\r\n            });\r\n            return { ok: false, error: message };\r\n          }\r\n        })();\r\n\r\n        try {\r\n          return await bootstrapInFlightPromise;\r\n        } finally {\r\n          bootstrapInFlightPromise = null;\r\n        }\r\n      },\r\n      //--------------------\r\n      // PROMOS\r\n      //--------------------\r\n      loadPromos: async ({ silent = false, force = false } = {}) => {\r\n        const loadedAt = get().promosLoadedAt;\r\n        if (!force && loadedAt) {\r\n          return { ok: true, cached: true };\r\n        }\r\n        if (silent) {\r\n          set({ promosRefreshing: true });\r\n        } else {\r\n          set({ loading: true, error: null });\r\n        }\r\n        try {\r\n          const { ok, data, error } = await getActivePromos();\r\n          if (!ok) {\r\n            set({ error, loading: false, promosRefreshing: false });\r\n            return { ok: false, error };\r\n          }\r\n          set({\r\n            promos: data,\r\n            loading: false,\r\n            promosRefreshing: false,\r\n            promosLoadedAt: Date.now(),\r\n          });\r\n          return { ok: true, data };\r\n        } catch (error) {\r\n          const message = handleError(error);\r\n          set({ error: message, loading: false, promosRefreshing: false });\r\n          return { ok: false, error: message };\r\n        }\r\n      },\r\n      startPromosAutoRefresh: () => {\r\n        if (promosAutoRefreshActive) return;\r\n        promosAutoRefreshActive = true;\r\n\r\n        if (!promosVisibilityHandler && typeof document !== \"undefined\") {\r\n          promosVisibilityHandler = () => {\r\n            if (!promosAutoRefreshActive) return;\r\n            if (document.visibilityState === \"hidden\") {\r\n              if (promosRefreshTimer) {\r\n                clearTimeout(promosRefreshTimer);\r\n                promosRefreshTimer = null;\r\n              }\r\n              return;\r\n            }\r\n            schedulePromosRefresh();\r\n          };\r\n          document.addEventListener(\"visibilitychange\", promosVisibilityHandler);\r\n        }\r\n\r\n        schedulePromosRefresh();\r\n      },\r\n      stopPromosAutoRefresh: () => {\r\n        promosAutoRefreshActive = false;\r\n        if (promosRefreshTimer) {\r\n          clearTimeout(promosRefreshTimer);\r\n          promosRefreshTimer = null;\r\n        }\r\n        if (promosVisibilityHandler && typeof document !== \"undefined\") {\r\n          document.removeEventListener(\r\n            \"visibilitychange\",\r\n            promosVisibilityHandler\r\n          );\r\n          promosVisibilityHandler = null;\r\n        }\r\n      },\r\n      setPromosVisible: (visible) => {\r\n        set({ promosVisible: visible });\r\n        if (promosAutoRefreshActive) {\r\n          schedulePromosRefresh();\r\n        }\r\n      },\r\n      //----------------------\r\n      // RATINGS\r\n      //----------------------\r\n      initRatings: (promos) => {\r\n        const current = get().ratings;\r\n        if (Object.keys(current).length > 0) return;\r\n        const map = {};\r\n        promos.forEach((p) => {\r\n          map[p.id] = Math.round((3 + Math.random() * 2) * 10) / 10;\r\n        });\r\n        set({ ratings: map });\r\n      },\r\n\r\n      //-----------------------\r\n      // QR (HMAC)\r\n      //-----------------------\r\n      generatePromoQr: (promoId) => generatePromoQr(promoId),\r\n      generateValidQr: (promoId, opts) => generateValidQr(promoId, opts),\r\n      getActiveValidQr: (promoId) => getActiveValidQr(promoId),\r\n      redeemValidQr: (code) => redeemValidQr(code),\r\n\r\n      //----------------------\r\n      // COMENTARIOS\r\n      //----------------------\r\n      addComentario: (payload) => addComentario(payload),\r\n      };\r\n    },\r\n    {\r\n      name: \"referidos_app_user\",\r\n      version: 2,\r\n      //Para evitar usuarios \"fantasma\" al arrancar, no persistimos usuario/onboarding\r\n      partialize: () => ({}),\r\n      migrate: () => ({}),\r\n    }\r\n  )\r\n);\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\utils\\dateUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\utils\\errorUtils.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\utils\\googleOneTap.js","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'createNonce' is defined but never used. Allowed unused vars must match /^[A-Z_]/u.","line":16,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":21,"suggestions":[{"messageId":"removeVar","data":{"varName":"createNonce"},"fix":{"range":[487,641],"text":""},"desc":"Remove unused variable 'createNonce'."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Lightweight helper to load and trigger Google One Tap\r\nconst SCRIPT_SRC = \"https://accounts.google.com/gsi/client\";\r\nlet loaderPromise = null;\r\n\r\nfunction ensureBrowser() {\r\n  if (typeof window === \"undefined\") {\r\n    throw new Error(\"Google One Tap solo esta disponible en navegador\");\r\n  }\r\n}\r\n\r\nfunction base64UrlEncode(buffer) {\r\n  const text = btoa(String.fromCharCode(...new Uint8Array(buffer)));\r\n  return text.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\r\n}\r\n\r\nfunction createNonce(length = 32) {\r\n  const bytes = new Uint8Array(length);\r\n  window.crypto.getRandomValues(bytes);\r\n  return base64UrlEncode(bytes);\r\n}\r\n\r\nfunction loadGoogleClient() {\r\n  ensureBrowser();\r\n  if (window.google?.accounts?.id) return Promise.resolve(window.google);\r\n  if (loaderPromise) return loaderPromise;\r\n\r\n  loaderPromise = new Promise((resolve, reject) => {\r\n    const existing = document.querySelector(\"script[data-google-one-tap]\");\r\n    if (existing) {\r\n      existing.addEventListener(\"load\", () => resolve(window.google));\r\n      existing.addEventListener(\"error\", () => reject(new Error(\"No se pudo cargar Google One Tap\")));\r\n      return;\r\n    }\r\n\r\n    const script = document.createElement(\"script\");\r\n    script.src = SCRIPT_SRC;\r\n    script.async = true;\r\n    script.defer = true;\r\n    script.dataset.googleOneTap = \"true\";\r\n    script.onload = () => resolve(window.google);\r\n    script.onerror = () => reject(new Error(\"No se pudo cargar Google One Tap\"));\r\n    document.head.appendChild(script);\r\n  });\r\n\r\n  return loaderPromise;\r\n}\r\n\r\nexport async function requestGoogleCredential({ clientId, context = \"signin\" }) {\r\n  if (!clientId) throw new Error(\"Falta GOOGLE_CLIENT_ID para One Tap\");\r\n  const google = await loadGoogleClient();\r\n\r\n  return new Promise((resolve, reject) => {\r\n    let settled = false;\r\n\r\n    const finish = (payload, isError = false) => {\r\n      if (settled) return;\r\n      settled = true;\r\n      if (isError) reject(payload);\r\n      else resolve(payload);\r\n    };\r\n\r\n    google.accounts.id.initialize({\r\n      client_id: clientId,\r\n      callback: (response) => {\r\n        if (settled) return;\r\n        if (response?.credential) {\r\n          finish({\r\n            type: \"credential\",\r\n            credential: response.credential,\r\n          });\r\n        } else {\r\n          finish(new Error(\"No se pudo obtener credencial de Google\"), true);\r\n        }\r\n      },\r\n      cancel_on_tap_outside: true,\r\n      use_fedcm_for_prompt: true,\r\n      context,\r\n    });\r\n\r\n    google.accounts.id.prompt((notification) => {\r\n      if (settled) return;\r\n      if (notification.isNotDisplayed?.() || notification.isSkippedMoment?.()) {\r\n        finish(new Error(\"No se pudo mostrar Google One Tap\"), true);\r\n        return;\r\n      }\r\n      if (notification.isDismissedMoment?.()) {\r\n        const reason =\r\n          notification.getDismissedReason?.() ||\r\n          notification.getNotDisplayedReason?.() ||\r\n          notification.dismissedReason ||\r\n          \"dismissed\";\r\n        if (reason === \"credential_returned\") return;\r\n        finish({ type: \"dismissed\", reason });\r\n      }\r\n    });\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\utils\\sanitize.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\utils\\storage.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\utils\\textCase.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Sebas\\Documents\\referidos-app\\apps\\referidos-app\\src\\utils\\validators.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
