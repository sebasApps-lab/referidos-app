name: Versioning Apply Migrations

on:
  workflow_dispatch:
    inputs:
      request_id:
        description: "ID interno de solicitud"
        required: true
        type: string
      product_key:
        description: "Producto (referidos_app | prelaunch_web)"
        required: true
        type: string
      env_key:
        description: "Entorno destino (staging | prod)"
        required: true
        type: string
      semver:
        description: "Version semver"
        required: true
        type: string
      target_project_ref:
        description: "Supabase project ref destino"
        required: true
        type: string
      source_commit_sha:
        description: "Commit de release"
        required: false
        type: string
      source_branch:
        description: "Rama origen"
        required: false
        type: string
      target_branch:
        description: "Rama destino"
        required: false
        type: string
      required_migrations:
        description: "Lista JSON de versiones requeridas"
        required: false
        type: string

permissions:
  contents: read

jobs:
  apply-migrations:
    runs-on: ubuntu-latest
    env:
      REQUEST_ID: ${{ inputs.request_id }}
      PRODUCT_KEY: ${{ inputs.product_key }}
      ENV_KEY: ${{ inputs.env_key }}
      SEMVER: ${{ inputs.semver }}
      TARGET_PROJECT_REF: ${{ inputs.target_project_ref }}
      SOURCE_COMMIT_SHA: ${{ inputs.source_commit_sha }}
      SOURCE_BRANCH: ${{ inputs.source_branch }}
      TARGET_BRANCH: ${{ inputs.target_branch }}
      REQUIRED_MIGRATIONS: ${{ inputs.required_migrations }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    steps:
      - name: Validar input y resolver runtime
        id: plan
        shell: bash
        run: |
          set -euo pipefail

          if [[ "$ENV_KEY" != "staging" && "$ENV_KEY" != "prod" ]]; then
            echo "env_key invalido: $ENV_KEY"
            exit 1
          fi

          if [[ -z "$TARGET_PROJECT_REF" ]]; then
            echo "target_project_ref requerido"
            exit 1
          fi

          if [[ -z "${SUPABASE_ACCESS_TOKEN:-}" ]]; then
            echo "Falta secret SUPABASE_ACCESS_TOKEN"
            exit 1
          fi

          runtime_dir=""
          if [[ "$PRODUCT_KEY" == "referidos_app" || "$PRODUCT_KEY" == "prelaunch_web" ]]; then
            runtime_dir="apps/referidos-app"
          else
            echo "Producto no soportado para apply migrations: $PRODUCT_KEY"
            exit 1
          fi

          echo "runtime_dir=${runtime_dir}" >> "$GITHUB_OUTPUT"

      - name: Checkout release commit
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.source_commit_sha || github.ref }}

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Mostrar contexto
        shell: bash
        run: |
          set -euo pipefail
          echo "request_id=${REQUEST_ID}"
          echo "product_key=${PRODUCT_KEY}"
          echo "env_key=${ENV_KEY}"
          echo "semver=${SEMVER}"
          echo "target_project_ref=${TARGET_PROJECT_REF}"
          echo "source_commit_sha=${SOURCE_COMMIT_SHA:-}"
          echo "source_branch=${SOURCE_BRANCH:-}"
          echo "target_branch=${TARGET_BRANCH:-}"
          echo "required_migrations=${REQUIRED_MIGRATIONS:-[]}"
          supabase --version

      - name: Apply migrations (db push)
        shell: bash
        working-directory: ${{ steps.plan.outputs.runtime_dir }}
        run: |
          set -euo pipefail
          supabase db push --project-ref "${TARGET_PROJECT_REF}" --yes
